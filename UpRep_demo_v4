import React, { useState, useRef } from 'react';
import { ChevronRight, ChevronLeft, Check, Plus, Minus, Play, X, Droplets, Moon, TrendingUp, User, Home, Dumbbell, Apple, BarChart3, Trophy, Flame, Clock, Target, Info, Calendar, AlertCircle, Zap, Coffee, Utensils, ChevronDown, ChevronUp, Eye, Undo2 } from 'lucide-react';

const COLORS = {
  primary: '#FF4D4D',
  primaryDark: '#CC3D3D',
  accent: '#00D9FF',
  background: '#0F0F1A',
  surface: '#1A1A2E',
  surfaceLight: '#252540',
  text: '#FFFFFF',
  textSecondary: '#B0B0C0',
  textMuted: '#6B6B80',
  success: '#00E676',
  warning: '#FFB300',
  error: '#FF5252',
};

const GOAL_INFO = {
  build_muscle: {
    title: 'Building Muscle & Size',
    icon: 'üí™',
    overview: "Building muscle is a journey of consistency, not a sprint.",
    requirements: [
      { icon: 'üèãÔ∏è', title: 'Progressive Overload', desc: 'Gradually increase weight, reps, or sets over time.' },
      { icon: 'üìÖ', title: 'Consistency', desc: 'Results come from stacking sessions week after week.' },
      { icon: 'üçó', title: 'Protein-Rich Diet', desc: 'Aim for 1.6-2.2g protein per kg bodyweight daily.' },
      { icon: 'üò¥', title: 'Quality Sleep', desc: '7-9 hours per night for muscle repair.' },
    ],
    minDays: 3,
    idealDays: '4-5',
  },
  lose_fat: {
    title: 'Losing Fat & Getting Lean',
    icon: 'üî•',
    overview: "Fat loss is about creating a sustainable calorie deficit.",
    requirements: [
      { icon: 'üçΩÔ∏è', title: 'Calorie Deficit', desc: 'Eat slightly less than you burn (300-500 cal deficit).' },
      { icon: 'üèÉ', title: 'Cardio + Weights', desc: 'Combine resistance training with cardio.' },
      { icon: 'üçó', title: 'High Protein', desc: 'Keep protein high to preserve muscle.' },
    ],
    minDays: 3,
    idealDays: '4-6',
  },
  strength: {
    title: 'Getting Stronger',
    icon: 'üèãÔ∏è',
    overview: "Strength is built through heavy compound lifts.",
    requirements: [
      { icon: 'üéØ', title: 'Heavy Compounds', desc: 'Focus on squat, bench, deadlift, overhead press.' },
      { icon: 'üìà', title: 'Low Reps, High Weight', desc: '1-6 rep range with heavy loads.' },
    ],
    minDays: 3,
    idealDays: '3-4',
  },
  fitness: {
    title: 'General Fitness & Health',
    icon: '‚ù§Ô∏è',
    overview: "Overall fitness combines strength, cardio, and mobility.",
    requirements: [
      { icon: 'üîÑ', title: 'Variety', desc: 'Mix resistance training, cardio, and flexibility work.' },
      { icon: '‚ù§Ô∏è', title: 'Heart Health', desc: '150 mins moderate cardio per week minimum.' },
    ],
    minDays: 2,
    idealDays: '3-5',
  },
};

const WORKOUT_EXERCISES = [
  { id: 'bench', name: 'Bench Press', sets: 4, targetReps: 8, suggestedWeight: 60 },
  { id: 'ohp', name: 'Overhead Press', sets: 3, targetReps: 10, suggestedWeight: 40 },
  { id: 'incline', name: 'Incline Dumbbell Press', sets: 3, targetReps: 12, suggestedWeight: 24 },
  { id: 'lateral', name: 'Lateral Raises', sets: 3, targetReps: 15, suggestedWeight: 10 },
  { id: 'tricep', name: 'Tricep Pushdowns', sets: 3, targetReps: 12, suggestedWeight: 25 },
];

const RPE_SCALE = [
  { value: 1, label: '1', desc: 'Warmup' },
  { value: 5, label: '5', desc: 'Moderate' },
  { value: 7, label: '7', desc: 'Hard - 3 reps left' },
  { value: 8, label: '8', desc: 'Very hard - 2 reps left' },
  { value: 9, label: '9', desc: 'Near max - 1 rep left' },
  { value: 10, label: '10', desc: 'Failure' },
];

// LoginScreen as separate component
function LoginScreen({ onBack, onLogin, COLORS }) {
  const [email, setEmail] = useState('');
  const [password, setPassword] = useState('');
  
  return (
    <div className="flex flex-col h-full p-6">
      <button onClick={onBack} className="mb-6">
        <ChevronLeft size={24} color={COLORS.text} />
      </button>
      <div className="flex-1">
        <h1 className="text-3xl font-bold mb-2" style={{ color: COLORS.text }}>Welcome Back</h1>
        <p className="mb-8" style={{ color: COLORS.textSecondary }}>Log in to continue your fitness journey</p>
        <div className="space-y-4">
          <div>
            <label className="text-sm mb-2 block" style={{ color: COLORS.textSecondary }}>Email</label>
            <input type="email" placeholder="your@email.com" value={email}
              onChange={e => setEmail(e.target.value)}
              className="w-full p-4 rounded-xl outline-none" 
              style={{ backgroundColor: COLORS.surface, color: COLORS.text, border: `1px solid ${COLORS.surfaceLight}` }} />
          </div>
          <div>
            <label className="text-sm mb-2 block" style={{ color: COLORS.textSecondary }}>Password</label>
            <input type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" value={password}
              onChange={e => setPassword(e.target.value)}
              className="w-full p-4 rounded-xl outline-none" 
              style={{ backgroundColor: COLORS.surface, color: COLORS.text, border: `1px solid ${COLORS.surfaceLight}` }} />
          </div>
        </div>
      </div>
      <button onClick={onLogin} disabled={!email || !password}
        className="w-full py-4 rounded-xl font-semibold text-lg"
        style={{ backgroundColor: COLORS.primary, color: COLORS.text, opacity: email && password ? 1 : 0.5 }}>
        Log In
      </button>
    </div>
  );
}

// RegisterScreen as separate component
function RegisterScreen({ onBack, onRegister, COLORS }) {
  const [regData, setRegData] = useState({
    firstName: '', lastName: '', email: '', password: '', confirmPassword: '', dob: '', weight: ''
  });
  
  const isValid = regData.firstName && regData.lastName && regData.email && 
    regData.password && regData.password === regData.confirmPassword;

  return (
    <div className="flex flex-col h-full">
      <div className="p-4 border-b flex items-center gap-3" style={{ borderColor: COLORS.surfaceLight }}>
        <button onClick={onBack}><ChevronLeft size={24} color={COLORS.text} /></button>
        <h2 className="text-lg font-bold" style={{ color: COLORS.text }}>Create Account</h2>
      </div>
      <div className="flex-1 overflow-auto p-6">
        <div className="space-y-4">
          <div className="flex gap-3">
            <div className="flex-1">
              <label className="text-sm mb-2 block" style={{ color: COLORS.textSecondary }}>First Name</label>
              <input type="text" placeholder="First name" value={regData.firstName}
                onChange={e => setRegData(p => ({...p, firstName: e.target.value}))}
                className="w-full p-4 rounded-xl outline-none" 
                style={{ backgroundColor: COLORS.surface, color: COLORS.text, border: `1px solid ${COLORS.surfaceLight}` }} />
            </div>
            <div className="flex-1">
              <label className="text-sm mb-2 block" style={{ color: COLORS.textSecondary }}>Last Name</label>
              <input type="text" placeholder="Last name" value={regData.lastName}
                onChange={e => setRegData(p => ({...p, lastName: e.target.value}))}
                className="w-full p-4 rounded-xl outline-none" 
                style={{ backgroundColor: COLORS.surface, color: COLORS.text, border: `1px solid ${COLORS.surfaceLight}` }} />
            </div>
          </div>
          <div>
            <label className="text-sm mb-2 block" style={{ color: COLORS.textSecondary }}>Email</label>
            <input type="email" placeholder="your@email.com" value={regData.email}
              onChange={e => setRegData(p => ({...p, email: e.target.value}))}
              className="w-full p-4 rounded-xl outline-none" 
              style={{ backgroundColor: COLORS.surface, color: COLORS.text, border: `1px solid ${COLORS.surfaceLight}` }} />
          </div>
          <div>
            <label className="text-sm mb-2 block" style={{ color: COLORS.textSecondary }}>Password</label>
            <input type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" value={regData.password}
              onChange={e => setRegData(p => ({...p, password: e.target.value}))}
              className="w-full p-4 rounded-xl outline-none" 
              style={{ backgroundColor: COLORS.surface, color: COLORS.text, border: `1px solid ${COLORS.surfaceLight}` }} />
          </div>
          <div>
            <label className="text-sm mb-2 block" style={{ color: COLORS.textSecondary }}>Confirm Password</label>
            <input type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" value={regData.confirmPassword}
              onChange={e => setRegData(p => ({...p, confirmPassword: e.target.value}))}
              className="w-full p-4 rounded-xl outline-none" 
              style={{ backgroundColor: COLORS.surface, color: COLORS.text, 
                border: `1px solid ${regData.confirmPassword && regData.password !== regData.confirmPassword ? COLORS.error : COLORS.surfaceLight}` }} />
          </div>
        </div>
      </div>
      <div className="p-6 border-t" style={{ borderColor: COLORS.surfaceLight }}>
        <button onClick={() => onRegister(regData)} disabled={!isValid}
          className="w-full py-4 rounded-xl font-semibold text-lg"
          style={{ backgroundColor: COLORS.primary, color: COLORS.text, opacity: isValid ? 1 : 0.5 }}>
          Create Account
        </button>
      </div>
    </div>
  );
}

// ActiveWorkoutScreen as separate component
function ActiveWorkoutScreen({ onClose, COLORS }) {
  const initSets = () => {
    const sets = {};
    WORKOUT_EXERCISES.forEach(ex => {
      sets[ex.id] = Array(ex.sets).fill(null).map(() => ({ 
        weight: ex.suggestedWeight, reps: ex.targetReps, rpe: null, completed: false 
      }));
    });
    return sets;
  };

  const [exerciseSets, setExerciseSets] = useState(initSets);
  const [expandedExercise, setExpandedExercise] = useState(WORKOUT_EXERCISES[0].id);

  const updateSet = (exerciseId, setIndex, field, value) => {
    setExerciseSets(prev => ({
      ...prev,
      [exerciseId]: prev[exerciseId].map((s, i) => i === setIndex ? { ...s, [field]: value } : s)
    }));
  };

  const completeSet = (exerciseId, setIndex) => {
    setExerciseSets(prev => ({
      ...prev,
      [exerciseId]: prev[exerciseId].map((s, i) => i === setIndex ? { ...s, completed: true } : s)
    }));
  };

  return (
    <div className="fixed inset-0 z-50 flex flex-col" style={{ backgroundColor: COLORS.background }}>
      <div className="p-4 border-b flex items-center justify-between" style={{ borderColor: COLORS.surfaceLight }}>
        <div className="flex items-center gap-3">
          <button onClick={onClose}><X size={24} color={COLORS.text} /></button>
          <h2 className="text-lg font-bold" style={{ color: COLORS.text }}>Push Day A</h2>
        </div>
      </div>
      <div className="flex-1 overflow-auto p-4">
        {WORKOUT_EXERCISES.map((exercise) => (
          <div key={exercise.id} className="mb-4 rounded-xl overflow-hidden" style={{ backgroundColor: COLORS.surface }}>
            <button onClick={() => setExpandedExercise(expandedExercise === exercise.id ? null : exercise.id)}
              className="w-full p-4 flex items-center justify-between">
              <div>
                <p className="font-semibold text-left" style={{ color: COLORS.text }}>{exercise.name}</p>
                <p className="text-sm" style={{ color: COLORS.textMuted }}>{exercise.sets} sets √ó {exercise.targetReps} reps</p>
              </div>
              {expandedExercise === exercise.id ? <ChevronUp size={20} color={COLORS.textMuted} /> : <ChevronDown size={20} color={COLORS.textMuted} />}
            </button>
            {expandedExercise === exercise.id && (
              <div className="px-4 pb-4">
                {exerciseSets[exercise.id]?.map((set, setIndex) => (
                  <div key={setIndex} className="flex items-center gap-2 mb-2 p-3 rounded-lg"
                    style={{ backgroundColor: set.completed ? COLORS.success + '20' : COLORS.surfaceLight }}>
                    <span className="w-8 text-center font-bold" style={{ color: COLORS.textMuted }}>{setIndex + 1}</span>
                    <input type="number" value={set.weight}
                      onChange={e => updateSet(exercise.id, setIndex, 'weight', parseInt(e.target.value) || 0)}
                      className="w-16 p-2 rounded text-center" 
                      style={{ backgroundColor: COLORS.surface, color: COLORS.text, border: 'none' }} />
                    <span style={{ color: COLORS.textMuted }}>kg</span>
                    <input type="number" value={set.reps}
                      onChange={e => updateSet(exercise.id, setIndex, 'reps', parseInt(e.target.value) || 0)}
                      className="w-12 p-2 rounded text-center" 
                      style={{ backgroundColor: COLORS.surface, color: COLORS.text, border: 'none' }} />
                    <span style={{ color: COLORS.textMuted }}>reps</span>
                    <button onClick={() => completeSet(exercise.id, setIndex)} disabled={set.completed}
                      className="ml-auto p-2 rounded-lg"
                      style={{ backgroundColor: set.completed ? COLORS.success : COLORS.primary }}>
                      <Check size={16} color={COLORS.text} />
                    </button>
                  </div>
                ))}
              </div>
            )}
          </div>
        ))}
      </div>
      <div className="p-4 border-t" style={{ borderColor: COLORS.surfaceLight }}>
        <button onClick={onClose} className="w-full py-4 rounded-xl font-semibold"
          style={{ backgroundColor: COLORS.primary, color: COLORS.text }}>
          Finish Workout
        </button>
      </div>
    </div>
  );
}

// Main App Component
export default function UpRepDemo() {
  const [currentScreen, setCurrentScreen] = useState('welcome');
  const [activeTab, setActiveTab] = useState('home');
  const [showActiveWorkout, setShowActiveWorkout] = useState(false);
  const [showReschedule, setShowReschedule] = useState(false);
  const [showPausePlan, setShowPausePlan] = useState(false);
  const [rescheduleOption, setRescheduleOption] = useState(null);
  const [pauseDuration, setPauseDuration] = useState(null);
  const [pauseCalendarMonth, setPauseCalendarMonth] = useState(0); // January 2026
  const [pauseCalendarYear, setPauseCalendarYear] = useState(2026);
  const [onboardingStep, setOnboardingStep] = useState(0);
  const [showGoalInfo, setShowGoalInfo] = useState(null);
  const [hoveredGoal, setHoveredGoal] = useState(null);
  const [waterIntake, setWaterIntake] = useState(1250);
  const [caloriesIntake, setCaloriesIntake] = useState(1450);
  const [proteinIntake, setProteinIntake] = useState(95);
  
  const [userData, setUserData] = useState({
    firstName: '', lastName: '', email: '', goal: null, experience: null,
    daysPerWeek: 4, sessionDuration: 60, dob: '', weight: ''
  });

  const [streaks] = useState({
    weeklyWorkouts: { weeksCompleted: 12 },
    calories: { daysInRow: 5 },
    protein: { daysInRow: 8 },
    water: { daysInRow: 3 },
  });

  // Welcome Screen
  const WelcomeScreen = () => (
    <div className="flex flex-col items-center justify-center h-full p-6 text-center">
      <div className="w-24 h-24 rounded-3xl flex items-center justify-center mb-6" style={{ backgroundColor: COLORS.surface }}>
        <Dumbbell size={48} color={COLORS.primary} />
      </div>
      <h1 className="text-4xl font-bold mb-2" style={{ color: COLORS.text }}>UpRep</h1>
      <p className="text-lg mb-2" style={{ color: COLORS.textSecondary }}>Your Personal Fitness Journey</p>
      <p className="text-sm mb-8" style={{ color: COLORS.textMuted }}>Track workouts, hit goals, transform your body</p>
      <button onClick={() => setCurrentScreen('register')}
        className="w-full py-4 rounded-xl font-semibold text-lg flex items-center justify-center gap-2 mb-3"
        style={{ backgroundColor: COLORS.primary, color: COLORS.text }}>
        Get Started <ChevronRight size={20} />
      </button>
      <button onClick={() => setCurrentScreen('login')}
        className="w-full py-4 rounded-xl font-semibold text-lg mb-6"
        style={{ backgroundColor: COLORS.surface, color: COLORS.text, border: `1px solid ${COLORS.surfaceLight}` }}>
        Log In
      </button>
    </div>
  );

  // Dashboard Screen
  const DashboardScreen = () => {
    const userName = userData.firstName || 'Matt';
    const hasProgress = userData.goal !== null;

    return (
      <div className="flex flex-col h-full">
        <div className="flex-1 overflow-auto p-6">
          <div className="flex items-center justify-center gap-2 mb-4">
            <div className="w-8 h-8 rounded-lg flex items-center justify-center" style={{ backgroundColor: COLORS.primary }}>
              <Dumbbell size={18} color={COLORS.text} />
            </div>
            <span className="text-xl font-bold" style={{ color: COLORS.text }}>UpRep</span>
          </div>
          <div className="text-center mb-6">
            <p className="text-lg mb-1" style={{ color: COLORS.textSecondary }}>Welcome back,</p>
            <h1 className="text-3xl font-bold" style={{ color: COLORS.text }}>{userName}! üëã</h1>
          </div>
          
          {!hasProgress && (
            <>
              <div className="p-6 rounded-2xl mb-4" style={{ backgroundColor: COLORS.surface }}>
                <div className="text-center mb-4"><span className="text-4xl">üöÄ</span></div>
                <h2 className="text-xl font-bold mb-2 text-center" style={{ color: COLORS.text }}>
                  Ready to Transform with UpRep?
                </h2>
                <p className="text-center mb-4" style={{ color: COLORS.textSecondary }}>
                  Your personalized fitness journey is just a few taps away
                </p>
              </div>
              <div className="space-y-3 mb-6">
                {[
                  { icon: Target, label: 'Personalized Plans', desc: 'Workouts tailored to your goals', color: COLORS.primary },
                  { icon: TrendingUp, label: 'Progress Tracking', desc: 'Watch your PRs climb', color: COLORS.accent },
                  { icon: Apple, label: 'Nutrition Tracking', desc: 'Hit your macros', color: COLORS.success },
                  { icon: Flame, label: 'Stay Motivated', desc: 'Streaks & achievements', color: COLORS.warning },
                ].map((item, i) => (
                  <div key={i} className="p-4 rounded-xl flex items-center gap-4" style={{ backgroundColor: COLORS.surface }}>
                    <div className="w-12 h-12 rounded-full flex items-center justify-center" style={{ backgroundColor: item.color + '20' }}>
                      <item.icon size={24} color={item.color} />
                    </div>
                    <div>
                      <p className="font-semibold" style={{ color: COLORS.text }}>{item.label}</p>
                      <p className="text-sm" style={{ color: COLORS.textSecondary }}>{item.desc}</p>
                    </div>
                  </div>
                ))}
              </div>
            </>
          )}
        </div>
        {!hasProgress && (
          <div className="p-6 border-t" style={{ borderColor: COLORS.surfaceLight }}>
            <button onClick={() => setCurrentScreen('onboarding')}
              className="w-full py-4 rounded-xl font-semibold text-lg flex items-center justify-center gap-2"
              style={{ backgroundColor: COLORS.primary, color: COLORS.text }}>
              Start Your UpRep Journey <ChevronRight size={20} />
            </button>
          </div>
        )}
      </div>
    );
  };

  // Goal Info Modal
  const GoalInfoModal = ({ goal, onClose, onSelect }) => {
    const info = GOAL_INFO[goal];
    return (
      <div className="fixed inset-0 z-50 flex flex-col" style={{ backgroundColor: COLORS.background }}>
        <div className="p-4 border-b flex items-center gap-3" style={{ borderColor: COLORS.surfaceLight }}>
          <button onClick={onClose}><ChevronLeft size={24} color={COLORS.text} /></button>
          <h2 className="text-lg font-bold" style={{ color: COLORS.text }}>{info.title}</h2>
        </div>
        <div className="flex-1 overflow-auto p-4">
          <div className="text-center mb-6">
            <span className="text-6xl">{info.icon}</span>
            <p className="mt-4" style={{ color: COLORS.textSecondary }}>{info.overview}</p>
          </div>
          <div className="space-y-3">
            {info.requirements.map((req, i) => (
              <div key={i} className="p-4 rounded-xl" style={{ backgroundColor: COLORS.surface }}>
                <div className="flex items-start gap-3">
                  <span className="text-2xl">{req.icon}</span>
                  <div>
                    <p className="font-semibold" style={{ color: COLORS.text }}>{req.title}</p>
                    <p className="text-sm" style={{ color: COLORS.textSecondary }}>{req.desc}</p>
                  </div>
                </div>
              </div>
            ))}
          </div>
        </div>
        <div className="p-4 border-t" style={{ borderColor: COLORS.surfaceLight }}>
          <button onClick={() => onSelect(goal)} className="w-full py-4 rounded-xl font-semibold"
            style={{ backgroundColor: COLORS.primary, color: COLORS.text }}>
            Select This Goal
          </button>
        </div>
      </div>
    );
  };

  // Onboarding Screen
  const OnboardingScreen = () => {
    const steps = [
      {
        title: "What's your main goal?",
        subtitle: "Select a goal, tap ‚ìò to learn more",
        content: (
          <div className="space-y-3">
            {Object.entries(GOAL_INFO).map(([id, goal]) => (
              <div key={id}>
                <div
                  className="w-full p-4 rounded-xl flex items-center gap-4 text-left cursor-pointer"
                  style={{ backgroundColor: userData.goal === id ? COLORS.primary + '20' : COLORS.surface,
                    border: `2px solid ${userData.goal === id ? COLORS.primary : COLORS.surfaceLight}`,
                    borderRadius: hoveredGoal === id ? '12px 12px 0 0' : '12px' }}
                  onClick={() => { setUserData(p => ({...p, goal: id})); setHoveredGoal(id); }}
                >
                  <span className="text-3xl">{goal.icon}</span>
                  <div className="flex-1">
                    <p className="font-semibold" style={{ color: userData.goal === id ? COLORS.primary : COLORS.text }}>{goal.title}</p>
                  </div>
                  {userData.goal === id && <Check size={20} color={COLORS.primary} />}
                  <button 
                    onClick={(e) => { e.stopPropagation(); setHoveredGoal(hoveredGoal === id ? null : id); }}
                    className="p-2 rounded-full"
                    style={{ backgroundColor: hoveredGoal === id ? COLORS.primary : COLORS.surfaceLight }}
                  >
                    <Info size={18} color={hoveredGoal === id ? COLORS.text : COLORS.textMuted} />
                  </button>
                </div>
                
                {/* Info Panel - Inline, pushes content down */}
                {hoveredGoal === id && (
                  <div 
                    className="p-4 rounded-b-xl"
                    style={{ backgroundColor: COLORS.surfaceLight, borderTop: `1px solid ${COLORS.surface}` }}
                  >
                    <p className="text-sm mb-3" style={{ color: COLORS.textSecondary }}>{goal.overview}</p>
                    <div className="space-y-2">
                      {goal.requirements.map((req, i) => (
                        <div key={i} className="flex items-start gap-2">
                          <span className="text-sm">{req.icon}</span>
                          <div>
                            <p className="text-sm font-semibold" style={{ color: COLORS.text }}>{req.title}</p>
                            <p className="text-xs" style={{ color: COLORS.textMuted }}>{req.desc}</p>
                          </div>
                        </div>
                      ))}
                    </div>
                    <div className="mt-3 pt-3 border-t flex justify-between text-xs" style={{ borderColor: COLORS.surface }}>
                      <span style={{ color: COLORS.textMuted }}>Min: {goal.minDays} days/week</span>
                      <span style={{ color: COLORS.accent }}>Ideal: {goal.idealDays} days/week</span>
                    </div>
                  </div>
                )}
              </div>
            ))}
          </div>
        )
      },
      {
        title: "Your experience level?",
        content: (
          <div className="space-y-3">
            {[
              { id: 'beginner', label: 'Beginner', desc: 'New to working out' },
              { id: 'intermediate', label: 'Intermediate', desc: '1-3 years experience' },
              { id: 'advanced', label: 'Advanced', desc: '3+ years experience' },
            ].map(level => (
              <button key={level.id} onClick={() => setUserData(p => ({...p, experience: level.id}))}
                className="w-full p-4 rounded-xl text-left"
                style={{ backgroundColor: userData.experience === level.id ? COLORS.primary + '20' : COLORS.surface,
                  border: `2px solid ${userData.experience === level.id ? COLORS.primary : COLORS.surfaceLight}` }}>
                <p className="font-semibold" style={{ color: userData.experience === level.id ? COLORS.primary : COLORS.text }}>{level.label}</p>
                <p className="text-sm" style={{ color: COLORS.textSecondary }}>{level.desc}</p>
              </button>
            ))}
          </div>
        )
      },
    ];

    const step = steps[onboardingStep];
    const canProceed = onboardingStep === 0 ? userData.goal : userData.experience;

    return (
      <div className="flex flex-col h-full">
        <div className="flex items-center gap-3 p-4">
          <button onClick={() => onboardingStep > 0 ? setOnboardingStep(onboardingStep - 1) : setCurrentScreen('dashboard')}>
            <ChevronLeft size={24} color={COLORS.text} />
          </button>
          <div className="flex-1 flex gap-1">
            {steps.map((_, i) => (
              <div key={i} className="flex-1 h-1 rounded-full" 
                style={{ backgroundColor: i <= onboardingStep ? COLORS.primary : COLORS.surfaceLight }} />
            ))}
          </div>
        </div>
        <div className="flex-1 overflow-auto px-6 pb-4">
          <h2 className="text-2xl font-bold mb-2" style={{ color: COLORS.text }}>{step.title}</h2>
          {step.subtitle && <p className="mb-6" style={{ color: COLORS.textSecondary }}>{step.subtitle}</p>}
          {step.content}
        </div>
        <div className="p-6">
          <button onClick={() => onboardingStep < steps.length - 1 ? setOnboardingStep(onboardingStep + 1) : setCurrentScreen('main')}
            disabled={!canProceed} className="w-full py-4 rounded-xl font-semibold text-lg"
            style={{ backgroundColor: COLORS.primary, color: COLORS.text, opacity: canProceed ? 1 : 0.5 }}>
            {onboardingStep < steps.length - 1 ? 'Continue' : 'Start Training'}
          </button>
        </div>
      </div>
    );
  };

  // Reschedule Modal
  const RescheduleModal = () => {
    // Base schedule for the next 14 days
    const baseSchedule = [
      { day: 'Wed', date: 'Jan 8', type: 'Push Day', isToday: true },
      { day: 'Thu', date: 'Jan 9', type: 'Pull Day' },
      { day: 'Fri', date: 'Jan 10', type: 'Leg Day' },
      { day: 'Sat', date: 'Jan 11', type: 'Rest' },
      { day: 'Sun', date: 'Jan 12', type: 'Rest' },
      { day: 'Mon', date: 'Jan 13', type: 'Push Day' },
      { day: 'Tue', date: 'Jan 14', type: 'Pull Day' },
      { day: 'Wed', date: 'Jan 15', type: 'Leg Day' },
      { day: 'Thu', date: 'Jan 16', type: 'Rest' },
      { day: 'Fri', date: 'Jan 17', type: 'Push Day' },
      { day: 'Sat', date: 'Jan 18', type: 'Pull Day' },
      { day: 'Sun', date: 'Jan 19', type: 'Rest' },
      { day: 'Mon', date: 'Jan 20', type: 'Leg Day' },
      { day: 'Tue', date: 'Jan 21', type: 'Rest' },
    ];

    const dayNames = ['Wed', 'Thu', 'Fri', 'Sat', 'Sun', 'Mon', 'Tue'];
    const dates = ['Jan 8', 'Jan 9', 'Jan 10', 'Jan 11', 'Jan 12', 'Jan 13', 'Jan 14', 'Jan 15', 'Jan 16', 'Jan 17', 'Jan 18', 'Jan 19', 'Jan 20', 'Jan 21'];

    const getUpdatedSchedule = () => {
      if (!rescheduleOption) return baseSchedule;

      const workouts = baseSchedule.map(d => d.type);
      let newSchedule = [];

      if (rescheduleOption === 'shift1') {
        // Shift all workouts by 1 day, today becomes rest
        newSchedule = dates.map((date, i) => ({
          day: dayNames[i % 7],
          date,
          type: i === 0 ? 'Rest' : workouts[i - 1],
          isToday: i === 0,
          changed: i <= workouts.findIndex((w, idx) => idx > 0 && workouts[idx] !== workouts[idx-1]) + 1
        }));
        // Mark first few as changed
        for (let i = 0; i < 5; i++) newSchedule[i].changed = true;
      } else if (rescheduleOption === 'shift2') {
        // Shift all workouts by 2 days
        newSchedule = dates.map((date, i) => ({
          day: dayNames[i % 7],
          date,
          type: i < 2 ? 'Rest' : workouts[i - 2],
          isToday: i === 0,
          changed: i < 6
        }));
      } else if (rescheduleOption === 'shift3') {
        // Shift all workouts by 3 days
        newSchedule = dates.map((date, i) => ({
          day: dayNames[i % 7],
          date,
          type: i < 3 ? 'Rest' : workouts[i - 3],
          isToday: i === 0,
          changed: i < 7
        }));
      } else if (rescheduleOption === 'swap') {
        // Swap today with tomorrow
        newSchedule = dates.map((date, i) => ({
          day: dayNames[i % 7],
          date,
          type: i === 0 ? workouts[1] : i === 1 ? workouts[0] : workouts[i],
          isToday: i === 0,
          changed: i < 2
        }));
      } else if (rescheduleOption === 'compress') {
        // Move to tomorrow but remove the next rest day to keep schedule tight
        const workoutsOnly = workouts.filter(w => w !== 'Rest');
        let restCount = 0;
        let workoutIdx = 0;
        newSchedule = dates.map((date, i) => {
          let type;
          if (i === 0) {
            type = 'Rest'; // Today becomes rest
          } else {
            // Insert workouts, skipping one rest day
            const originalType = workouts[i];
            if (originalType === 'Rest' && restCount === 0 && i > 0 && i < 6) {
              // Skip first rest day after today to compress
              restCount++;
              type = workouts[i + 1] || 'Rest';
            } else {
              type = i === 0 ? 'Rest' : workouts[i - 1 + restCount];
            }
          }
          return {
            day: dayNames[i % 7],
            date,
            type: type || 'Rest',
            isToday: i === 0,
            changed: i < 5
          };
        });
        // Simplified compress: shift by 1 but show compressed schedule note
        newSchedule = dates.map((date, i) => ({
          day: dayNames[i % 7],
          date,
          type: i === 0 ? 'Rest' : i === 1 ? 'Push Day' : i === 2 ? 'Pull Day' : i === 3 ? 'Leg Day' : i === 4 ? 'Push Day' : i === 5 ? 'Rest' : workouts[i],
          isToday: i === 0,
          changed: i < 5
        }));
      } else if (rescheduleOption === 'skip') {
        // Skip today's workout entirely, continue with rest of schedule
        newSchedule = dates.map((date, i) => ({
          day: dayNames[i % 7],
          date,
          type: i === 0 ? 'Skipped' : workouts[i],
          isToday: i === 0,
          changed: i === 0,
          skipped: i === 0
        }));
      }

      return newSchedule.slice(0, 10);
    };

    const schedule = getUpdatedSchedule();

    const options = [
      { id: 'shift1', label: 'Move to Tomorrow', desc: 'Shift entire schedule by 1 day', icon: 'üìÖ' },
      { id: 'shift2', label: 'Move 2 Days', desc: 'Shift entire schedule by 2 days', icon: 'üìÜ' },
      { id: 'shift3', label: 'Move 3 Days', desc: 'Shift entire schedule by 3 days', icon: 'üóìÔ∏è' },
      { id: 'swap', label: 'Swap with Tomorrow', desc: 'Do Pull Day today, Push Day tomorrow', icon: 'üîÑ' },
      { id: 'compress', label: 'Move & Compress', desc: 'Shift by 1 day, remove a rest day', icon: '‚ö°' },
      { id: 'skip', label: 'Skip This Workout', desc: 'Remove from schedule, continue as planned', icon: '‚è≠Ô∏è' },
    ];

    return (
      <div className="fixed inset-0 z-50 flex flex-col" style={{ backgroundColor: COLORS.background }}>
        <div className="p-4 border-b flex items-center gap-3" style={{ borderColor: COLORS.surfaceLight }}>
          <button onClick={() => { setRescheduleOption(null); setShowReschedule(false); }}>
            <ChevronLeft size={24} color={COLORS.text} />
          </button>
          <h2 className="text-lg font-bold" style={{ color: COLORS.text }}>Reschedule Workout</h2>
        </div>
        <div className="flex-1 overflow-auto p-4">
          <div className="p-3 rounded-xl mb-4 flex items-center gap-3" style={{ backgroundColor: COLORS.primary + '20' }}>
            <Dumbbell size={20} color={COLORS.primary} />
            <div>
              <p className="font-semibold" style={{ color: COLORS.text }}>Today: Push Day</p>
              <p className="text-sm" style={{ color: COLORS.textSecondary }}>Bench Press, OHP, Incline Press + 2 more</p>
            </div>
          </div>

          <p className="mb-3 font-semibold" style={{ color: COLORS.text }}>How would you like to reschedule?</p>
          <div className="space-y-2 mb-6">
            {options.map(option => (
              <button key={option.id} onClick={() => setRescheduleOption(option.id)}
                className="w-full p-4 rounded-xl flex items-center gap-3 text-left"
                style={{ backgroundColor: rescheduleOption === option.id ? COLORS.primary + '20' : COLORS.surface,
                  border: `2px solid ${rescheduleOption === option.id ? COLORS.primary : COLORS.surfaceLight}` }}>
                <span className="text-2xl">{option.icon}</span>
                <div className="flex-1">
                  <p className="font-semibold" style={{ color: rescheduleOption === option.id ? COLORS.primary : COLORS.text }}>{option.label}</p>
                  <p className="text-xs" style={{ color: COLORS.textMuted }}>{option.desc}</p>
                </div>
                {rescheduleOption === option.id && <Check size={20} color={COLORS.primary} />}
              </button>
            ))}
          </div>

          {rescheduleOption && (
            <>
              <div className="flex items-center justify-between mb-3">
                <h3 className="font-semibold" style={{ color: COLORS.text }}>Updated Schedule</h3>
                <span className="text-xs px-2 py-1 rounded" style={{ backgroundColor: COLORS.accent + '20', color: COLORS.accent }}>
                  {schedule.filter(d => d.changed).length} days affected
                </span>
              </div>
              <div className="space-y-1">
                {schedule.map((day, i) => (
                  <div key={i} className="p-3 rounded-xl flex items-center justify-between"
                    style={{ 
                      backgroundColor: day.skipped ? COLORS.error + '15' : day.changed ? COLORS.accent + '15' : COLORS.surface,
                      border: day.isToday ? `2px solid ${COLORS.primary}` : '1px solid transparent'
                    }}>
                    <div className="flex items-center gap-3">
                      <div className="w-12">
                        <p className="font-bold text-sm" style={{ color: day.isToday ? COLORS.primary : COLORS.text }}>{day.day}</p>
                        <p className="text-xs" style={{ color: COLORS.textMuted }}>{day.date.split(' ')[1]}</p>
                      </div>
                      <div className="flex items-center gap-2">
                        {day.type === 'Push Day' && <div className="w-2 h-2 rounded-full" style={{ backgroundColor: COLORS.primary }} />}
                        {day.type === 'Pull Day' && <div className="w-2 h-2 rounded-full" style={{ backgroundColor: COLORS.accent }} />}
                        {day.type === 'Leg Day' && <div className="w-2 h-2 rounded-full" style={{ backgroundColor: COLORS.warning }} />}
                        {day.type === 'Rest' && <div className="w-2 h-2 rounded-full" style={{ backgroundColor: COLORS.textMuted }} />}
                        {day.type === 'Skipped' && <div className="w-2 h-2 rounded-full" style={{ backgroundColor: COLORS.error }} />}
                        <p style={{ color: day.skipped ? COLORS.error : day.type === 'Rest' ? COLORS.textMuted : COLORS.text }}>{day.type}</p>
                      </div>
                    </div>
                    <div className="flex items-center gap-2">
                      {day.changed && !day.skipped && !day.isToday && (
                        <span className="text-xs px-2 py-0.5 rounded" style={{ backgroundColor: COLORS.accent + '30', color: COLORS.accent }}>
                          shifted
                        </span>
                      )}
                      {day.isToday && (
                        <span className="text-xs px-2 py-0.5 rounded" style={{ backgroundColor: COLORS.primary, color: COLORS.text }}>
                          Today
                        </span>
                      )}
                    </div>
                  </div>
                ))}
              </div>
              
              {rescheduleOption === 'compress' && (
                <div className="mt-4 p-3 rounded-xl flex items-start gap-2" style={{ backgroundColor: COLORS.warning + '15' }}>
                  <AlertCircle size={16} color={COLORS.warning} className="mt-0.5" />
                  <p className="text-xs" style={{ color: COLORS.textSecondary }}>
                    <strong style={{ color: COLORS.warning }}>Compressed schedule:</strong> A rest day has been removed to keep your program on track. Make sure you're recovering well!
                  </p>
                </div>
              )}
            </>
          )}
        </div>
        <div className="p-4 border-t" style={{ borderColor: COLORS.surfaceLight }}>
          <button onClick={() => { setRescheduleOption(null); setShowReschedule(false); }}
            disabled={!rescheduleOption} className="w-full py-4 rounded-xl font-semibold"
            style={{ backgroundColor: rescheduleOption === 'skip' ? COLORS.error : COLORS.primary, color: COLORS.text, opacity: rescheduleOption ? 1 : 0.5 }}>
            {rescheduleOption === 'skip' ? 'Skip Workout' : 'Confirm Reschedule'}
          </button>
        </div>
      </div>
    );
  };

  // Pause Plan Modal  
  // Pause Plan Modal with Calendar
  const PausePlanModal = () => {
    const today = new Date(2026, 0, 8); // Wed Jan 8, 2026
    
    const monthNames = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
    const dayNames = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
    
    const getDaysInMonth = (month, year) => new Date(year, month + 1, 0).getDate();
    const getFirstDayOfMonth = (month, year) => new Date(year, month, 1).getDay();
    
    const daysInMonth = getDaysInMonth(pauseCalendarMonth, pauseCalendarYear);
    const firstDay = getFirstDayOfMonth(pauseCalendarMonth, pauseCalendarYear);
    
    const isToday = (day) => {
      return day === today.getDate() && pauseCalendarMonth === today.getMonth() && pauseCalendarYear === today.getFullYear();
    };
    
    const isSelected = (day) => {
      if (!pauseDuration) return false;
      const selected = new Date(pauseDuration);
      return day === selected.getDate() && pauseCalendarMonth === selected.getMonth() && pauseCalendarYear === selected.getFullYear();
    };
    
    const isPast = (day) => {
      const date = new Date(pauseCalendarYear, pauseCalendarMonth, day);
      return date <= today;
    };
    
    const handleDateSelect = (day) => {
      if (isPast(day)) return;
      const selectedDate = new Date(pauseCalendarYear, pauseCalendarMonth, day);
      setPauseDuration(selectedDate.toISOString());
    };
    
    const formatSelectedDate = () => {
      if (!pauseDuration) return '';
      const date = new Date(pauseDuration);
      const days = Math.ceil((date - today) / (1000 * 60 * 60 * 24));
      return `${monthNames[date.getMonth()]} ${date.getDate()}, ${date.getFullYear()} (${days} days)`;
    };
    
    const changeMonth = (delta) => {
      let newMonth = pauseCalendarMonth + delta;
      let newYear = pauseCalendarYear;
      if (newMonth > 11) { newMonth = 0; newYear++; }
      if (newMonth < 0) { newMonth = 11; newYear--; }
      setPauseCalendarMonth(newMonth);
      setPauseCalendarYear(newYear);
    };
    
    const calendarDays = [];
    for (let i = 0; i < firstDay; i++) {
      calendarDays.push(null);
    }
    for (let i = 1; i <= daysInMonth; i++) {
      calendarDays.push(i);
    }

    return (
      <div className="fixed inset-0 z-50 flex flex-col" style={{ backgroundColor: COLORS.background }}>
        <div className="p-4 border-b flex items-center gap-3" style={{ borderColor: COLORS.surfaceLight }}>
          <button onClick={() => { setPauseDuration(null); setShowPausePlan(false); }}>
            <ChevronLeft size={24} color={COLORS.text} />
          </button>
          <h2 className="text-lg font-bold" style={{ color: COLORS.text }}>Take a Break</h2>
        </div>
        <div className="flex-1 overflow-auto p-4">
          {/* Supportive Message */}
          <div className="p-4 rounded-xl mb-4" style={{ backgroundColor: COLORS.surface }}>
            <div className="flex items-start gap-3">
              <span className="text-3xl">üå¥</span>
              <div>
                <h3 className="font-bold mb-1" style={{ color: COLORS.text }}>Rest is Part of Progress</h3>
                <p className="text-sm" style={{ color: COLORS.textSecondary }}>
                  Taking breaks is completely okay and often necessary! Whether it's a holiday, busy period, or you just need time off ‚Äî your body and mind will thank you.
                </p>
              </div>
            </div>
          </div>

          <p className="font-semibold mb-3" style={{ color: COLORS.text }}>When will you be back?</p>
          
          {/* Calendar */}
          <div className="rounded-xl p-4 mb-4" style={{ backgroundColor: COLORS.surface }}>
            {/* Month Navigation */}
            <div className="flex items-center justify-between mb-4">
              <button onClick={() => changeMonth(-1)} className="p-2 rounded-lg" style={{ backgroundColor: COLORS.surfaceLight }}>
                <ChevronLeft size={20} color={COLORS.text} />
              </button>
              <h4 className="font-bold" style={{ color: COLORS.text }}>{monthNames[pauseCalendarMonth]} {pauseCalendarYear}</h4>
              <button onClick={() => changeMonth(1)} className="p-2 rounded-lg" style={{ backgroundColor: COLORS.surfaceLight }}>
                <ChevronRight size={20} color={COLORS.text} />
              </button>
            </div>
            
            {/* Day Headers */}
            <div className="grid grid-cols-7 gap-1 mb-2">
              {dayNames.map(day => (
                <div key={day} className="text-center text-xs font-semibold py-1" style={{ color: COLORS.textMuted }}>
                  {day}
                </div>
              ))}
            </div>
            
            {/* Calendar Grid */}
            <div className="grid grid-cols-7 gap-1">
              {calendarDays.map((day, i) => (
                <button
                  key={i}
                  onClick={() => day && handleDateSelect(day)}
                  disabled={!day || isPast(day)}
                  className="aspect-square rounded-lg flex items-center justify-center text-sm font-medium transition-all"
                  style={{ 
                    backgroundColor: isSelected(day) ? COLORS.success : isToday(day) ? COLORS.primary : 'transparent',
                    color: !day ? 'transparent' : isPast(day) ? COLORS.textMuted : isSelected(day) || isToday(day) ? COLORS.text : COLORS.text,
                    opacity: !day ? 0 : isPast(day) ? 0.4 : 1,
                    cursor: !day || isPast(day) ? 'default' : 'pointer'
                  }}
                >
                  {day || ''}
                </button>
              ))}
            </div>
            
            {/* Legend */}
            <div className="flex items-center justify-center gap-4 mt-4 pt-3 border-t" style={{ borderColor: COLORS.surfaceLight }}>
              <div className="flex items-center gap-2">
                <div className="w-3 h-3 rounded" style={{ backgroundColor: COLORS.primary }} />
                <span className="text-xs" style={{ color: COLORS.textMuted }}>Today</span>
              </div>
              <div className="flex items-center gap-2">
                <div className="w-3 h-3 rounded" style={{ backgroundColor: COLORS.success }} />
                <span className="text-xs" style={{ color: COLORS.textMuted }}>Return Date</span>
              </div>
            </div>
          </div>

          {/* Selected Date Display */}
          {pauseDuration && (
            <div className="p-4 rounded-xl mb-4" style={{ backgroundColor: COLORS.success + '15', border: `1px solid ${COLORS.success}40` }}>
              <div className="flex items-center gap-3">
                <Calendar size={20} color={COLORS.success} />
                <div>
                  <p className="text-sm" style={{ color: COLORS.textSecondary }}>Returning on</p>
                  <p className="font-bold" style={{ color: COLORS.success }}>{formatSelectedDate()}</p>
                </div>
              </div>
            </div>
          )}

          {/* What happens during break */}
          <div className="p-4 rounded-xl" style={{ backgroundColor: COLORS.surfaceLight }}>
            <p className="text-sm font-semibold mb-2" style={{ color: COLORS.text }}>What happens when you're back:</p>
            <div className="space-y-2">
              {[
                { icon: 'üîÑ', text: 'Your schedule will be automatically recalculated' },
                { icon: 'üí™', text: 'Weights and reps adjusted based on your break length' },
                { icon: 'üî•', text: 'Streaks preserved ‚Äî we know life happens!' },
                { icon: 'üìà', text: 'Gradual ramp-up to get you back on track safely' },
              ].map((item, i) => (
                <div key={i} className="flex items-center gap-2">
                  <span>{item.icon}</span>
                  <p className="text-xs" style={{ color: COLORS.textSecondary }}>{item.text}</p>
                </div>
              ))}
            </div>
          </div>
        </div>
        <div className="p-4 border-t" style={{ borderColor: COLORS.surfaceLight }}>
          <button onClick={() => { setPauseDuration(null); setShowPausePlan(false); }}
            disabled={!pauseDuration} className="w-full py-4 rounded-xl font-semibold"
            style={{ backgroundColor: COLORS.success, color: COLORS.background, opacity: pauseDuration ? 1 : 0.5 }}>
            {pauseDuration ? `Pause Until ${new Date(pauseDuration).getDate()} ${monthNames[new Date(pauseDuration).getMonth()]}` : 'Select a Return Date'}
          </button>
        </div>
      </div>
    );
  };

  // Home Tab
  const HomeTab = () => (
    <div className="p-4 overflow-auto h-full">
      <div className="flex justify-between items-center mb-4">
        <div>
          <p style={{ color: COLORS.textSecondary }}>Good evening,</p>
          <h2 className="text-2xl font-bold" style={{ color: COLORS.text }}>{userData.firstName || 'Matt'}</h2>
        </div>
        <div className="w-10 h-10 rounded-full flex items-center justify-center" style={{ backgroundColor: COLORS.primary }}>
          <span className="font-bold" style={{ color: COLORS.text }}>M</span>
        </div>
      </div>

      <div className="mb-4">
        <div className="flex justify-between items-center mb-3">
          <h3 className="font-semibold" style={{ color: COLORS.text }}>Today's Workout</h3>
          <div className="flex gap-2">
            <button onClick={() => setShowPausePlan(true)} className="text-sm px-2 py-1 rounded flex items-center gap-1"
              style={{ backgroundColor: COLORS.surfaceLight, color: COLORS.textSecondary }}>
              <Moon size={14} /> Pause
            </button>
            <button onClick={() => setShowReschedule(true)} className="text-sm px-2 py-1 rounded flex items-center gap-1"
              style={{ backgroundColor: COLORS.surfaceLight, color: COLORS.textSecondary }}>
              <Calendar size={14} /> Reschedule
            </button>
          </div>
        </div>
        <div className="p-4 rounded-xl" style={{ backgroundColor: COLORS.surface, borderLeft: `4px solid ${COLORS.primary}` }}>
          <div className="flex justify-between items-center mb-2">
            <span className="px-2 py-1 rounded text-xs font-semibold" style={{ backgroundColor: COLORS.primary + '20', color: COLORS.primary }}>PUSH DAY</span>
            <span style={{ color: COLORS.textSecondary }}>60 min</span>
          </div>
          <h4 className="text-lg font-bold mb-1" style={{ color: COLORS.text }}>Push Day A</h4>
          <p className="text-sm mb-3" style={{ color: COLORS.textSecondary }}>5 exercises</p>
          <button onClick={() => setShowActiveWorkout(true)} className="w-full py-3 rounded-xl font-semibold flex items-center justify-center gap-2"
            style={{ backgroundColor: COLORS.primary, color: COLORS.text }}>
            Start Workout <Play size={16} />
          </button>
        </div>
      </div>

      <div className="mb-4">
        <h3 className="font-semibold mb-3" style={{ color: COLORS.text }}>Streaks</h3>
        <div className="grid grid-cols-4 gap-2">
          {[
            { icon: Dumbbell, value: streaks.weeklyWorkouts.weeksCompleted, label: 'weeks', color: COLORS.warning },
            { icon: Flame, value: streaks.calories.daysInRow, label: 'cal', color: COLORS.accent },
            { icon: Target, value: streaks.protein.daysInRow, label: 'protein', color: COLORS.primary },
            { icon: Droplets, value: streaks.water.daysInRow, label: 'water', color: '#448AFF' },
          ].map((s, i) => (
            <div key={i} className="p-3 rounded-xl text-center" style={{ backgroundColor: COLORS.surface }}>
              <s.icon size={20} color={s.color} className="mx-auto mb-1" />
              <p className="text-lg font-bold" style={{ color: COLORS.text }}>{s.value}</p>
              <p className="text-xs" style={{ color: COLORS.textMuted }}>{s.label}</p>
            </div>
          ))}
        </div>
      </div>

      <h3 className="font-semibold mb-3" style={{ color: COLORS.text }}>Today's Progress</h3>
      <div className="p-4 rounded-xl" style={{ backgroundColor: COLORS.surface }}>
        {[
          { label: 'Calories', current: caloriesIntake, target: 2200, color: COLORS.accent },
          { label: 'Protein', current: proteinIntake, target: 150, unit: 'g', color: COLORS.primary },
          { label: 'Water', current: waterIntake, target: 2500, unit: 'ml', color: '#448AFF' },
        ].map(item => (
          <div key={item.label} className="mb-3 last:mb-0">
            <div className="flex justify-between mb-1">
              <span style={{ color: COLORS.textSecondary }}>{item.label}</span>
              <span style={{ color: item.current >= item.target ? COLORS.success : COLORS.text }}>
                {item.current}{item.unit || ''} / {item.target}{item.unit || ''}
              </span>
            </div>
            <div className="h-3 rounded-full overflow-hidden" style={{ backgroundColor: COLORS.surfaceLight }}>
              <div className="h-full rounded-full" style={{ backgroundColor: item.color, width: `${Math.min((item.current / item.target) * 100, 100)}%` }} />
            </div>
          </div>
        ))}
      </div>

      {showReschedule && <RescheduleModal />}
      {showPausePlan && <PausePlanModal />}
      {showActiveWorkout && <ActiveWorkoutScreen onClose={() => setShowActiveWorkout(false)} COLORS={COLORS} />}
    </div>
  );

  // Main Screen with tabs
  const MainScreen = () => (
    <div className="flex flex-col h-full">
      <div className="flex-1 overflow-hidden">
        {activeTab === 'home' && <HomeTab />}
        {activeTab === 'workouts' && (
          <div className="p-4 h-full flex items-center justify-center">
            <p style={{ color: COLORS.textMuted }}>Workouts tab</p>
          </div>
        )}
        {activeTab === 'nutrition' && (
          <div className="p-4 h-full flex items-center justify-center">
            <p style={{ color: COLORS.textMuted }}>Nutrition tab</p>
          </div>
        )}
        {activeTab === 'progress' && (
          <div className="p-4 h-full flex items-center justify-center">
            <p style={{ color: COLORS.textMuted }}>Progress tab</p>
          </div>
        )}
        {activeTab === 'profile' && (
          <div className="p-4 h-full flex items-center justify-center">
            <p style={{ color: COLORS.textMuted }}>Profile tab</p>
          </div>
        )}
      </div>
      <div className="flex justify-around py-3 border-t" style={{ backgroundColor: COLORS.surface, borderColor: COLORS.surfaceLight }}>
        {[
          { id: 'home', icon: Home, label: 'Home' },
          { id: 'workouts', icon: Dumbbell, label: 'Workouts' },
          { id: 'nutrition', icon: Apple, label: 'Nutrition' },
          { id: 'progress', icon: TrendingUp, label: 'Progress' },
          { id: 'profile', icon: User, label: 'Profile' },
        ].map(tab => (
          <button key={tab.id} onClick={() => setActiveTab(tab.id)} className="flex flex-col items-center gap-1">
            <tab.icon size={22} color={activeTab === tab.id ? COLORS.primary : COLORS.textMuted} />
            <span className="text-xs" style={{ color: activeTab === tab.id ? COLORS.primary : COLORS.textMuted }}>{tab.label}</span>
          </button>
        ))}
      </div>
    </div>
  );

  return (
    <div className="w-full max-w-md mx-auto h-screen flex flex-col" style={{ backgroundColor: COLORS.background }}>
      <div className="flex-1 overflow-hidden relative">
        {currentScreen === 'welcome' && <WelcomeScreen />}
        {currentScreen === 'login' && <LoginScreen onBack={() => setCurrentScreen('welcome')} onLogin={() => setCurrentScreen('dashboard')} COLORS={COLORS} />}
        {currentScreen === 'register' && <RegisterScreen onBack={() => setCurrentScreen('welcome')} 
          onRegister={(data) => { setUserData(p => ({...p, ...data})); setCurrentScreen('onboarding'); }} COLORS={COLORS} />}
        {currentScreen === 'dashboard' && <DashboardScreen />}
        {currentScreen === 'onboarding' && <OnboardingScreen />}
        {currentScreen === 'main' && <MainScreen />}
      </div>
    </div>
  );
}
