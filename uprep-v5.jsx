import React, { useState, useRef, useEffect } from 'react';
import { LineChart, Line, XAxis, YAxis, ResponsiveContainer, Tooltip } from 'recharts';
import { ChevronRight, ChevronLeft, Check, Plus, Minus, Play, Pause, X, Droplets, Moon, TrendingUp, TrendingDown, User, Home, Dumbbell, Apple, BarChart3, Trophy, Flame, Clock, Target, Info, Calendar, AlertCircle, Zap, Coffee, Utensils, ChevronDown, ChevronUp, Eye, Undo2, Search, Book, History, Award, Edit3, Filter, ArrowLeftRight, GripVertical, Users, Heart, MessageCircle, Share2, Crown, Medal, Loader2, Settings, Sprout, RefreshCw, Scale, Scissors, Wind, Timer, Activity, Star, Sparkles, PartyPopper, Bell, UserPlus, Lock, Bookmark, Upload, Trash2, Camera, RotateCcw } from 'lucide-react';

// Icon mapping helper - converts icon names to Lucide components
const IconMap = ({ name, size = 24, color, className }) => {
  const icons = {
    dumbbell: Dumbbell,
    target: Target,
    'refresh-cw': RefreshCw,
    heart: Heart,
    zap: Zap,
    scissors: Scissors,
    flame: Flame,
    utensils: Utensils,
    moon: Moon,
    calendar: Calendar,
    'trending-up': TrendingUp,
    clock: Clock,
    scale: Scale,
    wind: Wind,
    sprout: Sprout,
    crown: Crown,
    trophy: Trophy,
    activity: Activity,
    star: Star,
    sparkles: Sparkles,
    apple: Apple,
    droplets: Droplets,
    timer: Timer,
    'party-popper': PartyPopper,
    user: User,
    award: Award,
    users: Users,
  };
  const Icon = icons[name] || Target;
  return <Icon size={size} color={color} className={className} />;
};

// Helper to get workout icon and color based on focus area
const getWorkoutStyle = (focus) => {
  const focusLower = (focus || '').toLowerCase();
  if (focusLower.includes('chest') || focusLower.includes('push')) {
    return { icon: 'target', color: '#FF6B6B', label: 'Push' };
  }
  if (focusLower.includes('back') || focusLower.includes('pull')) {
    return { icon: 'activity', color: '#4ECDC4', label: 'Pull' };
  }
  if (focusLower.includes('leg') || focusLower.includes('quad') || focusLower.includes('glute')) {
    return { icon: 'zap', color: '#45B7D1', label: 'Legs' };
  }
  if (focusLower.includes('arm') || focusLower.includes('bicep') || focusLower.includes('tricep')) {
    return { icon: 'flame', color: '#F7DC6F', label: 'Arms' };
  }
  if (focusLower.includes('shoulder') || focusLower.includes('delt')) {
    return { icon: 'star', color: '#BB8FCE', label: 'Shoulders' };
  }
  if (focusLower.includes('core') || focusLower.includes('ab')) {
    return { icon: 'sparkles', color: '#F39C12', label: 'Core' };
  }
  if (focusLower.includes('cardio') || focusLower.includes('hiit')) {
    return { icon: 'heart', color: '#E74C3C', label: 'Cardio' };
  }
  if (focusLower.includes('full body') || focusLower.includes('strength')) {
    return { icon: 'crown', color: '#9B59B6', label: 'Full Body' };
  }
  if (focusLower.includes('power') || focusLower.includes('athletic')) {
    return { icon: 'trophy', color: '#1ABC9C', label: 'Power' };
  }
  return { icon: 'dumbbell', color: '#3498DB', label: 'Workout' };
};

// Format time ago for activity timestamps
const formatActivityTime = (dateString) => {
  if (!dateString) return '';
  const date = new Date(dateString);
  const now = new Date();
  const diffMs = now - date;
  const diffMins = Math.floor(diffMs / (1000 * 60));
  const diffHours = Math.floor(diffMs / (1000 * 60 * 60));
  const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));

  if (diffMins < 1) return 'Just now';
  if (diffMins < 60) return `${diffMins}m ago`;
  if (diffHours < 24) return `${diffHours}h ago`;
  if (diffDays === 1) return 'Yesterday';
  if (diffDays < 7) return `${diffDays}d ago`;
  return date.toLocaleDateString();
};

// Render comment content with @mentions highlighted
const renderCommentWithMentions = (content, COLORS, onMentionClick) => {
  if (!content) return null;
  // Match @username patterns (alphanumeric and underscores)
  const mentionRegex = /@(\w+)/g;
  const parts = [];
  let lastIndex = 0;
  let match;

  while ((match = mentionRegex.exec(content)) !== null) {
    // Add text before the mention
    if (match.index > lastIndex) {
      parts.push(content.substring(lastIndex, match.index));
    }
    // Add the mention as a styled span
    const username = match[1];
    parts.push(
      <span
        key={match.index}
        onClick={() => onMentionClick && onMentionClick(username)}
        style={{
          color: COLORS.primary,
          fontWeight: 600,
          cursor: onMentionClick ? 'pointer' : 'default'
        }}
      >
        @{username}
      </span>
    );
    lastIndex = match.index + match[0].length;
  }
  // Add remaining text
  if (lastIndex < content.length) {
    parts.push(content.substring(lastIndex));
  }
  return parts.length > 0 ? parts : content;
};

// Star rating component with half-star support
const StarRating = ({ rating, onRate, size = 16, readonly = false, color = '#F7DC6F' }) => {
  // Map decimal to clip width that looks visually proportional
  // Star shape has thin tips and wide center, so linear % doesn't look right
  const getClipWidth = (decimal) => {
    if (decimal <= 0) return 0;
    if (decimal >= 1) return 100;
    // Mapping designed so each .1 increment is visually distinct
    const widthMap = {
      0.1: 8,    // tiny left tip
      0.2: 18,   // small wedge
      0.3: 30,   // clear portion visible
      0.4: 42,   // approaching half
      0.5: 50,   // half star
      0.6: 58,   // past half
      0.7: 68,   // good portion
      0.8: 78,   // most of star but gap visible
      0.9: 88,   // almost full, small gap on right
    };
    const rounded = Math.round(decimal * 10) / 10;
    return widthMap[rounded] || decimal * 100;
  };

  return (
    <div className="flex items-center gap-0.5">
      {[1, 2, 3, 4, 5].map((star) => {
        // Calculate fill: full stars get 100%, partial star gets decimal, empty get 0
        let fillDecimal = 0;
        if (star <= Math.floor(rating)) {
          fillDecimal = 1;
        } else if (star === Math.ceil(rating) && rating % 1 > 0) {
          fillDecimal = rating % 1;
        }

        const clipWidth = getClipWidth(fillDecimal);

        return (
          <button
            key={star}
            onClick={() => !readonly && onRate && onRate(star)}
            disabled={readonly}
            className={readonly ? '' : 'hover:scale-110 transition-transform'}
            style={{ cursor: readonly ? 'default' : 'pointer', position: 'relative' }}
          >
            {/* Background star (empty outline) */}
            <Star
              size={size}
              color={color}
              fill="transparent"
              style={{ opacity: 0.3 }}
            />
            {/* Foreground star clipped to show partial fill */}
            {clipWidth > 0 && (
              <div
                style={{
                  position: 'absolute',
                  top: 0,
                  left: 0,
                  width: `${clipWidth}%`,
                  overflow: 'hidden'
                }}
              >
                <Star
                  size={size}
                  color={color}
                  fill={color}
                />
              </div>
            )}
          </button>
        );
      })}
    </div>
  );
};

import { useAuth } from './src/contexts/AuthContext';
import { supabase } from './src/lib/supabase';
import { workoutService } from './src/services/workoutService';
import { sleepService } from './src/services/sleepService';
import { streakService } from './src/services/streakService';
import { nutritionService } from './src/services/nutritionService';
import { profileService } from './src/services/profileService';
import { injuryService } from './src/services/injuryService';
import { socialService } from './src/services/socialService';
import { notificationService } from './src/services/notificationService';
import { workoutRatingService } from './src/services/workoutRatingService';
import { publishedWorkoutService } from './src/services/publishedWorkoutService';
import { storageService } from './src/services/storageService';
import { foodRecognitionService } from './src/services/foodRecognitionService';
import { foodService } from './src/services/foodService';
import { exerciseService } from './src/services/exerciseService';
import { competitionService } from './src/services/competitionService';
import { accountabilityService } from './src/services/accountabilityService';
import { prLeaderboardService } from './src/services/prLeaderboardService';
import { generateNutritionTargets, projectWeightProgress, generateWorkoutSchedule, calculateSuggestedWeight } from './src/utils/fitnessCalculations';

// Helper function to get local date string in YYYY-MM-DD format (avoids UTC timezone issues)
const getLocalDateString = (date = new Date()) => {
  return `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
};

// Format date as relative time (Today at 2:30 PM, Yesterday, 3 days ago, etc.)
const formatRelativeDate = (dateString) => {
  const date = new Date(dateString);
  const now = new Date();
  const diffMs = now - date;
  const diffSecs = Math.floor(diffMs / 1000);
  const diffMins = Math.floor(diffSecs / 60);
  const diffHours = Math.floor(diffMins / 60);
  const diffDays = Math.floor(diffHours / 24);
  const diffWeeks = Math.floor(diffDays / 7);
  const diffMonths = Math.floor(diffDays / 30);
  const diffYears = Math.floor(diffDays / 365);

  const timeStr = date.toLocaleTimeString([], { hour: 'numeric', minute: '2-digit' });

  // Check if same day
  const isToday = date.toDateString() === now.toDateString();
  const yesterday = new Date(now);
  yesterday.setDate(yesterday.getDate() - 1);
  const isYesterday = date.toDateString() === yesterday.toDateString();

  if (isToday) {
    return `Today at ${timeStr}`;
  } else if (isYesterday) {
    return `Yesterday at ${timeStr}`;
  } else if (diffDays < 7) {
    return `${diffDays} day${diffDays === 1 ? '' : 's'} ago`;
  } else if (diffWeeks === 1) {
    return 'Last week';
  } else if (diffWeeks < 4) {
    return `${diffWeeks} weeks ago`;
  } else if (diffMonths === 1) {
    return '1 month ago';
  } else if (diffMonths < 12) {
    return `${diffMonths} months ago`;
  } else if (diffYears === 1) {
    return '1 year ago';
  } else {
    return `${diffYears} years ago`;
  }
};

// Dark mode color palette
const COLORS_DARK = {
  primary: '#06B6D4',        // Cyan - fresh, energetic, modern
  primaryDark: '#0891B2',    // Darker cyan for hover/pressed
  accent: '#22D3EE',         // Lighter cyan accent
  background: '#0D0F12',     // Dark background
  surface: '#121417',        // Card surface
  surfaceLight: '#1E2024',   // Slightly lighter surface
  text: '#F3F4F6',           // Primary text (slightly brighter)
  textSecondary: '#D1D5DB',  // Secondary text
  textMuted: '#9CA3AF',      // Muted text
  success: '#22C55E',        // Green - ONLY for success, wins, completed
  warning: '#FBBF24',        // Yellow warning
  error: '#EF4444',          // Red error
  border: '#2A2D32',         // Subtle borders
  // Category colors (all visually distinct)
  water: '#60A5FA',          // Blue - water
  sleep: '#C4B5FD',          // Soft lavender - sleep
  fats: '#F59E0B',           // Amber - fats
  protein: '#F472B6',        // Pink - protein
  carbs: '#FB923C',          // Orange - carbs
  supplements: '#FBBF24',    // Yellow - supplements (electric/zap)
};

// Light mode color palette
const COLORS_LIGHT = {
  primary: '#0891B2',        // Cyan 600 - slightly darker for light bg
  primaryDark: '#0E7490',    // Cyan 700
  accent: '#06B6D4',         // Cyan 500
  background: '#F8FAFC',     // Slate 50 - clean white
  surface: '#FFFFFF',        // White card surface
  surfaceLight: '#E2E8F0',   // Slate 200 - dividers
  text: '#0F172A',           // Slate 900 - dark text
  textSecondary: '#475569',  // Slate 600
  textMuted: '#94A3B8',      // Slate 400
  success: '#16A34A',        // Green 600 - success only
  warning: '#EAB308',        // Yellow 500
  error: '#DC2626',          // Red 600
  border: '#E2E8F0',         // Slate 200
  // Category colors
  water: '#3B82F6',          // Blue
  sleep: '#A78BFA',          // Violet
  fats: '#F59E0B',           // Amber
  protein: '#EC4899',        // Pink
  carbs: '#F97316',          // Orange
  supplements: '#EAB308',    // Yellow - supplements
};

// Default to dark mode
const COLORS = COLORS_DARK;

// Suggested supplements with reasons
const SUGGESTED_SUPPLEMENTS = [
  {
    id: 'creatine',
    name: 'Creatine Monohydrate',
    dosage: '5 g',
    reasons: [
      'Most researched supplement for muscle & strength',
      'Improves high-intensity exercise performance',
      'Safe for long-term daily use',
      'Supports brain health and cognitive function',
    ],
    forGoals: ['all'], // Show to everyone
  },
];

// Experience levels - expanded from 3 to 4 tiers
const EXPERIENCE_LEVELS = {
  beginner: {
    id: 'beginner',
    label: 'Beginner',
    desc: 'New to lifting (0-6 months)',
    icon: 'sprout',
    showHeadSpecificity: false,
    workoutComplexity: 'basic',
  },
  novice: {
    id: 'novice',
    label: 'Novice',
    desc: 'Learning the basics (6-18 months)',
    icon: 'trending-up',
    showHeadSpecificity: false,
    workoutComplexity: 'basic',
  },
  experienced: {
    id: 'experienced',
    label: 'Experienced',
    desc: 'Consistent training (1.5-4 years)',
    icon: 'dumbbell',
    showHeadSpecificity: true,
    workoutComplexity: 'advanced',
  },
  expert: {
    id: 'expert',
    label: 'Expert',
    desc: 'Advanced lifter (4+ years)',
    icon: 'crown',
    showHeadSpecificity: true,
    workoutComplexity: 'advanced',
  },
};

// Equipment options for gym setup
const EQUIPMENT_OPTIONS = [
  { id: 'Barbell', name: 'Barbells', icon: 'dumbbell', desc: 'Bench press, squats, deadlifts' },
  { id: 'Dumbbells', name: 'Dumbbells', icon: 'dumbbell', desc: 'Versatile free weights' },
  { id: 'Cable', name: 'Cable Machine', icon: 'activity', desc: 'Pulldowns, rows, flyes' },
  { id: 'Machine', name: 'Weight Machines', icon: 'settings', desc: 'Guided resistance machines' },
  { id: 'Bodyweight', name: 'Bodyweight', icon: 'user', desc: 'Pull-ups, dips, push-ups' },
  { id: 'Kettlebell', name: 'Kettlebells', icon: 'circle', desc: 'Swings, cleans, presses' },
  { id: 'Bands', name: 'Resistance Bands', icon: 'minus', desc: 'Portable resistance training' },
  { id: 'Smith', name: 'Smith Machine', icon: 'square', desc: 'Guided barbell movements' },
];

// Muscle head mappings for advanced users
const MUSCLE_HEAD_MAPPINGS = {
  'Biceps': ['Long Head Biceps', 'Short Head Biceps'],
  'Triceps': ['Long Head Triceps', 'Lateral Head Triceps', 'Medial Head Triceps'],
  'Back': ['Upper Back', 'Mid Back', 'Lower Back'],
  'Quads': ['Vastus Lateralis', 'Vastus Medialis', 'Rectus Femoris'],
  'Hamstrings': ['Bicep Femoris', 'Semitendinosus'],
  'Glutes': ['Gluteus Maximus', 'Gluteus Medius'],
  // Already have specificity:
  // Shoulders -> Front Delts, Side Delts, Rear Delts
  // Chest -> Upper Chest, Lower Chest, Chest
};

// Programs ordered from weight gain to weight loss
const GOAL_INFO = {
  bulk: {
    title: 'Mass Building (Bulk)',
    icon: 'dumbbell',
    overview: "Maximize muscle and size gains with a calorie surplus.",
    requirements: [
      { icon: 'utensils', title: 'Calorie Surplus', desc: 'Eat 300-500 calories above maintenance.' },
      { icon: 'dumbbell', title: 'Heavy Training', desc: 'Focus on compound lifts with progressive overload.' },
      { icon: 'apple', title: 'High Protein', desc: 'Aim for 1.8-2.2g protein per kg bodyweight.' },
      { icon: 'moon', title: 'Recovery', desc: 'Sleep 7-9 hours for optimal muscle growth.' },
    ],
    minDays: 4,
    idealDays: '4-6',
    weightDirection: 'gain',
  },
  build_muscle: {
    title: 'Lean Muscle Building',
    icon: 'target',
    overview: "Build muscle while minimizing fat gain with a slight surplus.",
    requirements: [
      { icon: 'dumbbell', title: 'Progressive Overload', desc: 'Gradually increase weight, reps, or sets.' },
      { icon: 'calendar', title: 'Consistency', desc: 'Results come from stacking sessions week after week.' },
      { icon: 'apple', title: 'Protein-Rich Diet', desc: 'Aim for 1.6-2.2g protein per kg bodyweight.' },
      { icon: 'moon', title: 'Quality Sleep', desc: '7-9 hours per night for muscle repair.' },
    ],
    minDays: 3,
    idealDays: '4-5',
    weightDirection: 'gain',
  },
  strength: {
    title: 'Strength & Power',
    icon: 'dumbbell',
    overview: "Maximize strength through heavy compound lifts.",
    requirements: [
      { icon: 'target', title: 'Heavy Compounds', desc: 'Focus on squat, bench, deadlift, overhead press.' },
      { icon: 'trending-up', title: 'Low Reps, High Weight', desc: '1-6 rep range with heavy loads.' },
      { icon: 'clock', title: 'Rest Periods', desc: 'Take 3-5 minutes rest between heavy sets.' },
    ],
    minDays: 3,
    idealDays: '3-4',
    weightDirection: 'maintain',
  },
  recomp: {
    title: 'Body Recomposition',
    icon: 'refresh-cw',
    overview: "Build muscle and lose fat simultaneously at maintenance calories.",
    requirements: [
      { icon: 'scale', title: 'Maintenance Calories', desc: 'Eat at or slightly below TDEE.' },
      { icon: 'apple', title: 'Very High Protein', desc: 'Aim for 2.0-2.4g protein per kg bodyweight.' },
      { icon: 'dumbbell', title: 'Heavy Training', desc: 'Prioritize strength training to preserve muscle.' },
      { icon: 'timer', title: 'Patience', desc: 'This approach is slower but sustainable.' },
    ],
    minDays: 3,
    idealDays: '4-5',
    weightDirection: 'maintain',
  },
  fitness: {
    title: 'General Fitness',
    icon: 'heart',
    overview: "Overall fitness combining strength, cardio, and mobility.",
    requirements: [
      { icon: 'refresh-cw', title: 'Variety', desc: 'Mix resistance training, cardio, and flexibility.' },
      { icon: 'heart', title: 'Heart Health', desc: '150 mins moderate cardio per week minimum.' },
      { icon: 'activity', title: 'Mobility', desc: 'Include stretching and mobility work.' },
    ],
    minDays: 2,
    idealDays: '3-5',
    weightDirection: 'maintain',
  },
  athletic: {
    title: 'Athletic Performance',
    icon: 'zap',
    overview: "Optimize for sports performance, speed, and agility.",
    requirements: [
      { icon: 'activity', title: 'Conditioning', desc: 'Mix strength with sport-specific cardio.' },
      { icon: 'wind', title: 'Speed & Power', desc: 'Include plyometrics and explosive movements.' },
      { icon: 'refresh-cw', title: 'Mobility', desc: 'Prioritize flexibility and injury prevention.' },
    ],
    minDays: 3,
    idealDays: '4-5',
    weightDirection: 'maintain',
  },
  lean: {
    title: 'Getting Lean (Cut)',
    icon: 'scissors',
    overview: "Shed fat while preserving muscle with a moderate deficit.",
    requirements: [
      { icon: 'utensils', title: 'Moderate Deficit', desc: 'Eat 300-400 calories below maintenance.' },
      { icon: 'apple', title: 'High Protein', desc: 'Keep protein at 2.0g+ per kg to preserve muscle.' },
      { icon: 'dumbbell', title: 'Maintain Intensity', desc: 'Keep lifting heavy to signal muscle retention.' },
    ],
    minDays: 3,
    idealDays: '4-5',
    weightDirection: 'lose',
  },
  lose_fat: {
    title: 'Fat Loss',
    icon: 'flame',
    overview: "Aggressive fat loss with a larger calorie deficit.",
    requirements: [
      { icon: 'utensils', title: 'Calorie Deficit', desc: 'Eat 500-750 calories below maintenance.' },
      { icon: 'activity', title: 'Cardio + Weights', desc: 'Combine resistance training with cardio.' },
      { icon: 'apple', title: 'Very High Protein', desc: 'Maximize protein to preserve muscle mass.' },
    ],
    minDays: 3,
    idealDays: '4-6',
    weightDirection: 'lose',
  },
};

// All available workout programs/splits that users can choose from
// These are templates - the actual schedule is generated based on user's days_per_week setting
const AVAILABLE_PROGRAMS = [
  { id: 'ppl', name: 'Push/Pull/Legs', days: 6, weeks: 12, desc: 'High volume split for maximum muscle growth', schedule: ['push', 'pull', 'legs_quad', 'push', 'pull', 'legs_posterior'] },
  { id: 'upper_lower', name: 'Upper/Lower', days: 4, weeks: 16, desc: 'Balanced approach with optimal recovery', schedule: ['upper', 'lower', 'upper', 'lower'] },
  { id: 'full_body', name: 'Full Body', days: 3, weeks: 12, desc: 'Efficient training for overall fitness', schedule: ['full_body', 'full_body', 'full_body'] },
  { id: 'strength', name: 'Strength Focus', days: 4, weeks: 12, desc: 'Powerlifting-style training for max strength', schedule: ['upper', 'lower', 'upper', 'lower'] },
  { id: 'ppl_5day', name: 'PPL + Upper/Lower', days: 5, weeks: 12, desc: '5-day hybrid for balanced volume', schedule: ['push', 'pull', 'legs_quad', 'upper', 'lower'] },
  { id: 'bro_split', name: 'Bro Split', days: 5, weeks: 12, desc: 'Classic bodybuilding split - one muscle group per day', schedule: ['chest', 'back', 'shoulders', 'legs_quad', 'arms'] },
  { id: 'athlete', name: 'Athletic Performance', days: 5, weeks: 12, desc: 'Speed, agility, and power focus', schedule: ['push', 'pull', 'legs_quad', 'upper', 'lower'] },
  { id: 'fat_loss', name: 'Fat Loss Circuit', days: 4, weeks: 8, desc: 'High intensity with cardio elements', schedule: ['full_body', 'full_body', 'full_body', 'full_body'] },
];

// Program templates that adapt to any number of days per week
const PROGRAM_TEMPLATES = [
  {
    id: 'ppl',
    name: 'Push/Pull/Legs',
    desc: 'Classic bodybuilding split targeting each muscle group optimally',
    cycle: ['push', 'pull', 'legs_quad', 'push', 'pull', 'legs_posterior'], // 6-workout cycle
    minDays: 3,
    maxDays: 6,
  },
  {
    id: 'upper_lower',
    name: 'Upper/Lower Split',
    desc: 'Balanced approach with great recovery between sessions',
    cycle: ['upper', 'lower', 'upper', 'lower'], // 4-workout cycle
    minDays: 2,
    maxDays: 6,
  },
  {
    id: 'full_body',
    name: 'Full Body',
    desc: 'Hit every muscle each session - efficient and effective',
    cycle: ['full_body', 'full_body', 'full_body'], // 3-workout cycle
    minDays: 2,
    maxDays: 6,
  },
  {
    id: 'bro_split',
    name: 'Bro Split',
    desc: 'One muscle group per day for maximum focus and volume',
    cycle: ['chest', 'back', 'shoulders', 'legs_quad', 'arms'], // 5-workout cycle
    minDays: 3,
    maxDays: 6,
  },
];

// Generate schedule for a given program template and user's days per week
const generateProgramSchedule = (template, daysPerWeek, restDays, weeks = 4) => {
  const schedule = [];
  let cycleIndex = 0;
  const dayNames = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];

  for (let week = 0; week < weeks; week++) {
    const weekSchedule = [];
    for (let day = 0; day < 7; day++) {
      if (restDays.includes(day)) {
        weekSchedule.push({ day: dayNames[day], isRest: true, workout: null });
      } else {
        // Check if we've already scheduled enough workouts this week
        const workoutsThisWeek = weekSchedule.filter(d => !d.isRest).length;
        if (workoutsThisWeek < daysPerWeek) {
          weekSchedule.push({
            day: dayNames[day],
            isRest: false,
            workout: template.cycle[cycleIndex % template.cycle.length],
          });
          cycleIndex++;
        } else {
          weekSchedule.push({ day: dayNames[day], isRest: true, workout: null });
        }
      }
    }
    schedule.push(weekSchedule);
  }
  return schedule;
};

// Map goals to recommended programs - program is auto-selected based on user's goal
const GOAL_TO_PROGRAM = {
  bulk: AVAILABLE_PROGRAMS.find(p => p.id === 'ppl'),
  build_muscle: AVAILABLE_PROGRAMS.find(p => p.id === 'upper_lower'),
  strength: AVAILABLE_PROGRAMS.find(p => p.id === 'strength'),
  recomp: AVAILABLE_PROGRAMS.find(p => p.id === 'upper_lower'),
  fitness: AVAILABLE_PROGRAMS.find(p => p.id === 'full_body'),
  athletic: AVAILABLE_PROGRAMS.find(p => p.id === 'athlete'),
  lean: AVAILABLE_PROGRAMS.find(p => p.id === 'fat_loss'),
  lose_fat: AVAILABLE_PROGRAMS.find(p => p.id === 'fat_loss'),
};

// Suggested next programs based on current program completion
const NEXT_PROGRAM_SUGGESTIONS = {
  ppl: [
    { id: 'strength', name: 'Strength Focus', days: 4, weeks: 12, desc: 'Build on your muscle with raw strength', reason: 'Great for converting muscle gains to strength' },
    { id: 'fat_loss_cut', name: 'Cutting Phase', days: 5, weeks: 8, desc: 'Reveal your hard-earned muscle', reason: 'Time to shred and show off your gains' },
    { id: 'upper_lower', name: 'Upper/Lower', days: 4, weeks: 16, desc: 'More recovery, continued growth', reason: 'Allows recovery while maintaining gains' },
  ],
  upper_lower: [
    { id: 'ppl', name: 'Push/Pull/Legs', days: 6, weeks: 12, desc: 'Increase volume for more growth', reason: 'Take your gains to the next level' },
    { id: 'fat_loss_cut', name: 'Cutting Phase', days: 4, weeks: 10, desc: 'Define your physique', reason: 'Reveal the muscle you\'ve built' },
    { id: 'strength', name: 'Strength Focus', days: 4, weeks: 12, desc: 'Focus on getting stronger', reason: 'Convert your muscle to strength' },
  ],
  strength: [
    { id: 'ppl', name: 'Push/Pull/Legs', days: 6, weeks: 12, desc: 'Add muscle to your frame', reason: 'Build muscle on your strength base' },
    { id: 'fat_loss_cut', name: 'Cutting Phase', days: 4, weeks: 8, desc: 'Get lean and defined', reason: 'Show off your strength with less body fat' },
    { id: 'athlete', name: 'Athletic Performance', days: 5, weeks: 12, desc: 'Apply your strength athletically', reason: 'Develop power and explosiveness' },
  ],
  full_body: [
    { id: 'upper_lower', name: 'Upper/Lower', days: 4, weeks: 16, desc: 'Progress to a split routine', reason: 'More volume per muscle group' },
    { id: 'ppl', name: 'Push/Pull/Legs', days: 6, weeks: 12, desc: 'Maximize your training', reason: 'For serious muscle building' },
  ],
  fat_loss: [
    { id: 'upper_lower', name: 'Upper/Lower', days: 4, weeks: 16, desc: 'Build lean muscle', reason: 'Now focus on building muscle' },
    { id: 'full_body', name: 'Full Body', days: 3, weeks: 12, desc: 'Maintain with less time', reason: 'Efficient maintenance training' },
  ],
  athlete: [
    { id: 'strength', name: 'Strength Focus', days: 4, weeks: 12, desc: 'Maximize your strength', reason: 'Build a stronger foundation' },
    { id: 'ppl', name: 'Push/Pull/Legs', days: 6, weeks: 12, desc: 'Add muscle mass', reason: 'Increase your power potential' },
  ],
};

// Break duration options between programs
const BREAK_OPTIONS = [
  { id: 'none', label: 'No Break', days: 0, desc: 'Jump right in' },
  { id: '1week', label: '1 Week', days: 7, desc: 'Quick refresh' },
  { id: '2weeks', label: '2 Weeks', days: 14, desc: 'Standard deload' },
  { id: '1month', label: '1 Month', days: 30, desc: 'Full recovery' },
];

// Exercise instructions - step by step guides for each exercise
const EXERCISE_INSTRUCTIONS = {
  // CHEST
  'Barbell Bench Press': {
    setup: ['Lie flat on the bench with your eyes under the bar', 'Plant your feet firmly on the floor', 'Grip the bar slightly wider than shoulder width', 'Arch your upper back slightly, squeeze shoulder blades together', 'Unrack the bar with arms fully extended'],
    execution: ['Lower the bar slowly to your mid-chest', 'Keep elbows at about 45 degrees from your body', 'Touch your chest lightly (don\'t bounce)', 'Press the bar back up in a slight arc toward your face', 'Lock out your arms at the top'],
    tips: ['Grip width affects emphasis: wider = more chest, narrower = more triceps', 'The bar should touch your chest at nipple line or slightly below', 'If your shoulders hurt, try a slightly narrower grip or reduce arch']
  },
  'Dumbbell Bench Press': {
    setup: ['Sit on the bench with dumbbells on your thighs', 'Lie back and use your knees to help lift dumbbells to chest level', 'Position dumbbells at chest height, palms facing forward', 'Plant feet firmly on the floor'],
    execution: ['Press dumbbells up until arms are extended', 'Bring dumbbells together at the top (don\'t clang them)', 'Lower slowly with control to chest level', 'Keep elbows at 45 degrees from your body'],
    tips: ['Dumbbells allow deeper stretch than barbell - use it for more muscle activation', 'Rotate palms inward at top for extra chest squeeze', 'Stabilizer muscles work harder here - expect to lift 15-20% less than barbell']
  },
  'Incline Barbell Press': {
    setup: ['Set bench to 30-45 degree incline', 'Lie back with eyes under the bar', 'Grip slightly wider than shoulder width', 'Unrack with arms fully extended'],
    execution: ['Lower bar to upper chest (just below collarbone)', 'Keep elbows at 45 degrees', 'Press back up to starting position', 'Lock out at the top'],
    tips: ['30 degrees targets upper chest best - 45 degrees shifts more to front delts', 'If you feel it more in shoulders, lower the incline angle', 'Touch point should be higher on chest than flat bench']
  },
  'Incline Dumbbell Press': {
    setup: ['Set bench to 30-45 degree incline', 'Sit with dumbbells on thighs, lie back', 'Position dumbbells at upper chest level', 'Feet flat on floor'],
    execution: ['Press dumbbells up and slightly together', 'Lower with control to upper chest', 'Keep elbows at 45 degrees throughout', 'Full range of motion - stretch at bottom'],
    tips: ['Angle dumbbells slightly inward to maximize upper chest contraction', 'Go lighter than flat bench - upper chest is a smaller muscle', 'This is arguably the best upper chest builder - prioritize it if lagging']
  },
  'Cable Fly': {
    setup: ['Set pulleys to shoulder height or slightly above', 'Grab handles and step forward into a staggered stance', 'Start with arms out wide, slight bend in elbows', 'Lean slightly forward from the hips'],
    execution: ['Bring hands together in a hugging motion', 'Squeeze your chest at the center', 'Slowly return to the starting position', 'Maintain the slight bend in elbows throughout'],
    tips: ['High cables target lower chest, low cables target upper chest', 'Cross hands over each other at the end for extra squeeze', 'This is an isolation move - save it for after your heavy pressing']
  },
  'Push Ups': {
    setup: ['Place hands slightly wider than shoulder width', 'Extend legs back, balance on toes', 'Body should form a straight line from head to heels', 'Engage your core'],
    execution: ['Lower your body until chest nearly touches floor', 'Keep elbows at 45 degrees from body', 'Push back up to starting position', 'Lock out arms at top'],
    tips: ['Elevate feet on a bench to make it harder and target upper chest', 'Diamond hand position shifts focus to triceps', 'If too easy, try pause reps or add a weight vest']
  },
  'Dips': {
    setup: ['Grip parallel bars and lift yourself up', 'Arms fully extended, shoulders down', 'Lean slightly forward for chest focus', 'Cross ankles if needed for stability'],
    execution: ['Lower your body by bending elbows', 'Go down until upper arms are parallel to floor', 'Push back up to starting position', 'Don\'t lock out aggressively at top'],
    tips: ['More forward lean = chest focus, upright = triceps focus', 'Stop at parallel if you have shoulder issues', 'Add weight with a dip belt once bodyweight becomes easy']
  },
  // BACK
  'Barbell Row': {
    setup: ['Stand with feet shoulder width apart', 'Hinge at hips, keep back flat', 'Grip bar slightly wider than shoulder width', 'Let bar hang at arm\'s length'],
    execution: ['Pull bar to lower chest/upper abs', 'Drive elbows back, squeeze shoulder blades', 'Lower bar with control', 'Keep torso angle constant throughout'],
    tips: ['Pull to lower chest for lats, pull higher for upper back/traps', 'Underhand grip increases bicep involvement and allows more lat stretch', 'Your torso angle determines difficulty - more upright = easier']
  },
  'Pull Ups': {
    setup: ['Grip bar slightly wider than shoulder width', 'Hang with arms fully extended', 'Engage your lats before pulling', 'Cross ankles if desired'],
    execution: ['Pull yourself up until chin clears the bar', 'Drive elbows down and back', 'Lower yourself with control', 'Full extension at the bottom'],
    tips: ['Wider grip emphasizes lats, closer grip hits mid-back more', 'Add weight with a belt once you can do 10+ clean reps', 'Can\'t do one? Start with negatives - jump up and lower slowly']
  },
  'Lat Pulldown': {
    setup: ['Sit at the machine, secure thighs under pads', 'Grip bar wider than shoulder width', 'Lean back slightly from the hips', 'Arms fully extended at start'],
    execution: ['Pull bar down to upper chest', 'Drive elbows down and slightly back', 'Squeeze your lats at the bottom', 'Slowly return to start position'],
    tips: ['Behind-the-neck pulldowns are not recommended - injury risk for minimal benefit', 'Try different grip attachments - each hits your back differently', 'Imagine pulling with your elbows, not your hands']
  },
  'Seated Cable Row': {
    setup: ['Sit at the machine, feet on footpads', 'Knees slightly bent', 'Grasp the handle with both hands', 'Sit upright with slight forward lean'],
    execution: ['Pull handle to your lower chest/upper abs', 'Drive elbows straight back', 'Squeeze shoulder blades together at end', 'Slowly extend arms back to start'],
    tips: ['V-bar grip targets mid-back, wide bar hits lats more', 'Let your shoulders protract forward at the stretch - increases range of motion', 'Don\'t lean back excessively - this becomes a lower back exercise']
  },
  'Deadlift': {
    setup: ['Stand with feet hip-width apart, bar over mid-foot', 'Bend at hips and knees to grip bar', 'Hands just outside knees, mixed or overhand grip', 'Chest up, back flat, shoulders over the bar'],
    execution: ['Drive through your heels to stand up', 'Keep the bar close to your body', 'Stand tall at the top, squeeze glutes', 'Lower by hinging at hips first, then bend knees'],
    tips: ['Mixed grip prevents bar rolling but can cause imbalances - switch hands or use straps', 'Wear flat shoes or go barefoot - running shoes are unstable', 'This is the most taxing exercise - save it for when you\'re fresh']
  },
  'Dumbbell Row': {
    setup: ['Place one knee and hand on bench', 'Keep back flat and parallel to floor', 'Hold dumbbell in opposite hand, arm hanging', 'Feet staggered for balance'],
    execution: ['Pull dumbbell to your hip/lower rib', 'Drive elbow up and back', 'Squeeze your lat at the top', 'Lower with control'],
    tips: ['Pulling to hip hits lats more, pulling to chest hits upper back', 'Let the dumbbell hang low and stretch your lat between reps', 'You can go heavier here than most back exercises - lats are strong']
  },
  'Face Pull': {
    setup: ['Set cable to face height', 'Use rope attachment', 'Step back to create tension', 'Arms extended in front'],
    execution: ['Pull the rope toward your face', 'Separate hands and pull to ears', 'Squeeze shoulder blades together', 'Slowly return to start'],
    tips: ['External rotate at the end - thumbs should point behind you', 'This is a rear delt and rotator cuff exercise - keep it light', 'Do these regularly for shoulder health - especially if you bench a lot']
  },
  // SHOULDERS
  'Overhead Press': {
    setup: ['Stand with feet shoulder width apart', 'Grip bar just outside shoulder width', 'Bar rests on front delts/upper chest', 'Elbows slightly in front of bar'],
    execution: ['Press bar straight up overhead', 'Move your head back slightly as bar passes', 'Lock out arms at the top', 'Lower bar with control to starting position'],
    tips: ['Strict form builds more muscle - save push press for strength goals', 'Narrower grip = more front delt, wider = more side delt', 'If lower back arches excessively, sit down or brace harder']
  },
  'Lateral Raises': {
    setup: ['Stand with feet hip width apart', 'Hold dumbbells at your sides', 'Slight bend in elbows', 'Lean very slightly forward'],
    execution: ['Raise arms out to the sides', 'Lift until arms are parallel to floor', 'Lead with your elbows, not hands', 'Lower with control'],
    tips: ['Tilt the dumbbells like you\'re pouring water - pinky higher than thumb', 'Going heavier usually means worse form - this is a finesse exercise', 'Side delts respond well to high volume - 15-20 reps work great']
  },
  'Front Raises': {
    setup: ['Stand with feet shoulder width apart', 'Hold dumbbells in front of thighs', 'Palms facing your body', 'Slight bend in elbows'],
    execution: ['Raise one or both arms straight in front', 'Lift to shoulder height', 'Lower with control', 'Alternate arms or do both together'],
    tips: ['Front delts get hit by all pressing movements - you may not need these', 'Thumbs up position is easier on shoulders than palms down', 'If doing these, do them after your pressing work']
  },
  'Rear Delt Fly': {
    setup: ['Bend over at hips until torso is nearly parallel to floor', 'Hold dumbbells hanging below chest', 'Slight bend in elbows', 'Keep back flat'],
    execution: ['Raise arms out to sides in an arc', 'Squeeze shoulder blades together at top', 'Lower with control', 'Maintain bent-over position'],
    tips: ['Rear delts are often neglected - train them as much as front/side delts', 'Face pulls and rows also hit rear delts - count those in your volume', 'Try the reverse pec deck machine for a more stable alternative']
  },
  // ARMS - BICEPS
  'Barbell Curl': {
    setup: ['Stand with feet shoulder width apart', 'Grip barbell at shoulder width', 'Arms fully extended, bar at thighs', 'Elbows close to your sides'],
    execution: ['Curl the bar up toward your shoulders', 'Keep elbows stationary at your sides', 'Squeeze biceps at the top', 'Lower with control'],
    tips: ['EZ bar is easier on wrists - straight bar hits biceps slightly differently', 'Strict form with controlled tempo builds more muscle than heavy cheating', 'Narrower grip emphasizes outer bicep (long head), wider grip hits inner']
  },
  'Dumbbell Curl': {
    setup: ['Stand or sit with dumbbells at sides', 'Palms facing forward', 'Arms fully extended', 'Elbows close to body'],
    execution: ['Curl dumbbells up toward shoulders', 'Can alternate arms or do both together', 'Squeeze at the top', 'Lower with control'],
    tips: ['Supinating (rotating pinky up) during the curl increases bicep activation', 'Incline bench curls put biceps in stretched position - great for growth', 'Alternating allows you to focus on each arm individually']
  },
  'Hammer Curl': {
    setup: ['Stand with dumbbells at sides', 'Palms facing each other (neutral grip)', 'Arms fully extended', 'Feet shoulder width apart'],
    execution: ['Curl dumbbells up keeping neutral grip', 'Bring dumbbells to shoulder level', 'Squeeze at the top', 'Lower with control'],
    tips: ['Builds brachialis (under bicep) which pushes bicep up for better peak', 'Also strengthens forearms significantly', 'Cross-body hammer curls emphasize brachialis even more']
  },
  'Preacher Curl': {
    setup: ['Sit at preacher bench', 'Rest upper arms flat on the pad', 'Grip barbell or dumbbells', 'Arms extended but not locked'],
    execution: ['Curl weight up toward shoulders', 'Keep upper arms pressed into pad', 'Squeeze biceps at top', 'Lower slowly - this is where growth happens'],
    tips: ['The stretch at the bottom is what makes this exercise special - control it', 'Don\'t fully lock out at bottom - keeps tension on biceps', 'Great for building the lower part of the bicep near elbow']
  },
  'Cable Curl': {
    setup: ['Set cable to lowest position', 'Stand facing the machine', 'Grip bar or rope attachment', 'Arms extended, slight forward lean'],
    execution: ['Curl handle up toward shoulders', 'Keep elbows stationary', 'Squeeze at the top', 'Slowly return to start'],
    tips: ['Cables provide constant tension throughout - dumbbells lose tension at top', 'Try high cable curls facing away for an incredible peak contraction', 'Great finisher after heavy barbell/dumbbell work']
  },
  // ARMS - TRICEPS
  'Tricep Pushdowns': {
    setup: ['Set cable to high position', 'Grip bar or rope attachment', 'Elbows pinned to sides', 'Start with forearms parallel to floor'],
    execution: ['Push handle down until arms are straight', 'Squeeze triceps at the bottom', 'Slowly return to starting position', 'Don\'t let elbows flare out'],
    tips: ['Rope allows you to split at the bottom for extra contraction', 'Straight bar allows more weight - use both in your program', 'Reverse grip (underhand) emphasizes the medial head more']
  },
  'Overhead Tricep Extension': {
    setup: ['Stand or sit with dumbbell or cable overhead', 'Arms extended above head', 'Grip dumbbell with both hands or use rope', 'Elbows pointing forward'],
    execution: ['Lower weight behind your head by bending elbows', 'Keep upper arms stationary and close to head', 'Extend arms back to starting position', 'Squeeze triceps at the top'],
    tips: ['This exercise stretches the long head - essential for complete tricep development', 'The long head makes up 2/3 of your tricep - prioritize overhead work', 'Cable version provides constant tension throughout the movement']
  },
  'Skull Crushers': {
    setup: ['Lie on bench with barbell or dumbbells', 'Arms extended straight up', 'Grip shoulder width or narrower', 'Feet flat on floor'],
    execution: ['Bend elbows to lower weight toward forehead', 'Keep upper arms stationary', 'Extend arms back to start', 'Don\'t lock out aggressively'],
    tips: ['Lowering behind your head (not to forehead) stretches long head more', 'EZ bar is easier on wrists than straight bar', 'If elbows hurt, switch to cable overhead extensions']
  },
  'Close Grip Bench Press': {
    setup: ['Lie on bench like regular bench press', 'Grip bar with hands shoulder width or narrower', 'Unrack with arms extended', 'Keep elbows close to body'],
    execution: ['Lower bar to lower chest', 'Keep elbows tucked close to sides', 'Press back up to starting position', 'Lock out at the top'],
    tips: ['This is the best heavy tricep exercise - you can load it heavy', 'Shoulder width grip is fine - too narrow stresses wrists', 'Great to superset with regular bench press']
  },
  // LEGS - QUADS
  'Squat': {
    setup: ['Bar on upper back (high bar) or rear delts (low bar)', 'Feet shoulder width apart, toes slightly out', 'Chest up, core braced', 'Take a breath and hold'],
    execution: ['Push hips back and bend knees', 'Descend until thighs are at least parallel', 'Keep knees tracking over toes', 'Drive up through your heels'],
    tips: ['High bar is more quad dominant, low bar is more hip/glute dominant', 'Squat shoes with raised heel allow deeper squats and more quad activation', 'Breathing and bracing is crucial - take a big breath before each rep']
  },
  'Leg Press': {
    setup: ['Sit in machine with back flat against pad', 'Feet shoulder width on platform', 'Toes slightly pointed out', 'Release safety handles'],
    execution: ['Lower platform by bending knees', 'Go until knees are at 90 degrees or more', 'Press through heels to extend legs', 'Don\'t lock out knees completely'],
    tips: ['High and wide foot placement targets glutes and hamstrings more', 'Low and narrow targets quads more - experiment with positions', 'This is safer than squats for going to failure']
  },
  'Leg Extension': {
    setup: ['Sit in machine with back against pad', 'Adjust pad to sit on lower shins', 'Grip handles for stability', 'Feet slightly flexed'],
    execution: ['Extend legs until straight', 'Squeeze quads hard at the top', 'Lower with control', 'Don\'t let weight stack touch'],
    tips: ['Point toes outward to emphasize inner quad (VMO)', 'Point toes inward to emphasize outer quad', 'Great for pre-exhaust before squats or finishing quads after']
  },
  'Lunges': {
    setup: ['Stand with feet hip width apart', 'Hold dumbbells at sides or barbell on back', 'Core engaged', 'Look straight ahead'],
    execution: ['Step forward with one leg', 'Lower until both knees are at 90 degrees', 'Push through front heel to return', 'Alternate legs or do all reps on one side'],
    tips: ['Shorter steps emphasize quads, longer steps hit glutes more', 'Walking lunges are more functional, stationary are more quad-focused', 'Reverse lunges are easier on knees than forward lunges']
  },
  'Bulgarian Split Squat': {
    setup: ['Stand about 2 feet in front of a bench', 'Place one foot on bench behind you', 'Hold dumbbells at sides', 'Most of weight on front foot'],
    execution: ['Lower your body by bending front knee', 'Descend until front thigh is parallel to floor', 'Push through front heel to stand', 'Complete all reps then switch legs'],
    tips: ['Leaning forward targets glutes more, upright targets quads more', 'This builds single-leg strength and fixes imbalances', 'Start with bodyweight to learn balance before adding weight']
  },
  // LEGS - HAMSTRINGS
  'Romanian Deadlift': {
    setup: ['Hold barbell or dumbbells in front of thighs', 'Feet hip width apart', 'Slight bend in knees (keep this constant)', 'Shoulders back, chest up'],
    execution: ['Hinge at hips, pushing them back', 'Lower weight along legs until you feel hamstring stretch', 'Keep back flat throughout', 'Drive hips forward to stand'],
    tips: ['This is a hip hinge, not a squat - knees barely bend', 'Go only as low as your hamstring flexibility allows with flat back', 'Squeeze glutes at the top but don\'t hyperextend your back']
  },
  'Leg Curl': {
    setup: ['Lie face down on leg curl machine', 'Pad should be on lower calves', 'Grip handles for stability', 'Legs fully extended'],
    execution: ['Curl your heels toward your glutes', 'Squeeze hamstrings at the top', 'Lower with control', 'Don\'t let weight stack touch'],
    tips: ['Pointing toes down (plantarflexion) increases hamstring activation', 'Lying curls hit the lateral hamstring more than seated', 'Don\'t let your hips lift - this is cheating']
  },
  'Seated Leg Curl': {
    setup: ['Sit with back against pad', 'Adjust leg pad to sit above your heels', 'Grip handles', 'Legs extended in front'],
    execution: ['Curl your heels down and back', 'Squeeze hamstrings at the bottom', 'Return with control', 'Don\'t use momentum'],
    tips: ['Seated position pre-stretches hamstrings at the hip for more range', 'This hits the medial hamstrings more than lying version', 'Great to superset with leg extensions']
  },
  // LEGS - GLUTES
  'Hip Thrust': {
    setup: ['Sit on floor with upper back against bench', 'Roll barbell over hips (use pad)', 'Feet flat on floor, hip width apart', 'Knees bent at 90 degrees'],
    execution: ['Drive through heels to lift hips', 'Squeeze glutes hard at the top', 'Lower with control', 'Don\'t hyperextend at the top'],
    tips: ['This is the king of glute exercises - prioritize it if glute growth is a goal', 'Wider stance hits outer glutes, narrower hits more inner glutes', 'Feet further out targets more hamstring, closer hits more quads']
  },
  'Glute Bridge': {
    setup: ['Lie on back, knees bent', 'Feet flat on floor, hip width apart', 'Arms at sides for stability', 'Weight on heels'],
    execution: ['Push through heels to lift hips', 'Squeeze glutes at the top', 'Lower with control', 'Don\'t let lower back hyperextend'],
    tips: ['Great warmup exercise before squats or hip thrusts', 'Single leg version is great for fixing glute imbalances', 'If you feel it in hamstrings, move feet closer to body']
  },
  'Cable Kickback': {
    setup: ['Attach ankle strap to low cable', 'Face the machine, hold for support', 'Stand on one leg', 'Slight bend in standing leg'],
    execution: ['Kick working leg straight back', 'Squeeze glute at the top', 'Return with control', 'Complete all reps then switch legs'],
    tips: ['Keep your hips square - don\'t rotate to kick higher', 'Small range of motion with perfect squeeze beats big swinging kicks', 'This isolates glutes - do it after heavy compound movements']
  },
  // CORE
  'Plank': {
    setup: ['Get in push-up position', 'Lower to forearms', 'Body forms straight line from head to heels', 'Core engaged, glutes squeezed'],
    execution: ['Hold this position', 'Don\'t let hips sag or pike up', 'Breathe normally', 'Maintain neutral spine'],
    tips: ['Once you can hold 60 seconds, add difficulty instead of time', 'Try weighted planks, plank reaches, or ab wheel for progression', 'Squeeze your glutes - most people forget this and sag']
  },
  'Crunches': {
    setup: ['Lie on back, knees bent', 'Feet flat on floor', 'Hands behind head or across chest', 'Lower back pressed into floor'],
    execution: ['Curl shoulders off the floor', 'Squeeze abs at the top', 'Lower with control', 'Don\'t pull on your neck'],
    tips: ['Think about bringing your ribs to your pelvis, not just sitting up', 'If your neck hurts, place tongue on roof of mouth - sounds weird, works', 'Cable crunches are more progressive - easier to add weight']
  },
  'Hanging Leg Raise': {
    setup: ['Hang from pull-up bar', 'Arms fully extended', 'Legs straight down', 'Core engaged'],
    execution: ['Raise legs until parallel to floor (or higher)', 'Control the movement, don\'t swing', 'Lower with control', 'Keep legs as straight as possible'],
    tips: ['Curling pelvis up at top increases lower ab activation significantly', 'If you swing, you\'re using momentum - slow down', 'Bring legs all the way to the bar for the hardest version']
  },
  'Russian Twist': {
    setup: ['Sit on floor with knees bent', 'Lean back slightly, feet can be on floor or elevated', 'Hold weight at chest', 'Keep back straight'],
    execution: ['Rotate torso to one side', 'Touch weight to floor beside hip', 'Rotate to other side', 'Control the movement'],
    tips: ['Keep the weight close to your body - extending arms makes it harder', 'Feet elevated increases difficulty significantly', 'This trains rotational core strength - important for sports and daily life']
  },
  'Cable Crunch': {
    setup: ['Kneel facing cable machine', 'Hold rope attachment behind head', 'Start with torso upright', 'Keep hips stationary'],
    execution: ['Crunch down, bringing elbows toward knees', 'Focus on flexing your spine', 'Squeeze abs at the bottom', 'Return with control'],
    tips: ['Hips shouldn\'t move - if they do, you\'re just bowing, not crunching', 'This is one of the few ab exercises you can progressively overload', 'Great for building thicker, more visible abs']
  },
  // CALVES
  'Standing Calf Raise': {
    setup: ['Stand on calf raise machine or step', 'Balls of feet on platform, heels hanging off', 'Legs straight', 'Hold onto supports for balance'],
    execution: ['Rise up onto toes as high as possible', 'Squeeze calves at the top', 'Lower heels below platform for stretch', 'Control the negative'],
    tips: ['Straight legs emphasize gastrocnemius (the visible calf muscle)', '2-second pause at top and full stretch at bottom is key', 'Calves respond well to high reps - try sets of 15-20']
  },
  'Seated Calf Raise': {
    setup: ['Sit at seated calf machine', 'Knees under pad', 'Balls of feet on platform', 'Heels hanging off'],
    execution: ['Push through balls of feet', 'Raise heels as high as possible', 'Lower with control for full stretch', 'Squeeze at the top'],
    tips: ['Bent knee position targets soleus (under the gastrocnemius)', 'The soleus gives your calf width when viewed from the front', 'Do both seated and standing for complete calf development']
  },
  // ADDITIONAL CHEST EXERCISES
  'Decline Bench Press': {
    setup: ['Set bench to 15-30 degree decline', 'Secure feet under pads', 'Lie back and grip bar slightly wider than shoulders', 'Unrack with arms extended'],
    execution: ['Lower bar to lower chest with control', 'Keep elbows at 45 degrees', 'Press back up to starting position', 'Lock out at the top'],
    tips: ['Targets lower chest fibers that flat bench misses', 'Don\'t go too steep - 15-30 degrees is optimal', 'Blood rushing to head is normal but don\'t stay inverted too long']
  },
  'Machine Chest Press': {
    setup: ['Adjust seat height so handles are at mid-chest', 'Sit with back flat against pad', 'Grip handles with palms facing down', 'Plant feet firmly on floor'],
    execution: ['Press handles forward until arms extended', 'Squeeze chest at the end', 'Return slowly to starting position', 'Keep shoulder blades retracted'],
    tips: ['Great for beginners or as a finishing exercise after free weights', 'The fixed path means safer failure - push to true failure here', 'Adjust seat height to change emphasis: lower = lower chest, higher = upper']
  },
  'Incline Cable Fly': {
    setup: ['Set bench to 30-45 degree incline between cable stations', 'Low pulley position', 'Grab handles, lie back on bench', 'Start with arms out wide, slight elbow bend'],
    execution: ['Bring hands together in arc over upper chest', 'Squeeze and hold at the top', 'Lower with control back to starting position', 'Maintain constant tension'],
    tips: ['Excellent upper chest isolation with constant cable tension', 'The low-to-high angle maximizes upper chest activation', 'Go lighter than dumbbell flies - the constant tension makes it harder']
  },
  'Pec Deck': {
    setup: ['Adjust seat so handles are at chest height', 'Sit with back flat against pad', 'Place forearms on pads or grip handles', 'Start with arms open wide'],
    execution: ['Bring arms together in front of chest', 'Squeeze and hold briefly at the center', 'Return slowly to starting position', 'Keep slight bend in elbows'],
    tips: ['Fixed machine path allows you to focus purely on the squeeze', 'The stretched position is where most chest growth happens - control it', 'Great finisher after heavy pressing movements']
  },
  'Dumbbell Fly': {
    setup: ['Lie flat on bench with dumbbells above chest', 'Arms extended with slight bend in elbows', 'Palms facing each other', 'Feet flat on floor'],
    execution: ['Lower dumbbells out to sides in wide arc', 'Stop when you feel chest stretch', 'Bring dumbbells back together in hugging motion', 'Squeeze chest at the top'],
    tips: ['Go lighter than you think - this is a stretch and squeeze exercise', 'Don\'t let dumbbells drop below shoulder level - protects shoulders', 'The stretched position builds muscle - don\'t rush through it']
  },
  'Landmine Press': {
    setup: ['Place barbell in landmine attachment or corner', 'Stand facing the end of the barbell', 'Hold end of bar at shoulder height', 'Stagger stance for stability'],
    execution: ['Press barbell up and forward', 'Full arm extension at top', 'Lower with control back to shoulder', 'Keep core braced throughout'],
    tips: ['The arc path is easier on shoulders than straight pressing', 'Can do single arm for more core engagement', 'Great alternative if overhead pressing hurts your shoulders']
  },
  'Floor Press': {
    setup: ['Lie on floor with barbell in rack or have partner hand off', 'Grip shoulder width or slightly wider', 'Legs can be flat or bent at knees', 'Upper back and head on floor'],
    execution: ['Lower bar until upper arms touch floor', 'Pause briefly on floor', 'Press bar back up explosively', 'Lock out at the top'],
    tips: ['The floor limits range of motion - protecting shoulders while building lockout strength', 'The pause eliminates stretch reflex - builds pure pressing power', 'Great for triceps development and bench press lockout strength']
  },
  // ADDITIONAL BACK EXERCISES
  'Pendlay Row': {
    setup: ['Stand over barbell with feet hip-width apart', 'Bend over until torso is parallel to floor', 'Grip bar shoulder width or wider', 'Bar starts on floor each rep'],
    execution: ['Explosively row bar to lower chest', 'Keep torso parallel to floor throughout', 'Lower bar back to floor with control', 'Reset between each rep'],
    tips: ['Each rep starts from a dead stop - builds explosive power', 'Stricter than regular rows since torso stays parallel', 'Great for building a thick, powerful back']
  },
  'Chest Supported Row': {
    setup: ['Set incline bench to 30-45 degrees', 'Lie face down with chest on bench', 'Hold dumbbells hanging below', 'Feet on floor for stability'],
    execution: ['Row dumbbells up to sides', 'Squeeze shoulder blades together', 'Lower with control', 'Keep chest pressed into bench'],
    tips: ['Eliminates momentum and lower back strain completely', 'You can\'t cheat - whatever weight you use, your back is doing the work', 'Great for feeling the mind-muscle connection with lats']
  },
  'T-Bar Row': {
    setup: ['Stand over T-bar machine or landmine', 'Bend at hips, keep back flat', 'Use close or wide grip handle', 'Slight bend in knees'],
    execution: ['Pull handle toward lower chest', 'Drive elbows back and squeeze', 'Lower with control', 'Maintain hip hinge throughout'],
    tips: ['Close grip hits lats more, wide grip emphasizes upper back', 'One of the best exercises for back thickness', 'Don\'t round your lower back - keep it flat throughout']
  },
  'Close Grip Pulldown': {
    setup: ['Attach V-bar or close grip handle', 'Sit with thighs secured under pads', 'Grip handle with palms facing each other', 'Arms fully extended overhead'],
    execution: ['Pull handle down toward upper chest', 'Lean back slightly as you pull', 'Squeeze lats at the bottom', 'Control the return'],
    tips: ['Close grip increases range of motion and lat stretch', 'Neutral grip is often easier on shoulders', 'Great for building lat width and lower lat development']
  },
  'Wide Grip Pulldown': {
    setup: ['Grip bar wider than shoulder width', 'Sit with thighs under pads', 'Lean back slightly', 'Arms fully extended'],
    execution: ['Pull bar down to upper chest', 'Drive elbows down and back', 'Squeeze lats at bottom', 'Control the return to full stretch'],
    tips: ['Wide grip emphasizes the outer lats for that V-taper', 'Don\'t go behind the neck - injury risk with minimal benefit', 'Think about pulling with your elbows, not your hands']
  },
  'Chin Ups': {
    setup: ['Grip bar with palms facing you, shoulder width', 'Hang with arms fully extended', 'Engage lats before pulling', 'Cross ankles or keep legs straight'],
    execution: ['Pull yourself up until chin clears bar', 'Lead with your chest', 'Lower with full control', 'Full extension at bottom'],
    tips: ['Underhand grip recruits more biceps than pull ups', 'Generally easier than pull ups - good progression step', 'If you can do 10+ clean reps, add weight with a belt']
  },
  'Neutral Grip Pull Ups': {
    setup: ['Grip parallel handles with palms facing each other', 'Hang with arms fully extended', 'Engage core and lats', 'Keep body straight'],
    execution: ['Pull yourself up until chin clears handles', 'Focus on driving elbows down', 'Lower with control', 'Full stretch at bottom'],
    tips: ['Neutral grip is easiest on shoulders and wrists', 'Great for those with shoulder issues on regular pull ups', 'Hits both lats and mid-back effectively']
  },
  'Machine Row': {
    setup: ['Adjust chest pad height appropriately', 'Sit with chest against pad', 'Grip handles with chosen grip', 'Arms fully extended forward'],
    execution: ['Pull handles back toward torso', 'Squeeze shoulder blades together', 'Return with control', 'Don\'t let weight stack touch'],
    tips: ['The chest support eliminates lower back involvement', 'Focus purely on the squeeze - this is a mind-muscle exercise', 'Great for higher reps since form stays consistent']
  },
  'Meadows Row': {
    setup: ['Barbell in landmine setup', 'Stand perpendicular to bar', 'Stagger stance, front foot near bar end', 'Grip end of bar with one hand'],
    execution: ['Row bar up toward hip', 'Drive elbow back and up', 'Lower with control', 'Complete all reps, then switch sides'],
    tips: ['The angled pull hits lats differently than other rows', 'Created by John Meadows for complete back development', 'Allows heavier loading with good stretch at bottom']
  },
  'Seal Row': {
    setup: ['Lie face down on elevated bench', 'Dumbbells or barbell hang below', 'Chest on bench, feet off ground', 'Arms fully extended down'],
    execution: ['Row weight up toward chest', 'Squeeze shoulder blades at top', 'Lower with full control', 'Get full stretch at bottom'],
    tips: ['Zero momentum possible - extremely strict rowing movement', 'The name comes from looking like a seal on a rock', 'Excellent for building mind-muscle connection with back']
  },
  'Straight Arm Pulldown': {
    setup: ['Stand facing high cable with bar attachment', 'Step back to create tension', 'Arms extended in front, slight bend in elbows', 'Hinge slightly at hips'],
    execution: ['Pull bar down in arc toward thighs', 'Keep arms straight throughout', 'Squeeze lats at the bottom', 'Return with control to start'],
    tips: ['Isolates lats without bicep involvement', 'Great as a lat activation exercise before pull ups or rows', 'Can also use rope attachment for different feel']
  },
  'Rack Pulls': {
    setup: ['Set safety pins at knee height or just below', 'Bar rests on pins', 'Stand with feet hip width, bar over mid-foot', 'Grip outside knees, chest up'],
    execution: ['Drive through heels to stand', 'Lockout with glutes squeezed', 'Lower bar back to pins with control', 'Reset between reps'],
    tips: ['Allows much heavier loading than full deadlifts', 'Great for building upper back thickness and grip strength', 'Primarily trains lockout portion of deadlift']
  },
  'Snatch Grip Deadlift': {
    setup: ['Very wide grip - hands near collars', 'Feet hip width apart', 'Get into deep hinge position', 'Chest up, back flat'],
    execution: ['Drive through floor to stand', 'Keep arms straight throughout', 'Stand tall at top', 'Lower with control'],
    tips: ['Wide grip forces deeper starting position - more quad and upper back', 'Excellent for building upper back width', 'Use straps - grip will be the limiting factor']
  },
  'Wide Grip Cable Row': {
    setup: ['Attach long bar to low cable', 'Sit at cable row station', 'Grip bar wider than shoulder width', 'Arms extended, slight lean forward'],
    execution: ['Pull bar to lower chest/upper abs', 'Drive elbows out to sides', 'Squeeze upper back and rear delts', 'Return with control'],
    tips: ['Wide grip shifts focus to upper back and rear delts', 'Different stimulus than close grip rowing', 'Great for building upper back thickness']
  },
  'High Cable Row': {
    setup: ['Set cable at face height or higher', 'Use rope or bar attachment', 'Step back to create tension', 'Arms extended toward cable'],
    execution: ['Pull toward face/upper chest', 'Drive elbows back and out', 'Squeeze upper back at contraction', 'Return with control'],
    tips: ['Targets upper back and rear delts simultaneously', 'Great alternative to face pulls with more range of motion', 'Keep the pulling angle high for best results']
  },
  'Back Extension': {
    setup: ['Position hips on pad', 'Anchor feet under lower pads', 'Start bent over at hips', 'Arms crossed over chest or behind head'],
    execution: ['Extend torso until body is straight', 'Squeeze glutes and lower back at top', 'Don\'t hyperextend beyond neutral', 'Lower with control'],
    tips: ['Great for building lower back endurance and strength', 'Holding weight adds resistance as you progress', 'Can also emphasize glutes by squeezing them hard at top']
  },
  'Hyperextension': {
    setup: ['Similar to back extension on 45-degree bench', 'Hips on pad, feet anchored', 'Start hanging down', 'Hands across chest or behind head'],
    execution: ['Raise torso until body is straight', 'Squeeze glutes and lower back', 'Hold briefly at top', 'Lower with control'],
    tips: ['The 45-degree angle changes the resistance curve', 'Add a plate to chest for increased difficulty', 'Don\'t round your lower back at the bottom']
  },
  // ADDITIONAL SHOULDER EXERCISES
  'Seated Dumbbell Press': {
    setup: ['Sit on bench with back support', 'Clean dumbbells to shoulder height', 'Palms facing forward', 'Feet flat on floor'],
    execution: ['Press dumbbells overhead', 'Bring dumbbells together at top', 'Lower with control to shoulder level', 'Keep core tight throughout'],
    tips: ['Dumbbells allow more natural arm path than barbell', 'Seated position prevents leg drive - stricter shoulder work', 'Don\'t let the dumbbells drift too far forward']
  },
  'Arnold Press': {
    setup: ['Sit with dumbbells at shoulder height', 'Palms start facing you', 'Elbows in front of body', 'Back against bench support'],
    execution: ['Press up while rotating palms to face forward', 'Full extension at top', 'Reverse the rotation on the way down', 'Control throughout'],
    tips: ['The rotation hits front delts through longer range of motion', 'Created by Arnold Schwarzenegger himself', 'Go lighter than regular press - the rotation makes it harder']
  },
  'Machine Shoulder Press': {
    setup: ['Adjust seat so handles are at shoulder height', 'Sit with back flat against pad', 'Grip handles with palms forward', 'Feet flat on floor'],
    execution: ['Press handles overhead', 'Full arm extension at top', 'Lower with control', 'Keep back against pad'],
    tips: ['Great for going to failure safely', 'The fixed path lets you focus on pushing hard', 'Adjust seat height to change emphasis on different delt heads']
  },
  'Push Press': {
    setup: ['Bar in front rack position on front delts', 'Feet shoulder width apart', 'Elbows slightly in front of bar', 'Core braced'],
    execution: ['Dip slightly by bending knees', 'Explosively extend legs while pressing bar', 'Lock out overhead', 'Lower with control'],
    tips: ['The leg drive lets you use heavier weights than strict press', 'Great for building overhead strength and power', 'Dip should be quick - don\'t pause at the bottom']
  },
  'Cable Lateral Raises': {
    setup: ['Set cable at lowest position', 'Stand sideways to machine', 'Grab handle with far hand', 'Arm at side, slight elbow bend'],
    execution: ['Raise arm out to side until parallel to floor', 'Lead with elbow, not hand', 'Lower with control', 'Complete all reps, then switch sides'],
    tips: ['Cable provides constant tension unlike dumbbells', 'Resistance curve is different - hardest at top', 'Great for side delt isolation and mind-muscle connection']
  },
  'Machine Lateral Raises': {
    setup: ['Adjust seat so arms are at sides', 'Sit with arms against pads', 'Grip handles lightly', 'Keep elbows slightly bent'],
    execution: ['Raise arms out to sides', 'Stop when arms are parallel to floor', 'Lower with control', 'Maintain constant tension'],
    tips: ['The machine path prevents cheating with body swing', 'Great for high reps and burning out side delts', 'Focus on squeezing the side delts, not gripping hard']
  },
  'Cable Front Raises': {
    setup: ['Set cable at lowest position', 'Face away from machine', 'Grab handle between legs', 'Stand with feet shoulder width'],
    execution: ['Raise arm straight in front to shoulder height', 'Keep slight bend in elbow', 'Lower with control', 'Can do one arm or both'],
    tips: ['Cables provide constant tension through full range', 'Front delts usually get enough work from pressing', 'Good finisher if front delts are a weak point']
  },
  'Face Pulls': {
    setup: ['Set cable at face height', 'Attach rope handle', 'Step back to create tension', 'Arms extended toward cable'],
    execution: ['Pull rope toward face', 'Separate hands as you pull to ears', 'Externally rotate at the end', 'Return with control'],
    tips: ['Essential for shoulder health - do these regularly', 'Thumbs should point behind you at the end', 'Targets rear delts and rotator cuff together']
  },
  'Reverse Pec Deck': {
    setup: ['Sit facing the pad on pec deck machine', 'Adjust handles to be in front of you', 'Grip handles with arms extended forward', 'Chest against pad'],
    execution: ['Open arms back in reverse fly motion', 'Squeeze rear delts at the end', 'Return with control', 'Don\'t let weight stack touch'],
    tips: ['Great isolation for rear delts with consistent resistance', 'The machine path ensures strict form', 'Keep the motion controlled - no swinging']
  },
  'Cable Rear Delt Fly': {
    setup: ['Set cables at shoulder height', 'Cross cables - right hand grabs left, left grabs right', 'Step back to create tension', 'Arms in front, slight elbow bend'],
    execution: ['Pull cables back and out', 'Open arms until in line with shoulders', 'Squeeze rear delts', 'Return with control'],
    tips: ['The cross pattern provides unique resistance angle', 'Keep elbows slightly bent throughout', 'Great for rear delt isolation with constant tension']
  },
  'Upright Rows': {
    setup: ['Stand with feet shoulder width', 'Grip barbell or dumbbells in front of thighs', 'Hands closer than shoulder width', 'Shoulders back, chest up'],
    execution: ['Pull weight up along body', 'Lead with elbows going up and out', 'Raise until elbows are at shoulder height', 'Lower with control'],
    tips: ['Controversial exercise - can impinge shoulders if done wrong', 'Keep hands wider and don\'t raise past shoulder level', 'Dumbbells or cables are safer than barbell']
  },
  'Lu Raises': {
    setup: ['Stand with dumbbells at sides', 'Arms straight, palms facing back', 'Slight lean forward', 'Feet shoulder width'],
    execution: ['Raise arms up and out at 45-degree angle', 'Thumbs point up throughout', 'Lift to shoulder height', 'Lower with control'],
    tips: ['Named after Olympic lifter Lu Xiaojun', 'The angle hits both front and side delts', 'Great warmup exercise before pressing']
  },
  'Y Raises': {
    setup: ['Lie face down on incline bench or stand bent over', 'Hold light dumbbells', 'Arms hanging down', 'Thumbs pointing up'],
    execution: ['Raise arms up and out forming a Y shape', 'Squeeze upper back at top', 'Lower with control', 'Keep thumbs pointing up'],
    tips: ['Excellent for lower trap and shoulder stability', 'Go very light - this is a small muscle group', 'Great for shoulder health and posture']
  },
  // ADDITIONAL TRICEP EXERCISES
  'Rope Pushdowns': {
    setup: ['Attach rope to high cable', 'Stand facing machine', 'Grip rope with palms facing each other', 'Elbows pinned to sides'],
    execution: ['Push rope down until arms straight', 'Spread rope at bottom for extra contraction', 'Return with control', 'Keep elbows stationary'],
    tips: ['The rope allows you to spread at the bottom for better squeeze', 'Spreading the rope hits the lateral head more', 'Keep elbows pinned - no flaring']
  },
  'Dumbbell Skull Crushers': {
    setup: ['Lie on bench holding dumbbells', 'Arms extended straight up', 'Palms facing each other', 'Feet flat on floor'],
    execution: ['Bend elbows to lower dumbbells toward head', 'Keep upper arms stationary', 'Extend arms back to start', 'Control the descent'],
    tips: ['Dumbbells allow more natural wrist position than bar', 'Can rotate palms at different points for variety', 'If elbows hurt, try lowering behind head instead']
  },
  'Tricep Dips': {
    setup: ['Grip parallel bars', 'Lift yourself to full arm extension', 'Keep body as upright as possible', 'Cross ankles behind you'],
    execution: ['Lower by bending elbows', 'Go down until upper arms parallel to floor', 'Press back up to start', 'Keep body upright for tricep focus'],
    tips: ['Stay upright to target triceps - leaning forward shifts to chest', 'Go to parallel only - deeper can stress shoulders', 'Add weight when bodyweight becomes easy']
  },
  'Diamond Push Ups': {
    setup: ['Get in push up position', 'Place hands together forming diamond shape', 'Thumbs and index fingers touching', 'Body in straight line'],
    execution: ['Lower chest toward hands', 'Keep elbows close to body', 'Push back up', 'Squeeze triceps at top'],
    tips: ['One of the best bodyweight tricep exercises', 'Harder than regular push ups - scale reps accordingly', 'Great for medial head tricep development']
  },
  'JM Press': {
    setup: ['Lie on bench with barbell', 'Grip narrower than shoulder width', 'Start with bar over upper chest', 'Elbows pointed forward'],
    execution: ['Lower bar toward throat/chin by bending elbows', 'Bar path goes forward as you lower', 'Press back up in reverse arc', 'Lock out over upper chest'],
    tips: ['A hybrid of close grip bench and skull crushers', 'Named after JM Blakley who popularized it', 'Excellent for building tricep mass and bench lockout']
  },
  'Tricep Kickbacks': {
    setup: ['Bend over with one hand on bench', 'Hold dumbbell in other hand', 'Pin upper arm parallel to floor', 'Elbow bent at 90 degrees'],
    execution: ['Extend arm straight back', 'Squeeze tricep at full extension', 'Return to 90 degrees', 'Complete all reps, switch sides'],
    tips: ['Despite reputation, this is effective when done correctly', 'Key is keeping upper arm stationary and parallel', 'Light weight with perfect form beats heavy cheating']
  },
  'Single Arm Pushdown': {
    setup: ['Set cable to high position', 'Stand facing machine', 'Grip handle with one hand', 'Elbow pinned to side'],
    execution: ['Push handle down until arm straight', 'Squeeze tricep at bottom', 'Return with control', 'Complete all reps, switch sides'],
    tips: ['Great for fixing tricep imbalances between arms', 'Can rotate body for different angles', 'Focus on the mind-muscle connection']
  },
  'V-Bar Pushdown': {
    setup: ['Attach V-bar to high cable', 'Stand facing machine', 'Grip V-bar with palms facing each other', 'Elbows at sides'],
    execution: ['Push bar down until arms straight', 'Squeeze triceps at bottom', 'Return with control', 'Keep elbows stationary'],
    tips: ['V-bar puts wrists in neutral position - easier on joints', 'Allows heavier loading than rope', 'Great for overall tricep development']
  },
  'Reverse Grip Pushdown': {
    setup: ['Attach straight bar to high cable', 'Stand facing machine', 'Grip bar with palms facing up', 'Elbows at sides'],
    execution: ['Push bar down until arms straight', 'Squeeze triceps', 'Return with control', 'Keep wrists straight'],
    tips: ['Underhand grip emphasizes the medial head', 'Feels awkward at first but builds well-rounded triceps', 'Go lighter than regular pushdowns']
  },
  'French Press': {
    setup: ['Sit or stand holding EZ bar or barbell overhead', 'Arms fully extended', 'Grip slightly narrower than shoulder width', 'Elbows pointing forward'],
    execution: ['Lower bar behind head by bending elbows', 'Keep upper arms stationary', 'Extend back to start', 'Full lockout at top'],
    tips: ['The overhead position stretches the long head fully', 'Essential for complete tricep development', 'Can do seated for more stability']
  },
  'Incline Skull Crushers': {
    setup: ['Set bench to 30-45 degree incline', 'Lie back with barbell or dumbbells', 'Arms extended up', 'Start with weight over face'],
    execution: ['Lower weight toward forehead/behind head', 'Keep upper arms in fixed position', 'Extend back to start', 'Control throughout'],
    tips: ['The incline increases long head stretch even more', 'Lower behind head rather than to forehead', 'Great alternative if flat skull crushers bother elbows']
  },
  'Overhead Dumbbell Extension': {
    setup: ['Sit or stand holding dumbbell with both hands', 'Press dumbbell overhead', 'Grip the inside of top weight plate', 'Elbows pointing up'],
    execution: ['Lower dumbbell behind head', 'Keep upper arms close to head', 'Extend back to start', 'Full lockout at top'],
    tips: ['Great long head tricep builder', 'Can also do single arm for more isolation', 'Keep elbows from flaring out']
  },
  // ADDITIONAL BICEP EXERCISES
  'EZ Bar Curl': {
    setup: ['Stand holding EZ bar at angled grips', 'Feet shoulder width apart', 'Arms extended, bar at thighs', 'Elbows at sides'],
    execution: ['Curl bar up toward shoulders', 'Keep elbows stationary', 'Squeeze at the top', 'Lower with control'],
    tips: ['The angled grip is easier on wrists than straight bar', 'Inner grip targets outer bicep, outer grip hits inner bicep', 'Just as effective as straight bar with less joint stress']
  },
  'Hammer Curls': {
    setup: ['Stand with dumbbells at sides', 'Neutral grip - palms facing thighs', 'Arms fully extended', 'Feet shoulder width'],
    execution: ['Curl dumbbells up keeping neutral grip', 'Bring to shoulder level', 'Squeeze at the top', 'Lower with control'],
    tips: ['Builds the brachialis which pushes the bicep up', 'Also hits forearms significantly', 'Can do across body for more brachialis emphasis']
  },
  'Incline Dumbbell Curl': {
    setup: ['Set bench to 45-60 degree incline', 'Lie back with dumbbells hanging down', 'Arms fully extended behind torso', 'Palms facing forward'],
    execution: ['Curl dumbbells up toward shoulders', 'Keep upper arms stationary', 'Squeeze at the top', 'Lower to full stretch'],
    tips: ['The incline puts biceps in stretched position - great for growth', 'You\'ll use less weight but feel it more', 'One of the best bicep exercises for long head']
  },
  'Concentration Curl': {
    setup: ['Sit on bench with legs spread', 'Rest elbow against inner thigh', 'Hold dumbbell with arm extended down', 'Lean slightly forward'],
    execution: ['Curl dumbbell up toward shoulder', 'Focus on squeezing the bicep', 'Lower with full control', 'Complete all reps, switch arms'],
    tips: ['The braced position prevents cheating completely', 'Great for building the bicep peak', 'Focus on the squeeze more than the weight']
  },
  'Spider Curls': {
    setup: ['Lie face down on incline bench', 'Let arms hang straight down', 'Hold dumbbells or EZ bar', 'Upper arms perpendicular to floor'],
    execution: ['Curl weight up without moving upper arms', 'Squeeze hard at top', 'Lower with control', 'Get full extension at bottom'],
    tips: ['The position eliminates all momentum', 'Great for building the short head (inner bicep)', 'You\'ll use lighter weight but feel every rep']
  },
  'Drag Curls': {
    setup: ['Stand holding barbell at thighs', 'Grip shoulder width', 'Arms extended', 'Elbows will move back during movement'],
    execution: ['Curl bar up while dragging it along body', 'Drive elbows back as bar rises', 'Bar stays in contact with body', 'Lower while dragging back down'],
    tips: ['Eliminates front delt involvement completely', 'The movement pattern is unusual but highly effective', 'Great for building bicep peak and long head']
  },
  'Reverse Curls': {
    setup: ['Stand holding barbell with overhand grip', 'Arms extended, bar at thighs', 'Grip shoulder width', 'Elbows at sides'],
    execution: ['Curl bar up keeping overhand grip', 'Bring bar to shoulder level', 'Lower with control', 'Keep wrists straight'],
    tips: ['Targets brachioradialis (forearm) and brachialis', 'Great for building forearm size', 'Use lighter weight than regular curls']
  },
  'Wrist Curls': {
    setup: ['Sit with forearms on thighs or bench', 'Wrists hanging over edge', 'Hold barbell or dumbbells', 'Palms facing up'],
    execution: ['Curl wrists up', 'Squeeze forearms at top', 'Lower with control', 'Full stretch at bottom'],
    tips: ['Targets the forearm flexors', 'Can also do with palms down for extensors', 'High reps (15-20) work well for forearms']
  },
  'Bayesian Cable Curl': {
    setup: ['Set cable at lowest position', 'Face away from machine', 'Grab handle behind you', 'Step forward, arm behind torso'],
    execution: ['Curl handle up toward shoulder', 'Keep upper arm behind you throughout', 'Squeeze at the top', 'Lower with control'],
    tips: ['Puts biceps in maximum stretched position', 'One of the best exercises for long head', 'The stretch at the bottom is what makes this special']
  },
  'High Cable Curl': {
    setup: ['Set cables at head height or above', 'Stand between cable stations', 'Grip handles with palms up', 'Arms extended out to sides'],
    execution: ['Curl handles toward your head', 'Squeeze biceps at peak contraction', 'Extend arms back to start', 'Maintain tension throughout'],
    tips: ['The unique angle gives an incredible peak contraction', 'Great for building the bicep peak', 'This is a finishing exercise - do it last']
  },
  'Machine Preacher Curl': {
    setup: ['Sit at preacher machine', 'Adjust pad height for upper arms', 'Grip handles', 'Arms on pad, slightly bent'],
    execution: ['Curl handles up toward shoulders', 'Squeeze biceps at top', 'Lower with control', 'Don\'t fully lock out at bottom'],
    tips: ['Machine provides consistent resistance through range', 'Great for mind-muscle connection', 'Safe for going to failure']
  },
  'Wide Grip Barbell Curl': {
    setup: ['Stand holding barbell with grip wider than shoulders', 'Arms extended at thighs', 'Elbows close to body', 'Chest up'],
    execution: ['Curl bar toward shoulders', 'Keep elbows stationary', 'Squeeze at top', 'Lower with control'],
    tips: ['Wide grip emphasizes the short head (inner bicep)', 'Good for building bicep width', 'Rotate with narrow grip work for complete development']
  },
  'Narrow Grip EZ Curl': {
    setup: ['Stand holding EZ bar at inner grips', 'Arms extended', 'Elbows at sides', 'Feet shoulder width'],
    execution: ['Curl bar up toward shoulders', 'Keep elbows pinned', 'Squeeze at top', 'Lower with control'],
    tips: ['Narrow grip emphasizes the long head (outer bicep)', 'Great for building the bicep peak', 'Part of a complete bicep routine with wide grip work']
  },
  // ADDITIONAL QUAD EXERCISES
  'Barbell Back Squat': {
    setup: ['Bar on upper traps (high bar) or rear delts (low bar)', 'Feet shoulder width, toes slightly out', 'Chest up, core braced', 'Unrack and step back'],
    execution: ['Push hips back and bend knees', 'Descend until thighs at least parallel', 'Keep knees over toes', 'Drive up through heels'],
    tips: ['High bar is more quad dominant, low bar shifts to glutes/hips', 'Squat shoes with raised heels help achieve depth', 'The king of leg exercises - prioritize it']
  },
  'Front Squat': {
    setup: ['Bar rests on front delts, not hands', 'Elbows high, upper arms parallel to floor', 'Feet shoulder width', 'Core very tight'],
    execution: ['Descend by pushing knees forward and down', 'Stay upright - elbows up', 'Go as deep as mobility allows', 'Drive up keeping chest high'],
    tips: ['More quad dominant than back squats', 'Requires good thoracic mobility', 'Great for core strength and athletic performance']
  },
  'Goblet Squat': {
    setup: ['Hold dumbbell or kettlebell at chest', 'Elbows pointing down', 'Feet slightly wider than shoulders', 'Toes pointed slightly out'],
    execution: ['Squat down between your legs', 'Keep chest up and elbows inside knees', 'Go as deep as possible', 'Drive up through heels'],
    tips: ['The front load forces upright posture', 'Great for learning squat mechanics', 'Excellent warmup before back squats']
  },
  'Hack Squat': {
    setup: ['Stand on platform with back against pad', 'Shoulders under pads', 'Feet shoulder width on platform', 'Release safety handles'],
    execution: ['Lower by bending knees', 'Go as deep as comfortable', 'Drive back up through heels', 'Don\'t lock out knees completely'],
    tips: ['The machine path allows focusing purely on quads', 'Low foot position targets quads more, high targets glutes', 'Great for quad hypertrophy without lower back stress']
  },
  'Walking Lunges': {
    setup: ['Stand with dumbbells at sides or barbell on back', 'Feet together', 'Core engaged', 'Look straight ahead'],
    execution: ['Step forward into lunge position', 'Lower until both knees at 90 degrees', 'Step through to next lunge', 'Continue walking pattern'],
    tips: ['The continuous motion is more metabolically demanding', 'Great for building functional leg strength', 'Shorter steps target quads, longer steps hit glutes']
  },
  'Reverse Lunges': {
    setup: ['Stand with feet together', 'Hold dumbbells at sides or barbell on back', 'Core engaged', 'Chest up'],
    execution: ['Step backward into lunge', 'Lower until both knees at 90 degrees', 'Push through front heel to return', 'Alternate legs or do all reps on one side'],
    tips: ['Easier on knees than forward lunges', 'Great for quad and glute development', 'The step back makes balance easier to maintain']
  },
  'Step Ups': {
    setup: ['Stand facing box or bench', 'Hold dumbbells at sides', 'One foot on box', 'Core engaged'],
    execution: ['Drive through front foot to step up', 'Bring other foot to box', 'Step down with control', 'Complete all reps then switch legs'],
    tips: ['Don\'t push off back leg - use the front leg only', 'Higher box increases glute involvement', 'Great unilateral exercise for fixing imbalances']
  },
  'Sissy Squat': {
    setup: ['Stand holding something for balance', 'Feet hip width apart', 'Rise up on toes', 'Lean back from the knees'],
    execution: ['Bend knees and lean back simultaneously', 'Lower until feeling deep quad stretch', 'Keep hips forward - don\'t sit back', 'Rise back up to start'],
    tips: ['Extreme quad isolation - prepare for soreness', 'Start with bodyweight only', 'Targets the rectus femoris uniquely']
  },
  'Pendulum Squat': {
    setup: ['Stand on platform with shoulders under pads', 'Feet in the center or slightly forward', 'Grip handles', 'Release safety'],
    execution: ['Lower by bending knees', 'The machine swings in a pendulum arc', 'Go as deep as comfortable', 'Drive back up'],
    tips: ['The arc path is easier on the lower back than hack squat', 'Constant tension through the entire range', 'Great machine for quad hypertrophy']
  },
  'Belt Squat': {
    setup: ['Attach belt around hips', 'Stand on elevated platforms', 'Weight hangs from belt between legs', 'Feet shoulder width or wider'],
    execution: ['Squat down between platforms', 'Keep chest up', 'Go as deep as possible', 'Drive up through heels'],
    tips: ['Zero spinal loading - amazing for back issues', 'Can go very heavy and very deep safely', 'One of the best leg exercises if your gym has one']
  },
  // ADDITIONAL HAMSTRING EXERCISES
  'Lying Leg Curl': {
    setup: ['Lie face down on leg curl machine', 'Ankles under pad', 'Grip handles', 'Hips pressed into pad'],
    execution: ['Curl heels toward glutes', 'Squeeze hamstrings at top', 'Lower with control', 'Don\'t let weight stack touch'],
    tips: ['Point toes away for more hamstring activation', 'Don\'t let hips rise up - that\'s cheating', 'Great for building hamstring mass']
  },
  'Nordic Curls': {
    setup: ['Kneel on pad with feet anchored', 'Partner holds ankles or use machine', 'Body straight from knees to head', 'Arms ready to catch yourself'],
    execution: ['Lower body forward with control', 'Resist with hamstrings as long as possible', 'Catch yourself and push back up', 'Use hamstrings to return if possible'],
    tips: ['One of the most effective hamstring exercises', 'Start with negatives only if too hard', 'Great for preventing hamstring injuries']
  },
  'Good Mornings': {
    setup: ['Bar on upper back like squat position', 'Feet shoulder width', 'Slight bend in knees', 'Core braced'],
    execution: ['Hinge at hips pushing them back', 'Lower torso until nearly parallel to floor', 'Keep back flat throughout', 'Drive hips forward to stand'],
    tips: ['Excellent for hamstring and lower back development', 'Keep the weight light and form strict', 'The stretch in hamstrings should be intense']
  },
  'Sumo Deadlift': {
    setup: ['Very wide stance, toes pointed out', 'Grip bar with hands inside knees', 'Chest up, hips low', 'Back flat'],
    execution: ['Drive through floor spreading knees', 'Keep bar close to body', 'Stand tall at top', 'Lower by pushing hips back'],
    tips: ['More hip and inner thigh dominant than conventional', 'Better for those with long torsos', 'The wide stance reduces range of motion']
  },
  // ADDITIONAL GLUTE EXERCISES
  'Hip Abduction Machine': {
    setup: ['Sit in machine with back against pad', 'Legs inside pads', 'Start with legs together', 'Grip handles'],
    execution: ['Push legs apart against resistance', 'Squeeze glutes at full extension', 'Return with control', 'Don\'t let weight stack touch'],
    tips: ['Targets gluteus medius and minimus', 'Great for building hip stability', 'Can lean forward for different glute emphasis']
  },
  'Cable Pull Through': {
    setup: ['Set cable at lowest position', 'Face away, straddle the cable', 'Grab rope between legs', 'Step forward to create tension'],
    execution: ['Hinge at hips pushing them back', 'Let hands go between legs', 'Drive hips forward powerfully', 'Squeeze glutes at top'],
    tips: ['Great hip hinge teaching exercise', 'Constant tension makes it great for glute activation', 'Keep your back flat throughout']
  },
  'Frog Pumps': {
    setup: ['Lie on back', 'Soles of feet together, knees out', 'Arms at sides for stability', 'Heels close to glutes'],
    execution: ['Drive hips up by squeezing glutes', 'Hold at top briefly', 'Lower with control', 'Keep feet pressed together'],
    tips: ['The position isolates glutes from hamstrings', 'Great for glute activation before heavy compounds', 'High reps (20-30) work well here']
  },
  'Single Leg Hip Thrust': {
    setup: ['Upper back on bench', 'One foot on floor, other leg extended', 'Hips starting low', 'Arms out for balance'],
    execution: ['Drive through planted foot to raise hips', 'Squeeze glute hard at top', 'Lower with control', 'Complete all reps, switch legs'],
    tips: ['Fixes glute imbalances between sides', 'Much harder than bilateral - use bodyweight first', 'Great for runners and athletes']
  },
  'Donkey Kicks': {
    setup: ['Get on all fours', 'Hands under shoulders, knees under hips', 'Core engaged', 'One knee stays on ground'],
    execution: ['Kick one leg back and up', 'Drive heel toward ceiling', 'Squeeze glute at top', 'Lower with control, repeat'],
    tips: ['Keep the motion controlled - no swinging', 'Focus on feeling the glute contract', 'Can add ankle weights for resistance']
  },
  'Fire Hydrants': {
    setup: ['On all fours position', 'Core tight', 'Back flat', 'Head neutral'],
    execution: ['Lift one knee out to the side', 'Keep 90-degree knee bend', 'Raise until thigh is parallel to floor', 'Lower with control'],
    tips: ['Great for gluteus medius activation', 'Perfect warmup exercise before squats', 'Can add band for increased resistance']
  },
  // ADDITIONAL HAMSTRING/GLUTE EXERCISES
  'Glute Ham Raise': {
    setup: ['Position yourself face down on GHD machine', 'Anchor feet under pads', 'Thighs on main pad, knees just behind pad', 'Start with torso hanging down'],
    execution: ['Curl body up using hamstrings', 'Keep hips extended throughout', 'Continue until torso is upright', 'Lower with control using eccentric hamstring strength'],
    tips: ['One of the best hamstring exercises - hits both functions', 'Use hands to push off floor if needed for assistance', 'Progress by reducing hand assistance over time']
  },
  'Stiff Leg Deadlift': {
    setup: ['Stand with feet hip-width apart holding barbell', 'Legs nearly straight with minimal knee bend', 'Back flat, chest up', 'Bar at thighs'],
    execution: ['Hinge at hips lowering bar toward floor', 'Keep legs straight (slight bend okay)', 'Lower until you feel hamstring stretch', 'Return by driving hips forward'],
    tips: ['Less knee bend than Romanian deadlift - more hamstring stretch', 'Go only as low as flexibility allows with flat back', 'Great for hamstring flexibility and strength']
  },
  'Curtsy Lunge': {
    setup: ['Stand with feet hip-width apart', 'Hold dumbbells at sides or hands on hips', 'Core engaged', 'Weight on one leg'],
    execution: ['Step one leg behind and across your body', 'Lower into a curtsy position', 'Keep front knee tracking over toes', 'Push through front foot to return'],
    tips: ['Excellent for targeting gluteus medius', 'Keep torso upright throughout', 'Great for hip stability and glute development']
  },
  // ADDITIONAL QUAD EXERCISES
  'Smith Machine Squat': {
    setup: ['Position bar on upper back', 'Feet slightly forward of bar', 'Shoulder-width stance', 'Unrack by twisting safety hooks'],
    execution: ['Lower by bending knees and hips', 'Descend until thighs are parallel', 'Drive through heels to stand', 'Keep back against bar throughout'],
    tips: ['Feet forward position targets quads more', 'The fixed bar path allows focus on muscle', 'Great for going heavy safely without a spotter']
  },
  'Heels Elevated Squat': {
    setup: ['Place heels on weight plates or wedge', 'Bar on upper back or hold dumbbells', 'Feet shoulder-width apart', 'Toes can point slightly out'],
    execution: ['Squat down keeping torso more upright', 'Knees travel forward over toes', 'Go as deep as possible', 'Drive up through the whole foot'],
    tips: ['The heel elevation allows deeper squats with less ankle mobility', 'Shifts emphasis to the quads, especially VMO', 'Great for those with limited ankle flexibility']
  },
  'Narrow Stance Leg Press': {
    setup: ['Sit in leg press with back flat', 'Place feet close together on platform', 'Feet lower on platform', 'Release safety handles'],
    execution: ['Lower platform by bending knees', 'Go as deep as comfortable', 'Press through feet to extend', 'Don\'t lock out knees completely'],
    tips: ['Narrow stance increases quad emphasis', 'Lower foot position targets quads more', 'Great isolation variation for quad development']
  },
  'Wide Stance Leg Press': {
    setup: ['Sit in leg press with back flat', 'Place feet wide apart on platform', 'Feet higher on platform, toes out', 'Release safety handles'],
    execution: ['Lower platform with knees tracking out', 'Go as deep as hip flexibility allows', 'Press through heels to extend', 'Don\'t lock out knees'],
    tips: ['Wide stance hits inner thighs and glutes more', 'Higher foot position reduces quad emphasis', 'Great for overall leg development']
  },
  // ADDITIONAL CALF EXERCISES
  'Leg Press Calf Raises': {
    setup: ['Sit in leg press machine', 'Place balls of feet on bottom edge of platform', 'Legs extended but not locked', 'Heels hanging off platform'],
    execution: ['Press through balls of feet', 'Extend ankles as far as possible', 'Hold the squeeze briefly', 'Lower heels for full stretch'],
    tips: ['Great alternative to standing calf raises', 'Can go heavier than standing variations', 'Focus on full range of motion']
  },
  'Donkey Calf Raises': {
    setup: ['Bend over with torso parallel to floor', 'Rest forearms on elevated surface', 'Partner sits on lower back or use machine', 'Balls of feet on raised block'],
    execution: ['Rise up on toes as high as possible', 'Squeeze calves at the top', 'Lower heels below platform for stretch', 'Control the movement'],
    tips: ['Arnold\'s favorite calf exercise', 'The bent position provides great stretch', 'Can use donkey calf machine if available']
  },
  'Single Leg Calf Raise': {
    setup: ['Stand on one foot on step or platform', 'Hold something for balance', 'Heel hanging off edge', 'Other foot lifted behind'],
    execution: ['Rise up on toes as high as possible', 'Squeeze calf at the top', 'Lower heel below platform', 'Complete all reps then switch'],
    tips: ['Great for fixing calf imbalances', 'Bodyweight is usually enough resistance', 'Full range of motion is key']
  },
  'Smith Machine Calf Raise': {
    setup: ['Position bar on upper back', 'Stand on block or plates under Smith bar', 'Balls of feet on elevated surface', 'Heels hanging off'],
    execution: ['Rise up on toes', 'Squeeze calves at the top', 'Lower heels for full stretch', 'Control throughout'],
    tips: ['The fixed bar path allows focus on the calves', 'Can go heavier than free weight variations', 'Great for building calf mass']
  },
  // ADDITIONAL CORE EXERCISES
  'Hanging Knee Raises': {
    setup: ['Hang from pull-up bar', 'Arms fully extended', 'Legs straight down', 'Core engaged'],
    execution: ['Raise knees toward chest', 'Curl pelvis up slightly', 'Lower with control', 'Avoid swinging'],
    tips: ['Easier progression than straight leg raises', 'Focus on using abs, not hip flexors', 'Great for building to full leg raises']
  },
  'Ab Wheel Rollout': {
    setup: ['Kneel on floor with ab wheel in front', 'Grip handles with both hands', 'Core tight, back flat', 'Start with wheel under shoulders'],
    execution: ['Roll wheel forward extending body', 'Go as far as you can control', 'Pull wheel back using abs', 'Keep hips from sagging'],
    tips: ['One of the best ab exercises available', 'Start with partial range and progress', 'Keep lower back from arching']
  },
  'Dead Bug': {
    setup: ['Lie on back with arms extended toward ceiling', 'Knees bent 90 degrees, thighs vertical', 'Press lower back into floor', 'Core engaged throughout'],
    execution: ['Extend opposite arm and leg simultaneously', 'Keep lower back pressed to floor', 'Return to start', 'Alternate sides'],
    tips: ['Excellent for core stability without neck strain', 'If back arches, reduce range of motion', 'Great for learning proper core bracing']
  },
  'Pallof Press': {
    setup: ['Stand sideways to cable machine', 'Hold handle at chest with both hands', 'Step away to create tension', 'Feet shoulder-width apart'],
    execution: ['Press handle straight out from chest', 'Hold extended position briefly', 'Return to chest', 'Resist rotation throughout'],
    tips: ['One of the best anti-rotation core exercises', 'Great for building functional core strength', 'Keep hips and shoulders square']
  },
  'Wood Chops': {
    setup: ['Set cable high or low depending on variation', 'Stand sideways to machine', 'Grip handle with both hands', 'Feet wider than shoulders'],
    execution: ['Pull handle diagonally across body', 'Rotate through core, not just arms', 'Control the return', 'Complete all reps then switch sides'],
    tips: ['Great for rotational core strength', 'High-to-low targets different muscles than low-to-high', 'Athletic movement pattern']
  },
  'Side Plank': {
    setup: ['Lie on side with elbow under shoulder', 'Stack feet or stagger them', 'Body in straight line', 'Core engaged'],
    execution: ['Lift hips off ground', 'Hold position with body straight', 'Don\'t let hips sag', 'Breathe normally'],
    tips: ['Great for obliques and hip stability', 'Progress by adding hip dips or leg lifts', 'Time both sides equally']
  },
  'Decline Sit Ups': {
    setup: ['Secure feet on decline bench', 'Lie back on declined surface', 'Hands across chest or behind head', 'Core engaged'],
    execution: ['Curl torso up toward thighs', 'Squeeze abs at the top', 'Lower with control', 'Don\'t use momentum'],
    tips: ['The decline increases resistance', 'Can hold weight for added difficulty', 'Don\'t go too steep to start']
  },
  'Bicycle Crunches': {
    setup: ['Lie on back with hands behind head', 'Lift shoulders off ground', 'Knees bent, feet off floor', 'Core engaged'],
    execution: ['Bring opposite elbow toward opposite knee', 'Extend other leg straight', 'Alternate in cycling motion', 'Keep lower back pressed down'],
    tips: ['One of the best exercises for obliques', 'Don\'t pull on your neck', 'Control the movement, don\'t rush']
  },
  'Mountain Climbers': {
    setup: ['Start in push-up position', 'Hands under shoulders', 'Body in straight line', 'Core tight'],
    execution: ['Drive one knee toward chest', 'Quickly switch legs', 'Maintain plank position', 'Keep hips level'],
    tips: ['Great cardio and core combo', 'Speed up for more cardio benefit', 'Slow down for more core engagement']
  },
  'V-Ups': {
    setup: ['Lie flat on back', 'Arms extended overhead', 'Legs straight', 'Lower back pressed to floor'],
    execution: ['Simultaneously lift legs and torso', 'Reach hands toward toes', 'Form a V shape at top', 'Lower with control'],
    tips: ['Advanced ab exercise - modify if needed', 'Keep legs as straight as possible', 'Control the descent']
  },
  'Toe Touches': {
    setup: ['Lie on back with legs vertical', 'Arms extended toward ceiling', 'Lower back pressed to floor', 'Core engaged'],
    execution: ['Reach hands toward toes', 'Lift shoulders off ground', 'Touch or reach past toes', 'Lower with control'],
    tips: ['Great for upper abs', 'Keep legs vertical throughout', 'Don\'t strain your neck']
  },
  'Flutter Kicks': {
    setup: ['Lie on back with hands under hips', 'Lift both legs slightly off ground', 'Lower back pressed to floor', 'Core engaged'],
    execution: ['Alternate kicking legs up and down', 'Keep legs relatively straight', 'Small, controlled movements', 'Don\'t let lower back arch'],
    tips: ['Great for lower abs', 'If back arches, raise legs higher', 'Can place hands under lower back for support']
  },
  'Dragon Flags': {
    setup: ['Lie on bench gripping behind head', 'Body straight, core engaged', 'Shoulders anchored to bench', 'This is advanced - ensure proper strength first'],
    execution: ['Lower body as one unit toward bench', 'Keep body straight like a flag', 'Don\'t let hips bend', 'Raise back up with control'],
    tips: ['Bruce Lee\'s signature ab exercise', 'Start with negatives only', 'Requires significant core strength']
  },
  'L-Sit': {
    setup: ['Support yourself on parallel bars or floor', 'Arms straight', 'Legs extended in front', 'Core extremely tight'],
    execution: ['Hold legs parallel to floor', 'Keep legs straight', 'Maintain position for time', 'Don\'t let legs drop'],
    tips: ['Extremely challenging - progress slowly', 'Start with tucked knees if needed', 'Great for hip flexors and abs']
  },
  'Hollow Body Hold': {
    setup: ['Lie on back', 'Arms extended overhead', 'Legs straight', 'Press lower back into floor'],
    execution: ['Lift arms and legs off ground', 'Create banana shape with body', 'Keep lower back pressed down', 'Hold for time'],
    tips: ['Foundation for gymnastics core work', 'If too hard, bend knees or arms', 'Great for total core tension']
  },
  'Bird Dog': {
    setup: ['Start on all fours', 'Hands under shoulders, knees under hips', 'Back flat, core engaged', 'Head neutral'],
    execution: ['Extend opposite arm and leg simultaneously', 'Keep hips and shoulders level', 'Hold briefly at extension', 'Return and alternate'],
    tips: ['Excellent for lower back health', 'Don\'t rotate hips or shoulders', 'Great warmup or rehab exercise']
  },
  // TRAPS
  'Barbell Shrugs': {
    setup: ['Stand holding barbell at thighs', 'Grip slightly wider than shoulder width', 'Arms straight', 'Shoulders relaxed down'],
    execution: ['Shrug shoulders straight up toward ears', 'Hold squeeze at the top', 'Lower with control', 'Don\'t roll shoulders'],
    tips: ['Straight up and down, no rolling needed', 'Hold the squeeze for 1-2 seconds', 'Use straps if grip is limiting']
  },
  'Dumbbell Shrugs': {
    setup: ['Stand holding dumbbells at sides', 'Arms straight', 'Shoulders relaxed down', 'Core engaged'],
    execution: ['Shrug shoulders up toward ears', 'Squeeze at the top', 'Lower with control', 'Keep arms straight throughout'],
    tips: ['Dumbbells allow slightly more range of motion', 'Can do one arm at a time for focus', 'Don\'t use momentum']
  },
  'Cable Shrugs': {
    setup: ['Stand between low cable pulleys', 'Or face single cable with bar attachment', 'Grip handles or bar', 'Arms straight down'],
    execution: ['Shrug shoulders up', 'Squeeze traps at top', 'Lower with control', 'Maintain constant tension'],
    tips: ['Cables provide constant tension throughout', 'Great for higher rep trap work', 'Try different angles']
  },
  'Farmers Walk': {
    setup: ['Pick up heavy dumbbells or farmer handles', 'Stand tall with weights at sides', 'Shoulders back and down', 'Core braced'],
    execution: ['Walk forward with controlled steps', 'Keep shoulders packed down', 'Maintain upright posture', 'Walk for distance or time'],
    tips: ['One of the best functional exercises', 'Great for grip, traps, and core', 'Go heavy - this builds real-world strength']
  },
  'Rack Pulls (High)': {
    setup: ['Set safety pins at upper thigh height', 'Bar rests on pins', 'Stand with conventional or sumo stance', 'Grip bar just outside legs'],
    execution: ['Drive through floor to stand', 'Shrug and squeeze traps at top', 'Lower bar back to pins', 'Reset between reps'],
    tips: ['Upper rack pulls are primarily a trap exercise', 'Can go very heavy due to short range', 'Great for building upper back thickness']
  },
  // CARDIO & CONDITIONING
  'Treadmill Run': {
    setup: ['Step onto treadmill belt', 'Set desired speed and incline', 'Hold rails initially if needed', 'Start walking then increase speed'],
    execution: ['Run at steady pace or intervals', 'Maintain good posture', 'Land midfoot, not heel', 'Swing arms naturally'],
    tips: ['Start slower than you think needed', 'Incline adds intensity without impact', '1% incline mimics outdoor running']
  },
  'Treadmill Walk (Incline)': {
    setup: ['Step onto treadmill', 'Set incline to 10-15%', 'Set speed to brisk walk (3-4 mph)', 'Don\'t hold handrails if possible'],
    execution: ['Walk at steady pace', 'Pump arms naturally', 'Lean slightly into the incline', 'Keep core engaged'],
    tips: ['Great low-impact cardio option', 'Burns more calories than flat walking', 'Don\'t hold rails - reduces effectiveness']
  },
  'Stationary Bike': {
    setup: ['Adjust seat height - slight knee bend at bottom', 'Adjust handlebars to comfortable position', 'Clip in or secure feet in straps', 'Set resistance to desired level'],
    execution: ['Pedal at steady cadence', 'Keep core engaged', 'Don\'t bounce in saddle', 'Vary resistance for intervals'],
    tips: ['Low impact on joints', 'Great for HIIT or steady state', 'Aim for 80-100 RPM typically']
  },
  'Rowing Machine': {
    setup: ['Sit on seat, feet strapped in', 'Grip handle with overhand grip', 'Knees bent, shins vertical', 'Arms extended, back straight'],
    execution: ['Drive with legs first', 'Then lean back slightly and pull handle to chest', 'Reverse: arms, body, then legs', 'Maintain fluid motion'],
    tips: ['Full body cardio workout', 'Power comes from legs, not arms', 'Don\'t round your back']
  },
  'Stair Climber': {
    setup: ['Step onto machine holding rails', 'Set desired speed', 'Stand upright, don\'t lean on rails', 'Start stepping'],
    execution: ['Step continuously at set pace', 'Use full range of motion', 'Don\'t lean heavily on rails', 'Maintain upright posture'],
    tips: ['Great for glutes and cardiovascular fitness', 'Leaning on rails reduces effectiveness significantly', 'Start slow - it\'s harder than it looks']
  },
  'Elliptical': {
    setup: ['Step onto pedals', 'Grip moving or stationary handles', 'Set resistance and incline', 'Start pedaling motion'],
    execution: ['Move in smooth elliptical motion', 'Push and pull with arms if using moving handles', 'Keep core engaged', 'Vary direction occasionally'],
    tips: ['Low impact alternative to running', 'Moving handles add upper body work', 'Pedaling backward changes muscle emphasis']
  },
  'Battle Ropes': {
    setup: ['Anchor rope at center point', 'Stand facing anchor holding rope ends', 'Athletic stance, slight bend in knees', 'Arms at sides holding ropes'],
    execution: ['Create waves by alternating arms up and down', 'Or slam both arms together', 'Or make circular motions', 'Maintain continuous motion'],
    tips: ['Great full body conditioning', 'Many variations possible', 'Keep core tight throughout']
  },
  'Box Jumps': {
    setup: ['Stand facing sturdy box', 'Feet shoulder-width apart', 'Arms ready to swing', 'Appropriate box height for your ability'],
    execution: ['Swing arms and jump onto box', 'Land softly with bent knees', 'Stand fully on box', 'Step down (don\'t jump) to preserve joints'],
    tips: ['Step down to reduce injury risk', 'Start with lower box height', 'Great for explosive power']
  },
  'Burpees': {
    setup: ['Stand with feet shoulder-width apart', 'Arms at sides', 'Space to drop to floor', 'Core engaged'],
    execution: ['Drop into squat, hands on floor', 'Jump feet back to plank', 'Do a push-up (optional)', 'Jump feet forward and explode up'],
    tips: ['Full body conditioning exercise', 'Scale by removing push-up or jump', 'Great for HIIT training']
  },
  'Jump Rope': {
    setup: ['Hold rope handles at hip height', 'Rope behind you on ground', 'Feet together', 'Elbows close to body'],
    execution: ['Swing rope overhead and jump', 'Stay on balls of feet', 'Small, quick jumps', 'Wrists do most of the work'],
    tips: ['Great cardio that improves coordination', 'Start with basic jumps, progress to tricks', 'Excellent warm-up exercise']
  },
  'Sled Push': {
    setup: ['Load sled with appropriate weight', 'Grip high or low handles', 'Lean into sled at 45 degrees', 'Core braced'],
    execution: ['Drive through legs pushing sled forward', 'Keep low body angle', 'Take powerful steps', 'Arms stay extended'],
    tips: ['No eccentric load - great for recovery days', 'High handles for more quad focus', 'Low handles for more hip drive']
  },
  'Sled Pull': {
    setup: ['Attach straps or rope to sled', 'Face sled or face away depending on variation', 'Grip rope or attach to belt', 'Athletic stance'],
    execution: ['Walk backward pulling sled', 'Or pull hand over hand facing sled', 'Keep tension on rope/straps', 'Drive through legs'],
    tips: ['Great for hamstrings when walking backward', 'Arm pulls work back and biceps', 'Excellent conditioning tool']
  },
  'Kettlebell Swings': {
    setup: ['Stand with feet wider than shoulders', 'Kettlebell on floor between feet', 'Hinge at hips to grip handle', 'Back flat, core engaged'],
    execution: ['Hike kettlebell back between legs', 'Drive hips forward explosively', 'Let kettlebell swing to chest height', 'Control the descent and repeat'],
    tips: ['Power comes from hips, not arms', 'Great for posterior chain and cardio', 'Keep arms relaxed, core tight']
  },
  'Assault Bike': {
    setup: ['Adjust seat height', 'Sit on bike, feet on pedals', 'Grip moving handles', 'Set for calories, distance, or time'],
    execution: ['Pedal and push/pull handles simultaneously', 'Use both upper and lower body', 'Vary intensity as needed', 'Full body effort'],
    tips: ['Brutal cardio - don\'t underestimate it', 'Great for intervals', 'Burns calories extremely fast']
  },
  'Ski Erg': {
    setup: ['Stand facing machine', 'Grip handles overhead', 'Feet shoulder-width apart', 'Set monitor for desired workout'],
    execution: ['Pull handles down while hinging at hips', 'Extend through whole body on pull', 'Let handles return overhead', 'Repeat in fluid motion'],
    tips: ['Great upper body cardio option', 'Mimics cross-country ski motion', 'Can sit for lower body isolation']
  },
  // OLYMPIC LIFTS
  'Power Clean': {
    setup: ['Bar over mid-foot, shoulder-width stance', 'Grip just outside legs', 'Hips higher than squat, lower than deadlift', 'Back flat, chest up'],
    execution: ['Pull bar off floor keeping close', 'Explosively extend hips and shrug', 'Pull under bar, catch on front delts', 'Stand to complete lift'],
    tips: ['Technical lift - learn from qualified coach', 'Don\'t reverse curl the bar', 'Power comes from hip extension']
  },
  'Hang Clean': {
    setup: ['Stand holding bar at thighs', 'Shoulder-width grip, just outside legs', 'Hinge to lower bar to above knees', 'Back flat, weight in heels'],
    execution: ['Explosively extend hips', 'Shrug and pull under bar', 'Catch on front delts in partial squat', 'Stand to complete'],
    tips: ['Great for learning clean timing', 'Removes first pull complexity', 'Focus on explosive hip drive']
  },
  'Clean and Jerk': {
    setup: ['Same setup as power clean', 'Full movement requires technique', 'Ensure proper mobility', 'Start light to learn'],
    execution: ['Clean bar to front rack', 'Dip and drive bar overhead', 'Split or push jerk to catch', 'Recover to standing'],
    tips: ['Competition Olympic lift', 'Requires significant technique work', 'Find qualified coaching']
  },
  'Snatch': {
    setup: ['Wide grip on bar (snatch grip)', 'Bar over mid-foot', 'Hips lower than deadlift', 'Back flat, arms straight'],
    execution: ['Pull bar off floor keeping close', 'Explosive hip extension', 'Pull under and catch overhead', 'Stand to complete'],
    tips: ['Most technical of all barbell lifts', 'Requires excellent mobility', 'Start with PVC pipe or light bar']
  },
  'Hang Snatch': {
    setup: ['Stand holding bar with snatch grip at thighs', 'Hinge to lower bar to above knees', 'Back flat, arms straight', 'Weight in heels'],
    execution: ['Explosively extend hips', 'Pull under bar', 'Catch overhead in squat', 'Stand to complete'],
    tips: ['Removes first pull to focus on extension', 'Great for learning snatch timing', 'Start with very light weight']
  },
  'Clean High Pull': {
    setup: ['Same start position as power clean', 'Shoulder-width grip', 'Back flat, hips higher than squat', 'Bar over mid-foot'],
    execution: ['Pull bar off floor', 'Explosively extend hips', 'Shrug and pull elbows high', 'Lower and repeat'],
    tips: ['Builds clean pulling power', 'Don\'t catch the bar, just pull', 'Great for learning triple extension']
  },
  'Dumbbell Snatch': {
    setup: ['Stand over dumbbell between feet', 'Wide stance, hinge to grip dumbbell', 'One arm grips center of handle', 'Back flat, free arm out for balance'],
    execution: ['Pull dumbbell off floor', 'Explosively extend hips', 'Pull dumbbell overhead in one motion', 'Catch with locked arm'],
    tips: ['Great single-arm power exercise', 'Easier to learn than barbell snatch', 'Alternating arms adds cardio element']
  },
  'Kettlebell Clean': {
    setup: ['Stand over kettlebell', 'Hinge and grip with one hand', 'Back flat, free arm out', 'Feet slightly wider than shoulders'],
    execution: ['Hike kettlebell back', 'Drive hips and pull kettlebell up', 'Rotate and catch in rack position', 'Elbow tight to body at catch'],
    tips: ['Keep kettlebell close to body', 'Don\'t let it flip and bang wrist', 'Clean catch = bell rests on forearm and bicep']
  },
  'Thruster': {
    setup: ['Bar in front rack position', 'Feet shoulder-width apart', 'Elbows up, core tight', 'Full grip on bar'],
    execution: ['Squat to full depth', 'Drive up explosively', 'As you stand, press bar overhead', 'Lower bar to rack and repeat'],
    tips: ['Great full body conditioning exercise', 'Common in CrossFit workouts', 'Front squat into push press in one motion']
  },
  'Dumbbell Thruster': {
    setup: ['Hold dumbbells at shoulders', 'Feet shoulder-width apart', 'Core engaged', 'Elbows slightly forward'],
    execution: ['Squat to full depth', 'Drive up explosively', 'Press dumbbells overhead as you stand', 'Lower to shoulders and repeat'],
    tips: ['More shoulder mobility required than barbell', 'Great for conditioning workouts', 'Can alternate or do both arms together']
  },
  // FUNCTIONAL EXERCISES
  'Turkish Get Up': {
    setup: ['Lie on back holding kettlebell overhead', 'Arm locked out, eyes on weight', 'Same side leg bent, other leg straight', 'Free arm out to side'],
    execution: ['Rise to elbow, then hand', 'Bridge hips and sweep leg through', 'Rise to kneeling, then standing', 'Reverse to return to floor'],
    tips: ['One of the best full body exercises', 'Go slow and control every position', 'Builds shoulder stability and core strength']
  },
  'Landmine Rotation': {
    setup: ['Stand holding end of barbell at chest', 'Barbell in landmine or corner', 'Feet wider than shoulders', 'Arms extended'],
    execution: ['Rotate barbell to one hip', 'Keep arms relatively straight', 'Rotate to other hip', 'Control the movement'],
    tips: ['Great for rotational core strength', 'Can add more hip and leg drive', 'Keep core engaged throughout']
  },
  'Medicine Ball Slam': {
    setup: ['Stand holding medicine ball overhead', 'Feet shoulder-width apart', 'Use a slam ball, not bouncy ball', 'Core engaged'],
    execution: ['Slam ball into ground with full force', 'Hinge at hips as you slam', 'Pick up and repeat', 'Use whole body'],
    tips: ['Great stress relief and conditioning', 'Engage core and use hip hinge', 'Pick a weight you can slam hard']
  },
  'Wall Ball': {
    setup: ['Hold medicine ball at chest', 'Stand facing wall at arm\'s length', 'Feet shoulder-width apart', 'Target spot on wall above you'],
    execution: ['Squat to full depth', 'Drive up and throw ball to target', 'Catch ball and descend into next squat', 'Continuous motion'],
    tips: ['Common CrossFit exercise', 'Combines squat with throwing', 'Great for conditioning']
  },
  'Bosu Ball Squat': {
    setup: ['Stand on rounded side of Bosu ball', 'Or flip and stand on flat side for harder version', 'Feet shoulder-width apart', 'Find balance before squatting'],
    execution: ['Squat down maintaining balance', 'Keep core tight', 'Stand back up', 'Control throughout'],
    tips: ['Great for stability and balance', 'Start with bodyweight only', 'The instability challenges core']
  },
  'Single Leg Deadlift': {
    setup: ['Stand on one leg holding dumbbell', 'Slight bend in standing leg', 'Other leg ready to extend behind', 'Core engaged'],
    execution: ['Hinge at hip extending rear leg', 'Lower dumbbell toward floor', 'Keep back flat throughout', 'Return to standing'],
    tips: ['Great for balance and hamstring strength', 'Touch toe down if needed for balance', 'Excellent for fixing imbalances']
  },
  'Pistol Squat': {
    setup: ['Stand on one leg', 'Other leg extended in front', 'Arms out for balance', 'Core very tight'],
    execution: ['Squat down on single leg', 'Keep extended leg off ground', 'Go as low as possible', 'Stand back up without help'],
    tips: ['Advanced single leg exercise', 'Requires strength and mobility', 'Use assistance (TRX, pole) to learn']
  },
  'Box Step Up': {
    setup: ['Stand facing sturdy box or step', 'Hold dumbbells at sides', 'One foot on top of box', 'Core engaged'],
    execution: ['Step up using top leg only', 'Don\'t push off bottom foot', 'Stand fully on box', 'Step down with control'],
    tips: ['Keep all the work in the top leg', 'Higher box = more glute emphasis', 'Great for single leg strength']
  }
};

// Helper to get exercise instructions (returns default if not found)
const getExerciseInstructions = (exerciseName) => {
  // Direct lookup first
  if (EXERCISE_INSTRUCTIONS[exerciseName]) {
    return EXERCISE_INSTRUCTIONS[exerciseName];
  }

  // Try removing trailing 's' (plural to singular)
  const singularName = exerciseName.endsWith('s') ? exerciseName.slice(0, -1) : exerciseName;
  if (EXERCISE_INSTRUCTIONS[singularName]) {
    return EXERCISE_INSTRUCTIONS[singularName];
  }

  // Try adding trailing 's' (singular to plural)
  const pluralName = exerciseName + 's';
  if (EXERCISE_INSTRUCTIONS[pluralName]) {
    return EXERCISE_INSTRUCTIONS[pluralName];
  }

  // Handle common variations
  const nameVariations = {
    'Dumbbell RDL': 'Romanian Deadlift',
    'Single Leg RDL': 'Single Leg Deadlift',
    'Glute Kickback': 'Cable Kickback',
    'Hip Abduction': 'Hip Abduction Machine',
    'Cable Hip Abduction': 'Hip Abduction Machine',
    'Squat': 'Barbell Back Squat',
    'Lunges': 'Walking Lunges',
    'Leg Curl': 'Lying Leg Curl',
    'Face Pull': 'Face Pulls',
    'Cable Woodchop (Low to High)': 'Wood Chops',
  };

  if (nameVariations[exerciseName] && EXERCISE_INSTRUCTIONS[nameVariations[exerciseName]]) {
    return EXERCISE_INSTRUCTIONS[nameVariations[exerciseName]];
  }

  // Return default instructions for unlisted exercises
  return {
    setup: ['Position yourself at the equipment', 'Adjust settings for your body size', 'Grip handles or bar with proper hand placement', 'Engage your core before starting'],
    execution: ['Perform the movement with control', 'Focus on the target muscle', 'Use full range of motion', 'Breathe out during exertion, in during release'],
    tips: ['Start with lighter weight to learn the movement', 'Focus on form over weight', 'If unsure, ask a trainer for guidance']
  };
};

// Exercise Info Modal - shows step-by-step instructions for exercises
const ExerciseInfoModal = ({ COLORS, exerciseName, onClose }) => {
  const instructions = getExerciseInstructions(exerciseName);

  return (
    <div className="fixed inset-0 z-50 flex items-center justify-center p-4" style={{ backgroundColor: 'rgba(0,0,0,0.2)' }}>
      <div className="w-full max-w-md rounded-2xl p-6 max-h-[85vh] overflow-auto" style={{ backgroundColor: COLORS.surface }}>
        <div className="flex items-center justify-between mb-6">
          <div className="flex items-center gap-3">
            <div className="w-10 h-10 rounded-full flex items-center justify-center" style={{ backgroundColor: COLORS.primary + '20' }}>
              <Info size={20} color={COLORS.primary} />
            </div>
            <h3 className="text-lg font-bold" style={{ color: COLORS.text }}>{exerciseName}</h3>
          </div>
          <button onClick={onClose} className="p-2 rounded-full" style={{ backgroundColor: COLORS.surfaceLight }}>
            <X size={20} color={COLORS.textMuted} />
          </button>
        </div>

        {/* Setup Section */}
        <div className="mb-5">
          <div className="flex items-center gap-2 mb-3">
            <div className="w-6 h-6 rounded-full flex items-center justify-center text-xs font-bold" style={{ backgroundColor: COLORS.primary, color: COLORS.text }}>1</div>
            <h4 className="font-semibold" style={{ color: COLORS.text }}>Setup</h4>
          </div>
          <div className="space-y-2 pl-8">
            {instructions.setup.map((step, idx) => (
              <div key={idx} className="flex items-start gap-2">
                <span className="text-sm mt-0.5" style={{ color: COLORS.textMuted }}>{idx + 1}.</span>
                <p className="text-sm" style={{ color: COLORS.textSecondary }}>{step}</p>
              </div>
            ))}
          </div>
        </div>

        {/* Execution Section */}
        <div className="mb-5">
          <div className="flex items-center gap-2 mb-3">
            <div className="w-6 h-6 rounded-full flex items-center justify-center text-xs font-bold" style={{ backgroundColor: COLORS.primary, color: COLORS.text }}>2</div>
            <h4 className="font-semibold" style={{ color: COLORS.text }}>Execution</h4>
          </div>
          <div className="space-y-2 pl-8">
            {instructions.execution.map((step, idx) => (
              <div key={idx} className="flex items-start gap-2">
                <span className="text-sm mt-0.5" style={{ color: COLORS.textMuted }}>{idx + 1}.</span>
                <p className="text-sm" style={{ color: COLORS.textSecondary }}>{step}</p>
              </div>
            ))}
          </div>
        </div>

        {/* Tips Section */}
        <div className="mb-4">
          <div className="flex items-center gap-2 mb-3">
            <div className="w-6 h-6 rounded-full flex items-center justify-center" style={{ backgroundColor: COLORS.warning + '20' }}>
              <Zap size={14} color={COLORS.warning} />
            </div>
            <h4 className="font-semibold" style={{ color: COLORS.text }}>Pro Tips</h4>
          </div>
          <div className="space-y-2 pl-8">
            {instructions.tips.map((tip, idx) => (
              <div key={idx} className="flex items-start gap-2">
                <span className="text-sm" style={{ color: COLORS.warning }}></span>
                <p className="text-sm" style={{ color: COLORS.textSecondary }}>{tip}</p>
              </div>
            ))}
          </div>
        </div>

        <button
          onClick={onClose}
          className="w-full py-3 rounded-xl font-semibold mt-2"
          style={{ backgroundColor: COLORS.primary, color: COLORS.text }}
        >
          Got It
        </button>
      </div>
    </div>
  );
};

// Helper to get program for a goal
const getProgramForGoal = (goal) => {
  return GOAL_TO_PROGRAM[goal] || GOAL_TO_PROGRAM.fitness;
};

// Weight Goal Step Component - defined outside main component to prevent recreation
const WeightGoalStep = ({ userData, setUserData, COLORS }) => {
  const currentWeightRef = React.useRef(null);
  const goalWeightRef = React.useRef(null);
  
  // Reasonable human weight bounds (in kg)
  const MIN_WEIGHT = 35;
  const MAX_WEIGHT = 250;
  
  const currentW = parseFloat(userData.currentWeight) || 0;
  const goalW = parseFloat(userData.goalWeight) || 0;
  const diff = goalW - currentW;
  const weeks = userData.programWeeks || 16;
  const weeklyChange = currentW && goalW ? (diff / weeks) : 0;
  
  // Weight validation
  const isValidWeight = (w) => w >= MIN_WEIGHT && w <= MAX_WEIGHT;
  const currentWeightValid = !userData.currentWeight || isValidWeight(currentW);
  const goalWeightValid = !userData.goalWeight || isValidWeight(goalW);
  
  const getSuggestedGoal = () => {
    if (!currentW || !isValidWeight(currentW)) return '';
    if (userData.goal === 'lose_fat') return (currentW * 0.9).toFixed(1);
    if (userData.goal === 'build_muscle' || userData.goal === 'strength') return (currentW * 1.05).toFixed(1);
    return currentW.toFixed(1);
  };
  
  const getWarning = () => {
    if (!currentW || !goalW) return null;
    if (!isValidWeight(currentW) || !isValidWeight(goalW)) return null; // Handled separately
    
    const absWeekly = Math.abs(weeklyChange);
    
    if (userData.goal === 'lose_fat') {
      if (diff > 0) return { type: 'error', msg: 'Your goal weight is higher than current. For fat loss, set a lower target.' };
      if (absWeekly > 1) return { type: 'error', msg: `Losing ${absWeekly.toFixed(1)}kg/week is too aggressive. Max recommended: 1kg/week.` };
      if (absWeekly > 0.75) return { type: 'warning', msg: `${absWeekly.toFixed(1)}kg/week is ambitious. Consider a slower pace for sustainability.` };
    } else if (userData.goal === 'build_muscle' || userData.goal === 'strength') {
      if (diff < 0) return { type: 'error', msg: 'Your goal weight is lower than current. For muscle gain, set a higher target.' };
      if (absWeekly > 0.5) return { type: 'error', msg: `Gaining ${absWeekly.toFixed(1)}kg/week may lead to excess fat. Max recommended: 0.5kg/week.` };
      if (absWeekly > 0.35) return { type: 'warning', msg: `${absWeekly.toFixed(1)}kg/week is ambitious. Slower gains = leaner results.` };
    }
    return null;
  };
  
  const warning = getWarning();
  
  // Check if fields need attention (empty or invalid)
  const currentWeightNeedsAttention = !userData.currentWeight || !isValidWeight(currentW);
  const goalWeightNeedsAttention = !userData.goalWeight || !isValidWeight(goalW);

  return (
    <div className="space-y-4">
      <div>
        <label className="text-sm mb-2 block" style={{ color: COLORS.textMuted }}>
          Current Weight (kg) <span style={{ color: COLORS.error }}>*</span>
        </label>
        <input
          ref={currentWeightRef}
          type="text"
          inputMode="decimal"
          defaultValue={userData.currentWeight}
          onBlur={e => {
            const val = e.target.value.replace(/[^0-9.]/g, '');
            setUserData(p => ({...p, currentWeight: val}));
          }}
          placeholder="e.g. 80"
          className="w-full p-4 rounded-xl text-xl font-bold text-center"
          style={{
            backgroundColor: COLORS.surface,
            color: COLORS.text,
            border: `2px solid ${!currentWeightValid ? COLORS.error : COLORS.surfaceLight}`
          }}
        />
        {!currentWeightValid && userData.currentWeight && (
          <p className="text-xs mt-1" style={{ color: COLORS.error }}>
            Please enter a realistic weight ({MIN_WEIGHT}-{MAX_WEIGHT}kg)
          </p>
        )}
        {!userData.currentWeight && (
          <p className="text-xs mt-1" style={{ color: COLORS.warning }}>
            Required - enter your current weight
          </p>
        )}
      </div>

      <div>
        <div className="flex justify-between items-center mb-2">
          <label className="text-sm" style={{ color: COLORS.textMuted }}>
            Goal Weight (kg) <span style={{ color: COLORS.error }}>*</span>
          </label>
          {userData.currentWeight && !userData.goalWeight && isValidWeight(currentW) && (
            <button
              onClick={() => {
                const suggested = getSuggestedGoal();
                if (goalWeightRef.current) goalWeightRef.current.value = suggested;
                setUserData(p => ({...p, goalWeight: suggested}));
              }}
              className="text-xs px-2 py-1 rounded-full"
              style={{ backgroundColor: COLORS.primary + '20', color: COLORS.primary }}
            >
              Use Suggested: {getSuggestedGoal()}kg
            </button>
          )}
        </div>
        <input
          ref={goalWeightRef}
          type="text"
          inputMode="decimal"
          defaultValue={userData.goalWeight}
          onBlur={e => {
            const val = e.target.value.replace(/[^0-9.]/g, '');
            setUserData(p => ({...p, goalWeight: val}));
          }}
          placeholder={userData.goal === 'build_muscle' || userData.goal === 'strength' ? 'e.g. 85' : 'e.g. 75'}
          className="w-full p-4 rounded-xl text-xl font-bold text-center"
          style={{
            backgroundColor: COLORS.surface,
            color: COLORS.text,
            border: `2px solid ${!goalWeightValid ? COLORS.error : COLORS.surfaceLight}`
          }}
        />
        {!goalWeightValid && userData.goalWeight && (
          <p className="text-xs mt-1" style={{ color: COLORS.error }}>
            Please enter a realistic weight ({MIN_WEIGHT}-{MAX_WEIGHT}kg)
          </p>
        )}
        {!userData.goalWeight && (
          <p className="text-xs mt-1" style={{ color: COLORS.warning }}>
            Required - enter your target weight
          </p>
        )}
      </div>

      <div>
        <label className="text-sm mb-2 block" style={{ color: COLORS.textMuted }}>Program Duration</label>
        <div className="flex gap-2">
          {[12, 16, 20, 24].map(w => (
            <button
              key={w}
              onClick={() => setUserData(p => ({...p, programWeeks: w}))}
              className="flex-1 py-3 rounded-xl text-sm font-semibold"
              style={{ 
                backgroundColor: userData.programWeeks === w ? COLORS.primary : COLORS.surface,
                color: userData.programWeeks === w ? COLORS.text : COLORS.textMuted,
                border: `2px solid ${userData.programWeeks === w ? COLORS.primary : COLORS.surfaceLight}`
              }}
            >
              {w} weeks
            </button>
          ))}
        </div>
      </div>

      {/* Rest Days Selector */}
      <div>
        <div className="flex justify-between items-center mb-2">
          <label className="text-sm" style={{ color: COLORS.textMuted }}>Rest Days</label>
          <button
            onClick={() => {
              // Suggest rest days based on goal (Mon=0, Sun=6 in our system)
              const suggested = userData.goal === 'strength' 
                ? [2, 6] // Wed, Sun for heavy lifting recovery
                : userData.goal === 'build_muscle'
                ? [3, 6] // Thu, Sun
                : [5, 6]; // Sat, Sun for general/fat loss
              setUserData(p => ({...p, restDays: suggested}));
            }}
            className="text-xs px-2 py-1 rounded-full"
            style={{ backgroundColor: COLORS.accent + '20', color: COLORS.accent }}
          >
            Use Suggested
          </button>
        </div>
        <div className="flex gap-1">
          {['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'].map((day, index) => {
            const isRestDay = userData.restDays?.includes(index);
            return (
              <button
                key={day}
                onClick={() => {
                  setUserData(p => ({
                    ...p,
                    restDays: isRestDay 
                      ? p.restDays.filter(d => d !== index)
                      : [...(p.restDays || []), index].sort((a, b) => a - b)
                  }));
                }}
                className="flex-1 py-3 rounded-xl text-xs font-semibold flex flex-col items-center gap-1"
                style={{ 
                  backgroundColor: isRestDay ? COLORS.surfaceLight : COLORS.primary,
                  color: isRestDay ? COLORS.textMuted : COLORS.text,
                  border: `2px solid ${isRestDay ? COLORS.surfaceLight : COLORS.primary}`
                }}
              >
                <span>{day}</span>
                <span style={{ fontSize: 10 }}>{isRestDay ? 'Rest' : 'Train'}</span>
              </button>
            );
          })}
        </div>
        <div className="flex justify-between items-center mt-2">
          <p className="text-xs" style={{ color: COLORS.textMuted }}>
            Tap days to toggle
          </p>
          <p className="text-xs font-semibold" style={{ color: COLORS.primary }}>
            {7 - (userData.restDays?.length || 0)} training days/week
          </p>
        </div>
      </div>

      {currentWeightValid && goalWeightValid && currentW > 0 && goalW > 0 && (
        <div className="p-4 rounded-xl" style={{ backgroundColor: COLORS.surface }}>
          <div className="flex justify-between items-center mb-2">
            <span className="text-sm" style={{ color: COLORS.textMuted }}>Total Change</span>
            <span className="font-bold" style={{ color: diff < 0 ? COLORS.accent : COLORS.success }}>
              {diff > 0 ? '+' : ''}{diff.toFixed(1)}kg
            </span>
          </div>
          <div className="flex justify-between items-center">
            <span className="text-sm" style={{ color: COLORS.textMuted }}>Weekly Target</span>
            <span className="font-bold" style={{ color: COLORS.text }}>
              {weeklyChange > 0 ? '+' : ''}{weeklyChange.toFixed(2)}kg/week
            </span>
          </div>
        </div>
      )}

      {warning && (
        <div 
          className="p-4 rounded-xl flex items-start gap-3"
          style={{ backgroundColor: warning.type === 'error' ? COLORS.error + '20' : COLORS.warning + '20' }}
        >
          <AlertCircle size={20} color={warning.type === 'error' ? COLORS.error : COLORS.warning} className="flex-shrink-0 mt-0.5" />
          <p className="text-sm" style={{ color: warning.type === 'error' ? COLORS.error : COLORS.warning }}>
            {warning.msg}
          </p>
        </div>
      )}

      {!warning && currentWeightValid && goalWeightValid && currentW > 0 && goalW > 0 && (
        <div 
          className="p-4 rounded-xl flex items-start gap-3"
          style={{ backgroundColor: COLORS.success + '20' }}
        >
          <Check size={20} color={COLORS.success} className="flex-shrink-0 mt-0.5" />
          <p className="text-sm" style={{ color: COLORS.success }}>
            This is a healthy, sustainable goal. You're set for success!
          </p>
        </div>
      )}
      
      <p className="text-xs text-center" style={{ color: COLORS.textMuted }}>
        Tap outside the input to update calculations
      </p>
    </div>
  );
};

// Profile Setup Step - separate component to prevent input focus loss
const ProfileSetupStep = ({ userData, setUserData, COLORS }) => {
  const usernameRef = React.useRef(null);
  const bioRef = React.useRef(null);

  const genderOptions = [
    { id: 'male', label: 'Male', icon: '' },
    { id: 'female', label: 'Female', icon: '' },
    { id: 'other', label: 'Other', icon: '' },
  ];

  return (
    <div className="space-y-4">
      <div>
        <label className="text-sm mb-2 block" style={{ color: COLORS.textMuted }}>Username</label>
        <input
          ref={usernameRef}
          type="text"
          defaultValue={userData.username}
          onBlur={e => {
            const val = e.target.value.toLowerCase().replace(/[^a-z0-9_]/g, '');
            e.target.value = val; // Update displayed value
            setUserData(p => ({...p, username: val}));
          }}
          placeholder="e.g. fitwarrior_23"
          className="w-full p-4 rounded-xl text-lg"
          style={{ backgroundColor: COLORS.surface, color: COLORS.text, border: `2px solid ${COLORS.surfaceLight}` }}
          maxLength={20}
        />
        <p className="text-xs mt-1" style={{ color: COLORS.textMuted }}>
          Lowercase letters, numbers, and underscores only  Tap outside to confirm
        </p>
      </div>
      <div>
        <label className="text-sm mb-2 block" style={{ color: COLORS.textMuted }}>Gender</label>
        <div className="grid grid-cols-3 gap-2">
          {genderOptions.map(option => (
            <button
              key={option.id}
              type="button"
              onClick={() => setUserData(p => ({...p, gender: option.id}))}
              className="p-3 rounded-xl flex flex-col items-center gap-1"
              style={{
                backgroundColor: userData.gender === option.id ? COLORS.primary + '20' : COLORS.surface,
                border: `2px solid ${userData.gender === option.id ? COLORS.primary : COLORS.surfaceLight}`
              }}
            >
              <span className="text-xl">{option.icon}</span>
              <span
                className="text-sm font-medium"
                style={{ color: userData.gender === option.id ? COLORS.primary : COLORS.text }}
              >
                {option.label}
              </span>
            </button>
          ))}
        </div>
      </div>
      <div>
        <label className="text-sm mb-2 block" style={{ color: COLORS.textMuted }}>Bio (optional)</label>
        <textarea
          ref={bioRef}
          defaultValue={userData.bio}
          onBlur={e => {
            setUserData(p => ({...p, bio: e.target.value}));
          }}
          placeholder="Tell others about your fitness journey..."
          className="w-full p-4 rounded-xl text-sm resize-none"
          style={{ backgroundColor: COLORS.surface, color: COLORS.text, border: `2px solid ${COLORS.surfaceLight}` }}
          rows={3}
          maxLength={150}
        />
      </div>
      <div className="p-4 rounded-xl" style={{ backgroundColor: COLORS.primary + '10' }}>
        <p className="text-sm" style={{ color: COLORS.primary }}>
          Your username will be visible to friends and in challenges. You can change it anytime.
        </p>
      </div>
    </div>
  );
};

// Onboarding Screen - extracted outside main component to prevent focus loss
const OnboardingScreen = ({
  userData,
  setUserData,
  onboardingStep,
  setOnboardingStep,
  hoveredGoal,
  setHoveredGoal,
  sleepHours,
  setSleepHours,
  setCurrentScreen,
  user,
  updateProfile,
  updateGoals,
  setNutritionGoals,
  setOverviewStats,
  onboardingScrollRef,
  toggleEquipmentWithScroll,
  getLocalDateString,
  generateNutritionTargets,
}) => {
  const steps = [
    {
      title: "Create your profile",
      subtitle: "Choose a username your friends will see",
      content: null // Will be rendered separately using ProfileSetupStep component
    },
    {
      title: "What's your main goal?",
      subtitle: "Select a goal, tap  to learn more",
      content: (
        <div className="space-y-3">
          {Object.entries(GOAL_INFO).map(([id, goal]) => (
            <div key={id}>
              <div
                className="w-full p-4 rounded-xl flex items-center gap-4 text-left cursor-pointer"
                style={{ backgroundColor: userData.goal === id ? COLORS.primary + '20' : COLORS.surface,
                  border: `2px solid ${userData.goal === id ? COLORS.primary : COLORS.surfaceLight}`,
                  borderRadius: hoveredGoal === id ? '12px 12px 0 0' : '12px' }}
                onClick={() => { setUserData(p => ({...p, goal: id})); setHoveredGoal(id); }}
              >
                <div className="w-12 h-12 rounded-xl flex items-center justify-center" style={{ backgroundColor: userData.goal === id ? COLORS.primary + '30' : COLORS.surfaceLight }}>
                  <IconMap name={goal.icon} size={24} color={userData.goal === id ? COLORS.primary : COLORS.textMuted} />
                </div>
                <div className="flex-1">
                  <p className="font-semibold" style={{ color: userData.goal === id ? COLORS.primary : COLORS.text }}>{goal.title}</p>
                </div>
                {userData.goal === id && <Check size={20} color={COLORS.primary} />}
                <button
                  onClick={(e) => { e.stopPropagation(); setHoveredGoal(hoveredGoal === id ? null : id); }}
                  className="p-2 rounded-full"
                  style={{ backgroundColor: hoveredGoal === id ? COLORS.primary : COLORS.surfaceLight }}
                >
                  <Info size={18} color={hoveredGoal === id ? COLORS.text : COLORS.textMuted} />
                </button>
              </div>

              {/* Info Panel - Inline, pushes content down */}
              {hoveredGoal === id && (
                <div
                  className="p-4 rounded-b-xl"
                  style={{ backgroundColor: COLORS.surfaceLight, borderTop: `1px solid ${COLORS.surface}` }}
                >
                  <p className="text-sm mb-3" style={{ color: COLORS.textSecondary }}>{goal.overview}</p>
                  <div className="space-y-2">
                    {goal.requirements.map((req, i) => (
                      <div key={i} className="flex items-start gap-2">
                        <IconMap name={req.icon} size={16} color={COLORS.textMuted} />
                        <div>
                          <p className="text-sm font-semibold" style={{ color: COLORS.text }}>{req.title}</p>
                          <p className="text-xs" style={{ color: COLORS.textMuted }}>{req.desc}</p>
                        </div>
                      </div>
                    ))}
                  </div>
                  <div className="mt-3 pt-3 border-t flex justify-between text-xs" style={{ borderColor: COLORS.surface }}>
                    <span style={{ color: COLORS.textMuted }}>Min: {goal.minDays} days/week</span>
                    <span style={{ color: COLORS.accent }}>Ideal: {goal.idealDays} days/week</span>
                  </div>
                </div>
              )}
            </div>
          ))}
        </div>
      )
    },
    {
      title: "Set your weight goals",
      subtitle: "We'll create a safe, sustainable plan",
      content: null // Will be rendered separately to avoid re-creation
    },
    {
      title: "Your experience level?",
      content: (
        <div className="space-y-3">
          {Object.values(EXPERIENCE_LEVELS).map(level => (
            <button key={level.id} onClick={() => setUserData(p => ({...p, experience: level.id}))}
              className="w-full p-4 rounded-xl text-left flex items-center gap-3"
              style={{ backgroundColor: userData.experience === level.id ? COLORS.primary + '20' : COLORS.surface,
                border: `2px solid ${userData.experience === level.id ? COLORS.primary : COLORS.surfaceLight}` }}>
              <div className="w-10 h-10 rounded-xl flex items-center justify-center" style={{ backgroundColor: userData.experience === level.id ? COLORS.primary + '30' : COLORS.surfaceLight }}>
                <IconMap name={level.icon} size={20} color={userData.experience === level.id ? COLORS.primary : COLORS.textMuted} />
              </div>
              <div className="flex-1">
                <p className="font-semibold" style={{ color: userData.experience === level.id ? COLORS.primary : COLORS.text }}>{level.label}</p>
                <p className="text-sm" style={{ color: COLORS.textSecondary }}>{level.desc}</p>
              </div>
              {userData.experience === level.id && <Check size={20} color={COLORS.primary} />}
            </button>
          ))}

          {/* Info callout for experienced/expert */}
          {['experienced', 'expert'].includes(userData.experience) && (
            <div className="mt-4 p-3 rounded-lg flex items-start gap-2" style={{ backgroundColor: COLORS.primary + '10' }}>
              <Info size={16} color={COLORS.primary} className="mt-0.5 flex-shrink-0" />
              <p className="text-sm" style={{ color: COLORS.textSecondary }}>
                Your workouts will include targeted muscle head selection for optimal development (e.g., long head vs short head biceps).
              </p>
            </div>
          )}
        </div>
      )
    },
    {
      title: "What equipment do you have?",
      subtitle: "We'll customize exercises to match your gym",
      content: (
        <div className="space-y-3">
          <p className="text-sm mb-2" style={{ color: COLORS.textMuted }}>Select all equipment you have access to:</p>
          {EQUIPMENT_OPTIONS.map(equip => {
            const isSelected = userData.equipment?.includes(equip.id);
            return (
              <button
                key={equip.id}
                onClick={() => toggleEquipmentWithScroll(equip.id)}
                className="w-full p-4 rounded-xl text-left flex items-center gap-3"
                style={{
                  backgroundColor: isSelected ? COLORS.primary + '20' : COLORS.surface,
                  border: `2px solid ${isSelected ? COLORS.primary : COLORS.surfaceLight}`
                }}
              >
                <div className="w-10 h-10 rounded-xl flex items-center justify-center" style={{ backgroundColor: isSelected ? COLORS.primary + '30' : COLORS.surfaceLight }}>
                  <IconMap name={equip.icon} size={20} color={isSelected ? COLORS.primary : COLORS.textMuted} />
                </div>
                <div className="flex-1">
                  <p className="font-semibold" style={{ color: isSelected ? COLORS.primary : COLORS.text }}>{equip.name}</p>
                  <p className="text-sm" style={{ color: COLORS.textSecondary }}>{equip.desc}</p>
                </div>
                {isSelected && <Check size={20} color={COLORS.primary} />}
              </button>
            );
          })}
          <div className="mt-4 p-3 rounded-lg flex items-start gap-2" style={{ backgroundColor: COLORS.surfaceLight }}>
            <Info size={16} color={COLORS.textMuted} className="mt-0.5 flex-shrink-0" />
            <p className="text-sm" style={{ color: COLORS.textMuted }}>
              Don't worry - you can change this anytime in Settings. We'll always show alternatives if needed.
            </p>
          </div>
        </div>
      )
    },
    {
      title: "Set your sleep goal",
      subtitle: "Good sleep is essential for recovery and results",
      content: (
        <div className="space-y-6">
          <div className="text-center py-6">
            <Moon size={48} color={COLORS.sleep} className="mx-auto mb-4" />
            <div className="mb-4">
              <span className="text-5xl font-bold" style={{ color: COLORS.sleep }}>{sleepHours}</span>
              <span className="text-xl ml-2" style={{ color: COLORS.textMuted }}>hours / night</span>
            </div>
            <p className="text-sm" style={{ color: COLORS.textSecondary }}>
              Most adults need 7-9 hours for optimal recovery
            </p>
          </div>

          <div className="flex items-center justify-center gap-6">
            <button
              onClick={() => setSleepHours(prev => Math.max(5, prev - 0.5))}
              className="w-14 h-14 rounded-full flex items-center justify-center"
              style={{ backgroundColor: COLORS.surface }}
            >
              <Minus size={24} color={COLORS.text} />
            </button>
            <div className="w-32 h-3 rounded-full overflow-hidden" style={{ backgroundColor: COLORS.surfaceLight }}>
              <div
                className="h-full rounded-full transition-all"
                style={{ backgroundColor: COLORS.sleep, width: `${((sleepHours - 5) / 5) * 100}%` }}
              />
            </div>
            <button
              onClick={() => setSleepHours(prev => Math.min(10, prev + 0.5))}
              className="w-14 h-14 rounded-full flex items-center justify-center"
              style={{ backgroundColor: COLORS.surface }}
            >
              <Plus size={24} color={COLORS.text} />
            </button>
          </div>

          <div className="mt-6 space-y-2">
            {[
              { hours: 6, label: 'Light sleeper', desc: 'Minimum for adults' },
              { hours: 7.5, label: 'Recommended', desc: 'Ideal for most people' },
              { hours: 8, label: 'Athlete', desc: 'Optimal for training recovery' },
            ].map(preset => (
              <button
                key={preset.hours}
                onClick={() => setSleepHours(preset.hours)}
                className="w-full p-3 rounded-xl text-left flex items-center gap-3"
                style={{
                  backgroundColor: sleepHours === preset.hours ? COLORS.sleep + '20' : COLORS.surface,
                  border: `2px solid ${sleepHours === preset.hours ? COLORS.sleep : 'transparent'}`
                }}
              >
                <div className="flex-1">
                  <p className="font-semibold" style={{ color: COLORS.text }}>{preset.hours} hrs - {preset.label}</p>
                  <p className="text-xs" style={{ color: COLORS.textMuted }}>{preset.desc}</p>
                </div>
                {sleepHours === preset.hours && <Check size={20} color={COLORS.sleep} />}
              </button>
            ))}
          </div>
        </div>
      )
    },
  ];

  const step = steps[onboardingStep];

  // Weight bounds
  const MIN_WEIGHT = 35;
  const MAX_WEIGHT = 250;
  const isValidWeight = (w) => w >= MIN_WEIGHT && w <= MAX_WEIGHT;

  // Check for weight step errors
  const getWeightError = () => {
    if (onboardingStep !== 2) return false;
    const currentW = parseFloat(userData.currentWeight) || 0;
    const goalW = parseFloat(userData.goalWeight) || 0;
    if (!currentW || !goalW) return false;

    // Check bounds
    if (!isValidWeight(currentW) || !isValidWeight(goalW)) return true;

    const diff = goalW - currentW;
    const weeks = userData.programWeeks || 16;
    const weeklyChange = Math.abs(diff / weeks);

    if (userData.goal === 'lose_fat' && diff > 0) return true;
    if ((userData.goal === 'build_muscle' || userData.goal === 'strength') && diff < 0) return true;
    if (userData.goal === 'lose_fat' && weeklyChange > 1) return true;
    if ((userData.goal === 'build_muscle' || userData.goal === 'strength') && weeklyChange > 0.5) return true;
    return false;
  };

  // Validate weights are real numbers in valid range
  const isValidWeightValue = (w) => {
    const num = parseFloat(w);
    return !isNaN(num) && num >= 35 && num <= 250;
  };

  const canProceed =
    onboardingStep === 0 ? (userData.username && userData.username.length >= 3) :
    onboardingStep === 1 ? userData.goal :
    onboardingStep === 2 ? (isValidWeightValue(userData.currentWeight) && isValidWeightValue(userData.goalWeight) && !getWeightError()) :
    onboardingStep === 3 ? userData.experience :
    onboardingStep === 4 ? (userData.equipment && userData.equipment.length > 0) :
    sleepHours >= 5 && sleepHours <= 10; // Sleep goal step

  return (
    <div className="flex flex-col h-full">
      <div className="flex items-center gap-3 p-4">
        <button onClick={() => onboardingStep > 0 ? setOnboardingStep(onboardingStep - 1) : setCurrentScreen('dashboard')}>
          <ChevronLeft size={24} color={COLORS.text} />
        </button>
        <div className="flex-1 flex gap-1">
          {steps.map((_, i) => (
            <div key={i} className="flex-1 h-1 rounded-full"
              style={{ backgroundColor: i <= onboardingStep ? COLORS.primary : COLORS.surfaceLight }} />
          ))}
        </div>
      </div>
      <div ref={onboardingScrollRef} className="flex-1 overflow-auto px-6 pb-4">
        <h2 className="text-2xl font-bold mb-2" style={{ color: COLORS.text }}>{step.title}</h2>
        {step.subtitle && <p className="mb-6" style={{ color: COLORS.textSecondary }}>{step.subtitle}</p>}
        {onboardingStep === 0 ? (
          <ProfileSetupStep
            userData={userData}
            setUserData={setUserData}
            COLORS={COLORS}
          />
        ) : onboardingStep === 2 ? (
          <WeightGoalStep
            userData={userData}
            setUserData={setUserData}
            COLORS={COLORS}
          />
        ) : step.content}
      </div>
      <div className="p-6">
        <button onClick={async () => {
          if (onboardingStep < steps.length - 1) {
            setOnboardingStep(onboardingStep + 1);
          } else {
            // Set up program based on user-entered weights
            const currentW = parseFloat(userData.currentWeight) || 80;
            const goalW = parseFloat(userData.goalWeight) || 75;
            const weeks = userData.programWeeks || 16;
            const weeklyTarget = (goalW - currentW) / weeks;

            // Save profile and goals to Supabase
            if (user) {
              try {
                // Update profile (username, bio, gender)
                await updateProfile({
                  username: userData.username,
                  bio: userData.bio || '',
                  gender: userData.gender,
                  first_name: userData.firstName || '',
                  last_name: userData.lastName || '',
                });

                // Update goals
                await updateGoals({
                  goal: userData.goal,
                  experience: userData.experience,
                  current_weight: currentW,
                  goal_weight: goalW,
                  starting_weight: currentW,
                  program_weeks: weeks,
                  days_per_week: userData.daysPerWeek || 4,
                  session_duration: userData.sessionDuration || 60,
                  rest_days: userData.restDays || [5, 6],
                });

                // Calculate and save nutrition goals
                const nutritionTargets = generateNutritionTargets({
                  weight: currentW,
                  height: 175, // Could add to onboarding
                  age: 25, // Could add to onboarding
                  gender: userData.gender || 'other',
                  goal: userData.goal || 'fitness',
                  workoutsPerWeek: userData.daysPerWeek || 4,
                  goalWeight: goalW,
                });

                await nutritionService.updateNutritionGoals(user.id, {
                  calories: nutritionTargets.calories,
                  protein: nutritionTargets.protein,
                  carbs: nutritionTargets.carbs,
                  fats: nutritionTargets.fat,
                  water: nutritionTargets.water,
                });

                // Update local state
                setNutritionGoals({
                  calories: nutritionTargets.calories,
                  protein: nutritionTargets.protein,
                  carbs: nutritionTargets.carbs,
                  fats: nutritionTargets.fat,
                  water: nutritionTargets.water,
                  tdee: nutritionTargets.tdee,
                  weeklyWeightChange: nutritionTargets.weeklyWeightChange,
                });

                // Log initial weight
                await profileService.logWeight(user.id, currentW);

                // Save default sleep goal
                await sleepService.updateSleepGoals(user.id, { target_hours: sleepHours });

              } catch (err) {
                console.error('Error saving onboarding data:', err);
              }
            }

            // Set program start date to today
            const programStartDate = getLocalDateString();

            setOverviewStats(prev => ({
              ...prev,
              startingWeight: currentW,
              currentWeight: currentW,
              targetWeight: goalW,
              weeklyTarget: parseFloat(weeklyTarget.toFixed(2)),
              programWeek: 1,
              programLength: weeks,
              programStartDate,
            }));
            setCurrentScreen('main');
          }
        }}
          disabled={!canProceed} className="w-full py-4 rounded-xl font-semibold text-lg"
          style={{ backgroundColor: COLORS.primary, color: COLORS.text, opacity: canProceed ? 1 : 0.5 }}>
          {onboardingStep < steps.length - 1 ? 'Continue' : 'Start Training'}
        </button>
      </div>
    </div>
  );
};

// Edit Profile Modal - separate component to prevent input focus loss
const EditProfileModal = ({ userData, setUserData, COLORS, onClose, user, updateProfile }) => {
  const usernameRef = React.useRef(null);
  const firstNameRef = React.useRef(null);
  const lastNameRef = React.useRef(null);
  const bioRef = React.useRef(null);
  const profilePicInputRef = React.useRef(null);
  const coverPhotoInputRef = React.useRef(null);

  const [uploadingProfilePic, setUploadingProfilePic] = React.useState(false);
  const [uploadingCover, setUploadingCover] = React.useState(false);
  const [saving, setSaving] = React.useState(false);
  const [saveError, setSaveError] = React.useState(null);

  const handleProfilePicUpload = async (e) => {
    const file = e.target.files?.[0];
    if (!file || !user?.id) return;

    // Validate file type
    if (!file.type.startsWith('image/')) {
      alert('Please select an image file');
      return;
    }

    // Validate file size (max 5MB)
    if (file.size > 5 * 1024 * 1024) {
      alert('Image must be less than 5MB');
      return;
    }

    setUploadingProfilePic(true);
    try {
      const { data, error } = await storageService.uploadProfilePicture(user.id, file);
      if (error) throw error;

      // Update profile with new avatar URL
      await updateProfile({ avatar_url: data.url });
      setUserData(prev => ({ ...prev, avatarUrl: data.url }));
    } catch (err) {
      console.error('Error uploading profile picture:', err);
      alert('Failed to upload profile picture');
    } finally {
      setUploadingProfilePic(false);
    }
  };

  const handleCoverPhotoUpload = async (e) => {
    const file = e.target.files?.[0];
    if (!file || !user?.id) return;

    // Validate file type
    if (!file.type.startsWith('image/')) {
      alert('Please select an image file');
      return;
    }

    // Validate file size (max 10MB)
    if (file.size > 10 * 1024 * 1024) {
      alert('Image must be less than 10MB');
      return;
    }

    setUploadingCover(true);
    try {
      const { data, error } = await storageService.uploadCoverPhoto(user.id, file);
      if (error) throw error;

      // Update profile with new cover photo URL
      await updateProfile({ cover_photo_url: data.url });
      setUserData(prev => ({ ...prev, coverPhotoUrl: data.url }));
    } catch (err) {
      console.error('Error uploading cover photo:', err);
      alert('Failed to upload cover photo');
    } finally {
      setUploadingCover(false);
    }
  };

  return (
    <div className="fixed inset-0 z-50 flex flex-col" style={{ backgroundColor: COLORS.background }}>
      <div className="p-4 border-b flex items-center gap-3" style={{ borderColor: COLORS.surfaceLight }}>
        <button onClick={onClose}>
          <X size={24} color={COLORS.text} />
        </button>
        <h3 className="text-lg font-bold" style={{ color: COLORS.text }}>Edit Profile</h3>
      </div>

      <div className="flex-1 overflow-auto p-4">
        {/* Cover Photo */}
        <div className="mb-4 -mx-4 -mt-4">
          <div
            className="h-32 relative flex items-center justify-center"
            style={{
              backgroundColor: userData.coverPhotoUrl ? 'transparent' : COLORS.surfaceLight,
              backgroundImage: userData.coverPhotoUrl ? `url(${userData.coverPhotoUrl})` : 'none',
              backgroundSize: 'cover',
              backgroundPosition: 'center'
            }}
          >
            <input
              ref={coverPhotoInputRef}
              type="file"
              accept="image/*"
              onChange={handleCoverPhotoUpload}
              className="hidden"
            />
            <button
              onClick={() => coverPhotoInputRef.current?.click()}
              disabled={uploadingCover}
              className="px-4 py-2 rounded-xl text-sm font-semibold"
              style={{ backgroundColor: COLORS.background + 'CC', color: COLORS.text }}
            >
              {uploadingCover ? 'Uploading...' : (userData.coverPhotoUrl ? 'Change Cover' : 'Add Cover Photo')}
            </button>
          </div>
        </div>

        {/* Avatar Preview */}
        <div className="flex flex-col items-center mb-6 -mt-12">
          <div
            className="w-24 h-24 rounded-full flex items-center justify-center text-5xl mb-3 border-4"
            style={{
              backgroundColor: userData.avatarUrl ? 'transparent' : COLORS.primary + '20',
              backgroundImage: userData.avatarUrl ? `url(${userData.avatarUrl})` : 'none',
              backgroundSize: 'cover',
              backgroundPosition: 'center',
              borderColor: COLORS.background
            }}
          >
            {!userData.avatarUrl && ''}
          </div>
          <input
            ref={profilePicInputRef}
            type="file"
            accept="image/*"
            onChange={handleProfilePicUpload}
            className="hidden"
          />
          <button
            onClick={() => profilePicInputRef.current?.click()}
            disabled={uploadingProfilePic}
            className="text-sm px-4 py-2 rounded-full"
            style={{ backgroundColor: COLORS.surfaceLight, color: COLORS.primary }}
          >
            {uploadingProfilePic ? 'Uploading...' : 'Change Avatar'}
          </button>
        </div>
        
        {/* Username */}
        <div className="mb-4">
          <label className="text-sm mb-2 block font-semibold" style={{ color: COLORS.text }}>Username</label>
          <div className="relative">
            <span className="absolute left-4 top-1/2 -translate-y-1/2" style={{ color: COLORS.textMuted }}>@</span>
            <input
              ref={usernameRef}
              type="text"
              defaultValue={userData.username}
              onBlur={e => {
                const val = e.target.value.toLowerCase().replace(/[^a-z0-9_]/g, '');
                e.target.value = val;
                setUserData(prev => ({...prev, username: val}));
              }}
              className="w-full p-4 pl-8 rounded-xl"
              style={{ backgroundColor: COLORS.surface, color: COLORS.text, border: `2px solid ${COLORS.surfaceLight}` }}
              maxLength={20}
            />
          </div>
          <p className="text-xs mt-1" style={{ color: COLORS.textMuted }}>
            Lowercase letters, numbers, and underscores only
          </p>
        </div>
        
        {/* Display Name */}
        <div className="mb-4">
          <label className="text-sm mb-2 block font-semibold" style={{ color: COLORS.text }}>Display Name</label>
          <div className="flex gap-2">
            <input
              ref={firstNameRef}
              type="text"
              defaultValue={userData.firstName}
              onBlur={e => setUserData(prev => ({...prev, firstName: e.target.value}))}
              placeholder="First"
              className="flex-1 p-4 rounded-xl"
              style={{ backgroundColor: COLORS.surface, color: COLORS.text, border: `2px solid ${COLORS.surfaceLight}` }}
            />
            <input
              ref={lastNameRef}
              type="text"
              defaultValue={userData.lastName}
              onBlur={e => setUserData(prev => ({...prev, lastName: e.target.value}))}
              placeholder="Last"
              className="flex-1 p-4 rounded-xl"
              style={{ backgroundColor: COLORS.surface, color: COLORS.text, border: `2px solid ${COLORS.surfaceLight}` }}
            />
          </div>
        </div>
        
        {/* Gender */}
        <div className="mb-4">
          <label className="text-sm mb-2 block font-semibold" style={{ color: COLORS.text }}>Gender</label>
          <div className="grid grid-cols-3 gap-2">
            {[
              { id: 'male', label: 'Male', icon: '' },
              { id: 'female', label: 'Female', icon: '' },
              { id: 'other', label: 'Other', icon: '' },
            ].map(option => (
              <button
                key={option.id}
                type="button"
                onClick={() => setUserData(prev => ({...prev, gender: option.id}))}
                className="p-3 rounded-xl flex flex-col items-center gap-1"
                style={{
                  backgroundColor: userData.gender === option.id ? COLORS.primary + '20' : COLORS.surface,
                  border: `2px solid ${userData.gender === option.id ? COLORS.primary : COLORS.surfaceLight}`
                }}
              >
                <span className="text-xl">{option.icon}</span>
                <span
                  className="text-sm font-medium"
                  style={{ color: userData.gender === option.id ? COLORS.primary : COLORS.text }}
                >
                  {option.label}
                </span>
              </button>
            ))}
          </div>
        </div>

        {/* Bio */}
        <div className="mb-4">
          <label className="text-sm mb-2 block font-semibold" style={{ color: COLORS.text }}>Bio</label>
          <textarea
            ref={bioRef}
            defaultValue={userData.bio}
            onBlur={e => setUserData(prev => ({...prev, bio: e.target.value}))}
            placeholder="Tell others about your fitness journey..."
            className="w-full p-4 rounded-xl resize-none"
            style={{ backgroundColor: COLORS.surface, color: COLORS.text, border: `2px solid ${COLORS.surfaceLight}` }}
            rows={4}
            maxLength={150}
          />
          <p className="text-xs mt-1 text-right" style={{ color: COLORS.textMuted }}>
            {userData.bio?.length || 0}/150
          </p>
        </div>
        
        {/* Preview */}
        <div className="p-4 rounded-xl" style={{ backgroundColor: COLORS.surface }}>
          <p className="text-xs mb-3" style={{ color: COLORS.textMuted }}>PREVIEW - How others see you</p>
          <div className="flex items-center gap-3 mb-3">
            <div
              className="w-12 h-12 rounded-full flex items-center justify-center text-2xl"
              style={{
                backgroundColor: userData.avatarUrl ? 'transparent' : COLORS.primary + '20',
                backgroundImage: userData.avatarUrl ? `url(${userData.avatarUrl})` : 'none',
                backgroundSize: 'cover',
                backgroundPosition: 'center'
              }}
            >
              {!userData.avatarUrl && ''}
            </div>
            <div>
              <p className="font-bold" style={{ color: COLORS.text }}>@{userData.username || 'username'}</p>
              <p className="text-xs" style={{ color: COLORS.textMuted }}>{userData.firstName || 'First'} {userData.lastName || 'Last'}</p>
            </div>
          </div>
          <p className="text-sm" style={{ color: COLORS.textSecondary }}>
            {userData.bio || 'No bio yet'}
          </p>
        </div>
      </div>
      
      <div className="p-4 border-t" style={{ borderColor: COLORS.surfaceLight }}>
        {saveError && (
          <p className="text-sm mb-3 text-center" style={{ color: '#ef4444' }}>
            {saveError}
          </p>
        )}
        <button
          onClick={async () => {
            setSaveError(null);
            setSaving(true);
            // Save profile data to database
            if (user?.id && updateProfile) {
              try {
                await updateProfile({
                  username: userData.username,
                  bio: userData.bio,
                  first_name: userData.firstName,
                  last_name: userData.lastName,
                  gender: userData.gender,
                });
                onClose();
              } catch (err) {
                console.error('Error saving profile:', err);
                setSaveError('Failed to save profile. Please try again.');
                setSaving(false);
                return;
              }
            } else {
              onClose();
            }
            setSaving(false);
          }}
          disabled={saving}
          className="w-full py-4 rounded-xl font-semibold"
          style={{
            backgroundColor: saving ? COLORS.surfaceLight : COLORS.primary,
            color: COLORS.text,
            opacity: saving ? 0.7 : 1
          }}
        >
          {saving ? 'Saving...' : 'Done'}
        </button>
      </div>
    </div>
  );
};

// Meal Entry Modal - separate component to prevent input focus loss
const MealEntryModal = ({ COLORS, onClose, onSave, userId }) => {
  // All state is local to prevent re-render issues with parent
  const [name, setName] = React.useState('');
  const [calories, setCalories] = React.useState('');
  const [protein, setProtein] = React.useState('');
  const [carbs, setCarbs] = React.useState('');
  const [searchQuery, setSearchQuery] = React.useState('');
  const [servingMultiplier, setServingMultiplier] = React.useState(1);
  const [capturedImage, setCapturedImage] = React.useState(null);
  const [analyzing, setAnalyzing] = React.useState(false);
  const [recognitionResult, setRecognitionResult] = React.useState(null);
  const [searchResults, setSearchResults] = React.useState([]);
  const [searching, setSearching] = React.useState(false);
  const [frequentMeals, setFrequentMeals] = React.useState([]);
  const [loadingFrequent, setLoadingFrequent] = React.useState(false);
  const fileInputRef = React.useRef(null);
  const modalRef = React.useRef(null);

  // Modal overlay handles scroll blocking via fixed positioning

  // Load user's frequent meals on mount
  React.useEffect(() => {
    if (!userId) return;

    const loadFrequentMeals = async () => {
      setLoadingFrequent(true);
      try {
        const { data, error } = await supabase
          .from('meal_logs')
          .select('meal_name, calories, protein, carbs, fats')
          .eq('user_id', userId)
          .order('logged_at', { ascending: false })
          .limit(100);

        if (error) throw error;

        // Group by meal name and count occurrences
        const mealCounts = {};
        const mealData = {};

        data?.forEach(meal => {
          const mealName = meal.meal_name?.toLowerCase().trim();
          if (!mealName) return;

          if (!mealCounts[mealName]) {
            mealCounts[mealName] = 0;
            mealData[mealName] = {
              name: meal.meal_name,
              calories: meal.calories || 0,
              protein: meal.protein || 0,
              carbs: meal.carbs || 0,
              fats: meal.fats || 0,
            };
          }
          mealCounts[mealName]++;
        });

        // Sort by frequency and take top 10
        const sortedMeals = Object.entries(mealCounts)
          .sort((a, b) => b[1] - a[1])
          .slice(0, 10)
          .map(([mealName, count]) => ({
            ...mealData[mealName],
            count,
          }));

        setFrequentMeals(sortedMeals);
      } catch (err) {
        console.error('Error loading frequent meals:', err);
      } finally {
        setLoadingFrequent(false);
      }
    };

    loadFrequentMeals();
  }, [userId]);

  const handlePhotoCapture = async (e) => {
    const file = e.target.files?.[0];
    if (!file) return;

    // Show preview
    const reader = new FileReader();
    reader.onload = (e) => setCapturedImage(e.target.result);
    reader.readAsDataURL(file);

    // Analyze food
    setAnalyzing(true);
    setRecognitionResult(null);

    try {
      const { data, error } = await foodRecognitionService.analyzeFood(file);

      if (error) {
        alert('Could not analyze food: ' + error);
        setAnalyzing(false);
        return;
      }

      // Auto-fill the form with recognized data
      setName(data.name);
      setCalories(data.nutrition.calories.toString());
      setProtein(data.nutrition.protein.toString());
      setCarbs((data.nutrition.carbs || 0).toString());
      setRecognitionResult(data);
    } catch (err) {
      console.error('Food analysis error:', err);
      alert('Failed to analyze food. Please enter manually.');
    } finally {
      setAnalyzing(false);
    }
  };

  const handleSearch = async () => {
    if (!searchQuery.trim()) {
      // Show all frequent meals if no query
      setSearchResults(frequentMeals.map(meal => ({
        ...meal,
        isFrequent: true,
      })));
      return;
    }

    setSearching(true);

    try {
      // Search user's frequent meals first
      const query = searchQuery.toLowerCase().trim();
      const matchingFrequent = frequentMeals
        .filter(meal => meal.name.toLowerCase().includes(query))
        .map(meal => ({ ...meal, isFrequent: true }));

      // Also search Open Food Facts database
      const { data, error } = await foodRecognitionService.searchOpenFoodFacts(searchQuery);

      if (error) {
        // Still show frequent meals even if API fails
        setSearchResults(matchingFrequent);
        setSearching(false);
        return;
      }

      // Combine results: frequent meals first, then API results
      const combinedResults = [
        ...matchingFrequent,
        ...(data || []).map(item => ({ ...item, isFrequent: false })),
      ];

      setSearchResults(combinedResults);
    } catch (err) {
      console.error('Search error:', err);
      // Show frequent meals as fallback
      const query = searchQuery.toLowerCase().trim();
      const matchingFrequent = frequentMeals
        .filter(meal => meal.name.toLowerCase().includes(query))
        .map(meal => ({ ...meal, isFrequent: true }));
      setSearchResults(matchingFrequent);
    } finally {
      setSearching(false);
    }
  };

  // Show suggestions as user types
  React.useEffect(() => {
    if (!searchQuery.trim()) {
      setSearchResults([]);
      return;
    }

    const query = searchQuery.toLowerCase().trim();
    const matchingFrequent = frequentMeals
      .filter(meal => meal.name.toLowerCase().includes(query))
      .map(meal => ({ ...meal, isFrequent: true }));

    if (matchingFrequent.length > 0) {
      setSearchResults(matchingFrequent);
    }
  }, [searchQuery, frequentMeals]);

  const handleSelectFood = (food) => {
    setName(food.name + (food.brand ? ` (${food.brand})` : ''));
    setCalories(Math.round(food.calories * servingMultiplier).toString());
    setProtein(Math.round(food.protein * servingMultiplier).toString());
    setCarbs(Math.round(food.carbs * servingMultiplier).toString());
    setSearchResults([]);
    setSearchQuery('');
  };

  const handleSave = (e) => {
    if (e) {
      e.preventDefault();
      e.stopPropagation();
    }

    const mealData = {
      name: name || 'Meal',
      calories: parseInt(calories) || 0,
      protein: parseInt(protein) || 0,
      carbs: parseInt(carbs) || 0,
      fats: 0, // Not tracking fats
    };
    onSave(mealData);
  };

  return (
    <div
      className="fixed inset-0 z-50 flex items-end justify-center"
      style={{ backgroundColor: 'rgba(0,0,0,0.2)', isolation: 'isolate', pointerEvents: 'none' }}
    >
      <div
        ref={modalRef}
        className="w-full max-w-md rounded-t-3xl p-6 max-h-[85vh] overflow-auto"
        style={{ backgroundColor: COLORS.surface, WebkitOverflowScrolling: 'touch', pointerEvents: 'auto' }}
      >
        <div className="flex items-center justify-between mb-4">
          <h3 className="text-xl font-bold" style={{ color: COLORS.text }}>Add Meal</h3>
          <button onClick={onClose} className="p-2 rounded-full" style={{ backgroundColor: COLORS.surfaceLight }}>
            <X size={20} color={COLORS.textMuted} />
          </button>
        </div>

        {/* Camera Capture Section */}
        <div className="mb-4">
          <input
            ref={fileInputRef}
            type="file"
            accept="image/*"
            capture="environment"
            onChange={handlePhotoCapture}
            className="hidden"
          />
          <button
            onClick={() => fileInputRef.current?.click()}
            disabled={analyzing}
            className="w-full p-4 rounded-xl flex items-center justify-center gap-2 font-semibold"
            style={{ backgroundColor: COLORS.primary + '20', color: COLORS.primary, border: `2px dashed ${COLORS.primary}` }}
          >
            <Camera size={20} />
            {analyzing ? 'Analyzing...' : 'Take Photo of Food'}
          </button>
        </div>

        {/* Search Section */}
        <div className="mb-4">
          <div className="flex gap-2">
            <input
              type="text"
              value={searchQuery}
              onChange={e => setSearchQuery(e.target.value)}
              onKeyPress={e => e.key === 'Enter' && handleSearch()}
              placeholder="Search for food..."
              autoComplete="off"
              autoCorrect="off"
              autoCapitalize="off"
              spellCheck="false"
              autoFocus
              className="flex-1 p-3 rounded-xl text-sm"
              style={{
                backgroundColor: COLORS.surfaceLight,
                color: COLORS.text,
                border: 'none',
                outline: 'none',
                WebkitAppearance: 'none',
                touchAction: 'manipulation',
                fontSize: '16px'
              }}
            />
            <button
              onClick={handleSearch}
              disabled={searching || !searchQuery.trim()}
              className="px-4 rounded-xl font-semibold"
              style={{ backgroundColor: COLORS.primary, color: COLORS.text }}
            >
              {searching ? 'Searching...' : 'Search'}
            </button>
          </div>

          {/* Serving Size Multiplier */}
          <div className="flex items-center gap-2 mt-2">
            <label className="text-xs" style={{ color: COLORS.textMuted }}>Servings:</label>
            <div className="flex items-center gap-1">
              <button
                onClick={() => setServingMultiplier(Math.max(0.25, servingMultiplier - 0.25))}
                className="w-8 h-8 rounded-lg font-bold"
                style={{ backgroundColor: COLORS.surfaceLight, color: COLORS.text }}
              >
                -
              </button>
              <input
                type="text"
                inputMode="decimal"
                value={servingMultiplier}
                onChange={e => {
                  const val = parseFloat(e.target.value);
                  if (!isNaN(val) && val >= 0) setServingMultiplier(val);
                }}
                className="w-16 p-2 rounded-lg text-sm text-center font-semibold"
                style={{ backgroundColor: COLORS.surfaceLight, color: COLORS.text, border: 'none' }}
              />
              <button
                onClick={() => setServingMultiplier(servingMultiplier + 0.25)}
                className="w-8 h-8 rounded-lg font-bold"
                style={{ backgroundColor: COLORS.surfaceLight, color: COLORS.text }}
              >
                +
              </button>
            </div>
            <span className="text-xs" style={{ color: COLORS.textMuted }}> 100g</span>
          </div>
        </div>

        {/* Search Results */}
        {searchResults.length > 0 && (
          <div className="mb-4 max-h-64 overflow-auto rounded-xl" style={{ backgroundColor: COLORS.surfaceLight }}>
            {searchResults.map((food, idx) => (
              <button
                key={idx}
                onClick={() => handleSelectFood(food)}
                className="w-full p-3 text-left border-b hover:opacity-80"
                style={{ borderColor: COLORS.surface }}
              >
                <div className="flex items-start justify-between mb-1">
                  <div className="font-semibold text-sm" style={{ color: COLORS.text }}>
                    {food.name}
                  </div>
                  {food.isFrequent && (
                    <div className="px-2 py-0.5 rounded text-xs font-semibold" style={{ backgroundColor: COLORS.primary + '30', color: COLORS.primary }}>
                      Your Meal {food.count && `(${food.count})`}
                    </div>
                  )}
                </div>
                {food.brand && (
                  <div className="text-xs mb-1" style={{ color: COLORS.textMuted }}>
                    {food.brand}
                  </div>
                )}
                <div className="text-xs flex gap-3" style={{ color: COLORS.textMuted }}>
                  <span>{Math.round(food.calories * servingMultiplier)} cal</span>
                  <span>P: {Math.round(food.protein * servingMultiplier)}g</span>
                  <span>C: {Math.round(food.carbs * servingMultiplier)}g</span>
                </div>
              </button>
            ))}
          </div>
        )}

        {/* Captured Image Preview */}
        {capturedImage && (
          <div className="mb-4 relative">
            <img src={capturedImage} alt="Captured food" className="w-full rounded-xl" />
            <button
              onClick={() => {
                setCapturedImage(null);
                setRecognitionResult(null);
              }}
              className="absolute top-2 right-2 p-2 rounded-full"
              style={{ backgroundColor: COLORS.background + 'CC' }}
            >
              <X size={16} color={COLORS.text} />
            </button>
          </div>
        )}

        {/* Recognition Result */}
        {recognitionResult && (
          <div className="mb-4 p-3 rounded-xl" style={{ backgroundColor: COLORS.success + '20' }}>
            <p className="text-xs font-semibold mb-1" style={{ color: COLORS.success }}>
              DETECTED: {recognitionResult.name} ({recognitionResult.confidence}% confident)
            </p>
            <p className="text-xs" style={{ color: COLORS.textMuted }}>
              Source: {recognitionResult.source === 'logmeal' ? 'Logmeal AI' : 'Open Food Facts'}
            </p>
          </div>
        )}

        {/* Divider */}
        <div className="flex items-center gap-2 mb-4">
          <div className="flex-1 h-px" style={{ backgroundColor: COLORS.surfaceLight }}></div>
          <span className="text-xs font-semibold" style={{ color: COLORS.textMuted }}>OR ENTER MANUALLY</span>
          <div className="flex-1 h-px" style={{ backgroundColor: COLORS.surfaceLight }}></div>
        </div>

        <div className="space-y-4 mb-6">
          <div>
            <label className="text-sm mb-1 block" style={{ color: COLORS.textMuted }}>Meal Name</label>
            <input
              type="text"
              value={name}
              onChange={e => setName(e.target.value)}
              placeholder="e.g. Chicken & Rice"
              autoComplete="off"
              autoCorrect="off"
              autoCapitalize="off"
              spellCheck="false"
              className="w-full p-3 rounded-xl text-sm"
              style={{
                backgroundColor: COLORS.surfaceLight,
                color: COLORS.text,
                border: 'none',
                outline: 'none',
                WebkitAppearance: 'none',
                touchAction: 'manipulation',
                fontSize: '16px'
              }}
            />
          </div>
          <div className="grid grid-cols-2 gap-3">
            <div>
              <label className="text-sm mb-1 block" style={{ color: COLORS.textMuted }}>Calories</label>
              <input
                type="text"
                inputMode="numeric"
                pattern="[0-9]*"
                value={calories}
                onChange={e => setCalories(e.target.value.replace(/\D/g, ''))}
                placeholder="0"
                autoComplete="off"
                className="w-full p-3 rounded-xl text-sm text-center"
                style={{
                  backgroundColor: COLORS.surfaceLight,
                  color: COLORS.text,
                  border: 'none',
                  outline: 'none',
                  WebkitAppearance: 'none',
                  touchAction: 'manipulation',
                  fontSize: '16px'
                }}
              />
            </div>
            <div>
              <label className="text-sm mb-1 block" style={{ color: COLORS.textMuted }}>Protein (g)</label>
              <input
                type="text"
                inputMode="numeric"
                pattern="[0-9]*"
                value={protein}
                onChange={e => setProtein(e.target.value.replace(/\D/g, ''))}
                placeholder="0"
                autoComplete="off"
                className="w-full p-3 rounded-xl text-sm text-center"
                style={{
                  backgroundColor: COLORS.surfaceLight,
                  color: COLORS.text,
                  border: 'none',
                  outline: 'none',
                  WebkitAppearance: 'none',
                  touchAction: 'manipulation',
                  fontSize: '16px'
                }}
              />
            </div>
          </div>
          <div>
            <label className="text-sm mb-1 block" style={{ color: COLORS.textMuted }}>Carbs (g)</label>
            <input
              type="text"
              inputMode="numeric"
              pattern="[0-9]*"
              value={carbs}
              onChange={e => setCarbs(e.target.value.replace(/\D/g, ''))}
              placeholder="0"
              autoComplete="off"
              className="w-full p-3 rounded-xl text-sm text-center"
              style={{
                backgroundColor: COLORS.surfaceLight,
                color: COLORS.text,
                border: 'none',
                outline: 'none',
                WebkitAppearance: 'none',
                touchAction: 'manipulation',
                fontSize: '16px'
              }}
            />
          </div>
        </div>

        <div className="flex gap-3">
          <button
            onClick={onClose}
            className="flex-1 py-3 rounded-xl font-semibold"
            style={{ backgroundColor: COLORS.surfaceLight, color: COLORS.textMuted }}
          >
            Cancel
          </button>
          <button
            onClick={handleSave}
            className="flex-1 py-3 rounded-xl font-semibold"
            style={{ backgroundColor: COLORS.primary, color: COLORS.text }}
          >
            Add Meal
          </button>
        </div>
      </div>
    </div>
  );
};

// Water Entry Modal - separate component to prevent input focus loss
const WaterEntryModal = ({ COLORS, onClose, onSave }) => {
  const [amount, setAmount] = React.useState('');
  const [saving, setSaving] = React.useState(false);

  // Modal overlay handles scroll blocking via fixed positioning

  const handleSave = async (e) => {
    if (e) {
      e.preventDefault();
      e.stopPropagation();
    }

    const waterAmount = parseInt(amount) || 0;
    if (waterAmount <= 0) return;

    setSaving(true);
    try {
      await onSave(waterAmount);
    } catch (err) {
      console.error('Error saving water:', err);
    } finally {
      setSaving(false);
    }
  };

  return (
    <div
      className="fixed inset-0 z-50 flex items-end justify-center"
      style={{ backgroundColor: 'rgba(0,0,0,0.2)', isolation: 'isolate', pointerEvents: 'none' }}
    >
      <div
        className="w-full max-w-md rounded-t-3xl p-6"
        style={{ backgroundColor: COLORS.surface, WebkitOverflowScrolling: 'touch', pointerEvents: 'auto' }}
      >
        <div className="flex items-center justify-between mb-4">
          <h3 className="text-xl font-bold" style={{ color: COLORS.text }}>Add Water</h3>
          <button onClick={onClose} disabled={saving} className="p-2 rounded-full" style={{ backgroundColor: COLORS.surfaceLight }}>
            <X size={20} color={COLORS.textMuted} />
          </button>
        </div>

        <div className="grid grid-cols-3 gap-2 mb-4">
          {[250, 500, 750, 1000, 1500, 2000].map(amt => (
            <button
              key={amt}
              onClick={() => setAmount(amt.toString())}
              disabled={saving}
              className="py-3 rounded-xl text-sm font-semibold"
              style={{
                backgroundColor: amount === amt.toString() ? COLORS.water : COLORS.surfaceLight,
                color: amount === amt.toString() ? COLORS.text : COLORS.water,
                opacity: saving ? 0.5 : 1
              }}
            >
              {amt >= 1000 ? `${amt/1000}L` : `${amt}ml`}
            </button>
          ))}
        </div>

        <div className="mb-6">
          <label className="text-sm mb-1 block" style={{ color: COLORS.textMuted }}>Custom Amount (ml)</label>
          <input
            type="text"
            inputMode="numeric"
            pattern="[0-9]*"
            value={amount}
            onChange={e => setAmount(e.target.value.replace(/\D/g, ''))}
            disabled={saving}
            placeholder="Enter ml"
            autoComplete="off"
            autoFocus
            className="w-full p-3 rounded-xl text-center text-xl font-bold"
            style={{
              backgroundColor: COLORS.surfaceLight,
              color: COLORS.text,
              border: 'none',
              outline: 'none',
              WebkitAppearance: 'none',
              touchAction: 'manipulation',
              fontSize: '20px',
              opacity: saving ? 0.5 : 1
            }}
          />
        </div>

        <div className="flex gap-3">
          <button
            onClick={onClose}
            disabled={saving}
            className="flex-1 py-3 rounded-xl font-semibold"
            style={{ backgroundColor: COLORS.surfaceLight, color: COLORS.textMuted, opacity: saving ? 0.5 : 1 }}
          >
            Cancel
          </button>
          <button
            onClick={handleSave}
            disabled={saving || !amount}
            className="flex-1 py-3 rounded-xl font-semibold flex items-center justify-center gap-2"
            style={{ backgroundColor: COLORS.water, color: COLORS.text, opacity: (saving || !amount) ? 0.5 : 1 }}
          >
            {saving ? (
              <>
                <div className="w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin"></div>
                Adding...
              </>
            ) : (
              'Add Water'
            )}
          </button>
        </div>
      </div>
    </div>
  );
};

// Missed Day Nutrition Prompt Modal
const MissedDayPromptModal = ({ COLORS, missedDayData, nutritionGoals, onDismiss, onLogMeal, onLogWater, onClose }) => {
  const [entryMode, setEntryMode] = React.useState(null); // null, 'meal', 'water'
  const [mealName, setMealName] = React.useState('');
  const [calories, setCalories] = React.useState('');
  const [protein, setProtein] = React.useState('');
  const [waterAmount, setWaterAmount] = React.useState('');

  const quickMeals = [
    { name: 'Light Day', calories: 1200, protein: 60, desc: 'Under ate / dieting' },
    { name: 'Average Day', calories: 1800, protein: 100, desc: 'Typical daily intake' },
    { name: 'Full Day', calories: 2200, protein: 140, desc: 'Hit my targets' },
  ];

  const quickWater = [1000, 1500, 2000, 2500];

  if (entryMode === 'meal') {
    return (
      <div className="fixed inset-0 z-50 flex items-end justify-center" style={{ backgroundColor: 'rgba(0,0,0,0.2)' }}>
        <div className="w-full max-w-md rounded-t-3xl p-6 max-h-[85vh] overflow-y-auto" style={{ backgroundColor: COLORS.surface }}>
          <div className="flex items-center justify-between mb-4">
            <button onClick={() => setEntryMode(null)} className="p-2 rounded-full" style={{ backgroundColor: COLORS.surfaceLight }}>
              <ChevronLeft size={20} color={COLORS.text} />
            </button>
            <h3 className="text-lg font-bold" style={{ color: COLORS.text }}>Log Meals for {missedDayData.dateLabel}</h3>
            <div className="w-10" />
          </div>

          <p className="text-sm mb-4" style={{ color: COLORS.textMuted }}>
            Quick estimate your total food intake for the day:
          </p>

          <div className="space-y-2 mb-4">
            {quickMeals.map(meal => (
              <button
                key={meal.name}
                onClick={() => {
                  onLogMeal({ name: meal.name, calories: meal.calories, protein: meal.protein, time: '12:00' });
                  setEntryMode(null);
                }}
                className="w-full p-4 rounded-xl text-left flex items-center justify-between"
                style={{ backgroundColor: COLORS.surfaceLight }}
              >
                <div>
                  <p className="font-semibold" style={{ color: COLORS.text }}>{meal.name}</p>
                  <p className="text-xs" style={{ color: COLORS.textMuted }}>{meal.desc}</p>
                </div>
                <div className="text-right">
                  <p className="font-bold" style={{ color: COLORS.accent }}>{meal.calories} cal</p>
                  <p className="text-xs" style={{ color: COLORS.textMuted }}>{meal.protein}g protein</p>
                </div>
              </button>
            ))}
          </div>

          <div className="p-4 rounded-xl mb-4" style={{ backgroundColor: COLORS.surfaceLight }}>
            <p className="text-sm font-semibold mb-3" style={{ color: COLORS.text }}>Or enter custom amount:</p>
            <div className="space-y-3">
              <input
                type="text"
                placeholder="Meal description (optional)"
                value={mealName}
                onChange={(e) => setMealName(e.target.value)}
                className="w-full p-3 rounded-xl text-sm"
                style={{ backgroundColor: COLORS.surface, color: COLORS.text, border: `1px solid ${COLORS.surfaceLight}` }}
              />
              <div className="flex gap-2">
                <input
                  type="number"
                  placeholder="Calories"
                  value={calories}
                  onChange={(e) => setCalories(e.target.value)}
                  className="flex-1 p-3 rounded-xl text-sm"
                  style={{ backgroundColor: COLORS.surface, color: COLORS.text, border: `1px solid ${COLORS.surfaceLight}` }}
                />
                <input
                  type="number"
                  placeholder="Protein (g)"
                  value={protein}
                  onChange={(e) => setProtein(e.target.value)}
                  className="flex-1 p-3 rounded-xl text-sm"
                  style={{ backgroundColor: COLORS.surface, color: COLORS.text, border: `1px solid ${COLORS.surfaceLight}` }}
                />
              </div>
              <button
                onClick={() => {
                  if (calories) {
                    onLogMeal({
                      name: mealName || 'Missed Day Entry',
                      calories: parseInt(calories) || 0,
                      protein: parseInt(protein) || 0,
                      time: '12:00'
                    });
                    setCalories('');
                    setProtein('');
                    setMealName('');
                    setEntryMode(null);
                  }
                }}
                disabled={!calories}
                className="w-full py-3 rounded-xl font-semibold"
                style={{ backgroundColor: calories ? COLORS.accent : COLORS.surfaceLight, color: calories ? COLORS.text : COLORS.textMuted }}
              >
                Add Entry
              </button>
            </div>
          </div>
        </div>
      </div>
    );
  }

  if (entryMode === 'water') {
    return (
      <div className="fixed inset-0 z-50 flex items-end justify-center" style={{ backgroundColor: 'rgba(0,0,0,0.2)' }}>
        <div className="w-full max-w-md rounded-t-3xl p-6" style={{ backgroundColor: COLORS.surface }}>
          <div className="flex items-center justify-between mb-4">
            <button onClick={() => setEntryMode(null)} className="p-2 rounded-full" style={{ backgroundColor: COLORS.surfaceLight }}>
              <ChevronLeft size={20} color={COLORS.text} />
            </button>
            <h3 className="text-lg font-bold" style={{ color: COLORS.text }}>Log Water for {missedDayData.dateLabel}</h3>
            <div className="w-10" />
          </div>

          <p className="text-sm mb-4" style={{ color: COLORS.textMuted }}>
            Estimate your water intake:
          </p>

          <div className="grid grid-cols-2 gap-2 mb-4">
            {quickWater.map(amount => (
              <button
                key={amount}
                onClick={() => {
                  onLogWater(amount);
                  setEntryMode(null);
                }}
                className="p-4 rounded-xl text-center"
                style={{ backgroundColor: COLORS.surfaceLight }}
              >
                <p className="text-2xl font-bold" style={{ color: COLORS.water }}>{amount / 1000}L</p>
                <p className="text-xs" style={{ color: COLORS.textMuted }}>{amount}ml</p>
              </button>
            ))}
          </div>

          <div className="p-4 rounded-xl" style={{ backgroundColor: COLORS.surfaceLight }}>
            <p className="text-sm font-semibold mb-3" style={{ color: COLORS.text }}>Custom amount:</p>
            <div className="flex gap-2">
              <input
                type="number"
                placeholder="ml"
                value={waterAmount}
                onChange={(e) => setWaterAmount(e.target.value)}
                className="flex-1 p-3 rounded-xl text-sm"
                style={{ backgroundColor: COLORS.surface, color: COLORS.text, border: `1px solid ${COLORS.surfaceLight}` }}
              />
              <button
                onClick={() => {
                  if (waterAmount) {
                    onLogWater(parseInt(waterAmount) || 0);
                    setWaterAmount('');
                    setEntryMode(null);
                  }
                }}
                disabled={!waterAmount}
                className="px-6 py-3 rounded-xl font-semibold"
                style={{ backgroundColor: waterAmount ? COLORS.water : COLORS.surfaceLight, color: waterAmount ? COLORS.text : COLORS.textMuted }}
              >
                Add
              </button>
            </div>
          </div>
        </div>
      </div>
    );
  }

  // Main prompt view
  const hasLoggedEnough = missedDayData.calories >= 500 && missedDayData.water >= 500;

  return (
    <div className="fixed inset-0 z-50 flex items-center justify-center p-4" style={{ backgroundColor: 'rgba(0,0,0,0.2)' }}>
      <div className="w-full max-w-md rounded-2xl p-6" style={{ backgroundColor: COLORS.surface }}>
        <div className="flex items-center gap-3 mb-4">
          <div className="w-12 h-12 rounded-full flex items-center justify-center" style={{ backgroundColor: COLORS.warning + '20' }}>
            <AlertCircle size={24} color={COLORS.warning} />
          </div>
          <div>
            <h3 className="text-lg font-bold" style={{ color: COLORS.text }}>Missed a day?</h3>
            <p className="text-sm" style={{ color: COLORS.textMuted }}>{missedDayData.dateLabel}</p>
          </div>
        </div>

        <p className="text-sm mb-4" style={{ color: COLORS.textSecondary }}>
          It looks like you didn't log much yesterday. Would you like to fill in what you ate and drank?
        </p>

        <div className="p-4 rounded-xl mb-4" style={{ backgroundColor: COLORS.surfaceLight }}>
          <div className="flex justify-between items-center mb-2">
            <span className="text-sm" style={{ color: COLORS.textMuted }}>Calories logged:</span>
            <span className="font-bold" style={{ color: missedDayData.calories < 500 ? COLORS.warning : COLORS.accent }}>
              {missedDayData.calories} / {nutritionGoals.calories || 2200}
            </span>
          </div>
          <div className="flex justify-between items-center">
            <span className="text-sm" style={{ color: COLORS.textMuted }}>Water logged:</span>
            <span className="font-bold" style={{ color: missedDayData.water < 500 ? COLORS.warning : COLORS.water }}>
              {missedDayData.water}ml / {nutritionGoals.water || 2500}ml
            </span>
          </div>
        </div>

        <div className="space-y-2 mb-4">
          <button
            onClick={() => setEntryMode('meal')}
            className="w-full p-4 rounded-xl flex items-center gap-3"
            style={{ backgroundColor: COLORS.accent + '20', border: `1px solid ${COLORS.accent}40` }}
          >
            <Utensils size={20} color={COLORS.accent} />
            <span className="font-semibold" style={{ color: COLORS.text }}>Log Food</span>
            <ChevronRight size={18} color={COLORS.textMuted} className="ml-auto" />
          </button>

          <button
            onClick={() => setEntryMode('water')}
            className="w-full p-4 rounded-xl flex items-center gap-3"
            style={{ backgroundColor: COLORS.water + '20', border: `1px solid ${COLORS.water}40` }}
          >
            <Droplets size={20} color={COLORS.water} />
            <span className="font-semibold" style={{ color: COLORS.text }}>Log Water</span>
            <ChevronRight size={18} color={COLORS.textMuted} className="ml-auto" />
          </button>
        </div>

        <div className="flex gap-2">
          <button
            onClick={onDismiss}
            className="flex-1 py-3 rounded-xl font-semibold"
            style={{ backgroundColor: COLORS.surfaceLight, color: COLORS.textMuted }}
          >
            Skip Day
          </button>
          {hasLoggedEnough && (
            <button
              onClick={onClose}
              className="flex-1 py-3 rounded-xl font-semibold"
              style={{ backgroundColor: COLORS.primary, color: COLORS.text }}
            >
              Done
            </button>
          )}
        </div>

        <p className="text-xs text-center mt-3" style={{ color: COLORS.textMuted }}>
          Logging helps us adjust your daily targets more accurately
        </p>
      </div>
    </div>
  );
};

// ============================================
// NEW SLEEK HOME SCREEN COMPONENTS
// ============================================

// Streak Hero Ring - Large animated progress ring showing primary streak
const StreakHeroRing = ({ COLORS, streaks, settings, onTap }) => {
  // Calculate primary streak (workout weeks is the main one)
  const primaryStreak = streaks?.weeklyWorkouts?.weeksCompleted || 0;
  const maxStreak = 52; // 1 year cap for ring visualization
  const progress = Math.min(primaryStreak / maxStreak, 1);

  // Secondary streaks for mini indicators with labels (with safety checks)
  const tracking = settings?.tracking || {};
  const secondaryStreaks = [
    tracking.calories && { icon: '', label: 'Cal', value: streaks?.calories?.daysInRow || 0, color: COLORS.accent },
    tracking.water && { icon: '', label: 'Water', value: streaks?.water?.daysInRow || 0, color: COLORS.water },
    tracking.sleep && { icon: '', label: 'Sleep', value: streaks?.sleep?.daysInRow || 0, color: COLORS.sleep },
  ].filter(Boolean);

  return (
    <button
      onClick={onTap}
      className="w-full flex flex-col items-center py-4"
      style={{ background: `linear-gradient(180deg, ${COLORS.surface}50 0%, transparent 100%)` }}
    >
      {/* Main Ring */}
      <div className="relative w-32 h-32 mb-2">
        <svg className="w-full h-full transform -rotate-90">
          <circle
            cx="64" cy="64" r="56"
            stroke={COLORS.surfaceLight}
            strokeWidth="8"
            fill="none"
          />
          <circle
            cx="64" cy="64" r="56"
            stroke={COLORS.warning}
            strokeWidth="8"
            fill="none"
            strokeLinecap="round"
            strokeDasharray={`${progress * 352} 352`}
            style={{ transition: 'stroke-dasharray 1s ease-out' }}
          />
        </svg>
        <div className="absolute inset-0 flex flex-col items-center justify-center">
          <span className="text-xl"></span>
          <span className="text-2xl font-bold" style={{ color: COLORS.text }}>{primaryStreak}</span>
          <span className="text-xs" style={{ color: COLORS.textMuted }}>weeks</span>
        </div>
      </div>

      {/* Secondary streaks row with labels */}
      {secondaryStreaks.length > 0 && (
        <div className="flex items-center gap-3 mt-1">
          {secondaryStreaks.map((streak, i) => (
            <div key={i} className="flex flex-col items-center px-3 py-2 rounded-xl" style={{ backgroundColor: COLORS.surfaceLight }}>
              <div className="flex items-center gap-1">
                <span className="text-sm">{streak.icon}</span>
                <span className="text-sm font-bold" style={{ color: streak.color }}>{streak.value}</span>
              </div>
              <span className="text-xs mt-0.5" style={{ color: COLORS.textMuted }}>{streak.label}</span>
            </div>
          ))}
        </div>
      )}
    </button>
  );
};

// Quick Stats Row - Compact circular progress indicators
const QuickStatsRow = ({ COLORS, stats, onStatTap }) => {
  return (
    <div className="flex justify-around py-4 px-2">
      {stats.filter(s => s.enabled).map((stat, i) => {
        const progress = Math.min(stat.current / stat.target, 1);
        const displayValue = stat.displayValue || Math.round(progress * 100) + '%';

        return (
          <button
            key={stat.id}
            onClick={() => onStatTap(stat.id)}
            className="flex flex-col items-center"
          >
            <div className="relative w-14 h-14 mb-1">
              <svg className="w-full h-full transform -rotate-90">
                <circle cx="28" cy="28" r="24" stroke={COLORS.surfaceLight} strokeWidth="4" fill="none" />
                <circle
                  cx="28" cy="28" r="24"
                  stroke={stat.color}
                  strokeWidth="4"
                  fill="none"
                  strokeLinecap="round"
                  strokeDasharray={`${progress * 151} 151`}
                />
              </svg>
              <div className="absolute inset-0 flex items-center justify-center">
                <span className="text-xs font-bold" style={{ color: stat.color }}>{displayValue}</span>
              </div>
            </div>
            <span className="text-xs" style={{ color: COLORS.textMuted }}>{stat.label}</span>
          </button>
        );
      })}
    </div>
  );
};

// Today's Action Card - Clean, focused workout/rest card
const TodayActionCard = ({ COLORS, workout, isCompleted, isPaused, onStart, onResume, getWorkoutColor }) => {
  // Safety check for workout
  if (!workout) {
    return (
      <div className="mx-4 p-5 rounded-2xl" style={{ backgroundColor: COLORS.surface }}>
        <p style={{ color: COLORS.textMuted }}>Loading workout...</p>
      </div>
    );
  }

  const isRest = workout.type === 'Rest';
  const isSkipped = workout.type === 'Skipped';

  // Safe color with fallback
  let cardColor = COLORS.primary;
  try {
    cardColor = isRest ? COLORS.sleep : (getWorkoutColor ? getWorkoutColor(workout.type, COLORS) : COLORS.primary);
  } catch (e) {
    cardColor = COLORS.primary;
  }

  if (isPaused) {
    return (
      <div className="mx-4 p-5 rounded-2xl" style={{ backgroundColor: COLORS.surface, borderLeft: `4px solid ${COLORS.warning}` }}>
        <div className="flex items-center gap-4">
          <div className="w-14 h-14 rounded-xl flex items-center justify-center text-2xl" style={{ backgroundColor: COLORS.warning + '20' }}>
            
          </div>
          <div className="flex-1">
            <p className="text-xs font-semibold mb-1" style={{ color: COLORS.warning }}>PAUSED</p>
            <p className="font-semibold" style={{ color: COLORS.text }}>Enjoying your break</p>
          </div>
        </div>
        <button
          onClick={onResume}
          className="w-full mt-4 py-3 rounded-xl font-semibold flex items-center justify-center gap-2"
          style={{ backgroundColor: COLORS.warning, color: COLORS.background }}
        >
          Resume Plan
        </button>
      </div>
    );
  }

  if (isCompleted) {
    return (
      <div className="mx-4 p-5 rounded-2xl" style={{ backgroundColor: COLORS.surface, borderLeft: `4px solid ${COLORS.success}` }}>
        <div className="flex items-center gap-4">
          <div className="w-14 h-14 rounded-xl flex items-center justify-center text-2xl" style={{ backgroundColor: COLORS.success + '20' }}>
            
          </div>
          <div className="flex-1">
            <p className="text-xs font-semibold mb-1" style={{ color: COLORS.success }}>COMPLETED</p>
            <p className="font-semibold" style={{ color: COLORS.text }}>{workout.name}</p>
            <p className="text-sm" style={{ color: COLORS.textMuted }}>Great work today!</p>
          </div>
        </div>
      </div>
    );
  }

  if (isRest) {
    return (
      <div className="mx-4 p-5 rounded-2xl" style={{ backgroundColor: COLORS.surface, borderLeft: `4px solid ${COLORS.sleep}` }}>
        <div className="flex items-center gap-4">
          <div className="w-14 h-14 rounded-xl flex items-center justify-center text-2xl" style={{ backgroundColor: COLORS.sleep + '20' }}>
            
          </div>
          <div className="flex-1">
            <p className="text-xs font-semibold mb-1" style={{ color: COLORS.sleep }}>REST DAY</p>
            <p className="font-semibold" style={{ color: COLORS.text }}>Recovery Time</p>
            <p className="text-sm" style={{ color: COLORS.textMuted }}>Your muscles grow while you rest</p>
          </div>
        </div>
      </div>
    );
  }

  if (isSkipped) {
    return (
      <div className="mx-4 p-5 rounded-2xl" style={{ backgroundColor: COLORS.surface, borderLeft: `4px solid ${COLORS.textMuted}` }}>
        <div className="flex items-center gap-4">
          <div className="w-14 h-14 rounded-xl flex items-center justify-center text-2xl" style={{ backgroundColor: COLORS.surfaceLight }}>
            
          </div>
          <div className="flex-1">
            <p className="text-xs font-semibold mb-1" style={{ color: COLORS.textMuted }}>SKIPPED</p>
            <p className="font-semibold" style={{ color: COLORS.text }}>Workout Skipped</p>
          </div>
        </div>
      </div>
    );
  }

  // Active workout card
  return (
    <div className="mx-4 p-5 rounded-2xl" style={{ backgroundColor: COLORS.surface, borderLeft: `4px solid ${cardColor}` }}>
      <div className="flex items-center gap-4 mb-4">
        <div className="w-14 h-14 rounded-xl flex items-center justify-center" style={{ backgroundColor: cardColor + '20' }}>
          <span className="text-2xl"></span>
        </div>
        <div className="flex-1">
          <p className="text-xs font-semibold mb-1" style={{ color: cardColor }}>TODAY</p>
          <p className="font-bold text-lg" style={{ color: COLORS.text }}>{workout.name}</p>
          <p className="text-sm" style={{ color: COLORS.textMuted }}>{workout.focus}</p>
        </div>
      </div>
      <div className="flex items-center gap-3 mb-4">
        <span className="px-2.5 py-1 rounded-lg text-xs font-medium" style={{ backgroundColor: COLORS.surfaceLight, color: COLORS.textSecondary }}>
          {workout.exercises} exercises
        </span>
        <span className="px-2.5 py-1 rounded-lg text-xs font-medium" style={{ backgroundColor: COLORS.surfaceLight, color: COLORS.textSecondary }}>
          ~{workout.duration} min
        </span>
      </div>
      <button
        onClick={onStart}
        className="w-full py-3.5 rounded-xl font-semibold text-base flex items-center justify-center gap-2"
        style={{ backgroundColor: cardColor, color: COLORS.text }}
      >
        Start Workout
      </button>
    </div>
  );
};

// ============================================
// END NEW SLEEK HOME SCREEN COMPONENTS
// ============================================

// Weigh-In Modal - separate component to prevent input focus loss
const WeighInModal = ({ COLORS, onClose, onSave, initialWeight, currentWeight, userGoal }) => {
  const [weight, setWeight] = React.useState(initialWeight.toString());
  const [date, setDate] = React.useState(getLocalDateString());
  const [bodyFat, setBodyFat] = React.useState('');
  const [muscleMass, setMuscleMass] = React.useState('');
  const [showBodyComp, setShowBodyComp] = React.useState(false);
  
  const weightNum = parseFloat(weight) || 0;
  const isValid = weightNum >= 35 && weightNum <= 250;
  const diff = weightNum - currentWeight;
  
  const bodyFatNum = parseFloat(bodyFat) || 0;
  const muscleMassNum = parseFloat(muscleMass) || 0;
  const bodyFatValid = !bodyFat || (bodyFatNum >= 3 && bodyFatNum <= 60);
  const muscleMassValid = !muscleMass || (muscleMassNum >= 20 && muscleMassNum <= 70);
  
  // Green if: losing weight on lose_fat program, OR gaining weight on build_muscle/strength program
  const isGoodChange = 
    (userGoal === 'lose_fat' && diff < 0) || 
    ((userGoal === 'build_muscle' || userGoal === 'strength') && diff > 0) ||
    (userGoal === 'fitness' && diff === 0);
  const changeColor = diff === 0 ? COLORS.textMuted : isGoodChange ? COLORS.success : COLORS.error;
  
  return (
    <div className="fixed inset-0 z-50 flex items-center justify-center p-4" style={{ backgroundColor: 'rgba(0,0,0,0.2)' }}>
      <div className="w-full max-w-sm rounded-2xl p-6 max-h-[90vh] overflow-auto" style={{ backgroundColor: COLORS.surface }}>
        <div className="flex items-center justify-between mb-6">
          <h3 className="text-xl font-bold" style={{ color: COLORS.text }}>Log Weigh-In</h3>
          <button onClick={onClose} className="p-2 rounded-full" style={{ backgroundColor: COLORS.surfaceLight }}>
            <X size={20} color={COLORS.textMuted} />
          </button>
        </div>
        
        <div className="text-center mb-6">
          <div className="w-20 h-20 rounded-full mx-auto mb-4 flex items-center justify-center" style={{ backgroundColor: COLORS.primary + '20' }}>
            <TrendingUp size={36} color={COLORS.primary} />
          </div>
          <p className="text-sm mb-1" style={{ color: COLORS.textMuted }}>Date</p>
          <input
            type="date"
            value={date}
            onChange={e => setDate(e.target.value)}
            className="font-semibold text-center bg-transparent border-none cursor-pointer"
            style={{ color: COLORS.text, colorScheme: 'dark' }}
          />
        </div>

        <div className="mb-6">
          <label className="text-sm mb-2 block" style={{ color: COLORS.textMuted }}>Your Weight</label>
          <div className="flex items-center gap-3">
            <button 
              onClick={() => setWeight(prev => (Math.max(35, (parseFloat(prev) || 0) - 0.1)).toFixed(1))}
              className="w-12 h-12 rounded-xl flex items-center justify-center"
              style={{ backgroundColor: COLORS.surfaceLight }}
            >
              <Minus size={20} color={COLORS.text} />
            </button>
            <div className="flex-1 relative">
              <input
                type="text"
                inputMode="decimal"
                value={weight}
                onChange={e => setWeight(e.target.value.replace(/[^0-9.]/g, ''))}
                className="w-full text-center text-3xl font-bold py-3 rounded-xl"
                style={{ 
                  backgroundColor: COLORS.surfaceLight, 
                  color: COLORS.text, 
                  border: !isValid && weight !== '' ? `2px solid ${COLORS.error}` : 'none' 
                }}
              />
              <span className="absolute right-4 top-1/2 -translate-y-1/2 text-lg" style={{ color: COLORS.textMuted }}>kg</span>
            </div>
            <button 
              onClick={() => setWeight(prev => (Math.min(250, (parseFloat(prev) || 0) + 0.1)).toFixed(1))}
              className="w-12 h-12 rounded-xl flex items-center justify-center"
              style={{ backgroundColor: COLORS.surfaceLight }}
            >
              <Plus size={20} color={COLORS.text} />
            </button>
          </div>
          {!isValid && weight !== '' && (
            <p className="text-xs mt-2 text-center" style={{ color: COLORS.error }}>
              Please enter a realistic weight (35-250kg)
            </p>
          )}
        </div>

        {/* Body Composition Toggle */}
        <button
          onClick={() => setShowBodyComp(!showBodyComp)}
          className="w-full p-3 rounded-xl mb-4 flex items-center justify-between"
          style={{ backgroundColor: COLORS.surfaceLight }}
        >
          <div className="flex items-center gap-2">
            <BarChart3 size={18} color={COLORS.accent} />
            <span className="text-sm" style={{ color: COLORS.textSecondary }}>Add Body Composition (optional)</span>
          </div>
          {showBodyComp ? <ChevronUp size={18} color={COLORS.textMuted} /> : <ChevronDown size={18} color={COLORS.textMuted} />}
        </button>

        {/* Body Composition Fields */}
        {showBodyComp && (
          <div className="mb-6 p-4 rounded-xl" style={{ backgroundColor: COLORS.surfaceLight }}>
            <div className="grid grid-cols-2 gap-4">
              <div>
                <label className="text-xs mb-1 block" style={{ color: COLORS.textMuted }}>Body Fat %</label>
                <div className="relative">
                  <input
                    type="text"
                    inputMode="decimal"
                    value={bodyFat}
                    onChange={e => setBodyFat(e.target.value.replace(/[^0-9.]/g, ''))}
                    placeholder="e.g. 15"
                    className="w-full text-center text-xl font-bold py-2 rounded-xl"
                    style={{ 
                      backgroundColor: COLORS.surface, 
                      color: COLORS.text, 
                      border: !bodyFatValid ? `2px solid ${COLORS.error}` : 'none' 
                    }}
                  />
                  <span className="absolute right-3 top-1/2 -translate-y-1/2 text-sm" style={{ color: COLORS.textMuted }}>%</span>
                </div>
                {!bodyFatValid && (
                  <p className="text-xs mt-1 text-center" style={{ color: COLORS.error }}>3-60%</p>
                )}
              </div>
              <div>
                <label className="text-xs mb-1 block" style={{ color: COLORS.textMuted }}>Muscle Mass %</label>
                <div className="relative">
                  <input
                    type="text"
                    inputMode="decimal"
                    value={muscleMass}
                    onChange={e => setMuscleMass(e.target.value.replace(/[^0-9.]/g, ''))}
                    placeholder="e.g. 40"
                    className="w-full text-center text-xl font-bold py-2 rounded-xl"
                    style={{ 
                      backgroundColor: COLORS.surface, 
                      color: COLORS.text, 
                      border: !muscleMassValid ? `2px solid ${COLORS.error}` : 'none' 
                    }}
                  />
                  <span className="absolute right-3 top-1/2 -translate-y-1/2 text-sm" style={{ color: COLORS.textMuted }}>%</span>
                </div>
                {!muscleMassValid && (
                  <p className="text-xs mt-1 text-center" style={{ color: COLORS.error }}>20-70%</p>
                )}
              </div>
            </div>
            <p className="text-xs text-center mt-3" style={{ color: COLORS.textMuted }}>
              Measure with a smart scale or body composition analyzer
            </p>
          </div>
        )}

        <div className="p-4 rounded-xl mb-6" style={{ backgroundColor: COLORS.surfaceLight }}>
          <div className="flex justify-between items-center mb-2">
            <span className="text-sm" style={{ color: COLORS.textMuted }}>Last weigh-in</span>
            <span className="font-semibold" style={{ color: COLORS.text }}>{currentWeight}kg</span>
          </div>
          <div className="flex justify-between items-center">
            <span className="text-sm" style={{ color: COLORS.textMuted }}>Change</span>
            <span className="font-semibold" style={{ color: changeColor }}>
              {diff > 0 ? '+' : ''}{diff.toFixed(1)}kg
            </span>
          </div>
        </div>

        <div className="flex gap-3">
          <button 
            onClick={onClose}
            className="flex-1 py-3 rounded-xl font-semibold"
            style={{ backgroundColor: COLORS.surfaceLight, color: COLORS.textMuted }}
          >
            Cancel
          </button>
          <button 
            onClick={() => isValid && bodyFatValid && muscleMassValid && onSave({
              weight: weightNum,
              date,
              bodyFat: bodyFat ? parseFloat(bodyFat) : null,
              muscleMass: muscleMass ? parseFloat(muscleMass) : null
            })}
            disabled={!isValid || !bodyFatValid || !muscleMassValid}
            className="flex-1 py-3 rounded-xl font-semibold"
            style={{ 
              backgroundColor: COLORS.primary, 
              color: COLORS.text,
              opacity: (isValid && bodyFatValid && muscleMassValid) ? 1 : 0.5
            }}
          >
            Save
          </button>
        </div>
      </div>
    </div>
  );
};

// Full Meal Entry Modal - with all macros and estimator
const FullMealEntryModal = ({ COLORS, onClose, onSave, foods = [], frequentMeals = [] }) => {
  const [name, setName] = React.useState('');
  const [calories, setCalories] = React.useState('');
  const [protein, setProtein] = React.useState('');
  const [carbs, setCarbs] = React.useState('');
  const [fats, setFats] = React.useState('');
  const [time, setTime] = React.useState(() => {
    const now = new Date();
    return `${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}`;
  });
  const [showEstimator, setShowEstimator] = React.useState(false);
  const [ingredients, setIngredients] = React.useState([]);
  const [showAddIngredient, setShowAddIngredient] = React.useState(false);
  const [tempIngredientAmount, setTempIngredientAmount] = React.useState({});
  const [tempIngredientUnit, setTempIngredientUnit] = React.useState({});
  const [ingredientSearch, setIngredientSearch] = React.useState('');
  const [ingredientFilter, setIngredientFilter] = React.useState('All');
  const [selectedProteins, setSelectedProteins] = React.useState([]);
  const [selectedCarbs, setSelectedCarbs] = React.useState([]);
  const [selectedFats, setSelectedFats] = React.useState([]);
  const [selectedVegetables, setSelectedVegetables] = React.useState([]);
  const [selectedToppings, setSelectedToppings] = React.useState([]);
  const [itemAmounts, setItemAmounts] = React.useState({});
  const [portionSize, setPortionSize] = React.useState('medium');
  
  // Portion multipliers
  const portionMultipliers = { small: 0.7, medium: 1, large: 1.4, xl: 1.8 };

  // Fallback food data if database foods are empty
  const defaultProteinSources = [
    { name: 'Chicken Breast', per100g: { cal: 165, p: 31, c: 0, f: 3.6 } },
    { name: 'Beef Steak', per100g: { cal: 271, p: 26, c: 0, f: 18 } },
    { name: 'Salmon', per100g: { cal: 208, p: 20, c: 0, f: 13 } },
    { name: 'Eggs', per100g: { cal: 155, p: 13, c: 1, f: 11 } },
    { name: 'Turkey', per100g: { cal: 135, p: 30, c: 0, f: 1 } },
    { name: 'Tofu', per100g: { cal: 76, p: 8, c: 2, f: 4.8 } },
    { name: 'Shrimp', per100g: { cal: 99, p: 24, c: 0, f: 0.3 } },
    { name: 'Greek Yogurt', per100g: { cal: 97, p: 9, c: 4, f: 5 } },
  ];
  const defaultCarbSources = [
    { name: 'White Rice', per100g: { cal: 130, p: 2.7, c: 28, f: 0.3 } },
    { name: 'Brown Rice', per100g: { cal: 111, p: 2.6, c: 23, f: 0.9 } },
    { name: 'Pasta', per100g: { cal: 131, p: 5, c: 25, f: 1.1 } },
    { name: 'Bread', per100g: { cal: 265, p: 9, c: 49, f: 3.2 } },
    { name: 'Potato', per100g: { cal: 77, p: 2, c: 17, f: 0.1 } },
    { name: 'Sweet Potato', per100g: { cal: 86, p: 1.6, c: 20, f: 0.1 } },
    { name: 'Oats', per100g: { cal: 389, p: 17, c: 66, f: 7 } },
    { name: 'Quinoa', per100g: { cal: 120, p: 4.4, c: 21, f: 1.9 } },
  ];
  const defaultFatSources = [
    { name: 'Olive Oil', per100g: { cal: 884, p: 0, c: 0, f: 100 } },
    { name: 'Avocado', per100g: { cal: 160, p: 2, c: 9, f: 15 } },
    { name: 'Peanut Butter', per100g: { cal: 588, p: 25, c: 20, f: 50 } },
    { name: 'Almonds', per100g: { cal: 579, p: 21, c: 22, f: 50 } },
    { name: 'Cheese', per100g: { cal: 402, p: 25, c: 1.3, f: 33 } },
    { name: 'Butter', per100g: { cal: 717, p: 0.9, c: 0.1, f: 81 } },
  ];
  const defaultVegetableSources = [
    { name: 'Broccoli', per100g: { cal: 34, p: 2.8, c: 7, f: 0.4 } },
    { name: 'Spinach', per100g: { cal: 23, p: 2.9, c: 3.6, f: 0.4 } },
    { name: 'Mixed Salad', per100g: { cal: 20, p: 1.5, c: 3.5, f: 0.2 } },
    { name: 'Carrots', per100g: { cal: 41, p: 0.9, c: 10, f: 0.2 } },
    { name: 'Bell Peppers', per100g: { cal: 31, p: 1, c: 6, f: 0.3 } },
    { name: 'Tomatoes', per100g: { cal: 18, p: 0.9, c: 3.9, f: 0.2 } },
  ];
  const defaultToppingSources = [
    { name: 'BBQ Sauce', per100g: { cal: 172, p: 0.8, c: 40, f: 0.6 } },
    { name: 'Mayo', per100g: { cal: 680, p: 1, c: 0.6, f: 75 } },
    { name: 'Hummus', per100g: { cal: 166, p: 8, c: 14, f: 10 } },
    { name: 'Soy Sauce', per100g: { cal: 53, p: 8, c: 5, f: 0 } },
    { name: 'Hot Sauce', per100g: { cal: 12, p: 0.5, c: 2, f: 0.3 } },
  ];

  // Food database from props - filter by category (loaded from database) with fallbacks
  const proteinSources = foods.filter(f => f.category === 'Protein').length > 0
    ? foods.filter(f => f.category === 'Protein')
    : defaultProteinSources;

  const carbSources = foods.filter(f => f.category === 'Carbs').length > 0
    ? foods.filter(f => f.category === 'Carbs')
    : defaultCarbSources;

  const fatSources = foods.filter(f => f.category === 'Fats').length > 0
    ? foods.filter(f => f.category === 'Fats')
    : defaultFatSources;

  const vegetableSources = foods.filter(f => f.category === 'Vegetables').length > 0
    ? foods.filter(f => f.category === 'Vegetables')
    : defaultVegetableSources;

  const toppingSources = foods.filter(f => f.category === 'Sauces').length > 0
    ? foods.filter(f => f.category === 'Sauces')
    : defaultToppingSources;


  // All foods combined with default units
  const allFoods = [
    ...proteinSources.map(f => ({
      ...f,
      category: 'Protein',
      defaultUnit: f.name.includes('Eggs') ? 'units' : 'g',
      defaultAmount: f.name === 'Eggs' ? 2 : f.name === 'Egg Whites' ? 4 : 100
    })),
    ...carbSources.map(f => ({ ...f, category: 'Carbs', defaultUnit: 'g', defaultAmount: 100 })),
    ...fatSources.map(f => {
      const useTbsp = ['Olive Oil', 'Coconut Oil', 'Peanut Butter', 'Almond Butter'].includes(f.name);
      return {
        ...f,
        category: 'Fats',
        defaultUnit: useTbsp ? 'tbsp' : 'g',
        defaultAmount: useTbsp ? 1 : 15
      };
    }),
    ...vegetableSources.map(f => ({ ...f, category: 'Vegetables', defaultUnit: 'g', defaultAmount: 100 })),
    ...toppingSources.map(f => {
      const useTbsp = ['BBQ Sauce', 'Hummus', 'Guacamole', 'Tzatziki', 'Mayo', 'Pesto', 'Tahini', 'Gravy'].includes(f.name);
      return {
        ...f,
        category: 'Sauces',
        defaultUnit: useTbsp ? 'tbsp' : 'g',
        defaultAmount: useTbsp ? 1 : 15
      };
    }),
  ].filter(f => f.name !== 'None' && f.name !== 'None/Minimal');

  // Calculate totals from ingredients
  const calculateFromIngredients = () => {
    let totalCal = 0, totalP = 0, totalC = 0, totalF = 0;

    ingredients.forEach(ing => {
      const multiplier = ing.unit === 'g' ? ing.amount / 100 : ing.amount;
      totalCal += ing.food.per100g.cal * multiplier;
      totalP += ing.food.per100g.p * multiplier;
      totalC += ing.food.per100g.c * multiplier;
      totalF += ing.food.per100g.f * multiplier;
    });

    return {
      cal: Math.round(totalCal),
      p: Math.round(totalP),
      c: Math.round(totalC),
      f: Math.round(totalF)
    };
  };

  const commonMeals = [
    { name: 'Chicken & Rice Bowl', cal: 450, p: 35, c: 45, f: 10 },
    { name: 'Burger & Fries', cal: 850, p: 30, c: 70, f: 45 },
    { name: 'Salad with Chicken', cal: 350, p: 30, c: 15, f: 18 },
    { name: 'Pasta with Meat Sauce', cal: 550, p: 25, c: 65, f: 18 },
    { name: 'Sandwich', cal: 400, p: 20, c: 40, f: 16 },
    { name: 'Pizza (2 slices)', cal: 550, p: 22, c: 60, f: 24 },
    { name: 'Sushi Roll (8pc)', cal: 350, p: 15, c: 50, f: 8 },
    { name: 'Stir Fry', cal: 400, p: 28, c: 35, f: 15 },
    { name: 'Omelette (3 egg)', cal: 300, p: 21, c: 3, f: 22 },
    { name: 'Smoothie Bowl', cal: 350, p: 15, c: 55, f: 8 },
    { name: 'Beef Burrito', cal: 680, p: 32, c: 65, f: 28 },
    { name: 'Poke Bowl', cal: 520, p: 35, c: 55, f: 15 },
    { name: 'Caesar Salad', cal: 380, p: 18, c: 20, f: 25 },
    { name: 'Ramen', cal: 550, p: 22, c: 70, f: 18 },
    { name: 'Fish & Chips', cal: 750, p: 28, c: 65, f: 40 },
    { name: 'Pad Thai', cal: 480, p: 20, c: 55, f: 18 },
    { name: 'Butter Chicken & Rice', cal: 620, p: 32, c: 50, f: 32 },
    { name: 'Greek Salad with Chicken', cal: 420, p: 35, c: 12, f: 26 },
    { name: 'Acai Bowl', cal: 420, p: 8, c: 75, f: 12 },
    { name: 'Meat Pie', cal: 480, p: 18, c: 35, f: 28 },
  ];
  
  // Calculate estimated macros from multi-select
  const calculateEstimate = () => {
    const mult = portionMultipliers[portionSize];
    let totalCal = 0, totalP = 0, totalC = 0, totalF = 0;

    // Process proteins
    selectedProteins.forEach(name => {
      const p = proteinSources.find(s => s.name === name);
      if (p) {
        const amount = itemAmounts[name] || 1;
        totalCal += p.per100g.cal * mult * amount;
        totalP += p.per100g.p * mult * amount;
        totalC += p.per100g.c * mult * amount;
        totalF += p.per100g.f * mult * amount;
      }
    });

    // Process carbs
    selectedCarbs.forEach(name => {
      const c = carbSources.find(s => s.name === name);
      if (c) {
        const amount = itemAmounts[name] || 1;
        totalCal += c.per100g.cal * mult * amount;
        totalP += c.per100g.p * mult * amount;
        totalC += c.per100g.c * mult * amount;
        totalF += c.per100g.f * mult * amount;
      }
    });

    // Process fats
    selectedFats.forEach(name => {
      const f = fatSources.find(s => s.name === name);
      if (f) {
        const amount = itemAmounts[name] || 1;
        totalCal += f.per100g.cal * amount;
        totalP += f.per100g.p * amount;
        totalC += f.per100g.c * amount;
        totalF += f.per100g.f * amount;
      }
    });

    // Process vegetables
    selectedVegetables.forEach(name => {
      const v = vegetableSources.find(s => s.name === name);
      if (v) {
        const amount = itemAmounts[name] || 1;
        totalCal += v.per100g.cal * mult * amount;
        totalP += v.per100g.p * mult * amount;
        totalC += v.per100g.c * mult * amount;
        totalF += v.per100g.f * mult * amount;
      }
    });

    // Process toppings
    selectedToppings.forEach(name => {
      const t = toppingSources.find(s => s.name === name);
      if (t) {
        const amount = itemAmounts[name] || 1;
        totalCal += t.per100g.cal * amount;
        totalP += t.per100g.p * amount;
        totalC += t.per100g.c * amount;
        totalF += t.per100g.f * amount;
      }
    });

    return {
      cal: Math.round(totalCal),
      p: Math.round(totalP),
      c: Math.round(totalC),
      f: Math.round(totalF)
    };
  };
  
  const generateMealName = () => {
    if (ingredients.length === 0) return 'Custom Meal';
    if (ingredients.length === 1) return ingredients[0].food.name;

    // Smart name generation
    const proteins = ingredients.filter(i => i.food.category === 'Protein');
    const carbs = ingredients.filter(i => i.food.category === 'Carbs');

    if (proteins.length > 0 && carbs.length > 0) {
      return `${proteins[0].food.name} & ${carbs[0].food.name}${ingredients.length > 2 ? ' Bowl' : ''}`;
    }

    const parts = ingredients.slice(0, 3).map(i => i.food.name);
    return parts.join(' + ');
  };

  const applyEstimate = () => {
    // Use ingredients if available, otherwise use old method
    const est = ingredients.length > 0 ? calculateFromIngredients() : calculateEstimate();

    let mealName = '';
    if (ingredients.length > 0) {
      mealName = generateMealName();
    } else {
      const parts = [];
      selectedProteins.forEach(p => parts.push(p));
      selectedCarbs.forEach(c => parts.push(c));
      selectedVegetables.forEach(v => { if (v !== 'None') parts.push(v); });
      selectedFats.forEach(f => { if (f !== 'None/Minimal') parts.push(f); });
      selectedToppings.forEach(t => { if (t !== 'None') parts.push('w/ ' + t); });
      mealName = parts.join(' + ');
    }

    setName(mealName || 'Custom Meal');
    setCalories(est.cal.toString());
    setProtein(est.p.toString());
    setCarbs(est.c.toString());
    setFats(est.f.toString());
    setShowEstimator(false);
    setShowAddIngredient(false);
  };
  
  const applyCommonMeal = (meal) => {
    const mult = portionMultipliers[portionSize];
    setName(meal.name);
    setCalories(Math.round(meal.cal * mult).toString());
    setProtein(Math.round(meal.p * mult).toString());
    setCarbs(Math.round(meal.c * mult).toString());
    setFats(Math.round(meal.f * mult).toString());
    setShowEstimator(false);
  };
  
  const estimate = calculateEstimate();
  
  return (
    <div className="fixed inset-0 z-50 flex items-center justify-center p-4" style={{ backgroundColor: 'rgba(0,0,0,0.2)' }}>
      <div className="w-full max-w-sm rounded-2xl p-6 max-h-[90vh] overflow-auto" style={{ backgroundColor: COLORS.surface }}>
        <div className="flex items-center justify-between mb-4">
          <h3 className="text-xl font-bold" style={{ color: COLORS.text }}>Add Meal</h3>
          <button onClick={onClose} className="p-2 rounded-full" style={{ backgroundColor: COLORS.surfaceLight }}>
            <X size={20} color={COLORS.textMuted} />
          </button>
        </div>
        
        {!showEstimator ? (
          <>
            {/* Don't know macros button */}
            <button
              onClick={() => setShowEstimator(true)}
              className="w-full p-3 rounded-xl mb-4 flex items-center justify-center gap-2"
              style={{ backgroundColor: COLORS.accent + '20', border: `1px solid ${COLORS.accent}` }}
            >
              <Info size={16} color={COLORS.accent} />
              <span className="text-sm font-semibold" style={{ color: COLORS.accent }}>Don't know macros? Use estimator</span>
            </button>
            
            <div className="space-y-3 mb-6">
              <div>
                <label className="text-xs mb-1 block" style={{ color: COLORS.textMuted }}>Meal Name</label>
                <input
                  type="text"
                  value={name}
                  onChange={e => setName(e.target.value)}
                  placeholder="e.g. Chicken & Rice"
                  className="w-full p-3 rounded-xl text-sm"
                  style={{ backgroundColor: COLORS.surfaceLight, color: COLORS.text, border: 'none' }}
                />
              </div>
              
              <div>
                <label className="text-xs mb-1 block" style={{ color: COLORS.textMuted }}>Time</label>
                <input
                  type="time"
                  value={time}
                  onChange={e => setTime(e.target.value)}
                  className="w-full p-3 rounded-xl text-sm"
                  style={{ backgroundColor: COLORS.surfaceLight, color: COLORS.text, border: 'none', colorScheme: 'dark' }}
                />
              </div>
              
              <div>
                <label className="text-xs mb-1 block" style={{ color: COLORS.textMuted }}>Calories</label>
                <input
                  type="text"
                  inputMode="numeric"
                  value={calories}
                  onChange={e => setCalories(e.target.value.replace(/\D/g, ''))}
                  placeholder="0"
                  className="w-full p-3 rounded-xl text-sm"
                  style={{ backgroundColor: COLORS.surfaceLight, color: COLORS.text, border: 'none' }}
                />
              </div>
              
              <div className="grid grid-cols-3 gap-2">
                <div>
                  <label className="text-xs mb-1 block" style={{ color: COLORS.textMuted }}>Protein (g)</label>
                  <input
                    type="text"
                    inputMode="numeric"
                    value={protein}
                    onChange={e => setProtein(e.target.value.replace(/\D/g, ''))}
                    placeholder="0"
                    className="w-full p-3 rounded-xl text-sm text-center"
                    style={{ backgroundColor: COLORS.surfaceLight, color: COLORS.text, border: 'none' }}
                  />
                </div>
                <div>
                  <label className="text-xs mb-1 block" style={{ color: COLORS.textMuted }}>Carbs (g)</label>
                  <input
                    type="text"
                    inputMode="numeric"
                    value={carbs}
                    onChange={e => setCarbs(e.target.value.replace(/\D/g, ''))}
                    placeholder="0"
                    className="w-full p-3 rounded-xl text-sm text-center"
                    style={{ backgroundColor: COLORS.surfaceLight, color: COLORS.text, border: 'none' }}
                  />
                </div>
                <div>
                  <label className="text-xs mb-1 block" style={{ color: COLORS.textMuted }}>Fats (g)</label>
                  <input
                    type="text"
                    inputMode="numeric"
                    value={fats}
                    onChange={e => setFats(e.target.value.replace(/\D/g, ''))}
                    placeholder="0"
                    className="w-full p-3 rounded-xl text-sm text-center"
                    style={{ backgroundColor: COLORS.surfaceLight, color: COLORS.text, border: 'none' }}
                  />
                </div>
              </div>
            </div>

            <div className="flex gap-3">
              <button 
                onClick={onClose}
                className="flex-1 py-3 rounded-xl font-semibold"
                style={{ backgroundColor: COLORS.surfaceLight, color: COLORS.textMuted }}
              >
                Cancel
              </button>
              <button 
                onClick={() => onSave({
                  id: Date.now(),
                  name: name || 'Meal',
                  time,
                  calories: parseInt(calories) || 0,
                  protein: parseInt(protein) || 0,
                  carbs: parseInt(carbs) || 0,
                  fats: parseInt(fats) || 0
                })}
                className="flex-1 py-3 rounded-xl font-semibold"
                style={{ backgroundColor: COLORS.primary, color: COLORS.text }}
              >
                Add Meal
              </button>
            </div>
          </>
        ) : (
          <>
            {/* Macro Estimator */}
            <button
              onClick={() => setShowEstimator(false)}
              className="flex items-center gap-2 mb-4"
              style={{ color: COLORS.textMuted }}
            >
              <ChevronLeft size={18} />
              <span className="text-sm">Back to manual entry</span>
            </button>

            {/* Ingredient Builder Button */}
            <button
              onClick={() => setShowAddIngredient(true)}
              className="w-full p-3 rounded-xl mb-4 flex items-center justify-center gap-2"
              style={{ backgroundColor: COLORS.primary + '20', border: `2px solid ${COLORS.primary}` }}
            >
              <Plus size={16} color={COLORS.primary} />
              <span className="text-sm font-semibold" style={{ color: COLORS.primary }}>Build with Ingredients ({ingredients.length})</span>
            </button>

            {/* Show added ingredients */}
            {ingredients.length > 0 && (
              <div className="mb-4 p-3 rounded-xl" style={{ backgroundColor: COLORS.surface }}>
                <p className="text-xs font-semibold mb-2" style={{ color: COLORS.textMuted }}>YOUR INGREDIENTS</p>
                <div className="space-y-2">
                  {ingredients.map((ing, idx) => (
                    <div key={idx} className="flex items-center justify-between p-2 rounded-lg" style={{ backgroundColor: COLORS.surfaceLight }}>
                      <div className="flex-1">
                        <p className="text-xs font-semibold" style={{ color: COLORS.text }}>{ing.food.name}</p>
                        <p className="text-xs" style={{ color: COLORS.textMuted }}>{ing.amount}{ing.unit}</p>
                      </div>
                      <button
                        onClick={() => setIngredients(prev => prev.filter((_, i) => i !== idx))}
                        className="p-1"
                      >
                        <X size={14} color={COLORS.error} />
                      </button>
                    </div>
                  ))}
                </div>
                {ingredients.length > 0 && (() => {
                  const totals = calculateFromIngredients();
                  return (
                    <div className="mt-2 p-2 rounded-lg" style={{ backgroundColor: COLORS.primary + '20' }}>
                      <p className="text-xs font-semibold" style={{ color: COLORS.primary }}>
                        Total: {totals.cal} cal | P:{totals.p}g | C:{totals.c}g | F:{totals.f}g
                      </p>
                    </div>
                  );
                })()}
              </div>
            )}

            {/* Portion Size */}
            <div className="mb-4">
              <p className="text-xs font-semibold mb-2" style={{ color: COLORS.textMuted }}>PORTION SIZE</p>
              <div className="grid grid-cols-4 gap-2">
                {[
                  { id: 'small', label: 'Small', emoji: '' },
                  { id: 'medium', label: 'Medium', emoji: '' },
                  { id: 'large', label: 'Large', emoji: '' },
                  { id: 'xl', label: 'XL', emoji: '' },
                ].map(size => (
                  <button
                    key={size.id}
                    onClick={() => setPortionSize(size.id)}
                    className="p-2 rounded-xl text-center"
                    style={{ 
                      backgroundColor: portionSize === size.id ? COLORS.primary : COLORS.surfaceLight,
                      color: portionSize === size.id ? COLORS.text : COLORS.textMuted
                    }}
                  >
                    <span className="text-lg">{size.emoji}</span>
                    <p className="text-xs mt-1">{size.label}</p>
                  </button>
                ))}
              </div>
            </div>
            
            {/* Your Frequent Meals */}
            {frequentMeals.length > 0 && (
              <div className="mb-4">
                <p className="text-xs font-semibold mb-2" style={{ color: COLORS.textMuted }}>YOUR FREQUENT MEALS</p>
                <div className="flex flex-wrap gap-2">
                  {frequentMeals.map((meal, i) => (
                    <button
                      key={i}
                      onClick={() => applyCommonMeal(meal)}
                      className="px-3 py-2 rounded-xl text-xs flex items-center gap-1"
                      style={{ backgroundColor: COLORS.primary + '20', color: COLORS.primary }}
                    >
                      {meal.name}
                      <span className="text-xs opacity-70">{meal.count}</span>
                    </button>
                  ))}
                </div>
              </div>
            )}

            {/* Common Meals */}
            <div className="mb-4">
              <p className="text-xs font-semibold mb-2" style={{ color: COLORS.textMuted }}>COMMON MEALS</p>
              <div className="flex flex-wrap gap-2">
                {commonMeals.map((meal, i) => (
                  <button
                    key={i}
                    onClick={() => applyCommonMeal(meal)}
                    className="px-3 py-2 rounded-xl text-xs"
                    style={{ backgroundColor: COLORS.surfaceLight, color: COLORS.textSecondary }}
                  >
                    {meal.name}
                  </button>
                ))}
              </div>
            </div>
            
            <div className="border-t border-b py-3 my-3" style={{ borderColor: COLORS.surfaceLight }}>
              <p className="text-xs text-center" style={{ color: COLORS.textMuted }}>OR build your own meal</p>
            </div>
            
            {/* Protein Source */}
            <div className="mb-3">
              <p className="text-xs font-semibold mb-2" style={{ color: COLORS.primary }}> PROTEIN SOURCE (Multi-select)</p>
              <div className="space-y-2">
                {proteinSources.map((source, i) => {
                  const isSelected = selectedProteins.includes(source.name);
                  return (
                    <div key={i} className="flex items-center gap-2">
                      <button
                        onClick={() => {
                          if (isSelected) {
                            setSelectedProteins(prev => prev.filter(p => p !== source.name));
                            setItemAmounts(prev => {
                              const newAmounts = { ...prev };
                              delete newAmounts[source.name];
                              return newAmounts;
                            });
                          } else {
                            setSelectedProteins(prev => [...prev, source.name]);
                          }
                        }}
                        className="flex-1 px-3 py-2 rounded-lg text-xs font-semibold text-left"
                        style={{
                          backgroundColor: isSelected ? COLORS.primary : COLORS.surfaceLight,
                          color: isSelected ? COLORS.text : COLORS.textSecondary
                        }}
                      >
                        {source.name}
                      </button>
                      {isSelected && (
                        <input
                          type="number"
                          value={itemAmounts[source.name] || 1}
                          onChange={(e) => setItemAmounts(prev => ({ ...prev, [source.name]: parseFloat(e.target.value) || 1 }))}
                          className="w-16 p-2 rounded-lg text-xs text-center"
                          style={{ backgroundColor: COLORS.surface, color: COLORS.text, border: 'none' }}
                          placeholder="1x"
                          step="0.5"
                          min="0.5"
                        />
                      )}
                    </div>
                  );
                })}
              </div>
            </div>
            
            {/* Carb Source */}
            <div className="mb-3">
              <p className="text-xs font-semibold mb-2" style={{ color: COLORS.warning }}> CARB SOURCE (Multi-select)</p>
              <div className="space-y-2">
                {carbSources.map((source, i) => {
                  const isSelected = selectedCarbs.includes(source.name);
                  return (
                    <div key={i} className="flex items-center gap-2">
                      <button
                        onClick={() => {
                          if (isSelected) {
                            setSelectedCarbs(prev => prev.filter(c => c !== source.name));
                            setItemAmounts(prev => {
                              const newAmounts = { ...prev };
                              delete newAmounts[source.name];
                              return newAmounts;
                            });
                          } else {
                            setSelectedCarbs(prev => [...prev, source.name]);
                          }
                        }}
                        className="flex-1 px-3 py-2 rounded-lg text-xs font-semibold text-left"
                        style={{
                          backgroundColor: isSelected ? COLORS.warning : COLORS.surfaceLight,
                          color: isSelected ? COLORS.background : COLORS.textSecondary
                        }}
                      >
                        {source.name}
                      </button>
                      {isSelected && (
                        <input
                          type="number"
                          value={itemAmounts[source.name] || 1}
                          onChange={(e) => setItemAmounts(prev => ({ ...prev, [source.name]: parseFloat(e.target.value) || 1 }))}
                          className="w-16 p-2 rounded-lg text-xs text-center"
                          style={{ backgroundColor: COLORS.surface, color: COLORS.text, border: 'none' }}
                          placeholder="1x"
                          step="0.5"
                          min="0.5"
                        />
                      )}
                    </div>
                  );
                })}
              </div>
            </div>

            {/* Fat Source */}
            <div className="mb-3">
              <p className="text-xs font-semibold mb-2" style={{ color: COLORS.sleep }}> FAT SOURCE (Multi-select)</p>
              <div className="space-y-2">
                {fatSources.map((source, i) => {
                  const isSelected = selectedFats.includes(source.name);
                  return (
                    <div key={i} className="flex items-center gap-2">
                      <button
                        onClick={() => {
                          if (isSelected) {
                            setSelectedFats(prev => prev.filter(f => f !== source.name));
                            setItemAmounts(prev => {
                              const newAmounts = { ...prev };
                              delete newAmounts[source.name];
                              return newAmounts;
                            });
                          } else {
                            setSelectedFats(prev => [...prev, source.name]);
                          }
                        }}
                        className="flex-1 px-3 py-2 rounded-lg text-xs font-semibold text-left"
                        style={{
                          backgroundColor: isSelected ? COLORS.sleep : COLORS.surfaceLight,
                          color: isSelected ? COLORS.text : COLORS.textSecondary
                        }}
                      >
                        {source.name}
                      </button>
                      {isSelected && (
                        <input
                          type="number"
                          value={itemAmounts[source.name] || 1}
                          onChange={(e) => setItemAmounts(prev => ({ ...prev, [source.name]: parseFloat(e.target.value) || 1 }))}
                          className="w-16 p-2 rounded-lg text-xs text-center"
                          style={{ backgroundColor: COLORS.surface, color: COLORS.text, border: 'none' }}
                          placeholder="1x"
                          step="0.5"
                          min="0.5"
                        />
                      )}
                    </div>
                  );
                })}
              </div>
            </div>

            {/* Vegetables */}
            <div className="mb-3">
              <p className="text-xs font-semibold mb-2" style={{ color: COLORS.protein }}> VEGETABLES (Multi-select)</p>
              <div className="space-y-2">
                {vegetableSources.filter(s => s.name !== 'None').map((source, i) => {
                  const isSelected = selectedVegetables.includes(source.name);
                  return (
                    <div key={i} className="flex items-center gap-2">
                      <button
                        onClick={() => {
                          if (isSelected) {
                            setSelectedVegetables(prev => prev.filter(v => v !== source.name));
                            setItemAmounts(prev => {
                              const newAmounts = { ...prev };
                              delete newAmounts[source.name];
                              return newAmounts;
                            });
                          } else {
                            setSelectedVegetables(prev => [...prev, source.name]);
                          }
                        }}
                        className="flex-1 px-3 py-2 rounded-lg text-xs font-semibold text-left"
                        style={{
                          backgroundColor: isSelected ? COLORS.protein : COLORS.surfaceLight,
                          color: isSelected ? COLORS.background : COLORS.textSecondary
                        }}
                      >
                        {source.name}
                      </button>
                      {isSelected && (
                        <input
                          type="number"
                          value={itemAmounts[source.name] || 1}
                          onChange={(e) => setItemAmounts(prev => ({ ...prev, [source.name]: parseFloat(e.target.value) || 1 }))}
                          className="w-16 p-2 rounded-lg text-xs text-center"
                          style={{ backgroundColor: COLORS.surface, color: COLORS.text, border: 'none' }}
                          placeholder="1x"
                          step="0.5"
                          min="0.5"
                        />
                      )}
                    </div>
                  );
                })}
              </div>
            </div>

            {/* Sauces & Toppings */}
            <div className="mb-4">
              <p className="text-xs font-semibold mb-2" style={{ color: COLORS.accent }}> SAUCE / TOPPING (Multi-select)</p>
              <div className="space-y-2">
                {toppingSources.filter(s => s.name !== 'None').map((source, i) => {
                  const isSelected = selectedToppings.includes(source.name);
                  return (
                    <div key={i} className="flex items-center gap-2">
                      <button
                        onClick={() => {
                          if (isSelected) {
                            setSelectedToppings(prev => prev.filter(t => t !== source.name));
                            setItemAmounts(prev => {
                              const newAmounts = { ...prev };
                              delete newAmounts[source.name];
                              return newAmounts;
                            });
                          } else {
                            setSelectedToppings(prev => [...prev, source.name]);
                          }
                        }}
                        className="flex-1 px-3 py-2 rounded-lg text-xs font-semibold text-left"
                        style={{
                          backgroundColor: isSelected ? COLORS.accent : COLORS.surfaceLight,
                          color: isSelected ? COLORS.background : COLORS.textSecondary
                        }}
                      >
                        {source.name}
                      </button>
                      {isSelected && (
                        <input
                          type="number"
                          value={itemAmounts[source.name] || 1}
                          onChange={(e) => setItemAmounts(prev => ({ ...prev, [source.name]: parseFloat(e.target.value) || 1 }))}
                          className="w-16 p-2 rounded-lg text-xs text-center"
                          style={{ backgroundColor: COLORS.surface, color: COLORS.text, border: 'none' }}
                          placeholder="1x"
                          step="0.5"
                          min="0.5"
                        />
                      )}
                    </div>
                  );
                })}
              </div>
            </div>
            
            {/* Estimate Preview */}
            {(selectedProteins.length > 0 || selectedCarbs.length > 0 || selectedFats.length > 0 || selectedVegetables.length > 0 || selectedToppings.length > 0) && (
              <div className="p-4 rounded-xl mb-4" style={{ backgroundColor: COLORS.surfaceLight }}>
                <p className="text-xs font-semibold mb-2" style={{ color: COLORS.textMuted }}>ESTIMATED MACROS</p>
                <div className="grid grid-cols-4 gap-2 text-center">
                  <div>
                    <p className="text-lg font-bold" style={{ color: COLORS.accent }}>{estimate.cal}</p>
                    <p className="text-xs" style={{ color: COLORS.textMuted }}>kcal</p>
                  </div>
                  <div>
                    <p className="text-lg font-bold" style={{ color: COLORS.primary }}>{estimate.p}g</p>
                    <p className="text-xs" style={{ color: COLORS.textMuted }}>protein</p>
                  </div>
                  <div>
                    <p className="text-lg font-bold" style={{ color: COLORS.warning }}>{estimate.c}g</p>
                    <p className="text-xs" style={{ color: COLORS.textMuted }}>carbs</p>
                  </div>
                  <div>
                    <p className="text-lg font-bold" style={{ color: COLORS.sleep }}>{estimate.f}g</p>
                    <p className="text-xs" style={{ color: COLORS.textMuted }}>fats</p>
                  </div>
                </div>
              </div>
            )}

            <button
              onClick={applyEstimate}
              disabled={selectedProteins.length === 0 && selectedCarbs.length === 0 && selectedFats.length === 0 && selectedVegetables.length === 0 && selectedToppings.length === 0}
              className="w-full py-3 rounded-xl font-semibold"
              style={{
                backgroundColor: (selectedProteins.length > 0 || selectedCarbs.length > 0 || selectedFats.length > 0 || selectedVegetables.length > 0 || selectedToppings.length > 0) ? COLORS.primary : COLORS.surfaceLight,
                color: (selectedProteins.length > 0 || selectedCarbs.length > 0 || selectedFats.length > 0 || selectedVegetables.length > 0 || selectedToppings.length > 0) ? COLORS.text : COLORS.textMuted
              }}
            >
              Use This Estimate
            </button>
            
            <p className="text-xs text-center mt-3" style={{ color: COLORS.textMuted }}>
              Estimates are approximate. Adjust manually if needed.
            </p>
          </>
        )}
      </div>

      {/* Ingredient Selection Modal */}
      {showAddIngredient && (
        <div className="fixed inset-0 z-[60] flex items-center justify-center p-4" style={{ backgroundColor: 'rgba(0,0,0,0.2)' }}>
          <div className="w-full max-w-lg rounded-2xl flex flex-col" style={{ backgroundColor: COLORS.background, maxHeight: '90vh' }}>
            {/* Header - Fixed */}
            <div className="p-6 pb-3">
              <div className="flex items-center justify-between mb-4">
                <h3 className="text-lg font-bold" style={{ color: COLORS.text }}>Build Your Meal</h3>
                <button onClick={() => setShowAddIngredient(false)} className="p-2 rounded-full" style={{ backgroundColor: COLORS.surfaceLight }}>
                  <X size={20} color={COLORS.textMuted} />
                </button>
              </div>

              {/* Search Bar */}
              <div className="mb-3">
                <input
                  type="text"
                  value={ingredientSearch}
                  onChange={(e) => setIngredientSearch(e.target.value)}
                  placeholder="Search ingredients..."
                  className="w-full p-3 rounded-xl text-sm"
                  style={{ backgroundColor: COLORS.surface, color: COLORS.text, border: 'none' }}
                  autoFocus
                />
              </div>

              {/* Category filter */}
              <div className="flex gap-2 overflow-x-auto pb-2" style={{ scrollbarWidth: 'none' }}>
                {['All', 'Protein', 'Carbs', 'Fats', 'Vegetables', 'Sauces'].map(cat => (
                  <button
                    key={cat}
                    onClick={() => setIngredientFilter(cat)}
                    className="px-3 py-1.5 rounded-full text-xs font-semibold whitespace-nowrap"
                    style={{
                      backgroundColor: ingredientFilter === cat ? COLORS.primary : COLORS.surfaceLight,
                      color: ingredientFilter === cat ? COLORS.text : COLORS.textSecondary
                    }}
                  >
                    {cat}
                  </button>
                ))}
              </div>
            </div>

            {/* Ingredient Docket - Fixed */}
            {ingredients.length > 0 && (
              <div className="px-6 pb-3">
                <div className="p-3 rounded-xl" style={{ backgroundColor: COLORS.surface }}>
                  <div className="flex items-center justify-between mb-2">
                    <p className="text-xs font-semibold" style={{ color: COLORS.textMuted }}>YOUR MEAL: {generateMealName()}</p>
                    <button
                      onClick={applyEstimate}
                      className="px-3 py-1 rounded-lg text-xs font-semibold"
                      style={{ backgroundColor: COLORS.primary, color: COLORS.text }}
                    >
                      Finish
                    </button>
                  </div>
                  <div className="space-y-1 max-h-24 overflow-y-auto">
                    {ingredients.map((ing, idx) => (
                      <div key={idx} className="flex items-center justify-between text-xs p-1.5 rounded" style={{ backgroundColor: COLORS.surfaceLight }}>
                        <span style={{ color: COLORS.text }}>{ing.amount}{ing.unit === 'g' ? 'g' : ` ${ing.unit}`} {ing.food.name}</span>
                        <button onClick={() => setIngredients(prev => prev.filter((_, i) => i !== idx))}>
                          <X size={12} color={COLORS.error} />
                        </button>
                      </div>
                    ))}
                  </div>
                  {(() => {
                    const totals = calculateFromIngredients();
                    return (
                      <div className="mt-2 pt-2 border-t" style={{ borderColor: COLORS.surfaceLight }}>
                        <p className="text-xs font-semibold" style={{ color: COLORS.primary }}>
                          {totals.cal} cal | P:{totals.p}g | C:{totals.c}g | F:{totals.f}g
                        </p>
                      </div>
                    );
                  })()}
                </div>
              </div>
            )}

            {/* Food list - Scrollable */}
            <div className="flex-1 overflow-y-auto px-6 pb-6">
              <div className="space-y-2">
                {allFoods
                  .filter(food => {
                    const matchesSearch = food.name.toLowerCase().includes(ingredientSearch.toLowerCase());
                    const matchesFilter = ingredientFilter === 'All' || food.category === ingredientFilter;
                    return matchesSearch && matchesFilter;
                  })
                  .map((food, idx) => {
                    const amount = tempIngredientAmount[idx] !== undefined ? tempIngredientAmount[idx] : food.defaultAmount;
                    const unit = tempIngredientUnit[idx] || food.defaultUnit;
                    const multiplier = unit === 'g' ? amount / 100 : amount;
                    const calories = Math.round(food.per100g.cal * multiplier);
                    const protein = Math.round(food.per100g.p * multiplier);
                    const carbs = Math.round(food.per100g.c * multiplier);
                    const fats = Math.round(food.per100g.f * multiplier);

                    return (
                      <div key={idx} className="p-3 rounded-xl" style={{ backgroundColor: COLORS.surface }}>
                        <div className="flex items-start justify-between mb-2">
                          <div className="flex-1">
                            <p className="text-sm font-semibold mb-1" style={{ color: COLORS.text }}>{food.name}</p>
                            <div className="flex items-center gap-2">
                              <input
                                type="number"
                                value={amount}
                                onChange={(e) => setTempIngredientAmount(prev => ({ ...prev, [idx]: parseFloat(e.target.value) || 0 }))}
                                className="w-16 p-1.5 rounded text-xs text-center"
                                style={{ backgroundColor: COLORS.surfaceLight, color: COLORS.text, border: 'none' }}
                              />
                              <select
                                value={unit}
                                onChange={(e) => setTempIngredientUnit(prev => ({ ...prev, [idx]: e.target.value }))}
                                className="p-1.5 rounded text-xs"
                                style={{ backgroundColor: COLORS.surfaceLight, color: COLORS.text, border: 'none' }}
                              >
                                <option value="g">g</option>
                                <option value="units">units</option>
                                <option value="tbsp">tbsp</option>
                                <option value="ml">ml</option>
                              </select>
                              <button
                                onClick={() => {
                                  setIngredients(prev => [...prev, { food, amount, unit }]);
                                }}
                                className="p-1.5 rounded-lg ml-auto"
                                style={{ backgroundColor: COLORS.primary }}
                              >
                                <Plus size={14} color={COLORS.text} />
                              </button>
                            </div>
                          </div>
                          <div className="text-right ml-3">
                            <p className="text-xs font-bold mb-0.5" style={{ color: COLORS.primary }}>{calories} cal</p>
                            <p className="text-xs" style={{ color: COLORS.primary }}>P{protein} C{carbs} F{fats}</p>
                          </div>
                        </div>
                      </div>
                    );
                  })}
              </div>
            </div>
          </div>
        </div>
      )}
    </div>
  );
};

// Comprehensive Exercise Database (default fallback)
const DEFAULT_ALL_EXERCISES = [
  // CHEST
  { name: 'Barbell Bench Press', muscleGroup: 'Chest', equipment: 'Barbell', type: 'compound' },
  { name: 'Dumbbell Bench Press', muscleGroup: 'Chest', equipment: 'Dumbbells', type: 'compound' },
  { name: 'Incline Barbell Press', muscleGroup: 'Upper Chest', equipment: 'Barbell', type: 'compound' },
  { name: 'Incline Dumbbell Press', muscleGroup: 'Upper Chest', equipment: 'Dumbbells', type: 'compound' },
  { name: 'Decline Bench Press', muscleGroup: 'Lower Chest', equipment: 'Barbell', type: 'compound' },
  { name: 'Machine Chest Press', muscleGroup: 'Chest', equipment: 'Machine', type: 'compound' },
  { name: 'Cable Fly', muscleGroup: 'Chest', equipment: 'Cable', type: 'isolation' },
  { name: 'Incline Cable Fly', muscleGroup: 'Upper Chest', equipment: 'Cable', type: 'isolation' },
  { name: 'Pec Deck', muscleGroup: 'Chest', equipment: 'Machine', type: 'isolation' },
  { name: 'Dumbbell Fly', muscleGroup: 'Chest', equipment: 'Dumbbells', type: 'isolation' },
  { name: 'Push Ups', muscleGroup: 'Chest', equipment: 'Bodyweight', type: 'compound' },
  { name: 'Dips', muscleGroup: 'Chest', equipment: 'Bodyweight', type: 'compound' },
  { name: 'Landmine Press', muscleGroup: 'Chest', equipment: 'Barbell', type: 'compound' },
  { name: 'Floor Press', muscleGroup: 'Chest', equipment: 'Barbell', type: 'compound' },
  { name: 'Close Grip Bench Press', muscleGroup: 'Chest', equipment: 'Barbell', type: 'compound' },
  
  // BACK - with muscle region targeting
  { name: 'Barbell Row', muscleGroup: 'Back', equipment: 'Barbell', type: 'compound', targetedHeads: ['Mid Back', 'Upper Back'] },
  { name: 'Pendlay Row', muscleGroup: 'Back', equipment: 'Barbell', type: 'compound', targetedHeads: ['Mid Back', 'Upper Back'] },
  { name: 'Dumbbell Row', muscleGroup: 'Back', equipment: 'Dumbbells', type: 'compound', targetedHeads: ['Mid Back'] },
  { name: 'Chest Supported Row', muscleGroup: 'Back', equipment: 'Dumbbells', type: 'compound', targetedHeads: ['Upper Back', 'Mid Back'] },
  { name: 'T-Bar Row', muscleGroup: 'Back', equipment: 'Barbell', type: 'compound', targetedHeads: ['Mid Back'] },
  { name: 'Seated Cable Row', muscleGroup: 'Back', equipment: 'Cable', type: 'compound', targetedHeads: ['Mid Back'] },
  { name: 'Lat Pulldown', muscleGroup: 'Lats', equipment: 'Cable', type: 'compound' },
  { name: 'Close Grip Pulldown', muscleGroup: 'Lats', equipment: 'Cable', type: 'compound' },
  { name: 'Wide Grip Pulldown', muscleGroup: 'Lats', equipment: 'Cable', type: 'compound' },
  { name: 'Pull Ups', muscleGroup: 'Lats', equipment: 'Bodyweight', type: 'compound' },
  { name: 'Chin Ups', muscleGroup: 'Lats', equipment: 'Bodyweight', type: 'compound' },
  { name: 'Neutral Grip Pull Ups', muscleGroup: 'Lats', equipment: 'Bodyweight', type: 'compound' },
  { name: 'Machine Row', muscleGroup: 'Back', equipment: 'Machine', type: 'compound', targetedHeads: ['Mid Back'] },
  { name: 'Meadows Row', muscleGroup: 'Back', equipment: 'Barbell', type: 'compound', targetedHeads: ['Mid Back'] },
  { name: 'Seal Row', muscleGroup: 'Back', equipment: 'Barbell', type: 'compound', targetedHeads: ['Mid Back', 'Upper Back'] },
  { name: 'Straight Arm Pulldown', muscleGroup: 'Lats', equipment: 'Cable', type: 'isolation' },
  { name: 'Rack Pulls', muscleGroup: 'Back', equipment: 'Barbell', type: 'compound', targetedHeads: ['Lower Back'] },
  { name: 'Deadlift', muscleGroup: 'Back', equipment: 'Barbell', type: 'compound', targetedHeads: ['Lower Back', 'Mid Back'] },
  { name: 'Snatch Grip Deadlift', muscleGroup: 'Back', equipment: 'Barbell', type: 'compound', targetedHeads: ['Upper Back', 'Mid Back'] },
  { name: 'Wide Grip Cable Row', muscleGroup: 'Back', equipment: 'Cable', type: 'compound', targetedHeads: ['Upper Back'] },
  { name: 'High Cable Row', muscleGroup: 'Back', equipment: 'Cable', type: 'compound', targetedHeads: ['Upper Back'] },
  { name: 'Back Extension', muscleGroup: 'Back', equipment: 'Equipment', type: 'isolation', targetedHeads: ['Lower Back'] },
  { name: 'Hyperextension', muscleGroup: 'Back', equipment: 'Equipment', type: 'isolation', targetedHeads: ['Lower Back'] },
  
  // SHOULDERS
  { name: 'Overhead Press', muscleGroup: 'Shoulders', equipment: 'Barbell', type: 'compound' },
  { name: 'Seated Dumbbell Press', muscleGroup: 'Shoulders', equipment: 'Dumbbells', type: 'compound' },
  { name: 'Arnold Press', muscleGroup: 'Shoulders', equipment: 'Dumbbells', type: 'compound' },
  { name: 'Machine Shoulder Press', muscleGroup: 'Shoulders', equipment: 'Machine', type: 'compound' },
  { name: 'Push Press', muscleGroup: 'Shoulders', equipment: 'Barbell', type: 'compound' },
  { name: 'Lateral Raises', muscleGroup: 'Side Delts', equipment: 'Dumbbells', type: 'isolation' },
  { name: 'Cable Lateral Raises', muscleGroup: 'Side Delts', equipment: 'Cable', type: 'isolation' },
  { name: 'Machine Lateral Raises', muscleGroup: 'Side Delts', equipment: 'Machine', type: 'isolation' },
  { name: 'Front Raises', muscleGroup: 'Front Delts', equipment: 'Dumbbells', type: 'isolation' },
  { name: 'Cable Front Raises', muscleGroup: 'Front Delts', equipment: 'Cable', type: 'isolation' },
  { name: 'Face Pulls', muscleGroup: 'Rear Delts', equipment: 'Cable', type: 'isolation' },
  { name: 'Reverse Pec Deck', muscleGroup: 'Rear Delts', equipment: 'Machine', type: 'isolation' },
  { name: 'Rear Delt Fly', muscleGroup: 'Rear Delts', equipment: 'Dumbbells', type: 'isolation' },
  { name: 'Cable Rear Delt Fly', muscleGroup: 'Rear Delts', equipment: 'Cable', type: 'isolation' },
  { name: 'Upright Rows', muscleGroup: 'Shoulders', equipment: 'Barbell', type: 'compound' },
  { name: 'Lu Raises', muscleGroup: 'Side Delts', equipment: 'Dumbbells', type: 'isolation' },
  { name: 'Y Raises', muscleGroup: 'Shoulders', equipment: 'Dumbbells', type: 'isolation' },
  
  // TRICEPS - with muscle head targeting
  { name: 'Tricep Pushdowns', muscleGroup: 'Triceps', equipment: 'Cable', type: 'isolation', targetedHeads: ['Lateral Head Triceps'] },
  { name: 'Rope Pushdowns', muscleGroup: 'Triceps', equipment: 'Cable', type: 'isolation', targetedHeads: ['Lateral Head Triceps', 'Medial Head Triceps'] },
  { name: 'Overhead Tricep Extension', muscleGroup: 'Triceps', equipment: 'Cable', type: 'isolation', targetedHeads: ['Long Head Triceps'] },
  { name: 'Skull Crushers', muscleGroup: 'Triceps', equipment: 'Barbell', type: 'isolation', targetedHeads: ['Long Head Triceps'] },
  { name: 'Dumbbell Skull Crushers', muscleGroup: 'Triceps', equipment: 'Dumbbells', type: 'isolation', targetedHeads: ['Long Head Triceps'] },
  { name: 'Tricep Dips', muscleGroup: 'Triceps', equipment: 'Bodyweight', type: 'compound', targetedHeads: ['Lateral Head Triceps', 'Medial Head Triceps'] },
  { name: 'Diamond Push Ups', muscleGroup: 'Triceps', equipment: 'Bodyweight', type: 'compound', targetedHeads: ['Medial Head Triceps'] },
  { name: 'JM Press', muscleGroup: 'Triceps', equipment: 'Barbell', type: 'compound', targetedHeads: ['Long Head Triceps', 'Lateral Head Triceps'] },
  { name: 'Tricep Kickbacks', muscleGroup: 'Triceps', equipment: 'Dumbbells', type: 'isolation', targetedHeads: ['Lateral Head Triceps'] },
  { name: 'Single Arm Pushdown', muscleGroup: 'Triceps', equipment: 'Cable', type: 'isolation', targetedHeads: ['Lateral Head Triceps'] },
  { name: 'V-Bar Pushdown', muscleGroup: 'Triceps', equipment: 'Cable', type: 'isolation', targetedHeads: ['Lateral Head Triceps'] },
  { name: 'Reverse Grip Pushdown', muscleGroup: 'Triceps', equipment: 'Cable', type: 'isolation', targetedHeads: ['Medial Head Triceps'] },
  { name: 'French Press', muscleGroup: 'Triceps', equipment: 'Barbell', type: 'isolation', targetedHeads: ['Long Head Triceps'] },
  { name: 'Incline Skull Crushers', muscleGroup: 'Triceps', equipment: 'Barbell', type: 'isolation', targetedHeads: ['Long Head Triceps'] },
  { name: 'Overhead Dumbbell Extension', muscleGroup: 'Triceps', equipment: 'Dumbbells', type: 'isolation', targetedHeads: ['Long Head Triceps'] },
  
  // BICEPS - with muscle head targeting
  { name: 'Barbell Curl', muscleGroup: 'Biceps', equipment: 'Barbell', type: 'isolation', targetedHeads: ['Long Head Biceps', 'Short Head Biceps'] },
  { name: 'EZ Bar Curl', muscleGroup: 'Biceps', equipment: 'Barbell', type: 'isolation', targetedHeads: ['Long Head Biceps', 'Short Head Biceps'] },
  { name: 'Dumbbell Curl', muscleGroup: 'Biceps', equipment: 'Dumbbells', type: 'isolation', targetedHeads: ['Long Head Biceps', 'Short Head Biceps'] },
  { name: 'Hammer Curls', muscleGroup: 'Biceps', equipment: 'Dumbbells', type: 'isolation', targetedHeads: ['Long Head Biceps'] },
  { name: 'Incline Dumbbell Curl', muscleGroup: 'Biceps', equipment: 'Dumbbells', type: 'isolation', targetedHeads: ['Long Head Biceps'] },
  { name: 'Preacher Curl', muscleGroup: 'Biceps', equipment: 'Barbell', type: 'isolation', targetedHeads: ['Short Head Biceps'] },
  { name: 'Cable Curl', muscleGroup: 'Biceps', equipment: 'Cable', type: 'isolation', targetedHeads: ['Long Head Biceps', 'Short Head Biceps'] },
  { name: 'Concentration Curl', muscleGroup: 'Biceps', equipment: 'Dumbbells', type: 'isolation', targetedHeads: ['Short Head Biceps'] },
  { name: 'Spider Curls', muscleGroup: 'Biceps', equipment: 'Dumbbells', type: 'isolation', targetedHeads: ['Short Head Biceps'] },
  { name: 'Drag Curls', muscleGroup: 'Biceps', equipment: 'Barbell', type: 'isolation', targetedHeads: ['Long Head Biceps'] },
  { name: 'Reverse Curls', muscleGroup: 'Forearms', equipment: 'Barbell', type: 'isolation' },
  { name: 'Wrist Curls', muscleGroup: 'Forearms', equipment: 'Barbell', type: 'isolation' },
  { name: 'Bayesian Cable Curl', muscleGroup: 'Biceps', equipment: 'Cable', type: 'isolation', targetedHeads: ['Long Head Biceps'] },
  { name: 'High Cable Curl', muscleGroup: 'Biceps', equipment: 'Cable', type: 'isolation', targetedHeads: ['Short Head Biceps'] },
  { name: 'Machine Preacher Curl', muscleGroup: 'Biceps', equipment: 'Machine', type: 'isolation', targetedHeads: ['Short Head Biceps'] },
  { name: 'Wide Grip Barbell Curl', muscleGroup: 'Biceps', equipment: 'Barbell', type: 'isolation', targetedHeads: ['Short Head Biceps'] },
  { name: 'Narrow Grip EZ Curl', muscleGroup: 'Biceps', equipment: 'Barbell', type: 'isolation', targetedHeads: ['Long Head Biceps'] },
  
  // QUADS - with muscle head targeting
  { name: 'Barbell Back Squat', muscleGroup: 'Quads', equipment: 'Barbell', type: 'compound', targetedHeads: ['Vastus Lateralis', 'Vastus Medialis', 'Rectus Femoris'] },
  { name: 'Front Squat', muscleGroup: 'Quads', equipment: 'Barbell', type: 'compound', targetedHeads: ['Rectus Femoris', 'Vastus Medialis'] },
  { name: 'Goblet Squat', muscleGroup: 'Quads', equipment: 'Dumbbells', type: 'compound', targetedHeads: ['Vastus Medialis', 'Rectus Femoris'] },
  { name: 'Hack Squat', muscleGroup: 'Quads', equipment: 'Machine', type: 'compound', targetedHeads: ['Rectus Femoris', 'Vastus Lateralis'] },
  { name: 'Leg Press', muscleGroup: 'Quads', equipment: 'Machine', type: 'compound', targetedHeads: ['Vastus Lateralis', 'Vastus Medialis'] },
  { name: 'Bulgarian Split Squat', muscleGroup: 'Quads', equipment: 'Dumbbells', type: 'compound', targetedHeads: ['Vastus Medialis', 'Rectus Femoris'] },
  { name: 'Walking Lunges', muscleGroup: 'Quads', equipment: 'Dumbbells', type: 'compound', targetedHeads: ['Vastus Lateralis', 'Rectus Femoris'] },
  { name: 'Reverse Lunges', muscleGroup: 'Quads', equipment: 'Dumbbells', type: 'compound', targetedHeads: ['Vastus Medialis', 'Rectus Femoris'] },
  { name: 'Step Ups', muscleGroup: 'Quads', equipment: 'Dumbbells', type: 'compound', targetedHeads: ['Vastus Medialis', 'Rectus Femoris'] },
  { name: 'Leg Extension', muscleGroup: 'Quads', equipment: 'Machine', type: 'isolation', targetedHeads: ['Rectus Femoris'] },
  { name: 'Sissy Squat', muscleGroup: 'Quads', equipment: 'Bodyweight', type: 'isolation', targetedHeads: ['Vastus Medialis', 'Rectus Femoris'] },
  { name: 'Pendulum Squat', muscleGroup: 'Quads', equipment: 'Machine', type: 'compound', targetedHeads: ['Rectus Femoris'] },
  { name: 'Belt Squat', muscleGroup: 'Quads', equipment: 'Machine', type: 'compound', targetedHeads: ['Vastus Lateralis', 'Vastus Medialis'] },
  { name: 'Smith Machine Squat', muscleGroup: 'Quads', equipment: 'Machine', type: 'compound', targetedHeads: ['Vastus Lateralis', 'Vastus Medialis'] },
  { name: 'Heels Elevated Squat', muscleGroup: 'Quads', equipment: 'Barbell', type: 'compound', targetedHeads: ['Vastus Medialis'] },
  { name: 'Narrow Stance Leg Press', muscleGroup: 'Quads', equipment: 'Machine', type: 'compound', targetedHeads: ['Vastus Medialis'] },
  { name: 'Wide Stance Leg Press', muscleGroup: 'Quads', equipment: 'Machine', type: 'compound', targetedHeads: ['Vastus Lateralis'] },

  // HAMSTRINGS & GLUTES - with muscle head targeting
  { name: 'Romanian Deadlift', muscleGroup: 'Hamstrings', equipment: 'Barbell', type: 'compound', targetedHeads: ['Bicep Femoris'] },
  { name: 'Stiff Leg Deadlift', muscleGroup: 'Hamstrings', equipment: 'Barbell', type: 'compound', targetedHeads: ['Bicep Femoris'] },
  { name: 'Dumbbell RDL', muscleGroup: 'Hamstrings', equipment: 'Dumbbells', type: 'compound', targetedHeads: ['Bicep Femoris'] },
  { name: 'Single Leg RDL', muscleGroup: 'Hamstrings', equipment: 'Dumbbells', type: 'compound', targetedHeads: ['Bicep Femoris'] },
  { name: 'Good Mornings', muscleGroup: 'Hamstrings', equipment: 'Barbell', type: 'compound', targetedHeads: ['Bicep Femoris'] },
  { name: 'Lying Leg Curl', muscleGroup: 'Hamstrings', equipment: 'Machine', type: 'isolation', targetedHeads: ['Bicep Femoris'] },
  { name: 'Seated Leg Curl', muscleGroup: 'Hamstrings', equipment: 'Machine', type: 'isolation', targetedHeads: ['Semitendinosus'] },
  { name: 'Nordic Curls', muscleGroup: 'Hamstrings', equipment: 'Bodyweight', type: 'isolation', targetedHeads: ['Semitendinosus', 'Bicep Femoris'] },
  { name: 'Glute Ham Raise', muscleGroup: 'Hamstrings', equipment: 'Equipment', type: 'isolation', targetedHeads: ['Semitendinosus', 'Bicep Femoris'] },
  { name: 'Hip Thrust', muscleGroup: 'Glutes', equipment: 'Barbell', type: 'compound', targetedHeads: ['Gluteus Maximus'] },
  { name: 'Glute Bridge', muscleGroup: 'Glutes', equipment: 'Barbell', type: 'compound', targetedHeads: ['Gluteus Maximus'] },
  { name: 'Cable Pull Through', muscleGroup: 'Glutes', equipment: 'Cable', type: 'compound', targetedHeads: ['Gluteus Maximus'] },
  { name: 'Glute Kickback', muscleGroup: 'Glutes', equipment: 'Cable', type: 'isolation', targetedHeads: ['Gluteus Maximus', 'Gluteus Medius'] },
  { name: 'Hip Abduction', muscleGroup: 'Glutes', equipment: 'Machine', type: 'isolation', targetedHeads: ['Gluteus Medius'] },
  { name: 'Sumo Deadlift', muscleGroup: 'Glutes', equipment: 'Barbell', type: 'compound', targetedHeads: ['Gluteus Maximus'] },
  { name: 'Single Leg Hip Thrust', muscleGroup: 'Glutes', equipment: 'Bodyweight', type: 'isolation', targetedHeads: ['Gluteus Maximus'] },
  { name: 'Cable Hip Abduction', muscleGroup: 'Glutes', equipment: 'Cable', type: 'isolation', targetedHeads: ['Gluteus Medius'] },
  { name: 'Curtsy Lunge', muscleGroup: 'Glutes', equipment: 'Dumbbells', type: 'compound', targetedHeads: ['Gluteus Medius', 'Gluteus Maximus'] },
  
  // CALVES
  { name: 'Standing Calf Raises', muscleGroup: 'Calves', equipment: 'Machine', type: 'isolation' },
  { name: 'Seated Calf Raises', muscleGroup: 'Calves', equipment: 'Machine', type: 'isolation' },
  { name: 'Leg Press Calf Raises', muscleGroup: 'Calves', equipment: 'Machine', type: 'isolation' },
  { name: 'Donkey Calf Raises', muscleGroup: 'Calves', equipment: 'Machine', type: 'isolation' },
  { name: 'Single Leg Calf Raise', muscleGroup: 'Calves', equipment: 'Bodyweight', type: 'isolation' },
  { name: 'Smith Machine Calf Raise', muscleGroup: 'Calves', equipment: 'Machine', type: 'isolation' },
  
  // CORE
  { name: 'Hanging Leg Raises', muscleGroup: 'Abs', equipment: 'Bodyweight', type: 'isolation' },
  { name: 'Hanging Knee Raises', muscleGroup: 'Abs', equipment: 'Bodyweight', type: 'isolation' },
  { name: 'Cable Crunches', muscleGroup: 'Abs', equipment: 'Cable', type: 'isolation' },
  { name: 'Ab Wheel Rollout', muscleGroup: 'Abs', equipment: 'Equipment', type: 'isolation' },
  { name: 'Plank', muscleGroup: 'Core', equipment: 'Bodyweight', type: 'isolation' },
  { name: 'Dead Bug', muscleGroup: 'Core', equipment: 'Bodyweight', type: 'isolation' },
  { name: 'Pallof Press', muscleGroup: 'Core', equipment: 'Cable', type: 'isolation' },
  { name: 'Wood Chops', muscleGroup: 'Core', equipment: 'Cable', type: 'isolation' },
  { name: 'Russian Twists', muscleGroup: 'Obliques', equipment: 'Bodyweight', type: 'isolation' },
  { name: 'Side Plank', muscleGroup: 'Obliques', equipment: 'Bodyweight', type: 'isolation' },
  { name: 'Decline Sit Ups', muscleGroup: 'Abs', equipment: 'Bodyweight', type: 'isolation' },
  { name: 'Bicycle Crunches', muscleGroup: 'Abs', equipment: 'Bodyweight', type: 'isolation' },
  { name: 'Mountain Climbers', muscleGroup: 'Core', equipment: 'Bodyweight', type: 'compound' },
  { name: 'V-Ups', muscleGroup: 'Abs', equipment: 'Bodyweight', type: 'isolation' },
  { name: 'Toe Touches', muscleGroup: 'Abs', equipment: 'Bodyweight', type: 'isolation' },
  { name: 'Flutter Kicks', muscleGroup: 'Abs', equipment: 'Bodyweight', type: 'isolation' },
  { name: 'Dragon Flags', muscleGroup: 'Abs', equipment: 'Bodyweight', type: 'isolation' },
  { name: 'L-Sit', muscleGroup: 'Core', equipment: 'Bodyweight', type: 'isolation' },
  { name: 'Hollow Body Hold', muscleGroup: 'Core', equipment: 'Bodyweight', type: 'isolation' },
  { name: 'Bird Dog', muscleGroup: 'Core', equipment: 'Bodyweight', type: 'isolation' },

  // TRAPS
  { name: 'Barbell Shrugs', muscleGroup: 'Traps', equipment: 'Barbell', type: 'isolation' },
  { name: 'Dumbbell Shrugs', muscleGroup: 'Traps', equipment: 'Dumbbells', type: 'isolation' },
  { name: 'Cable Shrugs', muscleGroup: 'Traps', equipment: 'Cable', type: 'isolation' },
  { name: 'Farmers Walk', muscleGroup: 'Traps', equipment: 'Dumbbells', type: 'compound' },
  { name: 'Rack Pulls (High)', muscleGroup: 'Traps', equipment: 'Barbell', type: 'compound' },

  // CARDIO & CONDITIONING
  { name: 'Treadmill Run', muscleGroup: 'Cardio', equipment: 'Machine', type: 'cardio' },
  { name: 'Treadmill Walk (Incline)', muscleGroup: 'Cardio', equipment: 'Machine', type: 'cardio' },
  { name: 'Stationary Bike', muscleGroup: 'Cardio', equipment: 'Machine', type: 'cardio' },
  { name: 'Rowing Machine', muscleGroup: 'Cardio', equipment: 'Machine', type: 'cardio' },
  { name: 'Stair Climber', muscleGroup: 'Cardio', equipment: 'Machine', type: 'cardio' },
  { name: 'Elliptical', muscleGroup: 'Cardio', equipment: 'Machine', type: 'cardio' },
  { name: 'Battle Ropes', muscleGroup: 'Cardio', equipment: 'Equipment', type: 'cardio' },
  { name: 'Box Jumps', muscleGroup: 'Cardio', equipment: 'Equipment', type: 'compound' },
  { name: 'Burpees', muscleGroup: 'Cardio', equipment: 'Bodyweight', type: 'compound' },
  { name: 'Jump Rope', muscleGroup: 'Cardio', equipment: 'Equipment', type: 'cardio' },
  { name: 'Sled Push', muscleGroup: 'Cardio', equipment: 'Equipment', type: 'compound' },
  { name: 'Sled Pull', muscleGroup: 'Cardio', equipment: 'Equipment', type: 'compound' },
  { name: 'Kettlebell Swings', muscleGroup: 'Cardio', equipment: 'Kettlebell', type: 'compound' },
  { name: 'Assault Bike', muscleGroup: 'Cardio', equipment: 'Machine', type: 'cardio' },
  { name: 'Ski Erg', muscleGroup: 'Cardio', equipment: 'Machine', type: 'cardio' },

  // OLYMPIC LIFTS & VARIATIONS
  { name: 'Power Clean', muscleGroup: 'Full Body', equipment: 'Barbell', type: 'compound' },
  { name: 'Hang Clean', muscleGroup: 'Full Body', equipment: 'Barbell', type: 'compound' },
  { name: 'Clean and Jerk', muscleGroup: 'Full Body', equipment: 'Barbell', type: 'compound' },
  { name: 'Snatch', muscleGroup: 'Full Body', equipment: 'Barbell', type: 'compound' },
  { name: 'Hang Snatch', muscleGroup: 'Full Body', equipment: 'Barbell', type: 'compound' },
  { name: 'Clean High Pull', muscleGroup: 'Full Body', equipment: 'Barbell', type: 'compound' },
  { name: 'Dumbbell Snatch', muscleGroup: 'Full Body', equipment: 'Dumbbells', type: 'compound' },
  { name: 'Kettlebell Clean', muscleGroup: 'Full Body', equipment: 'Kettlebell', type: 'compound' },
  { name: 'Thruster', muscleGroup: 'Full Body', equipment: 'Barbell', type: 'compound' },
  { name: 'Dumbbell Thruster', muscleGroup: 'Full Body', equipment: 'Dumbbells', type: 'compound' },

  // FUNCTIONAL & STABILITY
  { name: 'Turkish Get Up', muscleGroup: 'Full Body', equipment: 'Kettlebell', type: 'compound' },
  { name: 'Landmine Rotation', muscleGroup: 'Core', equipment: 'Barbell', type: 'compound' },
  { name: 'Medicine Ball Slam', muscleGroup: 'Full Body', equipment: 'Equipment', type: 'compound' },
  { name: 'Wall Ball', muscleGroup: 'Full Body', equipment: 'Equipment', type: 'compound' },
  { name: 'Cable Woodchop (Low to High)', muscleGroup: 'Core', equipment: 'Cable', type: 'compound' },
  { name: 'Bosu Ball Squat', muscleGroup: 'Quads', equipment: 'Equipment', type: 'compound' },
  { name: 'Single Leg Deadlift', muscleGroup: 'Hamstrings', equipment: 'Dumbbells', type: 'compound' },
  { name: 'Pistol Squat', muscleGroup: 'Quads', equipment: 'Bodyweight', type: 'compound' },
  { name: 'Box Step Up', muscleGroup: 'Quads', equipment: 'Equipment', type: 'compound' },
  { name: 'Reverse Lunge', muscleGroup: 'Quads', equipment: 'Dumbbells', type: 'compound' },
  { name: 'Walking Lunge', muscleGroup: 'Quads', equipment: 'Dumbbells', type: 'compound' },
  { name: 'Curtsy Lunge', muscleGroup: 'Glutes', equipment: 'Dumbbells', type: 'compound' },
  { name: 'Step Through Lunge', muscleGroup: 'Quads', equipment: 'Dumbbells', type: 'compound' },

  // ADVANCED BODYWEIGHT
  { name: 'Muscle Up', muscleGroup: 'Full Body', equipment: 'Bodyweight', type: 'compound' },
  { name: 'Ring Dips', muscleGroup: 'Chest', equipment: 'Bodyweight', type: 'compound' },
  { name: 'Ring Rows', muscleGroup: 'Back', equipment: 'Bodyweight', type: 'compound' },
  { name: 'Handstand Push Up', muscleGroup: 'Shoulders', equipment: 'Bodyweight', type: 'compound' },
  { name: 'Archer Push Up', muscleGroup: 'Chest', equipment: 'Bodyweight', type: 'compound' },
  { name: 'Pike Push Up', muscleGroup: 'Shoulders', equipment: 'Bodyweight', type: 'compound' },
  { name: 'Decline Push Up', muscleGroup: 'Chest', equipment: 'Bodyweight', type: 'compound' },
  { name: 'Inverted Row', muscleGroup: 'Back', equipment: 'Bodyweight', type: 'compound' },
  { name: 'Typewriter Pull Up', muscleGroup: 'Back', equipment: 'Bodyweight', type: 'compound' },
  { name: 'Archer Pull Up', muscleGroup: 'Back', equipment: 'Bodyweight', type: 'compound' },

  // ADDITIONAL SHOULDER EXERCISES
  { name: 'Seated Arnold Press', muscleGroup: 'Shoulders', equipment: 'Dumbbells', type: 'compound' },
  { name: 'Bradford Press', muscleGroup: 'Shoulders', equipment: 'Barbell', type: 'compound' },
  { name: 'Z Press', muscleGroup: 'Shoulders', equipment: 'Barbell', type: 'compound' },
  { name: 'Behind the Neck Press', muscleGroup: 'Shoulders', equipment: 'Barbell', type: 'compound' },
  { name: 'Bottoms Up Press', muscleGroup: 'Shoulders', equipment: 'Kettlebell', type: 'compound' },
  { name: 'Javelin Press', muscleGroup: 'Shoulders', equipment: 'Barbell', type: 'compound' },
  { name: 'Crucifix Hold', muscleGroup: 'Side Delts', equipment: 'Dumbbells', type: 'isolation' },

  // ADDITIONAL ARM EXERCISES
  { name: '21s (Bicep)', muscleGroup: 'Biceps', equipment: 'Barbell', type: 'isolation' },
  { name: 'Zottman Curls', muscleGroup: 'Biceps', equipment: 'Dumbbells', type: 'isolation' },
  { name: 'Waiter Curls', muscleGroup: 'Biceps', equipment: 'Dumbbells', type: 'isolation' },
  { name: 'Cable Hammer Curl', muscleGroup: 'Biceps', equipment: 'Cable', type: 'isolation' },
  { name: 'Overhead Cable Curl', muscleGroup: 'Biceps', equipment: 'Cable', type: 'isolation' },
  { name: 'California Press', muscleGroup: 'Triceps', equipment: 'Barbell', type: 'compound' },
  { name: 'Tate Press', muscleGroup: 'Triceps', equipment: 'Dumbbells', type: 'isolation' },
  { name: 'Bench Dips', muscleGroup: 'Triceps', equipment: 'Bodyweight', type: 'compound' },
  { name: 'Overhead Dumbbell Extension', muscleGroup: 'Triceps', equipment: 'Dumbbells', type: 'isolation' },
  { name: 'Cross Body Tricep Extension', muscleGroup: 'Triceps', equipment: 'Cable', type: 'isolation' },
];

// ============================================
// DYNAMIC WORKOUT GENERATION SYSTEM
// ============================================

// Goal-based training parameters
const GOAL_TRAINING_PARAMS = {
  bulk: { setsPerExercise: [4, 5], repsPerSet: [6, 10], restTime: [90, 150], compoundFirst: true },
  build_muscle: { setsPerExercise: [3, 4], repsPerSet: [8, 12], restTime: [60, 120], compoundFirst: true },
  strength: { setsPerExercise: [4, 5], repsPerSet: [3, 6], restTime: [180, 300], compoundFirst: true },
  recomp: { setsPerExercise: [3, 4], repsPerSet: [8, 12], restTime: [60, 90], compoundFirst: true },
  fitness: { setsPerExercise: [2, 3], repsPerSet: [12, 15], restTime: [45, 60], compoundFirst: false },
  athletic: { setsPerExercise: [3, 4], repsPerSet: [6, 10], restTime: [60, 120], compoundFirst: true },
  lean: { setsPerExercise: [3, 4], repsPerSet: [10, 15], restTime: [30, 60], compoundFirst: false },
  lose_fat: { setsPerExercise: [3, 4], repsPerSet: [12, 15], restTime: [30, 45], compoundFirst: false },
};

// Complementary muscle pairings for supersets (antagonist muscles only)
// These muscles can be safely supersetted as they don't interfere with each other
const SUPERSET_PAIRINGS = {
  // Arms - biceps and triceps are perfect antagonists
  'Biceps': ['Triceps'],
  'Triceps': ['Biceps'],
  // Chest and Back - classic push/pull antagonists
  'Chest': ['Back', 'Lats', 'Rear Delts'],
  'Upper Chest': ['Back', 'Lats', 'Rear Delts'],
  'Back': ['Chest', 'Upper Chest'],
  'Lats': ['Chest', 'Upper Chest'],
  // Shoulders - front and rear delts are antagonists
  'Shoulders': ['Rear Delts'],
  'Front Delts': ['Rear Delts'],
  'Rear Delts': ['Shoulders', 'Front Delts', 'Chest', 'Upper Chest'],
  'Side Delts': ['Rear Delts'], // Side delts can pair with rear delts
  // Legs - quads and hamstrings are antagonists
  'Quads': ['Hamstrings'],
  'Hamstrings': ['Quads'],
  // Core - abs and lower back are antagonists
  'Abs': ['Lower Back'],
  'Core': ['Lower Back'],
  'Lower Back': ['Abs', 'Core'],
};

// Muscles that should NEVER be supersetted together (synergists)
// These muscles assist each other and supersetting would cause fatigue issues
const INVALID_SUPERSET_PAIRINGS = {
  'Biceps': ['Back', 'Lats', 'Rear Delts'], // Biceps assist in pulling movements
  'Triceps': ['Chest', 'Upper Chest', 'Shoulders', 'Front Delts'], // Triceps assist in pressing
  'Front Delts': ['Chest', 'Upper Chest'], // Front delts assist in chest pressing
  'Glutes': ['Quads', 'Hamstrings'], // Glutes work with both in compound leg movements
};

// Check if two exercises can be supersetted
const canSuperset = (exercise1, exercise2) => {
  const muscle1 = exercise1.muscleGroup;
  const muscle2 = exercise2.muscleGroup;

  // Check if they're in the valid pairings
  const validPairs = SUPERSET_PAIRINGS[muscle1] || [];
  if (!validPairs.includes(muscle2)) return false;

  // Double-check they're not in invalid pairings
  const invalidPairs1 = INVALID_SUPERSET_PAIRINGS[muscle1] || [];
  const invalidPairs2 = INVALID_SUPERSET_PAIRINGS[muscle2] || [];
  if (invalidPairs1.includes(muscle2) || invalidPairs2.includes(muscle1)) return false;

  // Don't superset two compound exercises (too fatiguing)
  if (exercise1.type === 'compound' && exercise2.type === 'compound') return false;

  return true;
};

// Create supersets from exercise list when time is limited
const createSupersets = (exercises, targetTimeSavingMinutes = 0) => {
  if (targetTimeSavingMinutes <= 0 || exercises.length < 2) {
    return { exercises, supersets: [], timeSaved: 0 };
  }

  const result = [...exercises];
  const supersets = [];
  let timeSaved = 0;
  const usedIndices = new Set();

  // Try to create supersets to save time
  // Each superset saves approximately the rest time between the two exercises
  for (let i = 0; i < result.length && timeSaved < targetTimeSavingMinutes * 60; i++) {
    if (usedIndices.has(i)) continue;

    for (let j = i + 1; j < result.length; j++) {
      if (usedIndices.has(j)) continue;

      if (canSuperset(result[i], result[j])) {
        // Create a superset
        const exercise1 = result[i];
        const exercise2 = result[j];

        // Mark both as part of a superset
        const supersetId = `superset_${Date.now()}_${i}`;
        result[i] = {
          ...exercise1,
          supersetId,
          supersetOrder: 1,
          supersetWith: exercise2.name,
          // No rest after first exercise in superset
          restTime: 0,
        };
        result[j] = {
          ...exercise2,
          supersetId,
          supersetOrder: 2,
          supersetWith: exercise1.name,
          // Normal rest after completing both exercises
          restTime: exercise2.restTime || 60,
        };

        supersets.push({
          id: supersetId,
          exercise1: exercise1.name,
          exercise2: exercise2.name,
          muscle1: exercise1.muscleGroup,
          muscle2: exercise2.muscleGroup,
        });

        // Time saved is the rest period we eliminated
        timeSaved += (exercise1.restTime || 60);
        usedIndices.add(i);
        usedIndices.add(j);
        break;
      }
    }
  }

  // Reorder exercises to keep superset pairs together
  const reordered = [];
  const supersetExercises = result.filter(ex => ex.supersetId);
  const regularExercises = result.filter(ex => !ex.supersetId);

  // Group superset exercises together
  const supersetGroups = {};
  supersetExercises.forEach(ex => {
    if (!supersetGroups[ex.supersetId]) supersetGroups[ex.supersetId] = [];
    supersetGroups[ex.supersetId].push(ex);
  });

  // Sort each group by supersetOrder
  Object.values(supersetGroups).forEach(group => {
    group.sort((a, b) => a.supersetOrder - b.supersetOrder);
  });

  // Interleave: compound exercises first, then supersets, then isolation
  const compounds = regularExercises.filter(ex => ex.type === 'compound');
  const isolations = regularExercises.filter(ex => ex.type !== 'compound');

  reordered.push(...compounds);
  Object.values(supersetGroups).forEach(group => reordered.push(...group));
  reordered.push(...isolations);

  return {
    exercises: reordered,
    supersets,
    timeSaved: Math.round(timeSaved / 60) // Return in minutes
  };
};

// Related muscle groups that shouldn't be trained back-to-back (synergists)
// These muscles assist each other and need recovery time between exercises
const RELATED_MUSCLE_GROUPS = {
  'Chest': ['Upper Chest', 'Front Delts', 'Triceps'],
  'Upper Chest': ['Chest', 'Front Delts', 'Triceps'],
  'Back': ['Lats', 'Rear Delts', 'Biceps', 'Traps'],
  'Lats': ['Back', 'Rear Delts', 'Biceps'],
  'Shoulders': ['Front Delts', 'Side Delts', 'Upper Chest'],
  'Front Delts': ['Shoulders', 'Chest', 'Upper Chest', 'Triceps'],
  'Side Delts': ['Shoulders', 'Rear Delts'],
  'Rear Delts': ['Back', 'Lats', 'Side Delts'],
  'Triceps': ['Chest', 'Upper Chest', 'Shoulders', 'Front Delts'],
  'Biceps': ['Back', 'Lats'],
  'Quads': ['Glutes'],
  'Hamstrings': ['Glutes', 'Lower Back'],
  'Glutes': ['Quads', 'Hamstrings', 'Lower Back'],
  'Calves': [],
  'Abs': ['Core', 'Obliques'],
  'Core': ['Abs', 'Obliques', 'Lower Back'],
  'Traps': ['Back', 'Rear Delts'],
  'Forearms': ['Biceps'],
};

// Check if two muscle groups are related (synergists)
const areMusclesRelated = (muscle1, muscle2) => {
  if (muscle1 === muscle2) return true;
  const related1 = RELATED_MUSCLE_GROUPS[muscle1] || [];
  const related2 = RELATED_MUSCLE_GROUPS[muscle2] || [];
  return related1.includes(muscle2) || related2.includes(muscle1);
};

// Reorder exercises to avoid same/related muscle groups back-to-back
// This allows for better recovery between exercises targeting the same muscles
const reorderExercisesForRecovery = (exercises) => {
  if (exercises.length <= 2) return exercises;

  const reordered = [];
  const remaining = [...exercises];

  // Start with compounds first (they're usually more important)
  remaining.sort((a, b) => {
    if (a.exerciseType === 'compound' && b.exerciseType !== 'compound') return -1;
    if (a.exerciseType !== 'compound' && b.exerciseType === 'compound') return 1;
    return 0;
  });

  // Take the first exercise (usually a primary compound)
  reordered.push(remaining.shift());

  // Greedily select exercises that don't target related muscles
  while (remaining.length > 0) {
    const lastExercise = reordered[reordered.length - 1];
    const lastMuscle = lastExercise.muscleGroup;

    // Find the best next exercise (not targeting related muscles)
    let bestIndex = -1;
    let bestScore = -1;

    for (let i = 0; i < remaining.length; i++) {
      const candidate = remaining[i];
      const candidateMuscle = candidate.muscleGroup;

      // Score based on how unrelated the muscle is
      let score = 0;
      if (!areMusclesRelated(lastMuscle, candidateMuscle)) {
        score = 10; // Great - completely unrelated
      } else if (lastMuscle !== candidateMuscle) {
        score = 5; // OK - related but not the same
      } else {
        score = 1; // Same muscle - least preferred
      }

      // Bonus for compounds early in the workout
      if (candidate.exerciseType === 'compound' && reordered.length < 3) {
        score += 2;
      }

      if (score > bestScore) {
        bestScore = score;
        bestIndex = i;
      }
    }

    // Take the best candidate (or first remaining if all are related)
    const nextIndex = bestIndex >= 0 ? bestIndex : 0;
    reordered.push(remaining.splice(nextIndex, 1)[0]);
  }

  return reordered;
};

// Get all target muscle groups from a workout structure
const getTargetMuscleGroups = (workoutType) => {
  const structure = WORKOUT_STRUCTURES[workoutType];
  if (!structure) return [];
  return [
    ...structure.primaryMuscles,
    ...structure.secondaryMuscles,
    ...structure.tertiaryMuscles
  ];
};

// Check which target muscles are covered by the current exercise list
const getMusclesCovered = (exercises) => {
  const covered = new Set();
  exercises.forEach(ex => {
    if (ex.muscleGroup && ex.muscleGroup !== 'Cardio') {
      covered.add(ex.muscleGroup);
    }
  });
  return covered;
};

// Find a compound exercise that covers multiple of the missing muscles
const findCompoundForMuscles = (targetMuscles, usedExerciseIds = []) => {
  // Look for compounds that hit any of the target muscles
  const compounds = DEFAULT_ALL_EXERCISES.filter(ex =>
    ex.type === 'compound' &&
    targetMuscles.includes(ex.muscleGroup) &&
    !usedExerciseIds.includes(ex.id || ex.name)
  );

  // Sort by how many target muscles they help with (via related muscles)
  compounds.sort((a, b) => {
    const aRelated = RELATED_MUSCLE_GROUPS[a.muscleGroup] || [];
    const bRelated = RELATED_MUSCLE_GROUPS[b.muscleGroup] || [];
    const aHits = targetMuscles.filter(m => m === a.muscleGroup || aRelated.includes(m)).length;
    const bHits = targetMuscles.filter(m => m === b.muscleGroup || bRelated.includes(m)).length;
    return bHits - aHits; // Higher hits first
  });

  return compounds[0] || null;
};

// Ensure all target muscle groups are covered when shortening a workout
// May swap isolation exercises for compounds to maintain coverage
const ensureMuscleGroupCoverage = (exercises, workoutType, fullExercisePool) => {
  const targetMuscles = getTargetMuscleGroups(workoutType);
  if (targetMuscles.length === 0) return exercises;

  let result = [...exercises];
  const covered = getMusclesCovered(result);
  const missing = targetMuscles.filter(m => !covered.has(m));

  if (missing.length === 0) return result; // All covered

  // Try to add compounds that cover missing muscles
  const usedIds = result.map(ex => ex.id);

  for (const missingMuscle of missing) {
    // First, check if we can find a compound in the pool that covers this
    const compound = findCompoundForMuscles([missingMuscle], usedIds);
    if (compound) {
      // Find an isolation exercise we can swap out (preferably targeting a muscle we have multiple exercises for)
      const muscleCount = {};
      result.forEach(ex => {
        if (ex.exerciseType !== 'compound') {
          muscleCount[ex.muscleGroup] = (muscleCount[ex.muscleGroup] || 0) + 1;
        }
      });

      // Find an isolation with duplicate muscle coverage
      const swapIndex = result.findIndex(ex =>
        ex.exerciseType !== 'compound' &&
        muscleCount[ex.muscleGroup] > 1 &&
        ex.muscleGroup !== missingMuscle
      );

      if (swapIndex >= 0) {
        // Swap the isolation for the compound
        result[swapIndex] = {
          id: compound.id || compound.name.toLowerCase().replace(/[^a-z0-9]/g, '_'),
          name: compound.name,
          sets: result[swapIndex].sets,
          targetReps: result[swapIndex].targetReps,
          suggestedWeight: 0,
          lastWeight: 0,
          lastReps: Array(result[swapIndex].sets).fill(result[swapIndex].targetReps),
          restTime: result[swapIndex].restTime + 30, // Compounds need more rest
          muscleGroup: compound.muscleGroup,
          equipment: compound.equipment,
          exerciseType: 'compound',
        };
        usedIds.push(compound.id || compound.name);
      }
    }
  }

  return result;
};

// Workout structure definitions (muscle groups to target, not specific exercises)
const WORKOUT_STRUCTURES = {
  push: {
    name: 'Push Day',
    primaryMuscles: ['Chest', 'Upper Chest'],
    secondaryMuscles: ['Shoulders', 'Side Delts'],
    tertiaryMuscles: ['Triceps'],
    exerciseCounts: { primary: 2, secondary: 2, tertiary: 1 },
    focus: 'Chest, Shoulders & Triceps',
  },
  pull: {
    name: 'Pull Day',
    primaryMuscles: ['Back', 'Lats'],
    secondaryMuscles: ['Rear Delts', 'Traps'],
    tertiaryMuscles: ['Biceps'],
    exerciseCounts: { primary: 3, secondary: 1, tertiary: 2 },
    focus: 'Back & Biceps',
  },
  legs_quad: {
    name: 'Leg Day (Quad Focus)',
    primaryMuscles: ['Quads'],
    secondaryMuscles: ['Hamstrings', 'Glutes'],
    tertiaryMuscles: ['Calves'],
    exerciseCounts: { primary: 3, secondary: 2, tertiary: 1 },
    focus: 'Quads, Hamstrings & Glutes',
  },
  legs_posterior: {
    name: 'Leg Day (Posterior Focus)',
    primaryMuscles: ['Hamstrings', 'Glutes'],
    secondaryMuscles: ['Quads'],
    tertiaryMuscles: ['Calves'],
    exerciseCounts: { primary: 3, secondary: 2, tertiary: 1 },
    focus: 'Hamstrings, Glutes & Quads',
  },
  upper: {
    name: 'Upper Body',
    primaryMuscles: ['Chest', 'Back', 'Lats'],
    secondaryMuscles: ['Shoulders', 'Side Delts'],
    tertiaryMuscles: ['Biceps', 'Triceps'],
    exerciseCounts: { primary: 3, secondary: 2, tertiary: 2 },
    focus: 'Chest, Back & Shoulders',
  },
  lower: {
    name: 'Lower Body',
    primaryMuscles: ['Quads', 'Hamstrings'],
    secondaryMuscles: ['Glutes'],
    tertiaryMuscles: ['Calves'],
    exerciseCounts: { primary: 3, secondary: 2, tertiary: 1 },
    focus: 'Full Leg Development',
  },
  full_body: {
    name: 'Full Body',
    primaryMuscles: ['Quads', 'Chest', 'Back'],
    secondaryMuscles: ['Shoulders', 'Hamstrings'],
    tertiaryMuscles: ['Biceps', 'Triceps'],
    exerciseCounts: { primary: 3, secondary: 2, tertiary: 2 },
    focus: 'Complete Body Training',
  },
  arms: {
    name: 'Arms Day',
    primaryMuscles: ['Biceps', 'Triceps'],
    secondaryMuscles: ['Forearms'],
    tertiaryMuscles: [],
    exerciseCounts: { primary: 4, secondary: 1, tertiary: 0 },
    focus: 'Biceps & Triceps',
  },
  // Bro split specific days
  chest: {
    name: 'Chest Day',
    primaryMuscles: ['Chest', 'Upper Chest'],
    secondaryMuscles: ['Front Delts'],
    tertiaryMuscles: ['Triceps'],
    exerciseCounts: { primary: 4, secondary: 1, tertiary: 1 },
    focus: 'Complete Chest Development',
  },
  back: {
    name: 'Back Day',
    primaryMuscles: ['Back', 'Lats'],
    secondaryMuscles: ['Rear Delts', 'Traps'],
    tertiaryMuscles: ['Biceps'],
    exerciseCounts: { primary: 4, secondary: 1, tertiary: 1 },
    focus: 'Complete Back Development',
  },
  shoulders: {
    name: 'Shoulders Day',
    primaryMuscles: ['Shoulders', 'Side Delts', 'Front Delts'],
    secondaryMuscles: ['Rear Delts', 'Traps'],
    tertiaryMuscles: [],
    exerciseCounts: { primary: 4, secondary: 2, tertiary: 0 },
    focus: 'Complete Shoulder Development',
  },
};

// Core/Ab exercises for finishers
const CORE_MUSCLE_GROUPS = ['Abs', 'Core', 'Obliques'];

// Cardio exercises for weight loss goals
const CARDIO_EXERCISES = [
  { name: 'Treadmill Intervals', duration: 15, description: '30s sprint / 60s walk intervals', type: 'cardio', caloriesBurned: 200 },
  { name: 'Rowing Machine', duration: 10, description: 'Moderate intensity, focus on full strokes', type: 'cardio', caloriesBurned: 150 },
  { name: 'Stair Climber', duration: 12, description: 'Steady state, level 6-8', type: 'cardio', caloriesBurned: 180 },
  { name: 'Jump Rope', duration: 10, description: '30s on / 15s rest intervals', type: 'cardio', caloriesBurned: 160 },
  { name: 'Stationary Bike HIIT', duration: 15, description: '20s max effort / 40s recovery', type: 'cardio', caloriesBurned: 190 },
  { name: 'Battle Ropes', duration: 8, description: '20s work / 20s rest', type: 'cardio', caloriesBurned: 120 },
  { name: 'Burpees', duration: 10, description: '10 reps x 5 sets with 30s rest', type: 'cardio', caloriesBurned: 150 },
  { name: 'Mountain Climbers', duration: 8, description: '30s on / 30s rest', type: 'cardio', caloriesBurned: 100 },
];

// ============================================
// INJURY RECOVERY SYSTEM
// ============================================

// Injury severity levels with recovery time multipliers
const INJURY_SEVERITY = {
  mild: { label: 'Mild', description: 'Minor discomfort, slight pain', multiplier: 1, color: '#fbbf24' },
  moderate: { label: 'Moderate', description: 'Noticeable pain, limited movement', multiplier: 1.5, color: '#f97316' },
  severe: { label: 'Severe', description: 'Significant pain, major limitation', multiplier: 2.5, color: '#ef4444' },
};

// Recovery phases with descriptions
const RECOVERY_PHASES = {
  rest: {
    name: 'Rest & Protect',
    description: 'Complete rest for the injured area. Focus on reducing inflammation.',
    icon: '',
    tips: [
      'Apply ice for 15-20 minutes every 2-3 hours',
      'Keep the injured area elevated when possible',
      'Avoid any movements that cause pain',
      'Stay hydrated and eat anti-inflammatory foods',
      'Get plenty of sleep for tissue repair',
    ],
  },
  recovery: {
    name: 'Active Recovery',
    description: 'Gentle movement and stretching to restore mobility.',
    icon: '',
    tips: [
      'Start with gentle range of motion exercises',
      'Light stretching - never push through pain',
      'Consider foam rolling nearby muscles',
      'Short walks to maintain general fitness',
      'Listen to your body and rest if needed',
    ],
  },
  strengthening: {
    name: 'Rebuilding Strength',
    description: 'Progressive loading to restore muscle strength.',
    icon: '',
    tips: [
      'Start with bodyweight or very light weights',
      'Focus on controlled movements',
      'Gradually increase resistance over time',
      'Include stability and balance work',
      'Stop immediately if you feel sharp pain',
    ],
  },
  return: {
    name: 'Return to Training',
    description: 'Gradually return to your normal workout routine.',
    icon: '',
    tips: [
      'Start at 50-70% of your previous intensity',
      'Increase volume before intensity',
      'Include extra warm-up for the affected area',
      'Monitor for any pain or discomfort',
      'Be patient - full recovery takes time',
    ],
  },
};

// Base recovery timelines (in days) for each muscle group by injury type
const INJURY_RECOVERY_DATA = {
  // Upper Body
  'Chest': { baseDays: 7, restPercent: 30, recoveryPercent: 30, strengthenPercent: 25, relatedMuscles: ['Upper Chest', 'Front Delts', 'Triceps'] },
  'Upper Chest': { baseDays: 7, restPercent: 30, recoveryPercent: 30, strengthenPercent: 25, relatedMuscles: ['Chest', 'Front Delts'] },
  'Back': { baseDays: 10, restPercent: 35, recoveryPercent: 30, strengthenPercent: 25, relatedMuscles: ['Lats', 'Rear Delts', 'Biceps'] },
  'Lats': { baseDays: 8, restPercent: 30, recoveryPercent: 35, strengthenPercent: 25, relatedMuscles: ['Back', 'Biceps'] },
  'Shoulders': { baseDays: 14, restPercent: 40, recoveryPercent: 30, strengthenPercent: 20, relatedMuscles: ['Front Delts', 'Side Delts', 'Rear Delts'] },
  'Front Delts': { baseDays: 10, restPercent: 35, recoveryPercent: 30, strengthenPercent: 25, relatedMuscles: ['Shoulders', 'Chest'] },
  'Side Delts': { baseDays: 8, restPercent: 30, recoveryPercent: 35, strengthenPercent: 25, relatedMuscles: ['Shoulders'] },
  'Rear Delts': { baseDays: 8, restPercent: 30, recoveryPercent: 35, strengthenPercent: 25, relatedMuscles: ['Shoulders', 'Back'] },
  'Biceps': { baseDays: 7, restPercent: 25, recoveryPercent: 35, strengthenPercent: 30, relatedMuscles: ['Forearms'] },
  'Triceps': { baseDays: 7, restPercent: 25, recoveryPercent: 35, strengthenPercent: 30, relatedMuscles: ['Chest', 'Shoulders'] },
  'Forearms': { baseDays: 10, restPercent: 35, recoveryPercent: 35, strengthenPercent: 20, relatedMuscles: ['Biceps'] },
  // Lower Body
  'Quads': { baseDays: 10, restPercent: 30, recoveryPercent: 35, strengthenPercent: 25, relatedMuscles: ['Glutes'] },
  'Hamstrings': { baseDays: 14, restPercent: 40, recoveryPercent: 30, strengthenPercent: 20, relatedMuscles: ['Glutes', 'Lower Back'] },
  'Glutes': { baseDays: 10, restPercent: 30, recoveryPercent: 35, strengthenPercent: 25, relatedMuscles: ['Quads', 'Hamstrings'] },
  'Calves': { baseDays: 10, restPercent: 35, recoveryPercent: 35, strengthenPercent: 20, relatedMuscles: [] },
  'Hip Flexors': { baseDays: 12, restPercent: 35, recoveryPercent: 35, strengthenPercent: 20, relatedMuscles: ['Quads', 'Core'] },
  // Core & Back
  'Abs': { baseDays: 7, restPercent: 25, recoveryPercent: 40, strengthenPercent: 25, relatedMuscles: ['Core', 'Obliques'] },
  'Core': { baseDays: 10, restPercent: 30, recoveryPercent: 40, strengthenPercent: 20, relatedMuscles: ['Abs', 'Lower Back'] },
  'Lower Back': { baseDays: 21, restPercent: 45, recoveryPercent: 30, strengthenPercent: 15, relatedMuscles: ['Core', 'Glutes', 'Hamstrings'] },
  'Obliques': { baseDays: 7, restPercent: 25, recoveryPercent: 40, strengthenPercent: 25, relatedMuscles: ['Abs', 'Core'] },
  'Traps': { baseDays: 10, restPercent: 35, recoveryPercent: 35, strengthenPercent: 20, relatedMuscles: ['Shoulders', 'Back'] },
  // General
  'Neck': { baseDays: 14, restPercent: 50, recoveryPercent: 30, strengthenPercent: 15, relatedMuscles: ['Traps'] },
  'Groin': { baseDays: 14, restPercent: 40, recoveryPercent: 35, strengthenPercent: 15, relatedMuscles: ['Hip Flexors', 'Quads'] },
  'Knee': { baseDays: 21, restPercent: 45, recoveryPercent: 30, strengthenPercent: 15, relatedMuscles: ['Quads', 'Hamstrings', 'Calves'] },
  'Ankle': { baseDays: 14, restPercent: 40, recoveryPercent: 35, strengthenPercent: 15, relatedMuscles: ['Calves'] },
  'Wrist': { baseDays: 14, restPercent: 40, recoveryPercent: 35, strengthenPercent: 15, relatedMuscles: ['Forearms'] },
  'Elbow': { baseDays: 21, restPercent: 45, recoveryPercent: 30, strengthenPercent: 15, relatedMuscles: ['Biceps', 'Triceps', 'Forearms'] },
};

// Warmup exercises for each muscle group (dynamic stretches & activation)
const WARMUP_EXERCISES = {
  'General': [
    { name: 'Jumping Jacks', duration: '30 sec', description: 'Get heart rate up' },
    { name: 'High Knees', duration: '30 sec', description: 'Drive knees up, pump arms' },
    { name: 'Arm Circles', duration: '30 sec', description: 'Small to large circles' },
  ],
  'Chest': [
    { name: 'Arm Swings', duration: '30 sec', description: 'Horizontal arm swings across body' },
    { name: 'Push-up Plus', duration: '10 reps', description: 'Push-up position, protract shoulders' },
    { name: 'Band Pull-Aparts', duration: '15 reps', description: 'Light band, warm up shoulders' },
  ],
  'Back': [
    { name: 'Cat-Cow', duration: '30 sec', description: 'Mobilize the spine' },
    { name: 'Scapular Push-ups', duration: '10 reps', description: 'Activate serratus anterior' },
    { name: 'Band Face Pulls', duration: '15 reps', description: 'Light band, external rotation' },
  ],
  'Shoulders': [
    { name: 'Arm Circles', duration: '30 sec each direction', description: 'Small to large circles' },
    { name: 'Band Dislocates', duration: '10 reps', description: 'Wide grip, controlled motion' },
    { name: 'Wall Slides', duration: '10 reps', description: 'Back to wall, slide arms up' },
  ],
  'Biceps': [
    { name: 'Wrist Circles', duration: '30 sec', description: 'Both directions' },
    { name: 'Light Band Curls', duration: '15 reps', description: 'Get blood flowing' },
    { name: 'Arm Swings', duration: '30 sec', description: 'Front to back' },
  ],
  'Triceps': [
    { name: 'Arm Circles', duration: '30 sec', description: 'Focus on tricep engagement' },
    { name: 'Light Pushdowns', duration: '15 reps', description: 'Band or very light cable' },
    { name: 'Tricep Stretch', duration: '20 sec each', description: 'Overhead stretch' },
  ],
  'Quads': [
    { name: 'Leg Swings', duration: '30 sec each leg', description: 'Front to back motion' },
    { name: 'Bodyweight Squats', duration: '15 reps', description: 'Full range, controlled' },
    { name: 'Walking Lunges', duration: '10 each leg', description: 'Dynamic stretch' },
  ],
  'Hamstrings': [
    { name: 'Leg Swings', duration: '30 sec each', description: 'Front to back, hip height' },
    { name: 'Inchworms', duration: '8 reps', description: 'Walk hands out, walk feet up' },
    { name: 'Good Mornings', duration: '10 reps', description: 'Bodyweight hip hinge' },
  ],
  'Glutes': [
    { name: 'Hip Circles', duration: '30 sec each direction', description: 'Large controlled circles' },
    { name: 'Glute Bridges', duration: '15 reps', description: 'Activate glutes' },
    { name: 'Clamshells', duration: '12 each side', description: 'Fire up hip abductors' },
  ],
  'Hamstrings/Glutes': [
    { name: 'Hip Circles', duration: '30 sec each direction', description: 'Large controlled circles' },
    { name: 'Glute Bridges', duration: '15 reps', description: 'Activate posterior chain' },
    { name: 'Leg Swings', duration: '30 sec each', description: 'Front to back motion' },
  ],
  'Core': [
    { name: 'Cat-Cow', duration: '30 sec', description: 'Mobilize the spine' },
    { name: 'Dead Bug', duration: '8 each side', description: 'Activate deep core' },
    { name: 'Bird Dog', duration: '8 each side', description: 'Core stability' },
  ],
  'Calves': [
    { name: 'Ankle Circles', duration: '30 sec each', description: 'Both directions' },
    { name: 'Calf Raises', duration: '15 reps', description: 'Slow, full range' },
    { name: 'Toe Walks', duration: '30 sec', description: 'Walk on tiptoes' },
  ],
};

// Cooldown exercises for each muscle group (static stretches & recovery)
const COOLDOWN_EXERCISES = {
  'General': [
    { name: 'Deep Breathing', duration: '1 min', description: 'Slow diaphragmatic breaths' },
    { name: 'Standing Forward Fold', duration: '30 sec', description: 'Let upper body hang' },
  ],
  'Chest': [
    { name: 'Doorway Stretch', duration: '30 sec each side', description: 'Elbow at 90 degrees' },
    { name: 'Cross-Body Stretch', duration: '30 sec each', description: 'Pull arm across chest' },
  ],
  'Back': [
    { name: 'Child\'s Pose', duration: '45 sec', description: 'Arms extended, sink hips back' },
    { name: 'Cat-Cow Stretch', duration: '30 sec', description: 'Slow, controlled movements' },
  ],
  'Shoulders': [
    { name: 'Cross-Body Stretch', duration: '30 sec each', description: 'Pull arm across chest' },
    { name: 'Overhead Tricep Stretch', duration: '30 sec each', description: 'Also stretches shoulders' },
  ],
  'Biceps': [
    { name: 'Wall Bicep Stretch', duration: '30 sec each', description: 'Palm on wall, turn away' },
    { name: 'Seated Bicep Stretch', duration: '30 sec', description: 'Fingers pointing back' },
  ],
  'Triceps': [
    { name: 'Overhead Tricep Stretch', duration: '30 sec each', description: 'Elbow points up' },
    { name: 'Towel Stretch', duration: '30 sec each', description: 'Behind back stretch' },
  ],
  'Quads': [
    { name: 'Standing Quad Stretch', duration: '30 sec each', description: 'Pull heel to glute' },
    { name: 'Kneeling Hip Flexor Stretch', duration: '30 sec each', description: 'Lunge position stretch' },
  ],
  'Hamstrings': [
    { name: 'Seated Hamstring Stretch', duration: '45 sec', description: 'Reach for toes' },
    { name: 'Standing Hamstring Stretch', duration: '30 sec each', description: 'Foot elevated' },
  ],
  'Glutes': [
    { name: 'Pigeon Pose', duration: '45 sec each', description: 'Deep hip opener' },
    { name: 'Figure Four Stretch', duration: '30 sec each', description: 'Lying on back' },
  ],
  'Hamstrings/Glutes': [
    { name: 'Pigeon Pose', duration: '45 sec each', description: 'Deep hip opener' },
    { name: 'Seated Hamstring Stretch', duration: '45 sec', description: 'Reach for toes' },
  ],
  'Core': [
    { name: 'Cobra Stretch', duration: '30 sec', description: 'Gentle back extension' },
    { name: 'Supine Twist', duration: '30 sec each side', description: 'Knees to side, look opposite' },
  ],
  'Calves': [
    { name: 'Wall Calf Stretch', duration: '30 sec each', description: 'Heel down, lean forward' },
    { name: 'Downward Dog', duration: '45 sec', description: 'Press heels toward floor' },
  ],
};

// Recovery exercises for each muscle group
const RECOVERY_EXERCISES = {
  'Chest': [
    { name: 'Chest Stretch', duration: '30 sec each side', description: 'Doorway stretch, gentle hold' },
    { name: 'Arm Circles', duration: '1 min', description: 'Small to large circles, both directions' },
    { name: 'Wall Push-ups', duration: '2x10', description: 'Very light, focus on range of motion' },
  ],
  'Back': [
    { name: 'Cat-Cow Stretch', duration: '1 min', description: 'Slow, controlled movements' },
    { name: 'Child\'s Pose', duration: '1 min', description: 'Gentle lat stretch' },
    { name: 'Prone Y Raises', duration: '2x10', description: 'No weight, focus on activation' },
  ],
  'Shoulders': [
    { name: 'Pendulum Swings', duration: '1 min each arm', description: 'Let arm hang and swing gently' },
    { name: 'Wall Slides', duration: '2x10', description: 'Back against wall, slide arms up' },
    { name: 'Band Pull-Aparts', duration: '2x15', description: 'Very light band' },
  ],
  'Biceps': [
    { name: 'Bicep Stretch', duration: '30 sec each arm', description: 'Arm extended, palm on wall' },
    { name: 'Wrist Rotations', duration: '1 min', description: 'Gentle circles both directions' },
    { name: 'Light Curls', duration: '2x15', description: '1-2kg max, full range of motion' },
  ],
  'Triceps': [
    { name: 'Tricep Stretch', duration: '30 sec each arm', description: 'Overhead stretch' },
    { name: 'Arm Extensions', duration: '2x15', description: 'No weight, focus on extension' },
  ],
  'Quads': [
    { name: 'Quad Stretch', duration: '30 sec each leg', description: 'Standing or lying' },
    { name: 'Leg Swings', duration: '1 min each leg', description: 'Front to back, controlled' },
    { name: 'Wall Sits', duration: '3x15 sec', description: 'Shallow angle, no pain' },
  ],
  'Hamstrings': [
    { name: 'Hamstring Stretch', duration: '30 sec each leg', description: 'Seated or lying' },
    { name: 'Good Mornings', duration: '2x10', description: 'No weight, gentle hinge' },
    { name: 'Glute Bridges', duration: '2x12', description: 'Focus on hamstring engagement' },
  ],
  'Glutes': [
    { name: 'Pigeon Stretch', duration: '30 sec each side', description: 'Gentle hip opener' },
    { name: 'Clamshells', duration: '2x15 each side', description: 'Side lying, no band' },
    { name: 'Glute Bridges', duration: '2x12', description: 'Bodyweight only' },
  ],
  'Lower Back': [
    { name: 'Knee to Chest', duration: '30 sec each leg', description: 'Lying on back' },
    { name: 'Pelvic Tilts', duration: '2x15', description: 'Lying on back, gentle movement' },
    { name: 'Bird Dogs', duration: '2x8 each side', description: 'Slow and controlled' },
  ],
  'Core': [
    { name: 'Dead Bug', duration: '2x8 each side', description: 'Slow, controlled movement' },
    { name: 'Diaphragmatic Breathing', duration: '2 min', description: 'Deep belly breaths' },
    { name: 'Gentle Planks', duration: '3x15 sec', description: 'On knees if needed' },
  ],
};

// Restrengthening exercises (progressive loading)
const RESTRENGTHENING_EXERCISES = {
  'Chest': [
    { name: 'Incline Push-ups', sets: 3, reps: 12, description: 'Hands elevated, controlled tempo' },
    { name: 'Light Dumbbell Press', sets: 3, reps: 12, description: 'Start with 50% usual weight' },
    { name: 'Cable Flyes', sets: 3, reps: 15, description: 'Light weight, full stretch' },
  ],
  'Back': [
    { name: 'Banded Rows', sets: 3, reps: 15, description: 'Focus on squeeze at top' },
    { name: 'Light Lat Pulldowns', sets: 3, reps: 12, description: 'Controlled negative' },
    { name: 'Face Pulls', sets: 3, reps: 15, description: 'Light band, external rotation' },
  ],
  'Shoulders': [
    { name: 'Band External Rotation', sets: 3, reps: 15, description: 'Elbow at side' },
    { name: 'Light Lateral Raises', sets: 3, reps: 15, description: 'Very light, controlled' },
    { name: 'Y-T-W Raises', sets: 2, reps: 10, description: 'Prone position, no weight' },
  ],
  'Quads': [
    { name: 'Bodyweight Squats', sets: 3, reps: 12, description: 'Controlled, pain-free range' },
    { name: 'Step Ups', sets: 3, reps: 10, description: 'Low step, focus on control' },
    { name: 'Leg Extensions', sets: 3, reps: 15, description: 'Light weight, full extension' },
  ],
  'Hamstrings': [
    { name: 'Romanian Deadlifts', sets: 3, reps: 10, description: 'Very light, focus on stretch' },
    { name: 'Stability Ball Curls', sets: 3, reps: 12, description: 'Slow and controlled' },
    { name: 'Single Leg Glute Bridges', sets: 3, reps: 10, description: 'Focus on hamstring' },
  ],
  'Lower Back': [
    { name: 'Superman Holds', sets: 3, reps: '10 sec', description: 'Gentle, don\'t overextend' },
    { name: 'Hip Hinges', sets: 3, reps: 12, description: 'No weight, perfect form' },
    { name: 'Kettlebell Deadlifts', sets: 3, reps: 10, description: 'Very light, controlled' },
  ],
};

// Motivational coaching messages for each phase
const COACHING_MESSAGES = {
  rest: [
    "Rest is not giving up - it's part of getting stronger. Your body is healing right now.",
    "Every day of proper rest is an investment in your future performance. Trust the process.",
    "The strongest athletes know when to rest. You're making the right choice.",
    "Your muscles are rebuilding right now. Give them the time they need.",
    "Recovery is where the magic happens. You're doing great by listening to your body.",
  ],
  recovery: [
    "You're making progress! Gentle movement is exactly what your body needs right now.",
    "Each small movement is a step toward full recovery. Keep going!",
    "You're in the healing zone now. These exercises are rebuilding your strength foundation.",
    "Moving again feels good, doesn't it? Your body is responding well.",
    "Patience and persistence - you've got both. Recovery is going well!",
  ],
  strengthening: [
    "You're getting stronger every day! Your body has healed and is ready to rebuild.",
    "This is exciting - you're rebuilding better than before. Stay focused!",
    "Controlled progress is smart progress. You're doing this the right way.",
    "Your comeback is happening right now. Each rep is bringing you back stronger.",
    "The finish line is in sight. Keep up the amazing work!",
  ],
  return: [
    "Welcome back! You've earned this through patience and smart training.",
    "You did it the right way - full recovery means you're back for good.",
    "Stronger, smarter, and ready to crush it. Your dedication paid off!",
    "This injury taught you something valuable. Now go show what you've got!",
    "Full strength, full confidence. Time to get after it!",
  ],
};

// Calculate recovery timeline for an injury
const calculateRecoveryTimeline = (muscleGroup, severity, startDate) => {
  const recoveryData = INJURY_RECOVERY_DATA[muscleGroup] || INJURY_RECOVERY_DATA['Core'];
  const severityData = INJURY_SEVERITY[severity] || INJURY_SEVERITY.moderate;

  const totalDays = Math.round(recoveryData.baseDays * severityData.multiplier);
  const restDays = Math.round(totalDays * (recoveryData.restPercent / 100));
  const recoveryDays = Math.round(totalDays * (recoveryData.recoveryPercent / 100));
  const strengthenDays = Math.round(totalDays * (recoveryData.strengthenPercent / 100));
  const returnDays = totalDays - restDays - recoveryDays - strengthenDays;

  const start = new Date(startDate);

  return {
    totalDays,
    phases: {
      rest: {
        startDate: start.toISOString(),
        endDate: new Date(start.getTime() + restDays * 24 * 60 * 60 * 1000).toISOString(),
        days: restDays,
      },
      recovery: {
        startDate: new Date(start.getTime() + restDays * 24 * 60 * 60 * 1000).toISOString(),
        endDate: new Date(start.getTime() + (restDays + recoveryDays) * 24 * 60 * 60 * 1000).toISOString(),
        days: recoveryDays,
      },
      strengthening: {
        startDate: new Date(start.getTime() + (restDays + recoveryDays) * 24 * 60 * 60 * 1000).toISOString(),
        endDate: new Date(start.getTime() + (restDays + recoveryDays + strengthenDays) * 24 * 60 * 60 * 1000).toISOString(),
        days: strengthenDays,
      },
      return: {
        startDate: new Date(start.getTime() + (restDays + recoveryDays + strengthenDays) * 24 * 60 * 60 * 1000).toISOString(),
        endDate: new Date(start.getTime() + totalDays * 24 * 60 * 60 * 1000).toISOString(),
        days: returnDays,
      },
    },
    expectedRecoveryDate: new Date(start.getTime() + totalDays * 24 * 60 * 60 * 1000).toISOString(),
    affectedMuscles: [muscleGroup, ...(recoveryData.relatedMuscles || [])],
  };
};

// Get current recovery phase for an injury
const getCurrentRecoveryPhase = (injury) => {
  if (!injury || !injury.timeline) return null;

  const now = new Date();
  const { phases } = injury.timeline;

  for (const [phaseName, phaseData] of Object.entries(phases)) {
    const start = new Date(phaseData.startDate);
    const end = new Date(phaseData.endDate);
    if (now >= start && now < end) {
      const daysIntoPhase = Math.floor((now - start) / (24 * 60 * 60 * 1000));
      const daysRemaining = Math.ceil((end - now) / (24 * 60 * 60 * 1000));
      return {
        phase: phaseName,
        ...RECOVERY_PHASES[phaseName],
        daysIntoPhase,
        daysRemaining,
        percentComplete: Math.round((daysIntoPhase / phaseData.days) * 100),
      };
    }
  }

  // If past all phases, return completed
  const recoveryEnd = new Date(injury.timeline.expectedRecoveryDate);
  if (now >= recoveryEnd) {
    return { phase: 'completed', name: 'Fully Recovered', icon: '', percentComplete: 100 };
  }

  return null;
};

// Get a random coaching message for the current phase
const getCoachingMessage = (phase) => {
  const messages = COACHING_MESSAGES[phase] || COACHING_MESSAGES.rest;
  return messages[Math.floor(Math.random() * messages.length)];
};

// Check if a muscle group is injured and should be avoided
const isMuscleInjured = (muscleGroup, injuries) => {
  if (!injuries || injuries.length === 0) return false;

  return injuries.some(injury => {
    if (!injury.active) return false;
    const phase = getCurrentRecoveryPhase(injury);
    // During rest phase, avoid all related muscles
    if (phase?.phase === 'rest') {
      return injury.timeline.affectedMuscles.includes(muscleGroup);
    }
    // During recovery phase, still avoid direct work on the injured muscle
    if (phase?.phase === 'recovery') {
      return injury.muscleGroup === muscleGroup;
    }
    return false;
  });
};

// Get recovery exercises to add to a workout based on current injuries
const getRecoveryExercisesForWorkout = (injuries) => {
  const exercises = [];

  injuries.forEach(injury => {
    if (!injury.active) return;
    const phase = getCurrentRecoveryPhase(injury);

    if (phase?.phase === 'recovery') {
      const recoveryExs = RECOVERY_EXERCISES[injury.muscleGroup] || RECOVERY_EXERCISES['Core'];
      exercises.push(...recoveryExs.map(ex => ({
        ...ex,
        isRecovery: true,
        forInjury: injury.muscleGroup,
        phase: 'recovery',
      })));
    } else if (phase?.phase === 'strengthening') {
      const strengthExs = RESTRENGTHENING_EXERCISES[injury.muscleGroup] || [];
      if (strengthExs.length > 0) {
        // Add 1-2 restrengthening exercises
        exercises.push(...strengthExs.slice(0, 2).map(ex => ({
          ...ex,
          isRecovery: true,
          forInjury: injury.muscleGroup,
          phase: 'strengthening',
        })));
      }
    }
  });

  return exercises;
};

// Helper: Get random element from array
const getRandomElement = (arr) => arr[Math.floor(Math.random() * arr.length)];

// Helper: Get random number in range (inclusive)
const getRandomInRange = (min, max) => Math.floor(Math.random() * (max - min + 1)) + min;

// Helper: Shuffle array (Fisher-Yates)
const shuffleArray = (arr) => {
  const shuffled = [...arr];
  for (let i = shuffled.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
  }
  return shuffled;
};

// Generate a unique exercise ID
const generateExerciseId = (name) => name.toLowerCase().replace(/[^a-z0-9]/g, '_') + '_' + Math.random().toString(36).substr(2, 5);

// Select exercises for a muscle group, avoiding recently used ones
const selectExercisesForMuscleGroup = (muscleGroups, count, usedExercises = [], preferCompound = true, allExercises = []) => {
  // Get all exercises for these muscle groups
  let available = allExercises.filter(ex => muscleGroups.includes(ex.muscleGroup));

  // Filter out recently used exercises
  available = available.filter(ex => !usedExercises.includes(ex.name));

  // Sort: compounds first if preferred
  if (preferCompound) {
    available.sort((a, b) => {
      if (a.type === 'compound' && b.type !== 'compound') return -1;
      if (a.type !== 'compound' && b.type === 'compound') return 1;
      return 0;
    });
  }

  // Shuffle within type groups for variety
  const compounds = shuffleArray(available.filter(ex => ex.type === 'compound'));
  const isolations = shuffleArray(available.filter(ex => ex.type === 'isolation'));

  // Take the required count, preferring compounds for first exercises
  const selected = [];
  const pool = preferCompound ? [...compounds, ...isolations] : shuffleArray(available);

  for (let i = 0; i < Math.min(count, pool.length); i++) {
    selected.push(pool[i]);
  }

  return selected;
};

// Map old template IDs to workout types for backwards compatibility
const TEMPLATE_TO_WORKOUT_TYPE = {
  push_a: 'push', push_b: 'push',
  pull_a: 'pull', pull_b: 'pull',
  legs_a: 'legs_quad', legs_b: 'legs_posterior',
  upper_a: 'upper', upper_b: 'upper',
  lower: 'lower',
  full_body_a: 'full_body', full_body_b: 'full_body',
  arms: 'arms',
  chest_specialization: 'push',
  back_specialization: 'pull',
  leg_specialization: 'lower',
  powerlifting_squat: 'legs_quad',
  powerlifting_bench: 'push',
  powerlifting_deadlift: 'pull',
  athletic_power: 'full_body',
};

// Generate a complete dynamic workout
const generateDynamicWorkout = (workoutType, userGoal = 'build_muscle', recentlyUsedExercises = [], userExperience = 'beginner', allExercises = [], userStats = {}) => {
  // Map old template IDs to new workout types for backwards compatibility
  const mappedType = TEMPLATE_TO_WORKOUT_TYPE[workoutType] || workoutType;
  const structure = WORKOUT_STRUCTURES[mappedType];
  if (!structure) {
    return null;
  }

  const params = GOAL_TRAINING_PARAMS[userGoal] || GOAL_TRAINING_PARAMS.build_muscle;
  const usedInThisWorkout = [...recentlyUsedExercises];
  const exercises = [];
  const isAdvanced = ['experienced', 'expert'].includes(userExperience);

  // Generate exercises for primary muscle groups
  const primaryExercises = selectExercisesForMuscleGroup(
    structure.primaryMuscles,
    structure.exerciseCounts.primary,
    usedInThisWorkout,
    params.compoundFirst,
    allExercises
  );
  primaryExercises.forEach(ex => usedInThisWorkout.push(ex.name));

  // Generate exercises for secondary muscle groups
  const secondaryExercises = selectExercisesForMuscleGroup(
    structure.secondaryMuscles,
    structure.exerciseCounts.secondary,
    usedInThisWorkout,
    false,
    allExercises
  );
  secondaryExercises.forEach(ex => usedInThisWorkout.push(ex.name));

  // Generate exercises for tertiary muscle groups
  const tertiaryExercises = selectExercisesForMuscleGroup(
    structure.tertiaryMuscles,
    structure.exerciseCounts.tertiary,
    usedInThisWorkout,
    false,
    allExercises
  );
  tertiaryExercises.forEach(ex => usedInThisWorkout.push(ex.name));

  // Combine and format exercises
  const allSelected = [...primaryExercises, ...secondaryExercises, ...tertiaryExercises];

  allSelected.forEach((ex, index) => {
    const sets = getRandomInRange(params.setsPerExercise[0], params.setsPerExercise[1]);
    const reps = getRandomInRange(params.repsPerSet[0], params.repsPerSet[1]);
    const rest = getRandomInRange(params.restTime[0], params.restTime[1]);

    // Compounds get longer rest, isolations get shorter
    const adjustedRest = ex.type === 'compound' ? rest + 30 : rest - 15;

    // Calculate suggested weight based on user stats
    const weightStats = {
      bodyWeight: parseFloat(userStats.currentWeight) || parseFloat(userStats.weight) || 70,
      experience: userExperience,
      gender: userStats.gender || 'male',
      goal: userGoal,
    };
    const calculatedWeight = calculateSuggestedWeight(ex.name, weightStats, reps);

    exercises.push({
      id: generateExerciseId(ex.name),
      name: ex.name,
      sets: sets,
      targetReps: reps,
      suggestedWeight: calculatedWeight,
      lastWeight: 0,
      lastReps: Array(sets).fill(reps),
      restTime: Math.max(30, adjustedRest),
      muscleGroup: ex.muscleGroup,
      equipment: ex.equipment,
      exerciseType: ex.type,
      targetedHeads: isAdvanced && ex.targetedHeads ? ex.targetedHeads : null, // Show for advanced users
    });
  });

  // Add a core/ab finisher
  const coreExercises = selectExercisesForMuscleGroup(
    CORE_MUSCLE_GROUPS,
    1,
    usedInThisWorkout,
    false,
    allExercises
  );

  if (coreExercises.length > 0) {
    const coreEx = coreExercises[0];
    const isHold = coreEx.name.includes('Plank') || coreEx.name.includes('Hold') || coreEx.name.includes('L-Sit');
    const coreReps = isHold ? 45 : 15;
    // Calculate core exercise weight (most are bodyweight so will return 0)
    const coreWeightStats = {
      bodyWeight: parseFloat(userStats.currentWeight) || parseFloat(userStats.weight) || 70,
      experience: userExperience,
      gender: userStats.gender || 'male',
      goal: userGoal,
    };
    const coreWeight = calculateSuggestedWeight(coreEx.name, coreWeightStats, coreReps);

    exercises.push({
      id: generateExerciseId(coreEx.name),
      name: coreEx.name,
      sets: 3,
      targetReps: coreReps, // Seconds for holds, reps for movements
      suggestedWeight: coreWeight,
      lastWeight: 0,
      lastReps: isHold ? [45, 40, 35] : [15, 12, 10],
      restTime: 45,
      muscleGroup: coreEx.muscleGroup,
      equipment: coreEx.equipment,
      exerciseType: coreEx.type,
    });
  }

  // Add cardio for weight loss / lean goals
  let cardioExercise = null;
  if (['lose_fat', 'lean', 'fitness'].includes(userGoal)) {
    const cardio = getRandomElement(CARDIO_EXERCISES);
    cardioExercise = {
      id: generateExerciseId(cardio.name),
      name: cardio.name,
      sets: 1,
      targetReps: cardio.duration, // Duration in minutes
      isCardio: true,
      duration: cardio.duration,
      description: cardio.description,
      caloriesBurned: cardio.caloriesBurned,
      restTime: 0,
      muscleGroup: 'Cardio',
      exerciseType: 'cardio',
    };
    exercises.push(cardioExercise);
  }

  // Generate goal-specific workout explanation
  const goalExplanations = {
    bulk: `High-volume training with moderate reps to maximize muscle growth. Compounds first for strength, followed by isolation work for detail.`,
    build_muscle: `Balanced hypertrophy focus with 8-12 rep ranges. Exercise selection targets all heads of each muscle group for complete development.`,
    strength: `Lower rep ranges with longer rest periods to maximize neural adaptation. Heavy compounds prioritized for strength gains.`,
    recomp: `Moderate volume with compound movements to build muscle while burning calories. Balanced approach for body composition.`,
    fitness: `Higher rep ranges with shorter rest to improve muscular endurance and cardiovascular health. Full body engagement.`,
    athletic: `Power-focused movements with moderate reps. Exercises selected for functional strength and explosive power.`,
    lean: `Higher reps with minimal rest to elevate heart rate. Compound movements maximize calorie burn while preserving muscle.`,
    lose_fat: `Circuit-style training with cardio finisher. Shorter rest keeps heart rate elevated for maximum fat burning while maintaining muscle.`,
  };

  const explanation = goalExplanations[userGoal] || goalExplanations.build_muscle;

  // Create detailed workout reasoning
  const primaryMuscleNames = structure.primaryMuscles.join(', ');
  const todaysFocus = `Today's focus is ${structure.focus.toLowerCase()}, targeting ${primaryMuscleNames} as the primary muscle groups.`;
  const goalRationale = explanation;
  const exerciseRationale = `${exercises.length} exercises selected to ensure complete ${workoutType} development while avoiding overtraining.`;

  // Reorder exercises to avoid same/related muscle groups back-to-back
  // This provides better recovery between exercises
  // Keep cardio at the end
  const cardioInList = exercises.filter(ex => ex.isCardio || ex.muscleGroup === 'Cardio');
  const nonCardioInList = exercises.filter(ex => !ex.isCardio && ex.muscleGroup !== 'Cardio');
  const reorderedExercises = [...reorderExercisesForRecovery(nonCardioInList), ...cardioInList];

  return {
    id: `${workoutType}_${Date.now()}`,
    name: structure.name,
    focus: structure.focus,
    description: `${todaysFocus} ${goalRationale}`,
    todaysFocus: todaysFocus,
    goalRationale: goalRationale,
    exerciseRationale: exerciseRationale,
    goals: [`${structure.focus} development`, 'Progressive overload', 'Balanced training'],
    exercises: reorderedExercises,
    generatedAt: new Date().toISOString(),
    workoutType: workoutType,
    userGoal: userGoal,
    hasCardio: cardioExercise !== null,
  };
};

// ============================================
// END DYNAMIC WORKOUT GENERATION
// ============================================

// Workout Templates Database (kept for reference/fallback)
/* COMMENTED OUT - Now loading from database via workoutService
const WORKOUT_TEMPLATES = {
  push_a: {
    id: 'push_a',
    name: 'Push Day A',
    focus: 'Chest, Shoulders & Triceps',
    description: 'This workout emphasizes chest development with heavy compound pressing, followed by shoulder and tricep work. Focus on controlled negatives and full range of motion.',
    goals: ['Build pressing strength', 'Develop chest mass', 'Progressive overload'],
    exercises: [
      { id: 'bench', name: 'Barbell Bench Press', sets: 4, targetReps: 6, suggestedWeight: 80, lastWeight: 77.5, lastReps: [6, 6, 5, 5], restTime: 180, muscleGroup: 'Chest' },
      { id: 'incline_db', name: 'Incline Dumbbell Press', sets: 3, targetReps: 10, suggestedWeight: 30, lastWeight: 28, lastReps: [10, 9, 8], restTime: 120, muscleGroup: 'Upper Chest' },
      { id: 'ohp', name: 'Overhead Press', sets: 3, targetReps: 8, suggestedWeight: 50, lastWeight: 47.5, lastReps: [8, 7, 6], restTime: 150, muscleGroup: 'Shoulders' },
      { id: 'lateral', name: 'Lateral Raises', sets: 3, targetReps: 15, suggestedWeight: 12, lastWeight: 10, lastReps: [15, 14, 12], restTime: 60, muscleGroup: 'Side Delts' },
      { id: 'pushdown', name: 'Tricep Pushdowns', sets: 3, targetReps: 12, suggestedWeight: 30, lastWeight: 27.5, lastReps: [12, 11, 10], restTime: 60, muscleGroup: 'Triceps' },
      { id: 'hanging_leg_raise', name: 'Hanging Leg Raises', sets: 3, targetReps: 12, suggestedWeight: 0, lastWeight: 0, lastReps: [12, 10, 8], restTime: 60, muscleGroup: 'Abs' },
    ]
  },
  push_b: {
    id: 'push_b',
    name: 'Push Day B',
    focus: 'Shoulders, Chest & Triceps',
    description: 'A shoulder-focused push day that develops overhead strength and shoulder stability. Includes chest work and tricep isolation for complete pushing development.',
    goals: ['Overhead strength', 'Shoulder hypertrophy', 'Tricep development'],
    exercises: [
      { id: 'ohp', name: 'Overhead Press', sets: 4, targetReps: 6, suggestedWeight: 55, lastWeight: 52.5, lastReps: [6, 6, 5, 5], restTime: 180, muscleGroup: 'Shoulders' },
      { id: 'incline_bb', name: 'Incline Barbell Press', sets: 3, targetReps: 8, suggestedWeight: 65, lastWeight: 62.5, lastReps: [8, 7, 7], restTime: 150, muscleGroup: 'Upper Chest' },
      { id: 'db_press', name: 'Seated Dumbbell Press', sets: 3, targetReps: 10, suggestedWeight: 26, lastWeight: 24, lastReps: [10, 9, 8], restTime: 120, muscleGroup: 'Shoulders' },
      { id: 'cable_fly', name: 'Cable Fly', sets: 3, targetReps: 12, suggestedWeight: 15, lastWeight: 12.5, lastReps: [12, 12, 10], restTime: 60, muscleGroup: 'Chest' },
      { id: 'skull', name: 'Skull Crushers', sets: 3, targetReps: 10, suggestedWeight: 30, lastWeight: 27.5, lastReps: [10, 9, 8], restTime: 90, muscleGroup: 'Triceps' },
      { id: 'face_pull', name: 'Face Pulls', sets: 3, targetReps: 15, suggestedWeight: 20, lastWeight: 17.5, lastReps: [15, 15, 12], restTime: 60, muscleGroup: 'Rear Delts' },
      { id: 'cable_crunch', name: 'Cable Crunches', sets: 3, targetReps: 15, suggestedWeight: 0, lastWeight: 0, lastReps: [15, 14, 12], restTime: 60, muscleGroup: 'Abs' },
    ]
  },
  pull_a: {
    id: 'pull_a',
    name: 'Pull Day A',
    focus: 'Back Width & Biceps',
    description: 'This workout targets lat width and back thickness through vertical and horizontal pulling. Bicep work is included to maximize arm development.',
    goals: ['Build back width', 'Increase pulling strength', 'Bicep hypertrophy'],
    exercises: [
      { id: 'pullup', name: 'Pull Ups', sets: 4, targetReps: 8, suggestedWeight: 0, lastWeight: 0, lastReps: [8, 7, 6, 5], restTime: 150, muscleGroup: 'Lats' },
      { id: 'row', name: 'Barbell Row', sets: 4, targetReps: 8, suggestedWeight: 80, lastWeight: 77.5, lastReps: [8, 8, 7, 6], restTime: 150, muscleGroup: 'Back' },
      { id: 'lat_pull', name: 'Lat Pulldown', sets: 3, targetReps: 10, suggestedWeight: 60, lastWeight: 57.5, lastReps: [10, 9, 8], restTime: 90, muscleGroup: 'Lats' },
      { id: 'face_pull', name: 'Face Pulls', sets: 3, targetReps: 15, suggestedWeight: 22.5, lastWeight: 20, lastReps: [15, 14, 12], restTime: 60, muscleGroup: 'Rear Delts' },
      { id: 'curl', name: 'Barbell Curl', sets: 3, targetReps: 10, suggestedWeight: 35, lastWeight: 32.5, lastReps: [10, 9, 8], restTime: 60, muscleGroup: 'Biceps' },
      { id: 'hammer', name: 'Hammer Curls', sets: 3, targetReps: 12, suggestedWeight: 14, lastWeight: 12, lastReps: [12, 11, 10], restTime: 60, muscleGroup: 'Biceps' },
      { id: 'dead_bug', name: 'Dead Bug', sets: 3, targetReps: 10, suggestedWeight: 0, lastWeight: 0, lastReps: [10, 10, 8], restTime: 45, muscleGroup: 'Core' },
    ]
  },
  pull_b: {
    id: 'pull_b',
    name: 'Pull Day B',
    focus: 'Back Thickness & Biceps',
    description: 'A back thickness-focused session emphasizing rowing movements and horizontal pulls. Develops the mid-back and creates that dense, powerful look.',
    goals: ['Back thickness', 'Rowing strength', 'Complete back development'],
    exercises: [
      { id: 'deadlift', name: 'Deadlift', sets: 4, targetReps: 5, suggestedWeight: 140, lastWeight: 135, lastReps: [5, 5, 5, 4], restTime: 240, muscleGroup: 'Back' },
      { id: 'db_row', name: 'Dumbbell Row', sets: 3, targetReps: 10, suggestedWeight: 36, lastWeight: 34, lastReps: [10, 9, 8], restTime: 90, muscleGroup: 'Back' },
      { id: 'cable_row', name: 'Seated Cable Row', sets: 3, targetReps: 12, suggestedWeight: 65, lastWeight: 60, lastReps: [12, 11, 10], restTime: 90, muscleGroup: 'Back' },
      { id: 'straight_arm', name: 'Straight Arm Pulldown', sets: 3, targetReps: 12, suggestedWeight: 30, lastWeight: 27.5, lastReps: [12, 12, 10], restTime: 60, muscleGroup: 'Lats' },
      { id: 'preacher', name: 'Preacher Curl', sets: 3, targetReps: 10, suggestedWeight: 25, lastWeight: 22.5, lastReps: [10, 9, 8], restTime: 60, muscleGroup: 'Biceps' },
      { id: 'reverse_curl', name: 'Reverse Curls', sets: 2, targetReps: 15, suggestedWeight: 20, lastWeight: 17.5, lastReps: [15, 12], restTime: 60, muscleGroup: 'Forearms' },
      { id: 'hanging_knee_raise', name: 'Hanging Knee Raises', sets: 3, targetReps: 15, suggestedWeight: 0, lastWeight: 0, lastReps: [15, 12, 10], restTime: 60, muscleGroup: 'Abs' },
    ]
  },
  legs_a: {
    id: 'legs_a',
    name: 'Leg Day A',
    focus: 'Quad Dominant',
    description: 'A quad-focused leg workout built around the squat pattern. Develops leg strength, size and athletic power through heavy compound movements.',
    goals: ['Quad development', 'Squat strength', 'Lower body power'],
    exercises: [
      { id: 'squat', name: 'Barbell Back Squat', sets: 4, targetReps: 6, suggestedWeight: 120, lastWeight: 115, lastReps: [6, 6, 5, 5], restTime: 240, muscleGroup: 'Quads' },
      { id: 'leg_press', name: 'Leg Press', sets: 3, targetReps: 10, suggestedWeight: 200, lastWeight: 180, lastReps: [10, 9, 8], restTime: 150, muscleGroup: 'Quads' },
      { id: 'rdl', name: 'Romanian Deadlift', sets: 3, targetReps: 10, suggestedWeight: 90, lastWeight: 85, lastReps: [10, 9, 8], restTime: 120, muscleGroup: 'Hamstrings' },
      { id: 'leg_ext', name: 'Leg Extension', sets: 3, targetReps: 12, suggestedWeight: 50, lastWeight: 45, lastReps: [12, 11, 10], restTime: 60, muscleGroup: 'Quads' },
      { id: 'leg_curl', name: 'Lying Leg Curl', sets: 3, targetReps: 12, suggestedWeight: 40, lastWeight: 37.5, lastReps: [12, 11, 10], restTime: 60, muscleGroup: 'Hamstrings' },
      { id: 'calf', name: 'Standing Calf Raises', sets: 4, targetReps: 15, suggestedWeight: 80, lastWeight: 70, lastReps: [15, 14, 12, 10], restTime: 60, muscleGroup: 'Calves' },
      { id: 'plank', name: 'Plank', sets: 3, targetReps: 45, suggestedWeight: 0, lastWeight: 0, lastReps: [45, 45, 40], restTime: 45, muscleGroup: 'Core' },
    ]
  },
  legs_b: {
    id: 'legs_b',
    name: 'Leg Day B',
    focus: 'Posterior Chain & Glutes',
    description: 'A hamstring and glute-focused session that develops the posterior chain. Great for athletic performance, injury prevention, and building a strong foundation.',
    goals: ['Hamstring development', 'Glute strength', 'Posterior chain power'],
    exercises: [
      { id: 'rdl', name: 'Romanian Deadlift', sets: 4, targetReps: 8, suggestedWeight: 100, lastWeight: 95, lastReps: [8, 8, 7, 6], restTime: 180, muscleGroup: 'Hamstrings' },
      { id: 'hip_thrust', name: 'Hip Thrust', sets: 4, targetReps: 10, suggestedWeight: 100, lastWeight: 90, lastReps: [10, 10, 9, 8], restTime: 120, muscleGroup: 'Glutes' },
      { id: 'bss', name: 'Bulgarian Split Squat', sets: 3, targetReps: 10, suggestedWeight: 24, lastWeight: 22, lastReps: [10, 9, 8], restTime: 90, muscleGroup: 'Quads' },
      { id: 'leg_curl', name: 'Seated Leg Curl', sets: 3, targetReps: 12, suggestedWeight: 45, lastWeight: 40, lastReps: [12, 11, 10], restTime: 60, muscleGroup: 'Hamstrings' },
      { id: 'abduct', name: 'Hip Abduction', sets: 3, targetReps: 15, suggestedWeight: 50, lastWeight: 45, lastReps: [15, 14, 12], restTime: 60, muscleGroup: 'Glutes' },
      { id: 'calf', name: 'Seated Calf Raises', sets: 4, targetReps: 15, suggestedWeight: 40, lastWeight: 35, lastReps: [15, 14, 12, 10], restTime: 60, muscleGroup: 'Calves' },
      { id: 'ab_wheel', name: 'Ab Wheel Rollout', sets: 3, targetReps: 10, suggestedWeight: 0, lastWeight: 0, lastReps: [10, 8, 8], restTime: 60, muscleGroup: 'Core' },
    ]
  },
  upper_a: {
    id: 'upper_a',
    name: 'Upper Body A',
    focus: 'Horizontal Push/Pull',
    description: 'A balanced upper body session focusing on horizontal pressing and rowing. Develops chest and back equally for a proportional, powerful upper body.',
    goals: ['Upper body balance', 'Horizontal strength', 'Muscle symmetry'],
    exercises: [
      { id: 'bench', name: 'Barbell Bench Press', sets: 4, targetReps: 6, suggestedWeight: 85, lastWeight: 82.5, lastReps: [6, 6, 5, 5], restTime: 180, muscleGroup: 'Chest' },
      { id: 'row', name: 'Barbell Row', sets: 4, targetReps: 8, suggestedWeight: 82.5, lastWeight: 80, lastReps: [8, 7, 7, 6], restTime: 150, muscleGroup: 'Back' },
      { id: 'db_press', name: 'Seated Dumbbell Press', sets: 3, targetReps: 10, suggestedWeight: 28, lastWeight: 26, lastReps: [10, 9, 8], restTime: 120, muscleGroup: 'Shoulders' },
      { id: 'lat_pull', name: 'Lat Pulldown', sets: 3, targetReps: 10, suggestedWeight: 62.5, lastWeight: 60, lastReps: [10, 9, 8], restTime: 90, muscleGroup: 'Lats' },
      { id: 'curl', name: 'EZ Bar Curl', sets: 3, targetReps: 10, suggestedWeight: 32.5, lastWeight: 30, lastReps: [10, 9, 8], restTime: 60, muscleGroup: 'Biceps' },
      { id: 'pushdown', name: 'Rope Pushdowns', sets: 3, targetReps: 12, suggestedWeight: 25, lastWeight: 22.5, lastReps: [12, 11, 10], restTime: 60, muscleGroup: 'Triceps' },
      { id: 'hanging_leg_raise', name: 'Hanging Leg Raises', sets: 3, targetReps: 12, suggestedWeight: 0, lastWeight: 0, lastReps: [12, 10, 8], restTime: 60, muscleGroup: 'Abs' },
    ]
  },
  upper_b: {
    id: 'upper_b',
    name: 'Upper Body B',
    focus: 'Vertical Push/Pull',
    description: 'An upper body session emphasizing vertical movements. Builds impressive shoulders and lats while developing pulling and pressing strength overhead.',
    goals: ['Vertical strength', 'Shoulder & lat width', 'Overhead power'],
    exercises: [
      { id: 'ohp', name: 'Overhead Press', sets: 4, targetReps: 6, suggestedWeight: 57.5, lastWeight: 55, lastReps: [6, 6, 5, 5], restTime: 180, muscleGroup: 'Shoulders' },
      { id: 'pullup', name: 'Chin Ups', sets: 4, targetReps: 8, suggestedWeight: 0, lastWeight: 0, lastReps: [8, 7, 6, 5], restTime: 150, muscleGroup: 'Lats' },
      { id: 'incline', name: 'Incline Dumbbell Press', sets: 3, targetReps: 10, suggestedWeight: 32, lastWeight: 30, lastReps: [10, 9, 8], restTime: 120, muscleGroup: 'Upper Chest' },
      { id: 'cable_row', name: 'Seated Cable Row', sets: 3, targetReps: 12, suggestedWeight: 67.5, lastWeight: 65, lastReps: [12, 11, 10], restTime: 90, muscleGroup: 'Back' },
      { id: 'lateral', name: 'Lateral Raises', sets: 3, targetReps: 15, suggestedWeight: 12, lastWeight: 10, lastReps: [15, 14, 12], restTime: 60, muscleGroup: 'Side Delts' },
      { id: 'hammer', name: 'Hammer Curls', sets: 3, targetReps: 12, suggestedWeight: 16, lastWeight: 14, lastReps: [12, 11, 10], restTime: 60, muscleGroup: 'Biceps' },
      { id: 'overhead_ext', name: 'Overhead Tricep Extension', sets: 3, targetReps: 12, suggestedWeight: 27.5, lastWeight: 25, lastReps: [12, 11, 10], restTime: 60, muscleGroup: 'Triceps' },
      { id: 'v_ups', name: 'V-Ups', sets: 3, targetReps: 12, suggestedWeight: 0, lastWeight: 0, lastReps: [12, 10, 8], restTime: 45, muscleGroup: 'Abs' },
    ]
  },
  lower: {
    id: 'lower',
    name: 'Lower Body',
    focus: 'Full Leg Development',
    description: 'A comprehensive lower body session hitting all major leg muscles. Combines heavy compound lifts with isolation work for complete leg development.',
    goals: ['Overall leg strength', 'Quad & hamstring balance', 'Lower body power'],
    exercises: [
      { id: 'squat', name: 'Barbell Back Squat', sets: 4, targetReps: 6, suggestedWeight: 125, lastWeight: 120, lastReps: [6, 6, 5, 5], restTime: 240, muscleGroup: 'Quads' },
      { id: 'rdl', name: 'Romanian Deadlift', sets: 3, targetReps: 10, suggestedWeight: 95, lastWeight: 90, lastReps: [10, 9, 8], restTime: 150, muscleGroup: 'Hamstrings' },
      { id: 'bss', name: 'Bulgarian Split Squat', sets: 3, targetReps: 10, suggestedWeight: 26, lastWeight: 24, lastReps: [10, 9, 8], restTime: 90, muscleGroup: 'Quads' },
      { id: 'leg_curl', name: 'Lying Leg Curl', sets: 3, targetReps: 12, suggestedWeight: 42.5, lastWeight: 40, lastReps: [12, 11, 10], restTime: 60, muscleGroup: 'Hamstrings' },
      { id: 'leg_ext', name: 'Leg Extension', sets: 3, targetReps: 12, suggestedWeight: 52.5, lastWeight: 50, lastReps: [12, 11, 10], restTime: 60, muscleGroup: 'Quads' },
      { id: 'calf', name: 'Standing Calf Raises', sets: 4, targetReps: 15, suggestedWeight: 85, lastWeight: 80, lastReps: [15, 14, 12, 10], restTime: 60, muscleGroup: 'Calves' },
      { id: 'bicycle_crunch', name: 'Bicycle Crunches', sets: 3, targetReps: 20, suggestedWeight: 0, lastWeight: 0, lastReps: [20, 18, 15], restTime: 45, muscleGroup: 'Abs' },
    ]
  },
  full_body_a: {
    id: 'full_body_a',
    name: 'Full Body A',
    focus: 'Compound Strength',
    description: 'A full body strength session built around the big three lifts. Efficient and effective for building overall strength and muscle when time is limited.',
    goals: ['Full body strength', 'Efficient training', 'Compound lift focus'],
    exercises: [
      { id: 'squat', name: 'Barbell Back Squat', sets: 4, targetReps: 5, suggestedWeight: 110, lastWeight: 105, lastReps: [5, 5, 5, 4], restTime: 240, muscleGroup: 'Quads' },
      { id: 'bench', name: 'Barbell Bench Press', sets: 4, targetReps: 5, suggestedWeight: 82.5, lastWeight: 80, lastReps: [5, 5, 5, 4], restTime: 180, muscleGroup: 'Chest' },
      { id: 'row', name: 'Barbell Row', sets: 4, targetReps: 6, suggestedWeight: 77.5, lastWeight: 75, lastReps: [6, 6, 5, 5], restTime: 150, muscleGroup: 'Back' },
      { id: 'ohp', name: 'Overhead Press', sets: 3, targetReps: 8, suggestedWeight: 47.5, lastWeight: 45, lastReps: [8, 7, 6], restTime: 120, muscleGroup: 'Shoulders' },
      { id: 'rdl', name: 'Romanian Deadlift', sets: 3, targetReps: 10, suggestedWeight: 85, lastWeight: 80, lastReps: [10, 9, 8], restTime: 120, muscleGroup: 'Hamstrings' },
      { id: 'hanging_knee_raise', name: 'Hanging Knee Raises', sets: 3, targetReps: 15, suggestedWeight: 0, lastWeight: 0, lastReps: [15, 12, 10], restTime: 60, muscleGroup: 'Abs' },
    ]
  },
  full_body_b: {
    id: 'full_body_b',
    name: 'Full Body B',
    focus: 'Hypertrophy & Accessories',
    description: 'A full body session with higher rep ranges and more isolation work. Complements Full Body A for balanced muscle development.',
    goals: ['Muscle hypertrophy', 'Accessory work', 'Balanced development'],
    exercises: [
      { id: 'front_squat', name: 'Front Squat', sets: 3, targetReps: 8, suggestedWeight: 80, lastWeight: 75, lastReps: [8, 7, 6], restTime: 180, muscleGroup: 'Quads' },
      { id: 'db_bench', name: 'Dumbbell Bench Press', sets: 3, targetReps: 10, suggestedWeight: 34, lastWeight: 32, lastReps: [10, 9, 8], restTime: 120, muscleGroup: 'Chest' },
      { id: 'pullup', name: 'Pull Ups', sets: 3, targetReps: 8, suggestedWeight: 0, lastWeight: 0, lastReps: [8, 7, 6], restTime: 120, muscleGroup: 'Lats' },
      { id: 'hip_thrust', name: 'Hip Thrust', sets: 3, targetReps: 12, suggestedWeight: 90, lastWeight: 85, lastReps: [12, 11, 10], restTime: 90, muscleGroup: 'Glutes' },
      { id: 'lateral', name: 'Lateral Raises', sets: 3, targetReps: 15, suggestedWeight: 10, lastWeight: 8, lastReps: [15, 14, 12], restTime: 60, muscleGroup: 'Side Delts' },
      { id: 'curl', name: 'Dumbbell Curl', sets: 2, targetReps: 12, suggestedWeight: 14, lastWeight: 12, lastReps: [12, 10], restTime: 60, muscleGroup: 'Biceps' },
      { id: 'pushdown', name: 'Tricep Pushdowns', sets: 2, targetReps: 12, suggestedWeight: 27.5, lastWeight: 25, lastReps: [12, 10], restTime: 60, muscleGroup: 'Triceps' },
      { id: 'dead_bug', name: 'Dead Bug', sets: 3, targetReps: 10, suggestedWeight: 0, lastWeight: 0, lastReps: [10, 10, 8], restTime: 45, muscleGroup: 'Core' },
    ]
  },
  arms: {
    id: 'arms',
    name: 'Arms Day',
    focus: 'Biceps & Triceps',
    description: 'A dedicated arm session for maximum bicep and tricep development. High volume with varied angles to target all heads of each muscle.',
    goals: ['Arm size', 'Peak development', 'Tricep horseshoe'],
    exercises: [
      { id: 'close_grip', name: 'Close Grip Bench Press', sets: 4, targetReps: 8, suggestedWeight: 65, lastWeight: 62.5, lastReps: [8, 8, 7, 6], restTime: 150, muscleGroup: 'Triceps' },
      { id: 'curl', name: 'Barbell Curl', sets: 4, targetReps: 8, suggestedWeight: 37.5, lastWeight: 35, lastReps: [8, 8, 7, 6], restTime: 90, muscleGroup: 'Biceps' },
      { id: 'skull', name: 'Skull Crushers', sets: 3, targetReps: 10, suggestedWeight: 32.5, lastWeight: 30, lastReps: [10, 9, 8], restTime: 90, muscleGroup: 'Triceps' },
      { id: 'incline_curl', name: 'Incline Dumbbell Curl', sets: 3, targetReps: 10, suggestedWeight: 12, lastWeight: 10, lastReps: [10, 9, 8], restTime: 60, muscleGroup: 'Biceps' },
      { id: 'pushdown', name: 'Rope Pushdowns', sets: 3, targetReps: 12, suggestedWeight: 27.5, lastWeight: 25, lastReps: [12, 11, 10], restTime: 60, muscleGroup: 'Triceps' },
      { id: 'hammer', name: 'Hammer Curls', sets: 3, targetReps: 12, suggestedWeight: 16, lastWeight: 14, lastReps: [12, 11, 10], restTime: 60, muscleGroup: 'Biceps' },
      { id: 'overhead_ext', name: 'Overhead Tricep Extension', sets: 2, targetReps: 15, suggestedWeight: 25, lastWeight: 22.5, lastReps: [15, 12], restTime: 60, muscleGroup: 'Triceps' },
      { id: 'conc_curl', name: 'Concentration Curl', sets: 2, targetReps: 12, suggestedWeight: 10, lastWeight: 8, lastReps: [12, 10], restTime: 60, muscleGroup: 'Biceps' },
      { id: 'plank', name: 'Plank', sets: 3, targetReps: 45, suggestedWeight: 0, lastWeight: 0, lastReps: [45, 40, 35], restTime: 45, muscleGroup: 'Core' },
    ]
  },
  // ADVANCED WORKOUT TEMPLATES
  chest_specialization: {
    id: 'chest_specialization',
    name: 'Chest Specialization',
    focus: 'Chest Hypertrophy',
    description: 'An advanced chest-focused workout with high volume across multiple angles. For experienced lifters looking to bring up lagging chest development.',
    goals: ['Maximum chest development', 'Upper/lower chest balance', 'Mind-muscle connection'],
    difficulty: 'Advanced',
    muscleFrequency: { chest: 3, shoulders: 1, triceps: 2 },
    exercises: [
      { id: 'incline_bb', name: 'Incline Barbell Press', sets: 4, targetReps: 8, suggestedWeight: 70, lastWeight: 67.5, lastReps: [8, 8, 7, 6], restTime: 180, muscleGroup: 'Upper Chest' },
      { id: 'bench', name: 'Barbell Bench Press', sets: 4, targetReps: 8, suggestedWeight: 85, lastWeight: 82.5, lastReps: [8, 8, 7, 6], restTime: 180, muscleGroup: 'Chest' },
      { id: 'db_fly', name: 'Dumbbell Fly', sets: 3, targetReps: 12, suggestedWeight: 18, lastWeight: 16, lastReps: [12, 11, 10], restTime: 90, muscleGroup: 'Chest' },
      { id: 'cable_fly_high', name: 'Cable Fly', sets: 3, targetReps: 15, suggestedWeight: 15, lastWeight: 12.5, lastReps: [15, 14, 12], restTime: 60, muscleGroup: 'Chest' },
      { id: 'incline_fly', name: 'Incline Cable Fly', sets: 3, targetReps: 15, suggestedWeight: 12.5, lastWeight: 10, lastReps: [15, 14, 12], restTime: 60, muscleGroup: 'Upper Chest' },
      { id: 'dips', name: 'Dips', sets: 3, targetReps: 12, suggestedWeight: 0, lastWeight: 0, lastReps: [12, 10, 8], restTime: 90, muscleGroup: 'Lower Chest' },
      { id: 'pushdown', name: 'Tricep Pushdowns', sets: 3, targetReps: 15, suggestedWeight: 25, lastWeight: 22.5, lastReps: [15, 14, 12], restTime: 60, muscleGroup: 'Triceps' },
      { id: 'hanging_leg_raise', name: 'Hanging Leg Raises', sets: 3, targetReps: 12, suggestedWeight: 0, lastWeight: 0, lastReps: [12, 10, 8], restTime: 60, muscleGroup: 'Abs' },
    ]
  },
  back_specialization: {
    id: 'back_specialization',
    name: 'Back Specialization',
    focus: 'Back Width & Thickness',
    description: 'An advanced back workout combining width and thickness movements. High volume training for experienced lifters seeking maximum back development.',
    goals: ['Lat width', 'Mid-back thickness', 'Complete V-taper'],
    difficulty: 'Advanced',
    muscleFrequency: { back: 3, biceps: 2, rear_delts: 1 },
    exercises: [
      { id: 'weighted_pullup', name: 'Pull Ups', sets: 4, targetReps: 8, suggestedWeight: 15, lastWeight: 12.5, lastReps: [8, 8, 7, 6], restTime: 180, muscleGroup: 'Lats' },
      { id: 'pendlay_row', name: 'Pendlay Row', sets: 4, targetReps: 6, suggestedWeight: 90, lastWeight: 87.5, lastReps: [6, 6, 5, 5], restTime: 180, muscleGroup: 'Back' },
      { id: 'wide_pulldown', name: 'Wide Grip Pulldown', sets: 3, targetReps: 10, suggestedWeight: 65, lastWeight: 62.5, lastReps: [10, 9, 8], restTime: 90, muscleGroup: 'Lats' },
      { id: 'chest_row', name: 'Chest Supported Row', sets: 3, targetReps: 10, suggestedWeight: 32, lastWeight: 30, lastReps: [10, 9, 8], restTime: 90, muscleGroup: 'Back' },
      { id: 'straight_arm', name: 'Straight Arm Pulldown', sets: 3, targetReps: 12, suggestedWeight: 32.5, lastWeight: 30, lastReps: [12, 11, 10], restTime: 60, muscleGroup: 'Lats' },
      { id: 'face_pull', name: 'Face Pulls', sets: 3, targetReps: 15, suggestedWeight: 22.5, lastWeight: 20, lastReps: [15, 15, 12], restTime: 60, muscleGroup: 'Rear Delts' },
      { id: 'shrugs', name: 'Barbell Shrugs', sets: 3, targetReps: 12, suggestedWeight: 100, lastWeight: 95, lastReps: [12, 11, 10], restTime: 90, muscleGroup: 'Traps' },
      { id: 'curl', name: 'EZ Bar Curl', sets: 3, targetReps: 10, suggestedWeight: 35, lastWeight: 32.5, lastReps: [10, 9, 8], restTime: 60, muscleGroup: 'Biceps' },
      { id: 'ab_wheel', name: 'Ab Wheel Rollout', sets: 3, targetReps: 10, suggestedWeight: 0, lastWeight: 0, lastReps: [10, 8, 8], restTime: 60, muscleGroup: 'Core' },
    ]
  },
  leg_specialization: {
    id: 'leg_specialization',
    name: 'Leg Specialization',
    focus: 'Complete Leg Development',
    description: 'An intense leg session targeting quads, hamstrings, glutes and calves equally. For advanced lifters committed to balanced lower body development.',
    goals: ['Quad sweep', 'Hamstring tie-in', 'Glute development', 'Calf growth'],
    difficulty: 'Advanced',
    muscleFrequency: { quads: 3, hamstrings: 2, glutes: 2, calves: 2 },
    exercises: [
      { id: 'squat', name: 'Barbell Back Squat', sets: 4, targetReps: 6, suggestedWeight: 130, lastWeight: 125, lastReps: [6, 6, 5, 5], restTime: 240, muscleGroup: 'Quads' },
      { id: 'rdl', name: 'Romanian Deadlift', sets: 4, targetReps: 8, suggestedWeight: 105, lastWeight: 100, lastReps: [8, 8, 7, 6], restTime: 180, muscleGroup: 'Hamstrings' },
      { id: 'hack_squat', name: 'Hack Squat', sets: 3, targetReps: 10, suggestedWeight: 120, lastWeight: 110, lastReps: [10, 9, 8], restTime: 150, muscleGroup: 'Quads' },
      { id: 'hip_thrust', name: 'Hip Thrust', sets: 4, targetReps: 10, suggestedWeight: 110, lastWeight: 100, lastReps: [10, 10, 9, 8], restTime: 120, muscleGroup: 'Glutes' },
      { id: 'leg_ext', name: 'Leg Extension', sets: 3, targetReps: 12, suggestedWeight: 55, lastWeight: 50, lastReps: [12, 11, 10], restTime: 60, muscleGroup: 'Quads' },
      { id: 'leg_curl', name: 'Lying Leg Curl', sets: 3, targetReps: 12, suggestedWeight: 45, lastWeight: 42.5, lastReps: [12, 11, 10], restTime: 60, muscleGroup: 'Hamstrings' },
      { id: 'calf_standing', name: 'Standing Calf Raises', sets: 4, targetReps: 12, suggestedWeight: 90, lastWeight: 85, lastReps: [12, 12, 10, 10], restTime: 60, muscleGroup: 'Calves' },
      { id: 'calf_seated', name: 'Seated Calf Raises', sets: 3, targetReps: 15, suggestedWeight: 45, lastWeight: 40, lastReps: [15, 14, 12], restTime: 60, muscleGroup: 'Calves' },
      { id: 'hollow_hold', name: 'Hollow Body Hold', sets: 3, targetReps: 30, suggestedWeight: 0, lastWeight: 0, lastReps: [30, 25, 20], restTime: 45, muscleGroup: 'Core' },
    ]
  },
  powerlifting_squat: {
    id: 'powerlifting_squat',
    name: 'Squat Focus (Powerlifting)',
    focus: 'Squat Strength',
    description: 'A powerlifting-style squat-focused session with competition-style training. Heavy singles, doubles and triples with accessory work.',
    goals: ['Squat 1RM improvement', 'Competition prep', 'Technical refinement'],
    difficulty: 'Advanced',
    exercises: [
      { id: 'squat', name: 'Barbell Back Squat', sets: 5, targetReps: 3, suggestedWeight: 145, lastWeight: 140, lastReps: [3, 3, 3, 2, 2], restTime: 300, muscleGroup: 'Quads' },
      { id: 'pause_squat', name: 'Front Squat', sets: 3, targetReps: 5, suggestedWeight: 100, lastWeight: 95, lastReps: [5, 5, 4], restTime: 180, muscleGroup: 'Quads' },
      { id: 'bss', name: 'Bulgarian Split Squat', sets: 3, targetReps: 8, suggestedWeight: 30, lastWeight: 28, lastReps: [8, 8, 7], restTime: 120, muscleGroup: 'Quads' },
      { id: 'rdl', name: 'Romanian Deadlift', sets: 3, targetReps: 8, suggestedWeight: 95, lastWeight: 90, lastReps: [8, 8, 7], restTime: 120, muscleGroup: 'Hamstrings' },
      { id: 'leg_curl', name: 'Lying Leg Curl', sets: 3, targetReps: 12, suggestedWeight: 42.5, lastWeight: 40, lastReps: [12, 11, 10], restTime: 60, muscleGroup: 'Hamstrings' },
      { id: 'core', name: 'Ab Wheel Rollout', sets: 3, targetReps: 10, suggestedWeight: 0, lastWeight: 0, lastReps: [10, 8, 8], restTime: 60, muscleGroup: 'Core' },
    ]
  },
  powerlifting_bench: {
    id: 'powerlifting_bench',
    name: 'Bench Focus (Powerlifting)',
    focus: 'Bench Press Strength',
    description: 'A powerlifting-style bench press-focused session. Heavy work with pauses and accessory movements for maximum pressing strength.',
    goals: ['Bench 1RM improvement', 'Lockout strength', 'Chest drive'],
    difficulty: 'Advanced',
    exercises: [
      { id: 'bench', name: 'Barbell Bench Press', sets: 5, targetReps: 3, suggestedWeight: 105, lastWeight: 100, lastReps: [3, 3, 3, 2, 2], restTime: 300, muscleGroup: 'Chest' },
      { id: 'close_grip', name: 'Close Grip Bench Press', sets: 4, targetReps: 6, suggestedWeight: 85, lastWeight: 82.5, lastReps: [6, 6, 5, 5], restTime: 180, muscleGroup: 'Triceps' },
      { id: 'db_bench', name: 'Dumbbell Bench Press', sets: 3, targetReps: 8, suggestedWeight: 38, lastWeight: 36, lastReps: [8, 8, 7], restTime: 120, muscleGroup: 'Chest' },
      { id: 'row', name: 'Barbell Row', sets: 4, targetReps: 8, suggestedWeight: 82.5, lastWeight: 80, lastReps: [8, 8, 7, 6], restTime: 120, muscleGroup: 'Back' },
      { id: 'face_pull', name: 'Face Pulls', sets: 3, targetReps: 15, suggestedWeight: 22.5, lastWeight: 20, lastReps: [15, 14, 12], restTime: 60, muscleGroup: 'Rear Delts' },
      { id: 'tricep_ext', name: 'Overhead Tricep Extension', sets: 3, targetReps: 12, suggestedWeight: 30, lastWeight: 27.5, lastReps: [12, 11, 10], restTime: 60, muscleGroup: 'Triceps' },
      { id: 'dead_bug', name: 'Dead Bug', sets: 3, targetReps: 10, suggestedWeight: 0, lastWeight: 0, lastReps: [10, 10, 8], restTime: 45, muscleGroup: 'Core' },
    ]
  },
  powerlifting_deadlift: {
    id: 'powerlifting_deadlift',
    name: 'Deadlift Focus (Powerlifting)',
    focus: 'Deadlift Strength',
    description: 'A powerlifting-style deadlift-focused session. Heavy pulls with variations and back accessories for maximum pulling power.',
    goals: ['Deadlift 1RM improvement', 'Floor speed', 'Lockout strength'],
    difficulty: 'Advanced',
    exercises: [
      { id: 'deadlift', name: 'Deadlift', sets: 5, targetReps: 2, suggestedWeight: 175, lastWeight: 170, lastReps: [2, 2, 2, 2, 1], restTime: 300, muscleGroup: 'Back' },
      { id: 'deficit_dl', name: 'Romanian Deadlift', sets: 3, targetReps: 6, suggestedWeight: 115, lastWeight: 110, lastReps: [6, 6, 5], restTime: 180, muscleGroup: 'Hamstrings' },
      { id: 'row', name: 'Pendlay Row', sets: 4, targetReps: 6, suggestedWeight: 85, lastWeight: 82.5, lastReps: [6, 6, 5, 5], restTime: 150, muscleGroup: 'Back' },
      { id: 'pullup', name: 'Pull Ups', sets: 3, targetReps: 8, suggestedWeight: 10, lastWeight: 7.5, lastReps: [8, 7, 6], restTime: 120, muscleGroup: 'Lats' },
      { id: 'leg_curl', name: 'Lying Leg Curl', sets: 3, targetReps: 12, suggestedWeight: 42.5, lastWeight: 40, lastReps: [12, 11, 10], restTime: 60, muscleGroup: 'Hamstrings' },
      { id: 'shrugs', name: 'Barbell Shrugs', sets: 3, targetReps: 10, suggestedWeight: 110, lastWeight: 105, lastReps: [10, 9, 8], restTime: 90, muscleGroup: 'Traps' },
      { id: 'pallof_press', name: 'Pallof Press', sets: 3, targetReps: 10, suggestedWeight: 0, lastWeight: 0, lastReps: [10, 10, 8], restTime: 45, muscleGroup: 'Core' },
    ]
  },
  athletic_power: {
    id: 'athletic_power',
    name: 'Athletic Power',
    focus: 'Explosive Power & Conditioning',
    description: 'An athletic-focused workout combining strength with explosive power movements. Great for sports performance and functional fitness.',
    goals: ['Explosive power', 'Athletic performance', 'Conditioning'],
    difficulty: 'Intermediate',
    exercises: [
      { id: 'power_clean', name: 'Power Clean', sets: 5, targetReps: 3, suggestedWeight: 70, lastWeight: 65, lastReps: [3, 3, 3, 3, 2], restTime: 180, muscleGroup: 'Full Body' },
      { id: 'box_jump', name: 'Box Jumps', sets: 4, targetReps: 5, suggestedWeight: 0, lastWeight: 0, lastReps: [5, 5, 5, 5], restTime: 120, muscleGroup: 'Quads' },
      { id: 'front_squat', name: 'Front Squat', sets: 4, targetReps: 6, suggestedWeight: 85, lastWeight: 80, lastReps: [6, 6, 5, 5], restTime: 180, muscleGroup: 'Quads' },
      { id: 'push_press', name: 'Push Press', sets: 4, targetReps: 5, suggestedWeight: 60, lastWeight: 57.5, lastReps: [5, 5, 5, 4], restTime: 150, muscleGroup: 'Shoulders' },
      { id: 'kb_swing', name: 'Kettlebell Swings', sets: 3, targetReps: 15, suggestedWeight: 24, lastWeight: 20, lastReps: [15, 15, 12], restTime: 90, muscleGroup: 'Glutes' },
      { id: 'plank', name: 'Plank', sets: 3, targetReps: 60, suggestedWeight: 0, lastWeight: 0, lastReps: [60, 45, 45], restTime: 60, muscleGroup: 'Core' },
    ]
  }
};
*/

/* COMMENTED OUT - These referenced the hardcoded WORKOUT_TEMPLATES
// Current workout - would be determined by program/schedule
const CURRENT_WORKOUT = WORKOUT_TEMPLATES.push_a;
const WORKOUT_EXERCISES = CURRENT_WORKOUT.exercises.map(ex => ({
  ...ex,
  history: [
    { date: 'Jan 1', weight: ex.lastWeight * 0.9, reps: ex.lastReps, e1rm: Math.round(ex.lastWeight * 0.9 * 1.1) },
    { date: 'Jan 3', weight: ex.lastWeight * 0.95, reps: ex.lastReps, e1rm: Math.round(ex.lastWeight * 0.95 * 1.1) },
    { date: 'Jan 6', weight: ex.lastWeight, reps: ex.lastReps, e1rm: Math.round(ex.lastWeight * 1.1) },
  ],
  alternatives: ALL_EXERCISES.filter(e => e.muscleGroup === ex.muscleGroup).slice(0, 5).map(e => e.name)
}));
*/

// Helper function for workout type colors - consistent primary color for all workouts
const getWorkoutColor = (type, COLORS) => {
  if (!type) return COLORS.textMuted;
  const t = type.toLowerCase();
  if (t.includes('rest')) return COLORS.textMuted;
  return COLORS.primary;
};

const RPE_SCALE = [
  { value: 1, label: '1', desc: 'Warm up - very light' },
  { value: 2, label: '2', desc: 'Light - easy effort' },
  { value: 3, label: '3', desc: 'Light - could do many more' },
  { value: 4, label: '4', desc: 'Moderate - comfortable pace' },
  { value: 5, label: '5', desc: 'Moderate - starting to work' },
  { value: 6, label: '6', desc: 'Moderate-hard - 4+ reps left' },
  { value: 7, label: '7', desc: 'Hard - 3 reps left' },
  { value: 8, label: '8', desc: 'Very hard - 2 reps left' },
  { value: 9, label: '9', desc: 'Near max - 1 rep left' },
  { value: 10, label: '10', desc: 'Failure - no more reps possible' },
];

// LoginScreen as separate component
function LoginScreen({ onBack, onLogin, COLORS }) {
  const [loginMethod, setLoginMethod] = useState('email'); // 'email' or 'username'
  const [identifier, setIdentifier] = useState('');
  const [password, setPassword] = useState('');
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState(null);
  const { signIn } = useAuth();

  const handleLogin = async () => {
    if (!identifier || !password) return;

    setLoading(true);
    setError(null);

    const credentials = loginMethod === 'email'
      ? { email: identifier, password }
      : { username: identifier, password };

    const { error: authError } = await signIn(credentials);

    if (authError) {
      setError(authError.message);
      setLoading(false);
    } else {
      onLogin();
    }
  };

  return (
    <div className="flex flex-col h-full p-6">
      <button onClick={onBack} className="mb-6" disabled={loading}>
        <ChevronLeft size={24} color={COLORS.text} />
      </button>
      <div className="flex-1">
        <h1 className="text-3xl font-bold mb-2" style={{ color: COLORS.text }}>Welcome Back</h1>
        <p className="mb-8" style={{ color: COLORS.textSecondary }}>Log in to continue your fitness journey</p>

        {error && (
          <div className="mb-4 p-3 rounded-xl flex items-center gap-2" style={{ backgroundColor: COLORS.error + '20' }}>
            <AlertCircle size={18} color={COLORS.error} />
            <p className="text-sm" style={{ color: COLORS.error }}>{error}</p>
          </div>
        )}

        <div className="space-y-4">
          {/* Login method toggle */}
          <div className="flex gap-2 p-1 rounded-xl" style={{ backgroundColor: COLORS.surface }}>
            <button
              onClick={() => { setLoginMethod('email'); setIdentifier(''); setError(null); }}
              disabled={loading}
              className="flex-1 py-2 px-3 rounded-lg flex items-center justify-center gap-2 transition-all"
              style={{
                backgroundColor: loginMethod === 'email' ? COLORS.primary : 'transparent',
                color: loginMethod === 'email' ? COLORS.text : COLORS.textSecondary
              }}
            >
              <span className="text-sm font-medium">Email</span>
            </button>
            <button
              onClick={() => { setLoginMethod('username'); setIdentifier(''); setError(null); }}
              disabled={loading}
              className="flex-1 py-2 px-3 rounded-lg flex items-center justify-center gap-2 transition-all"
              style={{
                backgroundColor: loginMethod === 'username' ? COLORS.primary : 'transparent',
                color: loginMethod === 'username' ? COLORS.text : COLORS.textSecondary
              }}
            >
              <span className="text-sm font-medium">Username</span>
            </button>
          </div>

          <div>
            <label className="text-sm mb-2 block" style={{ color: COLORS.textSecondary }}>
              {loginMethod === 'email' ? 'Email' : 'Username'}
            </label>
            <input
              type={loginMethod === 'email' ? 'email' : 'text'}
              placeholder={loginMethod === 'email' ? 'your@email.com' : 'your_username'}
              value={identifier}
              onChange={e => setIdentifier(e.target.value)}
              disabled={loading}
              className="w-full p-4 rounded-xl outline-none"
              style={{ backgroundColor: COLORS.surface, color: COLORS.text, border: `1px solid ${COLORS.surfaceLight}` }} />
          </div>
          <div>
            <label className="text-sm mb-2 block" style={{ color: COLORS.textSecondary }}>Password</label>
            <input type="password" placeholder="" value={password}
              onChange={e => setPassword(e.target.value)}
              disabled={loading}
              onKeyDown={e => e.key === 'Enter' && handleLogin()}
              className="w-full p-4 rounded-xl outline-none"
              style={{ backgroundColor: COLORS.surface, color: COLORS.text, border: `1px solid ${COLORS.surfaceLight}` }} />
          </div>
        </div>
      </div>
      <button onClick={handleLogin} disabled={!identifier || !password || loading}
        className="w-full py-4 rounded-xl font-semibold text-lg flex items-center justify-center gap-2"
        style={{ backgroundColor: COLORS.primary, color: COLORS.text, opacity: identifier && password && !loading ? 1 : 0.5 }}>
        {loading ? (
          <>
            <Loader2 size={20} className="animate-spin" />
            Logging in...
          </>
        ) : (
          'Log In'
        )}
      </button>
    </div>
  );
}

// RegisterScreen as separate component
function RegisterScreen({ onBack, onRegister, COLORS }) {
  const [regData, setRegData] = useState({
    firstName: '', lastName: '', email: '', password: '', confirmPassword: '', dob: '', weight: '', username: '', gender: ''
  });
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState(null);
  const { signUp } = useAuth();

  // Username validation: 3-20 chars, lowercase letters, numbers, underscores only
  const isUsernameValid = regData.username.length >= 3 && regData.username.length <= 20 &&
    /^[a-z0-9_]+$/.test(regData.username);

  const isValid = regData.firstName && regData.lastName && regData.email && isUsernameValid &&
    regData.password && regData.password.length >= 6 && regData.password === regData.confirmPassword;

  const handleRegister = async () => {
    if (!isValid) return;

    setLoading(true);
    setError(null);

    const { error: authError } = await signUp({
      email: regData.email,
      password: regData.password,
      firstName: regData.firstName,
      lastName: regData.lastName,
      dob: regData.dob || null,
      username: regData.username.toLowerCase(),
      gender: regData.gender || null,
    });

    if (authError) {
      setError(authError.message);
      setLoading(false);
    } else {
      // Pass user data to continue to onboarding
      onRegister(regData);
    }
  };

  return (
    <div className="flex flex-col h-full">
      <div className="p-4 border-b flex items-center gap-3" style={{ borderColor: COLORS.surfaceLight }}>
        <button onClick={onBack} disabled={loading}><ChevronLeft size={24} color={COLORS.text} /></button>
        <h2 className="text-lg font-bold" style={{ color: COLORS.text }}>Create Account</h2>
      </div>
      <div className="flex-1 overflow-auto p-6">
        {error && (
          <div className="mb-4 p-3 rounded-xl flex items-center gap-2" style={{ backgroundColor: COLORS.error + '20' }}>
            <AlertCircle size={18} color={COLORS.error} />
            <p className="text-sm" style={{ color: COLORS.error }}>{error}</p>
          </div>
        )}

        <div className="space-y-4">
          <div className="flex gap-3">
            <div className="flex-1">
              <label className="text-sm mb-2 block" style={{ color: COLORS.textSecondary }}>First Name</label>
              <input type="text" placeholder="First name" value={regData.firstName}
                onChange={e => setRegData(p => ({...p, firstName: e.target.value}))}
                disabled={loading}
                className="w-full p-4 rounded-xl outline-none"
                style={{ backgroundColor: COLORS.surface, color: COLORS.text, border: `1px solid ${COLORS.surfaceLight}` }} />
            </div>
            <div className="flex-1">
              <label className="text-sm mb-2 block" style={{ color: COLORS.textSecondary }}>Last Name</label>
              <input type="text" placeholder="Last name" value={regData.lastName}
                onChange={e => setRegData(p => ({...p, lastName: e.target.value}))}
                disabled={loading}
                className="w-full p-4 rounded-xl outline-none"
                style={{ backgroundColor: COLORS.surface, color: COLORS.text, border: `1px solid ${COLORS.surfaceLight}` }} />
            </div>
          </div>
          <div>
            <label className="text-sm mb-2 block" style={{ color: COLORS.textSecondary }}>Username</label>
            <div className="relative">
              <span className="absolute left-4 top-1/2 -translate-y-1/2 text-sm" style={{ color: COLORS.textMuted }}>@</span>
              <input type="text" placeholder="your_username" value={regData.username}
                onChange={e => setRegData(p => ({...p, username: e.target.value.toLowerCase().replace(/[^a-z0-9_]/g, '')}))}
                disabled={loading}
                maxLength={20}
                className="w-full p-4 pl-8 rounded-xl outline-none"
                style={{ backgroundColor: COLORS.surface, color: COLORS.text,
                  border: `1px solid ${regData.username && !isUsernameValid ? COLORS.error : COLORS.surfaceLight}` }} />
            </div>
            {regData.username && !isUsernameValid && (
              <p className="text-xs mt-1" style={{ color: COLORS.error }}>Username must be 3-20 characters (letters, numbers, underscores)</p>
            )}
            <p className="text-xs mt-1" style={{ color: COLORS.textMuted }}>This is how friends will find you</p>
          </div>
          <div>
            <label className="text-sm mb-2 block" style={{ color: COLORS.textSecondary }}>Email</label>
            <input type="email" placeholder="your@email.com" value={regData.email}
              onChange={e => setRegData(p => ({...p, email: e.target.value}))}
              disabled={loading}
              className="w-full p-4 rounded-xl outline-none"
              style={{ backgroundColor: COLORS.surface, color: COLORS.text, border: `1px solid ${COLORS.surfaceLight}` }} />
          </div>
          <div>
            <label className="text-sm mb-2 block" style={{ color: COLORS.textSecondary }}>Password</label>
            <input type="password" placeholder="" value={regData.password}
              onChange={e => setRegData(p => ({...p, password: e.target.value}))}
              disabled={loading}
              className="w-full p-4 rounded-xl outline-none"
              style={{ backgroundColor: COLORS.surface, color: COLORS.text, border: `1px solid ${COLORS.surfaceLight}` }} />
            {regData.password && regData.password.length < 6 && (
              <p className="text-xs mt-1" style={{ color: COLORS.warning }}>Password must be at least 6 characters</p>
            )}
          </div>
          <div>
            <label className="text-sm mb-2 block" style={{ color: COLORS.textSecondary }}>Confirm Password</label>
            <input type="password" placeholder="" value={regData.confirmPassword}
              onChange={e => setRegData(p => ({...p, confirmPassword: e.target.value}))}
              disabled={loading}
              className="w-full p-4 rounded-xl outline-none"
              style={{ backgroundColor: COLORS.surface, color: COLORS.text,
                border: `1px solid ${regData.confirmPassword && regData.password !== regData.confirmPassword ? COLORS.error : COLORS.surfaceLight}` }} />
            {regData.confirmPassword && regData.password !== regData.confirmPassword && (
              <p className="text-xs mt-1" style={{ color: COLORS.error }}>Passwords don't match</p>
            )}
          </div>
          <div>
            <label className="text-sm mb-2 block" style={{ color: COLORS.textSecondary }}>Date of Birth</label>
            <input type="date" value={regData.dob}
              onChange={e => setRegData(p => ({...p, dob: e.target.value}))}
              disabled={loading}
              className="w-full p-4 rounded-xl outline-none"
              style={{ backgroundColor: COLORS.surface, color: COLORS.text, border: `1px solid ${COLORS.surfaceLight}` }} />
            <p className="text-xs mt-1" style={{ color: COLORS.textMuted }}>Used to calculate your fitness metrics</p>
          </div>
          <div>
            <label className="text-sm mb-2 block" style={{ color: COLORS.textSecondary }}>Gender</label>
            <div className="flex gap-3">
              {['male', 'female', 'other'].map(g => (
                <button
                  key={g}
                  type="button"
                  onClick={() => setRegData(p => ({...p, gender: g}))}
                  disabled={loading}
                  className="flex-1 py-3 px-4 rounded-xl text-sm font-medium capitalize"
                  style={{
                    backgroundColor: regData.gender === g ? COLORS.primary : COLORS.surface,
                    color: regData.gender === g ? COLORS.text : COLORS.textSecondary,
                    border: `1px solid ${regData.gender === g ? COLORS.primary : COLORS.surfaceLight}`
                  }}
                >
                  {g}
                </button>
              ))}
            </div>
            <p className="text-xs mt-1" style={{ color: COLORS.textMuted }}>Used for personalized workout recommendations</p>
          </div>
        </div>
      </div>
      <div className="p-6 border-t" style={{ borderColor: COLORS.surfaceLight }}>
        <button onClick={handleRegister} disabled={!isValid || loading}
          className="w-full py-4 rounded-xl font-semibold text-lg flex items-center justify-center gap-2"
          style={{ backgroundColor: COLORS.primary, color: COLORS.text, opacity: isValid && !loading ? 1 : 0.5 }}>
          {loading ? (
            <>
              <Loader2 size={20} className="animate-spin" />
              Creating Account...
            </>
          ) : (
            'Create Account'
          )}
        </button>
      </div>
    </div>
  );
}

// Workout time calculation constants and helpers (outside component for initialization)
const WORKOUT_TIMING = {
  AVG_SET_DURATION: 45, // Average time to complete one set (seconds)
  WARMUP_TIME: 300, // 5 minutes warmup
  COOLDOWN_TIME: 300, // 5 minutes cooldown
  TRANSITION_TIME: 30, // Time to move between exercises
};

const calculateWorkoutDuration = (exerciseList) => {
  if (!exerciseList || exerciseList.length === 0) return 0;
  let totalSeconds = WORKOUT_TIMING.WARMUP_TIME + WORKOUT_TIMING.COOLDOWN_TIME;
  exerciseList.forEach((ex) => {
    const sets = ex.sets || 3;
    const restTime = ex.restTime || 90;
    totalSeconds += sets * WORKOUT_TIMING.AVG_SET_DURATION;
    totalSeconds += (sets - 1) * restTime;
  });
  return totalSeconds;
};

const optimizeExercisesForTime = (exerciseList, targetMinutes) => {
  if (!exerciseList || exerciseList.length === 0) return exerciseList;
  const targetSeconds = targetMinutes * 60;

  // Calculate fixed time components (transition time absorbed into rest)
  const fixedTime = WORKOUT_TIMING.WARMUP_TIME + WORKOUT_TIMING.COOLDOWN_TIME;

  // Start with base exercises
  let optimized = exerciseList.map(ex => ({ ...ex, sets: ex.sets || 3 }));

  // Calculate total sets and working time
  let totalSets = optimized.reduce((sum, ex) => sum + ex.sets, 0);
  let workingTime = totalSets * WORKOUT_TIMING.AVG_SET_DURATION;

  // Calculate total rest periods needed (sets - exercises, since no rest after last set of each exercise)
  let totalRestPeriods = totalSets - optimized.length;

  // Available time for rest
  let availableRestTime = targetSeconds - fixedTime - workingTime;

  // If we have negative rest time, we need to reduce sets
  while (availableRestTime < totalRestPeriods * 30 && optimized.some(ex => ex.sets > 2)) {
    // Reduce sets from exercise with most sets
    const maxSetsEx = optimized.reduce((max, ex) => (ex.sets > max.sets) ? ex : max, optimized[0]);
    if (maxSetsEx.sets <= 2) break;
    const idx = optimized.findIndex(ex => ex.id === maxSetsEx.id);
    optimized[idx] = { ...optimized[idx], sets: optimized[idx].sets - 1 };

    // Recalculate
    totalSets = optimized.reduce((sum, ex) => sum + ex.sets, 0);
    workingTime = totalSets * WORKOUT_TIMING.AVG_SET_DURATION;
    totalRestPeriods = totalSets - optimized.length;
    availableRestTime = targetSeconds - fixedTime - workingTime;
  }

  // If we have too much time, add sets
  while (availableRestTime > totalRestPeriods * 180 && optimized.some(ex => ex.sets < 5)) {
    const minSetsEx = optimized.reduce((min, ex) => (ex.sets < min.sets && ex.sets < 5) ? ex : min, optimized[0]);
    if (minSetsEx.sets >= 5) break;
    const idx = optimized.findIndex(ex => ex.id === minSetsEx.id);
    optimized[idx] = { ...optimized[idx], sets: optimized[idx].sets + 1 };

    // Recalculate
    totalSets = optimized.reduce((sum, ex) => sum + ex.sets, 0);
    workingTime = totalSets * WORKOUT_TIMING.AVG_SET_DURATION;
    totalRestPeriods = totalSets - optimized.length;
    availableRestTime = targetSeconds - fixedTime - workingTime;
  }

  // Now distribute rest time EVENLY across all rest periods
  const restPerPeriod = totalRestPeriods > 0
    ? Math.max(30, Math.min(180, Math.round(availableRestTime / totalRestPeriods)))
    : 90;

  // Apply the same rest time to ALL exercises (even distribution)
  optimized = optimized.map(ex => ({
    ...ex,
    restTime: restPerPeriod
  }));

  return optimized;
};

const getWorkoutTimeBreakdown = (exerciseList) => {
  if (!exerciseList || exerciseList.length === 0) {
    return { workingTime: 0, restTime: 0, totalTime: 0, warmupCooldown: WORKOUT_TIMING.WARMUP_TIME + WORKOUT_TIMING.COOLDOWN_TIME };
  }
  let workingSeconds = 0;
  let totalSets = 0;
  let avgRestTime = 90;
  exerciseList.forEach((ex) => {
    const sets = ex.sets || 3;
    totalSets += sets;
    workingSeconds += sets * WORKOUT_TIMING.AVG_SET_DURATION;
    if (ex.restTime) avgRestTime = ex.restTime; // Use the optimized rest time
  });
  // Rest between ALL sets (not just within same exercise) - matches optimizer logic
  // Transition time is absorbed into rest periods
  const totalRestPeriods = Math.max(0, totalSets - 1);
  const totalRestSeconds = totalRestPeriods * avgRestTime;
  const warmupCooldown = WORKOUT_TIMING.WARMUP_TIME + WORKOUT_TIMING.COOLDOWN_TIME;
  return { workingTime: workingSeconds, restTime: totalRestSeconds, warmupCooldown, totalTime: workingSeconds + totalRestSeconds + warmupCooldown };
};

// Optimize exercises for a specific time AND exercise count
// This allows users to have more or fewer exercises while keeping the same total time
// workoutType is optional - if provided, ensures all target muscle groups are covered
// corePosition is optional - 'first' or 'last' - where to place core exercises
const optimizeExercisesForTimeAndCount = (baseExerciseList, fullExercisePool, targetMinutes, targetExerciseCount, workoutType = null, corePosition = 'last', includeWarmup = true, includeCooldown = true, preserveOrder = false) => {
  if (!baseExerciseList || baseExerciseList.length === 0) return baseExerciseList;
  const targetSeconds = targetMinutes * 60;

  let exercises = [...baseExerciseList];
  const defaultCount = Math.max(2, Math.floor(targetMinutes / 12));
  const targetCount = targetExerciseCount || defaultCount;
  const isShortening = targetCount < baseExerciseList.length;

  // If we need more exercises, add from the pool
  if (targetCount > exercises.length && fullExercisePool.length > exercises.length) {
    const currentIds = exercises.map(ex => ex.id);
    const additionalExercises = fullExercisePool
      .filter(ex => !currentIds.includes(ex.id))
      .slice(0, targetCount - exercises.length);
    exercises = [...exercises, ...additionalExercises];
  }

  // If we need fewer exercises, intelligently select which to keep
  if (targetCount < exercises.length) {
    if (preserveOrder) {
      // If preserving order, just truncate to target count (keep first N exercises)
      exercises = exercises.slice(0, targetCount);
    } else {
      // Prioritize keeping compounds and ensuring muscle group coverage
      const compounds = exercises.filter(ex => ex.exerciseType === 'compound');
      const isolations = exercises.filter(ex => ex.exerciseType !== 'compound');

      // Keep all compounds first (up to target count)
      const toKeep = compounds.slice(0, targetCount);

      // Fill remaining slots with isolations, prioritizing variety
      if (toKeep.length < targetCount) {
        const musclesCovered = new Set(toKeep.map(ex => ex.muscleGroup));
        // First add isolations targeting muscles not yet covered
        const uncoveredIsolations = isolations.filter(ex => !musclesCovered.has(ex.muscleGroup));
        const coveredIsolations = isolations.filter(ex => musclesCovered.has(ex.muscleGroup));
        const orderedIsolations = [...uncoveredIsolations, ...coveredIsolations];
        toKeep.push(...orderedIsolations.slice(0, targetCount - toKeep.length));
      }

      exercises = toKeep;
    }
  }

  // Ensure muscle group coverage if we shortened the workout (only if not preserving order)
  if (isShortening && workoutType && !preserveOrder) {
    exercises = ensureMuscleGroupCoverage(exercises, workoutType, fullExercisePool);
  }

  // Calculate fixed time components (transition time absorbed into rest)
  const warmupTime = includeWarmup ? WORKOUT_TIMING.WARMUP_TIME : 0;
  const cooldownTime = includeCooldown ? WORKOUT_TIMING.COOLDOWN_TIME : 0;
  const fixedTime = warmupTime + cooldownTime;

  // Start with base sets
  let optimized = exercises.map(ex => ({ ...ex, sets: ex.sets || 3 }));

  // Helper function to recalculate timing values
  const recalculate = () => {
    const totalSets = optimized.reduce((sum, ex) => sum + ex.sets, 0);
    const workingTime = totalSets * WORKOUT_TIMING.AVG_SET_DURATION;
    // Rest after every set except the last one in the entire workout
    const totalRestPeriods = Math.max(0, totalSets - 1);
    const availableRestTime = targetSeconds - fixedTime - workingTime;
    return { totalSets, workingTime, totalRestPeriods, availableRestTime };
  };

  let timing = recalculate();

  // First pass: If more exercises than default, reduce sets to fit
  if (targetCount > defaultCount) {
    while (timing.availableRestTime < timing.totalRestPeriods * 30 && optimized.some(ex => ex.sets > 2)) {
      const maxSetsEx = optimized.reduce((max, ex) => (ex.sets > max.sets) ? ex : max, optimized[0]);
      if (maxSetsEx.sets <= 2) break;
      const idx = optimized.findIndex(ex => ex.id === maxSetsEx.id);
      optimized[idx] = { ...optimized[idx], sets: optimized[idx].sets - 1 };
      timing = recalculate();
    }
  }

  // Second pass: ALWAYS try to fill remaining time by adding sets
  // If rest per period would exceed 120 seconds (2 min), add more sets to use the time productively
  // Max 6 sets per exercise to prevent excessive volume
  const MAX_SETS_PER_EXERCISE = 6;
  const IDEAL_REST_TIME = 90; // Target ~90 seconds rest between sets

  while (timing.totalRestPeriods > 0 &&
         timing.availableRestTime / timing.totalRestPeriods > IDEAL_REST_TIME + 30 &&
         optimized.some(ex => ex.sets < MAX_SETS_PER_EXERCISE)) {
    // Find exercise with fewest sets that's under max
    const minSetsEx = optimized
      .filter(ex => ex.sets < MAX_SETS_PER_EXERCISE)
      .reduce((min, ex) => (ex.sets < min.sets) ? ex : min, optimized.find(ex => ex.sets < MAX_SETS_PER_EXERCISE));

    if (!minSetsEx) break;

    const idx = optimized.findIndex(ex => ex.id === minSetsEx.id);
    optimized[idx] = { ...optimized[idx], sets: optimized[idx].sets + 1 };
    timing = recalculate();

    // Safety check: if we've maxed all exercises, stop
    if (optimized.every(ex => ex.sets >= MAX_SETS_PER_EXERCISE)) break;
  }

  // Final recalculation
  timing = recalculate();

  // Distribute rest evenly (min 30s, max 180s)
  const restPerPeriod = timing.totalRestPeriods > 0
    ? Math.max(30, Math.min(180, Math.round(timing.availableRestTime / timing.totalRestPeriods)))
    : 90;

  optimized = optimized.map(ex => ({
    ...ex,
    restTime: restPerPeriod
  }));

  // Only reorder for muscle group recovery if user hasn't customized the order
  if (!preserveOrder) {
    // Reorder exercises to avoid same muscle groups back-to-back
    // This provides better recovery between exercises for the same muscles
    // Skip cardio exercises in reordering (keep them at the end)
    const cardioExercises = optimized.filter(ex => ex.isCardio || ex.muscleGroup === 'Cardio');
    const nonCardioExercises = optimized.filter(ex => !ex.isCardio && ex.muscleGroup !== 'Cardio');
    const reorderedNonCardio = reorderExercisesForRecovery(nonCardioExercises);
    optimized = [...reorderedNonCardio, ...cardioExercises];
  }

  // Always apply core positioning based on user preference (this is a setting, not manual ordering)
  if (corePosition && optimized.length > 1) {
    const coreExercises = optimized.filter(ex => ex.muscleGroup === 'Core' || ex.muscleGroup?.toLowerCase()?.includes('core'));
    const nonCoreExercises = optimized.filter(ex => ex.muscleGroup !== 'Core' && !ex.muscleGroup?.toLowerCase()?.includes('core'));

    if (coreExercises.length > 0 && nonCoreExercises.length > 0) {
      optimized = corePosition === 'first'
        ? [...coreExercises, ...nonCoreExercises]
        : [...nonCoreExercises, ...coreExercises];
    }
  }

  // Check if workout still exceeds target time - if so, try to create supersets
  const currentTotalTime = getWorkoutTimeBreakdown(optimized).totalTime;
  const timeOverTarget = (currentTotalTime - targetSeconds) / 60; // in minutes

  if (timeOverTarget > 2) { // Only superset if we're more than 2 minutes over
    const supersetResult = createSupersets(optimized, timeOverTarget);
    if (supersetResult.supersets.length > 0) {
      optimized = supersetResult.exercises;
    }
  }

  return optimized;
};

// ActiveWorkoutScreen as separate component
function ActiveWorkoutScreen({ onClose, onComplete, onSaveProgress, COLORS, availableTime = 60, userGoal = 'build_muscle', userExperience = 'beginner', userId = null, workoutName = 'Workout', workoutTemplate = null, injuries = [], includeWarmup = true, includeCooldown = true, savedProgress = null }) {
  // Use passed workout template (workoutTemplate prop is now required)
  const activeWorkout = workoutTemplate;
  const isAdvancedUser = ['experienced', 'expert'].includes(userExperience);
  const [sessionId, setSessionId] = useState(savedProgress?.sessionId || null);
  const [isSaving, setIsSaving] = useState(false);
  const [phase, setPhase] = useState(savedProgress?.phase || (includeWarmup ? 'warmup' : 'workout')); // 'warmup', 'workout', 'workoutOverview', 'cooldown', 'complete'
  const [currentExerciseIndex, setCurrentExerciseIndex] = useState(savedProgress?.currentExerciseIndex || 0);
  const [currentSetIndex, setCurrentSetIndex] = useState(savedProgress?.currentSetIndex || 0);
  const [isResting, setIsResting] = useState(false);
  const [restTimeLeft, setRestTimeLeft] = useState(0);
  const [completedSets, setCompletedSets] = useState(savedProgress?.completedSets || []);
  const [currentSetData, setCurrentSetData] = useState({ weight: 0, reps: 0, rpe: 5 });
  const [showExerciseHistory, setShowExerciseHistory] = useState(null);
  const [showSwapExercise, setShowSwapExercise] = useState(null);
  const [swapSearch, setSwapSearch] = useState('');
  // Use exercises exactly as passed from the workout template (already optimized)
  const [exercises, setExercises] = useState(() => {
    // If resuming, use saved exercises
    if (savedProgress?.exercises) {
      return savedProgress.exercises;
    }
    const baseExercises = activeWorkout?.exercises || [];
    // Use exercises directly as passed - they're already optimized for time/count
    return baseExercises.map(ex => ({
      ...ex,
      history: [],
      alternatives: DEFAULT_ALL_EXERCISES.filter(e => e.muscleGroup === ex.muscleGroup).slice(0, 5).map(e => e.name)
    }));
  });
  const [showAddExercise, setShowAddExercise] = useState(false);
  const [addExerciseSearch, setAddExerciseSearch] = useState('');
  const [showFullWorkoutList, setShowFullWorkoutList] = useState(false);
  const [editingSet, setEditingSet] = useState(null); // { exerciseId, setIndex }
  const [editSetData, setEditSetData] = useState({ weight: 0, reps: 0, rpe: 5 });
  const [showEndWorkoutConfirm, setShowEndWorkoutConfirm] = useState(false);
  const [showExerciseInfoModal, setShowExerciseInfoModal] = useState(null); // exercise name to show info for

  // Workout media (photos/videos)
  const [workoutMedia, setWorkoutMedia] = useState([]);
  const fileInputRef = React.useRef(null);

  // Publish workout state
  const [showPublishPrompt, setShowPublishPrompt] = useState(false);
  const [publishWorkoutName, setPublishWorkoutName] = useState('');
  const [publishWorkoutDesc, setPublishWorkoutDesc] = useState('');
  const [isPublishing, setIsPublishing] = useState(false);
  
  // Time tracking - initialize start time immediately since we start in workout phase
  const [workoutStartTime, setWorkoutStartTime] = useState(() => savedProgress?.workoutStartTime || Date.now());
  const [workoutEndTime, setWorkoutEndTime] = useState(null);
  const [setStartTime, setSetStartTime] = useState(() => Date.now());
  const [totalWorkingTime, setTotalWorkingTime] = useState(savedProgress?.totalWorkingTime || 0); // Time actually doing sets (in seconds)
  const [totalRestTime, setTotalRestTime] = useState(savedProgress?.totalRestTime || 0); // Time spent resting (in seconds)

  // Optimize exercise order based on user's goal
  const optimizeExerciseOrder = (exerciseList) => {
    if (!exerciseList || exerciseList.length <= 1) return exerciseList;
    
    const sorted = [...exerciseList];
    
    // Define muscle group priorities based on goal
    const getPriority = (muscleGroup) => {
      if (userGoal === 'build_muscle') {
        // Prioritize larger muscle groups first for maximum hypertrophy
        const priorities = { 'Chest': 1, 'Back': 2, 'Quads': 3, 'Hamstrings/Glutes': 4, 'Shoulders': 5, 'Triceps': 6, 'Biceps': 7, 'Calves': 8, 'Core': 9 };
        return priorities[muscleGroup] || 10;
      } else if (userGoal === 'strength') {
        // Prioritize compound movements and powerlifting muscles
        const priorities = { 'Quads': 1, 'Back': 2, 'Chest': 3, 'Hamstrings/Glutes': 4, 'Shoulders': 5, 'Core': 6, 'Triceps': 7, 'Biceps': 8, 'Calves': 9 };
        return priorities[muscleGroup] || 10;
      } else if (userGoal === 'lose_fat') {
        // Prioritize larger muscle groups for more calorie burn, then circuits
        const priorities = { 'Quads': 1, 'Back': 2, 'Chest': 3, 'Hamstrings/Glutes': 4, 'Shoulders': 5, 'Core': 6, 'Triceps': 7, 'Biceps': 8, 'Calves': 9 };
        return priorities[muscleGroup] || 10;
      } else {
        // General fitness - balanced approach
        const priorities = { 'Chest': 1, 'Back': 2, 'Quads': 3, 'Shoulders': 4, 'Hamstrings/Glutes': 5, 'Core': 6, 'Triceps': 7, 'Biceps': 8, 'Calves': 9 };
        return priorities[muscleGroup] || 10;
      }
    };
    
    // Also consider compound vs isolation - compounds first
    const getTypeBonus = (exercise) => {
      const compoundExercises = ['Bench Press', 'Squat', 'Deadlift', 'Overhead Press', 'Barbell Row', 'Pull-up', 'Dip', 'Lunge', 'Romanian Deadlift'];
      const isCompound = compoundExercises.some(c => exercise.name.toLowerCase().includes(c.toLowerCase()));
      return isCompound ? 0 : 100; // Compounds get priority
    };
    
    sorted.sort((a, b) => {
      const priorityA = getPriority(a.muscleGroup) + getTypeBonus(a);
      const priorityB = getPriority(b.muscleGroup) + getTypeBonus(b);
      return priorityA - priorityB;
    });
    
    return sorted;
  };

  // Use exercises and calculate time breakdown
  const exercisesForTime = exercises;
  const timeBreakdown = getWorkoutTimeBreakdown(exercisesForTime);

  const totalSets = exercisesForTime.reduce((acc, ex) => acc + ex.sets, 0);
  const completedSetsCount = completedSets.length;
  const progressPercent = (completedSetsCount / totalSets) * 100;
  const currentExercise = exercisesForTime[currentExerciseIndex];

  useEffect(() => {
    if (currentExercise) {
      // Get completed sets for this exercise
      const exerciseCompletedSets = completedSets.filter(s => s.exerciseId === currentExercise.id);
      const lastCompletedSet = exerciseCompletedSets[exerciseCompletedSets.length - 1];

      // If we have a previous set for this exercise, use that data as suggestion
      if (lastCompletedSet) {
        setCurrentSetData({
          weight: lastCompletedSet.weight,
          reps: lastCompletedSet.reps,
          rpe: lastCompletedSet.rpe || 5
        });
      } else {
        // Otherwise use exercise defaults
        setCurrentSetData({
          weight: currentExercise.suggestedWeight || currentExercise.lastWeight || 0,
          reps: currentExercise.targetReps,
          rpe: 5
        });
      }
    }
  }, [currentExerciseIndex, currentSetIndex, currentExercise?.id]);

  useEffect(() => {
    let interval;
    if (isResting && restTimeLeft > 0) {
      interval = setInterval(() => setRestTimeLeft(prev => prev - 1), 1000);
    } else if (restTimeLeft === 0 && isResting) {
      setIsResting(false);
      setSetStartTime(Date.now()); // Start timing the next set
    }
    return () => clearInterval(interval);
  }, [isResting, restTimeLeft]);

  // Start workout session in Supabase when component mounts
  useEffect(() => {
    const startSession = async () => {
      if (userId && !sessionId) {
        try {
          const { data: session } = await workoutService.startWorkout(userId, null, null, workoutName);
          if (session) {
            setSessionId(session.id);
          }
        } catch (err) {
          console.error('Error starting workout session:', err);
        }
      }
    };
    startSession();
  }, [userId, workoutName]);

  const formatTime = (seconds) => `${Math.floor(seconds / 60)}:${(seconds % 60).toString().padStart(2, '0')}`;

  const formatDuration = (ms) => {
    const totalSeconds = Math.round(ms / 1000);
    const mins = Math.floor(totalSeconds / 60);
    const secs = totalSeconds % 60;
    return `${mins}:${secs.toString().padStart(2, '0')}`;
  };

  const completeSet = () => {
    // Track working time for this set
    if (setStartTime) {
      const setDuration = Math.round((Date.now() - setStartTime) / 1000);
      setTotalWorkingTime(prev => prev + setDuration);
    }
    
    setCompletedSets(prev => [...prev, { 
      exerciseId: currentExercise.id, 
      setIndex: currentSetIndex, 
      weight: currentSetData.weight, 
      reps: currentSetData.reps,
      rpe: currentSetData.rpe 
    }]);
    
    if (currentSetIndex < currentExercise.sets - 1) {
      const restDuration = currentExercise.restTime;
      setRestTimeLeft(restDuration);
      setTotalRestTime(prev => prev + restDuration);
      setIsResting(true);
      setCurrentSetIndex(prev => prev + 1);
    } else if (currentExerciseIndex < exercisesForTime.length - 1) {
      const restDuration = currentExercise.restTime;
      setRestTimeLeft(restDuration);
      setTotalRestTime(prev => prev + restDuration);
      setIsResting(true);
      setCurrentExerciseIndex(prev => prev + 1);
      setCurrentSetIndex(0);
    } else {
      setWorkoutEndTime(Date.now());
      setPhase(includeCooldown ? 'cooldown' : 'complete');
    }
  };

  const updateCompletedSet = (exerciseId, setIndex, newData) => {
    setCompletedSets(prev => prev.map(s => 
      s.exerciseId === exerciseId && s.setIndex === setIndex 
        ? { ...s, ...newData }
        : s
    ));
    setEditingSet(null);
  };
  
  const skipToExercise = (exerciseIndex, setIndex = 0) => {
    setCurrentExerciseIndex(exerciseIndex);
    setCurrentSetIndex(setIndex);
    setIsResting(false);
    setSetStartTime(Date.now()); // Start timing the new set
    setShowFullWorkoutList(false);
  };
  
  const endWorkoutEarly = () => {
    // Track any remaining working time from current set
    if (setStartTime && !isResting) {
      const setDuration = Math.round((Date.now() - setStartTime) / 1000);
      setTotalWorkingTime(prev => prev + setDuration);
    }
    setWorkoutEndTime(Date.now());
    setPhase(includeCooldown ? 'cooldown' : 'complete');
    setShowEndWorkoutConfirm(false);
  };

  const swapExercise = (exerciseIndex, newExerciseName) => {
    const existingExercise = DEFAULT_ALL_EXERCISES.find(e => e.name === newExerciseName);
    const newExercise = { 
      ...exercises[exerciseIndex], 
      name: newExerciseName, 
      id: newExerciseName.toLowerCase().replace(/\s/g, '_') + '_' + Date.now(),
      muscleGroup: existingExercise?.muscleGroup || exercises[exerciseIndex].muscleGroup
    };
    setExercises(prev => {
      const updated = prev.map((ex, i) => i === exerciseIndex ? newExercise : ex);
      return optimizeExerciseOrder(updated);
    });
    setShowSwapExercise(null);
    setSwapSearch('');
  };

  // Move exercise up or down in the list
  const moveExercise = (index, direction) => {
    const newIndex = direction === 'up' ? index - 1 : index + 1;
    if (newIndex < 0 || newIndex >= exercises.length) return;
    setExercises(prev => {
      const updated = [...prev];
      [updated[index], updated[newIndex]] = [updated[newIndex], updated[index]];
      return updated;
    });
    // Adjust current exercise index if needed
    if (currentExerciseIndex === index) {
      setCurrentExerciseIndex(newIndex);
    } else if (currentExerciseIndex === newIndex) {
      setCurrentExerciseIndex(index);
    }
  };

  const addExercise = (exerciseName) => {
    const existingExercise = DEFAULT_ALL_EXERCISES.find(e => e.name === exerciseName);
    const newEx = {
      id: exerciseName.toLowerCase().replace(/\s/g, '_') + '_' + Date.now(),
      name: exerciseName,
      sets: 3,
      targetReps: existingExercise?.type === 'compound' ? 8 : 12,
      suggestedWeight: 20,
      lastWeight: 0,
      lastReps: [0, 0, 0],
      restTime: existingExercise?.type === 'compound' ? 180 : 90,
      muscleGroup: existingExercise?.muscleGroup || 'Other',
      history: [],
      alternatives: []
    };
    
    setExercises(prev => {
      const updated = [...prev, newEx];
      return optimizeExerciseOrder(updated);
    });
    setShowAddExercise(false);
    setAddExerciseSearch('');
  };
  
  const removeExercise = (exerciseIndex) => {
    // Don't remove if it's the only exercise
    if (exercises.length <= 1) return;
    
    // Check if any sets completed for this exercise
    const exerciseId = exercises[exerciseIndex].id;
    const hasCompletedSets = completedSets.some(s => s.exerciseId === exerciseId);
    
    setExercises(prev => {
      const updated = prev.filter((_, i) => i !== exerciseIndex);
      return optimizeExerciseOrder(updated);
    });
    
    // Adjust current index if needed
    if (currentExerciseIndex >= exerciseIndex && currentExerciseIndex > 0) {
      setCurrentExerciseIndex(prev => prev - 1);
    }
  };

  const addSetToExercise = (exerciseIndex) => {
    setExercises(prev => prev.map((ex, i) => i === exerciseIndex ? { ...ex, sets: ex.sets + 1, lastReps: [...ex.lastReps, ex.targetReps] } : ex));
  };

  const removeSetFromExercise = (exerciseIndex) => {
    const exercise = exercises[exerciseIndex];
    // Don't allow removing if only 1 set left
    if (exercise.sets <= 1) return;
    // Remove the last set
    setExercises(prev => prev.map((ex, i) => i === exerciseIndex ? { ...ex, sets: ex.sets - 1, lastReps: ex.lastReps.slice(0, -1) } : ex));
    // If we're on the last set of this exercise and removing it, adjust set index
    if (exerciseIndex === currentExerciseIndex && currentSetIndex >= exercise.sets - 1) {
      setCurrentSetIndex(Math.max(0, exercise.sets - 2));
    }
  };

  const getCompletedForExercise = (exId) => completedSets.filter(s => s.exerciseId === exId);
  const getUpcomingExercises = () => exercisesForTime.slice(currentExerciseIndex + 1);
  const filteredSwapExercises = DEFAULT_ALL_EXERCISES.filter(ex => ex.name.toLowerCase().includes(swapSearch.toLowerCase()));
  const filteredAddExercises = DEFAULT_ALL_EXERCISES.filter(ex => {
    // Filter by search
    const matchesSearch = ex.name.toLowerCase().includes(addExerciseSearch.toLowerCase());
    // Exclude already added exercises (by name, since IDs might differ)
    const alreadyAdded = exercises.some(e => e.name === ex.name);
    return matchesSearch && !alreadyAdded;
  });

  // Safety check: if no exercises, show error state
  if (exercisesForTime.length === 0 && phase !== 'warmup' && phase !== 'cooldown') {
    return (
      <div className="fixed inset-0 z-50 flex flex-col items-center justify-center p-4" style={{ backgroundColor: COLORS.background }}>
        <div className="text-center">
          <div className="w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4" style={{ backgroundColor: COLORS.error + '20' }}>
            <X size={32} color={COLORS.error} />
          </div>
          <h2 className="text-xl font-bold mb-2" style={{ color: COLORS.text }}>No Exercises Available</h2>
          <p className="text-sm mb-6" style={{ color: COLORS.textMuted }}>
            This workout doesn't have any exercises. Please try a different workout or check your settings.
          </p>
          <button
            onClick={onClose}
            className="px-6 py-3 rounded-xl font-semibold"
            style={{ backgroundColor: COLORS.primary, color: COLORS.text }}
          >
            Go Back
          </button>
        </div>
      </div>
    );
  }

  // EXERCISE HISTORY MODAL
  if (showExerciseHistory !== null) {
    const exercise = exercisesForTime[showExerciseHistory];
    const maxE1rm = Math.max(...(exercise.history?.map(h => h.e1rm) || [0]));
    return (
      <div className="fixed inset-0 z-50 flex flex-col" style={{ backgroundColor: COLORS.background }}>
        <div className="p-4 border-b flex items-center gap-3" style={{ borderColor: COLORS.surfaceLight }}>
          <button onClick={() => setShowExerciseHistory(null)}><ChevronLeft size={24} color={COLORS.text} /></button>
          <h2 className="text-lg font-bold" style={{ color: COLORS.text }}>{exercise.name} History</h2>
        </div>
        <div className="flex-1 overflow-auto p-4">
          <div className="p-4 rounded-xl mb-4" style={{ backgroundColor: COLORS.surface }}>
            <p className="text-sm mb-2" style={{ color: COLORS.textMuted }}>Estimated 1RM Progress</p>
            <div className="h-32 flex items-end gap-2">
              {exercise.history?.map((h, i) => (
                <div key={i} className="flex-1 flex flex-col items-center">
                  <div className="w-full rounded-t" style={{ backgroundColor: COLORS.primary, height: `${(h.e1rm / maxE1rm) * 100}%`, minHeight: 8 }} />
                  <p className="text-xs mt-1 font-bold" style={{ color: COLORS.text }}>{h.e1rm}kg</p>
                  <p className="text-xs" style={{ color: COLORS.textMuted }}>{h.date}</p>
                </div>
              ))}
            </div>
          </div>
          <p className="font-semibold mb-3" style={{ color: COLORS.text }}>Previous Sessions</p>
          <div className="space-y-3">
            {exercise.history?.map((session, i) => (
              <div key={i} className="p-4 rounded-xl" style={{ backgroundColor: COLORS.surface }}>
                <div className="flex justify-between items-center mb-2">
                  <p className="font-semibold" style={{ color: COLORS.text }}>{session.date}</p>
                  <span className="text-xs px-2 py-1 rounded" style={{ backgroundColor: COLORS.accent + '20', color: COLORS.accent }}>e1RM: {session.e1rm}kg</span>
                </div>
                <p style={{ color: COLORS.textSecondary }}>{session.weight}kg  {session.reps.join(', ')} reps</p>
              </div>
            ))}
          </div>
        </div>
        <div className="p-4"><button onClick={() => setShowExerciseHistory(null)} className="w-full py-4 rounded-xl font-semibold" style={{ backgroundColor: COLORS.primary, color: COLORS.text }}>Back to Workout</button></div>
      </div>
    );
  }

  // SWAP EXERCISE MODAL
  if (showSwapExercise !== null) {
    const exercise = exercisesForTime[showSwapExercise];
    return (
      <div className="fixed inset-0 z-50 flex flex-col" style={{ backgroundColor: COLORS.background }}>
        <div className="p-4 border-b flex items-center gap-3" style={{ borderColor: COLORS.surfaceLight }}>
          <button onClick={() => { setShowSwapExercise(null); setSwapSearch(''); }}><ChevronLeft size={24} color={COLORS.text} /></button>
          <h2 className="text-lg font-bold" style={{ color: COLORS.text }}>Swap {exercise.name}</h2>
        </div>
        <div className="flex-1 overflow-auto p-4">
          <input type="text" placeholder="Search exercises..." value={swapSearch} onChange={e => setSwapSearch(e.target.value)}
            className="w-full p-4 rounded-xl mb-4" style={{ backgroundColor: COLORS.surface, color: COLORS.text, border: `1px solid ${COLORS.surfaceLight}` }} />
          <p className="text-sm font-semibold mb-2" style={{ color: COLORS.text }}>Suggested Alternatives</p>
          <div className="space-y-2 mb-4">
            {exercise.alternatives?.map(alt => (
              <div key={alt} className="w-full p-4 rounded-xl flex justify-between items-center" style={{ backgroundColor: COLORS.surface }}>
                <div className="flex items-center gap-2">
                  <span style={{ color: COLORS.text }}>{alt}</span>
                  <button onClick={(e) => { e.preventDefault(); e.stopPropagation(); setShowExerciseInfoModal(alt); }} className="p-1 rounded-full" style={{ backgroundColor: COLORS.primary + '20' }}><Info size={14} color={COLORS.primary} /></button>
                </div>
                <button onClick={() => swapExercise(showSwapExercise, alt)} className="px-3 py-1 rounded-lg text-sm font-medium" style={{ backgroundColor: COLORS.primary, color: COLORS.text }}>Select</button>
              </div>
            ))}
          </div>
          {swapSearch && (
            <>
              <p className="text-sm font-semibold mb-2" style={{ color: COLORS.text }}>Search Results</p>
              <div className="space-y-2">
                {filteredSwapExercises.slice(0, 8).map(ex => (
                  <div key={ex.name} className="w-full p-4 rounded-xl flex justify-between items-center" style={{ backgroundColor: COLORS.surface }}>
                    <div className="flex items-center gap-2">
                      <div>
                        <p style={{ color: COLORS.text }}>{ex.name}</p>
                        <p className="text-xs" style={{ color: COLORS.textMuted }}>{ex.muscleGroup}</p>
                      </div>
                      <button onClick={(e) => { e.preventDefault(); e.stopPropagation(); setShowExerciseInfoModal(ex.name); }} className="p-1 rounded-full" style={{ backgroundColor: COLORS.primary + '20' }}><Info size={14} color={COLORS.primary} /></button>
                    </div>
                    <button onClick={() => swapExercise(showSwapExercise, ex.name)} className="px-3 py-1 rounded-lg text-sm font-medium" style={{ backgroundColor: COLORS.primary, color: COLORS.text }}>Select</button>
                  </div>
                ))}
              </div>
            </>
          )}
        </div>
      </div>
    );
  }

  // ADD EXERCISE MODAL
  if (showAddExercise) {
    // Group exercises by muscle group for easier browsing
    const groupedExercises = filteredAddExercises.reduce((acc, ex) => {
      if (!acc[ex.muscleGroup]) acc[ex.muscleGroup] = [];
      acc[ex.muscleGroup].push(ex);
      return acc;
    }, {});
    
    return (
      <div className="fixed inset-0 z-50 flex flex-col" style={{ backgroundColor: COLORS.background }}>
        <div className="p-4 border-b flex items-center gap-3" style={{ borderColor: COLORS.surfaceLight }}>
          <button onClick={() => { setShowAddExercise(false); setAddExerciseSearch(''); }}><ChevronLeft size={24} color={COLORS.text} /></button>
          <h2 className="text-lg font-bold" style={{ color: COLORS.text }}>Add Exercise</h2>
        </div>
        <div className="p-4 pb-2" style={{ backgroundColor: COLORS.primary + '10' }}>
          <p className="text-xs" style={{ color: COLORS.primary }}>
            Exercises will be automatically reordered to optimize for your {userGoal === 'build_muscle' ? 'muscle building' : userGoal === 'strength' ? 'strength' : userGoal === 'lose_fat' ? 'fat loss' : 'fitness'} goal
          </p>
        </div>
        <div className="p-4 pt-2">
          <input type="text" placeholder="Search exercises..." value={addExerciseSearch} onChange={e => setAddExerciseSearch(e.target.value)}
            className="w-full p-4 rounded-xl" style={{ backgroundColor: COLORS.surface, color: COLORS.text, border: `1px solid ${COLORS.surfaceLight}` }} />
        </div>
        <div className="flex-1 overflow-auto px-4 pb-4">
          {filteredAddExercises.length === 0 ? (
            <div className="text-center py-8">
              <p style={{ color: COLORS.textMuted }}>No exercises found</p>
              <p className="text-xs mt-1" style={{ color: COLORS.textMuted }}>
                {addExerciseSearch ? 'Try a different search term' : 'All exercises already added'}
              </p>
            </div>
          ) : (
            Object.entries(groupedExercises).map(([muscleGroup, exs]) => (
              <div key={muscleGroup} className="mb-4">
                <p className="text-xs font-semibold mb-2 px-1" style={{ color: COLORS.textMuted }}>{muscleGroup.toUpperCase()}</p>
                <div className="space-y-2">
                  {exs.map(ex => (
                    <div key={ex.name} className="w-full p-4 rounded-xl flex justify-between items-center" style={{ backgroundColor: COLORS.surface }}>
                      <div className="flex items-center gap-2">
                        <div>
                          <p style={{ color: COLORS.text }}>{ex.name}</p>
                          <p className="text-xs" style={{ color: COLORS.textMuted }}>{ex.equipment}  {ex.type}</p>
                        </div>
                        <button onClick={(e) => { e.preventDefault(); e.stopPropagation(); setShowExerciseInfoModal(ex.name); }} className="p-1 rounded-full" style={{ backgroundColor: COLORS.primary + '20' }}><Info size={14} color={COLORS.primary} /></button>
                      </div>
                      <button onClick={() => addExercise(ex.name)} className="w-8 h-8 rounded-full flex items-center justify-center" style={{ backgroundColor: COLORS.primary }}><Plus size={18} color={COLORS.text} /></button>
                    </div>
                  ))}
                </div>
              </div>
            ))
          )}
        </div>
      </div>
    );
  }

  // WORKOUT OVERVIEW (during workout)
  if (phase === 'workoutOverview') {
    return (
      <div className="fixed inset-0 z-50 flex flex-col" style={{ backgroundColor: COLORS.background }}>
        <div className="p-4 border-b flex items-center justify-between" style={{ borderColor: COLORS.surfaceLight }}>
          <div className="flex items-center gap-3">
            <button onClick={() => setPhase('workout')}><ChevronLeft size={24} color={COLORS.text} /></button>
            <h2 className="text-lg font-bold" style={{ color: COLORS.text }}>Workout Overview</h2>
          </div>
          <span className="text-sm" style={{ color: COLORS.textMuted }}>{completedSetsCount}/{totalSets} sets</span>
        </div>
        <div className="flex-1 overflow-auto p-4">
          {exercisesForTime.map((exercise, exIdx) => {
            const exCompletedSets = getCompletedForExercise(exercise.id);
            const isCurrentEx = exIdx === currentExerciseIndex;
            const isCompleted = exCompletedSets.length === exercise.sets;
            return (
              <div key={exercise.id} className="mb-3 p-4 rounded-xl" style={{ backgroundColor: COLORS.surface, border: isCurrentEx ? `2px solid ${COLORS.primary}` : 'none' }}>
                <div className="flex items-center justify-between mb-2">
                  <div className="flex items-center gap-2">
                    {isCompleted ? <Check size={18} color={COLORS.success} /> : isCurrentEx ? <Play size={18} color={COLORS.primary} /> : <div className="w-4.5 h-4.5" />}
                    <div className="flex items-center gap-2">
                      <div>
                        <p className="font-semibold" style={{ color: isCompleted ? COLORS.success : COLORS.text }}>{exercise.name}</p>
                        {isAdvancedUser && exercise.targetedHeads && exercise.targetedHeads.length > 0 && (
                          <p className="text-xs" style={{ color: COLORS.textMuted }}>{exercise.targetedHeads.join(', ')}</p>
                        )}
                      </div>
                      <button onClick={(e) => { e.preventDefault(); e.stopPropagation(); setShowExerciseInfoModal(exercise.name); }} className="p-1 rounded-full" style={{ backgroundColor: COLORS.primary + '20' }}><Info size={14} color={COLORS.primary} /></button>
                    </div>
                  </div>
                  <div className="flex items-center gap-1">
                    {/* Reorder buttons */}
                    <button onClick={(e) => { e.stopPropagation(); moveExercise(exIdx, 'up'); }} disabled={exIdx === 0} className="p-1 rounded" style={{ backgroundColor: COLORS.surfaceLight, opacity: exIdx === 0 ? 0.4 : 1 }}><ChevronUp size={14} color={COLORS.textMuted} /></button>
                    <button onClick={(e) => { e.stopPropagation(); moveExercise(exIdx, 'down'); }} disabled={exIdx === exercises.length - 1} className="p-1 rounded" style={{ backgroundColor: COLORS.surfaceLight, opacity: exIdx === exercises.length - 1 ? 0.4 : 1 }}><ChevronDown size={14} color={COLORS.textMuted} /></button>
                    {/* Add/Remove set buttons */}
                    <button onClick={() => removeSetFromExercise(exIdx)} disabled={exercise.sets <= 1} className="p-1 rounded" style={{ backgroundColor: COLORS.surfaceLight, opacity: exercise.sets <= 1 ? 0.4 : 1 }}><Minus size={14} color={COLORS.textMuted} /></button>
                    <button onClick={() => addSetToExercise(exIdx)} className="p-1 rounded" style={{ backgroundColor: COLORS.surfaceLight }}><Plus size={14} color={COLORS.textMuted} /></button>
                    <button onClick={() => setShowSwapExercise(exIdx)} className="p-1 rounded" style={{ backgroundColor: COLORS.surfaceLight }}><ArrowLeftRight size={14} color={COLORS.textMuted} /></button>
                    {exercises.length > 1 && (
                      <button onClick={() => removeExercise(exIdx)} className="p-1 rounded" style={{ backgroundColor: COLORS.error + '20' }}><X size={14} color={COLORS.error} /></button>
                    )}
                  </div>
                </div>
                <div className="flex gap-2">
                  {Array(exercise.sets).fill(0).map((_, setIdx) => {
                    const completedSet = exCompletedSets[setIdx];
                    return (
                      <div key={setIdx} className="px-2 py-1 rounded text-xs" style={{ backgroundColor: completedSet ? COLORS.success + '20' : COLORS.surfaceLight, color: completedSet ? COLORS.success : COLORS.textMuted }}>
                        {completedSet ? `${completedSet.weight}${completedSet.reps}` : `Set ${setIdx + 1}`}
                      </div>
                    );
                  })}
                </div>
              </div>
            );
          })}
          <button onClick={() => setShowAddExercise(true)} className="w-full p-4 rounded-xl flex items-center justify-center gap-2" style={{ backgroundColor: COLORS.surfaceLight, border: `2px dashed ${COLORS.textMuted}` }}>
            <Plus size={18} color={COLORS.textMuted} /><span style={{ color: COLORS.textMuted }}>Add Exercise</span>
          </button>
        </div>
        <div className="p-4 border-t" style={{ borderColor: COLORS.surfaceLight }}>
          <div className="h-2 rounded-full overflow-hidden mb-3" style={{ backgroundColor: COLORS.surfaceLight }}>
            <div className="h-full rounded-full" style={{ backgroundColor: COLORS.primary, width: `${progressPercent}%` }} />
          </div>
          <button onClick={() => {
            // Make sure set timer is running if not resting
            if (!isResting && !setStartTime) {
              setSetStartTime(Date.now());
            }
            setPhase('workout');
          }} className="w-full py-4 rounded-xl font-semibold" style={{ backgroundColor: COLORS.primary, color: COLORS.text }}>Continue Workout</button>
        </div>
      </div>
    );
  }

  // WARMUP PHASE
  if (phase === 'warmup') {
    // Get unique muscle groups from workout exercises
    const muscleGroups = [...new Set(exercisesForTime.map(ex => ex.muscleGroup).filter(Boolean))];

    // Get warmup exercises for these muscle groups
    const warmupExercises = [
      ...(WARMUP_EXERCISES['General'] || []),
      ...muscleGroups.flatMap(group => WARMUP_EXERCISES[group] || [])
    ].slice(0, 8); // Limit to 8 exercises to keep warmup reasonable

    return (
      <div className="fixed inset-0 z-50 flex flex-col" style={{ backgroundColor: COLORS.background }}>
        <div className="p-4 border-b flex items-center justify-between" style={{ borderColor: COLORS.surfaceLight }}>
          <div className="flex items-center gap-3">
            <button onClick={onClose}><X size={24} color={COLORS.text} /></button>
            <h2 className="text-lg font-bold" style={{ color: COLORS.text }}>Warmup</h2>
          </div>
          <button
            onClick={() => setPhase('workout')}
            className="px-3 py-1 rounded-lg text-sm"
            style={{ backgroundColor: COLORS.surfaceLight, color: COLORS.textSecondary }}
          >
            Skip
          </button>
        </div>
        <div className="flex-1 overflow-auto p-4">
          <div className="text-center mb-6">
            <div className="w-16 h-16 rounded-full mx-auto flex items-center justify-center" style={{ backgroundColor: COLORS.primary + '20' }}>
              <Wind size={32} color={COLORS.primary} />
            </div>
            <h3 className="text-xl font-bold mt-3" style={{ color: COLORS.text }}>Get Your Body Ready</h3>
            <p className="text-sm" style={{ color: COLORS.textMuted }}>Dynamic stretches to prepare for {workoutName}</p>
          </div>

          {/* Target Muscles */}
          <div className="flex flex-wrap gap-2 justify-center mb-6">
            {muscleGroups.map(group => (
              <span key={group} className="text-xs px-3 py-1 rounded-full" style={{ backgroundColor: COLORS.primary + '20', color: COLORS.primary }}>
                {group}
              </span>
            ))}
          </div>

          {/* Warmup Exercise List */}
          <div className="space-y-3">
            {warmupExercises.map((exercise, i) => (
              <div key={i} className="p-4 rounded-xl flex items-center gap-4" style={{ backgroundColor: COLORS.surface }}>
                <div className="w-10 h-10 rounded-full flex items-center justify-center flex-shrink-0" style={{ backgroundColor: COLORS.primary + '20' }}>
                  <span className="font-bold" style={{ color: COLORS.primary }}>{i + 1}</span>
                </div>
                <div className="flex-1">
                  <p className="font-semibold" style={{ color: COLORS.text }}>{exercise.name}</p>
                  <p className="text-sm" style={{ color: COLORS.textMuted }}>{exercise.description}</p>
                </div>
                <div className="text-right">
                  <p className="font-semibold" style={{ color: COLORS.primary }}>{exercise.duration}</p>
                </div>
              </div>
            ))}
          </div>

          {/* Tips */}
          <div className="p-4 rounded-xl mt-6" style={{ backgroundColor: COLORS.warning + '10', border: `1px solid ${COLORS.warning}30` }}>
            <div className="flex items-start gap-3">
              <Flame size={20} color={COLORS.warning} className="flex-shrink-0 mt-0.5" />
              <div>
                <p className="font-semibold text-sm" style={{ color: COLORS.text }}>Warmup Tips</p>
                <p className="text-sm mt-1" style={{ color: COLORS.textMuted }}>
                  Move through each exercise at a moderate pace. Focus on controlled movements and gradually increasing range of motion.
                </p>
              </div>
            </div>
          </div>
        </div>

        <div className="p-4 border-t" style={{ borderColor: COLORS.surfaceLight }}>
          <button
            onClick={() => setPhase('workout')}
            className="w-full py-4 rounded-xl font-semibold flex items-center justify-center gap-2"
            style={{ backgroundColor: COLORS.primary, color: COLORS.text }}
          >
            Start Workout <Play size={18} />
          </button>
        </div>
      </div>
    );
  }

  // COOLDOWN PHASE
  if (phase === 'cooldown') {
    // Get unique muscle groups from workout exercises
    const muscleGroups = [...new Set(exercisesForTime.map(ex => ex.muscleGroup).filter(Boolean))];

    // Get cooldown exercises for these muscle groups
    const cooldownExercises = [
      ...(COOLDOWN_EXERCISES['General'] || []),
      ...muscleGroups.flatMap(group => COOLDOWN_EXERCISES[group] || [])
    ].slice(0, 8); // Limit to 8 exercises

    return (
      <div className="fixed inset-0 z-50 flex flex-col" style={{ backgroundColor: COLORS.background }}>
        <div className="p-4 border-b flex items-center justify-between" style={{ borderColor: COLORS.surfaceLight }}>
          <div className="flex items-center gap-3">
            <button onClick={() => setPhase('complete')}><X size={24} color={COLORS.text} /></button>
            <h2 className="text-lg font-bold" style={{ color: COLORS.text }}>Cooldown</h2>
          </div>
          <button
            onClick={() => setPhase('complete')}
            className="px-3 py-1 rounded-lg text-sm"
            style={{ backgroundColor: COLORS.surfaceLight, color: COLORS.textSecondary }}
          >
            Skip
          </button>
        </div>
        <div className="flex-1 overflow-auto p-4">
          <div className="text-center mb-6">
            <div className="w-16 h-16 rounded-full mx-auto flex items-center justify-center" style={{ backgroundColor: COLORS.success + '20' }}>
              <Sprout size={32} color={COLORS.success} />
            </div>
            <h3 className="text-xl font-bold mt-3" style={{ color: COLORS.text }}>Recovery Time</h3>
            <p className="text-sm" style={{ color: COLORS.textMuted }}>Static stretches to help your muscles recover</p>
          </div>

          {/* Target Muscles */}
          <div className="flex flex-wrap gap-2 justify-center mb-6">
            {muscleGroups.map(group => (
              <span key={group} className="text-xs px-3 py-1 rounded-full" style={{ backgroundColor: COLORS.success + '20', color: COLORS.success }}>
                {group}
              </span>
            ))}
          </div>

          {/* Cooldown Exercise List */}
          <div className="space-y-3">
            {cooldownExercises.map((exercise, i) => (
              <div key={i} className="p-4 rounded-xl flex items-center gap-4" style={{ backgroundColor: COLORS.surface }}>
                <div className="w-10 h-10 rounded-full flex items-center justify-center flex-shrink-0" style={{ backgroundColor: COLORS.success + '20' }}>
                  <span className="font-bold" style={{ color: COLORS.success }}>{i + 1}</span>
                </div>
                <div className="flex-1">
                  <p className="font-semibold" style={{ color: COLORS.text }}>{exercise.name}</p>
                  <p className="text-sm" style={{ color: COLORS.textMuted }}>{exercise.description}</p>
                </div>
                <div className="text-right">
                  <p className="font-semibold" style={{ color: COLORS.success }}>{exercise.duration}</p>
                </div>
              </div>
            ))}
          </div>

          {/* Tips */}
          <div className="p-4 rounded-xl mt-6" style={{ backgroundColor: COLORS.info + '10', border: `1px solid ${COLORS.info}30` }}>
            <div className="flex items-start gap-3">
              <Heart size={20} color={COLORS.info} className="flex-shrink-0 mt-0.5" />
              <div>
                <p className="font-semibold text-sm" style={{ color: COLORS.text }}>Cooldown Tips</p>
                <p className="text-sm mt-1" style={{ color: COLORS.textMuted }}>
                  Hold each stretch for the full duration without bouncing. Breathe deeply and let your muscles relax.
                </p>
              </div>
            </div>
          </div>
        </div>

        <div className="p-4 border-t" style={{ borderColor: COLORS.surfaceLight }}>
          <button
            onClick={() => setPhase('complete')}
            className="w-full py-4 rounded-xl font-semibold flex items-center justify-center gap-2"
            style={{ backgroundColor: COLORS.success, color: COLORS.text }}
          >
            Complete Workout <Check size={18} />
          </button>
        </div>
      </div>
    );
  }

  // INITIAL OVERVIEW PHASE
  if (phase === 'overview') {
    // Get workout purpose from template
    const workoutPurpose = {
      title: activeWorkout.name,
      focus: activeWorkout.focus,
      description: activeWorkout.description,
      goals: activeWorkout.goals || []
    };
    
    return (
      <div className="fixed inset-0 z-50 flex flex-col" style={{ backgroundColor: COLORS.background }}>
        <div className="p-4 border-b flex items-center gap-3" style={{ borderColor: COLORS.surfaceLight }}>
          <button onClick={onClose}><X size={24} color={COLORS.text} /></button>
          <h2 className="text-lg font-bold" style={{ color: COLORS.text }}>{workoutPurpose.title}</h2>
        </div>
        <div className="flex-1 overflow-auto p-4">
          <div className="text-center mb-4">
            <div className="w-20 h-20 rounded-full mx-auto flex items-center justify-center" style={{ backgroundColor: COLORS.primary + '20' }}>
              <Dumbbell size={40} color={COLORS.primary} />
            </div>
            <h3 className="text-2xl font-bold mt-3" style={{ color: COLORS.text }}>Today's Workout</h3>
            <p style={{ color: COLORS.textSecondary }}>{exercisesForTime.length} exercises  ~{availableTime} mins</p>
          </div>
          
          {/* Workout Purpose Section */}
          <div className="p-4 rounded-xl mb-4" style={{ backgroundColor: COLORS.primary + '15', border: `1px solid ${COLORS.primary}40` }}>
            <div className="flex items-center gap-2 mb-2">
              <Target size={18} color={COLORS.primary} />
              <span className="font-semibold" style={{ color: COLORS.primary }}>{workoutPurpose.focus}</span>
            </div>
            <p className="text-sm mb-3" style={{ color: COLORS.textSecondary }}>{workoutPurpose.description}</p>
            <div className="flex flex-wrap gap-2">
              {workoutPurpose.goals.map((goal, i) => (
                <span key={i} className="text-xs px-2 py-1 rounded-full" style={{ backgroundColor: COLORS.surface, color: COLORS.text }}>
                   {goal}
                </span>
              ))}
            </div>
          </div>

          {/* Injury Recovery Coaching */}
          {injuries.length > 0 && (() => {
            const primaryInjury = injuries[0];
            const currentPhase = getCurrentRecoveryPhase(primaryInjury);
            const phaseInfo = RECOVERY_PHASES[currentPhase];
            const coachingMessage = getCoachingMessage(currentPhase, primaryInjury.muscleGroup);
            const hasRecoveryExercises = exercisesForTime.some(ex => ex.isRecoveryExercise);

            return (
              <div className="p-4 rounded-xl mb-4" style={{ backgroundColor: COLORS.warning + '10', border: `1px solid ${COLORS.warning}30` }}>
                <div className="flex items-start gap-3">
                  <span className="text-2xl">{phaseInfo.icon}</span>
                  <div className="flex-1">
                    <div className="flex items-center gap-2 mb-1">
                      <span className="text-sm font-semibold" style={{ color: COLORS.text }}>Recovery Mode Active</span>
                      <span className="text-xs px-2 py-0.5 rounded-full" style={{ backgroundColor: INJURY_SEVERITY[primaryInjury.severity].color + '20', color: INJURY_SEVERITY[primaryInjury.severity].color }}>
                        {primaryInjury.muscleGroup}
                      </span>
                    </div>
                    <p className="text-sm mb-2" style={{ color: COLORS.textSecondary }}>{coachingMessage}</p>
                    {hasRecoveryExercises && (
                      <p className="text-xs" style={{ color: COLORS.success }}>
                         Rehab exercises included  Listen to your body and stop if you feel pain
                      </p>
                    )}
                  </div>
                </div>
              </div>
            );
          })()}

          <div className="space-y-3 mb-6">
            {exercisesForTime.map((exercise, i) => {
              const isSuperset = exercise.supersetId;
              const isFirstInSuperset = isSuperset && exercise.supersetOrder === 1;
              const isSecondInSuperset = isSuperset && exercise.supersetOrder === 2;

              return (
                <div key={exercise.id}>
                  {/* Superset header - show before first exercise in superset */}
                  {isFirstInSuperset && (
                    <div className="flex items-center gap-2 mb-2 px-2">
                      <Zap size={14} color={COLORS.warning} />
                      <span className="text-xs font-semibold" style={{ color: COLORS.warning }}>SUPERSET</span>
                      <span className="text-xs" style={{ color: COLORS.textMuted }}> No rest between these exercises</span>
                    </div>
                  )}
                  <div
                    className="p-4 rounded-xl"
                    style={{
                      backgroundColor: COLORS.surface,
                      ...(isSuperset && {
                        borderLeft: `3px solid ${COLORS.warning}`,
                        borderRadius: isFirstInSuperset ? '12px 12px 0 0' : isSecondInSuperset ? '0 0 12px 12px' : '12px',
                        marginTop: isSecondInSuperset ? '-1px' : 0
                      })
                    }}
                  >
                    <div className="flex items-center justify-between mb-2">
                      <button onClick={() => setShowExerciseHistory(i)} className="flex items-center gap-3 flex-1 text-left">
                        <div className="w-8 h-8 rounded-full flex items-center justify-center" style={{ backgroundColor: COLORS.primary + '20' }}>
                          <span className="font-bold" style={{ color: COLORS.primary }}>{i + 1}</span>
                        </div>
                        <div>
                          <div className="flex items-center gap-2">
                            <p className="font-semibold" style={{ color: COLORS.text }}>{exercise.name}</p>
                            {exercise.isRecoveryExercise && (
                              <span className="text-xs px-2 py-0.5 rounded-full" style={{ backgroundColor: COLORS.success + '20', color: COLORS.success }}>
                                Rehab
                              </span>
                            )}
                            <button onClick={(e) => { e.preventDefault(); e.stopPropagation(); setShowExerciseInfoModal(exercise.name); }} className="p-1 rounded-full" style={{ backgroundColor: COLORS.primary + '20' }}><Info size={14} color={COLORS.primary} /></button>
                          </div>
                          <p className="text-xs" style={{ color: COLORS.textMuted }}>
                            {isAdvancedUser && exercise.targetedHeads && exercise.targetedHeads.length > 0
                              ? exercise.targetedHeads.join(', ')
                              : exercise.muscleGroup}  {exercise.isRecoveryExercise ? 'Focus on form' : 'Tap to view history'}
                            {isSuperset && <span style={{ color: COLORS.warning }}>  Paired with {exercise.supersetWith}</span>}
                          </p>
                        </div>
                      </button>
                      <div className="flex items-center gap-2">
                        <div className="text-right mr-2">
                          <p className="font-semibold" style={{ color: COLORS.text }}>{exercise.sets}  {exercise.targetReps}</p>
                          <p className="text-xs" style={{ color: COLORS.textMuted }}>{exercise.suggestedWeight}kg</p>
                        </div>
                        {/* Reorder buttons */}
                        <div className="flex flex-col">
                          <button
                            onClick={(e) => { e.stopPropagation(); moveExercise(i, 'up'); }}
                            disabled={i === 0}
                            className="p-1 rounded-t-lg"
                            style={{ backgroundColor: COLORS.surfaceLight, opacity: i === 0 ? 0.4 : 1 }}
                          >
                            <ChevronUp size={14} color={COLORS.textMuted} />
                          </button>
                          <button
                            onClick={(e) => { e.stopPropagation(); moveExercise(i, 'down'); }}
                            disabled={i === exercises.length - 1}
                            className="p-1 rounded-b-lg"
                            style={{ backgroundColor: COLORS.surfaceLight, opacity: i === exercises.length - 1 ? 0.4 : 1 }}
                          >
                            <ChevronDown size={14} color={COLORS.textMuted} />
                          </button>
                        </div>
                        <button onClick={() => setShowSwapExercise(i)} className="p-2 rounded-lg" style={{ backgroundColor: COLORS.surfaceLight }}>
                          <ArrowLeftRight size={16} color={COLORS.textMuted} />
                        </button>
                        {exercises.length > 1 && (
                          <button onClick={() => removeExercise(i)} className="p-2 rounded-lg" style={{ backgroundColor: COLORS.error + '20' }}>
                            <X size={16} color={COLORS.error} />
                          </button>
                        )}
                      </div>
                    </div>
                    <div className="mt-2 pt-2 border-t flex items-center justify-between" style={{ borderColor: COLORS.surfaceLight }}>
                      <div className="flex items-center gap-3">
                        <p className="text-xs" style={{ color: COLORS.textMuted }}>Last: {exercise.lastWeight}kg  {exercise.lastReps?.join(', ') || '-'}</p>
                        {isSuperset && exercise.restTime === 0 ? (
                          <span className="text-xs px-2 py-0.5 rounded-full" style={{ backgroundColor: COLORS.warning + '15', color: COLORS.warning }}>
                            No rest
                          </span>
                        ) : (
                          <span className="text-xs px-2 py-0.5 rounded-full" style={{ backgroundColor: COLORS.warning + '15', color: COLORS.warning }}>
                            {Math.floor((exercise.restTime || 90) / 60)}:{((exercise.restTime || 90) % 60).toString().padStart(2, '0')} rest
                          </span>
                        )}
                      </div>
                      {exercise.suggestedWeight > (exercise.lastWeight || 0) && (
                        <span className="text-xs px-2 py-0.5 rounded" style={{ backgroundColor: COLORS.success + '20', color: COLORS.success }}>+{(exercise.suggestedWeight - (exercise.lastWeight || 0)).toFixed(1)}kg</span>
                      )}
                    </div>
                  </div>
                </div>
              );
            })}
          </div>
          <button onClick={() => setShowAddExercise(true)} className="w-full p-4 rounded-xl flex items-center justify-center gap-2 mb-4" style={{ backgroundColor: COLORS.surfaceLight, border: `2px dashed ${COLORS.textMuted}` }}>
            <Plus size={18} color={COLORS.textMuted} /><span style={{ color: COLORS.textMuted }}>Add Exercise</span>
          </button>

          {/* Time Breakdown Overview */}
          <div className="p-4 rounded-xl mb-4" style={{ backgroundColor: COLORS.surface }}>
            <div className="flex items-center gap-2 mb-3">
              <Clock size={18} color={COLORS.primary} />
              <span className="font-semibold" style={{ color: COLORS.text }}>Workout Time Breakdown</span>
            </div>
            <div className="grid grid-cols-2 gap-3 mb-3">
              <div className="p-3 rounded-lg text-center" style={{ backgroundColor: COLORS.primary + '15' }}>
                <p className="text-xl font-bold" style={{ color: COLORS.primary }}>
                  {Math.floor(timeBreakdown.workingTime / 60)}:{(timeBreakdown.workingTime % 60).toString().padStart(2, '0')}
                </p>
                <p className="text-xs" style={{ color: COLORS.textMuted }}>Working Time</p>
              </div>
              <div className="p-3 rounded-lg text-center" style={{ backgroundColor: COLORS.warning + '15' }}>
                <p className="text-xl font-bold" style={{ color: COLORS.warning }}>
                  {Math.floor(timeBreakdown.restTime / 60)}:{(timeBreakdown.restTime % 60).toString().padStart(2, '0')}
                </p>
                <p className="text-xs" style={{ color: COLORS.textMuted }}>Rest Time</p>
              </div>
            </div>
            <div className="flex items-center justify-between p-3 rounded-lg" style={{ backgroundColor: COLORS.surfaceLight }}>
              <div>
                <p className="text-sm font-medium" style={{ color: COLORS.text }}>Total Duration</p>
                <p className="text-xs" style={{ color: COLORS.textMuted }}>
                  Incl. {Math.floor(WORKOUT_TIMING.WARMUP_TIME / 60)} min warmup + {Math.floor(WORKOUT_TIMING.COOLDOWN_TIME / 60)} min cooldown
                </p>
              </div>
              <div className="text-right">
                <p className="text-2xl font-bold" style={{ color: COLORS.success }}>
                  ~{Math.round(timeBreakdown.totalTime / 60)} min
                </p>
                {Math.abs(timeBreakdown.totalTime / 60 - availableTime) <= 5 && (
                  <span className="text-xs px-2 py-0.5 rounded-full" style={{ backgroundColor: COLORS.success + '20', color: COLORS.success }}>
                     On target
                  </span>
                )}
              </div>
            </div>
            <div className="mt-3 text-xs space-y-1" style={{ color: COLORS.textMuted }}>
              <div className="flex justify-between">
                <span> {totalSets} total sets  ~{WORKOUT_TIMING.AVG_SET_DURATION}s avg</span>
                <span>{Math.floor(timeBreakdown.workingTime / 60)}m working</span>
              </div>
              <div className="flex justify-between">
                <span> Rest periods adjusted for {availableTime} min target</span>
                <span>~{Math.round((timeBreakdown.restTime / (totalSets - exercisesForTime.length)) || 0)}s/set</span>
              </div>
            </div>
          </div>

          <div className="p-4 rounded-xl" style={{ backgroundColor: COLORS.surfaceLight }}>
            <p className="text-sm" style={{ color: COLORS.textSecondary }}><strong style={{ color: COLORS.text }}>Tip:</strong> Exercises are auto-ordered for your goal. Rest times and sets have been adjusted to fit your {availableTime} min target.</p>
          </div>
        </div>
        <div className="p-4 border-t" style={{ borderColor: COLORS.surfaceLight }}>
          <button onClick={async () => {
            const now = Date.now();
            setWorkoutStartTime(now);
            setSetStartTime(now);

            // Start workout session in Supabase
            if (userId) {
              try {
                const { data: session } = await workoutService.startWorkout(userId, null, null, workoutName);
                if (session) {
                  setSessionId(session.id);
                }
              } catch (err) {
                console.error('Error starting workout session:', err);
              }
            }

            setPhase('workout');
          }} className="w-full py-4 rounded-xl font-semibold flex items-center justify-center gap-2" style={{ backgroundColor: COLORS.primary, color: COLORS.text }}>Start Workout <Play size={20} /></button>
        </div>
      </div>
    );
  }

  // COMPLETE PHASE
  if (phase === 'complete') {
    // Calculate workout stats
    const totalVolume = completedSets.reduce((acc, set) => acc + (set.weight * set.reps), 0);
    const totalReps = completedSets.reduce((acc, set) => acc + set.reps, 0);
    const avgRPE = completedSets.length > 0 
      ? (completedSets.reduce((acc, set) => acc + (set.rpe || 5), 0) / completedSets.length).toFixed(1)
      : 5;
    
    // Actual workout duration (start to end)
    const actualEndTime = workoutEndTime || Date.now();
    const totalDurationMs = workoutStartTime ? (actualEndTime - workoutStartTime) : 0;
    const totalDurationMins = Math.round(totalDurationMs / 60000);
    
    // Working time (time actually doing sets, excluding rest)
    const workingTimeMins = Math.round(totalWorkingTime / 60);
    
    // Rest time in minutes
    const restTimeMins = Math.round(totalRestTime / 60);
    
    // Estimate calories burned based on actual working time and intensity
    // Formula: ~8-12 cal/min for active weight training, adjusted by RPE
    const intensityMultiplier = avgRPE / 7;
    const caloriesBurned = Math.round(workingTimeMins * 10 * intensityMultiplier + restTimeMins * 2);
    
    // Check for PRs - compare each exercise's best set to their history
    const prsAchieved = [];
    exercisesForTime.forEach(exercise => {
      const exerciseSets = completedSets.filter(s => s.exerciseId === exercise.id);
      if (exerciseSets.length === 0) return;
      
      // Find best set by estimated 1RM (Epley formula: weight * (1 + reps/30))
      const bestSet = exerciseSets.reduce((best, set) => {
        const e1rm = set.weight * (1 + set.reps / 30);
        const bestE1rm = best.weight * (1 + best.reps / 30);
        return e1rm > bestE1rm ? set : best;
      });
      
      const currentE1rm = bestSet.weight * (1 + bestSet.reps / 30);
      
      // Compare to history (if available)
      const historyMax = exercise.history?.length > 0 
        ? Math.max(...exercise.history.map(h => h.e1rm || 0))
        : 0;
      
      // Also check against last workout
      const lastMax = exercise.lastWeight * (1 + Math.max(...(exercise.lastReps || [0])) / 30);
      const previousBest = Math.max(historyMax, lastMax);
      
      if (currentE1rm > previousBest && previousBest > 0) {
        prsAchieved.push({
          exercise: exercise.name,
          type: 'E1RM',
          value: `${currentE1rm.toFixed(1)}kg`,
          improvement: `+${(currentE1rm - previousBest).toFixed(1)}kg`
        });
      }
      
      // Check for weight PR
      if (bestSet.weight > exercise.lastWeight && exercise.lastWeight > 0) {
        // Only add if not already captured by E1RM
        if (!prsAchieved.find(pr => pr.exercise === exercise.name)) {
          prsAchieved.push({
            exercise: exercise.name,
            type: 'Weight',
            value: `${bestSet.weight}kg`,
            improvement: `+${(bestSet.weight - exercise.lastWeight).toFixed(1)}kg`
          });
        }
      }
    });
    
    // Group sets by exercise for breakdown - include actual set data
    const exerciseBreakdown = exercisesForTime.map(exercise => {
      const sets = completedSets.filter(s => s.exerciseId === exercise.id);
      const volume = sets.reduce((acc, s) => acc + (s.weight * s.reps), 0);
      return {
        name: exercise.name,
        sets: sets.length,
        targetSets: exercise.sets,
        volume,
        setDetails: sets.map(s => ({ weight: s.weight, reps: s.reps, rpe: s.rpe }))
      };
    }).filter(e => e.sets > 0);
    
    return (
      <div className="fixed inset-0 z-50 flex flex-col" style={{ backgroundColor: COLORS.background }}>
        <div className="p-4 border-b flex items-center gap-3" style={{ borderColor: COLORS.surfaceLight }}>
          <button onClick={onClose}><X size={24} color={COLORS.text} /></button>
          <h2 className="text-lg font-bold" style={{ color: COLORS.text }}>Workout Summary</h2>
        </div>
        
        <div className="flex-1 overflow-auto p-4">
          {/* Hero Section */}
          <div className="text-center mb-6">
            <div className="w-20 h-20 rounded-full mx-auto mb-3 flex items-center justify-center" style={{ backgroundColor: COLORS.success + '20' }}>
              <Check size={40} color={COLORS.success} />
            </div>
            <h2 className="text-2xl font-bold" style={{ color: COLORS.text }}>Workout Complete!</h2>
            <p className="text-sm" style={{ color: COLORS.textSecondary }}>{activeWorkout.name}  {totalDurationMins} mins</p>
          </div>
          
          {/* Time Breakdown */}
          <div className="p-4 rounded-xl mb-4" style={{ backgroundColor: COLORS.surface }}>
            <div className="flex items-center justify-between mb-3">
              <div className="flex items-center gap-2">
                <Clock size={18} color={COLORS.primary} />
                <span className="font-semibold" style={{ color: COLORS.text }}>Time Breakdown</span>
              </div>
              <span className="text-lg font-bold" style={{ color: COLORS.primary }}>{totalDurationMins} min total</span>
            </div>
            <div className="flex gap-2">
              <div className="flex-1 p-3 rounded-lg text-center" style={{ backgroundColor: COLORS.success + '15' }}>
                <p className="text-lg font-bold" style={{ color: COLORS.success }}>{workingTimeMins}m</p>
                <p className="text-xs" style={{ color: COLORS.textMuted }}>Working</p>
              </div>
              <div className="flex-1 p-3 rounded-lg text-center" style={{ backgroundColor: COLORS.accent + '15' }}>
                <p className="text-lg font-bold" style={{ color: COLORS.accent }}>{restTimeMins}m</p>
                <p className="text-xs" style={{ color: COLORS.textMuted }}>Resting</p>
              </div>
              <div className="flex-1 p-3 rounded-lg text-center" style={{ backgroundColor: COLORS.surfaceLight }}>
                <p className="text-lg font-bold" style={{ color: COLORS.text }}>{Math.round((workingTimeMins / Math.max(totalDurationMins, 1)) * 100)}%</p>
                <p className="text-xs" style={{ color: COLORS.textMuted }}>Efficiency</p>
              </div>
            </div>
          </div>
          
          {/* Key Stats Grid */}
          <div className="grid grid-cols-2 gap-3 mb-4">
            <div className="p-4 rounded-xl text-center" style={{ backgroundColor: COLORS.surface }}>
              <div className="flex items-center justify-center gap-2">
                <Flame size={24} color={COLORS.accent} />
                <p className="text-3xl font-bold" style={{ color: COLORS.accent }}>{caloriesBurned}</p>
              </div>
              <p className="text-xs" style={{ color: COLORS.textMuted }}>Calories Burned</p>
            </div>
            <div className="p-4 rounded-xl text-center" style={{ backgroundColor: COLORS.surface }}>
              <p className="text-3xl font-bold" style={{ color: COLORS.primary }}>{(totalVolume / 1000).toFixed(1)}k</p>
              <p className="text-xs" style={{ color: COLORS.textMuted }}>kg Volume</p>
            </div>
          </div>
          
          <div className="grid grid-cols-3 gap-2 mb-4">
            <div className="p-3 rounded-xl text-center" style={{ backgroundColor: COLORS.surface }}>
              <p className="text-xl font-bold" style={{ color: COLORS.text }}>{completedSetsCount}</p>
              <p className="text-xs" style={{ color: COLORS.textMuted }}>Sets</p>
            </div>
            <div className="p-3 rounded-xl text-center" style={{ backgroundColor: COLORS.surface }}>
              <p className="text-xl font-bold" style={{ color: COLORS.text }}>{totalReps}</p>
              <p className="text-xs" style={{ color: COLORS.textMuted }}>Reps</p>
            </div>
            <div className="p-3 rounded-xl text-center" style={{ backgroundColor: COLORS.surface }}>
              <p className="text-xl font-bold" style={{ color: COLORS.text }}>{avgRPE}</p>
              <p className="text-xs" style={{ color: COLORS.textMuted }}>Avg RPE</p>
            </div>
          </div>
          
          {/* PRs Achieved Section */}
          {prsAchieved.length > 0 && (
            <div className="mb-4 p-4 rounded-xl" style={{ backgroundColor: COLORS.warning + '15', border: `1px solid ${COLORS.warning}40` }}>
              <div className="flex items-center gap-2 mb-3">
                <Trophy size={20} color={COLORS.warning} />
                <h3 className="font-bold" style={{ color: COLORS.warning }}>Personal Records!</h3>
              </div>
              <div className="space-y-2">
                {prsAchieved.map((pr, idx) => (
                  <div key={idx} className="flex items-center justify-between p-2 rounded-lg" style={{ backgroundColor: COLORS.background }}>
                    <div>
                      <p className="font-semibold text-sm" style={{ color: COLORS.text }}>{pr.exercise}</p>
                      <p className="text-xs" style={{ color: COLORS.textMuted }}>{pr.type} PR</p>
                    </div>
                    <div className="text-right">
                      <p className="font-bold" style={{ color: COLORS.warning }}>{pr.value}</p>
                      <p className="text-xs" style={{ color: COLORS.success }}>{pr.improvement}</p>
                    </div>
                  </div>
                ))}
              </div>
            </div>
          )}
          
          {/* Exercise Breakdown */}
          <div className="p-4 rounded-xl mb-4" style={{ backgroundColor: COLORS.surface }}>
            <h3 className="font-semibold mb-3 flex items-center gap-2" style={{ color: COLORS.text }}>
              <Dumbbell size={16} /> Exercise Breakdown
            </h3>
            <div className="space-y-3">
              {exerciseBreakdown.map((ex, idx) => (
                <div key={idx} className="pb-3 border-b" style={{ borderColor: COLORS.surfaceLight }}>
                  <div className="flex items-center justify-between mb-2">
                    <div className="flex items-center gap-2">
                      {ex.sets === ex.targetSets ? (
                        <Check size={16} color={COLORS.success} />
                      ) : (
                        <div className="w-4 h-4 rounded-full" style={{ backgroundColor: COLORS.warning + '40' }} />
                      )}
                      <span className="text-sm font-medium" style={{ color: COLORS.text }}>{ex.name}</span>
                    </div>
                    <span className="text-xs" style={{ color: COLORS.textMuted }}>{ex.volume}kg vol</span>
                  </div>
                  <div className="flex flex-wrap gap-2 pl-6">
                    {ex.setDetails.map((set, setIdx) => (
                      <div key={setIdx} className="px-2 py-1 rounded text-xs" style={{ backgroundColor: COLORS.surfaceLight }}>
                        <span style={{ color: COLORS.text }}>{set.weight}kg  {set.reps}</span>
                        {set.rpe && <span style={{ color: COLORS.textMuted }}> @{set.rpe}</span>}
                      </div>
                    ))}
                  </div>
                </div>
              ))}
            </div>
          </div>
          
          {/* Workout Media Section */}
          <div className="p-4 rounded-xl mb-4" style={{ backgroundColor: COLORS.surface }}>
            <h3 className="font-semibold mb-3 flex items-center gap-2" style={{ color: COLORS.text }}>
              <Eye size={16} /> Add Photos/Videos
            </h3>
            <p className="text-xs mb-3" style={{ color: COLORS.textMuted }}>
              Document your workout with progress photos or form check videos
            </p>

            {/* Hidden file input */}
            <input
              ref={fileInputRef}
              type="file"
              accept="image/*,video/*"
              multiple
              className="hidden"
              onChange={(e) => {
                const files = Array.from(e.target.files || []);
                const newMedia = files.map(file => ({
                  id: Date.now() + Math.random(),
                  file,
                  url: URL.createObjectURL(file),
                  type: file.type.startsWith('video') ? 'video' : 'image',
                  name: file.name,
                }));
                setWorkoutMedia(prev => [...prev, ...newMedia]);
                e.target.value = ''; // Reset input
              }}
            />

            {/* Media Preview Grid */}
            {workoutMedia.length > 0 && (
              <div className="grid grid-cols-3 gap-2 mb-3">
                {workoutMedia.map((media) => (
                  <div key={media.id} className="relative aspect-square rounded-lg overflow-hidden" style={{ backgroundColor: COLORS.surfaceLight }}>
                    {media.type === 'image' ? (
                      <img src={media.url} alt="Workout" className="w-full h-full object-cover" />
                    ) : (
                      <div className="w-full h-full flex items-center justify-center">
                        <Play size={24} color={COLORS.text} />
                        <video src={media.url} className="absolute inset-0 w-full h-full object-cover" />
                      </div>
                    )}
                    <button
                      onClick={() => {
                        URL.revokeObjectURL(media.url);
                        setWorkoutMedia(prev => prev.filter(m => m.id !== media.id));
                      }}
                      className="absolute top-1 right-1 w-6 h-6 rounded-full flex items-center justify-center"
                      style={{ backgroundColor: COLORS.error }}
                    >
                      <X size={12} color={COLORS.text} />
                    </button>
                  </div>
                ))}
              </div>
            )}

            {/* Upload Button */}
            <button
              onClick={() => fileInputRef.current?.click()}
              className="w-full py-3 rounded-xl flex items-center justify-center gap-2"
              style={{ backgroundColor: COLORS.surfaceLight, color: COLORS.text }}
            >
              <Plus size={18} />
              <span className="font-medium">Add Photo or Video</span>
            </button>
          </div>

          {/* Success Message */}
          <div className="p-4 rounded-xl" style={{ backgroundColor: COLORS.success + '15' }}>
            <p className="text-sm text-center" style={{ color: COLORS.success }}>
               Progress saved! {prsAchieved.length > 0 ? `Amazing work on ${prsAchieved.length} PR${prsAchieved.length > 1 ? 's' : ''}!` : 'Keep pushing for those PRs!'}
            </p>
          </div>

          {/* Publish to Community Suggestion */}
          {!showPublishPrompt ? (
            <button
              onClick={() => setShowPublishPrompt(true)}
              className="w-full mt-4 p-4 rounded-xl flex items-center gap-3"
              style={{ backgroundColor: COLORS.primary + '15', border: `1px solid ${COLORS.primary}30` }}
            >
              <div className="w-10 h-10 rounded-full flex items-center justify-center" style={{ backgroundColor: COLORS.primary + '30' }}>
                <Upload size={20} color={COLORS.primary} />
              </div>
              <div className="flex-1 text-left">
                <p className="font-semibold text-sm" style={{ color: COLORS.text }}>Share with Community?</p>
                <p className="text-xs" style={{ color: COLORS.textMuted }}>Let others try your workout routine</p>
              </div>
              <ChevronRight size={20} color={COLORS.primary} />
            </button>
          ) : (
            <div className="mt-4 p-4 rounded-xl" style={{ backgroundColor: COLORS.surface }}>
              <div className="flex items-center justify-between mb-3">
                <p className="font-semibold" style={{ color: COLORS.text }}>Publish Workout</p>
                <button onClick={() => setShowPublishPrompt(false)}>
                  <X size={18} color={COLORS.textMuted} />
                </button>
              </div>
              <input
                type="text"
                placeholder="Workout name (e.g., 'Push Day Killer')"
                value={publishWorkoutName}
                onChange={(e) => setPublishWorkoutName(e.target.value)}
                className="w-full p-3 rounded-lg mb-2 outline-none"
                style={{ backgroundColor: COLORS.surfaceLight, color: COLORS.text }}
              />
              <textarea
                placeholder="Description (optional)"
                value={publishWorkoutDesc}
                onChange={(e) => setPublishWorkoutDesc(e.target.value)}
                className="w-full p-3 rounded-lg mb-3 outline-none resize-none"
                style={{ backgroundColor: COLORS.surfaceLight, color: COLORS.text }}
                rows={2}
              />
              <button
                onClick={async () => {
                  if (!userId || !publishWorkoutName.trim()) return;
                  try {
                    setIsPublishing(true);
                    // Prepare workout data from completed session
                    const workoutData = {
                      name: publishWorkoutName.trim(),
                      focus: activeWorkout?.focus || 'general',
                      description: publishWorkoutDesc.trim(),
                      exercises: exercisesForTime.map(ex => ({
                        name: ex.name,
                        muscleGroup: ex.muscleGroup,
                        sets: ex.sets || 3,
                        targetReps: ex.targetReps,
                        restTime: ex.restTime || 90,
                      })),
                    };
                    await publishedWorkoutService.publishWorkout(userId, workoutData);
                    setShowPublishPrompt(false);
                    setPublishWorkoutName('');
                    setPublishWorkoutDesc('');
                  } catch (err) {
                    console.warn('Error publishing workout:', err?.message);
                  } finally {
                    setIsPublishing(false);
                  }
                }}
                disabled={!publishWorkoutName.trim() || isPublishing}
                className="w-full py-3 rounded-xl font-semibold flex items-center justify-center gap-2"
                style={{ backgroundColor: publishWorkoutName.trim() ? COLORS.primary : COLORS.surfaceLight, color: COLORS.text }}
              >
                {isPublishing ? <Loader2 size={18} className="animate-spin" /> : <Upload size={18} />}
                {isPublishing ? 'Publishing...' : 'Publish to Community'}
              </button>
            </div>
          )}
        </div>

        <div className="p-4 border-t" style={{ borderColor: COLORS.surfaceLight }}>
          <button
            disabled={isSaving}
            onClick={async () => {
              // Save workout to Supabase
              if (userId && sessionId) {
                setIsSaving(true);
                try {
                  // Save each set
                  for (const set of completedSets) {
                    const exercise = exercisesForTime.find(e => e.id === set.exerciseId);
                    await workoutService.logSet(sessionId, null, exercise?.name || 'Unknown', {
                      setNumber: set.setIndex + 1,
                      weight: set.weight,
                      reps: set.reps,
                      rpe: set.rpe,
                    });

                    // Check for PRs
                    if (exercise) {
                      await workoutService.checkAndCreatePR(
                        userId,
                        null,
                        exercise.name,
                        set.weight,
                        set.reps,
                        sessionId
                      );
                    }
                  }

                  // Complete the session
                  await workoutService.completeWorkout(sessionId, {
                    durationMinutes: totalDurationMins,
                    totalVolume,
                    workingTime: totalWorkingTime,
                    restTime: totalRestTime,
                  });
                } catch (err) {
                  console.error('Error saving workout:', err);
                } finally {
                  setIsSaving(false);
                }
              }

              if (onComplete) onComplete();
              onClose();
            }}
            className="w-full py-4 rounded-xl font-semibold flex items-center justify-center gap-2"
            style={{ backgroundColor: COLORS.success, color: COLORS.text, opacity: isSaving ? 0.7 : 1 }}>
            {isSaving ? <><Loader2 size={20} className="animate-spin" /> Saving...</> : <><Check size={20} /> Return to App</>}
          </button>
        </div>
      </div>
    );
  }

  // ACTIVE WORKOUT PHASE (rest timer now inline)
  // Guard against undefined currentExercise
  if (!currentExercise) {
    return (
      <div className="fixed inset-0 z-50 flex flex-col items-center justify-center p-4" style={{ backgroundColor: COLORS.background }}>
        <div className="text-center">
          <p className="mb-4" style={{ color: COLORS.textMuted }}>Loading exercise...</p>
          <button onClick={onClose} className="px-4 py-2 rounded-lg" style={{ backgroundColor: COLORS.surfaceLight, color: COLORS.text }}>
            Go Back
          </button>
        </div>
      </div>
    );
  }

  return (
    <div className="fixed inset-0 z-50 flex flex-col" style={{ backgroundColor: COLORS.background }}>
      <div className="p-4 border-b flex items-center justify-between" style={{ borderColor: COLORS.surfaceLight }}>
        <div className="flex items-center gap-3">
          <button onClick={onClose}><X size={24} color={COLORS.text} /></button>
          <div>
            <div className="flex items-center gap-2">
              <h2 className="text-lg font-bold" style={{ color: COLORS.text }}>{currentExercise.name}</h2>
              <button onClick={(e) => { e.preventDefault(); e.stopPropagation(); setShowExerciseInfoModal(currentExercise.name); }} className="p-1 rounded-full" style={{ backgroundColor: COLORS.primary + '20' }}><Info size={14} color={COLORS.primary} /></button>
            </div>
            <p className="text-xs" style={{ color: COLORS.textMuted }}>{currentExercise.muscleGroup}</p>
          </div>
        </div>
        <div className="flex items-center gap-2">
          <button onClick={() => setShowSwapExercise(currentExerciseIndex)} className="p-2 rounded-lg" style={{ backgroundColor: COLORS.surfaceLight }}><Undo2 size={16} color={COLORS.textMuted} /></button>
          <button onClick={() => setPhase('workoutOverview')} className="px-3 py-1 rounded-lg text-sm" style={{ backgroundColor: COLORS.surfaceLight, color: COLORS.textSecondary }}>Overview</button>
          <div className="flex items-center">
            <button onClick={() => removeSetFromExercise(currentExerciseIndex)} disabled={currentExercise.sets <= 1} className="p-1 rounded-l-lg" style={{ backgroundColor: COLORS.surfaceLight, opacity: currentExercise.sets <= 1 ? 0.4 : 1 }}><Minus size={14} color={COLORS.textMuted} /></button>
            <span className="px-3 py-1 text-sm font-semibold" style={{ backgroundColor: COLORS.primary + '20', color: COLORS.primary }}>Set {currentSetIndex + 1}/{currentExercise.sets}</span>
            <button onClick={() => addSetToExercise(currentExerciseIndex)} className="p-1 rounded-r-lg" style={{ backgroundColor: COLORS.surfaceLight }}><Plus size={14} color={COLORS.textMuted} /></button>
          </div>
        </div>
      </div>
      
      {/* Inline Rest Timer Banner */}
      {isResting && (
        <div className="p-4" style={{ backgroundColor: COLORS.accent + '15' }}>
          <div className="flex items-center justify-between">
            <div className="flex items-center gap-3">
              <div 
                className="w-14 h-14 rounded-full flex items-center justify-center"
                style={{ backgroundColor: COLORS.accent + '30', border: `3px solid ${COLORS.accent}` }}
              >
                <p className="text-xl font-bold" style={{ color: COLORS.accent }}>{formatTime(restTimeLeft)}</p>
              </div>
              <div>
                <p className="text-sm font-semibold" style={{ color: COLORS.text }}>Rest Time</p>
                <p className="text-xs" style={{ color: COLORS.textMuted }}>Next: {currentExercise.name} - Set {currentSetIndex + 1}</p>
              </div>
            </div>
            <button 
              onClick={() => { 
                // Adjust rest time - subtract skipped time
                setTotalRestTime(prev => prev - restTimeLeft);
                setIsResting(false); 
                setRestTimeLeft(0);
                setSetStartTime(Date.now()); // Start timing next set
              }} 
              className="px-4 py-2 rounded-xl text-sm font-semibold"
              style={{ backgroundColor: COLORS.accent, color: COLORS.text }}
            >
              Skip
            </button>
          </div>
        </div>
      )}
      
      <div className="flex-1 overflow-auto p-4">
        <div className="p-6 rounded-2xl mb-4 text-center" style={{ backgroundColor: COLORS.surface }}>
          <p className="text-sm mb-2" style={{ color: COLORS.textSecondary }}>Target for this set</p>
          <div className="flex items-center justify-center gap-4 mb-4">
            <div><p className="text-4xl font-bold" style={{ color: COLORS.primary }}>{currentExercise.suggestedWeight}</p><p className="text-sm" style={{ color: COLORS.textMuted }}>kg</p></div>
            <span className="text-2xl" style={{ color: COLORS.textMuted }}></span>
            <div><p className="text-4xl font-bold" style={{ color: COLORS.primary }}>{currentExercise.targetReps}</p><p className="text-sm" style={{ color: COLORS.textMuted }}>reps</p></div>
          </div>
          <div className="pt-3 border-t" style={{ borderColor: COLORS.surfaceLight }}>
            <p className="text-xs" style={{ color: COLORS.textMuted }}>Last: {currentExercise.lastWeight}kg  {currentExercise.lastReps[currentSetIndex] || currentExercise.lastReps[0]} reps
              {currentExercise.suggestedWeight > currentExercise.lastWeight && <span style={{ color: COLORS.success }}> (+{(currentExercise.suggestedWeight - currentExercise.lastWeight).toFixed(1)}kg)</span>}
            </p>
          </div>
        </div>
        <div className="p-4 rounded-xl mb-4" style={{ backgroundColor: COLORS.surface }}>
          <p className="text-sm font-semibold mb-3" style={{ color: COLORS.text }}>Log your actual performance:</p>
          <div className="flex flex-col gap-3 mb-3">
            <div>
              <label className="text-xs mb-1 block" style={{ color: COLORS.textMuted }}>Weight (kg)</label>
              <div className="flex items-center gap-2">
                <button onClick={() => setCurrentSetData(prev => ({...prev, weight: Math.max(0, prev.weight - 2.5)}))} className="w-12 h-12 rounded-lg flex items-center justify-center" style={{ backgroundColor: COLORS.surfaceLight }}><Minus size={20} color={COLORS.text} /></button>
                <input
                  type="number"
                  value={currentSetData.weight || ''}
                  onChange={e => setCurrentSetData(prev => ({...prev, weight: parseFloat(e.target.value) || 0}))}
                  onBlur={e => setCurrentSetData(prev => ({...prev, weight: Number(prev.weight) || 0}))}
                  className="flex-1 p-3 rounded-lg text-center text-2xl font-bold"
                  style={{ backgroundColor: COLORS.surfaceLight, color: COLORS.text, border: 'none' }}
                />
                <button onClick={() => setCurrentSetData(prev => ({...prev, weight: prev.weight + 2.5}))} className="w-12 h-12 rounded-lg flex items-center justify-center" style={{ backgroundColor: COLORS.surfaceLight }}><Plus size={20} color={COLORS.text} /></button>
              </div>
            </div>
            <div>
              <label className="text-xs mb-1 block" style={{ color: COLORS.textMuted }}>Reps</label>
              <div className="flex items-center gap-2">
                <button onClick={() => setCurrentSetData(prev => ({...prev, reps: Math.max(0, prev.reps - 1)}))} className="w-12 h-12 rounded-lg flex items-center justify-center" style={{ backgroundColor: COLORS.surfaceLight }}><Minus size={20} color={COLORS.text} /></button>
                <input
                  type="number"
                  value={currentSetData.reps || ''}
                  onChange={e => setCurrentSetData(prev => ({...prev, reps: parseInt(e.target.value) || 0}))}
                  onBlur={e => setCurrentSetData(prev => ({...prev, reps: Number(prev.reps) || 0}))}
                  className="flex-1 p-3 rounded-lg text-center text-2xl font-bold"
                  style={{ backgroundColor: COLORS.surfaceLight, color: COLORS.text, border: 'none' }}
                />
                <button onClick={() => setCurrentSetData(prev => ({...prev, reps: prev.reps + 1}))} className="w-12 h-12 rounded-lg flex items-center justify-center" style={{ backgroundColor: COLORS.surfaceLight }}><Plus size={20} color={COLORS.text} /></button>
              </div>
            </div>
          </div>
          
          {/* RPE Selector */}
          <div>
            <label className="text-xs mb-2 block" style={{ color: COLORS.textMuted }}>RPE (Rate of Perceived Exertion)</label>
            <div className="flex gap-1">
              {[1, 2, 3, 4, 5, 6, 7, 8, 9, 10].map(rpe => (
                <button
                  key={rpe}
                  onClick={() => setCurrentSetData(prev => ({...prev, rpe}))}
                  className="flex-1 py-2 rounded-lg text-xs font-semibold"
                  style={{ 
                    backgroundColor: currentSetData.rpe === rpe ? COLORS.accent : COLORS.surfaceLight,
                    color: currentSetData.rpe === rpe ? COLORS.text : COLORS.textMuted
                  }}
                >
                  {rpe}
                </button>
              ))}
            </div>
            <p className="text-xs mt-1 text-center" style={{ color: COLORS.textMuted }}>
              {currentSetData.rpe === 1 && 'Warm up - very light'}
              {currentSetData.rpe === 2 && 'Light - easy effort'}
              {currentSetData.rpe === 3 && 'Light - could do many more'}
              {currentSetData.rpe === 4 && 'Moderate - comfortable pace'}
              {currentSetData.rpe === 5 && 'Moderate - starting to work'}
              {currentSetData.rpe === 6 && 'Moderate-hard - 4+ reps left'}
              {currentSetData.rpe === 7 && 'Hard - 3 reps left'}
              {currentSetData.rpe === 8 && 'Very hard - 2 reps left'}
              {currentSetData.rpe === 9 && 'Near max - 1 rep left'}
              {currentSetData.rpe === 10 && 'Failure - no more reps possible'}
            </p>
          </div>
        </div>
        
        <div className="p-3 rounded-xl mb-4 flex items-center gap-3" style={{ backgroundColor: COLORS.accent + '15' }}><Clock size={18} color={COLORS.accent} /><p className="text-sm" style={{ color: COLORS.textSecondary }}><strong style={{ color: COLORS.accent }}>{formatTime(currentExercise.restTime)}</strong> rest after this set</p></div>
        
        {/* Completed Sets - Clickable to edit */}
        {completedSets.filter(s => s.exerciseId === currentExercise.id).length > 0 && (
          <div className="mb-4">
            <p className="text-sm font-semibold mb-2" style={{ color: COLORS.text }}>Completed Sets <span className="text-xs font-normal" style={{ color: COLORS.textMuted }}>(tap to edit)</span></p>
            <div className="flex gap-2 flex-wrap">
              {completedSets.filter(s => s.exerciseId === currentExercise.id).map((s, i) => (
                <button 
                  key={i} 
                  onClick={() => { setEditingSet({ exerciseId: s.exerciseId, setIndex: s.setIndex }); setEditSetData({ weight: s.weight, reps: s.reps, rpe: s.rpe || 5 }); }}
                  className="px-3 py-2 rounded-lg" 
                  style={{ backgroundColor: COLORS.success + '20' }}
                >
                  <p className="text-xs font-semibold" style={{ color: COLORS.success }}>Set {i + 1}</p>
                  <p className="text-xs" style={{ color: COLORS.textMuted }}>{s.weight}kg  {s.reps}</p>
                  {s.rpe && <p className="text-xs" style={{ color: COLORS.accent }}>RPE {s.rpe}</p>}
                </button>
              ))}
            </div>
          </div>
        )}
        
        {/* Full Workout List Button */}
        <button 
          onClick={() => setShowFullWorkoutList(true)}
          className="w-full p-3 rounded-xl mb-4 flex items-center justify-between"
          style={{ backgroundColor: COLORS.surfaceLight }}
        >
          <div className="flex items-center gap-2">
            <Book size={18} color={COLORS.textMuted} />
            <span className="text-sm" style={{ color: COLORS.text }}>View Full Workout</span>
          </div>
          <ChevronRight size={18} color={COLORS.textMuted} />
        </button>
        
        {/* Up Next Preview */}
        {getUpcomingExercises().length > 0 && (
          <div>
            <p className="text-sm font-semibold mb-2" style={{ color: COLORS.text }}>Up Next</p>
            <div className="space-y-2">
              {getUpcomingExercises().slice(0, 2).map((ex, i) => (
                <button 
                  key={ex.id} 
                  onClick={() => skipToExercise(currentExerciseIndex + 1 + i)}
                  className="w-full p-3 rounded-lg flex items-center justify-between" 
                  style={{ backgroundColor: COLORS.surfaceLight }}
                >
                  <div className="flex items-center gap-2">
                    <span className="text-sm" style={{ color: COLORS.textMuted }}>{currentExerciseIndex + 2 + i}.</span>
                    <span className="text-sm" style={{ color: COLORS.text }}>{ex.name}</span>
                  </div>
                  <span className="text-xs" style={{ color: COLORS.textMuted }}>{ex.sets}  {ex.targetReps}</span>
                </button>
              ))}
            </div>
          </div>
        )}
      </div>
      
      <div className="p-4 border-t" style={{ borderColor: COLORS.surfaceLight }}>
        <div className="flex items-center justify-between mb-2"><span className="text-sm" style={{ color: COLORS.textMuted }}>Progress</span><span className="text-sm font-semibold" style={{ color: COLORS.text }}>{completedSetsCount}/{totalSets} sets</span></div>
        <div className="h-2 rounded-full overflow-hidden mb-4" style={{ backgroundColor: COLORS.surfaceLight }}><div className="h-full rounded-full transition-all" style={{ backgroundColor: COLORS.primary, width: `${progressPercent}%` }} /></div>
        <div className="flex gap-3">
          <button onClick={() => setShowEndWorkoutConfirm(true)} className="px-4 py-4 rounded-xl font-semibold" style={{ backgroundColor: COLORS.surfaceLight, color: COLORS.error }}>End</button>
          <button onClick={completeSet} className="flex-1 py-4 rounded-xl font-semibold flex items-center justify-center gap-2" style={{ backgroundColor: COLORS.success, color: COLORS.text }}><Check size={20} /> Complete Set</button>
        </div>
      </div>
      
      {/* Full Workout List Modal */}
      {showFullWorkoutList && (
        <div className="fixed inset-0 z-50 flex flex-col" style={{ backgroundColor: COLORS.background }}>
          <div className="p-4 border-b flex items-center justify-between" style={{ borderColor: COLORS.surfaceLight }}>
            <div className="flex items-center gap-3">
              <button onClick={() => setShowFullWorkoutList(false)}><X size={24} color={COLORS.text} /></button>
              <h3 className="text-lg font-bold" style={{ color: COLORS.text }}>Full Workout</h3>
            </div>
            <span className="text-sm" style={{ color: COLORS.textMuted }}>{completedSetsCount}/{totalSets} sets</span>
          </div>
          <div className="flex-1 overflow-auto p-4">
            {exercisesForTime.map((ex, exIndex) => {
              const completedForEx = completedSets.filter(s => s.exerciseId === ex.id);
              const isCurrentExercise = exIndex === currentExerciseIndex;
              const hasCompletedSets = completedForEx.length > 0;

              return (
                <div key={ex.id} className="mb-4 flex gap-2">
                  {/* Up/Down arrows for reordering - only show if not started this exercise */}
                  <div className="flex items-start gap-0.5 pt-3">
                    <button
                      onClick={() => moveExercise(exIndex, 'up')}
                      disabled={exIndex === 0 || hasCompletedSets}
                      className="p-1 rounded"
                      style={{
                        backgroundColor: (exIndex === 0 || hasCompletedSets) ? 'transparent' : COLORS.surfaceLight,
                        opacity: (exIndex === 0 || hasCompletedSets) ? 0.3 : 1
                      }}
                    >
                      <ChevronUp size={16} color={(exIndex === 0 || hasCompletedSets) ? COLORS.textMuted : COLORS.text} />
                    </button>
                    <button
                      onClick={() => moveExercise(exIndex, 'down')}
                      disabled={exIndex === exercisesForTime.length - 1 || hasCompletedSets}
                      className="p-1 rounded"
                      style={{
                        backgroundColor: (exIndex === exercisesForTime.length - 1 || hasCompletedSets) ? 'transparent' : COLORS.surfaceLight,
                        opacity: (exIndex === exercisesForTime.length - 1 || hasCompletedSets) ? 0.3 : 1
                      }}
                    >
                      <ChevronDown size={16} color={(exIndex === exercisesForTime.length - 1 || hasCompletedSets) ? COLORS.textMuted : COLORS.text} />
                    </button>
                  </div>
                  <div className="flex-1">
                  <div
                    className="p-3 rounded-t-xl flex items-center justify-between"
                    style={{
                      backgroundColor: isCurrentExercise ? COLORS.primary + '20' : COLORS.surface,
                      borderLeft: isCurrentExercise ? `3px solid ${COLORS.primary}` : 'none'
                    }}
                  >
                    <div className="flex items-center gap-2">
                      <span className="text-sm font-bold" style={{ color: isCurrentExercise ? COLORS.primary : COLORS.textMuted }}>{exIndex + 1}.</span>
                      <span className="font-semibold" style={{ color: COLORS.text }}>{ex.name}</span>
                      <button onClick={(e) => { e.preventDefault(); e.stopPropagation(); setShowExerciseInfoModal(ex.name); }} className="p-1 rounded-full" style={{ backgroundColor: COLORS.primary + '20' }}><Info size={12} color={COLORS.primary} /></button>
                      {isCurrentExercise && <span className="text-xs px-2 py-0.5 rounded-full" style={{ backgroundColor: COLORS.primary, color: COLORS.text }}>Current</span>}
                    </div>
                    <span className="text-xs" style={{ color: COLORS.textMuted }}>{ex.suggestedWeight}kg</span>
                  </div>
                  <div className="rounded-b-xl overflow-hidden" style={{ backgroundColor: COLORS.surfaceLight }}>
                    {Array.from({ length: ex.sets }).map((_, setIdx) => {
                      const completedSet = completedForEx.find(s => s.setIndex === setIdx);
                      const isCurrentSet = isCurrentExercise && setIdx === currentSetIndex;
                      const isPastSet = exIndex < currentExerciseIndex || (isCurrentExercise && setIdx < currentSetIndex);
                      
                      return (
                        <button
                          key={setIdx}
                          onClick={() => {
                            if (!completedSet) skipToExercise(exIndex, setIdx);
                          }}
                          disabled={completedSet}
                          className="w-full p-3 flex items-center justify-between border-b last:border-b-0"
                          style={{ 
                            borderColor: COLORS.surface,
                            backgroundColor: completedSet ? COLORS.success + '10' : isCurrentSet ? COLORS.primary + '10' : 'transparent'
                          }}
                        >
                          <div className="flex items-center gap-3">
                            {completedSet ? (
                              <div className="w-6 h-6 rounded-full flex items-center justify-center" style={{ backgroundColor: COLORS.success }}>
                                <Check size={14} color={COLORS.text} />
                              </div>
                            ) : isCurrentSet ? (
                              <div className="w-6 h-6 rounded-full flex items-center justify-center" style={{ backgroundColor: COLORS.primary }}>
                                <Play size={12} color={COLORS.text} />
                              </div>
                            ) : (
                              <div className="w-6 h-6 rounded-full flex items-center justify-center" style={{ backgroundColor: COLORS.surface }}>
                                <span className="text-xs" style={{ color: COLORS.textMuted }}>{setIdx + 1}</span>
                              </div>
                            )}
                            <span className="text-sm" style={{ color: completedSet ? COLORS.success : COLORS.text }}>Set {setIdx + 1}</span>
                          </div>
                          <div className="text-right">
                            {completedSet ? (
                              <div>
                                <span className="text-sm font-semibold" style={{ color: COLORS.success }}>{completedSet.weight}kg  {completedSet.reps}</span>
                                {completedSet.rpe && <span className="text-xs ml-2" style={{ color: COLORS.accent }}>RPE {completedSet.rpe}</span>}
                              </div>
                            ) : (
                              <span className="text-sm" style={{ color: COLORS.textMuted }}>{ex.suggestedWeight}kg  {ex.targetReps}</span>
                            )}
                          </div>
                        </button>
                      );
                    })}
                    {/* Rest indicator after exercise */}
                    {exIndex < exercisesForTime.length - 1 && (
                      <div className="p-2 flex items-center justify-center gap-2" style={{ backgroundColor: COLORS.accent + '10' }}>
                        <Clock size={12} color={COLORS.accent} />
                        <span className="text-xs" style={{ color: COLORS.accent }}>{formatTime(ex.restTime)} rest</span>
                      </div>
                    )}
                  </div>
                  </div>
                </div>
              );
            })}
          </div>
          <div className="p-4 border-t" style={{ borderColor: COLORS.surfaceLight }}>
            <button onClick={() => setShowFullWorkoutList(false)} className="w-full py-4 rounded-xl font-semibold" style={{ backgroundColor: COLORS.primary, color: COLORS.text }}>Back to Workout</button>
          </div>
        </div>
      )}
      
      {/* Edit Set Modal */}
      {editingSet && (
        <div className="fixed inset-0 z-50 flex items-center justify-center p-4" style={{ backgroundColor: 'rgba(0,0,0,0.2)' }}>
          <div className="w-full max-w-sm rounded-2xl p-6" style={{ backgroundColor: COLORS.surface }}>
            <div className="flex items-center justify-between mb-4">
              <h3 className="text-lg font-bold" style={{ color: COLORS.text }}>Edit Set</h3>
              <button onClick={() => setEditingSet(null)} className="p-2 rounded-full" style={{ backgroundColor: COLORS.surfaceLight }}><X size={20} color={COLORS.textMuted} /></button>
            </div>
            
            <div className="space-y-4 mb-6">
              <div>
                <label className="text-xs mb-1 block" style={{ color: COLORS.textMuted }}>Weight (kg)</label>
                <div className="flex items-center gap-2">
                  <button onClick={() => setEditSetData(prev => ({...prev, weight: Math.max(0, prev.weight - 2.5)}))} className="w-10 h-10 rounded-lg flex items-center justify-center" style={{ backgroundColor: COLORS.surfaceLight }}><Minus size={16} color={COLORS.text} /></button>
                  <input type="number" value={editSetData.weight} onChange={e => setEditSetData(prev => ({...prev, weight: parseFloat(e.target.value) || 0}))} className="flex-1 p-3 rounded-lg text-center text-xl font-bold" style={{ backgroundColor: COLORS.surfaceLight, color: COLORS.text, border: 'none' }} />
                  <button onClick={() => setEditSetData(prev => ({...prev, weight: prev.weight + 2.5}))} className="w-10 h-10 rounded-lg flex items-center justify-center" style={{ backgroundColor: COLORS.surfaceLight }}><Plus size={16} color={COLORS.text} /></button>
                </div>
              </div>
              <div>
                <label className="text-xs mb-1 block" style={{ color: COLORS.textMuted }}>Reps</label>
                <div className="flex items-center gap-2">
                  <button onClick={() => setEditSetData(prev => ({...prev, reps: Math.max(0, prev.reps - 1)}))} className="w-10 h-10 rounded-lg flex items-center justify-center" style={{ backgroundColor: COLORS.surfaceLight }}><Minus size={16} color={COLORS.text} /></button>
                  <input type="number" value={editSetData.reps} onChange={e => setEditSetData(prev => ({...prev, reps: parseInt(e.target.value) || 0}))} className="flex-1 p-3 rounded-lg text-center text-xl font-bold" style={{ backgroundColor: COLORS.surfaceLight, color: COLORS.text, border: 'none' }} />
                  <button onClick={() => setEditSetData(prev => ({...prev, reps: prev.reps + 1}))} className="w-10 h-10 rounded-lg flex items-center justify-center" style={{ backgroundColor: COLORS.surfaceLight }}><Plus size={16} color={COLORS.text} /></button>
                </div>
              </div>
              <div>
                <label className="text-xs mb-2 block" style={{ color: COLORS.textMuted }}>RPE</label>
                <div className="flex gap-1 flex-wrap">
                  {[1, 2, 3, 4, 5, 6, 7, 8, 9, 10].map(rpe => (
                    <button
                      key={rpe}
                      onClick={() => setEditSetData(prev => ({...prev, rpe}))}
                      className="flex-1 py-2 rounded-lg text-xs font-semibold min-w-[28px]"
                      style={{ 
                        backgroundColor: editSetData.rpe === rpe ? COLORS.accent : COLORS.surfaceLight,
                        color: editSetData.rpe === rpe ? COLORS.text : COLORS.textMuted
                      }}
                    >
                      {rpe}
                    </button>
                  ))}
                </div>
              </div>
            </div>
            
            <div className="flex gap-3">
              <button onClick={() => setEditingSet(null)} className="flex-1 py-3 rounded-xl font-semibold" style={{ backgroundColor: COLORS.surfaceLight, color: COLORS.textMuted }}>Cancel</button>
              <button onClick={() => updateCompletedSet(editingSet.exerciseId, editingSet.setIndex, editSetData)} className="flex-1 py-3 rounded-xl font-semibold" style={{ backgroundColor: COLORS.primary, color: COLORS.text }}>Save</button>
            </div>
          </div>
        </div>
      )}
      
      {/* End Workout Confirmation */}
      {showEndWorkoutConfirm && (
        <div className="fixed inset-0 z-50 flex items-center justify-center p-4" style={{ backgroundColor: 'rgba(0,0,0,0.2)' }}>
          <div className="w-full max-w-sm rounded-2xl p-6" style={{ backgroundColor: COLORS.surface }}>
            <div className="text-center mb-6">
              <div className="w-16 h-16 rounded-full mx-auto mb-4 flex items-center justify-center" style={{ backgroundColor: COLORS.warning + '20' }}>
                <Pause size={32} color={COLORS.warning} />
              </div>
              <h3 className="text-xl font-bold mb-2" style={{ color: COLORS.text }}>Pause Workout?</h3>
              <p className="text-sm" style={{ color: COLORS.textMuted }}>
                You've completed {completedSetsCount} of {totalSets} sets.
              </p>
            </div>
            <div className="space-y-2">
              <button onClick={() => setShowEndWorkoutConfirm(false)} className="w-full py-3 rounded-xl font-semibold" style={{ backgroundColor: COLORS.primary, color: COLORS.text }}>Continue Workout</button>
              <button
                onClick={() => {
                  // Save progress for resume
                  if (onSaveProgress) {
                    onSaveProgress({
                      phase,
                      currentExerciseIndex,
                      currentSetIndex,
                      completedSets,
                      exercises,
                      workoutStartTime,
                      totalWorkingTime,
                      totalRestTime,
                      sessionId,
                      workoutName,
                    });
                  }
                  setShowEndWorkoutConfirm(false);
                  onClose();
                }}
                className="w-full py-3 rounded-xl font-semibold flex items-center justify-center gap-2"
                style={{ backgroundColor: COLORS.warning + '20', color: COLORS.warning }}
              >
                <Pause size={18} /> Save & Exit (Resume Later)
              </button>
              <button onClick={endWorkoutEarly} className="w-full py-3 rounded-xl font-semibold" style={{ backgroundColor: COLORS.error + '20', color: COLORS.error }}>End Workout Now</button>
            </div>
          </div>
        </div>
      )}

      {/* Exercise Info Modal */}
      {showExerciseInfoModal && (
        <ExerciseInfoModal
          COLORS={COLORS}
          exerciseName={showExerciseInfoModal}
          onClose={() => setShowExerciseInfoModal(null)}
        />
      )}
    </div>
  );
}

// Main App Component

// HomeTab Component - extracted outside UpRepDemo to prevent re-creation on state changes
const HomeTab = ({
  COLORS,
  homeScrollRef,
  homeScrollPos,
  userData,
  user,
  todayWorkout,
  setTodayWorkout,
  todayWorkoutCompleted,
  todayWorkoutTemplate,
  isPaused,
  setIsPaused,
  pauseReturnDate,
  setPauseReturnDate,
  isRescheduled,
  originalWorkout,
  setIsRescheduled,
  setOriginalWorkout,
  setShowPausePlan,
  setShowReschedule,
  setShowWorkoutPreview,
  caloriesIntake,
  proteinIntake,
  carbsIntake,
  fatsIntake,
  waterIntake,
  setWaterIntake,
  nutritionGoals,
  adjustedNutritionGoals,
  supplements,
  setSupplements,
  mealLog,
  lastNightBedTime,
  lastNightWakeTime,
  lastNightConfirmed,
  setLastNightConfirmed,
  sleepHours,
  settings,
  setSettings,
  streaks,
  setShowWeighIn,
  setShowWaterEntry,
  setShowAddMealFull,
  activityFeed,
  setActivityFeed,
  likedPosts,
  setLikedPosts,
  setActiveTab,
  setFriendsTab,
  setNutritionTab,
  setShowWorkoutSummary,
  socialEnabled,
  followersCount,
  followingIds,
  showNotifications,
  setShowNotifications,
  unreadCount,
  notifications,
  setNotifications,
  getWorkoutColor,
  nutritionService,
  setWaterLogs,
  supabase,
  socialService,
  workoutStats,
  chartTimeFrame,
  setChartTimeFrame,
  chartData,
  weeklyNutrition,
  sleepChartData,
  communityWorkouts,
  expandedTrendingWorkoutId,
  setExpandedTrendingWorkoutId,
  friends,
  savedWorkoutIds,
  setSavedWorkoutIds,
  showMissedDayPrompt,
  setShowMissedDayPrompt,
  missedDayData,
  setMissedDayData,
  setMissedDayDismissed,
  showActiveWorkout,
  setShowActiveWorkout,
  partialWorkoutProgress,
  setPartialWorkoutProgress,
  completeTodayWorkout,
  workoutTime,
  setWorkoutTime,
  injuries,
  personalWarmup,
  setPersonalWarmup,
  personalCooldown,
  setPersonalCooldown,
  customExerciseCount,
  setCustomExerciseCount,
  customizedExercises,
  setCustomizedExercises,
  getCurrentExercises,
  getInjuryRecoveryExercisesToAdd,
  ALL_EXERCISES,
  WORKOUT_TIMING,
  showWorkoutTimeEditor,
  setShowWorkoutTimeEditor,
}) => {
    const handleScroll = (e) => {
      homeScrollPos.current = e.target.scrollTop;
    };

    // Get time-based greeting
    const getGreeting = () => {
      const hour = new Date().getHours();
      if (hour < 12) return 'Good morning';
      if (hour < 17) return 'Good afternoon';
      return 'Good evening';
    };

    // Calculate sleep hours from last night (with safety)
    const getSleepHours = () => {
      try {
        const bedTime = lastNightBedTime || '23:00';
        const wakeTime = lastNightWakeTime || '07:00';
        const [bedH, bedM] = bedTime.split(':').map(Number);
        const [wakeH, wakeM] = wakeTime.split(':').map(Number);
        let hours = wakeH - bedH + (wakeM - bedM) / 60;
        if (hours < 0) hours += 24;
        return hours.toFixed(1);
      } catch (e) {
        return '7.0';
      }
    };

    // Quick stats for the compact circles (with safety checks)
    const tracking = settings?.tracking || {};
    const adjGoals = adjustedNutritionGoals || {};
    const nutGoals = nutritionGoals || {};

    const supplementsTaken = supplements?.filter(s => s.taken)?.length || 0;
    const supplementsTotal = supplements?.length || 0;

    const quickStats = [
      {
        id: 'calories',
        label: 'Cal',
        current: caloriesIntake || 0,
        target: adjGoals.calories || nutGoals.calories || 2200,
        color: COLORS.accent,
        enabled: tracking.calories
      },
      {
        id: 'protein',
        label: 'Protein',
        current: proteinIntake || 0,
        target: adjGoals.protein || nutGoals.protein || 150,
        color: COLORS.protein || COLORS.primary,
        enabled: tracking.macros
      },
      {
        id: 'water',
        label: 'Water',
        current: waterIntake || 0,
        target: adjGoals.water || nutGoals.water || 2500,
        color: COLORS.water,
        enabled: tracking.water
      },
      {
        id: 'supplements',
        label: 'Supps',
        current: supplementsTaken,
        target: Math.max(supplementsTotal, 1),
        displayValue: `${supplementsTaken}/${supplementsTotal}`,
        color: COLORS.supplements,
        enabled: tracking.supplements
      },
      {
        id: 'sleep',
        label: 'Sleep',
        current: parseFloat(getSleepHours()) || 0,
        target: 8,
        displayValue: getSleepHours() + 'h',
        color: COLORS.sleep,
        enabled: tracking.sleep
      }
    ];

    // Handle quick stat taps
    const handleStatTap = (statId) => {
      if (statId === 'calories' || statId === 'protein') {
        setShowMealEntry(true);
      } else if (statId === 'water') {
        setShowWaterEntry(true);
      } else if (statId === 'supplements') {
        setShowSupplementHistory(true);
      } else if (statId === 'sleep') {
        setActiveTab('nutrition');
        setNutritionTab('sleep');
      }
    };

    // Resume plan handler
    const handleResume = () => {
      setIsPaused(false);
      setPauseReturnDate(null);
      setTodayWorkout({
        type: todayWorkoutTemplate?.name?.replace(' Day ', ' ').replace('Day ', '') || 'Workout',
        name: todayWorkoutTemplate?.name || 'Workout',
        focus: todayWorkoutTemplate?.focus || '',
        exercises: todayWorkoutTemplate?.exercises?.length || 5,
        duration: 60
      });
    };

    // Chart selection state
    const [selectedChart, setSelectedChart] = React.useState('weight');

    return (
    <div ref={homeScrollRef} onScroll={handleScroll} className="overflow-auto pb-20" style={{ backgroundColor: COLORS.background, height: '100%' }}>
      {/* User Header with Stats */}
      <div className="flex justify-between items-center px-4 pt-4 pb-3">
        <div className="flex items-center gap-3">
          <button
            onClick={() => setActiveTab('profile')}
            className="w-11 h-11 rounded-full flex items-center justify-center"
            style={{ backgroundColor: COLORS.primary }}
          >
            <span className="text-base font-bold" style={{ color: COLORS.text }}>
              {userData.firstName ? userData.firstName[0].toUpperCase() : 'U'}
            </span>
          </button>
          <div className="flex-1">
            <p className="font-bold text-lg" style={{ color: COLORS.text }}>
              @{userData.username || 'username'}
            </p>
            {userData.bio && (
              <p className="text-xs mb-1 line-clamp-1" style={{ color: COLORS.textSecondary }}>
                {userData.bio}
              </p>
            )}
            <div className="flex items-center gap-3">
              <button
                onClick={() => { setActiveTab('friends'); setFriendsTab('followers'); }}
                className="text-xs"
                style={{ color: COLORS.textMuted }}
              >
                <span style={{ color: COLORS.text, fontWeight: 600 }}>{followersCount}</span> followers
              </button>
              <button
                onClick={() => { setActiveTab('friends'); setFriendsTab('following'); }}
                className="text-xs"
                style={{ color: COLORS.textMuted }}
              >
                <span style={{ color: COLORS.text, fontWeight: 600 }}>{followingIds.size}</span> following
              </button>
            </div>
          </div>
        </div>
        <div className="flex items-center gap-2">
          {/* Notification Bell */}
          <div className="relative">
            <button
              onClick={() => setShowNotifications(!showNotifications)}
              className="p-2 rounded-lg relative"
              style={{ backgroundColor: COLORS.surface }}
            >
              <Bell size={18} color={COLORS.textMuted} />
              {unreadCount > 0 && (
                <span
                  className="absolute -top-1 -right-1 w-5 h-5 rounded-full flex items-center justify-center text-xs font-bold"
                  style={{ backgroundColor: COLORS.error, color: COLORS.text }}
                >
                  {unreadCount > 9 ? '9+' : unreadCount}
                </span>
              )}
            </button>

            {/* Notification Dropdown */}
            {showNotifications && (
              <>
                {/* Backdrop to close on outside click */}
                <div
                  className="fixed inset-0 z-40"
                  onClick={async () => {
                    if (unreadCount > 0) {
                      await notificationService.markAllAsRead(user?.id);
                      setUnreadCount(0);
                      setNotifications(prev => prev.map(n => ({ ...n, read: true })));
                    }
                    setShowNotifications(false);
                  }}
                />
                <div
                  className="absolute right-0 top-12 w-80 max-h-96 overflow-auto rounded-xl shadow-lg z-50"
                  style={{ backgroundColor: COLORS.surface }}
                >
                  <div className="p-3 border-b flex justify-between items-center" style={{ borderColor: COLORS.surfaceLight }}>
                    <p className="font-semibold" style={{ color: COLORS.text }}>Notifications</p>
                    {unreadCount > 0 && (
                      <button
                        onClick={async () => {
                          await notificationService.markAllAsRead(user?.id);
                          setUnreadCount(0);
                          setNotifications(prev => prev.map(n => ({ ...n, read: true })));
                        }}
                        className="text-xs"
                        style={{ color: COLORS.primary }}
                      >
                        Mark all read
                      </button>
                    )}
                  </div>
                  {notifications.length === 0 ? (
                    <div className="p-6 text-center">
                      <Bell size={24} color={COLORS.textMuted} className="mx-auto mb-2" />
                      <p className="text-sm" style={{ color: COLORS.textMuted }}>No notifications yet</p>
                    </div>
                  ) : (
                    <div>
                      {notifications.slice(0, 10).map(notif => (
                        <div
                          key={notif.id}
                          onClick={async () => {
                            // Mark as read
                            if (!notif.read) {
                              await notificationService.markAsRead(notif.id);
                              setNotifications(prev => prev.map(n => n.id === notif.id ? { ...n, read: true } : n));
                              setUnreadCount(prev => Math.max(0, prev - 1));
                            }
                            // Navigate based on notification type
                            if (notif.type === 'new_follower' && notif.from_user) {
                              setShowFriendProfile({
                                id: notif.from_user.id,
                                name: `${notif.from_user.first_name || ''} ${notif.from_user.last_name || ''}`.trim() || notif.from_user.username,
                                username: notif.from_user.username,
                                avatar: notif.from_user.avatar_url || notif.from_user.first_name?.[0]?.toUpperCase() || '?',
                              });
                            } else if (notif.type === 'comment' && notif.reference_id) {
                              // Go directly to comments section
                              loadComments(notif.reference_id);
                              setActiveTab('friends');
                              setFriendsTab('community_workouts');
                            } else if (notif.type === 'workout_like' && notif.reference_id) {
                              // Find the workout in communityWorkouts or myPublishedWorkouts
                              let workout = communityWorkouts.find(w => w.id === notif.reference_id);
                              if (!workout) {
                                workout = myPublishedWorkouts.find(w => w.id === notif.reference_id);
                              }
                              if (workout) {
                                setSelectedCommunityWorkout(workout);
                              } else {
                                // Fetch the workout directly
                                publishedWorkoutService.getWorkoutById(notif.reference_id).then(result => {
                                  if (result?.data) {
                                    setSelectedCommunityWorkout(result.data);
                                  }
                                });
                              }
                              setActiveTab('friends');
                              setFriendsTab('community_workouts');
                            }
                            setShowNotifications(false);
                          }}
                          className="w-full p-3 border-b flex items-start gap-3 text-left hover:opacity-80 cursor-pointer"
                          role="button"
                          tabIndex={0}
                          style={{
                            borderColor: COLORS.surfaceLight,
                            backgroundColor: notif.read ? 'transparent' : COLORS.primary + '10'
                          }}
                        >
                          <button
                            onClick={(e) => {
                              e.stopPropagation();
                              if (notif.from_user) {
                                setShowFriendProfile({
                                  id: notif.from_user.id,
                                  name: `${notif.from_user.first_name || ''} ${notif.from_user.last_name || ''}`.trim() || notif.from_user.username,
                                  username: notif.from_user.username,
                                  avatar: notif.from_user.avatar_url || notif.from_user.first_name?.[0]?.toUpperCase() || '?',
                                });
                                setShowNotifications(false);
                              }
                            }}
                            className="w-10 h-10 rounded-full flex items-center justify-center flex-shrink-0"
                            style={{ backgroundColor: COLORS.surfaceLight }}
                          >
                            {notif.from_user?.first_name?.[0]?.toUpperCase() || <User size={16} color={COLORS.textMuted} />}
                          </button>
                          <div className="flex-1 min-w-0">
                            <p className="text-sm font-medium" style={{ color: COLORS.text }}>{notif.title}</p>
                            <p className="text-xs" style={{ color: COLORS.textMuted }}>{notif.message}</p>
                            <p className="text-xs mt-1" style={{ color: COLORS.textSecondary }}>
                              {formatRelativeDate(notif.created_at)}
                            </p>
                          </div>
                        </div>
                      ))}
                    </div>
                  )}
                </div>
              </>
            )}
          </div>

          <button
            onClick={() => setActiveTab('profile')}
            className="p-2 rounded-lg"
            style={{ backgroundColor: COLORS.surface }}
          >
            <Settings size={18} color={COLORS.textMuted} />
          </button>
        </div>
      </div>

      {/* Today's Action Card - FIRST */}
      <div className="mx-4 mb-2">
        <p className="text-xs font-semibold" style={{ color: COLORS.textMuted }}>TODAY'S WORKOUT</p>
      </div>
      <div className="mx-4 p-4 rounded-xl mb-6" style={{ backgroundColor: COLORS.surface, borderLeft: `4px solid ${COLORS.primary}` }}>
        {isPaused ? (
          <>
            <div className="flex items-center gap-4">
              <div className="w-14 h-14 rounded-xl flex items-center justify-center" style={{ backgroundColor: COLORS.warning + '20' }}>
                <Pause size={28} color={COLORS.warning} />
              </div>
              <div className="flex-1">
                <p className="text-xs font-semibold mb-1" style={{ color: COLORS.warning }}>PAUSED</p>
                <p className="font-semibold" style={{ color: COLORS.text }}>Enjoying your break</p>
              </div>
            </div>
            <button onClick={handleResume} className="w-full mt-4 py-3 rounded-xl font-semibold" style={{ backgroundColor: COLORS.warning, color: COLORS.background }}>
              Resume Plan
            </button>
          </>
        ) : todayWorkoutCompleted ? (
          <div className="flex items-center gap-4">
            <div className="w-14 h-14 rounded-xl flex items-center justify-center" style={{ backgroundColor: COLORS.success + '20' }}>
              <Check size={28} color={COLORS.success} />
            </div>
            <div className="flex-1">
              <p className="text-xs font-semibold mb-1" style={{ color: COLORS.success }}>COMPLETED</p>
              <p className="font-semibold" style={{ color: COLORS.text }}>{todayWorkout?.name || 'Workout'}</p>
              <p className="text-sm" style={{ color: COLORS.textMuted }}>Great work today!</p>
            </div>
          </div>
        ) : todayWorkout?.type === 'Rest' ? (
          <div className="flex items-center gap-4">
            <div className="w-14 h-14 rounded-xl flex items-center justify-center" style={{ backgroundColor: COLORS.sleep + '20' }}>
              <Moon size={28} color={COLORS.sleep} />
            </div>
            <div className="flex-1">
              <p className="text-xs font-semibold mb-1" style={{ color: COLORS.sleep }}>REST DAY</p>
              <p className="font-semibold" style={{ color: COLORS.text }}>Recovery Time</p>
              <p className="text-sm" style={{ color: COLORS.textMuted }}>Your muscles grow while you rest</p>
            </div>
          </div>
        ) : (
          <>
            <div className="flex justify-between items-start mb-3">
              <div>
                <span className="text-xs px-2 py-1 rounded font-semibold"
                  style={{ backgroundColor: COLORS.primary + '20', color: COLORS.primary }}>
                  TODAY
                </span>
                <h4 className="text-xl font-bold mt-2" style={{ color: COLORS.text }}>{todayWorkout?.name || 'Workout'}</h4>
                <p className="text-sm" style={{ color: COLORS.primary }}>{todayWorkout?.focus || ''}</p>
              </div>
              <div className="flex items-center gap-2">
                <button onClick={() => setShowPausePlan(true)} className="p-2 rounded-lg" style={{ backgroundColor: COLORS.surfaceLight }} title="Pause Plan">
                  <Moon size={16} color={COLORS.textMuted} />
                </button>
                <button onClick={() => setShowReschedule(true)} className="p-2 rounded-lg" style={{ backgroundColor: COLORS.surfaceLight }} title="Reschedule">
                  <Calendar size={16} color={COLORS.textMuted} />
                </button>
              </div>
            </div>

            {/* Time Editor Toggle */}
            <button
              onClick={() => setShowWorkoutTimeEditor(!showWorkoutTimeEditor)}
              className="flex items-center gap-2 mb-3 px-3 py-2 rounded-lg w-full justify-between"
              style={{ backgroundColor: COLORS.surfaceLight }}
            >
              <div className="flex items-center gap-2">
                <Clock size={14} color={COLORS.textSecondary} />
                <span className="text-sm" style={{ color: COLORS.textSecondary }}>
                  {workoutTime} min  {customExerciseCount || Math.max(2, Math.floor(workoutTime / 12))} exercises
                </span>
              </div>
              <ChevronDown size={14} color={COLORS.textMuted} style={{ transform: showWorkoutTimeEditor ? 'rotate(180deg)' : 'none', transition: 'transform 0.2s' }} />
            </button>

            {/* Expanded Time Editor */}
            {showWorkoutTimeEditor && (() => {
              const defaultExerciseCount = Math.max(2, Math.floor(workoutTime / 12));
              const exerciseCount = customExerciseCount || defaultExerciseCount;
              const allExercises = getCurrentExercises();
              // Use template exercises, or current exercises, or fall back to ALL_EXERCISES
              const fullPool = (todayWorkoutTemplate?.exercises?.length > 0 ? todayWorkoutTemplate.exercises : null)
                || (allExercises?.length > 0 ? allExercises : null)
                || ALL_EXERCISES;
              const minExercises = 2;
              const maxExercises = Math.min(fullPool.length, Math.floor(workoutTime / 5));
              const workoutTypeForCoverage = todayWorkoutTemplate?.workoutType || todayWorkout?.type || null;
              const exercisesForTime = optimizeExercisesForTimeAndCount(allExercises, fullPool, workoutTime, exerciseCount, workoutTypeForCoverage, settings.workout.corePosition, personalWarmup, personalCooldown, !!customizedExercises);
              const timeBreakdown = getWorkoutTimeBreakdown(exercisesForTime);

              return (
                <div className="mb-3 p-3 rounded-lg" style={{ backgroundColor: COLORS.background }}>
                  <p className="text-xs mb-2" style={{ color: COLORS.textMuted }}>How much time do you have?</p>
                  <div className="grid grid-cols-6 gap-1.5 mb-3">
                    {[20, 30, 45, 60, 75, 90].map(time => (
                      <button
                        key={time}
                        onClick={() => setWorkoutTime(time)}
                        className="py-1.5 rounded-lg text-xs font-semibold"
                        style={{
                          backgroundColor: workoutTime === time ? COLORS.primary : COLORS.surface,
                          color: workoutTime === time ? COLORS.text : COLORS.textMuted
                        }}
                      >
                        {time}
                      </button>
                    ))}
                  </div>

                  {/* Exercise Count */}
                  <div className="flex items-center justify-between mb-3 p-2 rounded-lg" style={{ backgroundColor: COLORS.surface }}>
                    <span className="text-xs" style={{ color: COLORS.textSecondary }}>Exercises</span>
                    <div className="flex items-center gap-2">
                      <button
                        onClick={() => {
                          const newCount = Math.max(minExercises, exerciseCount - 1);
                          setCustomExerciseCount(newCount === defaultExerciseCount ? null : newCount);
                        }}
                        disabled={exerciseCount <= minExercises}
                        className="w-7 h-7 rounded-full flex items-center justify-center"
                        style={{
                          backgroundColor: exerciseCount <= minExercises ? COLORS.surfaceLight : COLORS.primary + '20',
                          opacity: exerciseCount <= minExercises ? 0.5 : 1
                        }}
                      >
                        <Minus size={14} color={exerciseCount <= minExercises ? COLORS.textMuted : COLORS.primary} />
                      </button>
                      <span className="text-sm font-bold w-6 text-center" style={{ color: COLORS.text }}>{exerciseCount}</span>
                      <button
                        onClick={() => {
                          const newCount = Math.min(maxExercises, exerciseCount + 1);
                          setCustomExerciseCount(newCount === defaultExerciseCount ? null : newCount);
                        }}
                        disabled={exerciseCount >= maxExercises}
                        className="w-7 h-7 rounded-full flex items-center justify-center"
                        style={{
                          backgroundColor: exerciseCount >= maxExercises ? COLORS.surfaceLight : COLORS.primary + '20',
                          opacity: exerciseCount >= maxExercises ? 0.5 : 1
                        }}
                      >
                        <Plus size={14} color={exerciseCount >= maxExercises ? COLORS.textMuted : COLORS.primary} />
                      </button>
                    </div>
                  </div>

                  {/* Time Breakdown */}
                  <div className="grid grid-cols-4 gap-1.5 mb-3">
                    <div className="p-2 rounded-lg text-center" style={{ backgroundColor: COLORS.primary + '15' }}>
                      <p className="text-xs font-bold" style={{ color: COLORS.primary }}>{Math.floor(timeBreakdown.workingTime / 60)}m</p>
                      <p className="text-xs" style={{ color: COLORS.textMuted }}>Work</p>
                    </div>
                    <div className="p-2 rounded-lg text-center" style={{ backgroundColor: COLORS.warning + '15' }}>
                      <p className="text-xs font-bold" style={{ color: COLORS.warning }}>{Math.floor(timeBreakdown.restTime / 60)}m</p>
                      <p className="text-xs" style={{ color: COLORS.textMuted }}>Rest</p>
                    </div>
                    <div className="p-2 rounded-lg text-center" style={{ backgroundColor: COLORS.sleep + '15' }}>
                      <p className="text-xs font-bold" style={{ color: COLORS.sleep }}>{(personalWarmup ? 5 : 0) + (personalCooldown ? 5 : 0)}m</p>
                      <p className="text-xs" style={{ color: COLORS.textMuted }}>Warm/Cool</p>
                    </div>
                    <div className="p-2 rounded-lg text-center" style={{ backgroundColor: COLORS.success + '15' }}>
                      <p className="text-xs font-bold" style={{ color: COLORS.success }}>~{Math.round((timeBreakdown.workingTime + timeBreakdown.restTime) / 60 + (personalWarmup ? 5 : 0) + (personalCooldown ? 5 : 0))}m</p>
                      <p className="text-xs" style={{ color: COLORS.textMuted }}>Total</p>
                    </div>
                  </div>

                  {/* Warmup/Cooldown Toggles */}
                  <div className="flex items-center gap-2 mb-3">
                    <button
                      onClick={() => setPersonalWarmup(!personalWarmup)}
                      className="flex-1 flex items-center justify-center gap-2 px-3 py-2 rounded-lg text-xs font-semibold"
                      style={{
                        backgroundColor: personalWarmup ? COLORS.primary + '20' : COLORS.surfaceLight,
                        color: personalWarmup ? COLORS.primary : COLORS.textMuted
                      }}
                    >
                      <Wind size={14} />
                      Warmup 5min
                      {personalWarmup ? <Check size={12} /> : null}
                    </button>
                    <button
                      onClick={() => setPersonalCooldown(!personalCooldown)}
                      className="flex-1 flex items-center justify-center gap-2 px-3 py-2 rounded-lg text-xs font-semibold"
                      style={{
                        backgroundColor: personalCooldown ? COLORS.primary + '20' : COLORS.surfaceLight,
                        color: personalCooldown ? COLORS.primary : COLORS.textMuted
                      }}
                    >
                      <Sprout size={14} />
                      Cooldown 5min
                      {personalCooldown ? <Check size={12} /> : null}
                    </button>
                  </div>

                  {/* Exercise List Toggle */}
                  <div className="border-t pt-3" style={{ borderColor: COLORS.surfaceLight }}>
                    <button
                      onClick={() => setExerciseListCollapsed(!exerciseListCollapsed)}
                      className="w-full flex items-center justify-between mb-2"
                    >
                      <div className="flex items-center gap-2">
                        <ChevronDown
                          size={14}
                          color={COLORS.textMuted}
                          style={{ transform: exerciseListCollapsed ? 'rotate(-90deg)' : 'rotate(0deg)', transition: 'transform 0.2s' }}
                        />
                        <p className="text-xs font-semibold" style={{ color: COLORS.textMuted }}>
                          {exercisesForTime.length} EXERCISES  {exercisesForTime.reduce((acc, ex) => acc + (ex.sets || 3), 0)} SETS
                        </p>
                      </div>
                      <div className="flex items-center gap-2">
                        {(customizedExercises || customExerciseCount) && (
                          <button
                            onClick={(e) => {
                              e.stopPropagation();
                              resetCustomizations();
                              setCustomExerciseCount(null);
                            }}
                            className="text-xs px-2 py-1 rounded-full flex items-center gap-1"
                            style={{ backgroundColor: COLORS.warning + '20', color: COLORS.warning }}
                          >
                            <Undo2 size={10} /> Reset
                          </button>
                        )}
                        <span className="text-xs" style={{ color: COLORS.textMuted }}>
                          {exerciseListCollapsed ? 'Show' : 'Hide'}
                        </span>
                      </div>
                    </button>

                    {!exerciseListCollapsed && (
                      <div className="space-y-1.5">
                        {/* Warmup Item */}
                        {personalWarmup && (
                          <div className="p-2 rounded-lg flex items-center gap-2" style={{ backgroundColor: COLORS.primary + '15', border: `1px dashed ${COLORS.primary}40` }}>
                            <div className="w-5 h-5 rounded-full flex items-center justify-center" style={{ backgroundColor: COLORS.primary + '30' }}>
                              <Wind size={12} color={COLORS.primary} />
                            </div>
                            <div className="flex-1">
                              <p className="text-xs font-semibold" style={{ color: COLORS.primary }}>Warmup</p>
                              <p className="text-xs" style={{ color: COLORS.textMuted }}>Dynamic stretches</p>
                            </div>
                            <p className="text-xs font-semibold" style={{ color: COLORS.primary }}>5min</p>
                          </div>
                        )}
                        {exercisesForTime.map((exercise, i) => {
                          const isExpanded = expandedExerciseId === exercise.id;
                          const originalIndex = allExercises.findIndex(ex => ex.id === exercise.id);

                          return (
                            <div key={exercise.id} className="flex items-stretch gap-1">
                              {/* Up/Down arrows on left */}
                              <div className="flex items-center gap-0.5">
                                <button
                                  onClick={(e) => { e.stopPropagation(); moveExerciseInHome(exercise.id, 'up', exercisesForTime); }}
                                  disabled={i === 0}
                                  className="p-1 rounded"
                                  style={{
                                    backgroundColor: i === 0 ? 'transparent' : COLORS.surfaceLight,
                                    opacity: i === 0 ? 0.3 : 1
                                  }}
                                >
                                  <ChevronUp size={14} color={i === 0 ? COLORS.textMuted : COLORS.text} />
                                </button>
                                <button
                                  onClick={(e) => { e.stopPropagation(); moveExerciseInHome(exercise.id, 'down', exercisesForTime); }}
                                  disabled={i === exercisesForTime.length - 1}
                                  className="p-1 rounded"
                                  style={{
                                    backgroundColor: i === exercisesForTime.length - 1 ? 'transparent' : COLORS.surfaceLight,
                                    opacity: i === exercisesForTime.length - 1 ? 0.3 : 1
                                  }}
                                >
                                  <ChevronDown size={14} color={i === exercisesForTime.length - 1 ? COLORS.textMuted : COLORS.text} />
                                </button>
                              </div>

                              {/* Exercise card */}
                              <div className="flex-1 rounded-lg overflow-hidden" style={{ backgroundColor: COLORS.surface }}>
                                <div
                                  onClick={() => setExpandedExerciseId(isExpanded ? null : exercise.id)}
                                  className="w-full flex items-center justify-between p-2 cursor-pointer"
                                  role="button"
                                  tabIndex={0}
                                  onKeyDown={(e) => { if (e.key === 'Enter' || e.key === ' ') setExpandedExerciseId(isExpanded ? null : exercise.id); }}
                                >
                                  <div className="flex items-center gap-2">
                                    <div
                                      className="w-5 h-5 rounded-full flex items-center justify-center text-xs font-bold"
                                      style={{ backgroundColor: COLORS.primary + '20', color: COLORS.primary }}
                                    >
                                      {i + 1}
                                    </div>
                                    <div className="text-left">
                                      <div className="flex items-center gap-1">
                                        <p className="text-xs font-medium" style={{ color: COLORS.text }}>{exercise.name}</p>
                                        <button
                                          onClick={(e) => { e.stopPropagation(); setShowExerciseInfo(exercise.name); }}
                                          className="p-0.5 rounded-full"
                                          style={{ backgroundColor: COLORS.primary + '20' }}
                                        >
                                          <Info size={10} color={COLORS.primary} />
                                        </button>
                                      </div>
                                      <p className="text-xs" style={{ color: COLORS.textMuted }}>{exercise.muscleGroup}</p>
                                    </div>
                                  </div>
                                  <div className="flex items-center gap-2">
                                    <div className="text-right">
                                      <p className="text-xs font-semibold" style={{ color: COLORS.text }}>{exercise.sets}{exercise.targetReps}</p>
                                      <div className="flex items-center gap-1">
                                        <p className="text-xs" style={{ color: COLORS.textMuted }}>{exercise.suggestedWeight}kg</p>
                                        <span className="text-xs px-1 py-0.5 rounded" style={{ backgroundColor: COLORS.warning + '15', color: COLORS.warning }}>
                                          {Math.floor((exercise.restTime || 90) / 60)}:{((exercise.restTime || 90) % 60).toString().padStart(2, '0')}
                                        </span>
                                      </div>
                                    </div>
                                    <ChevronDown
                                      size={14}
                                      color={COLORS.textMuted}
                                      style={{ transform: isExpanded ? 'rotate(180deg)' : 'none', transition: 'transform 0.2s' }}
                                    />
                                  </div>
                                </div>

                                {/* Expanded Options */}
                                {isExpanded && (
                                  <div className="px-2 pb-2 pt-1 border-t" style={{ borderColor: COLORS.surfaceLight }}>
                                    <div className="flex gap-2">
                                      <button
                                        onClick={() => swapExercise(originalIndex)}
                                        className="flex-1 py-1.5 rounded-lg text-xs font-medium flex items-center justify-center gap-1"
                                        style={{ backgroundColor: COLORS.primary + '20', color: COLORS.primary }}
                                      >
                                        <ArrowLeftRight size={12} /> Swap
                                      </button>
                                      <button
                                        onClick={() => removeExercise(originalIndex)}
                                        disabled={allExercises.length <= 2}
                                        className="flex-1 py-1.5 rounded-lg text-xs font-medium flex items-center justify-center gap-1"
                                        style={{
                                          backgroundColor: allExercises.length <= 2 ? COLORS.surfaceLight : COLORS.error + '20',
                                          color: allExercises.length <= 2 ? COLORS.textMuted : COLORS.error,
                                          opacity: allExercises.length <= 2 ? 0.5 : 1
                                        }}
                                      >
                                        <X size={12} /> Remove
                                      </button>
                                    </div>
                                  </div>
                                )}
                              </div>
                            </div>
                          );
                        })}
                        {/* Cooldown Item */}
                        {personalCooldown && (
                          <div className="p-2 rounded-lg flex items-center gap-2" style={{ backgroundColor: COLORS.primary + '15', border: `1px dashed ${COLORS.primary}40` }}>
                            <div className="w-5 h-5 rounded-full flex items-center justify-center" style={{ backgroundColor: COLORS.primary + '30' }}>
                              <Sprout size={12} color={COLORS.primary} />
                            </div>
                            <div className="flex-1">
                              <p className="text-xs font-semibold" style={{ color: COLORS.primary }}>Cooldown</p>
                              <p className="text-xs" style={{ color: COLORS.textMuted }}>Static stretches</p>
                            </div>
                            <p className="text-xs font-semibold" style={{ color: COLORS.primary }}>5min</p>
                          </div>
                        )}
                      </div>
                    )}
                  </div>
                </div>
              );
            })()}

            <button onClick={() => setShowActiveWorkout(true)} className="w-full py-3 rounded-xl font-semibold flex items-center justify-center gap-2" style={{ backgroundColor: partialWorkoutProgress ? COLORS.warning : COLORS.primary, color: COLORS.text }}>
              {partialWorkoutProgress ? <><Play size={18} /> Resume Workout</> : 'Start Workout'}
            </button>
          </>
        )}
      </div>

      {/* Quick Stats Row - SECOND */}
      <div className="px-4 mt-4">
        <p className="text-xs font-semibold mb-2" style={{ color: COLORS.textMuted }}>TODAY'S PROGRESS</p>
        <div className="flex justify-around py-3 px-2 rounded-xl" style={{ backgroundColor: COLORS.surface }}>
          {quickStats.map((stat) => {
            const progress = Math.min((stat.current || 0) / (stat.target || 1), 1);
            const displayVal = stat.displayValue || Math.round(progress * 100) + '%';
            return (
              <button
                key={stat.id}
                onClick={() => handleStatTap(stat.id)}
                className="flex flex-col items-center"
              >
                <div className="relative w-11 h-11 mb-1">
                  <svg className="w-full h-full transform -rotate-90">
                    <circle cx="22" cy="22" r="18" stroke={COLORS.surfaceLight} strokeWidth="3" fill="none" />
                    <circle
                      cx="22" cy="22" r="18"
                      stroke={stat.color || COLORS.primary}
                      strokeWidth="3"
                      fill="none"
                      strokeLinecap="round"
                      strokeDasharray={`${progress * 113} 113`}
                    />
                  </svg>
                  <div className="absolute inset-0 flex items-center justify-center">
                    <span className="text-xs font-bold" style={{ color: stat.color || COLORS.primary, fontSize: 9 }}>{displayVal}</span>
                  </div>
                </div>
                <span className="text-xs" style={{ color: COLORS.textMuted, fontSize: 9 }}>{stat.label}</span>
              </button>
            );
          })}
        </div>
      </div>

      {/* Streak Section - THIRD */}
      <div className="mx-4 mt-4">
        <p className="text-xs font-semibold mb-2" style={{ color: COLORS.textMuted }}>STREAKS</p>
      </div>
      <div className="mx-4 flex gap-2">
        <button onClick={() => setActiveTab('workouts')} className="flex-1 flex flex-col items-center p-3 rounded-xl" style={{ backgroundColor: COLORS.surface }}>
          <Dumbbell size={20} color={COLORS.warning} className="mb-1" />
          <span className="text-xs" style={{ color: COLORS.textMuted }}>Workouts</span>
          <span className="text-lg font-bold" style={{ color: COLORS.warning }}>{streaks?.weeklyWorkouts?.weeksCompleted || 0}</span>
        </button>
        <button onClick={() => { setActiveTab('nutrition'); setNutritionTab('overview'); }} className="flex-1 flex flex-col items-center p-3 rounded-xl" style={{ backgroundColor: COLORS.surface }}>
          <Flame size={20} color={COLORS.accent} className="mb-1" />
          <span className="text-xs" style={{ color: COLORS.textMuted }}>Calories</span>
          <span className="text-lg font-bold" style={{ color: COLORS.accent }}>{streaks?.calories?.daysInRow || 0}</span>
        </button>
        <button onClick={() => { setActiveTab('nutrition'); setNutritionTab('overview'); }} className="flex-1 flex flex-col items-center p-3 rounded-xl" style={{ backgroundColor: COLORS.surface }}>
          <Droplets size={20} color={COLORS.water} className="mb-1" />
          <span className="text-xs" style={{ color: COLORS.textMuted }}>Water</span>
          <span className="text-lg font-bold" style={{ color: COLORS.water }}>{streaks?.water?.daysInRow || 0}</span>
        </button>
        <button onClick={() => { setActiveTab('nutrition'); setNutritionTab('supplements'); }} className="flex-1 flex flex-col items-center p-3 rounded-xl" style={{ backgroundColor: COLORS.surface }}>
          <Zap size={20} color={COLORS.supplements} className="mb-1" />
          <span className="text-xs" style={{ color: COLORS.textMuted }}>Supps</span>
          <span className="text-lg font-bold" style={{ color: COLORS.supplements }}>{streaks?.supplements?.daysInRow || 0}</span>
        </button>
        <button onClick={() => { setActiveTab('nutrition'); setNutritionTab('sleep'); }} className="flex-1 flex flex-col items-center p-3 rounded-xl" style={{ backgroundColor: COLORS.surface }}>
          <Moon size={20} color={COLORS.sleep} className="mb-1" />
          <span className="text-xs" style={{ color: COLORS.textMuted }}>Sleep</span>
          <span className="text-lg font-bold" style={{ color: COLORS.sleep }}>{streaks?.sleep?.daysInRow || 0}</span>
        </button>
      </div>

      {/* Progress Charts with Tabs */}
      <div className="mx-4 mt-4">
        <p className="text-xs font-semibold mb-2" style={{ color: COLORS.textMuted }}>TRENDS</p>
      </div>
      <div className="mx-4 p-4 rounded-xl" style={{ backgroundColor: COLORS.surface }}>
        {/* Chart Selector and Time Frame */}
        <div className="flex items-center justify-between mb-3">
          {/* Chart Type Tabs */}
          <div className="flex flex-wrap gap-1.5">
            {[
              { id: 'weight', label: 'Weight', color: COLORS.primary },
              { id: 'calories', label: 'Cals', color: COLORS.accent },
              { id: 'protein', label: 'Protein', color: COLORS.protein || COLORS.primary },
              { id: 'water', label: 'Water', color: COLORS.water },
              { id: 'sleep', label: 'Sleep', color: COLORS.sleep },
            ].map(tab => (
              <button
                key={tab.id}
                onClick={() => setSelectedChart(tab.id)}
                className="px-2.5 py-1 rounded-lg text-xs font-semibold transition-all"
                style={{
                  backgroundColor: selectedChart === tab.id ? tab.color + '20' : 'transparent',
                  color: selectedChart === tab.id ? tab.color : COLORS.textMuted,
                  border: `1px solid ${selectedChart === tab.id ? tab.color : 'transparent'}`
                }}
              >
                {tab.label}
              </button>
            ))}
          </div>
          {/* Time Frame Toggle */}
          <div className="flex gap-1">
            {[
              { id: '7d', label: '7D' },
              { id: '30d', label: '30D' },
              { id: '90d', label: '90D' },
              { id: 'all', label: 'All' },
            ].map(tf => (
              <button
                key={tf.id}
                onClick={() => setChartTimeFrame(tf.id)}
                className="px-1.5 py-0.5 rounded text-xs"
                style={{
                  backgroundColor: chartTimeFrame === tf.id ? COLORS.primary : 'transparent',
                  color: chartTimeFrame === tf.id ? COLORS.text : COLORS.textMuted
                }}
              >
                {tf.label}
              </button>
            ))}
          </div>
        </div>

        {/* Helper to filter data by time frame */}
        {(() => {
          const getFilteredData = (data, timeFrame) => {
            if (!data || data.length === 0) return data;
            const weeksToShow = timeFrame === '7d' ? 1 : timeFrame === '30d' ? 4 : timeFrame === '90d' ? 13 : data.length;
            return data.slice(-weeksToShow);
          };

          const filteredWeightData = getFilteredData(chartData?.weight, chartTimeFrame);
          const filteredNutritionData = getFilteredData(weeklyNutrition, chartTimeFrame);
          const filteredSleepData = getFilteredData(sleepChartData, chartTimeFrame);

          return null;
        })()}

        {/* Weight Chart */}
        {selectedChart === 'weight' && (() => {
          const weeksToShow = chartTimeFrame === '7d' ? 1 : chartTimeFrame === '30d' ? 4 : chartTimeFrame === '90d' ? 13 : chartData?.weight?.length || 16;
          const filteredData = chartData?.weight?.slice(-weeksToShow) || [];
          return (
          <div style={{ height: 110 }}>
            {filteredData.length > 0 ? (
              <ResponsiveContainer width="100%" height="100%">
                <LineChart data={filteredData.map(d => ({ date: `W${d.week}`, actual: d.value, goal: d.expected }))}>
                  <XAxis dataKey="date" tick={{ fill: COLORS.textMuted, fontSize: 9 }} axisLine={false} tickLine={false} interval={Math.ceil(filteredData.length / 6)} />
                  <YAxis tick={{ fill: COLORS.textMuted, fontSize: 9 }} axisLine={false} tickLine={false} width={32} domain={['dataMin - 2', 'dataMax + 2']} tickFormatter={(v) => Math.round(v)} allowDecimals={false} />
                  <Tooltip
                    contentStyle={{ backgroundColor: COLORS.surface, border: `1px solid ${COLORS.surfaceLight}`, borderRadius: 8, padding: '6px 10px' }}
                    labelStyle={{ color: COLORS.text, fontSize: 11 }}
                    formatter={(value, name) => [value ? `${value}kg` : '-', name === 'actual' ? 'You' : 'Goal']}
                  />
                  <Line type="monotone" dataKey="actual" stroke={COLORS.primary} strokeWidth={2} dot={{ fill: COLORS.primary, r: 2 }} connectNulls />
                  <Line type="monotone" dataKey="goal" stroke={COLORS.textMuted} strokeWidth={1} strokeDasharray="4 4" dot={false} />
                </LineChart>
              </ResponsiveContainer>
            ) : (
              <div className="h-full flex items-center justify-center">
                <p className="text-xs" style={{ color: COLORS.textMuted }}>Log weight to see progress</p>
              </div>
            )}
          </div>
          );
        })()}

        {/* Calories Chart */}
        {selectedChart === 'calories' && (() => {
          const weeksToShow = chartTimeFrame === '7d' ? 1 : chartTimeFrame === '30d' ? 4 : chartTimeFrame === '90d' ? 13 : weeklyNutrition?.length || 16;
          const filteredData = weeklyNutrition?.slice(-weeksToShow) || [];
          return (
          <div style={{ height: 110 }}>
            {filteredData.length > 0 ? (
              <ResponsiveContainer width="100%" height="100%">
                <LineChart data={filteredData.map((d, i) => ({ ...d, week: `W${weeklyNutrition.length - filteredData.length + i + 1}`, actual: d.calories }))}>
                  <XAxis dataKey="week" tick={{ fill: COLORS.textMuted, fontSize: 9 }} axisLine={false} tickLine={false} interval={Math.ceil(filteredData.length / 6)} />
                  <YAxis tick={{ fill: COLORS.textMuted, fontSize: 9 }} axisLine={false} tickLine={false} width={32} domain={['dataMin - 200', 'dataMax + 200']} tickFormatter={(v) => Math.round(v)} allowDecimals={false} />
                  <Tooltip
                    contentStyle={{ backgroundColor: COLORS.surface, border: `1px solid ${COLORS.surfaceLight}`, borderRadius: 8, padding: '6px 10px' }}
                    labelStyle={{ color: COLORS.text, fontSize: 11 }}
                    formatter={(value, name) => [value ? `${value}` : '-', name === 'actual' ? 'You' : 'Goal']}
                  />
                  <Line type="monotone" dataKey="actual" stroke={COLORS.accent} strokeWidth={2} dot={{ fill: COLORS.accent, r: 2 }} />
                  <Line type="monotone" dataKey="goal" stroke={COLORS.textMuted} strokeWidth={1} strokeDasharray="4 4" dot={false} />
                </LineChart>
              </ResponsiveContainer>
            ) : (
              <div className="h-full flex items-center justify-center">
                <p className="text-xs" style={{ color: COLORS.textMuted }}>Log meals to see trends</p>
              </div>
            )}
          </div>
          );
        })()}

        {/* Protein Chart */}
        {selectedChart === 'protein' && (() => {
          const weeksToShow = chartTimeFrame === '7d' ? 1 : chartTimeFrame === '30d' ? 4 : chartTimeFrame === '90d' ? 13 : weeklyNutrition?.length || 16;
          const filteredData = weeklyNutrition?.slice(-weeksToShow) || [];
          return (
          <div style={{ height: 110 }}>
            {filteredData.length > 0 ? (
              <ResponsiveContainer width="100%" height="100%">
                <LineChart data={filteredData.map((d, i) => ({ week: `W${weeklyNutrition.length - filteredData.length + i + 1}`, actual: d.protein || 0, goal: d.proteinGoal || 150 }))}>
                  <XAxis dataKey="week" tick={{ fill: COLORS.textMuted, fontSize: 9 }} axisLine={false} tickLine={false} interval={Math.ceil(filteredData.length / 6)} />
                  <YAxis tick={{ fill: COLORS.textMuted, fontSize: 9 }} axisLine={false} tickLine={false} width={32} domain={[0, 'auto']} tickFormatter={(v) => Math.round(v)} allowDecimals={false} />
                  <Tooltip
                    contentStyle={{ backgroundColor: COLORS.surface, border: `1px solid ${COLORS.surfaceLight}`, borderRadius: 8, padding: '6px 10px' }}
                    labelStyle={{ color: COLORS.text, fontSize: 11 }}
                    formatter={(value, name) => [value ? `${value}g` : '-', name === 'actual' ? 'You' : 'Goal']}
                  />
                  <Line type="monotone" dataKey="actual" stroke={COLORS.protein || COLORS.primary} strokeWidth={2} dot={{ fill: COLORS.protein || COLORS.primary, r: 2 }} />
                  <Line type="monotone" dataKey="goal" stroke={COLORS.textMuted} strokeWidth={1} strokeDasharray="4 4" dot={false} />
                </LineChart>
              </ResponsiveContainer>
            ) : (
              <div className="h-full flex items-center justify-center">
                <p className="text-xs" style={{ color: COLORS.textMuted }}>Log meals to see protein trends</p>
              </div>
            )}
          </div>
          );
        })()}

        {/* Water Chart */}
        {selectedChart === 'water' && (() => {
          const weeksToShow = chartTimeFrame === '7d' ? 1 : chartTimeFrame === '30d' ? 4 : chartTimeFrame === '90d' ? 13 : weeklyNutrition?.length || 16;
          const filteredData = weeklyNutrition?.slice(-weeksToShow) || [];
          return (
          <div style={{ height: 110 }}>
            {filteredData.length > 0 ? (
              <ResponsiveContainer width="100%" height="100%">
                <LineChart data={filteredData.map((d, i) => ({ week: `W${weeklyNutrition.length - filteredData.length + i + 1}`, actual: d.water, goal: d.waterGoal }))}>
                  <XAxis dataKey="week" tick={{ fill: COLORS.textMuted, fontSize: 9 }} axisLine={false} tickLine={false} interval={Math.ceil(filteredData.length / 6)} />
                  <YAxis tick={{ fill: COLORS.textMuted, fontSize: 9 }} axisLine={false} tickLine={false} width={32} domain={['dataMin - 500', 'dataMax + 500']} tickFormatter={(v) => `${(v/1000).toFixed(1)}`} />
                  <Tooltip
                    contentStyle={{ backgroundColor: COLORS.surface, border: `1px solid ${COLORS.surfaceLight}`, borderRadius: 8, padding: '6px 10px' }}
                    labelStyle={{ color: COLORS.text, fontSize: 11 }}
                    formatter={(value, name) => [value ? `${(value/1000).toFixed(1)}L` : '-', name === 'actual' ? 'You' : 'Goal']}
                  />
                  <Line type="monotone" dataKey="actual" stroke={COLORS.water} strokeWidth={2} dot={{ fill: COLORS.water, r: 2 }} />
                  <Line type="monotone" dataKey="goal" stroke={COLORS.textMuted} strokeWidth={1} strokeDasharray="4 4" dot={false} />
                </LineChart>
              </ResponsiveContainer>
            ) : (
              <div className="h-full flex items-center justify-center">
                <p className="text-xs" style={{ color: COLORS.textMuted }}>Log water to see trends</p>
              </div>
            )}
          </div>
          );
        })()}

        {/* Sleep Chart */}
        {selectedChart === 'sleep' && (
          <div style={{ height: 110 }}>
            {sleepChartData?.length > 0 ? (() => {
              // Group sleep data by week and calculate weekly averages
              const daysToShow = chartTimeFrame === '7d' ? 7 : chartTimeFrame === '30d' ? 28 : chartTimeFrame === '90d' ? 90 : sleepChartData.length;
              const weeklySleepData = [];
              const data = sleepChartData.slice(-daysToShow);
              for (let i = 0; i < data.length; i += 7) {
                const weekData = data.slice(i, i + 7);
                const avgHours = weekData.reduce((sum, d) => sum + (d.hours || 0), 0) / weekData.length;
                weeklySleepData.push({ week: `W${weeklySleepData.length + 1}`, actual: parseFloat(avgHours.toFixed(1)), goal: 8 });
              }
              return (
                <ResponsiveContainer width="100%" height="100%">
                  <LineChart data={weeklySleepData}>
                    <XAxis dataKey="week" tick={{ fill: COLORS.textMuted, fontSize: 9 }} axisLine={false} tickLine={false} interval={Math.ceil(weeklySleepData.length / 6)} />
                    <YAxis tick={{ fill: COLORS.textMuted, fontSize: 9 }} axisLine={false} tickLine={false} width={24} domain={[4, 10]} tickFormatter={(v) => Math.round(v)} allowDecimals={false} />
                    <Tooltip
                      contentStyle={{ backgroundColor: COLORS.surface, border: `1px solid ${COLORS.surfaceLight}`, borderRadius: 8, padding: '6px 10px' }}
                      labelStyle={{ color: COLORS.text, fontSize: 11 }}
                      formatter={(value, name) => [value ? `${value}h` : '-', name === 'actual' ? 'You' : 'Goal']}
                    />
                    <Line type="monotone" dataKey="actual" stroke={COLORS.sleep} strokeWidth={2} dot={{ fill: COLORS.sleep, r: 2 }} />
                    <Line type="monotone" dataKey="goal" stroke={COLORS.textMuted} strokeWidth={1} strokeDasharray="4 4" dot={false} />
                  </LineChart>
                </ResponsiveContainer>
              );
            })() : (
              <div className="h-full flex items-center justify-center">
                <p className="text-xs" style={{ color: COLORS.textMuted }}>Log sleep to see trends</p>
              </div>
            )}
          </div>
        )}

        {/* Chart Legend */}
        <div className="flex justify-center gap-4 mt-3 pt-2" style={{ borderTop: `1px solid ${COLORS.surfaceLight}` }}>
          <div className="flex items-center gap-1">
            <div className="w-3 h-0.5" style={{ backgroundColor: selectedChart === 'weight' ? COLORS.primary : selectedChart === 'calories' ? COLORS.accent : COLORS.water }} />
            <span className="text-xs" style={{ color: COLORS.textMuted }}>Actual</span>
          </div>
          <div className="flex items-center gap-1">
            <div className="w-3 h-0.5" style={{ backgroundColor: COLORS.textMuted, borderStyle: 'dashed' }} />
            <span className="text-xs" style={{ color: COLORS.textMuted }}>Goal</span>
          </div>
        </div>
      </div>

      {/* Community Section - Trending Workouts Carousel */}
      <div className="mx-4 mt-4">
        <div className="flex justify-between items-center mb-2">
          <p className="text-xs font-semibold" style={{ color: COLORS.textMuted }}>TRENDING WORKOUTS</p>
          <button
            onClick={() => { setActiveTab('friends'); setFriendsTab('community_workouts'); }}
            className="text-xs"
            style={{ color: COLORS.primary }}
          >
            View All
          </button>
        </div>
      </div>
      {/* Horizontal Scrollable Carousel */}
      {communityWorkouts.length > 0 && (
        <div
          className="flex gap-3 overflow-x-auto pb-2 px-4 scrollbar-hide"
          style={{ scrollSnapType: 'x mandatory', WebkitOverflowScrolling: 'touch' }}
        >
          {communityWorkouts.slice(0, 5).map((workout, idx) => {
            const creator = workout?.creator;
            const creatorProfile = creator ? {
              id: creator.id,
              name: creator.name,
              username: creator.username,
              avatar: creator.avatar,
            } : null;

            const isExpanded = expandedTrendingWorkoutId === workout.id;
            return (
              <button
                key={workout.id || idx}
                onClick={() => toggleTrendingWorkoutWithScroll(workout.id)}
                className="flex-shrink-0 p-4 rounded-xl text-left"
                style={{
                  backgroundColor: isExpanded ? COLORS.primary + '25' : COLORS.primary + '15',
                  border: `1px solid ${isExpanded ? COLORS.primary : COLORS.primary + '30'}`,
                  width: '280px',
                  scrollSnapAlign: 'start',
                }}
              >
                {/* Workout Name */}
                <div className="flex items-center gap-2 mb-3">
                  <div className="w-8 h-8 rounded-lg flex items-center justify-center" style={{ backgroundColor: COLORS.primary + '30' }}>
                    <Dumbbell size={16} color={COLORS.primary} />
                  </div>
                  <div className="flex-1 min-w-0">
                    <p className="font-bold text-sm truncate" style={{ color: COLORS.text }}>{workout.name}</p>
                    {workout.focus && (
                      <p className="text-xs truncate" style={{ color: COLORS.textMuted }}>{workout.focus}</p>
                    )}
                  </div>
                  <ChevronDown
                    size={16}
                    color={COLORS.primary}
                    style={{ transform: isExpanded ? 'rotate(180deg)' : 'rotate(0deg)', transition: 'transform 0.2s' }}
                  />
                </div>

                {/* Publisher Info */}
                {creatorProfile && (
                  <div
                    onClick={(e) => { e.stopPropagation(); setShowFriendProfile(creatorProfile); }}
                    className="flex items-center gap-2 mb-3 p-2 rounded-lg w-full text-left hover:opacity-80 cursor-pointer"
                    style={{ backgroundColor: COLORS.surface }}
                  >
                    <div
                      className="w-7 h-7 rounded-full flex items-center justify-center text-xs font-bold"
                      style={{ backgroundColor: COLORS.primary + '30', color: COLORS.primary }}
                    >
                      {typeof creator.avatar === 'string' && creator.avatar.length === 1 ? creator.avatar : creator.name?.[0]?.toUpperCase() || '?'}
                    </div>
                    <div className="flex-1 min-w-0">
                      <p className="text-xs font-medium truncate" style={{ color: COLORS.text }}>{creator.name}</p>
                      <p className="text-xs" style={{ color: COLORS.textMuted }}>@{creator.username}  {creator.followers || 0} followers</p>
                    </div>
                  </div>
                )}

                {/* Stats Row */}
                <div className="flex items-center justify-between mb-3">
                  <div className="flex items-center gap-3 text-xs" style={{ color: COLORS.textMuted }}>
                    <span className="flex items-center gap-1">
                      <Clock size={12} />
                      {workout.target_duration || estimateWorkoutDuration(workout.exercises)}min
                    </span>
                    <span className="flex items-center gap-1">
                      <Star size={12} color={COLORS.warning} fill={COLORS.warning} />
                      {(workout.averageRating || 0).toFixed(1)}
                    </span>
                    <span className="flex items-center gap-1">
                      <Users size={12} />
                      {workout.completionCount || 0}
                    </span>
                  </div>
                </div>

                {/* Action Buttons */}
                <div className="flex items-center gap-2">
                  <div
                    onClick={(e) => {
                      e.stopPropagation();
                      openCommentsWithScroll(workout.id);
                    }}
                    className="flex-1 flex items-center justify-center gap-1.5 py-2 rounded-lg cursor-pointer"
                    style={{ backgroundColor: COLORS.surface }}
                  >
                    <MessageCircle size={14} color={COLORS.textMuted} />
                    <span className="text-xs" style={{ color: COLORS.textMuted }}>
                      {workout.comment_count || 0} comments
                    </span>
                  </div>
                  <div className="flex items-center gap-1 text-xs" style={{ color: COLORS.primary }}>
                    <span className="font-semibold">View</span>
                    <ChevronDown size={14} style={{ transform: isExpanded ? 'rotate(180deg)' : 'rotate(0deg)', transition: 'transform 0.2s' }} />
                  </div>
                </div>
              </button>
            );
          })}
        </div>
      )}

      {/* Expanded Trending Workout Details */}
      {expandedTrendingWorkoutId && (() => {
        const workout = communityWorkouts.find(w => w.id === expandedTrendingWorkoutId);
        if (!workout) return null;
        const style = getWorkoutStyle(workout.focus);
        const timing = getWorkoutTimeBreakdown(workout.exercises || []);
        const activeMins = Math.round(timing.workingTime / 60);
        const restMins = Math.round(timing.restTime / 60);
        const warmupMins = Math.round(WORKOUT_TIMING.WARMUP_TIME / 60);
        const cooldownMins = Math.round(WORKOUT_TIMING.COOLDOWN_TIME / 60);
        const warmupCooldownState = workoutWarmupCooldown[workout.id] || {};
        const hasWarmup = warmupCooldownState.warmup ?? true;
        const hasCooldown = warmupCooldownState.cooldown ?? true;
        const workoutMins = activeMins + restMins + (hasWarmup ? warmupMins : 0) + (hasCooldown ? cooldownMins : 0);
        const targetDuration = workout.target_duration || estimateWorkoutDuration(workout.exercises);
        return (
          <div className="mx-4 mt-3 rounded-xl overflow-hidden" style={{ backgroundColor: COLORS.surface }}>
            {/* Time Breakdown */}
            <div className="grid grid-cols-4 gap-2 p-4">
              <div className="text-center p-2 rounded-lg" style={{ backgroundColor: COLORS.success + '15' }}>
                <p className="font-bold text-sm" style={{ color: COLORS.success }}>{activeMins}min</p>
                <p className="text-xs" style={{ color: COLORS.textMuted }}>Active</p>
              </div>
              <div className="text-center p-2 rounded-lg" style={{ backgroundColor: COLORS.warning + '15' }}>
                <p className="font-bold text-sm" style={{ color: COLORS.warning }}>{restMins}min</p>
                <p className="text-xs" style={{ color: COLORS.textMuted }}>Rest</p>
              </div>
              <div className="text-center p-2 rounded-lg" style={{ backgroundColor: COLORS.primary + '15' }}>
                <p className="font-bold text-sm" style={{ color: COLORS.primary }}>{hasWarmup ? warmupMins : 0}+{hasCooldown ? cooldownMins : 0}min</p>
                <p className="text-xs" style={{ color: COLORS.textMuted }}>Warm/Cool</p>
              </div>
              <div className="text-center p-2 rounded-lg" style={{ backgroundColor: COLORS.surfaceLight }}>
                <p className="font-bold text-sm" style={{ color: COLORS.text }}>{workoutMins}min</p>
                <p className="text-xs" style={{ color: COLORS.textMuted }}>Total</p>
              </div>
            </div>

            {/* Warmup/Cooldown Toggles */}
            <div className="flex items-center gap-3 px-4 pb-3">
              <button
                onClick={() => toggleWarmupCooldownHomeTab(workout.id, 'warmup')}
                className="flex items-center gap-2 px-3 py-1.5 rounded-lg text-xs font-semibold"
                style={{
                  backgroundColor: hasWarmup ? COLORS.primary + '20' : COLORS.surfaceLight,
                  color: hasWarmup ? COLORS.primary : COLORS.textMuted
                }}
              >
                <Wind size={12} />
                Warmup {warmupMins}min
                {hasWarmup ? <Check size={12} /> : null}
              </button>
              <button
                onClick={() => toggleWarmupCooldownHomeTab(workout.id, 'cooldown')}
                className="flex items-center gap-2 px-3 py-1.5 rounded-lg text-xs font-semibold"
                style={{
                  backgroundColor: hasCooldown ? COLORS.primary + '20' : COLORS.surfaceLight,
                  color: hasCooldown ? COLORS.primary : COLORS.textMuted
                }}
              >
                <Sprout size={12} />
                Cooldown {cooldownMins}min
                {hasCooldown ? <Check size={12} /> : null}
              </button>
            </div>

            {/* Description */}
            {workout.description && (
              <p className="text-sm px-4 pb-3" style={{ color: COLORS.textSecondary }}>{workout.description}</p>
            )}

            {/* Exercises List */}
            <div className="px-4 pb-4 space-y-2">
              {/* Warmup Item */}
              {hasWarmup && (
                <div className="p-3 rounded-lg flex items-center gap-3" style={{ backgroundColor: COLORS.primary + '15', border: `1px dashed ${COLORS.primary}40` }}>
                  <div className="w-8 h-8 rounded-full flex items-center justify-center" style={{ backgroundColor: COLORS.primary + '30' }}>
                    <Wind size={14} color={COLORS.primary} />
                  </div>
                  <div className="flex-1">
                    <p className="font-semibold text-sm" style={{ color: COLORS.primary }}>Warmup</p>
                    <p className="text-xs" style={{ color: COLORS.textMuted }}>Light cardio & dynamic stretches</p>
                  </div>
                  <p className="font-semibold text-sm" style={{ color: COLORS.primary }}>{warmupMins}min</p>
                </div>
              )}

              {(workout.exercises || []).map((exercise, i) => {
                const sets = exercise.sets || 3;
                const restTime = exercise.restTime || 90;
                return (
                  <div
                    key={exercise.id || i}
                    className="p-3 rounded-lg flex items-center gap-3"
                    style={{ backgroundColor: COLORS.surfaceLight }}
                  >
                    <div className="w-8 h-8 rounded-full flex items-center justify-center" style={{ backgroundColor: style.color + '20' }}>
                      <span className="font-bold text-sm" style={{ color: style.color }}>{i + 1}</span>
                    </div>
                    <div className="flex-1">
                      <div className="flex items-center gap-1">
                        <p className="font-semibold text-sm" style={{ color: COLORS.text }}>{exercise.name}</p>
                        <button
                          onClick={(e) => { e.stopPropagation(); setShowExerciseInfo(exercise.name); }}
                          className="p-0.5 rounded-full"
                          style={{ backgroundColor: COLORS.primary + '20' }}
                        >
                          <Info size={12} color={COLORS.primary} />
                        </button>
                      </div>
                      <p className="text-xs" style={{ color: COLORS.textMuted }}>
                        {exercise.muscleGroup}
                      </p>
                    </div>
                    <div className="text-right">
                      <p className="font-semibold text-sm" style={{ color: COLORS.text }}>
                        {exercise.sets} x {exercise.targetReps || exercise.reps}
                      </p>
                      {sets > 1 && (
                        <p className="text-xs" style={{ color: COLORS.warning }}>{restTime}s rest</p>
                      )}
                    </div>
                  </div>
                );
              })}

              {/* Cooldown Item */}
              {hasCooldown && (
                <div className="p-3 rounded-lg flex items-center gap-3" style={{ backgroundColor: COLORS.primary + '15', border: `1px dashed ${COLORS.primary}40` }}>
                  <div className="w-8 h-8 rounded-full flex items-center justify-center" style={{ backgroundColor: COLORS.primary + '30' }}>
                    <Sprout size={14} color={COLORS.primary} />
                  </div>
                  <div className="flex-1">
                    <p className="font-semibold text-sm" style={{ color: COLORS.primary }}>Cooldown</p>
                    <p className="text-xs" style={{ color: COLORS.textMuted }}>Static stretches & recovery</p>
                  </div>
                  <p className="font-semibold text-sm" style={{ color: COLORS.primary }}>{cooldownMins}min</p>
                </div>
              )}
            </div>

            {/* Action Buttons */}
            <div className="p-4 pt-0 space-y-2">
              <button
                onClick={() => {
                  const adjusted = adjustWorkoutForUser(workout);
                  setTodayWorkout({
                    type: adjusted.name,
                    name: adjusted.name,
                    focus: adjusted.focus,
                    exercises: adjusted.exercises?.length || 0,
                    duration: targetDuration,
                    communityWorkoutId: workout.id,
                  });
                  setExpandedTrendingWorkoutId(null);
                  setActiveTab('workouts');
                }}
                className="w-full py-3 rounded-xl font-semibold flex items-center justify-center gap-2"
                style={{ backgroundColor: COLORS.primary, color: COLORS.text }}
              >
                <Play size={18} /> Start Workout
              </button>
              <button
                onClick={() => {
                  handleSaveWorkout(workout.id);
                }}
                className="w-full py-2 rounded-xl font-semibold text-sm flex items-center justify-center gap-2"
                style={{
                  backgroundColor: savedWorkoutIds.has(workout.id) ? COLORS.warning + '20' : COLORS.surfaceLight,
                  color: savedWorkoutIds.has(workout.id) ? COLORS.warning : COLORS.textSecondary
                }}
              >
                <Book size={16} fill={savedWorkoutIds.has(workout.id) ? COLORS.warning : 'transparent'} />
                {savedWorkoutIds.has(workout.id) ? 'Saved to Rep-ertoire' : 'Save to Rep-ertoire'}
              </button>
            </div>
          </div>
        );
      })()}

      <div className="mx-4 mt-3 space-y-3">

        {/* Friends Activity Feed */}
        <div className="p-4 rounded-xl" style={{ backgroundColor: COLORS.surface }}>
          <div className="flex justify-between items-center mb-3">
            <p className="font-semibold text-sm" style={{ color: COLORS.text }}>Friends Activity</p>
            <button onClick={() => { setActiveTab('friends'); setFriendsTab('feed'); }} className="text-xs" style={{ color: COLORS.primary }}>
              View All
            </button>
          </div>

          {/* Show recent activity from followed users */}
          {activityFeed.length > 0 ? (
            <div className="space-y-3">
              {activityFeed.slice(0, 5).map((activity, i) => {
                const friendName = activity.friend
                  ? `${activity.friend.first_name || ''} ${activity.friend.last_name || ''}`.trim() || activity.friend.username || 'User'
                  : 'User';
                const friendAvatar = activity.friend?.avatar_url || activity.friend?.first_name?.[0]?.toUpperCase() || 'U';
                const isExpanded = expandedHomeActivity === activity.id;

                const handleExpandWorkout = async () => {
                  if (isExpanded) {
                    setExpandedHomeActivity(null);
                    return;
                  }
                  setExpandedHomeActivity(activity.id);
                  // Fetch workout sets if not already loaded
                  if (!expandedActivitySets[activity.id]) {
                    try {
                      const { data } = await supabase
                        .from('workout_sets')
                        .select('*')
                        .eq('session_id', activity.id)
                        .order('exercise_name', { ascending: true })
                        .order('set_number', { ascending: true });
                      setExpandedActivitySets(prev => ({ ...prev, [activity.id]: data || [] }));
                    } catch (err) {
                      console.warn('Error loading workout sets:', err);
                    }
                  }
                };

                const friendProfile = {
                  id: activity.friendId,
                  name: friendName,
                  username: activity.friend?.username || 'user',
                  avatar: friendAvatar,
                  bio: activity.friend?.bio || '',
                };

                return (
                  <div key={activity.id || i} className="rounded-lg overflow-hidden" style={{ backgroundColor: COLORS.surfaceLight }}>
                    {/* Header - clickable to expand */}
                    <button
                      onClick={handleExpandWorkout}
                      className="w-full flex items-center gap-3 p-3"
                    >
                      {/* Avatar - clickable to profile */}
                      <div
                        onClick={(e) => { e.stopPropagation(); setShowFriendProfile(friendProfile); }}
                        className="w-10 h-10 rounded-full flex items-center justify-center text-sm font-bold cursor-pointer hover:opacity-80"
                        style={{ backgroundColor: COLORS.primary + '30', color: COLORS.primary }}
                      >
                        {friendAvatar}
                      </div>
                      <div className="flex-1 min-w-0 text-left">
                        <p className="text-sm" style={{ color: COLORS.text }}>
                          <span
                            onClick={(e) => { e.stopPropagation(); setShowFriendProfile(friendProfile); }}
                            className="font-semibold hover:underline cursor-pointer"
                          >
                            {friendName.split(' ')[0]}
                          </span>
                          {' '}{activity.type === 'workout' ? 'completed' : activity.type === 'pr' ? 'hit a PR' : 'is active'}
                        </p>
                        <p className="text-xs" style={{ color: COLORS.textMuted }}>
                          @{friendProfile.username} {activity.time && ` ${activity.time}`}
                        </p>
                        {(activity.workoutName || activity.exercise) && (
                          <p className="text-xs font-medium" style={{ color: COLORS.primary }}>
                            {activity.workoutName || activity.exercise}
                          </p>
                        )}
                      </div>
                      <div className="flex items-center gap-2">
                        {activity.type === 'pr' && <Trophy size={16} color={COLORS.warning} />}
                        {activity.type === 'workout' && <Check size={16} color={COLORS.success} />}
                        <ChevronDown
                          size={16}
                          color={COLORS.textMuted}
                          style={{ transform: isExpanded ? 'rotate(180deg)' : 'rotate(0deg)', transition: 'transform 0.2s' }}
                        />
                      </div>
                    </button>

                    {/* Expanded workout details */}
                    {isExpanded && activity.type === 'workout' && (
                      <div className="px-3 pb-3 border-t" style={{ borderColor: COLORS.surface }}>
                        {!expandedActivitySets[activity.id] ? (
                          <div className="py-4 text-center">
                            <div className="animate-spin w-5 h-5 border-2 rounded-full mx-auto" style={{ borderColor: COLORS.primary, borderTopColor: 'transparent' }} />
                          </div>
                        ) : expandedActivitySets[activity.id].length === 0 ? (
                          <p className="py-3 text-sm text-center" style={{ color: COLORS.textMuted }}>No exercise data recorded</p>
                        ) : (
                          <div className="pt-3 space-y-3">
                            {/* Group sets by exercise */}
                            {Object.entries(
                              expandedActivitySets[activity.id].reduce((acc, set) => {
                                const name = set.exercise_name || 'Unknown';
                                if (!acc[name]) acc[name] = [];
                                acc[name].push(set);
                                return acc;
                              }, {})
                            ).map(([exerciseName, sets]) => (
                              <div key={exerciseName}>
                                <p className="text-sm font-semibold mb-2" style={{ color: COLORS.text }}>{exerciseName}</p>
                                <div className="space-y-1">
                                  {sets.map((set, idx) => (
                                    <div key={set.id || idx} className="flex items-center justify-between text-xs px-2 py-1 rounded" style={{ backgroundColor: COLORS.surface }}>
                                      <span style={{ color: COLORS.textMuted }}>
                                        {set.is_warmup ? 'Warmup' : `Set ${set.set_number}`}
                                      </span>
                                      <span style={{ color: COLORS.text }}>
                                        {set.weight}kg  {set.reps} reps
                                        {set.rpe && <span style={{ color: COLORS.textMuted }}> @ RPE {set.rpe}</span>}
                                      </span>
                                    </div>
                                  ))}
                                </div>
                              </div>
                            ))}
                            {activity.duration && (
                              <div className="flex items-center gap-2 pt-2 text-xs" style={{ color: COLORS.textMuted }}>
                                <Clock size={12} />
                                <span>{activity.duration} min workout</span>
                              </div>
                            )}
                          </div>
                        )}
                      </div>
                    )}

                    {/* Like and Comment buttons */}
                    <div className="flex items-center gap-4 px-3 pb-3 border-t pt-2" style={{ borderColor: COLORS.surface }}>
                      <button
                        onClick={() => handleHomeActivityLike(activity.id, activity.friendId)}
                        className="flex items-center gap-1.5"
                      >
                        <Heart
                          size={16}
                          color={userLikes[activity.id] ? COLORS.error : COLORS.textMuted}
                          fill={userLikes[activity.id] ? COLORS.error : 'none'}
                        />
                        <span className="text-xs" style={{ color: COLORS.textMuted }}>
                          {(activity.likes || 0) + (userLikes[activity.id] ? 1 : 0)}
                        </span>
                      </button>
                      <button
                        onClick={() => setShowCommentsModal(activity.id)}
                        className="flex items-center gap-1.5"
                      >
                        <MessageCircle size={16} color={COLORS.textMuted} />
                        <span className="text-xs" style={{ color: COLORS.textMuted }}>
                          {activityCommentCounts[activity.id] > 0 ? activityCommentCounts[activity.id] : 'Comment'}
                        </span>
                      </button>
                    </div>
                  </div>
                );
              })}
            </div>
          ) : friends.length > 0 ? (
            <div className="text-center py-4">
              <Activity size={32} color={COLORS.textMuted} className="mx-auto mb-2" style={{ opacity: 0.5 }} />
              <p className="text-sm" style={{ color: COLORS.textMuted }}>No recent activity from friends</p>
              <p className="text-xs" style={{ color: COLORS.textMuted }}>Check back later!</p>
            </div>
          ) : (
            <button
              onClick={() => setActiveTab('friends')}
              className="w-full flex items-center gap-3 py-2"
            >
              <div className="w-10 h-10 rounded-full flex items-center justify-center" style={{ backgroundColor: COLORS.primary + '20' }}>
                <UserPlus size={18} color={COLORS.primary} />
              </div>
              <div className="flex-1 text-left">
                <p className="text-sm font-semibold" style={{ color: COLORS.text }}>Find workout buddies</p>
                <p className="text-xs" style={{ color: COLORS.textMuted }}>Follow friends to see their activity</p>
              </div>
              <ChevronRight size={18} color={COLORS.primary} />
            </button>
          )}
        </div>
      </div>

      {/* Rep-ertoire (Saved Workouts) */}
      <div className="mx-4 mt-4">
        <div className="flex items-center justify-between mb-2">
          <p className="text-xs font-semibold" style={{ color: COLORS.textMuted }}>MY REP-ERTOIRE</p>
          {savedWorkoutIds.size > 0 && (
            <button
              onClick={() => { setActiveTab('friends'); setFriendsTab('community_workouts'); setShowRepertoire(true); }}
              className="text-xs"
              style={{ color: COLORS.primary }}
            >
              See All ({savedWorkoutIds.size})
            </button>
          )}
        </div>
        <div className="p-4 rounded-xl" style={{ backgroundColor: COLORS.surface }}>
          {savedWorkoutIds.size > 0 ? (
            <div className="flex items-center gap-3">
              <div className="w-12 h-12 rounded-xl flex items-center justify-center" style={{ backgroundColor: COLORS.primary + '20' }}>
                <Bookmark size={24} color={COLORS.primary} />
              </div>
              <div className="flex-1">
                <p className="text-sm font-semibold" style={{ color: COLORS.text }}>{savedWorkoutIds.size} Saved Workouts</p>
                <p className="text-xs" style={{ color: COLORS.textMuted }}>Ready for your next session</p>
              </div>
              <button
                onClick={() => { setActiveTab('friends'); setFriendsTab('community_workouts'); setShowRepertoire(true); }}
                className="px-3 py-2 rounded-lg text-xs font-semibold"
                style={{ backgroundColor: COLORS.primary, color: COLORS.text }}
              >
                Browse
              </button>
            </div>
          ) : (
            <div className="flex items-center gap-3">
              <div className="w-12 h-12 rounded-xl flex items-center justify-center" style={{ backgroundColor: COLORS.surfaceLight }}>
                <Bookmark size={24} color={COLORS.textMuted} />
              </div>
              <div className="flex-1">
                <p className="text-sm font-semibold" style={{ color: COLORS.text }}>No saved workouts yet</p>
                <p className="text-xs" style={{ color: COLORS.textMuted }}>Save workouts from the community</p>
              </div>
              <button
                onClick={() => { setActiveTab('friends'); setFriendsTab('community_workouts'); }}
                className="px-3 py-2 rounded-lg text-xs font-semibold"
                style={{ backgroundColor: COLORS.primary, color: COLORS.text }}
              >
                Discover
              </button>
            </div>
          )}
        </div>
      </div>

      {/* Weight Tracking */}
      <div className="mx-4 mt-4">
        <p className="text-xs font-semibold mb-2" style={{ color: COLORS.textMuted }}>WEIGHT TRACKING</p>
        <button
          onClick={() => setShowWeighIn(true)}
          className="w-full p-4 rounded-xl flex items-center justify-center gap-2 mb-4"
          style={{ backgroundColor: COLORS.primary }}
        >
          <Plus size={20} color={COLORS.text} />
          <span className="font-semibold" style={{ color: COLORS.text }}>Log Weigh-In</span>
        </button>
      </div>

      {/* Bottom padding */}
      <div className="h-8" />

      {/* Missed Day Nutrition Prompt */}
      {showMissedDayPrompt && missedDayData && (
        <MissedDayPromptModal
          COLORS={COLORS}
          missedDayData={missedDayData}
          nutritionGoals={nutritionGoals}
          onDismiss={() => {
            // Save dismissal to localStorage so we don't prompt again for this day
            localStorage.setItem('uprep_missed_day_dismissed', JSON.stringify(missedDayData.date));
            setMissedDayDismissed(missedDayData.date);
            setShowMissedDayPrompt(false);
          }}
          onLogMeal={async (mealData) => {
            if (!user?.id) return;
            try {
              // Log meal for yesterday
              const { data, error } = await nutritionService.logMeal(user.id, {
                date: missedDayData.date,
                name: mealData.name,
                time: mealData.time || '12:00',
                calories: mealData.calories,
                protein: mealData.protein || 0,
                carbs: mealData.carbs || 0,
                fats: mealData.fats || 0,
              });

              if (!error) {
                // Update recent nutrition history to reflect the new entry
                setRecentNutritionHistory(prev => {
                  const updated = [...prev];
                  const idx = updated.findIndex(d => d.log_date === missedDayData.date);
                  if (idx >= 0) {
                    updated[idx] = {
                      ...updated[idx],
                      total_calories: (updated[idx].total_calories || 0) + mealData.calories,
                      total_protein: (updated[idx].total_protein || 0) + (mealData.protein || 0),
                      total_carbs: (updated[idx].total_carbs || 0) + (mealData.carbs || 0),
                      total_fats: (updated[idx].total_fats || 0) + (mealData.fats || 0),
                    };
                  } else {
                    updated.push({
                      log_date: missedDayData.date,
                      total_calories: mealData.calories,
                      total_protein: mealData.protein || 0,
                      total_carbs: mealData.carbs || 0,
                      total_fats: mealData.fats || 0,
                      water_intake: 0,
                    });
                  }
                  return updated;
                });

                // Update missedDayData to show new totals
                setMissedDayData(prev => ({
                  ...prev,
                  calories: prev.calories + mealData.calories,
                }));
              }
            } catch (err) {
              console.warn('Error logging missed day meal:', err);
            }
          }}
          onLogWater={async (amount) => {
            if (!user?.id) return;
            try {
              // Log water for yesterday
              const { error } = await nutritionService.logWater(user.id, amount, missedDayData.date);

              if (!error) {
                // Update recent nutrition history
                setRecentNutritionHistory(prev => {
                  const updated = [...prev];
                  const idx = updated.findIndex(d => d.log_date === missedDayData.date);
                  if (idx >= 0) {
                    updated[idx] = {
                      ...updated[idx],
                      water_intake: (updated[idx].water_intake || 0) + amount,
                    };
                  } else {
                    updated.push({
                      log_date: missedDayData.date,
                      total_calories: 0,
                      total_protein: 0,
                      total_carbs: 0,
                      total_fats: 0,
                      water_intake: amount,
                    });
                  }
                  return updated;
                });

                // Update missedDayData
                setMissedDayData(prev => ({
                  ...prev,
                  water: prev.water + amount,
                }));
              }
            } catch (err) {
              console.warn('Error logging missed day water:', err);
            }
          }}
          onClose={() => setShowMissedDayPrompt(false)}
        />
      )}

      {/* Active Workout Screen */}
      {showActiveWorkout && (() => {
        // Check if resuming a partial workout
        if (partialWorkoutProgress) {
          return (
            <ActiveWorkoutScreen
              onClose={() => setShowActiveWorkout(false)}
              onComplete={() => { setPartialWorkoutProgress(null); completeTodayWorkout(); }}
              onSaveProgress={setPartialWorkoutProgress}
              COLORS={COLORS}
              availableTime={workoutTime}
              userGoal={userData.goal || 'build_muscle'}
              userExperience={userData.experience || 'beginner'}
              userId={user?.id}
              workoutName={partialWorkoutProgress.workoutName || todayWorkout?.name || 'Workout'}
              workoutTemplate={{ exercises: partialWorkoutProgress.exercises }}
              injuries={injuries}
              includeWarmup={personalWarmup}
              includeCooldown={personalCooldown}
              savedProgress={partialWorkoutProgress}
            />
          );
        }

        // Get exercises exactly as shown in the workout card
        const filteredExercises = getCurrentExercises();
        const recoveryExercises = getInjuryRecoveryExercisesToAdd();
        const baseExercises = [...filteredExercises, ...recoveryExercises];
        const fullPool = todayWorkoutTemplate?.exercises || baseExercises;

        // Apply same time/count optimization as displayed
        const defaultExerciseCount = Math.max(2, Math.floor(workoutTime / 12));
        const exerciseCount = customExerciseCount || defaultExerciseCount;
        const workoutTypeForCoverage = todayWorkoutTemplate?.workoutType || todayWorkout?.type || null;
        const optimizedExercises = optimizeExercisesForTimeAndCount(baseExercises, fullPool, workoutTime, exerciseCount, workoutTypeForCoverage, settings.workout.corePosition, personalWarmup, personalCooldown, !!customizedExercises);

        const template = { ...todayWorkoutTemplate, exercises: optimizedExercises };
        return (
          <ActiveWorkoutScreen
            onClose={() => setShowActiveWorkout(false)}
            onComplete={() => { setPartialWorkoutProgress(null); completeTodayWorkout(); }}
            onSaveProgress={setPartialWorkoutProgress}
            COLORS={COLORS}
            availableTime={workoutTime}
            userGoal={userData.goal || 'build_muscle'}
            userExperience={userData.experience || 'beginner'}
            userId={user?.id}
            workoutName={todayWorkout?.name || 'Workout'}
            workoutTemplate={template}
            injuries={injuries}
            includeWarmup={personalWarmup}
            includeCooldown={personalCooldown}
          />
        );
      })()}
    </div>
  );
  };

// ProgressTab Component - extracted outside UpRepDemo to prevent re-creation on state changes
const ProgressTab = ({
  COLORS,
  userData,
  currentProgram,
  programProgress,
  masterSchedule,
  adjustedNutritionGoals,
  nutritionGoals,
  todayWorkoutCompleted,
  WORKOUT_TEMPLATES,
  caloriesIntake,
  proteinIntake,
  waterIntake,
  lastNightBedTime,
  lastNightWakeTime,
  streaks,
  dailyInsightsExpanded,
  setDailyInsightsExpanded,
  chartData,
  setShowWeighIn,
  getLocalDateString,
}) => (
          <div className="p-4 h-full overflow-auto">
            {/* Progress Overview */}
            <p className="text-xs font-semibold mb-3" style={{ color: COLORS.textMuted }}>OVERVIEW</p>
            <div className="grid grid-cols-2 gap-3 mb-6">
              <div className="p-4 rounded-xl" style={{ backgroundColor: COLORS.surface }}>
                <div className="flex items-center gap-2 mb-2">
                  <TrendingUp size={18} color={COLORS.primary} />
                  <span className="text-sm" style={{ color: COLORS.textMuted }}>Current</span>
                </div>
                <p className="text-2xl font-bold" style={{ color: COLORS.text }}>{userData.currentWeight || 80}kg</p>
                <p className="text-xs" style={{ color: COLORS.textMuted }}>
                  {userData.goal === 'lose_fat' ? 'Goal: ' : 'Target: '}{userData.goalWeight || 75}kg
                </p>
              </div>
              <div className="p-4 rounded-xl" style={{ backgroundColor: COLORS.surface }}>
                <div className="flex items-center gap-2 mb-2">
                  <Target size={18} color={COLORS.success} />
                  <span className="text-sm" style={{ color: COLORS.textMuted }}>Progress</span>
                </div>
                <p className="text-2xl font-bold" style={{ color: COLORS.success }}>
                  {(() => {
                    const start = parseFloat(userData.currentWeight) || 80;
                    const goal = parseFloat(userData.goalWeight) || 75;
                    const current = start; // Would be dynamic in real app
                    const totalChange = Math.abs(goal - start);
                    const currentChange = Math.abs(current - start);
                    return totalChange > 0 ? Math.round((currentChange / totalChange) * 100) : 0;
                  })()}%
                </p>
                <p className="text-xs" style={{ color: COLORS.textMuted }}>to goal</p>
              </div>
            </div>

            {/* Program Progress */}
            <p className="text-xs font-semibold mb-3" style={{ color: COLORS.textMuted }}>PROGRAM</p>
            <div className="p-4 rounded-xl mb-6" style={{ backgroundColor: COLORS.surface }}>
              <div className="flex items-center justify-between mb-3">
                <p className="font-semibold" style={{ color: COLORS.text }}>{currentProgram.name}</p>
                <span className="text-xs px-2 py-1 rounded-full" style={{ backgroundColor: programProgress.isComplete ? COLORS.success + '20' : COLORS.primary + '20', color: programProgress.isComplete ? COLORS.success : COLORS.primary }}>
                  {programProgress.isComplete ? 'Complete!' : `${Math.round(programProgress.progressPercent)}%`}
                </span>
              </div>

              <div className="mb-3">
                <div className="flex items-center gap-3">
                  <div className="flex-1 h-2 rounded-full" style={{ backgroundColor: COLORS.surfaceLight }}>
                    <div
                      className="h-full rounded-full"
                      style={{ backgroundColor: programProgress.isComplete ? COLORS.success : COLORS.primary, width: `${programProgress.progressPercent}%` }}
                    />
                  </div>
                </div>
              </div>

              <div className="grid grid-cols-4 gap-2">
                <div className="text-center">
                  <p className="text-lg font-bold" style={{ color: COLORS.success }}>{programProgress.completedWorkouts}</p>
                  <p className="text-xs" style={{ color: COLORS.textMuted }}>Done</p>
                </div>
                <div className="text-center">
                  <p className="text-lg font-bold" style={{ color: COLORS.warning }}>{programProgress.workoutsRemaining}</p>
                  <p className="text-xs" style={{ color: COLORS.textMuted }}>Left</p>
                </div>
                <div className="text-center">
                  <p className="text-lg font-bold" style={{ color: COLORS.primary }}>
                    {programProgress.currentWeek}/{programProgress.totalWeeks}
                  </p>
                  <p className="text-xs" style={{ color: COLORS.textMuted }}>Week</p>
                </div>
                <div className="text-center">
                  <p className="text-lg font-bold" style={{ color: COLORS.accent }}>{programProgress.weeksRemaining}</p>
                  <p className="text-xs" style={{ color: COLORS.textMuted }}>Wks left</p>
                </div>
              </div>

              {programProgress.isComplete && (
                <div className="mt-3 p-2 rounded-lg" style={{ backgroundColor: COLORS.success + '10' }}>
                  <p className="text-xs text-center" style={{ color: COLORS.success }}>
                    Congratulations! Check the Workouts tab to choose your next program.
                  </p>
                </div>
              )}
            </div>

            {/* Daily Insights */}
            {(() => {
              // Generate insights based on current data
              const generateInsights = () => {
                const insights = [];
                const warnings = [];
                const successes = [];

                // Get tomorrow's date
                const tomorrow = new Date();
                tomorrow.setDate(tomorrow.getDate() + 1);
                const tomorrowKey = getLocalDateString(tomorrow);
                const tomorrowSchedule = masterSchedule[tomorrowKey];
                const tomorrowWorkoutType = tomorrowSchedule?.workoutType;

                // Get today's date
                const todayKey = getLocalDateString();
                const todaySchedule = masterSchedule[todayKey];

                // Nutrition goals
                const calorieGoal = adjustedNutritionGoals?.calories || nutritionGoals?.calories || 2200;
                const proteinGoal = adjustedNutritionGoals?.protein || nutritionGoals?.protein || 150;
                const waterGoal = adjustedNutritionGoals?.water || nutritionGoals?.water || 2500;

                // Check workout progress
                if (todaySchedule?.workoutType && !todayWorkoutCompleted) {
                  const workoutName = WORKOUT_TEMPLATES?.[todaySchedule.workoutType]?.name || 'Today\'s workout';
                  warnings.push({
                    icon: Dumbbell,
                    color: COLORS.warning,
                    text: `${workoutName} is still waiting. Get it done today to stay on track.`
                  });
                } else if (todayWorkoutCompleted) {
                  successes.push({
                    icon: Check,
                    color: COLORS.success,
                    text: 'Workout completed. Great job staying consistent!'
                  });
                }

                // Check tomorrow's workout
                if (tomorrowWorkoutType) {
                  const tomorrowName = WORKOUT_TEMPLATES?.[tomorrowWorkoutType]?.name || 'Workout';
                  insights.push({
                    icon: Calendar,
                    color: COLORS.primary,
                    text: `Tomorrow: ${tomorrowName}. Plan your day around it.`
                  });
                } else if (tomorrowSchedule) {
                  insights.push({
                    icon: Moon,
                    color: COLORS.sleep,
                    text: 'Tomorrow is a rest day. Focus on recovery and nutrition.'
                  });
                }

                // Check calories
                const caloriePercent = (caloriesIntake / calorieGoal) * 100;
                if (caloriePercent < 70) {
                  const deficit = calorieGoal - caloriesIntake;
                  warnings.push({
                    icon: Flame,
                    color: COLORS.accent,
                    text: `You're ${Math.round(deficit)} cal under your goal. A protein-rich snack would help fuel recovery.`
                  });
                } else if (caloriePercent >= 90 && caloriePercent <= 110) {
                  successes.push({
                    icon: Flame,
                    color: COLORS.success,
                    text: 'Calories on track. Keep it up!'
                  });
                } else if (caloriePercent > 120) {
                  warnings.push({
                    icon: Flame,
                    color: COLORS.warning,
                    text: `Over calorie target by ${Math.round(caloriesIntake - calorieGoal)}. Consider a lighter dinner.`
                  });
                }

                // Check protein
                const proteinPercent = (proteinIntake / proteinGoal) * 100;
                if (proteinPercent < 60) {
                  const needed = proteinGoal - proteinIntake;
                  warnings.push({
                    icon: Target,
                    color: COLORS.protein || COLORS.primary,
                    text: `${Math.round(needed)}g protein to go. Add chicken, fish, or a shake to hit your target.`
                  });
                }

                // Check water
                const waterPercent = (waterIntake / waterGoal) * 100;
                if (waterPercent < 50) {
                  warnings.push({
                    icon: Droplets,
                    color: COLORS.water,
                    text: 'Water intake is low. Set a reminder to drink 500ml before your next meal.'
                  });
                } else if (waterPercent >= 80) {
                  successes.push({
                    icon: Droplets,
                    color: COLORS.success,
                    text: 'Good hydration today!'
                  });
                }

                // Check sleep (calculate from bed/wake times)
                const getSleepHours = () => {
                  try {
                    const bedTime = lastNightBedTime || '23:00';
                    const wakeTime = lastNightWakeTime || '07:00';
                    const [bedH, bedM] = bedTime.split(':').map(Number);
                    const [wakeH, wakeM] = wakeTime.split(':').map(Number);
                    let hours = wakeH - bedH + (wakeM - bedM) / 60;
                    if (hours < 0) hours += 24;
                    return hours;
                  } catch (e) {
                    return 7;
                  }
                };
                const currentSleepHours = getSleepHours();
                if (currentSleepHours > 0 && currentSleepHours < 7) {
                  insights.push({
                    icon: Moon,
                    color: COLORS.sleep,
                    text: `Only ${currentSleepHours.toFixed(1)}h sleep last night. Aim for 7-8h tonight for better recovery.`
                  });
                }

                // Check streaks at risk
                if (streaks?.calories?.daysInRow >= 3 && caloriePercent < 70) {
                  warnings.push({
                    icon: AlertCircle,
                    color: COLORS.error,
                    text: `${streaks.calories.daysInRow}-day calorie streak at risk. Don't let it break!`
                  });
                }

                return { insights, warnings, successes };
              };

              const { insights, warnings, successes } = generateInsights();
              const hasContent = insights.length > 0 || warnings.length > 0 || successes.length > 0;

              if (!hasContent) return null;

              const totalItems = successes.length + warnings.length + insights.length;
              const statusColor = warnings.length > 0 ? COLORS.warning : COLORS.success;

              return (
                <div className="mb-6">
                  <button
                    onClick={() => setDailyInsightsExpanded(!dailyInsightsExpanded)}
                    className="w-full p-4 rounded-xl flex items-center justify-between"
                    style={{ backgroundColor: COLORS.surface }}
                  >
                    <div className="flex items-center gap-3">
                      <div className="w-10 h-10 rounded-xl flex items-center justify-center" style={{ backgroundColor: statusColor + '20' }}>
                        <Sparkles size={20} color={statusColor} />
                      </div>
                      <div className="text-left">
                        <p className="font-semibold" style={{ color: COLORS.text }}>Daily Insights</p>
                        <p className="text-xs" style={{ color: COLORS.textMuted }}>
                          {warnings.length > 0 ? `${warnings.length} area${warnings.length > 1 ? 's' : ''} need attention` : 'All on track'}
                        </p>
                      </div>
                    </div>
                    <div className="flex items-center gap-2">
                      <span className="text-xs px-2 py-1 rounded-full" style={{ backgroundColor: statusColor + '20', color: statusColor }}>
                        {totalItems}
                      </span>
                      <ChevronDown
                        size={20}
                        color={COLORS.textMuted}
                        style={{ transform: dailyInsightsExpanded ? 'rotate(180deg)' : 'rotate(0deg)', transition: 'transform 0.2s' }}
                      />
                    </div>
                  </button>

                  {dailyInsightsExpanded && (
                    <div className="mt-2 p-4 rounded-xl" style={{ backgroundColor: COLORS.surface }}>
                      {/* Successes */}
                      {successes.map((item, idx) => (
                        <div key={`success-${idx}`} className="flex items-start gap-3 mb-3 last:mb-0">
                          <div className="w-8 h-8 rounded-full flex items-center justify-center flex-shrink-0" style={{ backgroundColor: item.color + '20' }}>
                            <item.icon size={16} color={item.color} />
                          </div>
                          <p className="text-sm flex-1 pt-1" style={{ color: COLORS.text }}>{item.text}</p>
                        </div>
                      ))}

                      {/* Warnings */}
                      {warnings.map((item, idx) => (
                        <div key={`warning-${idx}`} className="flex items-start gap-3 mb-3 last:mb-0">
                          <div className="w-8 h-8 rounded-full flex items-center justify-center flex-shrink-0" style={{ backgroundColor: item.color + '20' }}>
                            <item.icon size={16} color={item.color} />
                          </div>
                          <p className="text-sm flex-1 pt-1" style={{ color: COLORS.text }}>{item.text}</p>
                        </div>
                      ))}

                      {/* Tomorrow's Focus / General Insights */}
                      {insights.map((item, idx) => (
                        <div key={`insight-${idx}`} className="flex items-start gap-3 mb-3 last:mb-0">
                          <div className="w-8 h-8 rounded-full flex items-center justify-center flex-shrink-0" style={{ backgroundColor: item.color + '20' }}>
                            <item.icon size={16} color={item.color} />
                          </div>
                          <p className="text-sm flex-1 pt-1" style={{ color: COLORS.text }}>{item.text}</p>
                        </div>
                      ))}
                    </div>
                  )}
                </div>
              );
            })()}

            {/* Weight Chart */}
            <p className="text-xs font-semibold mb-3" style={{ color: COLORS.textMuted }}>WEIGHT TRACKING</p>
            <div className="p-4 rounded-xl mb-6" style={{ backgroundColor: COLORS.surface }}>
              <div className="flex items-center justify-end mb-3">
                <div className="flex gap-2">
                  {['1M', '3M', '6M', 'All'].map(period => (
                    <button
                      key={period}
                      className="px-2 py-1 rounded text-xs"
                      style={{ backgroundColor: period === '3M' ? COLORS.primary + '20' : 'transparent', color: period === '3M' ? COLORS.primary : COLORS.textMuted }}
                    >
                      {period}
                    </button>
                  ))}
                </div>
              </div>
              <div style={{ height: 160 }}>
                {chartData.weight.length > 0 ? (
                  <ResponsiveContainer width="100%" height="100%">
                    <LineChart data={chartData.weight.map(d => ({ date: `Week ${d.week}`, weight: d.value, expected: d.expected }))}>
                      <XAxis dataKey="date" tick={{ fill: COLORS.textMuted, fontSize: 10 }} axisLine={false} tickLine={false} />
                      <YAxis tick={{ fill: COLORS.textMuted, fontSize: 10 }} axisLine={false} tickLine={false} width={35} domain={['dataMin - 2', 'dataMax + 2']} />
                      <Tooltip
                        contentStyle={{ backgroundColor: COLORS.surface, border: 'none', borderRadius: 8 }}
                        labelStyle={{ color: COLORS.text }}
                        formatter={(value, name) => [value ? value + 'kg' : 'No data', name === 'weight' ? 'Actual' : 'Target']}
                      />
                      <Line type="monotone" dataKey="expected" stroke={COLORS.textMuted} strokeWidth={1} strokeDasharray="5 5" dot={false} />
                      <Line type="monotone" dataKey="weight" stroke={COLORS.primary} strokeWidth={2} dot={{ fill: COLORS.primary, r: 3 }} connectNulls />
                    </LineChart>
                  </ResponsiveContainer>
                ) : (
                  <div className="h-full flex items-center justify-center">
                    <div className="text-center">
                      <Scale size={32} color={COLORS.textMuted} className="mx-auto mb-2" />
                      <p className="text-sm" style={{ color: COLORS.textMuted }}>No weigh-in data yet</p>
                      <p className="text-xs mt-1" style={{ color: COLORS.textMuted }}>Log your first weigh-in to start tracking</p>
                    </div>
                  </div>
                )}
              </div>
              <div className="flex justify-center gap-4 mt-2">
                <div className="flex items-center gap-1">
                  <div className="w-3 h-0.5 rounded" style={{ backgroundColor: COLORS.primary }} />
                  <span className="text-xs" style={{ color: COLORS.textMuted }}>Actual</span>
                </div>
                <div className="flex items-center gap-1">
                  <div className="w-3 h-0.5 rounded" style={{ backgroundColor: COLORS.textMuted, borderStyle: 'dashed' }} />
                  <span className="text-xs" style={{ color: COLORS.textMuted }}>Target</span>
                </div>
              </div>
            </div>

            {/* Body Composition Chart */}
            <p className="text-xs font-semibold mb-3" style={{ color: COLORS.textMuted }}>BODY COMPOSITION</p>
            <div className="p-4 rounded-xl mb-6" style={{ backgroundColor: COLORS.surface }}>
              <div className="text-center py-8">
                <p className="text-sm" style={{ color: COLORS.textMuted }}>Track body fat and muscle mass</p>
                <p className="text-xs mt-1" style={{ color: COLORS.textMuted }}>Coming soon</p>
              </div>
            </div>

            {/* Current Stats */}
            <p className="text-xs font-semibold mb-3" style={{ color: COLORS.textMuted }}>MEASUREMENTS</p>
            <div className="p-4 rounded-xl mb-6" style={{ backgroundColor: COLORS.surface }}>
              <div className="space-y-3">
                <div className="flex justify-between items-center">
                  <div className="flex items-center gap-2">
                    <div className="w-8 h-8 rounded-lg flex items-center justify-center" style={{ backgroundColor: COLORS.primary + '20' }}>
                      <TrendingUp size={16} color={COLORS.primary} />
                    </div>
                    <span style={{ color: COLORS.textSecondary }}>Current Weight</span>
                  </div>
                  <div className="text-right">
                    <span className="font-bold" style={{ color: COLORS.text }}>{userData.currentWeight || '--'} kg</span>
                  </div>
                </div>
                <div className="flex justify-between items-center">
                  <div className="flex items-center gap-2">
                    <div className="w-8 h-8 rounded-lg flex items-center justify-center" style={{ backgroundColor: COLORS.accent + '20' }}>
                      <Target size={16} color={COLORS.accent} />
                    </div>
                    <span style={{ color: COLORS.textSecondary }}>Goal Weight</span>
                  </div>
                  <div className="text-right">
                    <span className="font-bold" style={{ color: COLORS.text }}>{userData.goalWeight || '--'} kg</span>
                  </div>
                </div>
                <div className="flex justify-between items-center">
                  <div className="flex items-center gap-2">
                    <div className="w-8 h-8 rounded-lg flex items-center justify-center" style={{ backgroundColor: COLORS.success + '20' }}>
                      <TrendingDown size={16} color={COLORS.success} />
                    </div>
                    <span style={{ color: COLORS.textSecondary }}>To Go</span>
                  </div>
                  <div className="text-right">
                    <span className="font-bold" style={{ color: COLORS.text }}>
                      {userData.currentWeight && userData.goalWeight
                        ? `${Math.abs(parseFloat(userData.currentWeight) - parseFloat(userData.goalWeight)).toFixed(1)} kg`
                        : '--'}
                    </span>
                  </div>
                </div>
              </div>
            </div>

            {/* Log New Weigh-In Button */}
            <button 
              onClick={() => setShowWeighIn(true)}
              className="w-full p-4 rounded-xl flex items-center justify-center gap-2 mb-4"
              style={{ backgroundColor: COLORS.primary }}
            >
              <Plus size={20} color={COLORS.text} />
              <span className="font-semibold" style={{ color: COLORS.text }}>Log Weigh-In</span>
            </button>

            {/* Weigh-In History */}
            <p className="text-xs font-semibold mb-3" style={{ color: COLORS.textMuted }}>WEIGH-IN HISTORY</p>
            <div className="p-4 rounded-xl text-center" style={{ backgroundColor: COLORS.surface }}>
              <p className="text-sm" style={{ color: COLORS.textMuted }}>
                Log your weigh-ins to track progress
              </p>
            </div>
          </div>

);

// WorkoutTab Component - extracted outside UpRepDemo to prevent re-creation on state changes
const WorkoutTab = ({
  COLORS,
  workoutTabScrollRef,
  handleWorkoutTabScroll,
  scheduleWeekOffset,
  setScheduleWeekOffset,
  getWeekHeaderText,
  setShowScheduleSettings,
  draggedDay,
  setDraggedDay,
  dragOverDay,
  setDragOverDay,
  currentWeekDates,
  overviewStats,
  setEditingScheduleDay,
  swapWorkoutDays,
  getWorkoutColor,
  isPaused,
  pauseReturnDate,
  setIsPaused,
  setPauseReturnDate,
  todayWorkout,
  setTodayWorkout,
  todayWorkoutCompleted,
  todayWorkoutTemplate,
  isRescheduled,
  originalWorkout,
  setIsRescheduled,
  setOriginalWorkout,
  workoutStats,
  setShowPausePlan,
  setShowReschedule,
  setShowWorkoutPreview,
  showWorkoutTimeEditor,
  setShowWorkoutTimeEditor,
  workoutTime,
  customExerciseCount,
  setCustomExerciseCount,
  updateWorkoutTimeWithScroll,
  getCurrentExercises,
  settings,
  personalWarmup,
  personalCooldown,
  setPersonalWarmup,
  setPersonalCooldown,
  customizedExercises,
  optimizeExercisesForTimeAndCount,
  getWorkoutTimeBreakdown,
  updateExerciseCountWithScroll,
  exerciseListCollapsed,
  toggleExerciseListWithScroll,
  resetCustomizations,
  expandedExerciseId,
  toggleExpandedExercise,
  moveExerciseInHome,
  showExerciseInfoWithScroll,
  userData,
  swapExercise,
  removeExercise,
  partialWorkoutProgress,
  setShowActiveWorkout,
  upcomingWorkouts,
  setShowExerciseLibrary,
  setShowWorkoutHistory,
  setShowPersonalRecords,
  setShowCustomWorkout,
  workoutHistory,
  setShowWorkoutSummary,
  personalRecords,
  setShowPRLeaderboard,
  loadPRLeaderboard,
  setShowExerciseDetail,
  currentProgram,
  programProgress,
  setShowProgramSelector,
  suggestedNextPrograms,
  selectedNextProgram,
  setSelectedNextProgram,
  selectedBreakDuration,
  setSelectedBreakDuration,
  BREAK_OPTIONS,
}) => (
          <div ref={workoutTabScrollRef} onScroll={handleWorkoutTabScroll} className="p-4 h-full overflow-auto">
            {/* Scrollable Week Schedule */}
            <p className="text-xs font-semibold mb-3" style={{ color: COLORS.textMuted }}>THIS WEEK</p>
            <div className="mb-6">
              <div className="flex items-center justify-between mb-3">
                <div className="flex items-center gap-1">
                  <button
                    onClick={() => setScheduleWeekOffset(prev => prev - 1)}
                    className="p-2 rounded-lg"
                    style={{ backgroundColor: COLORS.surface }}
                  >
                    <ChevronLeft size={18} color={COLORS.text} />
                  </button>
                </div>
                <h3 className="font-semibold" style={{ color: COLORS.text }}>{getWeekHeaderText(scheduleWeekOffset)}</h3>
                <div className="flex items-center gap-1">
                  <button
                    onClick={() => setScheduleWeekOffset(prev => prev + 1)}
                    className="p-2 rounded-lg"
                    style={{ backgroundColor: COLORS.surface }}
                  >
                    <ChevronRight size={18} color={COLORS.text} />
                  </button>
                  <button
                    onClick={() => setShowScheduleSettings(true)}
                    className="p-2 rounded-lg"
                    style={{ backgroundColor: COLORS.surface }}
                  >
                    <Settings size={18} color={COLORS.textMuted} />
                  </button>
                </div>
              </div>
              <div className="flex gap-2">
                {(() => {
                  // Drag handlers for week schedule (works for both workouts and rest days)
                  const handleDragStart = (day, isBeforeProgram) => {
                    if (day.isPast || isBeforeProgram) return;
                    setDraggedDay(day);
                  };
                  const handleDragOver = (day) => {
                    if (!draggedDay || day.dateKey === draggedDay.dateKey || day.isPast) return;
                    setDragOverDay(day);
                  };
                  const handleDragEnd = () => {
                    if (draggedDay && dragOverDay && draggedDay.dateKey !== dragOverDay.dateKey) {
                      swapWorkoutDays(draggedDay.dateKey, dragOverDay.dateKey);
                    }
                    setDraggedDay(null);
                    setDragOverDay(null);
                  };

                  return currentWeekDates.map((day, i) => {
                    const isBeforeProgram = overviewStats.programStartDate && day.dateKey < overviewStats.programStartDate;
                    const isMissed = day.isPast && day.workout && !day.completed && !isBeforeProgram;
                    // Past rest days are considered "completed" since there's nothing to do
                    const isPastRestDay = day.isPast && !day.workout && !isBeforeProgram;
                    const isEffectivelyCompleted = day.completed || isPastRestDay;
                    const isDragging = draggedDay?.dateKey === day.dateKey;
                    const isDragOver = dragOverDay?.dateKey === day.dateKey;
                    const canDrag = !day.isPast && !isBeforeProgram;

                    return (
                      <button
                        key={day.dateKey}
                        onClick={() => !isBeforeProgram && !draggedDay && setEditingScheduleDay(day)}
                        onPointerDown={() => handleDragStart(day, isBeforeProgram)}
                        onPointerEnter={() => draggedDay && handleDragOver(day)}
                        onPointerUp={handleDragEnd}
                        onPointerLeave={() => setDragOverDay(null)}
                        onPointerCancel={handleDragEnd}
                        className="flex-1 p-2 rounded-xl text-center"
                        style={{
                          backgroundColor: isEffectivelyCompleted ? COLORS.success + '15' : day.isToday ? COLORS.primary + '20' : isMissed ? COLORS.surface : COLORS.surface,
                          border: isEffectivelyCompleted ? `2px solid ${COLORS.success}` : day.isToday ? `2px solid ${COLORS.primary}` : isDragOver ? `2px solid ${COLORS.accent}` : '2px solid transparent',
                          opacity: isMissed ? 0.5 : 1,
                          transform: isDragging ? 'scale(1.08)' : 'scale(1)',
                          boxShadow: isDragging ? '0 4px 12px rgba(0,0,0,0.3)' : 'none',
                          cursor: isBeforeProgram ? 'default' : canDrag ? 'grab' : 'pointer',
                          transition: 'transform 0.15s, box-shadow 0.15s, border 0.15s',
                          touchAction: 'none',
                          zIndex: isDragging ? 10 : 1,
                        }}
                      >
                      <p className="text-xs" style={{ color: isEffectivelyCompleted ? COLORS.success : COLORS.textMuted }}>{day.day}</p>
                      <p className="font-bold" style={{ color: isEffectivelyCompleted ? COLORS.success : day.isToday ? COLORS.primary : isMissed ? COLORS.textMuted : COLORS.text }}>{day.date}</p>
                      {isBeforeProgram ? (
                        <p className="text-xs mt-1" style={{ color: COLORS.textMuted }}>-</p>
                      ) : day.completed ? (
                        <div className="flex items-center justify-center gap-1 mt-1">
                          <Check size={10} color={COLORS.success} />
                          <p className="text-xs truncate" style={{ color: COLORS.success }}>
                            {day.workout?.name?.split(' ')[0] || 'Done'}
                          </p>
                        </div>
                      ) : isPastRestDay ? (
                        <div className="flex items-center justify-center gap-1 mt-1">
                          <Check size={10} color={COLORS.success} />
                          <p className="text-xs" style={{ color: COLORS.success }}>Rest</p>
                        </div>
                      ) : isMissed ? (
                        <p className="text-xs mt-1 truncate" style={{ color: COLORS.textMuted }}>
                          {day.workout?.name?.split(' ')[0] || 'Missed'}
                        </p>
                      ) : day.workout ? (
                        <p className="text-xs mt-1 truncate" style={{ color: getWorkoutColor(day.workout.name, COLORS) }}>
                          {day.workout.name.split(' ')[0]}
                        </p>
                      ) : (
                        <p className="text-xs mt-1" style={{ color: COLORS.textMuted }}>Rest</p>
                      )}
                    </button>
                    );
                  });
                })()}
              </div>
              {scheduleWeekOffset !== 0 && (
                <button 
                  onClick={() => setScheduleWeekOffset(0)}
                  className="w-full mt-2 py-2 rounded-lg text-sm"
                  style={{ backgroundColor: COLORS.surfaceLight, color: COLORS.primary }}
                >
                  Back to This Week
                </button>
              )}
              <p className="text-xs text-center mt-2" style={{ color: COLORS.textMuted }}>
                Tap any day to edit  Drag future workouts to reschedule
              </p>
            </div>

            {/* Today's Workout Card */}
            {scheduleWeekOffset === 0 && (
              <>
                <p className="text-xs font-semibold mb-3" style={{ color: COLORS.textMuted }}>TODAY'S WORKOUT</p>
                {/* Paused Card */}
                {isPaused && (
                  <div className="p-4 rounded-xl mb-6" style={{ backgroundColor: COLORS.surface, borderLeft: `4px solid ${COLORS.warning}` }}>
                    <div className="flex justify-between items-center mb-2">
                      <span className="px-2 py-1 rounded text-xs font-semibold" style={{ backgroundColor: COLORS.warning + '20', color: COLORS.warning }}>PAUSED</span>
                    </div>
                    <div className="flex items-center gap-3 mb-3">
                      <div className="w-12 h-12 rounded-xl flex items-center justify-center" style={{ backgroundColor: COLORS.warning + '20' }}>
                        <Coffee size={24} color={COLORS.warning} />
                      </div>
                      <div>
                        <h4 className="text-lg font-bold" style={{ color: COLORS.text }}>Enjoying Your Break</h4>
                        <p className="text-sm" style={{ color: COLORS.textSecondary }}>
                          Plan resumes {pauseReturnDate ? new Date(pauseReturnDate).toLocaleDateString('en-US', { weekday: 'long', month: 'short', day: 'numeric' }) : 'soon'}
                        </p>
                      </div>
                    </div>
                    <button onClick={() => { setIsPaused(false); setPauseReturnDate(null); setTodayWorkout({ type: todayWorkoutTemplate?.name?.replace(' Day ', ' ').replace('Day ', '') || 'Workout', name: todayWorkoutTemplate?.name || 'Workout', focus: todayWorkoutTemplate?.focus || '', exercises: todayWorkoutTemplate?.exercises?.length || 5, duration: 60 }); }}
                      className="w-full py-3 rounded-xl font-semibold flex items-center justify-center gap-2"
                      style={{ backgroundColor: COLORS.warning, color: COLORS.background }}>
                      Resume Plan Early <Play size={16} />
                    </button>
                  </div>
                )}

                {/* Rescheduled Banner */}
                {isRescheduled && originalWorkout && !isPaused && (
                  <div className="p-3 rounded-xl mb-4 flex items-center justify-between" style={{ backgroundColor: COLORS.primary + '15', border: `1px solid ${COLORS.primary}40` }}>
                    <div className="flex items-center gap-2">
                      <Calendar size={16} color={COLORS.primary} />
                      <p className="text-sm" style={{ color: COLORS.primary }}>
                        <strong>{originalWorkout}</strong> rescheduled
                      </p>
                    </div>
                    <button 
                      onClick={() => { setIsRescheduled(false); setOriginalWorkout(null); }}
                      className="text-xs px-2 py-1 rounded"
                      style={{ backgroundColor: COLORS.primary + '20', color: COLORS.primary }}
                    >
                      Undo
                    </button>
                  </div>
                )}

                {/* Active Workout Card - Completed */}
                {todayWorkout.type !== 'Rest' && !isPaused && todayWorkoutCompleted && (
                  <div className="p-4 rounded-xl mb-6" style={{ backgroundColor: COLORS.surface, borderLeft: `4px solid ${COLORS.success}` }}>
                    <div className="flex justify-between items-start mb-3">
                      <div>
                        <span className="text-xs px-2 py-1 rounded font-semibold flex items-center gap-1"
                          style={{ backgroundColor: COLORS.success + '20', color: COLORS.success }}>
                          <Check size={12} /> COMPLETED
                        </span>
                        <h4 className="text-xl font-bold mt-2" style={{ color: COLORS.text }}>{todayWorkout.name}</h4>
                        <p className="text-sm" style={{ color: COLORS.success }}>Great work today!</p>
                      </div>
                      <div className="w-12 h-12 rounded-full flex items-center justify-center" style={{ backgroundColor: COLORS.success + '20' }}>
                        <Check size={24} color={COLORS.success} />
                      </div>
                    </div>
                    <div className="p-3 rounded-lg" style={{ backgroundColor: COLORS.success + '10' }}>
                      <p className="text-sm text-center" style={{ color: COLORS.success }}>
                        You've crushed your workout for today. Rest up and come back stronger tomorrow!
                      </p>
                    </div>
                  </div>
                )}

                {/* Active Workout Card - Not Completed */}
                {todayWorkout.type !== 'Rest' && !isPaused && !todayWorkoutCompleted && (
                  <div className="p-4 rounded-xl mb-6" style={{ backgroundColor: COLORS.surface, borderLeft: `4px solid ${getWorkoutColor(todayWorkout.type, COLORS)}` }}>
                    <div className="flex justify-between items-start mb-3">
                      <div>
                        <span className="text-xs px-2 py-1 rounded font-semibold"
                          style={{ backgroundColor: getWorkoutColor(todayWorkout.type, COLORS) + '20', color: getWorkoutColor(todayWorkout.type, COLORS) }}>
                          TODAY
                        </span>
                        <h4 className="text-xl font-bold mt-2" style={{ color: COLORS.text }}>{todayWorkout.name}</h4>
                        <div className="flex items-center gap-2">
                          <p className="text-sm" style={{ color: getWorkoutColor(todayWorkout.type, COLORS) }}>{todayWorkout.focus}</p>
                          {todayWorkoutTemplate?.id && workoutStats[todayWorkoutTemplate.id] && (
                            <span className="text-xs flex items-center gap-1 px-2 py-0.5 rounded-full" style={{ backgroundColor: COLORS.surfaceLight }}>
                              <Award size={12} color={COLORS.warning} />
                              {(workoutStats[todayWorkoutTemplate.id]?.averageRating || 0).toFixed(1)}
                            </span>
                          )}
                        </div>
                      </div>
                      <div className="flex items-center gap-2">
                        <button onClick={() => setShowPausePlan(true)} className="p-2 rounded-lg" style={{ backgroundColor: COLORS.surfaceLight }} title="Pause Plan">
                          <Moon size={16} color={COLORS.textMuted} />
                        </button>
                        <button onClick={() => setShowReschedule(true)} className="p-2 rounded-lg" style={{ backgroundColor: COLORS.surfaceLight }} title="Reschedule">
                          <Calendar size={16} color={COLORS.textMuted} />
                        </button>
                        <button
                          onClick={() => todayWorkoutTemplate && setShowWorkoutPreview(todayWorkoutTemplate)}
                          className="p-2 rounded-lg"
                          style={{ backgroundColor: COLORS.surfaceLight }}
                          title="Preview"
                        >
                          <Eye size={16} color={COLORS.textMuted} />
                        </button>
                      </div>
                    </div>


                {/* Time Editor */}
                <button
                  onClick={() => setShowWorkoutTimeEditor(!showWorkoutTimeEditor)}
                  className="flex items-center gap-2 mb-3 px-3 py-2 rounded-lg w-full justify-between"
                  style={{ backgroundColor: COLORS.surfaceLight }}
                >
                  <div className="flex items-center gap-2">
                    <Clock size={16} color={COLORS.textSecondary} />
                    <span className="text-sm" style={{ color: COLORS.textSecondary }}>
                      {workoutTime} min  {customExerciseCount || Math.max(2, Math.floor(workoutTime / 12))} exercises
                    </span>
                  </div>
                  <ChevronDown size={16} color={COLORS.textMuted} style={{ transform: showWorkoutTimeEditor ? 'rotate(180deg)' : 'none', transition: 'transform 0.2s' }} />
                </button>

                {showWorkoutTimeEditor && (() => {
                  const defaultExerciseCount = Math.max(2, Math.floor(workoutTime / 12));
                  const exerciseCount = customExerciseCount || defaultExerciseCount;
                  const allExercises = getCurrentExercises();
                  const fullPool = todayWorkoutTemplate?.exercises || allExercises;
                  // Min: 2 exercises, Max: pool size or time-based max (allowing more exercises with less rest)
                  const minExercises = 2;
                  const maxExercises = Math.min(fullPool.length, Math.floor(workoutTime / 5)); // ~5min minimum per exercise
                  // Optimize exercises for the selected time AND count
                  const workoutTypeForCoverage = todayWorkoutTemplate?.workoutType || todayWorkout?.type || null;
                  const exercisesForTime = optimizeExercisesForTimeAndCount(allExercises, fullPool, workoutTime, exerciseCount, workoutTypeForCoverage, settings.workout.corePosition, personalWarmup, personalCooldown, !!customizedExercises);
                  const timeBreakdown = getWorkoutTimeBreakdown(exercisesForTime);
                  const totalSetsPreview = exercisesForTime.reduce((acc, ex) => acc + (ex.sets || 3), 0);

                  return (
                    <div className="mb-4 p-3 rounded-lg" style={{ backgroundColor: COLORS.background }}>
                      <p className="text-xs mb-2" style={{ color: COLORS.textMuted }}>How much time do you have?</p>
                      <div className="grid grid-cols-6 gap-2 mb-3">
                        {[20, 30, 45, 60, 75, 90].map(time => (
                          <button
                            key={time}
                            onClick={() => updateWorkoutTimeWithScroll(time)}
                            className="py-2 rounded-lg text-sm font-semibold"
                            style={{
                              backgroundColor: workoutTime === time ? COLORS.primary : COLORS.surface,
                              color: workoutTime === time ? COLORS.text : COLORS.textMuted
                            }}
                          >
                            {time}
                          </button>
                        ))}
                      </div>

                      {/* Exercise Count Adjuster */}
                      <div className="flex items-center justify-between mb-3 p-2 rounded-lg" style={{ backgroundColor: COLORS.surface }}>
                        <span className="text-sm" style={{ color: COLORS.textSecondary }}>Number of exercises</span>
                        <div className="flex items-center gap-2">
                          <button
                            onClick={() => {
                              const newCount = Math.max(minExercises, exerciseCount - 1);
                              updateExerciseCountWithScroll(newCount === defaultExerciseCount ? null : newCount);
                            }}
                            disabled={exerciseCount <= minExercises}
                            className="w-8 h-8 rounded-full flex items-center justify-center"
                            style={{
                              backgroundColor: exerciseCount <= minExercises ? COLORS.surfaceLight : COLORS.primary + '20',
                              color: exerciseCount <= minExercises ? COLORS.textMuted : COLORS.primary,
                              opacity: exerciseCount <= minExercises ? 0.5 : 1
                            }}
                          >
                            <Minus size={16} />
                          </button>
                          <span className="text-lg font-bold w-8 text-center" style={{ color: COLORS.text }}>
                            {exerciseCount}
                          </span>
                          <button
                            onClick={() => {
                              const newCount = Math.min(maxExercises, exerciseCount + 1);
                              updateExerciseCountWithScroll(newCount === defaultExerciseCount ? null : newCount);
                            }}
                            disabled={exerciseCount >= maxExercises}
                            className="w-8 h-8 rounded-full flex items-center justify-center"
                            style={{
                              backgroundColor: exerciseCount >= maxExercises ? COLORS.surfaceLight : COLORS.primary + '20',
                              color: exerciseCount >= maxExercises ? COLORS.textMuted : COLORS.primary,
                              opacity: exerciseCount >= maxExercises ? 0.5 : 1
                            }}
                          >
                            <Plus size={16} />
                          </button>
                        </div>
                      </div>
                      {customExerciseCount && customExerciseCount !== defaultExerciseCount && (
                        <p className="text-xs text-center mb-2" style={{ color: COLORS.warning }}>
                          {customExerciseCount > defaultExerciseCount
                            ? 'More exercises = shorter rest periods'
                            : 'Fewer exercises = longer rest periods & more sets'}
                        </p>
                      )}

                      {/* Time Breakdown Summary */}
                      <div className="grid grid-cols-4 gap-1.5 mb-2">
                        <div className="p-2 rounded-lg text-center" style={{ backgroundColor: COLORS.primary + '15' }}>
                          <p className="text-sm font-bold" style={{ color: COLORS.primary }}>
                            {Math.floor(timeBreakdown.workingTime / 60)}m
                          </p>
                          <p className="text-xs" style={{ color: COLORS.textMuted }}>Work</p>
                        </div>
                        <div className="p-2 rounded-lg text-center" style={{ backgroundColor: COLORS.warning + '15' }}>
                          <p className="text-sm font-bold" style={{ color: COLORS.warning }}>
                            {Math.floor(timeBreakdown.restTime / 60)}m
                          </p>
                          <p className="text-xs" style={{ color: COLORS.textMuted }}>Rest</p>
                        </div>
                        <div className="p-2 rounded-lg text-center" style={{ backgroundColor: COLORS.sleep + '15' }}>
                          <p className="text-sm font-bold" style={{ color: COLORS.sleep }}>
                            {(personalWarmup ? 5 : 0) + (personalCooldown ? 5 : 0)}m
                          </p>
                          <p className="text-xs" style={{ color: COLORS.textMuted }}>Warm/Cool</p>
                        </div>
                        <div className="p-2 rounded-lg text-center" style={{ backgroundColor: COLORS.success + '15' }}>
                          <p className="text-sm font-bold" style={{ color: COLORS.success }}>
                            ~{Math.round((timeBreakdown.workingTime + timeBreakdown.restTime) / 60 + (personalWarmup ? 5 : 0) + (personalCooldown ? 5 : 0))}m
                          </p>
                          <p className="text-xs" style={{ color: COLORS.textMuted }}>Total</p>
                        </div>
                      </div>

                      {/* Warmup/Cooldown Toggles */}
                      <div className="flex items-center gap-2 mb-3">
                        <button
                          onClick={() => setPersonalWarmup(!personalWarmup)}
                          className="flex-1 flex items-center justify-center gap-2 px-3 py-2 rounded-lg text-xs font-semibold"
                          style={{
                            backgroundColor: personalWarmup ? COLORS.primary + '20' : COLORS.surfaceLight,
                            color: personalWarmup ? COLORS.primary : COLORS.textMuted
                          }}
                        >
                          <Wind size={14} />
                          Warmup 5min
                          {personalWarmup ? <Check size={12} /> : null}
                        </button>
                        <button
                          onClick={() => setPersonalCooldown(!personalCooldown)}
                          className="flex-1 flex items-center justify-center gap-2 px-3 py-2 rounded-lg text-xs font-semibold"
                          style={{
                            backgroundColor: personalCooldown ? COLORS.primary + '20' : COLORS.surfaceLight,
                            color: personalCooldown ? COLORS.primary : COLORS.textMuted
                          }}
                        >
                          <Sprout size={14} />
                          Cooldown 5min
                          {personalCooldown ? <Check size={12} /> : null}
                        </button>
                      </div>

                      <p className="text-xs text-center mb-3" style={{ color: COLORS.textMuted }}>
                        Rest time evenly distributed between all sets
                      </p>

                      {/* Exercise Overview - Collapsible */}
                      <div className="border-t pt-3" style={{ borderColor: COLORS.surfaceLight }}>
                        <button
                          onClick={toggleExerciseListWithScroll}
                          className="w-full flex items-center justify-between mb-2"
                        >
                          <div className="flex items-center gap-2">
                            <ChevronDown
                              size={16}
                              color={COLORS.textMuted}
                              style={{ transform: exerciseListCollapsed ? 'rotate(-90deg)' : 'rotate(0deg)', transition: 'transform 0.2s' }}
                            />
                            <p className="text-xs font-semibold" style={{ color: COLORS.textMuted }}>
                              {exercisesForTime.length} EXERCISES  {totalSetsPreview} SETS
                            </p>
                          </div>
                          <div className="flex items-center gap-2">
                            {(customizedExercises || customExerciseCount) && (
                              <button
                                onClick={(e) => {
                                  e.stopPropagation();
                                  const scrollTop = workoutTabScrollRef.current?.scrollTop;
                                  resetCustomizations();
                                  setCustomExerciseCount(null);
                                  requestAnimationFrame(() => {
                                    if (workoutTabScrollRef.current && scrollTop !== undefined) {
                                      workoutTabScrollRef.current.scrollTop = scrollTop;
                                    }
                                  });
                                }}
                                className="text-xs px-2 py-1 rounded-full flex items-center gap-1"
                                style={{ backgroundColor: COLORS.warning + '20', color: COLORS.warning }}
                              >
                                <Undo2 size={10} /> Reset
                              </button>
                            )}
                            <span className="text-xs" style={{ color: COLORS.textMuted }}>
                              {exerciseListCollapsed ? 'Show' : 'Hide'}
                            </span>
                          </div>
                        </button>

                        {!exerciseListCollapsed && (
                          <>
                            <div className="space-y-2">
                              {/* Warmup Item */}
                              {personalWarmup && (
                                <div className="p-3 rounded-lg flex items-center gap-3" style={{ backgroundColor: COLORS.primary + '15', border: `1px dashed ${COLORS.primary}40` }}>
                                  <div className="w-6 h-6 rounded-full flex items-center justify-center" style={{ backgroundColor: COLORS.primary + '30' }}>
                                    <Wind size={14} color={COLORS.primary} />
                                  </div>
                                  <div className="flex-1">
                                    <p className="text-sm font-semibold" style={{ color: COLORS.primary }}>Warmup</p>
                                    <p className="text-xs" style={{ color: COLORS.textMuted }}>Light cardio & dynamic stretches</p>
                                  </div>
                                  <p className="text-sm font-semibold" style={{ color: COLORS.primary }}>5min</p>
                                </div>
                              )}
                              {exercisesForTime.map((exercise, i) => {
                            const isExpanded = expandedExerciseId === exercise.id;
                            const originalIndex = allExercises.findIndex(ex => ex.id === exercise.id);
                            const isSuperset = exercise.supersetId;
                            const isFirstInSuperset = isSuperset && exercise.supersetOrder === 1;
                            const isSecondInSuperset = isSuperset && exercise.supersetOrder === 2;

                            return (
                              <div key={exercise.id}>
                                {/* Superset header - show before first exercise in superset */}
                                {isFirstInSuperset && (
                                  <div className="flex items-center gap-2 mb-1 px-1 ml-8">
                                    <Zap size={12} color={COLORS.warning} />
                                    <span className="text-xs font-semibold" style={{ color: COLORS.warning }}>SUPERSET</span>
                                  </div>
                                )}
                                <div className="flex items-stretch gap-1">
                                  {/* Up/Down arrows on left */}
                                  <div className="flex items-center gap-0.5">
                                    <button
                                      onClick={(e) => { e.stopPropagation(); moveExerciseInHome(exercise.id, 'up', exercisesForTime); }}
                                      disabled={i === 0}
                                      className="p-1 rounded"
                                      style={{
                                        backgroundColor: i === 0 ? 'transparent' : COLORS.surfaceLight,
                                        opacity: i === 0 ? 0.3 : 1
                                      }}
                                    >
                                      <ChevronUp size={14} color={i === 0 ? COLORS.textMuted : COLORS.text} />
                                    </button>
                                    <button
                                      onClick={(e) => { e.stopPropagation(); moveExerciseInHome(exercise.id, 'down', exercisesForTime); }}
                                      disabled={i === exercisesForTime.length - 1}
                                      className="p-1 rounded"
                                      style={{
                                        backgroundColor: i === exercisesForTime.length - 1 ? 'transparent' : COLORS.surfaceLight,
                                        opacity: i === exercisesForTime.length - 1 ? 0.3 : 1
                                      }}
                                    >
                                      <ChevronDown size={14} color={i === exercisesForTime.length - 1 ? COLORS.textMuted : COLORS.text} />
                                    </button>
                                  </div>

                                  {/* Exercise card */}
                                  <div
                                    className="flex-1 rounded-lg overflow-hidden"
                                    style={{
                                      backgroundColor: COLORS.surface,
                                      ...(isSuperset && {
                                        borderLeft: `3px solid ${COLORS.warning}`,
                                        borderRadius: isFirstInSuperset ? '8px 8px 0 0' : isSecondInSuperset ? '0 0 8px 8px' : '8px',
                                        marginTop: isSecondInSuperset ? '-2px' : 0
                                      })
                                    }}
                                  >
                                    <button
                                      onClick={() => toggleExpandedExercise(exercise.id)}
                                      className="w-full flex items-center justify-between p-2"
                                    >
                                      <div className="flex items-center gap-2">
                                        <div
                                          className="w-5 h-5 rounded-full flex items-center justify-center text-xs font-bold"
                                          style={{ backgroundColor: getWorkoutColor(todayWorkout.type, COLORS) + '20', color: getWorkoutColor(todayWorkout.type, COLORS) }}
                                        >
                                          {i + 1}
                                        </div>
                                        <div className="text-left">
                                          <div className="flex items-center gap-1">
                                            <p className="text-xs font-medium" style={{ color: COLORS.text }}>{exercise.name}</p>
                                            <button onClick={(e) => { e.preventDefault(); e.stopPropagation(); showExerciseInfoWithScroll(exercise.name); }} className="p-0.5 rounded-full" style={{ backgroundColor: COLORS.primary + '20' }}><Info size={10} color={COLORS.primary} /></button>
                                          </div>
                                          <p className="text-xs" style={{ color: COLORS.textMuted }}>
                                            {['experienced', 'expert'].includes(userData.experience) && exercise.targetedHeads && exercise.targetedHeads.length > 0
                                              ? exercise.targetedHeads.join(', ')
                                              : exercise.muscleGroup}
                                            {isSuperset && <span style={{ color: COLORS.warning }}>  {exercise.supersetWith}</span>}
                                          </p>
                                        </div>
                                      </div>
                                      <div className="flex items-center gap-2">
                                        <div className="text-right">
                                          <p className="text-xs font-semibold" style={{ color: COLORS.text }}>{exercise.sets}{exercise.targetReps}</p>
                                          <div className="flex items-center gap-1">
                                            <span className="text-xs" style={{ color: COLORS.textMuted }}>{exercise.suggestedWeight}kg</span>
                                            {isSuperset && exercise.restTime === 0 ? (
                                              <span className="text-xs px-1 py-0.5 rounded" style={{ backgroundColor: COLORS.warning + '15', color: COLORS.warning }}>
                                                No rest
                                              </span>
                                            ) : (
                                              <span className="text-xs px-1 py-0.5 rounded" style={{ backgroundColor: COLORS.warning + '15', color: COLORS.warning }}>
                                                {Math.floor((exercise.restTime || 90) / 60)}:{((exercise.restTime || 90) % 60).toString().padStart(2, '0')}
                                              </span>
                                            )}
                                          </div>
                                        </div>
                                        <ChevronDown
                                          size={14}
                                          color={COLORS.textMuted}
                                          style={{ transform: isExpanded ? 'rotate(180deg)' : 'none', transition: 'transform 0.2s' }}
                                        />
                                      </div>
                                    </button>

                                    {/* Expanded Options */}
                                    {isExpanded && (
                                      <div className="px-2 pb-2 pt-1 border-t" style={{ borderColor: COLORS.surfaceLight }}>
                                        <div className="flex gap-2">
                                          <button
                                            onClick={() => swapExercise(originalIndex)}
                                            className="flex-1 py-1.5 rounded-lg text-xs font-medium flex items-center justify-center gap-1"
                                            style={{ backgroundColor: COLORS.primary + '20', color: COLORS.primary }}
                                          >
                                            <ArrowLeftRight size={12} /> Swap
                                          </button>
                                          <button
                                            onClick={() => removeExercise(originalIndex)}
                                            disabled={allExercises.length <= 2}
                                            className="flex-1 py-1.5 rounded-lg text-xs font-medium flex items-center justify-center gap-1"
                                            style={{
                                              backgroundColor: allExercises.length <= 2 ? COLORS.surfaceLight : COLORS.error + '20',
                                              color: allExercises.length <= 2 ? COLORS.textMuted : COLORS.error,
                                              opacity: allExercises.length <= 2 ? 0.5 : 1
                                            }}
                                          >
                                            <X size={12} /> Remove
                                          </button>
                                        </div>
                                        {allExercises.length <= 2 && (
                                          <p className="text-xs text-center mt-2" style={{ color: COLORS.textMuted }}>
                                            Minimum 2 exercises required
                                          </p>
                                        )}
                                      </div>
                                    )}
                                  </div>
                                </div>
                              </div>
                            );
                          })}
                            </div>
                            {allExercises.length > exerciseCount && (
                              <p className="text-xs text-center mt-2" style={{ color: COLORS.textMuted }}>
                                +{allExercises.length - exerciseCount} more exercises with more time
                              </p>
                            )}

                            {/* Cooldown Item */}
                            {personalCooldown && (
                              <div className="p-3 rounded-lg mt-2 flex items-center gap-3" style={{ backgroundColor: COLORS.primary + '15', border: `1px dashed ${COLORS.primary}40` }}>
                                <div className="w-6 h-6 rounded-full flex items-center justify-center" style={{ backgroundColor: COLORS.primary + '30' }}>
                                  <Sprout size={14} color={COLORS.primary} />
                                </div>
                                <div className="flex-1">
                                  <p className="text-sm font-semibold" style={{ color: COLORS.primary }}>Cooldown</p>
                                  <p className="text-xs" style={{ color: COLORS.textMuted }}>Static stretches & recovery</p>
                                </div>
                                <p className="text-sm font-semibold" style={{ color: COLORS.primary }}>5min</p>
                              </div>
                            )}
                          </>
                        )}
                      </div>
                    </div>
                  );
                })()}

                <button
                  onClick={() => setShowActiveWorkout(true)}
                  className="w-full py-3 rounded-xl font-semibold flex items-center justify-center gap-2"
                  style={{ backgroundColor: partialWorkoutProgress ? COLORS.warning : getWorkoutColor(todayWorkout.type, COLORS), color: COLORS.text }}
                >
                  {partialWorkoutProgress ? <><Play size={18} /> Resume Workout</> : <>Start Workout <Play size={18} /></>}
                </button>
              </div>
            )}

                {/* Rest Day Card */}
                {!isPaused && todayWorkout.type === 'Rest' && (
                  <div className="p-4 rounded-xl mb-6" style={{ backgroundColor: COLORS.surface, borderLeft: `4px solid ${COLORS.textMuted}` }}>
                    <div className="flex justify-between items-center mb-2">
                      <span className="px-2 py-1 rounded text-xs font-semibold" style={{ backgroundColor: COLORS.surfaceLight, color: COLORS.textMuted }}>REST DAY</span>
                      <div className="flex items-center gap-2">
                        <button onClick={() => setShowPausePlan(true)} className="p-2 rounded-lg" style={{ backgroundColor: COLORS.surfaceLight }} title="Pause Plan">
                          <Moon size={16} color={COLORS.textMuted} />
                        </button>
                      </div>
                    </div>
                    <div className="flex items-center gap-3 mb-3">
                      <div className="w-12 h-12 rounded-xl flex items-center justify-center" style={{ backgroundColor: COLORS.sleep + '20' }}>
                        <Moon size={24} color={COLORS.sleep} />
                      </div>
                      <div>
                        <h4 className="text-lg font-bold" style={{ color: COLORS.text }}>Recovery Day</h4>
                        <p className="text-sm" style={{ color: COLORS.textSecondary }}>Rest is essential for muscle growth</p>
                      </div>
                    </div>
                    <div className="p-3 rounded-lg" style={{ backgroundColor: COLORS.surfaceLight }}>
                      <p className="text-xs" style={{ color: COLORS.textMuted }}><strong style={{ color: COLORS.text }}>Tip:</strong> Stay active with light stretching or a walk. Stay hydrated!</p>
                    </div>
                  </div>
                )}
              </>
            )}

            {/* Upcoming Workouts */}
            <p className="text-xs font-semibold mb-3" style={{ color: COLORS.textMuted }}>UPCOMING</p>
            <div className="mb-6">
              <div className="space-y-2">
                {upcomingWorkouts.map((item, i) => {
                  const workoutTime = Math.round(getWorkoutTimeBreakdown(item.workout.exercises).totalTime / 60);
                  return (
                    <button
                      key={i}
                      onClick={() => setShowWorkoutPreview(item.workout)}
                      className="w-full p-3 rounded-xl flex items-center justify-between"
                      style={{ backgroundColor: COLORS.surface }}
                    >
                      <div className="flex items-center gap-3">
                        <div
                          className="w-1 h-10 rounded-full"
                          style={{ backgroundColor: getWorkoutColor(item.workout.name, COLORS) }}
                        />
                        <div className="text-left">
                          <p className="font-semibold" style={{ color: COLORS.text }}>{item.workout.name}</p>
                          <p className="text-xs" style={{ color: COLORS.textMuted }}>{item.date}  {item.workout.exercises.length} exercises  {workoutTime} min</p>
                        </div>
                      </div>
                      <ChevronRight size={18} color={COLORS.textMuted} />
                    </button>
                  );
                })}
              </div>
            </div>

            {/* Quick Actions */}
            <p className="text-xs font-semibold mb-3" style={{ color: COLORS.textMuted }}>QUICK ACTIONS</p>
            <div className="grid grid-cols-4 gap-2 mb-6">
              <button
                onClick={() => setShowExerciseLibrary(true)}
                className="p-3 rounded-xl flex flex-col items-center gap-1"
                style={{ backgroundColor: COLORS.surface }}
              >
                <Book size={20} color={COLORS.accent} />
                <span className="text-xs font-semibold text-center" style={{ color: COLORS.text }}>Library</span>
              </button>
              <button
                onClick={() => setShowWorkoutHistory(true)}
                className="p-3 rounded-xl flex flex-col items-center gap-1"
                style={{ backgroundColor: COLORS.surface }}
              >
                <History size={20} color={COLORS.warning} />
                <span className="text-xs font-semibold text-center" style={{ color: COLORS.text }}>History</span>
              </button>
              <button
                onClick={() => setShowPersonalRecords(true)}
                className="p-3 rounded-xl flex flex-col items-center gap-1"
                style={{ backgroundColor: COLORS.surface }}
              >
                <Trophy size={20} color={COLORS.success} />
                <span className="text-xs font-semibold text-center" style={{ color: COLORS.text }}>PRs</span>
              </button>
              <button
                onClick={() => setShowCustomWorkout(true)}
                className="p-3 rounded-xl flex flex-col items-center gap-1"
                style={{ backgroundColor: COLORS.surface }}
              >
                <Edit3 size={20} color={COLORS.primary} />
                <span className="text-xs font-semibold text-center" style={{ color: COLORS.text }}>Custom</span>
              </button>
            </div>

            {/* Recent Activity */}
            <p className="text-xs font-semibold mb-3" style={{ color: COLORS.textMuted }}>RECENT ACTIVITY</p>
            <div className="mb-6">
              {workoutHistory.length === 0 ? (
                <div className="p-6 rounded-xl text-center" style={{ backgroundColor: COLORS.surface }}>
                  <div className="w-12 h-12 rounded-full mx-auto mb-3 flex items-center justify-center" style={{ backgroundColor: COLORS.surfaceLight }}>
                    <Dumbbell size={24} color={COLORS.textMuted} />
                  </div>
                  <p className="font-semibold mb-1" style={{ color: COLORS.text }}>No workouts yet</p>
                  <p className="text-xs" style={{ color: COLORS.textMuted }}>Complete your first workout to see your activity here</p>
                </div>
              ) : (
                <div className="space-y-2">
                  {workoutHistory.slice(0, 3).map((item) => (
                    <button
                      key={item.id}
                      onClick={() => setShowWorkoutSummary(item)}
                      className="w-full p-3 rounded-xl flex items-center justify-between"
                      style={{ backgroundColor: COLORS.surface }}
                    >
                      <div className="flex items-center gap-3">
                        <div className="w-10 h-10 rounded-full flex items-center justify-center" style={{ backgroundColor: COLORS.success + '20' }}>
                          <Check size={18} color={COLORS.success} />
                        </div>
                        <div className="text-left">
                          <p className="font-semibold" style={{ color: COLORS.text }}>{item.workout.name}</p>
                          <p className="text-xs" style={{ color: COLORS.textMuted }}>{item.date}  {item.duration} min</p>
                        </div>
                      </div>
                      <div className="text-right">
                        <p className="text-sm font-semibold" style={{ color: COLORS.text }}>{(item.totalVolume / 1000).toFixed(1)}k kg</p>
                        <p className="text-xs" style={{ color: COLORS.textMuted }}>volume</p>
                      </div>
                    </button>
                  ))}
                </div>
              )}
            </div>

            {/* Personal Records Preview */}
            <div className="flex justify-between items-center mb-3">
              <p className="text-xs font-semibold" style={{ color: COLORS.textMuted }}>PERSONAL RECORDS</p>
              <div className="flex items-center gap-3">
                {personalRecords.length > 0 && (
                  <button
                    onClick={() => { setShowPRLeaderboard(true); loadPRLeaderboard(); }}
                    className="text-xs flex items-center gap-1"
                    style={{ color: COLORS.warning }}
                  >
                    <Trophy size={12} />
                    Rankings
                  </button>
                )}
                {personalRecords.length > 0 && (
                  <button
                    onClick={() => setShowPersonalRecords(true)}
                    className="text-xs"
                    style={{ color: COLORS.primary }}
                  >
                    View All
                  </button>
                )}
              </div>
            </div>
            <div className="mb-6">
              {personalRecords.length === 0 ? (
                <div className="p-6 rounded-xl text-center" style={{ backgroundColor: COLORS.surface }}>
                  <div className="w-12 h-12 rounded-full mx-auto mb-3 flex items-center justify-center" style={{ backgroundColor: COLORS.surfaceLight }}>
                    <Trophy size={24} color={COLORS.textMuted} />
                  </div>
                  <p className="font-semibold mb-1" style={{ color: COLORS.text }}>No PRs yet</p>
                  <p className="text-xs" style={{ color: COLORS.textMuted }}>Complete a workout to start tracking your personal records</p>
                </div>
              ) : (
                <div className="flex gap-2 overflow-x-auto pb-2">
                  {personalRecords.slice(0, 4).map((pr, i) => (
                    <button
                      key={i}
                      onClick={() => setShowExerciseDetail(pr.exercise)}
                      className="flex-shrink-0 p-3 rounded-xl text-center"
                      style={{ backgroundColor: COLORS.surface, minWidth: '120px' }}
                    >
                      <Trophy size={16} color={COLORS.warning} className="mx-auto mb-1" />
                      <p className="text-lg font-bold" style={{ color: COLORS.text }}>{pr.weight}kg</p>
                      <p className="text-xs" style={{ color: COLORS.textMuted }}> {pr.reps}</p>
                      <p className="text-xs mt-1 truncate" style={{ color: COLORS.textSecondary }}>{pr.exercise.split(' ')[0]}</p>
                    </button>
                  ))}
                </div>
              )}
            </div>

            {/* Training Split */}
            <p className="text-xs font-semibold mb-3" style={{ color: COLORS.textMuted }}>TRAINING SPLIT</p>
            <div className="p-4 rounded-xl mb-4" style={{ backgroundColor: COLORS.surface }}>
              <button
                type="button"
                onClick={() => setShowProgramSelector(true)}
                className="w-full p-3 rounded-xl flex items-center justify-between"
                style={{ backgroundColor: COLORS.surfaceLight, border: `1px solid ${COLORS.primary}40` }}
              >
                <div className="text-left">
                  <h4 className="font-bold" style={{ color: COLORS.text }}>{currentProgram.name}</h4>
                  <p className="text-xs" style={{ color: COLORS.textSecondary }}>{currentProgram.daysPerWeek} days/week  Week {programProgress.currentWeek} of {programProgress.totalWeeks}</p>
                </div>
                <div className="flex items-center gap-2">
                  <span className="text-sm font-semibold" style={{ color: COLORS.primary }}>{Math.round(programProgress.progressPercent)}%</span>
                  <ChevronRight size={20} color={COLORS.primary} />
                </div>
              </button>
            </div>

            {/* What's Next - Program Suggestions */}
            <p className="text-xs font-semibold mb-3" style={{ color: COLORS.textMuted }}>WHAT'S NEXT</p>
            <div className="p-4 rounded-xl mb-6" style={{ backgroundColor: COLORS.surface }}>
              {programProgress.isComplete ? (
                <div className="p-3 rounded-lg mb-3" style={{ backgroundColor: COLORS.success + '15' }}>
                  <p className="text-sm font-semibold" style={{ color: COLORS.success }}>Program Complete!</p>
                  <p className="text-xs" style={{ color: COLORS.textMuted }}>Choose your next challenge below</p>
                </div>
              ) : (
                <p className="text-xs mb-3" style={{ color: COLORS.textMuted }}>
                  After completing your current program, we recommend:
                </p>
              )}

              {/* Suggested Programs */}
              <div className="space-y-2 mb-3">
                {suggestedNextPrograms.map((program, idx) => {
                  const isSelected = selectedNextProgram === program.id || (!selectedNextProgram && idx === 0);
                  return (
                    <button
                      type="button"
                      key={program.id}
                      onClick={() => {
                        const scrollTop = workoutTabScrollRef.current?.scrollTop;
                        setSelectedNextProgram(program.id);
                        requestAnimationFrame(() => {
                          if (workoutTabScrollRef.current && scrollTop !== undefined) {
                            workoutTabScrollRef.current.scrollTop = scrollTop;
                          }
                        });
                      }}
                      className="w-full p-3 rounded-lg text-left transition-all"
                      style={{
                        backgroundColor: isSelected ? COLORS.primary + '15' : COLORS.surfaceLight,
                        border: isSelected ? `2px solid ${COLORS.primary}` : '2px solid transparent'
                      }}
                    >
                      <div className="flex items-start justify-between">
                        <div className="flex-1">
                          <div className="flex items-center gap-2">
                            <p className="font-semibold text-sm" style={{ color: isSelected ? COLORS.primary : COLORS.text }}>{program.name}</p>
                            {idx === 0 && <span className="text-xs px-2 py-0.5 rounded-full" style={{ backgroundColor: COLORS.primary + '20', color: COLORS.primary }}>Recommended</span>}
                          </div>
                          <p className="text-xs" style={{ color: COLORS.textMuted }}>{program.days} days/week  {program.weeks} weeks</p>
                          <p className="text-xs mt-1" style={{ color: COLORS.textSecondary }}>{program.reason}</p>
                        </div>
                        {isSelected && <Check size={18} color={COLORS.primary} />}
                      </div>
                    </button>
                  );
                })}
              </div>

              {/* Start Next Program Buttons */}
              <div className="flex gap-2 mb-6">
                <button
                  type="button"
                  onClick={() => {
                    const programId = selectedNextProgram || suggestedNextPrograms[0]?.id;
                    const program = suggestedNextPrograms.find(p => p.id === programId);
                    alert(`${program?.name || programId} scheduled to start after your current program ends!`);
                  }}
                  className="flex-1 py-3 px-2 rounded-xl font-semibold flex flex-col items-center justify-center"
                  style={{ backgroundColor: COLORS.primary, color: COLORS.text }}
                >
                  <span>Start in {programProgress.weeksRemaining + 1} Week{programProgress.weeksRemaining + 1 !== 1 ? 's' : ''}</span>
                  <span className="text-xs font-normal opacity-70">(after current program)</span>
                </button>
                <button
                  type="button"
                  onClick={() => {
                    const programId = selectedNextProgram || suggestedNextPrograms[0]?.id;
                    const program = suggestedNextPrograms.find(p => p.id === programId);
                    alert(`Starting ${program?.name || programId} now!`);
                  }}
                  className="flex-1 py-3 px-2 rounded-xl font-semibold"
                  style={{ backgroundColor: COLORS.primary, color: COLORS.text }}
                >
                  Start Now
                </button>
              </div>

              {/* Break Duration Options */}
              <div className="p-4 rounded-xl" style={{ backgroundColor: COLORS.surface, border: `1px solid ${COLORS.surfaceLight}` }}>
                <div className="flex items-center gap-2 mb-3">
                  <Moon size={16} color={COLORS.accent} />
                  <p className="font-semibold text-sm" style={{ color: COLORS.text }}>Or Take a Break First</p>
                </div>
                <p className="text-xs mb-3" style={{ color: COLORS.textMuted }}>
                  Need some time off? Schedule a break before your next program.
                </p>
                <div className="grid grid-cols-2 gap-2 mb-3">
                  {/* No Break Option */}
                  <button
                    type="button"
                    onClick={() => {
                      const scrollTop = workoutTabScrollRef.current?.scrollTop;
                      setSelectedBreakDuration('none');
                      requestAnimationFrame(() => {
                        if (workoutTabScrollRef.current && scrollTop !== undefined) {
                          workoutTabScrollRef.current.scrollTop = scrollTop;
                        }
                      });
                    }}
                    className="py-2 px-3 rounded-lg text-center"
                    style={{
                      backgroundColor: selectedBreakDuration === 'none' ? COLORS.primary + '20' : COLORS.surfaceLight,
                      border: selectedBreakDuration === 'none' ? `2px solid ${COLORS.primary}` : '2px solid transparent'
                    }}
                  >
                    <p className="text-sm font-semibold" style={{ color: selectedBreakDuration === 'none' ? COLORS.primary : COLORS.text }}>No Break</p>
                    <p className="text-xs" style={{ color: COLORS.textMuted }}>Continue training</p>
                  </button>
                  {BREAK_OPTIONS.filter(o => o.id !== 'none').map(option => (
                    <button
                      type="button"
                      key={option.id}
                      onClick={() => {
                        const scrollTop = workoutTabScrollRef.current?.scrollTop;
                        setSelectedBreakDuration(option.id);
                        requestAnimationFrame(() => {
                          if (workoutTabScrollRef.current && scrollTop !== undefined) {
                            workoutTabScrollRef.current.scrollTop = scrollTop;
                          }
                        });
                      }}
                      className="py-2 px-3 rounded-lg text-center"
                      style={{
                        backgroundColor: selectedBreakDuration === option.id ? COLORS.primary + '20' : COLORS.surfaceLight,
                        border: selectedBreakDuration === option.id ? `2px solid ${COLORS.primary}` : '2px solid transparent'
                      }}
                    >
                      <p className="text-sm font-semibold" style={{ color: selectedBreakDuration === option.id ? COLORS.primary : COLORS.text }}>{option.label}</p>
                      <p className="text-xs" style={{ color: COLORS.textMuted }}>{option.desc}</p>
                    </button>
                  ))}
                </div>
                <button
                  type="button"
                  onClick={() => {
                    if (selectedBreakDuration === 'none') {
                      alert('Please select a break duration first');
                      return;
                    }
                    setShowPausePlan(true);
                  }}
                  disabled={selectedBreakDuration === 'none'}
                  className="w-full py-2 rounded-lg font-semibold"
                  style={{
                    backgroundColor: selectedBreakDuration !== 'none' ? COLORS.primary : COLORS.surfaceLight,
                    color: selectedBreakDuration !== 'none' ? COLORS.text : COLORS.textMuted,
                    opacity: selectedBreakDuration !== 'none' ? 1 : 0.6
                  }}
                >
                  Schedule {selectedBreakDuration !== 'none' ? BREAK_OPTIONS.find(b => b.id === selectedBreakDuration)?.label : ''} Break
                </button>
              </div>

              {/* Comeback Message */}
              <div className="p-3 rounded-lg mt-3" style={{ backgroundColor: COLORS.surfaceLight }}>
                <p className="text-xs text-center" style={{ color: COLORS.textSecondary }}>
                  Remember, you can come back anytime. Rest is part of the journey!
                </p>
              </div>
            </div>

          </div>
);

// FriendsTab Component - extracted outside UpRepDemo to prevent re-creation on state changes
const FriendsTab = ({
  COLORS,
  friendsTabScrollRef,
  socialEnabled,
  setSocialEnabled,
  friendsTab,
  setFriendsTab,
  // Community workouts
  todayWorkoutTemplate,
  setWorkoutToPublish,
  setShowPublishModal,
  communitySort,
  setCommunitySort,
  showCommunityFilters,
  setShowCommunityFilters,
  communityFilters,
  setCommunityFilters,
  myPublishedWorkouts,
  expandedWorkoutId,
  setExpandedWorkoutIdWithScroll,
  workoutWarmupCooldown,
  toggleWarmupCooldownWithScroll,
  renamingWorkout,
  setRenamingWorkout,
  newWorkoutName,
  setNewWorkoutName,
  handleRenameWorkout,
  loadComments,
  setSelectedCommunityWorkout,
  savedWorkoutIds,
  setSavedWorkoutIds,
  loadRepertoire,
  getWorkoutStyle,
  estimateWorkoutDuration,
  getWorkoutTimeBreakdown,
  WORKOUT_TIMING,
  showExerciseInfoFriendsTab,
  formatActivityTime,
  IconMap,
  StarRating,
  communityWorkouts,
  communityWorkoutsLoading,
  userWorkoutRatings,
  handleRateWorkout,
  handleSaveWorkout,
  user,
  adjustWorkoutForUser,
  publishedWorkoutService,
  // Feed
  userData,
  overviewStats,
  personalRecords,
  streaks,
  setShowShareModal,
  weeklyLeaderboard,
  setWeeklyLeaderboard,
  leaderboardType,
  setLeaderboardType,
  leaderboardLoading,
  setLeaderboardLoading,
  competitionService,
  activityFeed,
  activityFeedLoading,
  userLikes,
  handleActivityLike,
  expandedActivity,
  setExpandedActivity,
  expandedActivitySets,
  setExpandedActivitySets,
  setShowCommentsModal,
  activityCommentCounts,
  // Followers/Following
  followersList,
  followersLoading,
  setShowFriendProfile,
  setShowFriendStreakCalendar,
  setShowAddFriendModal,
  friends,
  followingList,
  followingLoading,
  // Discover
  suggestedFriends,
  topFollowedUsers,
  topFollowedLoading,
  topFollowedPeriod,
  setTopFollowedPeriod,
  followingIds,
  handleFollowUser,
  // Challenges
  challenges,
  setShowCreateChallenge,
  profile,
  // Workout Buddy (Feed tab)
  workoutBuddy,
  setWorkoutBuddy,
  buddyRequests,
  setBuddyRequests,
  accountabilityService,
  supabase,
  // Utility
  setActiveTab,
}) => {
  const handleScroll = (e) => {
    if (friendsTabScrollRef?.current !== undefined) {
      friendsTabScrollRef.current = e.target.scrollTop;
    }
  };

  return (
    <div
      ref={friendsTabScrollRef}
      onScroll={handleScroll}
      className="p-4 h-full overflow-auto"
    >
      {/* Social Opt-Out Banner */}
      {!socialEnabled && (
        <div className="p-4 rounded-xl mb-4" style={{ backgroundColor: COLORS.surfaceLight }}>
          <div className="flex items-center justify-between">
            <div>
              <p className="font-semibold" style={{ color: COLORS.text }}>Social Features Disabled</p>
              <p className="text-xs" style={{ color: COLORS.textMuted }}>Your activity is private</p>
            </div>
            <button
              onClick={() => setSocialEnabled(true)}
              className="px-3 py-2 rounded-xl text-sm font-semibold"
              style={{ backgroundColor: COLORS.primary, color: COLORS.text }}
            >
              Enable
            </button>
          </div>
        </div>
      )}

      {/* Tab Navigation */}
      <div className="flex gap-2 mb-4 overflow-x-auto">
        {[
          { id: 'feed', label: 'Activity' },
          { id: 'community_workouts', label: 'Workouts' },
          { id: 'followers', label: 'Followers' },
          { id: 'following', label: 'Following' },
          { id: 'discover', label: 'Discover' },
          { id: 'challenges', label: 'Challenges' },
        ].map(tab => (
          <button
            key={tab.id}
            onClick={() => setFriendsTab(tab.id)}
            className="flex-1 py-2 px-1 rounded-xl text-xs font-semibold"
            style={{
              backgroundColor: friendsTab === tab.id ? COLORS.primary : COLORS.surface,
              color: friendsTab === tab.id ? COLORS.text : COLORS.textMuted
            }}
          >
            {tab.label}
          </button>
        ))}
      </div>

      {/* COMMUNITY WORKOUTS TAB */}
      {friendsTab === 'community_workouts' && (
        <>
          {/* Publish Button */}
          <button
            onClick={() => {
              if (todayWorkoutTemplate) {
                setWorkoutToPublish(todayWorkoutTemplate);
                setShowPublishModal(true);
              }
            }}
            className="w-full p-4 rounded-xl mb-4 flex items-center justify-center gap-2"
            style={{ backgroundColor: COLORS.primary, color: COLORS.text }}
          >
            <Share2 size={18} />
            <span className="font-semibold">Share Your Workout</span>
          </button>

          {/* Sort Options */}
          <div className="flex gap-2 mb-3">
            {[
              { id: 'popular', label: 'Most Popular' },
              { id: 'rating', label: 'Top Rated' },
              { id: 'newest', label: 'Newest' },
            ].map(sort => (
              <button
                key={sort.id}
                onClick={() => setCommunitySort(sort.id)}
                className="flex-1 py-2 rounded-lg text-xs font-semibold"
                style={{
                  backgroundColor: communitySort === sort.id ? COLORS.primary : COLORS.surface,
                  color: communitySort === sort.id ? COLORS.text : COLORS.textMuted
                }}
              >
                {sort.label}
              </button>
            ))}
          </div>

          {/* Filter Options */}
          <div className="mb-4">
            <button
              onClick={() => setShowCommunityFilters(!showCommunityFilters)}
              className="flex items-center gap-2 px-3 py-2 rounded-lg text-xs font-semibold"
              style={{ backgroundColor: COLORS.surface, color: COLORS.textMuted }}
            >
              <Filter size={14} />
              Filters
              {(communityFilters.duration || communityFilters.minRating || communityFilters.focus || communityFilters.minCompletions) && (
                <span className="w-2 h-2 rounded-full" style={{ backgroundColor: COLORS.primary }} />
              )}
              <ChevronDown size={14} style={{ transform: showCommunityFilters ? 'rotate(180deg)' : 'rotate(0deg)', transition: 'transform 0.2s' }} />
            </button>

            {showCommunityFilters && (
              <div className="mt-2 p-3 rounded-xl space-y-3" style={{ backgroundColor: COLORS.surface }}>
                {/* Duration Filter */}
                <div>
                  <p className="text-xs font-semibold mb-2" style={{ color: COLORS.textMuted }}>Duration</p>
                  <div className="flex gap-2 flex-wrap">
                    {[
                      { id: null, label: 'Any' },
                      { id: 'short', label: '<30min' },
                      { id: 'medium', label: '30-60min' },
                      { id: 'long', label: '>60min' },
                    ].map(d => (
                      <button
                        key={d.id || 'any'}
                        onClick={() => setCommunityFilters(prev => ({ ...prev, duration: d.id }))}
                        className="px-3 py-1.5 rounded-lg text-xs font-semibold"
                        style={{
                          backgroundColor: communityFilters.duration === d.id ? COLORS.primary : COLORS.surfaceLight,
                          color: communityFilters.duration === d.id ? COLORS.text : COLORS.textMuted
                        }}
                      >
                        {d.label}
                      </button>
                    ))}
                  </div>
                </div>

                {/* Min Rating Filter */}
                <div>
                  <p className="text-xs font-semibold mb-2" style={{ color: COLORS.textMuted }}>Minimum Rating</p>
                  <div className="flex gap-2 flex-wrap">
                    {[
                      { id: null, label: 'Any' },
                      { id: 3, label: '3+ stars' },
                      { id: 4, label: '4+ stars' },
                      { id: 4.5, label: '4.5+ stars' },
                    ].map(r => (
                      <button
                        key={r.id || 'any'}
                        onClick={() => setCommunityFilters(prev => ({ ...prev, minRating: r.id }))}
                        className="px-3 py-1.5 rounded-lg text-xs font-semibold"
                        style={{
                          backgroundColor: communityFilters.minRating === r.id ? COLORS.primary : COLORS.surfaceLight,
                          color: communityFilters.minRating === r.id ? COLORS.text : COLORS.textMuted
                        }}
                      >
                        {r.label}
                      </button>
                    ))}
                  </div>
                </div>

                {/* Focus/Type Filter */}
                <div>
                  <p className="text-xs font-semibold mb-2" style={{ color: COLORS.textMuted }}>Workout Type</p>
                  <div className="flex gap-2 flex-wrap">
                    {[
                      { id: null, label: 'Any' },
                      { id: 'push', label: 'Push' },
                      { id: 'pull', label: 'Pull' },
                      { id: 'legs', label: 'Legs' },
                      { id: 'upper', label: 'Upper' },
                      { id: 'full', label: 'Full Body' },
                      { id: 'core', label: 'Core' },
                    ].map(f => (
                      <button
                        key={f.id || 'any'}
                        onClick={() => setCommunityFilters(prev => ({ ...prev, focus: f.id }))}
                        className="px-3 py-1.5 rounded-lg text-xs font-semibold"
                        style={{
                          backgroundColor: communityFilters.focus === f.id ? COLORS.primary : COLORS.surfaceLight,
                          color: communityFilters.focus === f.id ? COLORS.text : COLORS.textMuted
                        }}
                      >
                        {f.label}
                      </button>
                    ))}
                  </div>
                </div>

                {/* Min Completions Filter */}
                <div>
                  <p className="text-xs font-semibold mb-2" style={{ color: COLORS.textMuted }}>Completed By</p>
                  <div className="flex gap-2 flex-wrap">
                    {[
                      { id: null, label: 'Any' },
                      { id: 10, label: '10+ people' },
                      { id: 50, label: '50+ people' },
                      { id: 100, label: '100+ people' },
                    ].map(c => (
                      <button
                        key={c.id || 'any'}
                        onClick={() => setCommunityFilters(prev => ({ ...prev, minCompletions: c.id }))}
                        className="px-3 py-1.5 rounded-lg text-xs font-semibold"
                        style={{
                          backgroundColor: communityFilters.minCompletions === c.id ? COLORS.primary : COLORS.surfaceLight,
                          color: communityFilters.minCompletions === c.id ? COLORS.text : COLORS.textMuted
                        }}
                      >
                        {c.label}
                      </button>
                    ))}
                  </div>
                </div>

                {/* Clear Filters */}
                {(communityFilters.duration || communityFilters.minRating || communityFilters.focus || communityFilters.minCompletions) && (
                  <button
                    onClick={() => setCommunityFilters({ duration: null, minRating: null, focus: null, minCompletions: null })}
                    className="text-xs font-semibold"
                    style={{ color: COLORS.error }}
                  >
                    Clear All Filters
                  </button>
                )}
              </div>
            )}
          </div>

          {/* My Published Workouts */}
          {myPublishedWorkouts.length > 0 && (
            <div className="mb-6">
              <p className="text-xs font-semibold mb-3" style={{ color: COLORS.textMuted }}>YOUR SHARED WORKOUTS</p>
              <div className="space-y-2">
                {myPublishedWorkouts.map(workout => {
                  const style = getWorkoutStyle(workout.focus);
                  const isExpanded = expandedWorkoutId === workout.id;
                  const targetDuration = workout.target_duration || estimateWorkoutDuration(workout.exercises);
                  const uploadDate = workout.created_at ? new Date(workout.created_at) : null;
                  const uploadTimeAgo = uploadDate ? formatActivityTime(workout.created_at) : '';

                  return (
                    <div
                      key={workout.id}
                      className="rounded-xl overflow-hidden"
                      style={{ backgroundColor: COLORS.surface }}
                    >
                      {/* Card Header - Clickable to expand */}
                      <button
                        onClick={() => setExpandedWorkoutIdWithScroll(isExpanded ? null : workout.id)}
                        className="w-full p-3 text-left"
                      >
                        <div className="flex items-center gap-3">
                          <div
                            className="w-10 h-10 rounded-lg flex items-center justify-center flex-shrink-0"
                            style={{ backgroundColor: style.color + '20' }}
                          >
                            <IconMap name={style.icon} size={18} color={style.color} />
                          </div>
                          <div className="flex-1 min-w-0">
                            <div className="flex items-center gap-2">
                              <p className="font-semibold text-sm truncate" style={{ color: COLORS.text }}>{workout.name}</p>
                              <ChevronDown
                                size={14}
                                color={COLORS.textMuted}
                                style={{ transform: isExpanded ? 'rotate(180deg)' : 'rotate(0deg)', transition: 'transform 0.2s' }}
                              />
                            </div>
                            <div className="flex items-center flex-wrap gap-2 text-xs mt-1" style={{ color: COLORS.textMuted }}>
                              <div className="flex items-center gap-1">
                                <StarRating rating={workout.averageRating || 0} readonly size={10} />
                                <span className="font-medium" style={{ color: COLORS.warning }}>{(workout.averageRating || 0).toFixed(1)}</span>
                              </div>
                              <span>({workout.ratingCount || 0})</span>
                              <span className="flex items-center gap-1">
                                <Users size={10} /> {workout.completionCount || 0}
                              </span>
                              {uploadTimeAgo && <span>{uploadTimeAgo}</span>}
                            </div>
                          </div>
                          <button
                            onClick={(e) => { e.stopPropagation(); loadComments(workout.id); }}
                            className="p-2 rounded-lg flex items-center gap-1"
                            style={{ backgroundColor: COLORS.surfaceLight }}
                          >
                            <MessageCircle size={14} color={COLORS.textMuted} />
                            <span className="text-xs" style={{ color: COLORS.textMuted }}>{workout.comment_count || 0}</span>
                          </button>
                        </div>
                      </button>

                      {/* Expanded Content */}
                      {isExpanded && (() => {
                        const timing = getWorkoutTimeBreakdown(workout.exercises || []);
                        const activeMins = Math.round(timing.workingTime / 60);
                        const restMins = Math.round(timing.restTime / 60);
                        const warmupMins = Math.round(WORKOUT_TIMING.WARMUP_TIME / 60);
                        const cooldownMins = Math.round(WORKOUT_TIMING.COOLDOWN_TIME / 60);
                        const warmupCooldownState = workoutWarmupCooldown[workout.id] || {};
                        const hasWarmup = warmupCooldownState.warmup ?? true;
                        const hasCooldown = warmupCooldownState.cooldown ?? true;
                        const workoutMins = activeMins + restMins + (hasWarmup ? warmupMins : 0) + (hasCooldown ? cooldownMins : 0);
                        return (
                        <div className="px-3 pb-3 border-t" style={{ borderColor: COLORS.surfaceLight }}>
                          {/* Time Breakdown */}
                          <div className="grid grid-cols-4 gap-2 py-3">
                            <div className="text-center p-2 rounded-lg" style={{ backgroundColor: COLORS.success + '15' }}>
                              <p className="font-bold text-sm" style={{ color: COLORS.success }}>{activeMins}min</p>
                              <p className="text-xs" style={{ color: COLORS.textMuted }}>Active</p>
                            </div>
                            <div className="text-center p-2 rounded-lg" style={{ backgroundColor: COLORS.warning + '15' }}>
                              <p className="font-bold text-sm" style={{ color: COLORS.warning }}>{restMins}min</p>
                              <p className="text-xs" style={{ color: COLORS.textMuted }}>Rest</p>
                            </div>
                            <div className="text-center p-2 rounded-lg" style={{ backgroundColor: COLORS.primary + '15' }}>
                              <p className="font-bold text-sm" style={{ color: COLORS.primary }}>{hasWarmup ? warmupMins : 0}+{hasCooldown ? cooldownMins : 0}min</p>
                              <p className="text-xs" style={{ color: COLORS.textMuted }}>Warm/Cool</p>
                            </div>
                            <div className="text-center p-2 rounded-lg" style={{ backgroundColor: COLORS.surfaceLight }}>
                              <p className="font-bold text-sm" style={{ color: COLORS.text }}>{workoutMins}min</p>
                              <p className="text-xs" style={{ color: COLORS.textMuted }}>Total</p>
                            </div>
                          </div>

                          {/* Warmup/Cooldown Toggles */}
                          <div className="flex items-center gap-3 py-2">
                            <button
                              onClick={() => toggleWarmupCooldownWithScroll(workout.id, 'warmup')}
                              className="flex items-center gap-2 px-3 py-1.5 rounded-lg text-xs font-semibold"
                              style={{
                                backgroundColor: hasWarmup ? COLORS.primary + '20' : COLORS.surfaceLight,
                                color: hasWarmup ? COLORS.primary : COLORS.textMuted
                              }}
                            >
                              <Wind size={12} />
                              Warmup {warmupMins}min
                              {hasWarmup ? <Check size={12} /> : null}
                            </button>
                            <button
                              onClick={() => toggleWarmupCooldownWithScroll(workout.id, 'cooldown')}
                              className="flex items-center gap-2 px-3 py-1.5 rounded-lg text-xs font-semibold"
                              style={{
                                backgroundColor: hasCooldown ? COLORS.primary + '20' : COLORS.surfaceLight,
                                color: hasCooldown ? COLORS.primary : COLORS.textMuted
                              }}
                            >
                              <Sprout size={12} />
                              Cooldown {cooldownMins}min
                              {hasCooldown ? <Check size={12} /> : null}
                            </button>
                          </div>

                          {/* Exercise count & avg completion */}
                          <div className="flex items-center gap-3 py-2 text-xs" style={{ color: COLORS.textMuted }}>
                            <span>{workout.exercises?.length || 0} exercises</span>
                            {workout.avg_actual_duration && (
                              <span className="flex items-center gap-1">
                                <Clock size={10} /> Avg completion: {workout.avg_actual_duration}min
                              </span>
                            )}
                          </div>

                          {/* Description */}
                          {workout.description && (
                            <p className="text-sm py-2" style={{ color: COLORS.textSecondary }}>{workout.description}</p>
                          )}

                          {/* Exercises List with Warmup/Cooldown */}
                          <div className="py-2 space-y-2">
                            {/* Warmup Item */}
                            {hasWarmup && (
                              <div className="p-2 rounded-lg flex items-center gap-2" style={{ backgroundColor: COLORS.primary + '15', border: `1px dashed ${COLORS.primary}40` }}>
                                <div className="w-6 h-6 rounded-full flex items-center justify-center" style={{ backgroundColor: COLORS.primary + '30' }}>
                                  <Wind size={12} color={COLORS.primary} />
                                </div>
                                <div className="flex-1">
                                  <p className="font-semibold text-xs" style={{ color: COLORS.primary }}>Warmup</p>
                                  <p className="text-xs" style={{ color: COLORS.textMuted }}>Light cardio & dynamic stretches</p>
                                </div>
                                <p className="font-semibold text-xs" style={{ color: COLORS.primary }}>{warmupMins}min</p>
                              </div>
                            )}
                            {(workout.exercises || []).map((exercise, i) => {
                              const sets = exercise.sets || 3;
                              const restTime = exercise.restTime || 90;
                              return (
                                <div
                                  key={exercise.id || i}
                                  className="p-2 rounded-lg flex items-center gap-2"
                                  style={{ backgroundColor: COLORS.surfaceLight }}
                                >
                                  <div className="w-6 h-6 rounded-full flex items-center justify-center" style={{ backgroundColor: style.color + '20' }}>
                                    <span className="font-bold text-xs" style={{ color: style.color }}>{i + 1}</span>
                                  </div>
                                  <div className="flex-1 flex items-center gap-1">
                                    <p className="font-semibold text-xs" style={{ color: COLORS.text }}>{exercise.name}</p>
                                    <button
                                      onClick={(e) => { e.stopPropagation(); showExerciseInfoFriendsTab(exercise.name); }}
                                      className="p-0.5 rounded-full"
                                      style={{ backgroundColor: COLORS.primary + '20' }}
                                    >
                                      <Info size={10} color={COLORS.primary} />
                                    </button>
                                  </div>
                                  <div className="text-right">
                                    <p className="font-semibold text-xs" style={{ color: COLORS.text }}>
                                      {exercise.sets} x {exercise.targetReps || exercise.reps}
                                    </p>
                                    {sets > 1 && (
                                      <p className="text-xs" style={{ color: COLORS.warning }}>{restTime}s rest</p>
                                    )}
                                  </div>
                                </div>
                              );
                            })}

                            {/* Cooldown Item */}
                            {hasCooldown && (
                              <div className="p-2 rounded-lg flex items-center gap-2" style={{ backgroundColor: COLORS.primary + '15', border: `1px dashed ${COLORS.primary}40` }}>
                                <div className="w-6 h-6 rounded-full flex items-center justify-center" style={{ backgroundColor: COLORS.primary + '30' }}>
                                  <Sprout size={12} color={COLORS.primary} />
                                </div>
                                <div className="flex-1">
                                  <p className="font-semibold text-xs" style={{ color: COLORS.primary }}>Cooldown</p>
                                  <p className="text-xs" style={{ color: COLORS.textMuted }}>Static stretches & recovery</p>
                                </div>
                                <p className="font-semibold text-xs" style={{ color: COLORS.primary }}>{cooldownMins}min</p>
                              </div>
                            )}
                          </div>

                          {/* Rename Section */}
                          {renamingWorkout?.id === workout.id ? (
                            <div className="flex gap-2 py-2">
                              <input
                                type="text"
                                value={newWorkoutName}
                                onChange={(e) => setNewWorkoutName(e.target.value)}
                                placeholder="New workout name"
                                className="flex-1 px-3 py-2 rounded-lg text-sm outline-none"
                                style={{ backgroundColor: COLORS.surfaceLight, color: COLORS.text, border: `1px solid ${COLORS.primary}` }}
                                autoFocus
                              />
                              <button
                                onClick={handleRenameWorkout}
                                className="px-3 py-2 rounded-lg text-sm font-semibold"
                                style={{ backgroundColor: COLORS.primary, color: COLORS.text }}
                              >
                                Save
                              </button>
                              <button
                                onClick={() => { setRenamingWorkout(null); setNewWorkoutName(''); }}
                                className="px-3 py-2 rounded-lg text-sm"
                                style={{ backgroundColor: COLORS.surfaceLight, color: COLORS.textMuted }}
                              >
                                Cancel
                              </button>
                            </div>
                          ) : null}

                          {/* Action Buttons */}
                          <div className="flex gap-2 pt-2">
                            <button
                              onClick={() => { setRenamingWorkout({ id: workout.id, name: workout.name }); setNewWorkoutName(workout.name); }}
                              className="py-2 px-3 rounded-lg font-semibold text-sm flex items-center justify-center gap-1"
                              style={{ backgroundColor: COLORS.surfaceLight, color: COLORS.text }}
                            >
                              <Edit3 size={14} />
                            </button>
                            <button
                              onClick={() => loadComments(workout.id)}
                              className="flex-1 py-2 rounded-lg font-semibold text-sm flex items-center justify-center gap-1"
                              style={{ backgroundColor: COLORS.surfaceLight, color: COLORS.text }}
                            >
                              <MessageCircle size={14} /> Comments
                            </button>
                            <button
                              onClick={() => setSelectedCommunityWorkout(workout)}
                              className="flex-1 py-2 rounded-lg font-semibold text-sm"
                              style={{ backgroundColor: COLORS.primary + '20', color: COLORS.primary }}
                            >
                              Full Details
                            </button>
                          </div>
                        </div>
                        );
                      })()}
                    </div>
                  );
                })}
              </div>
            </div>
          )}

          {/* Rep-ertoire Button */}
          <button
            onClick={loadRepertoire}
            className="w-full p-3 rounded-xl mb-4 flex items-center justify-center gap-2"
            style={{ backgroundColor: COLORS.surface, border: `1px solid ${COLORS.warning}40` }}
          >
            <Book size={18} color={COLORS.warning} />
            <span className="font-semibold" style={{ color: COLORS.warning }}>My Rep-ertoire</span>
            {savedWorkoutIds.size > 0 && (
              <span className="px-2 py-0.5 rounded-full text-xs font-bold" style={{ backgroundColor: COLORS.warning, color: COLORS.background }}>
                {savedWorkoutIds.size}
              </span>
            )}
          </button>

          {/* Community Workouts List - PLACEHOLDER for remaining content */}
          <p className="text-xs font-semibold mb-3" style={{ color: COLORS.textMuted }}>COMMUNITY WORKOUTS</p>
          {communityWorkoutsLoading ? (
            <div className="flex items-center justify-center py-8">
              <Loader2 size={24} className="animate-spin" color={COLORS.primary} />
            </div>
          ) : communityWorkouts.length === 0 ? (
            <div className="p-6 rounded-xl text-center" style={{ backgroundColor: COLORS.surface }}>
              <Dumbbell size={40} color={COLORS.primary} className="mx-auto mb-3" style={{ opacity: 0.7 }} />
              <p className="text-sm font-medium" style={{ color: COLORS.text }}>No community workouts yet</p>
              <p className="text-xs mt-1" style={{ color: COLORS.textMuted }}>Be the first to share a workout!</p>
            </div>
          ) : (
            <div className="text-xs text-center py-4" style={{ color: COLORS.textMuted }}>
              {/* Full community workouts list will be rendered here - content moved from original */}
              Community workouts available: {communityWorkouts.length}
            </div>
          )}
        </>
      )}

      {/* ACTIVITY FEED TAB */}
      {friendsTab === 'feed' && (
        <>
          {/* Your Stats Card */}
          <div className="p-4 rounded-xl mb-4" style={{ backgroundColor: COLORS.surface }}>
            <div className="flex items-center justify-between mb-3">
              <div className="flex items-center gap-3">
                <div className="w-12 h-12 rounded-full flex items-center justify-center text-2xl" style={{ backgroundColor: COLORS.primary + '20' }}>
                  
                </div>
                <div>
                  <p className="font-bold" style={{ color: COLORS.text }}>@{userData.username || 'username'}</p>
                  <p className="text-xs" style={{ color: COLORS.textSecondary }}>{userData.firstName} {userData.lastName}</p>
                  <div className="flex items-center gap-1 mt-0.5">
                    <Flame size={12} color={COLORS.warning} />
                    <span className="text-xs font-semibold" style={{ color: COLORS.warning }}>{streaks.weeklyWorkouts?.weeksCompleted || 0} week streak</span>
                  </div>
                </div>
              </div>
              <button
                onClick={() => setShowShareModal(true)}
                className="px-3 py-2 rounded-xl text-sm font-semibold flex items-center gap-2"
                style={{ backgroundColor: COLORS.primary }}
              >
                <Share2 size={14} color={COLORS.text} />
                <span style={{ color: COLORS.text }}>Share</span>
              </button>
            </div>
            {userData.bio && (
              <p className="text-sm mb-3" style={{ color: COLORS.textSecondary }}>{userData.bio}</p>
            )}
            <div className="grid grid-cols-3 gap-3 text-center">
              <div className="p-2 rounded-lg" style={{ backgroundColor: COLORS.surfaceLight }}>
                <p className="font-bold" style={{ color: COLORS.text }}>{overviewStats.totalWorkouts}</p>
                <p className="text-xs" style={{ color: COLORS.textMuted }}>workouts</p>
              </div>
              <div className="p-2 rounded-lg" style={{ backgroundColor: COLORS.surfaceLight }}>
                <p className="font-bold" style={{ color: COLORS.text }}>{personalRecords.length}</p>
                <p className="text-xs" style={{ color: COLORS.textMuted }}>PRs</p>
              </div>
              <div className="p-2 rounded-lg" style={{ backgroundColor: COLORS.surfaceLight }}>
                <p className="font-bold" style={{ color: COLORS.text }}>{streaks.weeklyWorkouts?.weeksCompleted || 0}</p>
                <p className="text-xs" style={{ color: COLORS.textMuted }}>week streak</p>
              </div>
            </div>
          </div>

          {/* Privacy Toggle */}
          <button
            onClick={() => setSocialEnabled(!socialEnabled)}
            className="w-full p-3 rounded-xl mb-4 flex items-center justify-between"
            style={{ backgroundColor: COLORS.surface }}
          >
            <div className="flex items-center gap-2">
              <Eye size={16} color={COLORS.textMuted} />
              <span className="text-sm" style={{ color: COLORS.textSecondary }}>Share my activity with followers</span>
            </div>
            <div
              className="w-10 h-6 rounded-full p-0.5 transition-colors"
              style={{ backgroundColor: socialEnabled ? COLORS.success : COLORS.surfaceLight }}
            >
              <div
                className="w-5 h-5 rounded-full transition-transform"
                style={{
                  backgroundColor: COLORS.text,
                  transform: socialEnabled ? 'translateX(16px)' : 'translateX(0)'
                }}
              />
            </div>
          </button>

          {/* Weekly Leaderboard */}
          {weeklyLeaderboard.length > 0 && (
            <div className="p-4 rounded-xl mb-4" style={{ backgroundColor: COLORS.surface }}>
              <div className="flex items-center justify-between mb-3">
                <div className="flex items-center gap-2">
                  <Crown size={18} color={COLORS.warning} />
                  <h3 className="font-bold text-sm" style={{ color: COLORS.text }}>This Week's Leaders</h3>
                </div>
                <div className="flex gap-1">
                  {[
                    { id: 'workouts', label: 'Workouts' },
                    { id: 'volume', label: 'Volume' },
                    { id: 'streak', label: 'Streak' },
                  ].map(type => (
                    <button
                      key={type.id}
                      onClick={async () => {
                        setLeaderboardType(type.id);
                        setLeaderboardLoading(true);
                        const result = await competitionService.getFriendsLeaderboard(user?.id, type.id, 10);
                        if (result?.data) setWeeklyLeaderboard(result.data);
                        setLeaderboardLoading(false);
                      }}
                      className="px-2 py-1 rounded text-xs"
                      style={{
                        backgroundColor: leaderboardType === type.id ? COLORS.primary : 'transparent',
                        color: leaderboardType === type.id ? COLORS.text : COLORS.textMuted
                      }}
                    >
                      {type.label}
                    </button>
                  ))}
                </div>
              </div>

              {leaderboardLoading ? (
                <div className="flex justify-center py-4">
                  <Loader2 size={24} color={COLORS.primary} className="animate-spin" />
                </div>
              ) : (
                <div className="space-y-2">
                  {weeklyLeaderboard.slice(0, 5).map((entry, index) => {
                    const entryName = entry.profile
                      ? `${entry.profile.first_name || ''} ${entry.profile.last_name || ''}`.trim() || entry.profile.username || 'User'
                      : 'User';
                    const entryAvatar = entry.profile?.avatar_url || entry.profile?.first_name?.[0]?.toUpperCase() || 'U';

                    return (
                      <button
                        key={entry.userId}
                        onClick={() => {
                          if (!entry.isCurrentUser) {
                            setShowFriendProfile({
                              id: entry.userId,
                              name: entryName,
                              username: entry.profile?.username || 'user',
                              avatar: entryAvatar,
                            });
                          }
                        }}
                        className="w-full flex items-center gap-3 p-2 rounded-lg"
                        style={{ backgroundColor: entry.isCurrentUser ? COLORS.primary + '15' : COLORS.surfaceLight }}
                      >
                        {/* Rank */}
                        <div
                          className="w-7 h-7 rounded-full flex items-center justify-center text-xs font-bold"
                          style={{
                            backgroundColor: entry.rank === 1 ? COLORS.warning + '30' : entry.rank === 2 ? '#C0C0C0' + '30' : entry.rank === 3 ? '#CD7F32' + '30' : COLORS.surfaceLight,
                            color: entry.rank === 1 ? COLORS.warning : entry.rank === 2 ? '#C0C0C0' : entry.rank === 3 ? '#CD7F32' : COLORS.textMuted
                          }}
                        >
                          {entry.rank === 1 ? <Crown size={14} /> : entry.rank}
                        </div>

                        {/* Avatar */}
                        <div
                          className="w-8 h-8 rounded-full flex items-center justify-center text-sm font-bold"
                          style={{ backgroundColor: COLORS.primary + '30', color: COLORS.primary }}
                        >
                          {typeof entryAvatar === 'string' && entryAvatar.length === 1 ? entryAvatar : entryName[0]?.toUpperCase()}
                        </div>

                        {/* Name */}
                        <div className="flex-1 min-w-0 text-left">
                          <p className="text-sm font-medium truncate" style={{ color: COLORS.text }}>
                            {entry.isCurrentUser ? 'You' : entryName}
                          </p>
                          {entry.isCurrentUser && (
                            <p className="text-xs" style={{ color: COLORS.primary }}>Your position</p>
                          )}
                        </div>

                        {/* Score */}
                        <div className="text-right">
                          <p className="font-bold" style={{ color: COLORS.text }}>
                            {leaderboardType === 'volume' ? `${(entry.score / 1000).toFixed(1)}k` : entry.score}
                          </p>
                          <p className="text-xs" style={{ color: COLORS.textMuted }}>
                            {leaderboardType === 'volume' ? 'kg' : leaderboardType === 'streak' ? 'days' : 'sessions'}
                          </p>
                        </div>
                      </button>
                    );
                  })}
                </div>
              )}
            </div>
          )}

          {/* Workout Buddy Card */}
          {workoutBuddy?.buddy && (
            <div className="p-4 rounded-xl mb-4" style={{ backgroundColor: COLORS.surface }}>
              <div className="flex items-center gap-2 mb-3">
                <Users size={18} color={COLORS.success} />
                <h3 className="font-bold text-sm" style={{ color: COLORS.text }}>Workout Buddy</h3>
              </div>
              <button
                onClick={() => {
                  const buddy = workoutBuddy.buddy;
                  setShowFriendProfile({
                    id: buddy.id,
                    name: `${buddy.first_name || ''} ${buddy.last_name || ''}`.trim() || buddy.username || 'User',
                    username: buddy.username || 'user',
                    avatar: buddy.avatar_url || buddy.first_name?.[0]?.toUpperCase() || 'U',
                    bio: buddy.bio,
                  });
                }}
                className="w-full flex items-center gap-3 p-3 rounded-lg"
                style={{ backgroundColor: COLORS.success + '15' }}
              >
                <div
                  className="w-12 h-12 rounded-full flex items-center justify-center text-lg font-bold"
                  style={{ backgroundColor: COLORS.success + '30', color: COLORS.success }}
                >
                  {workoutBuddy.buddy.avatar_url || workoutBuddy.buddy.first_name?.[0]?.toUpperCase() || 'U'}
                </div>
                <div className="flex-1 text-left">
                  <p className="font-semibold" style={{ color: COLORS.text }}>
                    {`${workoutBuddy.buddy.first_name || ''} ${workoutBuddy.buddy.last_name || ''}`.trim() || workoutBuddy.buddy.username || 'Buddy'}
                  </p>
                  <p className="text-xs" style={{ color: COLORS.textMuted }}>
                    Buddies since {workoutBuddy.matched_at ? new Date(workoutBuddy.matched_at).toLocaleDateString() : 'recently'}
                  </p>
                </div>
                <ChevronRight size={20} color={COLORS.textMuted} />
              </button>
            </div>
          )}

          {/* Pending Buddy Requests */}
          {buddyRequests?.length > 0 && (
            <div className="p-4 rounded-xl mb-4" style={{ backgroundColor: COLORS.surface }}>
              <div className="flex items-center gap-2 mb-3">
                <UserPlus size={18} color={COLORS.primary} />
                <h3 className="font-bold text-sm" style={{ color: COLORS.text }}>Buddy Requests</h3>
                <span className="px-2 py-0.5 rounded-full text-xs font-bold" style={{ backgroundColor: COLORS.primary, color: COLORS.text }}>
                  {buddyRequests.length}
                </span>
              </div>
              <div className="space-y-2">
                {buddyRequests.map(request => {
                  const requester = request.user_a;
                  const requesterName = `${requester?.first_name || ''} ${requester?.last_name || ''}`.trim() || requester?.username || 'User';

                  return (
                    <div key={request.id} className="flex items-center gap-3 p-2 rounded-lg" style={{ backgroundColor: COLORS.surfaceLight }}>
                      <div
                        className="w-10 h-10 rounded-full flex items-center justify-center text-sm font-bold"
                        style={{ backgroundColor: COLORS.primary + '30', color: COLORS.primary }}
                      >
                        {requester?.avatar_url || requester?.first_name?.[0]?.toUpperCase() || 'U'}
                      </div>
                      <div className="flex-1 min-w-0">
                        <p className="text-sm font-medium" style={{ color: COLORS.text }}>{requesterName}</p>
                        <p className="text-xs" style={{ color: COLORS.textMuted }}>wants to be your workout buddy</p>
                      </div>
                      <div className="flex gap-2">
                        <button
                          onClick={async () => {
                            await accountabilityService.acceptBuddy(request.id, user?.id);
                            setBuddyRequests(prev => prev.filter(r => r.id !== request.id));
                            const result = await accountabilityService.getBuddy(user?.id);
                            if (result?.data) setWorkoutBuddy(result.data);
                          }}
                          className="px-3 py-1.5 rounded-lg text-xs font-semibold"
                          style={{ backgroundColor: COLORS.success, color: COLORS.text }}
                        >
                          Accept
                        </button>
                        <button
                          onClick={async () => {
                            await accountabilityService.declineBuddy(request.id, user?.id);
                            setBuddyRequests(prev => prev.filter(r => r.id !== request.id));
                          }}
                          className="px-3 py-1.5 rounded-lg text-xs font-semibold"
                          style={{ backgroundColor: COLORS.surfaceLight, color: COLORS.textMuted }}
                        >
                          Decline
                        </button>
                      </div>
                    </div>
                  );
                })}
              </div>
            </div>
          )}

          {/* Activity Feed */}
          <p className="text-xs font-semibold mb-3" style={{ color: COLORS.textMuted }}>ACTIVITY FEED</p>

          {activityFeedLoading ? (
            <div className="flex items-center justify-center py-8">
              <Loader2 size={24} className="animate-spin" color={COLORS.primary} />
            </div>
          ) : activityFeed.length === 0 ? (
            <div className="p-6 rounded-xl text-center" style={{ backgroundColor: COLORS.surface }}>
              <Users size={40} color={COLORS.primary} className="mx-auto mb-3" style={{ opacity: 0.7 }} />
              <p className="text-sm font-medium" style={{ color: COLORS.text }}>No recent activity</p>
              <p className="text-xs mt-1" style={{ color: COLORS.textMuted }}>Follow more people to see their workouts here!</p>
              <button
                onClick={() => setFriendsTab('discover')}
                className="mt-3 px-4 py-2 rounded-lg text-sm font-semibold"
                style={{ backgroundColor: COLORS.primary, color: COLORS.text }}
              >
                Discover People
              </button>
            </div>
          ) : (
            <div className="space-y-3">
              {activityFeed.map(activity => {
                const friendData = activity.friend;
                if (!friendData) return null;
                const friend = {
                  id: friendData.id,
                  name: `${friendData.first_name || ''} ${friendData.last_name || ''}`.trim() || friendData.username || 'User',
                  username: friendData.username || 'user',
                  avatar: friendData.avatar_url || friendData.first_name?.[0]?.toUpperCase() || '?',
                  streak: 0,
                };
                const isExpanded = expandedActivity === activity.id;

                return (
                  <div
                    key={activity.id}
                    className="rounded-xl overflow-hidden"
                    style={{ backgroundColor: COLORS.surface }}
                  >
                    {/* Workout Activity Card */}
                    {activity.type === 'workout' && (
                      <div className="p-4">
                        <div className="flex items-start gap-3 mb-3">
                          <button
                            onClick={() => setShowFriendProfile(friend)}
                            className="w-10 h-10 rounded-full flex items-center justify-center text-xl flex-shrink-0"
                            style={{ backgroundColor: COLORS.surfaceLight }}
                          >
                            {typeof friend.avatar === 'string' && friend.avatar.length === 1 ? friend.avatar : '?'}
                          </button>
                          <div className="flex-1">
                            <div className="flex items-center gap-2">
                              <button
                                onClick={() => setShowFriendProfile(friend)}
                                className="font-semibold"
                                style={{ color: COLORS.text }}
                              >
                                {friend.name}
                              </button>
                              {friend.streak >= 7 && (
                                <button
                                  onClick={(e) => { e.stopPropagation(); setShowFriendStreakCalendar(friend); }}
                                  className="text-xs px-2 py-0.5 rounded-full flex items-center gap-1"
                                  style={{ backgroundColor: COLORS.warning + '20' }}>
                                  <Flame size={10} color={COLORS.warning} />
                                  <span style={{ color: COLORS.warning }}>{friend.streak}</span>
                                </button>
                              )}
                            </div>
                            <p className="text-xs" style={{ color: COLORS.textMuted }}>@{friend.username}  {activity.time}</p>
                          </div>
                        </div>

                        {/* Workout Summary - Clickable to expand */}
                        <button
                          onClick={async () => {
                            if (isExpanded) {
                              setExpandedActivity(null);
                              return;
                            }
                            setExpandedActivity(activity.id);
                            if (!expandedActivitySets[activity.id]) {
                              try {
                                const { data } = await supabase
                                  .from('workout_sets')
                                  .select('*')
                                  .eq('session_id', activity.id)
                                  .order('exercise_name', { ascending: true })
                                  .order('set_number', { ascending: true });
                                setExpandedActivitySets(prev => ({ ...prev, [activity.id]: data || [] }));
                              } catch (err) {
                                console.warn('Error loading workout sets:', err);
                              }
                            }
                          }}
                          className="w-full p-3 rounded-lg mb-3 text-left"
                          style={{ backgroundColor: COLORS.primary + '10', borderLeft: `3px solid ${COLORS.primary}` }}
                        >
                          <div className="flex items-center justify-between mb-2">
                            <div className="flex items-center gap-2">
                              <Dumbbell size={16} color={COLORS.primary} />
                              <span className="font-semibold" style={{ color: COLORS.text }}>{activity.workoutName}</span>
                            </div>
                            <div className="flex items-center gap-2">
                              <span className="text-xs" style={{ color: COLORS.textMuted }}>{activity.duration} min</span>
                              {isExpanded ? <ChevronUp size={16} color={COLORS.primary} /> : <ChevronDown size={16} color={COLORS.primary} />}
                            </div>
                          </div>

                          {/* Exercise Details when expanded */}
                          {isExpanded && (
                            <div className="space-y-2 mt-3 pt-3 border-t" style={{ borderColor: COLORS.primary + '30' }}>
                              {expandedActivitySets[activity.id] ? (
                                (() => {
                                  const sets = expandedActivitySets[activity.id];
                                  if (sets.length === 0) {
                                    return <p className="text-xs" style={{ color: COLORS.textMuted }}>No exercise details recorded</p>;
                                  }
                                  const groupedExercises = {};
                                  sets.forEach(set => {
                                    const name = set.exercise_name || 'Unknown';
                                    if (!groupedExercises[name]) {
                                      groupedExercises[name] = [];
                                    }
                                    groupedExercises[name].push(set);
                                  });
                                  return Object.entries(groupedExercises).map(([exerciseName, exerciseSets], i) => (
                                    <div key={i} className="text-sm">
                                      <p className="font-medium" style={{ color: COLORS.text }}>{exerciseName}</p>
                                      <div className="ml-3 space-y-0.5">
                                        {exerciseSets.map((set, j) => (
                                          <p key={j} className="text-xs" style={{ color: COLORS.textMuted }}>
                                            Set {set.set_number}: {set.weight}kg x {set.reps} reps
                                            {set.rpe && ` @ RPE ${set.rpe}`}
                                          </p>
                                        ))}
                                      </div>
                                    </div>
                                  ));
                                })()
                              ) : (
                                <p className="text-xs" style={{ color: COLORS.textMuted }}>Loading...</p>
                              )}
                            </div>
                          )}

                          {!isExpanded && (
                            <p className="text-xs" style={{ color: COLORS.primary }}>Tap to see exercises</p>
                          )}
                        </button>

                        {/* Actions */}
                        <div className="flex items-center gap-4">
                          <button
                            onClick={() => handleActivityLike(activity.id, activity.friendId)}
                            className="flex items-center gap-1"
                          >
                            <Heart
                              size={18}
                              color={userLikes[activity.id] ? COLORS.error : COLORS.textMuted}
                              fill={userLikes[activity.id] ? COLORS.error : 'none'}
                            />
                            <span className="text-sm" style={{ color: COLORS.textMuted }}>
                              {activity.likes + (userLikes[activity.id] ? 1 : 0)}
                            </span>
                          </button>
                          <button
                            onClick={() => setShowCommentsModal(activity.id)}
                            className="flex items-center gap-1"
                          >
                            <MessageCircle size={18} color={COLORS.textMuted} />
                            <span className="text-sm" style={{ color: COLORS.textMuted }}>
                              {activityCommentCounts[activity.id] > 0 ? activityCommentCounts[activity.id] : 'Comment'}
                            </span>
                          </button>
                        </div>
                      </div>
                    )}

                    {/* PR Activity Card */}
                    {activity.type === 'pr' && (
                      <div className="p-4">
                        <div className="flex items-start gap-3 mb-3">
                          <button
                            onClick={() => setShowFriendProfile(friend)}
                            className="w-10 h-10 rounded-full flex items-center justify-center text-xl flex-shrink-0"
                            style={{ backgroundColor: COLORS.surfaceLight }}
                          >
                            {friend.avatar}
                          </button>
                          <div className="flex-1">
                            <div className="flex items-center gap-2">
                              <button
                                onClick={() => setShowFriendProfile(friend)}
                                className="font-semibold"
                                style={{ color: COLORS.text }}
                              >
                                {friend.name}
                              </button>
                              <span className="text-xs px-2 py-0.5 rounded-full flex items-center gap-1" style={{ backgroundColor: COLORS.success + '20', color: COLORS.success }}>
                                <Trophy size={12} /> NEW PR
                              </span>
                            </div>
                            <p className="text-xs" style={{ color: COLORS.textMuted }}>{activity.time}</p>
                          </div>
                        </div>

                        {/* PR Details */}
                        <button
                          onClick={() => setExpandedActivity(isExpanded ? null : activity.id)}
                          className="w-full p-3 rounded-lg mb-3 text-left"
                          style={{ backgroundColor: COLORS.success + '10', borderLeft: `3px solid ${COLORS.success}` }}
                        >
                          <div className="flex items-center justify-between mb-1">
                            <span className="font-semibold" style={{ color: COLORS.text }}>{activity.exercise}</span>
                            <ChevronDown
                              size={16}
                              color={COLORS.textMuted}
                              style={{ transform: isExpanded ? 'rotate(180deg)' : 'none', transition: 'transform 0.2s' }}
                            />
                          </div>
                          <div className="flex items-center gap-2">
                            <span className="text-2xl font-bold" style={{ color: COLORS.success }}>{activity.newWeight}kg</span>
                            <span className="text-sm px-2 py-0.5 rounded" style={{ backgroundColor: COLORS.success + '20', color: COLORS.success }}>
                              +{activity.newWeight - activity.previousWeight}kg
                            </span>
                          </div>
                          <p className="text-xs mt-1" style={{ color: COLORS.textMuted }}>
                            Tap to see progress journey 
                          </p>
                        </button>

                        {/* Actions */}
                        <div className="flex items-center gap-4">
                          <button
                            onClick={() => handleActivityLike(activity.id, activity.friendId)}
                            className="flex items-center gap-1"
                          >
                            <Heart
                              size={18}
                              color={userLikes[activity.id] ? COLORS.error : COLORS.textMuted}
                              fill={userLikes[activity.id] ? COLORS.error : 'none'}
                            />
                            <span className="text-sm" style={{ color: COLORS.textMuted }}>
                              {activity.likes + (userLikes[activity.id] ? 1 : 0)}
                            </span>
                          </button>
                          <button
                            onClick={() => setShowCommentsModal(activity.id)}
                            className="flex items-center gap-1"
                          >
                            <MessageCircle size={18} color={COLORS.textMuted} />
                            <span className="text-sm" style={{ color: COLORS.textMuted }}>
                              {activityCommentCounts[activity.id] > 0 ? activityCommentCounts[activity.id] : 'Congratulate'}
                            </span>
                          </button>
                        </div>
                      </div>
                    )}

                    {/* Milestone Activity Card */}
                    {activity.type === 'milestone' && (
                      <div className="p-4">
                        <div className="flex items-center gap-3">
                          <button
                            onClick={() => setShowFriendProfile(friend)}
                            className="w-10 h-10 rounded-full flex items-center justify-center text-xl flex-shrink-0"
                            style={{ backgroundColor: COLORS.surfaceLight }}
                          >
                            {friend.avatar}
                          </button>
                          <div className="flex-1">
                            <div className="flex items-center gap-2 flex-wrap">
                              <button
                                onClick={() => setShowFriendProfile(friend)}
                                className="font-semibold"
                                style={{ color: COLORS.text }}
                              >
                                {friend.name}
                              </button>
                              <span className="text-sm" style={{ color: COLORS.textSecondary }}>reached</span>
                              <span className="text-sm font-bold px-2 py-0.5 rounded-full flex items-center gap-1" style={{ backgroundColor: COLORS.accent + '20', color: COLORS.accent }}>
                                <Star size={12} /> {activity.milestone}
                              </span>
                            </div>
                            <p className="text-xs" style={{ color: COLORS.textMuted }}>{activity.time}</p>
                          </div>
                          <button onClick={() => handleActivityLike(activity.id, activity.friendId)}>
                            <Heart
                              size={18}
                              color={userLikes[activity.id] ? COLORS.error : COLORS.textMuted}
                              fill={userLikes[activity.id] ? COLORS.error : 'none'}
                            />
                          </button>
                        </div>
                      </div>
                    )}
                  </div>
                );
              })}
            </div>
          )}
        </>
      )}

      {/* FOLLOWERS TAB */}
      {friendsTab === 'followers' && (
        <>
          <p className="text-xs font-semibold mb-3" style={{ color: COLORS.textMuted }}>
            PEOPLE WHO FOLLOW YOU ({followersList.length})
          </p>

          {followersLoading ? (
            <div className="p-6 rounded-xl text-center" style={{ backgroundColor: COLORS.surface }}>
              <div className="animate-spin w-8 h-8 border-2 rounded-full mx-auto mb-2"
                   style={{ borderColor: COLORS.primary, borderTopColor: 'transparent' }} />
              <p className="text-sm" style={{ color: COLORS.textMuted }}>Loading followers...</p>
            </div>
          ) : followersList.length === 0 ? (
            <div className="p-6 rounded-xl text-center" style={{ backgroundColor: COLORS.surface }}>
              <Users size={40} color={COLORS.primary} className="mx-auto mb-3" style={{ opacity: 0.7 }} />
              <p className="text-sm font-medium" style={{ color: COLORS.text }}>No followers yet</p>
              <p className="text-xs mt-1" style={{ color: COLORS.textMuted }}>
                Share your workouts and stay active to gain followers!
              </p>
            </div>
          ) : (
            <div className="space-y-2">
              {followersList.map(follower => (
                <button
                  key={follower.id}
                  onClick={() => {
                    const friendData = {
                      id: follower.id,
                      name: follower.name,
                      username: follower.username,
                      avatar: follower.avatar || follower.name?.charAt(0) || '?',
                      workouts: follower.workouts,
                      followers: follower.followers,
                    };
                    setShowFriendProfile(friendData);
                  }}
                  className="w-full p-4 rounded-xl flex items-center justify-between"
                  style={{ backgroundColor: COLORS.surface }}
                >
                  <div className="flex items-center gap-3">
                    <div
                      className="w-12 h-12 rounded-full flex items-center justify-center text-xl overflow-hidden"
                      style={{ backgroundColor: COLORS.surfaceLight }}
                    >
                      {follower.avatar ? (
                        typeof follower.avatar === 'string' && follower.avatar.startsWith('http') ? (
                          <img src={follower.avatar} alt="" className="w-full h-full object-cover" />
                        ) : (
                          follower.name?.charAt(0) || '?'
                        )
                      ) : (
                        follower.name?.charAt(0) || '?'
                      )}
                    </div>
                    <div className="text-left">
                      <p className="font-semibold" style={{ color: COLORS.text }}>{follower.name}</p>
                      <p className="text-xs" style={{ color: COLORS.textMuted }}>@{follower.username}</p>
                    </div>
                  </div>
                  <div className="text-right">
                    <div className="flex items-center gap-1 justify-end">
                      <Dumbbell size={12} color={COLORS.textMuted} />
                      <span className="text-xs" style={{ color: COLORS.textMuted }}>{follower.workouts} workouts</span>
                    </div>
                    <div className="flex items-center gap-1 justify-end mt-1">
                      <Users size={12} color={COLORS.textMuted} />
                      <span className="text-xs" style={{ color: COLORS.textMuted }}>{follower.followers} followers</span>
                    </div>
                  </div>
                </button>
              ))}
            </div>
          )}
        </>
      )}

      {/* FOLLOWING TAB */}
      {friendsTab === 'following' && (
        <>
          {/* Find Users Button */}
          <button
            onClick={() => setShowAddFriendModal(true)}
            className="w-full p-4 rounded-xl mb-4 flex items-center justify-center gap-2"
            style={{ backgroundColor: COLORS.primary }}
          >
            <Plus size={20} color={COLORS.text} />
            <span className="font-semibold" style={{ color: COLORS.text }}>Find Users to Follow</span>
          </button>

          {/* Active Workouts */}
          {friends.filter(f => f.workoutStatus === 'working_out').length > 0 && (
            <div className="mb-4">
              <p className="text-xs font-semibold mb-2" style={{ color: COLORS.textMuted }}>WORKING OUT NOW</p>
              <div className="flex gap-3 overflow-x-auto pb-2">
                {friends.filter(f => f.workoutStatus === 'working_out').map(friend => (
                  <button
                    key={friend.id}
                    onClick={() => setShowFriendProfile(friend)}
                    className="flex flex-col items-center flex-shrink-0"
                  >
                    <div className="relative">
                      <div
                        className="w-14 h-14 rounded-full flex items-center justify-center text-2xl animate-pulse"
                        style={{ backgroundColor: COLORS.primary + '30', border: `2px solid ${COLORS.primary}` }}
                      >
                        {friend.avatar}
                      </div>
                      <div
                        className="absolute -bottom-1 left-1/2 -translate-x-1/2 px-2 py-0.5 rounded-full flex items-center gap-1"
                        style={{ backgroundColor: COLORS.primary }}
                      >
                        <Dumbbell size={10} color={COLORS.text} />
                        <span className="text-xs font-bold" style={{ color: COLORS.text }}>{friend.workoutDuration}m</span>
                      </div>
                    </div>
                    <p className="text-xs mt-2 max-w-[70px] truncate" style={{ color: COLORS.textSecondary }}>
                      {friend.name.split(' ')[0]}
                    </p>
                  </button>
                ))}
              </div>
            </div>
          )}

          {/* All Following */}
          <p className="text-xs font-semibold mb-3" style={{ color: COLORS.textMuted }}>FOLLOWING ({friends.length})</p>

          {friends.length === 0 ? (
            <div className="p-6 rounded-xl text-center" style={{ backgroundColor: COLORS.surface }}>
              <UserPlus size={40} color={COLORS.primary} className="mx-auto mb-3" style={{ opacity: 0.7 }} />
              <p className="text-sm font-medium" style={{ color: COLORS.text }}>Not following anyone yet</p>
              <p className="text-xs mt-1" style={{ color: COLORS.textMuted }}>Search for users or discover top athletes to follow!</p>
              <button
                onClick={() => setFriendsTab('discover')}
                className="mt-3 px-4 py-2 rounded-lg text-sm font-semibold"
                style={{ backgroundColor: COLORS.primary, color: COLORS.text }}
              >
                Discover People
              </button>
            </div>
          ) : (
            <div className="space-y-2">
              {friends.map(friend => (
                <button
                  key={friend.id}
                  onClick={() => setShowFriendProfile(friend)}
                  className="w-full p-4 rounded-xl flex items-center justify-between"
                  style={{ backgroundColor: COLORS.surface }}
                >
                  <div className="flex items-center gap-3">
                    <div className="relative">
                      <div
                        className="w-12 h-12 rounded-full flex items-center justify-center text-xl"
                        style={{
                          backgroundColor: friend.workoutStatus === 'working_out' ? COLORS.primary + '30' :
                                          friend.workoutStatus === 'just_finished' ? COLORS.success + '20' :
                                          COLORS.surfaceLight,
                          border: friend.workoutStatus ? `2px solid ${friend.workoutStatus === 'working_out' ? COLORS.primary : COLORS.success}` : 'none'
                        }}
                      >
                        {typeof friend.avatar === 'string' && friend.avatar.length === 1 ? friend.avatar : '?'}
                      </div>
                      {friend.isOnline && !friend.workoutStatus && (
                        <div
                          className="absolute bottom-0 right-0 w-3 h-3 rounded-full border-2"
                          style={{ backgroundColor: COLORS.success, borderColor: COLORS.surface }}
                        />
                      )}
                    </div>
                    <div className="text-left">
                      <p className="font-semibold" style={{ color: COLORS.text }}>{friend.name}</p>
                      <p className="text-xs" style={{ color: COLORS.textMuted }}>@{friend.username}</p>
                    </div>
                  </div>
                  <div className="text-right">
                    <button
                      onClick={(e) => { e.stopPropagation(); setShowFriendStreakCalendar(friend); }}
                      className="flex items-center gap-1 justify-end px-2 py-1 rounded-lg mb-1"
                      style={{ backgroundColor: COLORS.warning + '15' }}
                    >
                      <Flame size={14} color={COLORS.warning} />
                      <span className="font-bold" style={{ color: COLORS.warning }}>{friend.streak}</span>
                    </button>
                    <p className="text-xs" style={{ color: COLORS.textMuted }}>{friend.lastActive}</p>
                  </div>
                </button>
              ))}
            </div>
          )}
        </>
      )}

      {/* DISCOVER TAB - Top Followed Users */}
      {friendsTab === 'discover' && (
        <>
          {/* Time Period Filter */}
          <div className="mb-4">
            <p className="text-xs font-semibold mb-2" style={{ color: COLORS.textMuted }}>TOP FOLLOWED</p>
            <div className="flex gap-2">
              {[
                { id: 'all', label: 'All Time' },
                { id: '7', label: '7 Days' },
                { id: '14', label: '14 Days' },
                { id: '31', label: '31 Days' },
              ].map(period => (
                <button
                  key={period.id}
                  onClick={() => setTopFollowedPeriod(period.id)}
                  className="flex-1 py-2 rounded-lg text-xs font-semibold"
                  style={{
                    backgroundColor: topFollowedPeriod === period.id ? COLORS.primary : COLORS.surface,
                    color: topFollowedPeriod === period.id ? COLORS.text : COLORS.textMuted
                  }}
                >
                  {period.label}
                </button>
              ))}
            </div>
          </div>

          {/* Top Followed Leaderboard */}
          {topFollowedLoading ? (
            <div className="flex items-center justify-center py-8">
              <Loader2 size={24} className="animate-spin" color={COLORS.primary} />
            </div>
          ) : topFollowedUsers.length === 0 ? (
            <div className="p-6 rounded-xl text-center" style={{ backgroundColor: COLORS.surface }}>
              <Trophy size={40} color={COLORS.primary} className="mx-auto mb-3" style={{ opacity: 0.7 }} />
              <p className="text-sm font-medium" style={{ color: COLORS.text }}>Leaderboard Coming Soon</p>
              <p className="text-xs mt-1" style={{ color: COLORS.textMuted }}>Follow others and build your network - top creators will appear here!</p>
            </div>
          ) : (
            <div className="space-y-3">
              {[...(topFollowedUsers || [])]
                .filter(u => u && u.id)
                .sort((a, b) => {
                  if (topFollowedPeriod === 'all') {
                    return (b?.followers || 0) - (a?.followers || 0);
                  }
                  return (b?.followedRecently || 0) - (a?.followedRecently || 0);
                })
                .map((user, index) => (
                  <div
                    key={user.id}
                    className="p-4 rounded-xl flex items-center gap-3"
                    style={{ backgroundColor: COLORS.surface }}
                  >
                    {/* Rank */}
                    <div
                      className="w-8 h-8 rounded-full flex items-center justify-center text-sm font-bold flex-shrink-0"
                      style={{
                        backgroundColor: index === 0 ? '#FFD700' : index === 1 ? '#C0C0C0' : index === 2 ? '#CD7F32' : COLORS.surfaceLight,
                        color: index < 3 ? COLORS.background : COLORS.text
                      }}
                    >
                      {index + 1}
                    </div>

                    {/* Avatar */}
                    <div
                      className="w-12 h-12 rounded-full flex items-center justify-center text-lg font-bold flex-shrink-0"
                      style={{ backgroundColor: COLORS.primary + '30', color: COLORS.primary }}
                    >
                      {user.avatar || user.name?.[0]?.toUpperCase() || 'U'}
                    </div>

                    {/* Info */}
                    <div className="flex-1 min-w-0">
                      <p className="font-semibold truncate" style={{ color: COLORS.text }}>{user.name || 'User'}</p>
                      <p className="text-xs" style={{ color: COLORS.textMuted }}>@{user.username || 'user'}</p>
                      <div className="flex items-center gap-2 mt-1">
                        {(user.streak || 0) > 0 && (
                          <span className="text-xs flex items-center gap-1" style={{ color: COLORS.warning }}>
                            <Flame size={10} /> {user.streak}
                          </span>
                        )}
                      </div>
                    </div>

                    {/* Followers Count & Follow Button */}
                    <div className="text-right flex-shrink-0">
                      <p className="text-lg font-bold" style={{ color: COLORS.text }}>
                        {topFollowedPeriod === 'all'
                          ? ((user.followers || 0) >= 1000 ? `${((user.followers || 0) / 1000).toFixed(1)}k` : (user.followers || 0))
                          : `+${user.followedRecently || 0}`
                        }
                      </p>
                      <p className="text-xs mb-2" style={{ color: COLORS.textMuted }}>
                        {topFollowedPeriod === 'all' ? 'followers' : 'new'}
                      </p>
                      <button
                        onClick={() => user?.id && handleFollowUser(user.id)}
                        className="px-3 py-1 rounded-lg text-xs font-semibold"
                        style={{
                          backgroundColor: followingIds?.has?.(user?.id) ? COLORS.surfaceLight : COLORS.primary + '20',
                          color: followingIds?.has?.(user?.id) ? COLORS.textMuted : COLORS.primary
                        }}
                      >
                        {followingIds?.has?.(user?.id) ? 'Following' : 'Follow'}
                      </button>
                    </div>
                  </div>
                ))}
            </div>
          )}

          {/* Suggested For You Section */}
          {(suggestedFriends || []).length > 0 && (
            <div className="mt-6">
              <p className="text-xs font-semibold mb-3" style={{ color: COLORS.textMuted }}>SUGGESTED FOR YOU</p>
              <div className="space-y-2">
                {(suggestedFriends || []).slice(0, 4).filter(s => s && s.id).map(suggested => (
                  <div
                    key={suggested.id}
                    className="p-3 rounded-xl flex items-center gap-3"
                    style={{ backgroundColor: COLORS.surface }}
                  >
                    <div
                      className="w-10 h-10 rounded-full flex items-center justify-center text-lg font-bold"
                      style={{ backgroundColor: COLORS.primary + '30', color: COLORS.primary }}
                    >
                      {suggested.avatar || suggested.name?.[0]?.toUpperCase() || 'U'}
                    </div>
                    <div className="flex-1 min-w-0">
                      <p className="font-semibold text-sm truncate" style={{ color: COLORS.text }}>{suggested.name || 'User'}</p>
                      <p className="text-xs" style={{ color: COLORS.textMuted }}>{suggested.followers || 0} followers</p>
                    </div>
                    <button
                      onClick={() => suggested?.id && handleFollowUser(suggested.id)}
                      className="px-3 py-1.5 rounded-lg text-xs font-semibold"
                      style={{
                        backgroundColor: followingIds?.has?.(suggested?.id) ? COLORS.surfaceLight : COLORS.primary,
                        color: followingIds?.has?.(suggested?.id) ? COLORS.textMuted : COLORS.text
                      }}
                    >
                      {followingIds?.has?.(suggested?.id) ? 'Following' : 'Follow'}
                    </button>
                  </div>
                ))}
              </div>
            </div>
          )}
        </>
      )}

      {/* CHALLENGES TAB */}
      {friendsTab === 'challenges' && (
        <>
          {/* Active Challenges */}
          <p className="text-xs font-semibold mb-3" style={{ color: COLORS.textMuted }}>YOUR CHALLENGES</p>
          <div className="space-y-4 mb-6">
            {challenges.filter(c => c.joined).map(challenge => (
              <div key={challenge.id} className="p-4 rounded-xl" style={{ backgroundColor: COLORS.surface }}>
                <div className="flex items-center justify-between mb-3">
                  <div>
                    <div className="flex items-center gap-2">
                      <Trophy size={18} color={COLORS.warning} />
                      <h5 className="font-bold" style={{ color: COLORS.text }}>{challenge.name}</h5>
                    </div>
                    <p className="text-xs" style={{ color: COLORS.textMuted }}>{challenge.description}</p>
                  </div>
                  <div className="text-right">
                    <p className="text-xs" style={{ color: COLORS.textMuted }}>Ends</p>
                    <p className="text-sm font-semibold" style={{ color: COLORS.text }}>{challenge.endDate}</p>
                  </div>
                </div>

                {/* Leaderboard */}
                <div className="space-y-2">
                  {challenge.participants.slice(0, 4).map((participant, index) => (
                    <div
                      key={participant.id}
                      className="flex items-center justify-between p-2 rounded-lg"
                      style={{
                        backgroundColor: participant.id === 'you' ? COLORS.primary + '20' : COLORS.surfaceLight
                      }}
                    >
                      <div className="flex items-center gap-2">
                        <div
                          className="w-6 h-6 rounded-full flex items-center justify-center text-xs font-bold"
                          style={{
                            backgroundColor: index === 0 ? '#FFD700' : index === 1 ? '#C0C0C0' : index === 2 ? '#CD7F32' : COLORS.surface,
                            color: index < 3 ? COLORS.background : COLORS.text
                          }}
                        >
                          {index + 1}
                        </div>
                        <span className="text-lg">{participant.avatar}</span>
                        <span
                          className="text-sm font-medium"
                          style={{ color: participant.id === 'you' ? COLORS.primary : COLORS.text }}
                        >
                          {participant.name}
                        </span>
                      </div>
                      <span className="font-bold" style={{ color: COLORS.text }}>
                        {challenge.type === 'volume' ? `${(participant.score / 1000).toFixed(1)}k` : participant.score}
                        {challenge.type === 'workouts' && ' workouts'}
                        {challenge.type === 'streak' && ' days'}
                        {challenge.type === 'volume' && ' kg'}
                      </span>
                    </div>
                  ))}
                </div>
              </div>
            ))}
          </div>

          {/* Available Challenges */}
          <p className="text-xs font-semibold mb-3" style={{ color: COLORS.textMuted }}>JOIN A CHALLENGE</p>
          <div className="space-y-3">
            {challenges.filter(c => !c.joined).map(challenge => (
              <div key={challenge.id} className="p-4 rounded-xl" style={{ backgroundColor: COLORS.surface }}>
                <div className="flex items-center justify-between">
                  <div>
                    <div className="flex items-center gap-2">
                      <Trophy size={16} color={COLORS.textMuted} />
                      <h5 className="font-semibold" style={{ color: COLORS.text }}>{challenge.name}</h5>
                    </div>
                    <p className="text-xs" style={{ color: COLORS.textMuted }}>{challenge.description}</p>
                    <p className="text-xs mt-1" style={{ color: COLORS.textSecondary }}>
                      {challenge.participants.length} friends participating
                    </p>
                  </div>
                  <button
                    className="px-4 py-2 rounded-xl text-sm font-semibold"
                    style={{ backgroundColor: COLORS.primary, color: COLORS.text }}
                  >
                    Join
                  </button>
                </div>
              </div>
            ))}
          </div>

          {/* Create Challenge */}
          <button
            onClick={() => setShowCreateChallenge(true)}
            className="w-full mt-4 p-4 rounded-xl flex items-center justify-center gap-2"
            style={{ backgroundColor: COLORS.surfaceLight, border: `1px dashed ${COLORS.textMuted}` }}
          >
            <Plus size={18} color={COLORS.textMuted} />
            <span style={{ color: COLORS.textMuted }}>Create New Challenge</span>
          </button>
        </>
      )}
    </div>
  );
};

const NutritionTab = ({
  COLORS,
  nutritionSelectedDate,
  setNutritionSelectedDate,
  showDatePicker,
  setShowDatePicker,
  TODAY_DATE_KEY,
  getLocalDateString,
  caloriesIntake,
  setCaloriesIntake,
  proteinIntake,
  setProteinIntake,
  carbsIntake,
  setCarbsIntake,
  fatsIntake,
  setFatsIntake,
  waterIntake,
  setWaterIntake,
  waterLogs,
  setWaterLogs,
  adjustedNutritionGoals,
  nutritionGoals,
  mealLog,
  setMealLog,
  supplements,
  setSupplements,
  supplementsLoading,
  setSupplementsLoading,
  supplementHistory,
  setSupplementHistory,
  userData,
  user,
  nutritionTab,
  setNutritionTab,
  showMacroDetail,
  setShowMacroDetail,
  showAddSupplement,
  setShowAddSupplement,
  setShowAddMealFull,
  setShowWaterEntry,
  setShowWaterHistory,
  setShowMealHistory,
  dismissedSuggestions,
  setDismissedSuggestions,
  backdateNutrition,
  setBackdateNutrition,
  lastNightBedTime,
  setLastNightBedTime,
  lastNightWakeTime,
  setLastNightWakeTime,
  lastNightConfirmed,
  setLastNightConfirmed,
  sleepHours,
  sleepChartView,
  setSleepChartView,
  selectedSleepDate,
  setSelectedSleepDate,
  monthlyTracking,
  setMonthlyTracking,
  sleepEditRefs,
  streaks,
  setStreaks,
  nutritionService,
  sleepService,
  weeklyNutrition,
  nutritionTabScrollRef,
}) => {
  const handleScroll = (e) => {
    if (nutritionTabScrollRef?.current !== undefined) {
      nutritionTabScrollRef.current = e.target.scrollTop;
    }
  };

  return (
          <>
          <div
            ref={(el) => {
              if (el && nutritionTabScrollRef?.current && typeof nutritionTabScrollRef.current === 'number') {
                el.scrollTop = nutritionTabScrollRef.current;
              }
            }}
            onScroll={handleScroll}
            className="p-4 h-full overflow-auto">
            {/* Date Selector - allows backdating entries */}
            <div className="mb-4">
              <div className="flex items-center justify-between p-3 rounded-xl" style={{ backgroundColor: COLORS.surface }}>
                <button
                  onClick={() => {
                    const currentDate = new Date(nutritionSelectedDate);
                    currentDate.setDate(currentDate.getDate() - 1);
                    const minDate = new Date();
                    minDate.setDate(minDate.getDate() - 7); // Max 7 days back
                    if (currentDate >= minDate) {
                      setNutritionSelectedDate(getLocalDateString(currentDate));
                    }
                  }}
                  className="p-2 rounded-lg"
                  style={{ backgroundColor: COLORS.surfaceLight }}
                >
                  <ChevronLeft size={18} color={COLORS.text} />
                </button>
                <button
                  onClick={() => setShowDatePicker(!showDatePicker)}
                  className="flex items-center gap-2 px-4 py-2 rounded-lg"
                  style={{ backgroundColor: nutritionSelectedDate !== TODAY_DATE_KEY ? COLORS.primary + '20' : 'transparent' }}
                >
                  <Calendar size={16} color={nutritionSelectedDate !== TODAY_DATE_KEY ? COLORS.primary : COLORS.textMuted} />
                  <span className="font-semibold" style={{ color: nutritionSelectedDate !== TODAY_DATE_KEY ? COLORS.primary : COLORS.text }}>
                    {nutritionSelectedDate === TODAY_DATE_KEY ? 'Today' :
                     new Date(nutritionSelectedDate).toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' })}
                  </span>
                  {nutritionSelectedDate !== TODAY_DATE_KEY && (
                    <span className="text-xs px-2 py-0.5 rounded-full" style={{ backgroundColor: COLORS.warning + '30', color: COLORS.warning }}>
                      Backdating
                    </span>
                  )}
                </button>
                <button
                  onClick={() => {
                    const currentDate = new Date(nutritionSelectedDate);
                    currentDate.setDate(currentDate.getDate() + 1);
                    const today = new Date();
                    today.setHours(0, 0, 0, 0);
                    const nextDate = new Date(currentDate);
                    nextDate.setHours(0, 0, 0, 0);
                    if (nextDate <= today) {
                      setNutritionSelectedDate(getLocalDateString(currentDate));
                    }
                  }}
                  disabled={nutritionSelectedDate === TODAY_DATE_KEY}
                  className="p-2 rounded-lg"
                  style={{ backgroundColor: nutritionSelectedDate !== TODAY_DATE_KEY ? COLORS.surfaceLight : COLORS.surface, opacity: nutritionSelectedDate !== TODAY_DATE_KEY ? 1 : 0.5 }}
                >
                  <ChevronRight size={18} color={COLORS.text} />
                </button>
              </div>

              {/* Quick Date Picker */}
              {showDatePicker && (
                <div className="mt-2 p-3 rounded-xl" style={{ backgroundColor: COLORS.surface }}>
                  {/* Date Options Grid - 4x2 with Today in top-right */}
                  <div className="grid grid-cols-4 gap-2">
                    {Array.from({ length: 8 }, (_, i) => {
                      // Layout: [Day-3, Day-2, Yesterday, TODAY]
                      //         [Day-7, Day-6, Day-5, Day-4]
                      // Map grid position to day index
                      let dayIndex;
                      if (i < 4) {
                        // Top row: positions 0-3 map to days 3,2,1,0
                        dayIndex = 3 - i;
                      } else {
                        // Bottom row: positions 4-7 map to days 7,6,5,4
                        dayIndex = 11 - i;
                      }

                      const date = new Date();
                      date.setDate(date.getDate() - dayIndex);
                      const dateStr = getLocalDateString(date);
                      const isSelected = nutritionSelectedDate === dateStr;
                      const isToday = dayIndex === 0;

                      return (
                        <button
                          key={dateStr}
                          onClick={() => {
                            setNutritionSelectedDate(dateStr);
                            setShowDatePicker(false);
                          }}
                          className="p-2 rounded-lg text-center"
                          style={{
                            backgroundColor: isToday ? COLORS.primary : (isSelected ? COLORS.primary + '80' : COLORS.surfaceLight),
                            border: isSelected && !isToday ? `2px solid ${COLORS.primary}` : 'none'
                          }}
                        >
                          <p className="text-xs" style={{ color: isToday ? COLORS.text : (isSelected ? COLORS.text : COLORS.textMuted) }}>
                            {dayIndex === 0 ? 'Today' : dayIndex === 1 ? 'Yesterday' : date.toLocaleDateString('en-US', { weekday: 'short' })}
                          </p>
                          <p className="text-sm font-semibold" style={{ color: isToday ? COLORS.text : COLORS.text }}>
                            {date.getDate()}
                          </p>
                        </button>
                      );
                    })}
                  </div>
                </div>
              )}
            </div>

            {/* Tab Navigation */}
            <div className="flex gap-1 mb-6">
              {[
                { id: 'overview', label: 'Overview' },
                { id: 'meals', label: 'Meals' },
                { id: 'supplements', label: 'Supps' },
                { id: 'sleep', label: 'Sleep' },
              ].map(tab => (
                <button
                  key={tab.id}
                  onClick={() => setNutritionTab(tab.id)}
                  className="flex-1 py-2 rounded-xl text-xs font-semibold"
                  style={{
                    backgroundColor: nutritionTab === tab.id ? COLORS.primary : COLORS.surface,
                    color: nutritionTab === tab.id ? COLORS.text : COLORS.textMuted
                  }}
                >
                  {tab.label}
                </button>
              ))}
            </div>

            {/* OVERVIEW TAB */}
            {nutritionTab === 'overview' && (() => {
              // Get weight values from multiple sources for reliability
              const currentW = parseFloat(userData.currentWeight) || overviewStats.currentWeight || 0;
              const goalW = parseFloat(userData.goalWeight) || overviewStats.targetWeight || 0;

              // Always infer from weight targets first - this is more reliable than stored goal
              let effectiveGoal = 'fitness'; // default

              if (goalW > 0 && currentW > 0) {
                // Weight targets are set - use them to determine goal
                if (goalW < currentW) {
                  effectiveGoal = 'lose_fat';
                } else if (goalW > currentW) {
                  effectiveGoal = 'build_muscle';
                } else {
                  // Weights are equal - check stored goal
                  effectiveGoal = userData.goal || 'fitness';
                }
              } else if (userData.goal && ['lose_fat', 'build_muscle', 'strength'].includes(userData.goal)) {
                // No weight data but has explicit goal
                effectiveGoal = userData.goal;
              }

              return (
              <>
                {/* Goal Overview Banner */}
                <div className="p-4 rounded-xl mb-4" style={{
                  backgroundColor: effectiveGoal === 'lose_fat' ? COLORS.error + '15' :
                                   effectiveGoal === 'build_muscle' ? COLORS.success + '15' :
                                   effectiveGoal === 'strength' ? COLORS.primary + '15' : COLORS.accent + '15',
                  border: `1px solid ${effectiveGoal === 'lose_fat' ? COLORS.error + '40' :
                                       effectiveGoal === 'build_muscle' ? COLORS.success + '40' :
                                       effectiveGoal === 'strength' ? COLORS.primary + '40' : COLORS.accent + '40'}`
                }}>
                  <div className="flex items-center gap-3 mb-2">
                    <div className="w-10 h-10 rounded-full flex items-center justify-center" style={{
                      backgroundColor: effectiveGoal === 'lose_fat' ? COLORS.error + '30' :
                                       effectiveGoal === 'build_muscle' ? COLORS.success + '30' :
                                       effectiveGoal === 'strength' ? COLORS.primary + '30' : COLORS.accent + '30'
                    }}>
                      {effectiveGoal === 'lose_fat' && <Flame size={20} color={COLORS.error} />}
                      {effectiveGoal === 'build_muscle' && <Target size={20} color={COLORS.success} />}
                      {effectiveGoal === 'strength' && <Dumbbell size={20} color={COLORS.primary} />}
                      {!['lose_fat', 'build_muscle', 'strength'].includes(effectiveGoal) && <Heart size={20} color={COLORS.accent} />}
                    </div>
                    <div>
                      <p className="font-bold" style={{ color: COLORS.text }}>
                        {effectiveGoal === 'lose_fat' ? 'Fat Loss Mode' :
                         effectiveGoal === 'build_muscle' ? 'Muscle Building Mode' :
                         effectiveGoal === 'strength' ? 'Strength Building Mode' : 'General Fitness'}
                      </p>
                      <p className="text-xs" style={{ color: COLORS.textSecondary }}>
                        {effectiveGoal === 'lose_fat' ? 'Stay in a calorie deficit to lose fat' :
                         effectiveGoal === 'build_muscle' ? 'Eat in a surplus to support muscle growth' :
                         effectiveGoal === 'strength' ? 'Fuel your training with adequate calories' : 'Maintain balanced nutrition'}
                      </p>
                    </div>
                  </div>
                  <div className="flex items-center justify-between p-3 rounded-lg" style={{ backgroundColor: COLORS.background + '50' }}>
                    <div>
                      <p className="text-xs" style={{ color: COLORS.textMuted }}>
                        Daily Target{adjustedNutritionGoals.adjustments?.calories > 0 ? ' (adjusted)' : ''}
                      </p>
                      <p className="text-lg font-bold" style={{ color: COLORS.text }}>{adjustedNutritionGoals.calories} kcal</p>
                      {adjustedNutritionGoals.adjustments?.calories > 0 && effectiveGoal !== 'lose_fat' && (
                        <p className="text-xs" style={{ color: COLORS.primary }}>
                          +{adjustedNutritionGoals.adjustments.calories} catch-up
                        </p>
                      )}
                    </div>
                    <div className="text-right">
                      <p className="text-xs" style={{ color: COLORS.textMuted }}>Remaining</p>
                      <p className="text-lg font-bold" style={{
                        color: (adjustedNutritionGoals.calories - (nutritionSelectedDate === TODAY_DATE_KEY ? caloriesIntake : (backdateNutrition?.calories || 0))) < 0
                          ? (effectiveGoal === 'lose_fat' ? COLORS.error : COLORS.success)
                          : (effectiveGoal === 'lose_fat' ? COLORS.success : COLORS.warning)
                      }}>
                        {adjustedNutritionGoals.calories - (nutritionSelectedDate === TODAY_DATE_KEY ? caloriesIntake : (backdateNutrition?.calories || 0))} kcal
                      </p>
                    </div>
                    <div className="px-3 py-1 rounded-full" style={{
                      backgroundColor: effectiveGoal === 'lose_fat'
                        ? ((nutritionSelectedDate === TODAY_DATE_KEY ? caloriesIntake : (backdateNutrition?.calories || 0)) <= adjustedNutritionGoals.calories ? COLORS.success + '30' : COLORS.error + '30')
                        : ((nutritionSelectedDate === TODAY_DATE_KEY ? caloriesIntake : (backdateNutrition?.calories || 0)) >= adjustedNutritionGoals.calories * 0.9 ? COLORS.success + '30' : COLORS.warning + '30')
                    }}>
                      <p className="text-xs font-semibold" style={{
                        color: effectiveGoal === 'lose_fat'
                          ? ((nutritionSelectedDate === TODAY_DATE_KEY ? caloriesIntake : (backdateNutrition?.calories || 0)) <= adjustedNutritionGoals.calories ? COLORS.success : COLORS.error)
                          : ((nutritionSelectedDate === TODAY_DATE_KEY ? caloriesIntake : (backdateNutrition?.calories || 0)) >= adjustedNutritionGoals.calories * 0.9 ? COLORS.success : COLORS.warning)
                      }}>
                        {effectiveGoal === 'lose_fat'
                          ? ((nutritionSelectedDate === TODAY_DATE_KEY ? caloriesIntake : (backdateNutrition?.calories || 0)) <= adjustedNutritionGoals.calories ? ' On Track' : ' Over')
                          : ((nutritionSelectedDate === TODAY_DATE_KEY ? caloriesIntake : (backdateNutrition?.calories || 0)) >= adjustedNutritionGoals.calories * 0.9 ? ' On Track' : ' Eat More')}
                      </p>
                    </div>
                  </div>
                </div>

                {/* Today's Macros */}
                <p className="text-xs font-semibold mb-3" style={{ color: COLORS.textMuted }}>
                  {nutritionSelectedDate === TODAY_DATE_KEY ? "TODAY'S NUTRITION" : `NUTRITION - ${new Date(nutritionSelectedDate).toLocaleDateString('en-US', { month: 'short', day: 'numeric' }).toUpperCase()}`}
                </p>
                <div className="mb-6">
                  {/* Quick Add Section - Side by Side */}
                  <div className="grid grid-cols-2 gap-3 mb-4">
                    {/* Left: Add Meal */}
                    <div className="p-3 rounded-xl" style={{ backgroundColor: COLORS.surface }}>
                      <div className="flex items-center gap-2 mb-3">
                        <div className="w-7 h-7 rounded-full flex items-center justify-center" style={{ backgroundColor: COLORS.accent + '20' }}>
                          <Utensils size={14} color={COLORS.accent} />
                        </div>
                        <p className="font-semibold text-xs" style={{ color: COLORS.text }}>Add Meal</p>
                      </div>
                      <button
                        onClick={() => setShowAddMealFull(true)}
                        className="w-full py-2 rounded-lg flex items-center justify-center gap-1 mb-3"
                        style={{ backgroundColor: COLORS.accent + '20', border: `1px solid ${COLORS.accent}40` }}
                      >
                        <span className="text-xs font-semibold" style={{ color: COLORS.accent }}>Log Meal</span>
                      </button>
                      {/* Macro Rings */}
                      <div className="flex justify-around gap-2">
                        {[
                          { name: 'Protein', key: 'P', id: 'protein', current: nutritionSelectedDate === TODAY_DATE_KEY ? proteinIntake : (backdateNutrition?.protein || 0), target: adjustedNutritionGoals.protein, unit: 'g', color: COLORS.primary },
                          { name: 'Carbs', key: 'C', id: 'carbs', current: nutritionSelectedDate === TODAY_DATE_KEY ? carbsIntake : (backdateNutrition?.carbs || 0), target: nutritionGoals.carbs, unit: 'g', color: COLORS.warning },
                        ].map(macro => {
                          const percentage = Math.min(100, (macro.current / macro.target) * 100);
                          const circumference = 2 * Math.PI * 16;
                          const strokeDasharray = `${(percentage / 100) * circumference} ${circumference}`;

                          return (
                            <button
                              type="button"
                              key={macro.name}
                              onClick={(e) => {
                                e.preventDefault();
                                e.stopPropagation();
                                console.log('=== MACRO CLICK START ===');
                                console.log('Macro clicked:', macro.id);
                                console.log('Current showMacroDetail before:', showMacroDetail);

                                // Use functional update to ensure we get latest state
                                setShowMacroDetail(prev => {
                                  console.log('Previous showMacroDetail:', prev);
                                  console.log('Setting to:', macro.id);
                                  return macro.id;
                                });

                                console.log('=== MACRO CLICK END ===');
                              }}
                              className="flex-1 flex flex-col items-center"
                              style={{ cursor: 'pointer', WebkitTapHighlightColor: 'transparent' }}
                            >
                              <p className="text-xs font-semibold mb-1" style={{ color: COLORS.text }}>{macro.name}</p>
                              <div className="relative w-12 h-12">
                                <svg className="w-full h-full transform -rotate-90">
                                  <circle cx="24" cy="24" r="16" stroke={COLORS.surfaceLight} strokeWidth="3" fill="none" />
                                  <circle
                                    cx="24" cy="24" r="16"
                                    stroke={macro.color}
                                    strokeWidth="3"
                                    fill="none"
                                    strokeDasharray={strokeDasharray}
                                    strokeLinecap="round"
                                  />
                                </svg>
                                <div className="absolute inset-0 flex items-center justify-center">
                                  <span className="text-xs font-bold" style={{ color: COLORS.text }}>{Math.round(percentage)}%</span>
                                </div>
                              </div>
                            </button>
                          );
                        })}
                      </div>
                    </div>

                    {/* Right: Quick Add Water */}
                    <div className="p-3 rounded-xl" style={{ backgroundColor: COLORS.surface }}>
                      <div className="flex items-center gap-2 mb-3">
                        <div className="w-7 h-7 rounded-full flex items-center justify-center" style={{ backgroundColor: COLORS.water + '20' }}>
                          <Droplets size={14} color={COLORS.water} />
                        </div>
                        <p className="font-semibold text-xs" style={{ color: COLORS.text }}>Quick Water</p>
                      </div>
                      <div className="grid grid-cols-2 gap-1.5">
                        {[
                          { label: '100ml', amount: 100 },
                          { label: '200ml', amount: 200 },
                          { label: '250ml', amount: 250 },
                          { label: '500ml', amount: 500 },
                          { label: '1L', amount: 1000 },
                          { label: '+', amount: null },
                        ].map((opt, idx) => (
                          <button
                            key={idx}
                            onClick={async (e) => {
                              e.preventDefault();
                              if (opt.amount === null) {
                                setShowWaterEntry(true);
                                return;
                              }
                              const targetDate = nutritionSelectedDate !== TODAY_DATE_KEY ? nutritionSelectedDate : null;
                              if (targetDate) {
                                // Backdate water entry
                                if (user?.id) {
                                  const { data } = await nutritionService.logWater(user.id, opt.amount, targetDate);
                                  if (data) {
                                    setWaterLogs(prev => [...prev, data]);
                                  }
                                  setBackdateNutrition(prev => prev ? {
                                    ...prev,
                                    water: (prev.water || 0) + opt.amount,
                                  } : { water: opt.amount, calories: 0, protein: 0, carbs: 0, fats: 0, meals: [] });
                                }
                              } else {
                                // Today's water - optimistic update
                                const tempId = `temp-${Date.now()}`;
                                const tempLog = { id: tempId, amount_ml: opt.amount, logged_at: new Date().toISOString() };
                                setWaterIntake(prev => Math.min(prev + opt.amount, 10000));
                                setWaterLogs(prev => [...prev, tempLog]);

                                // Save to database in background and update with real ID
                                if (user?.id) {
                                  nutritionService.logWater(user.id, opt.amount).then(({ data }) => {
                                    if (data) {
                                      setWaterLogs(prev => prev.map(l => l.id === tempId ? data : l));
                                    }
                                  });
                                }
                              }
                            }}
                            className="py-1.5 rounded-lg text-center"
                            style={{
                              backgroundColor: opt.amount === null ? COLORS.surfaceLight : COLORS.water + '15',
                              border: opt.amount === null ? 'none' : `1px solid ${COLORS.water}30`
                            }}
                          >
                            <p className="text-xs font-bold" style={{ color: opt.amount === null ? COLORS.textMuted : COLORS.water }}>
                              {opt.label}
                            </p>
                          </button>
                        ))}
                      </div>
                    </div>
                  </div>

                  <div className="grid grid-cols-2 gap-3">
                    {/* Calories Circle */}
                    <div className="p-4 rounded-xl relative" style={{ backgroundColor: COLORS.surface }}>
                      <button
                        onClick={() => setShowMealHistory(true)}
                        className="absolute top-2 right-2 p-1.5 rounded-full"
                        style={{ backgroundColor: COLORS.surfaceLight }}
                      >
                        <Settings size={14} color={COLORS.textMuted} />
                      </button>
                      <div className="flex items-center justify-center mb-2">
                        <div className="relative w-24 h-24">
                          <svg className="w-full h-full transform -rotate-90">
                            <circle cx="48" cy="48" r="40" stroke={COLORS.surfaceLight} strokeWidth="8" fill="none" />
                            <circle
                              cx="48" cy="48" r="40"
                              stroke={COLORS.accent}
                              strokeWidth="8"
                              fill="none"
                              strokeDasharray={`${((nutritionSelectedDate === TODAY_DATE_KEY ? caloriesIntake : (backdateNutrition?.calories || 0)) / adjustedNutritionGoals.calories) * 251} 251`}
                              strokeLinecap="round"
                            />
                          </svg>
                          <div className="absolute inset-0 flex flex-col items-center justify-center">
                            <Flame size={16} color={COLORS.accent} />
                            <span className="text-lg font-bold" style={{ color: COLORS.text }}>{nutritionSelectedDate === TODAY_DATE_KEY ? caloriesIntake : (backdateNutrition?.calories || 0)}</span>
                          </div>
                        </div>
                      </div>
                      <p className="text-center text-sm font-semibold" style={{ color: COLORS.text }}>Calories</p>
                      <p className="text-center text-xs" style={{ color: COLORS.textMuted }}>{adjustedNutritionGoals.calories - (nutritionSelectedDate === TODAY_DATE_KEY ? caloriesIntake : (backdateNutrition?.calories || 0))} remaining</p>
                    </div>

                    {/* Water Circle */}
                    <div className="p-4 rounded-xl relative" style={{ backgroundColor: COLORS.surface }}>
                      <button
                        onClick={async () => {
                          // Load water logs before showing modal
                          if (user?.id) {
                            const targetDate = nutritionSelectedDate !== TODAY_DATE_KEY ? nutritionSelectedDate : TODAY_DATE_KEY;
                            const { data } = await nutritionService.getWaterLogs(user.id, targetDate);
                            setWaterLogs(data || []);
                          }
                          setShowWaterHistory(true);
                        }}
                        className="absolute top-2 right-2 p-1.5 rounded-full"
                        style={{ backgroundColor: COLORS.surfaceLight }}
                      >
                        <Settings size={14} color={COLORS.textMuted} />
                      </button>
                      <div className="flex items-center justify-center mb-2">
                        <div className="relative w-24 h-24">
                          <svg className="w-full h-full transform -rotate-90">
                            <circle cx="48" cy="48" r="40" stroke={COLORS.surfaceLight} strokeWidth="8" fill="none" />
                            <circle
                              cx="48" cy="48" r="40"
                              stroke={COLORS.water}
                              strokeWidth="8"
                              fill="none"
                              strokeDasharray={`${((nutritionSelectedDate === TODAY_DATE_KEY ? waterIntake : (backdateNutrition?.water || 0)) / adjustedNutritionGoals.water) * 251} 251`}
                              strokeLinecap="round"
                            />
                          </svg>
                          <div className="absolute inset-0 flex flex-col items-center justify-center">
                            <Droplets size={16} color={COLORS.water} />
                            <span className="text-lg font-bold" style={{ color: COLORS.text }}>{((nutritionSelectedDate === TODAY_DATE_KEY ? waterIntake : (backdateNutrition?.water || 0)) / 1000).toFixed(1)}L</span>
                          </div>
                        </div>
                      </div>
                      <p className="text-center text-sm font-semibold" style={{ color: COLORS.text }}>Water</p>
                      <p className="text-center text-xs" style={{ color: COLORS.textMuted }}>{((adjustedNutritionGoals.water - (nutritionSelectedDate === TODAY_DATE_KEY ? waterIntake : (backdateNutrition?.water || 0))) / 1000).toFixed(1)}L remaining</p>
                    </div>
                  </div>

                  {/* Recent Entries Section */}
                  <div className="grid grid-cols-2 gap-3 mt-3">
                    {/* Recent Meals */}
                    <div className="p-3 rounded-xl" style={{ backgroundColor: COLORS.surface }}>
                      <div className="flex items-center justify-between mb-2">
                        <p className="text-xs font-semibold" style={{ color: COLORS.textMuted }}>Recent Meals</p>
                        <button
                          onClick={() => setShowMealHistory(true)}
                          className="text-xs"
                          style={{ color: COLORS.accent }}
                        >
                          See all
                        </button>
                      </div>
                      <div className="space-y-2">
                        {(nutritionSelectedDate === TODAY_DATE_KEY ? mealLog : (backdateNutrition?.meals || [])).slice(-3).reverse().map((meal, idx) => (
                          <div key={meal.id || idx} className="flex items-center justify-between p-2 rounded-lg" style={{ backgroundColor: COLORS.surfaceLight }}>
                            <div className="flex-1 min-w-0">
                              <p className="text-xs font-semibold truncate" style={{ color: COLORS.text }}>{meal.name}</p>
                              <p className="text-xs" style={{ color: COLORS.accent }}>{meal.calories} cal</p>
                            </div>
                            <button
                              onClick={async () => {
                                if (!user?.id || !meal.id) return;
                                const targetDate = nutritionSelectedDate !== TODAY_DATE_KEY ? nutritionSelectedDate : TODAY_DATE_KEY;
                                await nutritionService.deleteMeal(meal.id, user.id, targetDate);
                                if (nutritionSelectedDate === TODAY_DATE_KEY) {
                                  setMealLog(prev => prev.filter(m => m.id !== meal.id));
                                  setCaloriesIntake(prev => prev - meal.calories);
                                  setProteinIntake(prev => prev - meal.protein);
                                  setCarbsIntake(prev => prev - meal.carbs);
                                  setFatsIntake(prev => prev - meal.fats);
                                } else {
                                  setBackdateNutrition(prev => prev ? {
                                    ...prev,
                                    calories: (prev.calories || 0) - meal.calories,
                                    protein: (prev.protein || 0) - meal.protein,
                                    carbs: (prev.carbs || 0) - meal.carbs,
                                    fats: (prev.fats || 0) - meal.fats,
                                    meals: (prev.meals || []).filter(m => m.id !== meal.id),
                                  } : null);
                                }
                              }}
                              className="p-1 ml-2"
                            >
                              <X size={12} color={COLORS.error} />
                            </button>
                          </div>
                        ))}
                        {(nutritionSelectedDate === TODAY_DATE_KEY ? mealLog : (backdateNutrition?.meals || [])).length === 0 && (
                          <p className="text-xs text-center py-2" style={{ color: COLORS.textMuted }}>No meals yet</p>
                        )}
                      </div>
                    </div>

                    {/* Recent Water */}
                    <div className="p-3 rounded-xl" style={{ backgroundColor: COLORS.surface }}>
                      <div className="flex items-center justify-between mb-2">
                        <p className="text-xs font-semibold" style={{ color: COLORS.textMuted }}>Recent Water</p>
                        <button
                          onClick={async () => {
                            if (user?.id) {
                              const targetDate = nutritionSelectedDate !== TODAY_DATE_KEY ? nutritionSelectedDate : TODAY_DATE_KEY;
                              const { data } = await nutritionService.getWaterLogs(user.id, targetDate);
                              setWaterLogs(data || []);
                            }
                            setShowWaterHistory(true);
                          }}
                          className="text-xs"
                          style={{ color: COLORS.water }}
                        >
                          See all
                        </button>
                      </div>
                      <div className="space-y-2">
                        {(() => {
                          // We need to load water logs for display - use a simple approach
                          const displayLogs = waterLogs.slice(-3).reverse();
                          return displayLogs.length > 0 ? displayLogs.map((log, idx) => (
                            <div key={log.id || idx} className="flex items-center justify-between p-2 rounded-lg" style={{ backgroundColor: COLORS.surfaceLight }}>
                              <div className="flex-1">
                                <p className="text-xs font-semibold" style={{ color: COLORS.text }}>{log.amount_ml}ml</p>
                                <p className="text-xs" style={{ color: COLORS.textMuted }}>
                                  {new Date(log.logged_at || log.created_at).toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' })}
                                </p>
                              </div>
                              <button
                                onClick={async (e) => {
                                  e.preventDefault();
                                  e.stopPropagation();
                                  if (!user?.id || !log.id) {
                                    return;
                                  }

                                  // Save scroll position
                                  const scrollY = window.scrollY;

                                  try {
                                    const { error } = await supabase
                                      .from('water_logs')
                                      .delete()
                                      .eq('id', log.id)
                                      .eq('user_id', user.id);

                                    if (error) {
                                      console.error('Delete error:', error);
                                      alert(`Delete failed: ${error.message}`);
                                      return;
                                    }

                                    // Update local state
                                    setWaterLogs(prev => prev.filter(l => l.id !== log.id));

                                    // Update water intake
                                    if (nutritionSelectedDate === TODAY_DATE_KEY) {
                                      setWaterIntake(prev => Math.max(0, prev - log.amount_ml));
                                    } else {
                                      setBackdateNutrition(prev => prev ? {
                                        ...prev,
                                        water: Math.max(0, (prev.water || 0) - log.amount_ml),
                                      } : null);
                                    }

                                    // Restore scroll position after state update
                                    requestAnimationFrame(() => {
                                      window.scrollTo(0, scrollY);
                                    });
                                  } catch (err) {
                                    console.error('Error deleting water:', err);
                                  }
                                }}
                                className="p-1 ml-2"
                              >
                                <X size={12} color={COLORS.error} />
                              </button>
                            </div>
                          )) : (
                            <p className="text-xs text-center py-2" style={{ color: COLORS.textMuted }}>No water yet</p>
                          );
                        })()}
                      </div>
                    </div>
                  </div>
                </div>

                {/* Weekly Calorie Chart */}
                <p className="text-xs font-semibold mb-3" style={{ color: COLORS.textMuted }}>WEEKLY CALORIES</p>
                <div className="p-4 rounded-xl mb-6" style={{ backgroundColor: COLORS.surface }}>
                  {weeklyNutrition.length > 0 && weeklyNutrition.some(d => d.calories != null) ? (
                    <>
                      <div style={{ height: 120 }}>
                        <ResponsiveContainer width="100%" height="100%">
                          <LineChart data={weeklyNutrition.map(d => ({ ...d, goal: nutritionGoals.calories }))}>
                            <XAxis dataKey="week" tick={{ fill: COLORS.textMuted, fontSize: 10 }} axisLine={false} tickLine={false} />
                            <YAxis tick={{ fill: COLORS.textMuted, fontSize: 10 }} axisLine={false} tickLine={false} width={40} />
                            <Tooltip
                              content={({ active, payload, label }) => {
                                if (active && payload && payload.length) {
                                  const userVal = payload.find(p => p.dataKey === 'calories')?.value;
                                  const goalVal = payload.find(p => p.dataKey === 'goal')?.value;
                                  return (
                                    <div style={{
                                      backgroundColor: COLORS.surface,
                                      border: `1px solid ${COLORS.surfaceLight}`,
                                      borderRadius: 8,
                                      padding: '8px 12px',
                                    }}>
                                      <p style={{ color: COLORS.textMuted, fontSize: 11, marginBottom: 4 }}>{label}</p>
                                      {userVal != null && (
                                        <p style={{ color: COLORS.accent, fontSize: 14, fontWeight: 'bold' }}>Avg: {userVal} kcal</p>
                                      )}
                                      {goalVal != null && (
                                        <p style={{ color: COLORS.textMuted, fontSize: 11 }}>Goal: {goalVal} kcal</p>
                                      )}
                                    </div>
                                  );
                                }
                                return null;
                              }}
                            />
                            <Line type="monotone" dataKey="goal" stroke={COLORS.textMuted} strokeWidth={1} strokeDasharray="5 5" dot={false} connectNulls />
                            <Line type="monotone" dataKey="calories" stroke={COLORS.accent} strokeWidth={2} dot={{ fill: COLORS.accent, r: 3 }} connectNulls />
                          </LineChart>
                        </ResponsiveContainer>
                      </div>
                      <div className="flex justify-center gap-4 mt-2">
                        <div className="flex items-center gap-1">
                          <div className="w-3 h-0.5 rounded" style={{ backgroundColor: COLORS.accent }} />
                          <span className="text-xs" style={{ color: COLORS.textMuted }}>Avg/day</span>
                        </div>
                        <div className="flex items-center gap-1">
                          <div className="w-3 h-0.5 rounded" style={{ backgroundColor: COLORS.textMuted, opacity: 0.5 }} />
                          <span className="text-xs" style={{ color: COLORS.textMuted }}>Goal ({nutritionGoals.calories})</span>
                        </div>
                      </div>
                    </>
                  ) : (
                    <div className="h-24 flex flex-col items-center justify-center">
                      <TrendingUp size={32} color={COLORS.textMuted} style={{ opacity: 0.3 }} />
                      <p className="text-sm mt-2" style={{ color: COLORS.textMuted }}>No calorie data yet</p>
                      <p className="text-xs" style={{ color: COLORS.textMuted }}>Log meals to see your weekly trends</p>
                    </div>
                  )}
                </div>

                {/* Weekly Water Chart */}
                <p className="text-xs font-semibold mb-3" style={{ color: COLORS.textMuted }}>WEEKLY HYDRATION</p>
                <div className="p-4 rounded-xl mb-6" style={{ backgroundColor: COLORS.surface }}>
                  {weeklyNutrition.length > 0 && weeklyNutrition.some(d => d.water != null) ? (
                    <>
                      <div style={{ height: 120 }}>
                        <ResponsiveContainer width="100%" height="100%">
                          <LineChart data={weeklyNutrition.map(d => ({ ...d, waterGoal: nutritionGoals.water }))}>
                            <XAxis dataKey="week" tick={{ fill: COLORS.textMuted, fontSize: 10 }} axisLine={false} tickLine={false} />
                            <YAxis tick={{ fill: COLORS.textMuted, fontSize: 10 }} axisLine={false} tickLine={false} width={40} tickFormatter={(v) => `${(v/1000).toFixed(1)}`} />
                            <Tooltip
                              content={({ active, payload, label }) => {
                                if (active && payload && payload.length) {
                                  const userVal = payload.find(p => p.dataKey === 'water')?.value;
                                  const goalVal = payload.find(p => p.dataKey === 'waterGoal')?.value;
                                  return (
                                    <div style={{
                                      backgroundColor: COLORS.surface,
                                      border: `1px solid ${COLORS.surfaceLight}`,
                                      borderRadius: 8,
                                      padding: '8px 12px',
                                    }}>
                                      <p style={{ color: COLORS.textMuted, fontSize: 11, marginBottom: 4 }}>{label}</p>
                                      {userVal != null && (
                                        <p style={{ color: COLORS.water, fontSize: 14, fontWeight: 'bold' }}>Avg: {(userVal / 1000).toFixed(1)}L</p>
                                      )}
                                      {goalVal != null && (
                                        <p style={{ color: COLORS.textMuted, fontSize: 11 }}>Goal: {(goalVal / 1000).toFixed(1)}L</p>
                                      )}
                                    </div>
                                  );
                                }
                                return null;
                              }}
                            />
                            <Line type="monotone" dataKey="waterGoal" stroke={COLORS.textMuted} strokeWidth={1} strokeDasharray="5 5" dot={false} connectNulls />
                            <Line type="monotone" dataKey="water" stroke={COLORS.water} strokeWidth={2} dot={{ fill: COLORS.water, r: 3 }} connectNulls />
                          </LineChart>
                        </ResponsiveContainer>
                      </div>
                      <div className="flex justify-center gap-4 mt-2">
                        <div className="flex items-center gap-1">
                          <div className="w-3 h-0.5 rounded" style={{ backgroundColor: COLORS.water }} />
                          <span className="text-xs" style={{ color: COLORS.textMuted }}>Avg/day</span>
                        </div>
                        <div className="flex items-center gap-1">
                          <div className="w-3 h-0.5 rounded" style={{ backgroundColor: COLORS.textMuted, opacity: 0.5 }} />
                          <span className="text-xs" style={{ color: COLORS.textMuted }}>Goal ({(nutritionGoals.water / 1000).toFixed(1)}L)</span>
                        </div>
                      </div>
                    </>
                  ) : (
                    <div className="h-24 flex flex-col items-center justify-center">
                      <Droplets size={32} color={COLORS.textMuted} style={{ opacity: 0.3 }} />
                      <p className="text-sm mt-2" style={{ color: COLORS.textMuted }}>No hydration data yet</p>
                      <p className="text-xs" style={{ color: COLORS.textMuted }}>Log water intake to see your weekly trends</p>
                    </div>
                  )}
                </div>

                {/* Monthly Nutrition Calendar */}
                <p className="text-xs font-semibold mb-2" style={{ color: COLORS.textMuted }}>NUTRITION STREAK</p>
                <div className="p-3 rounded-xl mb-4" style={{ backgroundColor: COLORS.surface }}>
                  <div className="flex gap-0.5 mb-1">
                    {['M', 'T', 'W', 'T', 'F', 'S', 'S'].map((d, i) => (
                      <div key={i} className="flex-1 text-center">
                        <span className="text-xs" style={{ color: COLORS.textMuted, fontSize: 9 }}>{d}</span>
                      </div>
                    ))}
                  </div>
                  <div className="grid grid-cols-7 gap-0.5">
                    {(() => {
                      const days = [];
                      const today = new Date();
                      // Start from 27 days ago to show 4 complete weeks ending today
                      for (let i = 27; i >= 0; i--) {
                        const date = new Date(today);
                        date.setDate(today.getDate() - i);
                        const dateKey = getLocalDateString(date);
                        const data = monthlyTracking?.nutrition?.[dateKey];
                        const isToday = i === 0;
                        const isFuture = false;

                        let bgColor = COLORS.surfaceLight;
                        if (data) {
                          bgColor = data.goalMet ? COLORS.success + '60' : COLORS.error + '40';
                        }

                        days.push(
                          <div
                            key={dateKey}
                            className="aspect-square rounded-sm flex items-center justify-center"
                            style={{
                              backgroundColor: bgColor,
                              border: isToday ? `2px solid ${COLORS.primary}` : 'none',
                            }}
                            title={`${dateKey}: ${data ? `${data.calories} kcal` : 'No data'}`}
                          >
                            {data?.goalMet && <Check size={8} color={COLORS.success} />}
                          </div>
                        );
                      }
                      return days;
                    })()}
                  </div>
                  <div className="flex items-center justify-center gap-4 mt-2">
                    <div className="flex items-center gap-1">
                      <div className="w-2 h-2 rounded-sm" style={{ backgroundColor: COLORS.success + '60' }} />
                      <span style={{ fontSize: 9, color: COLORS.textMuted }}>Goal met</span>
                    </div>
                    <div className="flex items-center gap-1">
                      <div className="w-2 h-2 rounded-sm" style={{ backgroundColor: COLORS.error + '40' }} />
                      <span style={{ fontSize: 9, color: COLORS.textMuted }}>Missed</span>
                    </div>
                    <div className="flex items-center gap-1">
                      <div className="w-2 h-2 rounded-sm" style={{ backgroundColor: COLORS.surfaceLight }} />
                      <span style={{ fontSize: 9, color: COLORS.textMuted }}>No data</span>
                    </div>
                  </div>
                </div>

              </>
              );
            })()}

            {/* MEALS TAB */}
            {nutritionTab === 'meals' && (
              <>
                {/* Remaining Summary - Prominent */}
                <div className="p-4 rounded-xl mb-4" style={{ backgroundColor: COLORS.surface }}>
                  <div className="flex items-center justify-center gap-2 mb-3">
                    <p className="text-xs font-semibold text-center" style={{ color: COLORS.textMuted }}>REMAINING TODAY</p>
                    {adjustedNutritionGoals.isAdjusted && (
                      <span className="text-xs px-2 py-0.5 rounded-full" style={{ backgroundColor: COLORS.primary + '20', color: COLORS.primary }}>
                        adjusted
                      </span>
                    )}
                  </div>
                  <div className="grid grid-cols-2 gap-4 mb-4">
                    <div className="p-3 rounded-xl text-center" style={{ backgroundColor: COLORS.accent + '15' }}>
                      <p className="text-3xl font-bold" style={{ color: adjustedNutritionGoals.calories - caloriesIntake >= 0 ? COLORS.accent : COLORS.error }}>
                        {adjustedNutritionGoals.calories - caloriesIntake}
                      </p>
                      <p className="text-sm" style={{ color: COLORS.textMuted }}>calories left</p>
                    </div>
                    <div className="p-3 rounded-xl text-center" style={{ backgroundColor: COLORS.primary + '15' }}>
                      <p className="text-3xl font-bold" style={{ color: adjustedNutritionGoals.protein - proteinIntake >= 0 ? COLORS.primary : COLORS.error }}>
                        {adjustedNutritionGoals.protein - proteinIntake}g
                      </p>
                      <p className="text-sm" style={{ color: COLORS.textMuted }}>protein left</p>
                    </div>
                  </div>
                  
                  {/* Current intake row */}
                  <div className="grid grid-cols-3 gap-2 text-center pt-3 border-t" style={{ borderColor: COLORS.surfaceLight }}>
                    <div>
                      <p className="text-sm font-semibold" style={{ color: COLORS.text }}>{caloriesIntake}</p>
                      <p className="text-xs" style={{ color: COLORS.textMuted }}>eaten</p>
                    </div>
                    <div>
                      <p className="text-sm font-semibold" style={{ color: COLORS.text }}>{proteinIntake}g</p>
                      <p className="text-xs" style={{ color: COLORS.textMuted }}>protein</p>
                    </div>
                    <div>
                      <p className="text-sm font-semibold" style={{ color: COLORS.text }}>{carbsIntake}g</p>
                      <p className="text-xs" style={{ color: COLORS.textMuted }}>carbs</p>
                    </div>
                  </div>
                </div>

                {/* Add Meal Button */}
                <button 
                  onClick={() => setShowAddMealFull(true)}
                  className="w-full p-4 rounded-xl mb-4 flex items-center justify-center gap-2"
                  style={{ backgroundColor: COLORS.primary }}
                >
                  <Plus size={20} color={COLORS.text} />
                  <span className="font-semibold" style={{ color: COLORS.text }}>Add Meal with Macros</span>
                </button>

                {/* Meal Log */}
                <p className="text-xs font-semibold mb-3" style={{ color: COLORS.textMuted }}>TODAY'S MEALS</p>
                <div className="space-y-3">
                  {mealLog.map(meal => (
                    <div key={meal.id} className="p-4 rounded-xl" style={{ backgroundColor: COLORS.surface }}>
                      <div className="flex justify-between items-start mb-2">
                        <div>
                          <p className="font-semibold" style={{ color: COLORS.text }}>{meal.name}</p>
                          <p className="text-xs" style={{ color: COLORS.textMuted }}>
                            {(() => {
                              // Format time to 12-hour format with am/pm
                              if (!meal.time) return '';
                              const [hours, minutes] = meal.time.split(':');
                              const h = parseInt(hours, 10);
                              const ampm = h >= 12 ? 'pm' : 'am';
                              const h12 = h % 12 || 12;
                              return `${h12}:${minutes} ${ampm}`;
                            })()}
                          </p>
                        </div>
                        <div className="flex items-center gap-2">
                          <span className="text-lg font-bold" style={{ color: COLORS.accent }}>{meal.calories}</span>
                          <span className="text-xs" style={{ color: COLORS.textMuted }}>kcal</span>
                        </div>
                      </div>
                      <div className="flex gap-4 pt-2 border-t" style={{ borderColor: COLORS.surfaceLight }}>
                        <div className="flex items-center gap-1">
                          <div className="w-2 h-2 rounded-full" style={{ backgroundColor: COLORS.primary }} />
                          <span className="text-xs" style={{ color: COLORS.textSecondary }}>{meal.protein}g P</span>
                        </div>
                        <div className="flex items-center gap-1">
                          <div className="w-2 h-2 rounded-full" style={{ backgroundColor: COLORS.warning }} />
                          <span className="text-xs" style={{ color: COLORS.textSecondary }}>{meal.carbs}g C</span>
                        </div>
                      </div>
                    </div>
                  ))}
                </div>

                {/* Monthly Meals Calendar */}
                <p className="text-xs font-semibold mb-2 mt-4" style={{ color: COLORS.textMuted }}>PROTEIN STREAK</p>
                <div className="p-3 rounded-xl mb-4" style={{ backgroundColor: COLORS.surface }}>
                  <div className="flex gap-0.5 mb-1">
                    {['M', 'T', 'W', 'T', 'F', 'S', 'S'].map((d, i) => (
                      <div key={i} className="flex-1 text-center">
                        <span className="text-xs" style={{ color: COLORS.textMuted, fontSize: 9 }}>{d}</span>
                      </div>
                    ))}
                  </div>
                  <div className="grid grid-cols-7 gap-0.5">
                    {(() => {
                      const days = [];
                      const today = new Date();
                      for (let i = 27; i >= 0; i--) {
                        const date = new Date(today);
                        date.setDate(today.getDate() - i);
                        const dateKey = getLocalDateString(date);
                        const data = monthlyTracking?.nutrition?.[dateKey];
                        const isToday = i === 0;
                        const proteinGoalMet = data && data.protein >= (nutritionGoals.protein * 0.85);

                        let bgColor = COLORS.surfaceLight;
                        if (data) {
                          bgColor = proteinGoalMet ? COLORS.primary + '50' : COLORS.error + '40';
                        }

                        days.push(
                          <div
                            key={dateKey}
                            className="aspect-square rounded-sm flex items-center justify-center"
                            style={{
                              backgroundColor: bgColor,
                              border: isToday ? `2px solid ${COLORS.primary}` : 'none',
                            }}
                            title={`${dateKey}: ${data ? `${data.protein}g protein` : 'No data'}`}
                          >
                            {proteinGoalMet && <Check size={8} color={COLORS.primary} />}
                          </div>
                        );
                      }
                      return days;
                    })()}
                  </div>
                  <div className="flex items-center justify-center gap-4 mt-2">
                    <div className="flex items-center gap-1">
                      <div className="w-2 h-2 rounded-sm" style={{ backgroundColor: COLORS.primary + '50' }} />
                      <span style={{ fontSize: 9, color: COLORS.textMuted }}>Goal met</span>
                    </div>
                    <div className="flex items-center gap-1">
                      <div className="w-2 h-2 rounded-sm" style={{ backgroundColor: COLORS.error + '40' }} />
                      <span style={{ fontSize: 9, color: COLORS.textMuted }}>Missed</span>
                    </div>
                  </div>
                </div>
              </>
            )}

            {/* SUPPLEMENTS TAB */}
            {nutritionTab === 'supplements' && (
              <>
                {/* Today's Progress */}
                <p className="text-xs font-semibold mb-3" style={{ color: COLORS.textMuted }}>TODAY'S PROGRESS</p>
                <div className="p-4 rounded-xl mb-4" style={{ backgroundColor: COLORS.surface }}>
                  <div className="flex justify-end items-center mb-3">
                    <span className="text-sm font-semibold" style={{ color: COLORS.supplements }}>
                      {supplements.filter(s => s.taken).length}/{supplements.length} taken
                    </span>
                  </div>
                  <div className="h-3 rounded-full overflow-hidden mb-2" style={{ backgroundColor: COLORS.surfaceLight }}>
                    <div
                      className="h-full rounded-full transition-all"
                      style={{
                        backgroundColor: COLORS.supplements,
                        width: supplements.length > 0 ? `${(supplements.filter(s => s.taken).length / supplements.length) * 100}%` : '0%'
                      }}
                    />
                  </div>
                  <p className="text-xs text-center" style={{ color: COLORS.textMuted }}>
                    {supplements.length === 0
                      ? 'Add supplements to start tracking'
                      : supplements.filter(s => s.taken).length === supplements.length
                        ? 'All supplements taken!'
                        : `${supplements.length - supplements.filter(s => s.taken).length} remaining`
                    }
                  </p>
                </div>

                {/* Supplement List */}
                <div className="space-y-2 mb-4" style={{ opacity: supplementsLoading ? 0.5 : 1, transition: 'opacity 0.2s' }}>
                  {supplementsLoading && (
                    <div className="flex items-center justify-center py-2">
                      <Loader2 size={20} color={COLORS.supplements} className="animate-spin" />
                    </div>
                  )}
                  {supplements.map(supp => {
                    const takenCount = supp.takenCount || (supp.taken ? 1 : 0);
                    return (
                    <div
                      key={supp.id}
                      className="p-4 rounded-xl flex items-center justify-between"
                      style={{ backgroundColor: takenCount > 0 ? COLORS.supplements + '15' : COLORS.surface }}
                    >
                      <div
                        className="flex items-center gap-3 flex-1 cursor-pointer"
                        onClick={async () => {
                          if (supplementsLoading) return;
                          const newCount = takenCount + 1;

                          // Update UI immediately for responsiveness
                          setSupplements(prev => prev.map(s => s.id === supp.id ? {...s, taken: true, takenCount: newCount} : s));

                          // Save to database using the selected date
                          const targetDate = nutritionSelectedDate;
                          if (user?.id) {
                            await nutritionService.logSupplement(user.id, supp.id, targetDate);
                          }

                          // Reload supplement history to update calendar and streaks
                          if (user?.id) {
                            const startDate = new Date();
                            startDate.setDate(startDate.getDate() - 27);
                            const { data: supplementLogsRange } = await nutritionService.getSupplementLogsRange(
                              user.id,
                              getLocalDateString(startDate),
                              TODAY_DATE_KEY
                            );

                            const { data: userSupplements } = await nutritionService.getSupplements(user.id);
                            const totalSupps = userSupplements?.length || 0;

                            // Build history by date
                            const historyMap = new Map();
                            for (let i = 0; i < 28; i++) {
                              const date = new Date();
                              date.setDate(date.getDate() - i);
                              const dateKey = getLocalDateString(date);
                              historyMap.set(dateKey, { date: dateKey, completed: 0, total: totalSupps, allTaken: false });
                            }

                            // Count completed supplements per day
                            supplementLogsRange?.forEach(log => {
                              const dateKey = log.log_date;
                              if (historyMap.has(dateKey)) {
                                const day = historyMap.get(dateKey);
                                day.completed++;
                                day.allTaken = day.completed >= day.total;
                              }
                            });

                            setSupplementHistory(Array.from(historyMap.values()).sort((a, b) => b.date.localeCompare(a.date)));

                            // Calculate supplement streak
                            let streak = 0;
                            const sortedHistory = Array.from(historyMap.values()).sort((a, b) => b.date.localeCompare(a.date));
                            for (const day of sortedHistory) {
                              if (day.allTaken && day.total > 0) {
                                streak++;
                              } else {
                                break;
                              }
                            }

                            setStreaks(prev => ({
                              ...prev,
                              supplements: { daysInRow: streak }
                            }));
                          }
                        }}
                      >
                        <div
                          className="w-8 h-8 rounded-full flex items-center justify-center"
                          style={{
                            backgroundColor: takenCount > 0 ? COLORS.supplements : COLORS.surfaceLight,
                            border: takenCount > 0 ? 'none' : `2px solid ${COLORS.textMuted}`
                          }}
                        >
                          {takenCount > 0 && (
                            takenCount > 1
                              ? <span className="text-xs font-bold" style={{ color: COLORS.background }}>{takenCount}</span>
                              : <Check size={16} color={COLORS.background} />
                          )}
                        </div>
                        <div>
                          <p className="font-semibold" style={{ color: COLORS.text }}>{supp.name}</p>
                          <div className="flex items-center gap-2">
                            <span className="text-xs" style={{ color: COLORS.textMuted }}>{supp.dosage}</span>
                            {takenCount > 1 && (
                              <span className="text-xs font-semibold" style={{ color: COLORS.supplements }}>{takenCount} today</span>
                            )}
                            {supp.time && takenCount <= 1 && (
                              <>
                                <span className="text-xs" style={{ color: COLORS.textMuted }}></span>
                                <span className="text-xs" style={{ color: COLORS.textMuted }}>{supp.time}</span>
                              </>
                            )}
                          </div>
                        </div>
                      </div>
                      {/* Reset count button - only show if taken */}
                      {takenCount > 0 && (
                        <button
                          onClick={async (e) => {
                            e.stopPropagation();
                            // Reset count for today
                            setSupplements(prev => prev.map(s => s.id === supp.id ? {...s, taken: false, takenCount: 0} : s));

                            // Delete all logs for this supplement today
                            if (user?.id) {
                              await supabase
                                .from('supplement_logs')
                                .delete()
                                .eq('supplement_id', supp.id)
                                .eq('log_date', nutritionSelectedDate);
                            }
                          }}
                          className="p-2 rounded-full mr-1"
                          style={{ backgroundColor: COLORS.surfaceLight }}
                        >
                          <RotateCcw size={14} color={COLORS.textMuted} />
                        </button>
                      )}
                      <button
                        onClick={async () => {
                          // Update UI immediately
                          setSupplements(prev => prev.filter(s => s.id !== supp.id));

                          // Delete from database
                          if (user?.id) {
                            await supabase
                              .from('user_supplements')
                              .update({ is_active: false })
                              .eq('id', supp.id);
                          }
                        }}
                        className="p-2 rounded-full"
                        style={{ backgroundColor: COLORS.surfaceLight }}
                      >
                        <X size={14} color={COLORS.textMuted} />
                      </button>
                    </div>
                  );
                  })}
                </div>

                {/* Suggested Supplements */}
                {SUGGESTED_SUPPLEMENTS.filter(suggestion =>
                  !dismissedSuggestions.includes(suggestion.id) &&
                  !supplements.some(s => s.name.toLowerCase().includes(suggestion.name.toLowerCase().split(' ')[0]))
                ).map(suggestion => (
                  <div key={suggestion.id} className="p-4 rounded-xl mb-4" style={{ backgroundColor: COLORS.primary + '15', border: `1px solid ${COLORS.primary}40` }}>
                    <div className="flex items-start gap-3 mb-3">
                      <div className="w-10 h-10 rounded-full flex items-center justify-center flex-shrink-0" style={{ backgroundColor: COLORS.primary + '30' }}>
                        <Zap size={20} color={COLORS.primary} />
                      </div>
                      <div className="flex-1">
                        <p className="text-xs font-semibold mb-1" style={{ color: COLORS.primary }}>Recommended for you</p>
                        <p className="font-semibold" style={{ color: COLORS.text }}>{suggestion.name}</p>
                        <p className="text-sm" style={{ color: COLORS.textMuted }}>{suggestion.dosage} daily</p>
                      </div>
                    </div>
                    <div className="space-y-2 mb-4">
                      {suggestion.reasons.map((reason, i) => (
                        <div key={i} className="flex items-start gap-2">
                          <Check size={14} color={COLORS.success} className="flex-shrink-0 mt-0.5" />
                          <p className="text-sm" style={{ color: COLORS.textSecondary }}>{reason}</p>
                        </div>
                      ))}
                    </div>
                    <div className="flex gap-2">
                      <button
                        onClick={() => setDismissedSuggestions(prev => [...prev, suggestion.id])}
                        className="flex-1 py-2.5 rounded-xl text-sm font-semibold"
                        style={{ backgroundColor: COLORS.surfaceLight, color: COLORS.textMuted }}
                      >
                        Dismiss
                      </button>
                      <button
                        onClick={async () => {
                          if (user?.id) {
                            const { data, error } = await nutritionService.addSupplement(user.id, { name: suggestion.name, dosage: suggestion.dosage });
                            if (!error && data) {
                              setSupplements(prev => [...prev, { id: data.id, name: data.name, dosage: data.dosage, taken: false, time: '' }]);
                            } else {
                              setSupplements(prev => [...prev, { id: Date.now().toString(), name: suggestion.name, dosage: suggestion.dosage, taken: false, time: '' }]);
                            }
                          }
                        }}
                        className="flex-1 py-2.5 rounded-xl text-sm font-semibold"
                        style={{ backgroundColor: COLORS.primary, color: COLORS.text }}
                      >
                        Add to My Supps
                      </button>
                    </div>
                  </div>
                ))}

                {/* Add Supplement */}
                {showAddSupplement ? (
                  <div className="p-4 rounded-xl mb-4" style={{ backgroundColor: COLORS.surface }} onMouseDown={e => e.stopPropagation()}>
                    <p className="font-semibold mb-3" style={{ color: COLORS.text }}>Add New Supplement</p>
                    <div className="space-y-3 mb-3">
                      <input
                        type="text"
                        placeholder="Supplement name"
                        ref={supplementNameRef}
                        autoFocus
                        onMouseDown={e => e.stopPropagation()}
                        className="w-full p-3 rounded-xl text-sm"
                        style={{ backgroundColor: COLORS.surfaceLight, color: COLORS.text, border: 'none', outline: 'none' }}
                      />
                      <div className="flex gap-2">
                        <input
                          type="number"
                          placeholder="Amount"
                          ref={supplementDosageRef}
                          onMouseDown={e => e.stopPropagation()}
                          className="flex-1 p-3 rounded-xl text-sm"
                          style={{ backgroundColor: COLORS.surfaceLight, color: COLORS.text, border: 'none', outline: 'none' }}
                        />
                        <select
                          ref={supplementUnitRef}
                          defaultValue="mg"
                          onMouseDown={e => e.stopPropagation()}
                          className="p-3 rounded-xl text-sm"
                          style={{ backgroundColor: COLORS.surfaceLight, color: COLORS.text, border: 'none', outline: 'none' }}
                        >
                          {SUPPLEMENT_UNITS.map(unit => (
                            <option key={unit} value={unit}>{unit}</option>
                          ))}
                        </select>
                      </div>
                    </div>
                    <div className="flex gap-2">
                      <button
                        onClick={() => {
                          setShowAddSupplement(false);
                          if (supplementNameRef.current) supplementNameRef.current.value = '';
                          if (supplementDosageRef.current) supplementDosageRef.current.value = '';
                          if (supplementUnitRef.current) supplementUnitRef.current.value = 'mg';
                        }}
                        className="flex-1 py-3 rounded-xl font-semibold"
                        style={{ backgroundColor: COLORS.surfaceLight, color: COLORS.textMuted }}
                      >
                        Cancel
                      </button>
                      <button
                        onClick={async () => {
                          const name = supplementNameRef.current?.value?.trim();
                          const amount = supplementDosageRef.current?.value?.trim();
                          const unit = supplementUnitRef.current?.value || 'mg';
                          const dosage = amount ? `${amount} ${unit}` : 'As needed';
                          if (name && user?.id) {
                            const { data, error } = await nutritionService.addSupplement(user.id, { name, dosage });
                            if (!error && data) {
                              setSupplements(prev => [...prev, { id: data.id, name: data.name, dosage: data.dosage, taken: false, time: '' }]);
                            } else {
                              setSupplements(prev => [...prev, { id: Date.now().toString(), name, dosage, taken: false, time: '' }]);
                            }
                            setShowAddSupplement(false);
                            if (supplementNameRef.current) supplementNameRef.current.value = '';
                            if (supplementDosageRef.current) supplementDosageRef.current.value = '';
                            if (supplementUnitRef.current) supplementUnitRef.current.value = 'mg';
                          }
                        }}
                        className="flex-1 py-3 rounded-xl font-semibold"
                        style={{ backgroundColor: COLORS.primary, color: COLORS.text }}
                      >
                        Add
                      </button>
                    </div>
                  </div>
                ) : (
                  <button
                    onClick={() => setShowAddSupplement(true)}
                    className="w-full p-4 rounded-xl flex items-center justify-center gap-2 mb-4"
                    style={{ backgroundColor: COLORS.surface, border: `1px dashed ${COLORS.textMuted}` }}
                  >
                    <Plus size={18} color={COLORS.textMuted} />
                    <span style={{ color: COLORS.textMuted }}>Add Supplement</span>
                  </button>
                )}

                {/* Supplement Streak */}
                <p className="text-xs font-semibold mb-3" style={{ color: COLORS.textMuted }}>CONSISTENCY</p>
                <div className="p-4 rounded-xl mb-4" style={{ backgroundColor: COLORS.surface }}>
                  <div className="flex items-center justify-end mb-3">
                    <div className="flex items-center gap-1">
                      <Flame size={16} color={COLORS.warning} />
                      <span className="font-bold" style={{ color: COLORS.warning }}>{streaks.supplements.daysInRow} day streak</span>
                    </div>
                  </div>
                  <div className="flex gap-1">
                    {supplementHistory.slice(0, 7).map((day, i) => (
                      <div 
                        key={i}
                        className="flex-1 aspect-square rounded-lg flex flex-col items-center justify-center"
                        style={{ backgroundColor: day.completed === day.total ? COLORS.success + '20' : COLORS.surfaceLight }}
                      >
                        <span className="text-xs" style={{ color: COLORS.textMuted }}>{day.date.split(' ')[1]}</span>
                        {day.completed === day.total ? (
                          <Check size={14} color={COLORS.success} />
                        ) : (
                          <span className="text-xs font-semibold" style={{ color: COLORS.textMuted }}>{day.completed}/{day.total}</span>
                        )}
                      </div>
                    ))}
                  </div>
                </div>

                {/* Monthly Supplements Calendar */}
                <p className="text-xs font-semibold mb-2" style={{ color: COLORS.textMuted }}>SUPPLEMENT STREAK</p>
                <div className="p-3 rounded-xl" style={{ backgroundColor: COLORS.surface }}>
                  <div className="flex gap-0.5 mb-1">
                    {['M', 'T', 'W', 'T', 'F', 'S', 'S'].map((d, i) => (
                      <div key={i} className="flex-1 text-center">
                        <span className="text-xs" style={{ color: COLORS.textMuted, fontSize: 9 }}>{d}</span>
                      </div>
                    ))}
                  </div>
                  <div className="grid grid-cols-7 gap-0.5">
                    {(() => {
                      const days = [];
                      const today = new Date();
                      for (let i = 27; i >= 0; i--) {
                        const date = new Date(today);
                        date.setDate(today.getDate() - i);
                        const dateKey = getLocalDateString(date);
                        // Check supplementHistory for this day
                        const dayData = supplementHistory.find(h => h.date === dateKey);
                        const isToday = i === 0;
                        const allTaken = dayData?.allTaken || false;
                        const hasData = dayData !== undefined;

                        let bgColor = COLORS.surfaceLight;
                        if (hasData) {
                          bgColor = allTaken ? COLORS.supplements + '50' : COLORS.error + '40';
                        }

                        days.push(
                          <div
                            key={dateKey}
                            className="aspect-square rounded-sm flex items-center justify-center"
                            style={{
                              backgroundColor: bgColor,
                              border: isToday ? `2px solid ${COLORS.supplements}` : 'none',
                            }}
                            title={`${dateKey}: ${hasData ? (allTaken ? 'All taken' : 'Incomplete') : 'No data'}`}
                          >
                            {allTaken && <Check size={8} color={COLORS.supplements} />}
                          </div>
                        );
                      }
                      return days;
                    })()}
                  </div>
                  <div className="flex items-center justify-center gap-4 mt-2">
                    <div className="flex items-center gap-1">
                      <div className="w-2 h-2 rounded-sm" style={{ backgroundColor: COLORS.supplements + '50' }} />
                      <span style={{ fontSize: 9, color: COLORS.textMuted }}>All taken</span>
                    </div>
                    <div className="flex items-center gap-1">
                      <div className="w-2 h-2 rounded-sm" style={{ backgroundColor: COLORS.error + '40' }} />
                      <span style={{ fontSize: 9, color: COLORS.textMuted }}>Incomplete</span>
                    </div>
                  </div>
                </div>
              </>
            )}

            {/* SLEEP TAB */}
            {nutritionTab === 'sleep' && (
              <>
                {/* Sleep Entry with Date Navigation */}
                <div className="flex items-center justify-between mb-3">
                  <p className="text-xs font-semibold" style={{ color: COLORS.textMuted }}>
                    {new Date(selectedSleepDate).toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' }).toUpperCase()}
                  </p>
                  <div className="flex items-center gap-2">
                    <button
                      onClick={() => {
                        const newDate = new Date(selectedSleepDate);
                        newDate.setDate(newDate.getDate() - 1);
                        setSelectedSleepDate(getLocalDateString(newDate));
                      }}
                      className="p-1.5 rounded-lg"
                      style={{ backgroundColor: COLORS.surfaceLight }}
                    >
                      <ChevronLeft size={16} color={COLORS.text} />
                    </button>
                    <button
                      onClick={() => {
                        const newDate = new Date(selectedSleepDate);
                        const yesterday = new Date();
                        yesterday.setDate(yesterday.getDate() - 1);
                        // Don't allow going forward past yesterday
                        if (newDate < yesterday) {
                          newDate.setDate(newDate.getDate() + 1);
                          setSelectedSleepDate(getLocalDateString(newDate));
                        }
                      }}
                      className="p-1.5 rounded-lg"
                      style={{ backgroundColor: COLORS.surfaceLight }}
                      disabled={(() => { const y = new Date(); y.setDate(y.getDate() - 1); return selectedSleepDate >= getLocalDateString(y); })()}
                    >
                      <ChevronRight size={16} color={COLORS.text} />
                    </button>
                  </div>
                </div>
                <div className="p-4 rounded-xl mb-4" style={{ backgroundColor: COLORS.surface }}>
                  {!lastNightConfirmed ? (
                    <>
                      <div className="flex items-center justify-end mb-3">
                        <div className="flex items-center gap-1">
                          <Moon size={16} color={COLORS.sleep} />
                          <span className="font-bold" style={{ color: COLORS.sleep }}>
                            {(() => {
                              const [bedH, bedM] = lastNightBedTime.split(':').map(Number);
                              const [wakeH, wakeM] = lastNightWakeTime.split(':').map(Number);
                              let hours = wakeH - bedH + (wakeM - bedM) / 60;
                              if (hours < 0) hours += 24;
                              return hours.toFixed(1);
                            })()} hrs
                          </span>
                        </div>
                      </div>
                    <div className="space-y-3">
                      <div className="flex items-center gap-3">
                        <div className="flex-1">
                          <p className="text-xs mb-2" style={{ color: COLORS.textMuted }}>Bed Time</p>
                          <div className="flex items-center gap-2">
                            <input
                              ref={sleepEditRefs.lastBedH}
                              type="text"
                              inputMode="numeric"
                              defaultValue={lastNightBedTime.split(':')[0]}
                              onBlur={(e) => {
                                let val = parseInt(e.target.value) || 0;
                                const h = Math.max(0, Math.min(23, val)).toString().padStart(2, '0');
                                e.target.value = h;
                                setLastNightBedTime(prev => `${h}:${prev.split(':')[1]}`);
                              }}
                              onKeyDown={(e) => {
                                if (e.key === 'Enter') e.target.blur();
                              }}
                              className="w-12 p-2 rounded-lg text-center font-bold"
                              style={{ backgroundColor: COLORS.surfaceLight, color: COLORS.text, border: 'none' }}
                            />
                            <span style={{ color: COLORS.textMuted, fontSize: 18 }}>:</span>
                            <input
                              ref={sleepEditRefs.lastBedM}
                              type="text"
                              inputMode="numeric"
                              defaultValue={lastNightBedTime.split(':')[1]}
                              onBlur={(e) => {
                                let val = parseInt(e.target.value) || 0;
                                const newMinutes = Math.max(0, Math.min(59, val));
                                const m = newMinutes.toString().padStart(2, '0');
                                e.target.value = m;

                                setLastNightBedTime(prev => {
                                  const [currentH, currentM] = prev.split(':').map(Number);
                                  let newH = currentH;

                                  // If going from 55 to 0, increment hour
                                  if (currentM === 55 && newMinutes === 0) {
                                    newH = (currentH + 1) % 24;
                                  }
                                  // If going from 0 to 55, decrement hour
                                  else if (currentM === 0 && newMinutes === 55) {
                                    newH = (currentH - 1 + 24) % 24;
                                  }

                                  return `${newH.toString().padStart(2, '0')}:${m}`;
                                });
                              }}
                              onKeyDown={(e) => {
                                if (e.key === 'Enter') e.target.blur();
                                // Handle arrow keys for wrapping
                                if (e.key === 'ArrowUp' || e.key === 'ArrowDown') {
                                  const currentVal = parseInt(e.target.value) || 0;
                                  if (e.key === 'ArrowUp' && currentVal >= 55) {
                                    e.preventDefault();
                                    e.target.value = '00';
                                    e.target.blur();
                                  } else if (e.key === 'ArrowDown' && currentVal <= 0) {
                                    e.preventDefault();
                                    e.target.value = '55';
                                    e.target.blur();
                                  } else if (e.key === 'ArrowUp') {
                                    e.preventDefault();
                                    e.target.value = Math.min(55, currentVal + 5).toString().padStart(2, '0');
                                    e.target.blur();
                                  } else if (e.key === 'ArrowDown') {
                                    e.preventDefault();
                                    e.target.value = Math.max(0, currentVal - 5).toString().padStart(2, '0');
                                    e.target.blur();
                                  }
                                }
                              }}
                              className="w-12 p-2 rounded-lg text-center font-bold"
                              style={{ backgroundColor: COLORS.surfaceLight, color: COLORS.text, border: 'none' }}
                            />
                          </div>
                        </div>
                        <div className="flex-1">
                          <p className="text-xs mb-2" style={{ color: COLORS.textMuted }}>Wake Time</p>
                          <div className="flex items-center gap-2">
                            <input
                              ref={sleepEditRefs.lastWakeH}
                              type="text"
                              inputMode="numeric"
                              defaultValue={lastNightWakeTime.split(':')[0]}
                              onBlur={(e) => {
                                let val = parseInt(e.target.value) || 0;
                                const h = Math.max(0, Math.min(23, val)).toString().padStart(2, '0');
                                e.target.value = h;
                                setLastNightWakeTime(prev => `${h}:${prev.split(':')[1]}`);
                              }}
                              onKeyDown={(e) => {
                                if (e.key === 'Enter') e.target.blur();
                              }}
                              className="w-12 p-2 rounded-lg text-center font-bold"
                              style={{ backgroundColor: COLORS.surfaceLight, color: COLORS.text, border: 'none' }}
                            />
                            <span style={{ color: COLORS.textMuted, fontSize: 18 }}>:</span>
                            <input
                              ref={sleepEditRefs.lastWakeM}
                              type="text"
                              inputMode="numeric"
                              defaultValue={lastNightWakeTime.split(':')[1]}
                              onBlur={(e) => {
                                let val = parseInt(e.target.value) || 0;
                                const newMinutes = Math.max(0, Math.min(59, val));
                                const m = newMinutes.toString().padStart(2, '0');
                                e.target.value = m;

                                setLastNightWakeTime(prev => {
                                  const [currentH, currentM] = prev.split(':').map(Number);
                                  let newH = currentH;

                                  // If going from 55 to 0, increment hour
                                  if (currentM === 55 && newMinutes === 0) {
                                    newH = (currentH + 1) % 24;
                                  }
                                  // If going from 0 to 55, decrement hour
                                  else if (currentM === 0 && newMinutes === 55) {
                                    newH = (currentH - 1 + 24) % 24;
                                  }

                                  return `${newH.toString().padStart(2, '0')}:${m}`;
                                });
                              }}
                              onKeyDown={(e) => {
                                if (e.key === 'Enter') e.target.blur();
                                // Handle arrow keys for wrapping
                                if (e.key === 'ArrowUp' || e.key === 'ArrowDown') {
                                  const currentVal = parseInt(e.target.value) || 0;
                                  if (e.key === 'ArrowUp' && currentVal >= 55) {
                                    e.preventDefault();
                                    e.target.value = '00';
                                    e.target.blur();
                                  } else if (e.key === 'ArrowDown' && currentVal <= 0) {
                                    e.preventDefault();
                                    e.target.value = '55';
                                    e.target.blur();
                                  } else if (e.key === 'ArrowUp') {
                                    e.preventDefault();
                                    e.target.value = Math.min(55, currentVal + 5).toString().padStart(2, '0');
                                    e.target.blur();
                                  } else if (e.key === 'ArrowDown') {
                                    e.preventDefault();
                                    e.target.value = Math.max(0, currentVal - 5).toString().padStart(2, '0');
                                    e.target.blur();
                                  }
                                }
                              }}
                              className="w-12 p-2 rounded-lg text-center font-bold"
                              style={{ backgroundColor: COLORS.surfaceLight, color: COLORS.text, border: 'none' }}
                            />
                          </div>
                        </div>
                      </div>
                      <button
                        onClick={async () => {
                          const [bedH, bedM] = lastNightBedTime.split(':').map(Number);
                          const [wakeH, wakeM] = lastNightWakeTime.split(':').map(Number);
                          let hours = wakeH - bedH + (wakeM - bedM) / 60;
                          if (hours < 0) hours += 24;
                          await sleepService.logSleep(user.id, {
                            date: selectedSleepDate,
                            hoursSlept: hours,
                            qualityRating: 3,
                            bedTime: lastNightBedTime,
                            wakeTime: lastNightWakeTime,
                          });
                          // Update local tracking state for calendar
                          setMonthlyTracking(prev => ({
                            ...prev,
                            sleep: {
                              ...prev.sleep,
                              [selectedSleepDate]: { hours, goalMet: hours >= sleepHours }
                            }
                          }));
                          // Refresh streaks to update sleep streak
                          try {
                            const result = await streakService.refreshAllStreaks(user.id);
                            if (result) {
                              setStreaks({
                                weeklyWorkouts: { weeksCompleted: result.workout?.streak || 0 },
                                calories: { daysInRow: result.nutrition?.streak || 0 },
                                protein: { daysInRow: result.nutrition?.streak || 0 },
                                water: { daysInRow: result.water?.streak || 0 },
                                sleep: { daysInRow: result.sleep?.streak || 0 },
                                supplements: { daysInRow: 0 },
                              });
                            }
                          } catch (err) {
                            console.warn('Error refreshing streaks:', err?.message || err);
                          }
                          setLastNightConfirmed(true);
                        }}
                        className="w-full py-3 rounded-xl font-semibold"
                        style={{ backgroundColor: COLORS.primary, color: COLORS.text }}
                      >
                        Log Sleep
                      </button>
                    </div>
                    </>
                  ) : (
                    <div className="relative flex items-center justify-between py-3">
                      <button
                        onClick={() => setLastNightConfirmed(false)}
                        className="absolute top-1 right-1 p-1.5 rounded-full"
                        style={{ backgroundColor: COLORS.surfaceLight }}
                      >
                        <Settings size={14} color={COLORS.textMuted} />
                      </button>
                      <div className="flex items-center gap-3">
                        <Check size={24} color={COLORS.success} />
                        <div>
                          <p className="font-semibold" style={{ color: COLORS.text }}>Sleep Logged</p>
                          <p className="text-sm" style={{ color: COLORS.textMuted }}>{lastNightBedTime}  {lastNightWakeTime}</p>
                        </div>
                      </div>
                      <div className="text-right pr-8">
                        <span className="text-2xl font-bold" style={{ color: COLORS.sleep }}>
                          {(() => {
                            const [bedH, bedM] = lastNightBedTime.split(':').map(Number);
                            const [wakeH, wakeM] = lastNightWakeTime.split(':').map(Number);
                            let hours = wakeH - bedH + (wakeM - bedM) / 60;
                            if (hours < 0) hours += 24;
                            return hours.toFixed(1);
                          })()}
                        </span>
                        <span className="text-sm ml-1" style={{ color: COLORS.textMuted }}>hrs</span>
                      </div>
                    </div>
                  )}
                </div>

                {/* Sleep Streak Card */}
                <div className="p-4 rounded-xl mb-4 flex items-center justify-between" style={{ backgroundColor: COLORS.surface }}>
                  <div className="flex items-center gap-3">
                    <div className="w-12 h-12 rounded-xl flex items-center justify-center" style={{ backgroundColor: COLORS.warning + '20' }}>
                      <Flame size={24} color={COLORS.warning} />
                    </div>
                    <div>
                      <p className="text-xs" style={{ color: COLORS.textMuted }}>Current Streak</p>
                      <p className="font-bold text-lg" style={{ color: COLORS.text }}>
                        {streaks.sleep.daysInRow} {streaks.sleep.daysInRow === 1 ? 'night' : 'nights'}
                      </p>
                    </div>
                  </div>
                  <div className="text-right">
                    <p className="text-xs" style={{ color: COLORS.textMuted }}>Goal: {sleepHours} hrs</p>
                    <p className="text-xs" style={{ color: streaks.sleep.daysInRow > 0 ? COLORS.success : COLORS.textMuted }}>
                      {streaks.sleep.daysInRow === 0 ? "Log sleep to start!" : "Keep it up!"}
                    </p>
                  </div>
                </div>

                {/* Sleep Chart with View Toggle */}
                <div className="flex items-center justify-between mb-3">
                  <p className="text-xs font-semibold" style={{ color: COLORS.textMuted }}>
                    {sleepChartView === '7days' ? 'LAST 7 NIGHTS' : sleepChartView === 'weekly' ? 'WEEKLY AVERAGES' : 'MONTHLY AVERAGES'}
                  </p>
                  <div className="flex gap-1">
                    {[
                      { id: '7days', label: '7D' },
                      { id: 'weekly', label: '4W' },
                      { id: 'monthly', label: '3M' },
                    ].map(view => (
                      <button
                        key={view.id}
                        onClick={() => setSleepChartView(view.id)}
                        className="px-2 py-1 rounded text-xs font-medium"
                        style={{
                          backgroundColor: sleepChartView === view.id ? COLORS.sleep : COLORS.surfaceLight,
                          color: sleepChartView === view.id ? COLORS.text : COLORS.textMuted,
                        }}
                      >
                        {view.label}
                      </button>
                    ))}
                  </div>
                </div>
                <div className="p-4 rounded-xl mb-4" style={{ backgroundColor: COLORS.surface }}>
                  <div style={{ height: 120 }}>
                    {(() => {
                      const weekDays = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
                      let chartData = [];

                      if (sleepChartView === '7days') {
                        // Last 7 nights (excluding today)
                        for (let i = 7; i >= 1; i--) {
                          const date = new Date();
                          date.setDate(date.getDate() - i);
                          const dateKey = getLocalDateString(date);
                          const dayName = weekDays[date.getDay()];
                          const sleepEntry = monthlyTracking.sleep[dateKey];
                          chartData.push({
                            label: dayName,
                            hours: sleepEntry?.hours || 0,
                            goal: sleepHours
                          });
                        }
                      } else if (sleepChartView === 'weekly') {
                        // Last 4 weeks - weekly averages
                        for (let week = 4; week >= 1; week--) {
                          let totalHours = 0;
                          let count = 0;
                          for (let day = 0; day < 7; day++) {
                            const date = new Date();
                            date.setDate(date.getDate() - (week * 7) + day);
                            const dateKey = getLocalDateString(date);
                            const sleepEntry = monthlyTracking.sleep[dateKey];
                            if (sleepEntry?.hours) {
                              totalHours += sleepEntry.hours;
                              count++;
                            }
                          }
                          chartData.push({
                            label: `W${5 - week}`,
                            hours: count > 0 ? parseFloat((totalHours / count).toFixed(1)) : 0,
                            goal: sleepHours
                          });
                        }
                      } else {
                        // Last 3 months - monthly averages
                        const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
                        for (let month = 2; month >= 0; month--) {
                          let totalHours = 0;
                          let count = 0;
                          const targetMonth = new Date();
                          targetMonth.setMonth(targetMonth.getMonth() - month);
                          const monthKey = targetMonth.getMonth();
                          const yearKey = targetMonth.getFullYear();

                          Object.entries(monthlyTracking.sleep).forEach(([dateKey, entry]) => {
                            const entryDate = new Date(dateKey);
                            if (entryDate.getMonth() === monthKey && entryDate.getFullYear() === yearKey && entry?.hours) {
                              totalHours += entry.hours;
                              count++;
                            }
                          });
                          chartData.push({
                            label: monthNames[monthKey],
                            hours: count > 0 ? parseFloat((totalHours / count).toFixed(1)) : 0,
                            goal: sleepHours
                          });
                        }
                      }

                      return (
                        <ResponsiveContainer width="100%" height="100%">
                          <LineChart data={chartData}>
                            <XAxis
                              dataKey="label"
                              tick={{ fill: COLORS.textMuted, fontSize: 10 }}
                              axisLine={false}
                              tickLine={false}
                            />
                            <YAxis
                              tick={{ fill: COLORS.textMuted, fontSize: 10 }}
                              axisLine={false}
                              tickLine={false}
                              width={25}
                              domain={[0, 12]}
                              ticks={[0, 3, 6, 9, 12]}
                              interval={0}
                            />
                            <Line
                              type="monotone"
                              dataKey="hours"
                              stroke={COLORS.sleep}
                              strokeWidth={2}
                              dot={(props) => {
                                if (!props.payload.hours || props.payload.hours === 0) return null;
                                return <circle cx={props.cx} cy={props.cy} r={4} fill={COLORS.sleep} />;
                              }}
                              connectNulls={false}
                            />
                            <Line
                              type="monotone"
                              dataKey="goal"
                              stroke={COLORS.textMuted}
                              strokeWidth={1}
                              strokeDasharray="3 3"
                              dot={false}
                            />
                          </LineChart>
                        </ResponsiveContainer>
                      );
                    })()}
                  </div>
                </div>

                {/* Monthly Sleep Calendar */}
                <p className="text-xs font-semibold mb-2" style={{ color: COLORS.textMuted }}>SLEEP STREAK</p>
                <div className="p-3 rounded-xl" style={{ backgroundColor: COLORS.surface }}>
                  <div className="flex gap-1 mb-1">
                    {['M', 'T', 'W', 'T', 'F', 'S', 'S'].map((d, i) => (
                      <div key={i} className="flex-1 text-center">
                        <span style={{ color: COLORS.textMuted, fontSize: 8, fontWeight: 600 }}>{d}</span>
                      </div>
                    ))}
                  </div>
                  <div className="grid grid-cols-7 gap-1">
                    {(() => {
                      const days = [];
                      const today = new Date();
                      for (let i = 27; i >= 0; i--) {
                        const date = new Date(today);
                        date.setDate(today.getDate() - i);
                        const dateKey = getLocalDateString(date);
                        const dateNum = date.getDate();
                        const data = monthlyTracking?.sleep?.[dateKey];
                        const isToday = i === 0;

                        let bgColor = COLORS.surfaceLight;
                        if (data) {
                          bgColor = data.goalMet ? COLORS.sleep + '50' : COLORS.error + '40';
                        }

                        days.push(
                          <div
                            key={dateKey}
                            className="rounded-sm flex flex-col items-center justify-center p-1 relative"
                            style={{
                              backgroundColor: bgColor,
                              border: isToday ? `2px solid ${COLORS.sleep}` : 'none',
                              minHeight: 40,
                            }}
                            title={`${dateKey}: ${data ? `${data.hours}h sleep` : 'No data'}`}
                          >
                            <span style={{ fontSize: 7, fontWeight: 500, color: COLORS.textMuted, position: 'absolute', top: 2, left: 3, lineHeight: 1 }}>
                              {dateNum}
                            </span>
                            {data?.hours > 0 ? (
                              <span style={{ fontSize: 14, fontWeight: 700, color: COLORS.text, lineHeight: 1 }}>
                                {data.hours.toFixed(1)}
                              </span>
                            ) : (
                              <span style={{ fontSize: 10, color: COLORS.textMuted, opacity: 0.3 }}>-</span>
                            )}
                          </div>
                        );
                      }
                      return days;
                    })()}
                  </div>
                  <div className="flex items-center justify-center gap-4 mt-2">
                    <div className="flex items-center gap-1">
                      <div className="w-2 h-2 rounded-sm" style={{ backgroundColor: COLORS.sleep + '50' }} />
                      <span style={{ fontSize: 9, color: COLORS.textMuted }}>7+ hrs</span>
                    </div>
                    <div className="flex items-center gap-1">
                      <div className="w-2 h-2 rounded-sm" style={{ backgroundColor: COLORS.error + '40' }} />
                      <span style={{ fontSize: 9, color: COLORS.textMuted }}>&lt;7 hrs</span>
                    </div>
                  </div>
                </div>
              </>
            )}
          </div>

          {/* Macro Detail Modal */}
          {showMacroDetail && (() => {
            console.log('Rendering macro modal for:', showMacroDetail);
            const macros = {
              protein: { name: 'Protein', key: 'protein', current: nutritionSelectedDate === TODAY_DATE_KEY ? proteinIntake : (backdateNutrition?.protein || 0), target: adjustedNutritionGoals.protein, color: COLORS.primary },
              carbs: { name: 'Carbs', key: 'carbs', current: nutritionSelectedDate === TODAY_DATE_KEY ? carbsIntake : (backdateNutrition?.carbs || 0), target: nutritionGoals.carbs, color: COLORS.warning },
            };
            const macro = macros[showMacroDetail];
            if (!macro) return null;

            const percentage = Math.min(100, (macro.current / macro.target) * 100);
            const remaining = macro.target - macro.current;

            return (
              <div
                className="fixed inset-0 z-50 flex items-end justify-center"
                style={{ backgroundColor: 'rgba(0,0,0,0.2)' }}
                onClick={(e) => {
                  if (e.target === e.currentTarget) {
                    setShowMacroDetail(null);
                  }
                }}
              >
                <div className="w-full max-w-md rounded-t-3xl p-6 max-h-[85vh] overflow-y-auto" style={{ backgroundColor: COLORS.surface }}>
                  <div className="flex items-center justify-between mb-4">
                    <h3 className="text-xl font-bold" style={{ color: COLORS.text }}>{macro.name}</h3>
                    <button onClick={() => setShowMacroDetail(null)} className="p-2 rounded-full" style={{ backgroundColor: COLORS.surfaceLight }}>
                      <X size={20} color={COLORS.textMuted} />
                    </button>
                  </div>

                  {/* Summary Stats */}
                  <div className="grid grid-cols-3 gap-2 mb-4">
                    <div className="p-3 rounded-xl text-center" style={{ backgroundColor: COLORS.surfaceLight }}>
                      <p className="text-xs" style={{ color: COLORS.textMuted }}>Current</p>
                      <p className="text-lg font-bold" style={{ color: COLORS.text }}>{macro.current}g</p>
                    </div>
                    <div className="p-3 rounded-xl text-center" style={{ backgroundColor: COLORS.surfaceLight }}>
                      <p className="text-xs" style={{ color: COLORS.textMuted }}>Goal</p>
                      <p className="text-lg font-bold" style={{ color: COLORS.text }}>{macro.target}g</p>
                    </div>
                    <div className="p-3 rounded-xl text-center" style={{ backgroundColor: remaining >= 0 ? COLORS.success + '20' : COLORS.error + '20' }}>
                      <p className="text-xs" style={{ color: COLORS.textMuted }}>{remaining >= 0 ? 'To Go' : 'Over'}</p>
                      <p className="text-lg font-bold" style={{ color: remaining >= 0 ? COLORS.success : COLORS.error }}>
                        {Math.abs(remaining)}g
                      </p>
                    </div>
                  </div>

                  {/* Progress Bar */}
                  <div className="mb-6">
                    <div className="h-3 rounded-full overflow-hidden" style={{ backgroundColor: COLORS.surfaceLight }}>
                      <div
                        className="h-full rounded-full transition-all"
                        style={{
                          backgroundColor: macro.color,
                          width: `${percentage}%`
                        }}
                      />
                    </div>
                    <p className="text-xs text-center mt-1" style={{ color: COLORS.textMuted }}>{Math.round(percentage)}% of daily goal</p>
                  </div>

                  {/* Meals Breakdown */}
                  <div className="mb-4">
                    <p className="text-xs font-semibold mb-3" style={{ color: COLORS.textMuted }}>TODAY'S MEALS</p>
                    {mealLog.length > 0 ? (
                      <div className="space-y-2">
                        {mealLog.map((meal, idx) => {
                          const macroAmount = meal[macro.key] || 0;
                          return (
                            <div key={meal.id || idx} className="p-3 rounded-xl" style={{ backgroundColor: COLORS.surfaceLight }}>
                              <div className="flex items-start justify-between mb-1">
                                <div className="flex-1 min-w-0">
                                  <p className="text-sm font-semibold truncate" style={{ color: COLORS.text }}>{meal.name}</p>
                                  <p className="text-xs" style={{ color: COLORS.textMuted }}>{meal.calories} cal</p>
                                </div>
                                <div className="text-right ml-2">
                                  <p className="text-lg font-bold" style={{ color: macro.color }}>{macroAmount}g</p>
                                </div>
                              </div>
                            </div>
                          );
                        })}
                      </div>
                    ) : (
                      <div className="p-6 text-center rounded-xl" style={{ backgroundColor: COLORS.surfaceLight }}>
                        <Utensils size={24} color={COLORS.textMuted} className="mx-auto mb-2" />
                        <p className="text-sm" style={{ color: COLORS.textMuted }}>No meals logged yet</p>
                      </div>
                    )}
                  </div>

                  <button
                    onClick={() => setShowMacroDetail(null)}
                    className="w-full py-3 rounded-xl font-semibold"
                    style={{ backgroundColor: macro.color, color: COLORS.text }}
                  >
                    Close
                  </button>
                </div>
              </div>
            );
          })()}

          </>
  );
};

export default function UpRepDemo() {
  // Auth state
  const { user, profile, loading: authLoading, isAuthenticated, signOut, updateProfile, updateGoals } = useAuth();

  // Determine initial screen based on auth state
  const getInitialScreen = () => {
    if (isAuthenticated) {
      // Check if user has completed onboarding (has goals set)
      if (profile?.user_goals?.goal) {
        return 'main';
      }
      return 'onboarding';
    }
    return 'welcome';
  };

  const [currentScreen, setCurrentScreen] = useState('welcome');
  const [activeTab, setActiveTab] = useState('home');

  // Data loaded from database
  const [allFoods, setAllFoods] = useState([]);
  const [frequentMealsForModal, setFrequentMealsForModal] = useState([]);
  const [allExercises, setAllExercises] = useState([]);
  const [workoutTemplates, setWorkoutTemplates] = useState({});
  const [dataLoading, setDataLoading] = useState(true);

  // Selected date for sleep logging (defaults to yesterday)
  const [selectedSleepDate, setSelectedSleepDate] = useState(() => {
    const yesterday = new Date();
    yesterday.setDate(yesterday.getDate() - 1);
    return getLocalDateString(yesterday);
  });

  // Update screen when auth state changes
  useEffect(() => {
    if (!authLoading) {
      if (isAuthenticated) {
        if (profile?.user_goals?.goal) {
          setCurrentScreen('main');
        } else if (currentScreen === 'welcome' || currentScreen === 'login') {
          // User just logged in but hasn't completed onboarding
          setCurrentScreen('onboarding');
        }
      } else {
        setCurrentScreen('welcome');
      }
    }
  }, [authLoading, isAuthenticated, profile]);

  // Sync profile data from Supabase to local state
  useEffect(() => {
    if (profile) {
      // Update userData from profile
      setUserData(prev => ({
        ...prev,
        username: profile.username || prev.username,
        bio: profile.bio || prev.bio,
        gender: profile.gender || prev.gender,
        firstName: profile.first_name || prev.firstName,
        lastName: profile.last_name || prev.lastName,
        email: user?.email || prev.email,
        avatarUrl: profile.avatar_url || prev.avatarUrl,
        coverPhotoUrl: profile.cover_photo_url || prev.coverPhotoUrl,
        // From user_goals - skip goal/weight sync if a goal change is in progress to prevent race condition
        goal: goalChangeInProgressRef.current ? prev.goal : (profile.user_goals?.goal || prev.goal),
        experience: profile.user_goals?.experience || prev.experience,
        currentWeight: goalChangeInProgressRef.current ? prev.currentWeight : (profile.user_goals?.current_weight?.toString() || prev.currentWeight),
        goalWeight: goalChangeInProgressRef.current ? prev.goalWeight : (profile.user_goals?.goal_weight?.toString() || prev.goalWeight),
        programWeeks: goalChangeInProgressRef.current ? prev.programWeeks : (profile.user_goals?.program_weeks || prev.programWeeks),
        daysPerWeek: profile.user_goals?.days_per_week || prev.daysPerWeek,
        sessionDuration: profile.user_goals?.session_duration || prev.sessionDuration,
        restDays: profile.user_goals?.rest_days || prev.restDays,
        programId: profile.user_goals?.program_id || prev.programId,
        equipment: profile.user_goals?.equipment || prev.equipment,
      }));

      // Sync allow_subscribers from profile to settings (only if explicitly set to true/false)
      if (typeof profile.allow_subscribers === 'boolean') {
        setSettings(prev => ({
          ...prev,
          social: { ...prev.social, allowSubscribers: profile.allow_subscribers }
        }));
      }

      // Update overview stats if goals exist
      if (profile.user_goals) {
        const goals = profile.user_goals;
        const currentW = goals.current_weight || 80;
        const goalW = goals.goal_weight || 75;
        const startW = goals.starting_weight || currentW;
        const weeks = goals.program_weeks || 16;
        const weeklyTarget = (goalW - currentW) / weeks;

        // Calculate program start date from goals created_at or use a reasonable default
        const startDate = goals.created_at ? new Date(goals.created_at) : new Date();

        // Calculate current program week based on start date
        const now = new Date();
        const msPerWeek = 7 * 24 * 60 * 60 * 1000;
        const weeksSinceStart = Math.floor((now - startDate) / msPerWeek) + 1;
        const currentProgramWeek = Math.min(weeksSinceStart, weeks);

        setOverviewStats(prev => ({
          ...prev,
          startingWeight: startW,
          currentWeight: currentW,
          targetWeight: goalW,
          weeklyTarget: parseFloat(weeklyTarget.toFixed(2)),
          programLength: weeks,
          programStartDate: getLocalDateString(startDate),
          programWeek: Math.max(1, currentProgramWeek),
        }));

        // Also update currentProgram to stay in sync
        setCurrentProgram(prev => ({
          ...prev,
          currentWeek: Math.max(1, currentProgramWeek),
          totalWeeks: weeks,
          daysPerWeek: goals.days_per_week || prev.daysPerWeek,
        }));

        // Calculate personalized nutrition targets
        const nutritionTargets = generateNutritionTargets({
          weight: currentW,
          height: profile.height || 175,
          age: profile.age || 25,
          gender: profile.gender || 'other',
          goal: goals.goal || 'fitness',
          workoutsPerWeek: goals.days_per_week || 4,
          goalWeight: goalW,
        });

        setNutritionGoals({
          calories: nutritionTargets.calories,
          protein: nutritionTargets.protein,
          carbs: nutritionTargets.carbs,
          fats: nutritionTargets.fat,
          water: nutritionTargets.water,
          tdee: nutritionTargets.tdee,
          weeklyWeightChange: nutritionTargets.weeklyWeightChange,
        });
      }

      // Load sleep goal from database
      if (profile.sleep_goals?.target_hours) {
        setSleepHours(profile.sleep_goals.target_hours);
      }
    }
  }, [profile, user]);

  // Load streaks from Supabase
  useEffect(() => {
    let isMounted = true;

    const loadStreaks = async () => {
      if (user?.id && isAuthenticated) {
        try {
          const result = await streakService.refreshAllStreaks(user.id);
          if (isMounted && result) {
            setStreaks({
              weeklyWorkouts: { weeksCompleted: result.workout?.streak || 0 },
              calories: { daysInRow: result.nutrition?.streak || 0 },
              protein: { daysInRow: result.nutrition?.streak || 0 },
              water: { daysInRow: result.water?.streak || 0 },
              sleep: { daysInRow: result.sleep?.streak || 0 },
              supplements: { daysInRow: 0 }, // Not tracked yet
            });
          }
        } catch (err) {
          console.warn('Error loading streaks:', err?.message || err);
        }
      }
    };

    loadStreaks();

    return () => { isMounted = false; };
  }, [user?.id, isAuthenticated]);

  // Load foods, exercises, and workout templates from database
  useEffect(() => {
    let isMounted = true;

    const loadStaticData = async () => {
      if (isAuthenticated) {
        setDataLoading(true);

        try {
          const [foodsResult, exercisesResult, templatesResult] = await Promise.all([
            foodService.getFoods(),
            exerciseService.getAllExercises(),
            workoutService.getWorkoutTemplates()
          ]);

          if (isMounted) {
            setAllFoods(foodsResult.data || []);
            setAllExercises(exercisesResult.data || []);

            // Convert templates array to object keyed by ID for backwards compatibility
            const templatesObj = {};
            (templatesResult.data || []).forEach(t => {
              templatesObj[t.id] = t;
            });
            setWorkoutTemplates(templatesObj);

            setDataLoading(false);
          }
        } catch (err) {
          console.warn('Error loading static data:', err?.message || err);
          if (isMounted) {
            setDataLoading(false);
          }
        }
      } else {
        // If not authenticated, still mark as loaded to allow app to render
        setDataLoading(false);
      }
    };

    loadStaticData();

    return () => { isMounted = false; };
  }, [isAuthenticated]);

  // Dynamic today's date - defined early for use in useEffects
  // Use local date, not UTC, to avoid timezone issues
  const today = new Date();
  const TODAY_DATE_KEY = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}-${String(today.getDate()).padStart(2, '0')}`;
  const currentYear = today.getFullYear();
  const currentMonth = today.getMonth();

  // Always use DEFAULT_ALL_EXERCISES for workout generation - database exercises may have different muscle group names
  // TODO: Standardize muscle group names in database to match WORKOUT_STRUCTURES
  const ALL_EXERCISES = DEFAULT_ALL_EXERCISES;

  // Use workout templates from database - create local reference for backward compatibility
  const WORKOUT_TEMPLATES = workoutTemplates;

  // Load today's nutrition data from database
  useEffect(() => {
    let isMounted = true;

    const loadTodayNutrition = async () => {
      if (!user?.id || !isAuthenticated) return;

      try {
        // Load today's daily nutrition totals
        const { data: dailyData, error: dailyError } = await nutritionService.getDailyNutrition(user.id, TODAY_DATE_KEY);
        if (dailyError) console.warn('Daily nutrition error:', dailyError?.message);
        if (isMounted && dailyData) {
          setCaloriesIntake(dailyData.total_calories || 0);
          setProteinIntake(dailyData.total_protein || 0);
          setCarbsIntake(dailyData.total_carbs || 0);
          setFatsIntake(dailyData.total_fats || 0);
          setWaterIntake(dailyData.water_intake || 0);
        }

        // Load today's meals
        const { data: meals, error: mealsError } = await nutritionService.getMeals(user.id, TODAY_DATE_KEY);
        if (mealsError) console.warn('Meals error:', mealsError?.message);
        if (isMounted && meals) {
          setMealLog(meals.map(meal => ({
            id: meal.id,
            name: meal.meal_name,
            time: meal.meal_time,
            calories: meal.calories,
            protein: meal.protein,
            carbs: meal.carbs,
            fats: meal.fats,
          })));
        }

        // Load frequent meals for the meal entry modal
        const { data: frequentMeals } = await nutritionService.getFrequentMeals(user.id, 8);
        if (isMounted && frequentMeals) {
          setFrequentMealsForModal(frequentMeals);
        }

        // Load user supplements
        setSupplementsLoading(true);
        const { data: userSupplements, error: suppError } = await nutritionService.getSupplements(user.id);
        if (suppError) {
          console.warn('Supplements error:', suppError?.message);
          setSupplementsLoading(false);
          return;
        }
        if (!userSupplements) {
          setSupplementsLoading(false);
          return;
        }
        if (isMounted && userSupplements) {
          // Load today's supplement logs to check which are taken
          const { data: supplementLogs } = await nutritionService.getSupplementLogs(user.id, TODAY_DATE_KEY);
          const takenIds = new Set(supplementLogs?.map(log => log.supplement_id) || []);

          setSupplements(userSupplements.map(supp => ({
            id: supp.id,
            name: supp.name,
            dosage: supp.dosage,
            time: supp.scheduled_time,
            taken: takenIds.has(supp.id),
          })));

          // Load supplement history for calendar (last 28 days)
          const startDate = new Date();
          startDate.setDate(startDate.getDate() - 27);
          const { data: supplementLogsRange } = await nutritionService.getSupplementLogsRange(
            user.id,
            getLocalDateString(startDate),
            TODAY_DATE_KEY
          );

          // Build history by date
          const historyMap = new Map();
          for (let i = 0; i < 28; i++) {
            const date = new Date();
            date.setDate(date.getDate() - i);
            const dateKey = getLocalDateString(date);
            historyMap.set(dateKey, { date: dateKey, completed: 0, total: userSupplements.length, allTaken: false });
          }

          // Count completed supplements per day
          supplementLogsRange?.forEach(log => {
            const dateKey = log.log_date;
            if (historyMap.has(dateKey)) {
              const day = historyMap.get(dateKey);
              day.completed++;
              day.allTaken = day.completed >= day.total;
            }
          });

          if (isMounted) {
            setSupplementHistory(Array.from(historyMap.values()).sort((a, b) => b.date.localeCompare(a.date)));
          }

          // Calculate supplement streak
          let streak = 0;
          const sortedHistory = Array.from(historyMap.values()).sort((a, b) => b.date.localeCompare(a.date));
          for (const day of sortedHistory) {
            if (day.allTaken && day.total > 0) {
              streak++;
            } else {
              break;
            }
          }

          if (isMounted) {
            setStreaks(prev => ({
              ...prev,
              supplements: { daysInRow: streak }
            }));
            setSupplementsLoading(false);
          }
        }
      } catch (err) {
        console.warn('Error loading nutrition data:', err?.message || err);
        setSupplementsLoading(false);
      }
    };

    loadTodayNutrition();

    return () => { isMounted = false; };
  }, [user?.id, isAuthenticated, TODAY_DATE_KEY]);

  // Load recent nutrition history for dynamic goal adjustment
  useEffect(() => {
    let isMounted = true;

    const loadRecentNutrition = async () => {
      if (!user?.id || !isAuthenticated) return;

      try {
        // Get the last 7 days (excluding today)
        const endDate = new Date();
        endDate.setDate(endDate.getDate() - 1); // Yesterday
        const startDate = new Date();
        startDate.setDate(startDate.getDate() - 7); // 7 days ago

        const { data, error } = await nutritionService.getNutritionHistory(
          user.id,
          getLocalDateString(startDate),
          getLocalDateString(endDate)
        );

        if (error) {
          console.warn('Recent nutrition history error:', error?.message);
          return;
        }

        if (isMounted && data) {
          setRecentNutritionHistory(data);

          // Check if yesterday's data is missing or unrealistically low
          const yesterday = new Date();
          yesterday.setDate(yesterday.getDate() - 1);
          const yesterdayStr = getLocalDateString(yesterday);

          // Find yesterday's entry in the data
          const yesterdayEntry = data.find(d => d.log_date === yesterdayStr);
          const yesterdayCalories = yesterdayEntry?.total_calories || 0;
          const yesterdayWater = yesterdayEntry?.water_intake || 0;

          // Thresholds for "unrealistically low" - likely forgot to log
          const MIN_REALISTIC_CALORIES = 500; // Less than 500 cal is definitely a missed day
          const MIN_REALISTIC_WATER = 500; // Less than 500ml is definitely a missed day

          const isMissedDay = yesterdayCalories < MIN_REALISTIC_CALORIES || yesterdayWater < MIN_REALISTIC_WATER;

          // Only show prompt if:
          // 1. Day was missed
          // 2. User hasn't dismissed this specific day's prompt
          // 3. We're not already showing it
          if (isMissedDay) {
            const savedDismiss = localStorage.getItem('uprep_missed_day_dismissed');
            const dismissedDate = savedDismiss ? JSON.parse(savedDismiss) : null;

            if (dismissedDate !== yesterdayStr) {
              setMissedDayData({
                date: yesterdayStr,
                dateLabel: yesterday.toLocaleDateString('en-US', { weekday: 'long', month: 'short', day: 'numeric' }),
                calories: yesterdayCalories,
                water: yesterdayWater,
              });
              setShowMissedDayPrompt(true);
            }
          }
        }
      } catch (err) {
        console.warn('Error loading recent nutrition:', err?.message || err);
      }
    };

    loadRecentNutrition();

    return () => { isMounted = false; };
  }, [user?.id, isAuthenticated]);

  // Load weekly nutrition data for charts
  useEffect(() => {
    let isMounted = true;

    const loadWeeklyNutrition = async () => {
      if (!user?.id || !isAuthenticated) return;

      try {
        // Get last 7 weeks of data
        const endDate = new Date();
        const startDate = new Date();
        startDate.setDate(startDate.getDate() - 49); // 7 weeks

        const { data, error } = await nutritionService.getNutritionHistory(
          user.id,
          getLocalDateString(startDate),
          getLocalDateString(endDate)
        );

        if (error) {
          console.warn('Weekly nutrition history error:', error?.message);
          return;
        }

        if (isMounted && data && data.length > 0) {
          // Group by week
          const weeklyData = {};
          const now = new Date();

          data.forEach(entry => {
            if (!entry?.log_date) return;
            const entryDate = new Date(entry.log_date);
            const daysDiff = Math.floor((now - entryDate) / (24 * 60 * 60 * 1000));
            const weekNum = Math.floor(daysDiff / 7) + 1;

            if (weekNum <= 7) {
              if (!weeklyData[weekNum]) {
                weeklyData[weekNum] = { calories: 0, caloriesCount: 0, water: 0, waterCount: 0 };
              }
              if (entry.total_calories) {
                weeklyData[weekNum].calories += entry.total_calories;
                weeklyData[weekNum].caloriesCount++;
              }
              // Check both water_intake (database field) and total_water (legacy)
              const waterAmount = entry.water_intake || entry.total_water;
              if (waterAmount) {
                weeklyData[weekNum].water += waterAmount;
                weeklyData[weekNum].waterCount++;
              }
            }
          });

          // Build chart data array (most recent week last)
          const chartData = [];
          for (let week = 7; week >= 1; week--) {
            const weekData = weeklyData[week];
            chartData.push({
              week: week === 1 ? 'This Week' : `${week}w ago`,
              calories: weekData?.caloriesCount ? Math.round(weekData.calories / weekData.caloriesCount) : null,
              water: weekData?.waterCount ? Math.round(weekData.water / weekData.waterCount) : null,
              goal: 2500, // Will be overridden by actual goal in render
              waterGoal: 2500, // Will be overridden by actual goal in render
            });
          }

          setWeeklyNutrition(chartData);
        }
      } catch (err) {
        console.warn('Error loading weekly nutrition:', err?.message || err);
      }
    };

    loadWeeklyNutrition();

    return () => { isMounted = false; };
  }, [user?.id, isAuthenticated]);

  // Load monthly tracking data for calendar views
  useEffect(() => {
    let isMounted = true;

    const loadMonthlyTracking = async () => {
      if (!user?.id || !isAuthenticated) return;

      try {
        const endDate = new Date();
        const startDate = new Date();
        startDate.setDate(startDate.getDate() - 35);

        const startStr = getLocalDateString(startDate);
        const endStr = getLocalDateString(endDate);

        // Load nutrition, supplements, and sleep data in parallel
        const [nutritionResult, sleepResult] = await Promise.all([
          nutritionService.getNutritionHistory(user.id, startStr, endStr),
          sleepService.getRecentSleep(user.id, 35),
        ]);

        if (isMounted) {
          const nutritionByDay = {};
          const sleepByDay = {};

          // Process nutrition data (use default 2200 cal goal for initial load)
          const defaultCalorieGoal = 2200;
          if (nutritionResult.data) {
            nutritionResult.data.forEach(entry => {
              if (entry?.log_date) {
                const calorieGoalMet = entry.total_calories >= (defaultCalorieGoal * 0.85) &&
                                       entry.total_calories <= (defaultCalorieGoal * 1.15);
                nutritionByDay[entry.log_date] = {
                  calories: entry.total_calories || 0,
                  protein: entry.total_protein || 0,
                  water: entry.water_intake || entry.total_water || 0,
                  goalMet: calorieGoalMet,
                };
              }
            });
          }

          // Process sleep data
          if (sleepResult.data) {
            sleepResult.data.forEach(entry => {
              if (entry?.log_date) {
                sleepByDay[entry.log_date] = {
                  hours: entry.hours_slept || 0,
                  goalMet: (entry.hours_slept || 0) >= 7,
                };
              }
            });
          }

          setMonthlyTracking({
            nutrition: nutritionByDay,
            supplements: {}, // Will be populated from supplementHistory
            sleep: sleepByDay,
          });
        }
      } catch (err) {
        console.warn('Error loading monthly tracking:', err?.message || err);
      }
    };

    loadMonthlyTracking();

    return () => { isMounted = false; };
  }, [user?.id, isAuthenticated]);

  // Load injuries from database
  useEffect(() => {
    let isMounted = true;

    const loadInjuries = async () => {
      if (!user?.id || !isAuthenticated) return;

      try {
        // Sync injury phases based on current date and get active injuries
        const { data: activeInjuries, error } = await injuryService.syncInjuryPhases(user.id);
        if (error) {
          console.warn('Injuries error:', error?.message);
          return;
        }

        if (isMounted && activeInjuries) {
          // Convert database format to app format
          setInjuries(activeInjuries.map(injury => ({
            id: injury.id,
            muscleGroup: injury.muscle_group,
            severity: injury.severity,
            notes: injury.notes,
            reportedDate: injury.reported_date,
            timeline: injury.timeline,
          })));
        }
      } catch (err) {
        console.warn('Error loading injuries:', err?.message || err);
      }
    };

    loadInjuries();

    return () => { isMounted = false; };
  }, [user?.id, isAuthenticated]);

  // Load social data (following list, suggested users) - wrapped in defensive try-catch
  useEffect(() => {
    let isMounted = true;

    const loadSocialData = async () => {
      if (!user?.id || !isAuthenticated) return;

      try {
        // Load list of users we're following
        const result = await socialService.getFollowing(user.id);
        if (isMounted && result?.data && Array.isArray(result.data)) {
          setFollowingIds(new Set(result.data.filter(id => id != null)));
        }
      } catch (err) {
        // Silently fail - database tables may not exist yet
        console.warn('Social data not available:', err?.message);
      }

      try {
        // Load suggested users
        const result = await socialService.getSuggestedUsers(user.id, 10);
        if (isMounted && result?.data && Array.isArray(result.data)) {
          setSuggestedFriends(result.data);
        }
      } catch (err) {
        console.warn('Suggested users not available:', err?.message);
      }

      try {
        // Load followers count
        const result = await socialService.getFollowersCount(user.id);
        if (isMounted && typeof result?.count === 'number') {
          setFollowersCount(result.count);
        }
      } catch (err) {
        console.warn('Followers count not available:', err?.message);
      }

      try {
        // Load full friend/following list with profile data
        const result = await profileService.getSubscriptions(user.id);
        if (isMounted && result?.data && Array.isArray(result.data)) {
          // Get user IDs to fetch workout statuses
          const userIds = result.data.map(f => f.friend_id).filter(Boolean);

          // Fetch workout statuses for all friends
          let workoutStatuses = {};
          if (userIds.length > 0) {
            const statusResult = await workoutService.getWorkoutStatuses(userIds);
            workoutStatuses = statusResult?.data || {};
          }

          // Helper to format time ago
          const formatLastActive = (dateStr) => {
            if (!dateStr) return null;
            const date = new Date(dateStr);
            const now = new Date();
            const diffMs = now - date;
            const diffMins = Math.floor(diffMs / (1000 * 60));
            const diffHours = Math.floor(diffMs / (1000 * 60 * 60));
            const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));
            if (diffMins < 60) return `${diffMins}m ago`;
            if (diffHours < 24) return `${diffHours}h ago`;
            if (diffDays === 1) return 'Yesterday';
            if (diffDays < 7) return `${diffDays}d ago`;
            return `${Math.floor(diffDays / 7)}w ago`;
          };

          const friendsList = result.data.map(f => {
            const firstName = f.profiles?.first_name || '';
            const lastName = f.profiles?.last_name || '';
            const status = workoutStatuses[f.friend_id];

            // Determine last active time
            let lastActive = null;
            if (status?.status === 'working_out') {
              lastActive = 'Working out now';
            } else if (status?.status === 'just_finished') {
              lastActive = `${status.minutesAgo}m ago`;
            } else if (f.profiles?.updated_at) {
              lastActive = formatLastActive(f.profiles.updated_at);
            }

            return {
              id: f.friend_id,
              name: `${firstName} ${lastName}`.trim() || f.profiles?.username || 'User',
              username: f.profiles?.username || 'user',
              avatar: f.profiles?.avatar_url || firstName?.[0]?.toUpperCase() || '?',
              bio: f.profiles?.bio || '',
              program: f.profiles?.bio?.slice(0, 30) || 'Fitness enthusiast',
              isOnline: status?.status === 'working_out', // Online if currently working out
              streak: 0, // Will be calculated when viewing profile
              lastActive: lastActive,
              // Workout status
              workoutStatus: status?.status || null, // 'working_out' or 'just_finished'
              currentWorkout: status?.workoutName || null,
              workoutDuration: status?.duration || null,
              finishedMinutesAgo: status?.minutesAgo || null,
            };
          });
          setFriends(friendsList);
        }
      } catch (err) {
        console.warn('Friends list not available:', err?.message);
      }

      try {
        // Load notifications
        const result = await notificationService.getNotifications(user.id, 20);
        if (isMounted && result?.data) {
          setNotifications(result.data);
        }
        const unreadResult = await notificationService.getUnreadCount(user.id);
        if (isMounted && typeof unreadResult?.count === 'number') {
          setUnreadCount(unreadResult.count);
        }
      } catch (err) {
        console.warn('Notifications not available:', err?.message);
      }

      try {
        // Load activity feed from followed users
        const result = await socialService.getActivityFeed(user.id, 30);
        if (isMounted && result?.data) {
          setActivityFeed(result.data);
        }

        // Load user's likes from database
        const likesResult = await socialService.getUserLikes(user.id);
        if (isMounted && likesResult?.data) {
          const likesMap = {};
          likesResult.data.forEach(like => {
            likesMap[like.activity_id] = like.reaction_type || 'like';
          });
          setUserLikes(likesMap);
          // Also sync to likedPosts for backwards compatibility
          setLikedPosts(likesResult.data.map(like => like.activity_id));
        }
      } catch (err) {
        console.warn('Activity feed not available:', err?.message);
      }

      // Load weekly leaderboard
      try {
        const leaderboardResult = await competitionService.getFriendsLeaderboard(user.id, 'workouts', 10);
        if (isMounted && leaderboardResult?.data) {
          setWeeklyLeaderboard(leaderboardResult.data);
        }
      } catch (err) {
        console.warn('Leaderboard not available:', err?.message);
      }

      // Load workout buddy
      try {
        const buddyResult = await accountabilityService.getBuddy(user.id);
        if (isMounted && buddyResult?.data) {
          setWorkoutBuddy(buddyResult.data);
        }
        const requestsResult = await accountabilityService.getPendingBuddyRequests(user.id);
        if (isMounted && requestsResult?.data) {
          setBuddyRequests(requestsResult.data);
        }
      } catch (err) {
        console.warn('Buddy data not available:', err?.message);
      }

      // Load shared goals
      try {
        const goalsResult = await accountabilityService.getSharedGoals(user.id);
        if (isMounted && goalsResult?.data) {
          setSharedGoals(goalsResult.data);
        }
      } catch (err) {
        console.warn('Shared goals not available:', err?.message);
      }
    };

    loadSocialData();

    return () => { isMounted = false; };
  }, [user?.id, isAuthenticated]);

  // Load chart data from database
  useEffect(() => {
    let isMounted = true;

    const loadChartData = async () => {
      if (!user?.id || !isAuthenticated || !profile?.user_goals) return;

      const goals = profile.user_goals;
      const startWeight = goals.starting_weight || goals.current_weight || 80;
      const goalWeight = goals.goal_weight || startWeight;
      const programWeeks = goals.program_weeks || 16;
      const workoutsPerWeek = goals.days_per_week || 4;

      try {
        // Load weight history
        const { data: weightData, error: weightError } = await profileService.getWeightHistory(user.id, programWeeks * 7);
        if (weightError) console.warn('Weight history error:', weightError?.message);

        // Group weight data by week
        const weightByWeek = {};
        if (weightData && weightData.length > 0) {
          weightData.forEach(entry => {
            if (!entry?.log_date || entry?.weight == null) return;
            const weekNum = Math.ceil(
              (new Date(entry.log_date) - new Date(weightData[weightData.length - 1].log_date)) / (7 * 24 * 60 * 60 * 1000)
            ) + 1;
            if (!weightByWeek[weekNum] || entry.log_date > weightByWeek[weekNum].date) {
              weightByWeek[weekNum] = { weight: entry.weight, date: entry.log_date };
            }
          });
        }

        // Generate weight chart data with projections
        const weightChartData = [];
        const weeklyChange = programWeeks > 0 ? (goalWeight - startWeight) / programWeeks : 0;
        for (let week = 1; week <= Math.min(programWeeks, 16); week++) {
          const expectedWeight = startWeight + (weeklyChange * week);
          const actualWeight = weightByWeek[week]?.weight;
          weightChartData.push({
            week: week.toString(),
            value: actualWeight || null,
            expected: parseFloat(expectedWeight.toFixed(1)),
          });
        }

        // Load workout history
        const { data: workoutData, error: workoutError } = await workoutService.getWorkoutHistory(user.id, 100);
        if (workoutError) console.warn('Workout history error:', workoutError?.message);

        // Group workouts by week
        const workoutsByWeek = {};
        if (workoutData && workoutData.length > 0) {
          workoutData.forEach(session => {
            if (!session?.started_at) return;
            const sessionDate = new Date(session.started_at);
            const weekNum = Math.ceil(
              (new Date() - sessionDate) / (7 * 24 * 60 * 60 * 1000)
            );
            const displayWeek = Math.min(16, Math.max(1, 16 - weekNum + 1));
            workoutsByWeek[displayWeek] = (workoutsByWeek[displayWeek] || 0) + 1;
          });
        }

        // Generate workout chart data
        const workoutChartData = [];
        for (let week = 1; week <= 16; week++) {
          workoutChartData.push({
            week: week.toString(),
            value: workoutsByWeek[week] || 0,
            expected: workoutsPerWeek,
          });
        }

        // Load sleep history
        const { data: sleepData, error: sleepError } = await sleepService.getRecentSleep(user.id, 84); // 12 weeks
        if (sleepError) console.warn('Sleep history error:', sleepError?.message);

        // Group sleep by week - Week 1 = start of program (current), Week 12 = end (future)
        // Calculate weeks since program start based on current program week
        const sleepByWeek = {};
        const now = new Date();
        if (sleepData && sleepData.length > 0) {
          sleepData.forEach(entry => {
            if (!entry?.log_date || entry?.hours_slept == null) return;
            const entryDate = new Date(entry.log_date);
            const daysDiff = Math.floor((now - entryDate) / (24 * 60 * 60 * 1000));
            const weeksAgo = Math.floor(daysDiff / 7); // 0 = current week
            // Week 1 = current week, Week 2 = next week (future), etc.
            // But we can only have data for past/current weeks
            const displayWeek = 1 - weeksAgo; // This gives us: current=1, 1 week ago=0, etc.
            // We want: current week = Week 1, last week would be before program started
            // So only current week (weeksAgo=0) maps to Week 1
            const programWeek = 1 - weeksAgo;

            if (programWeek >= 1 && programWeek <= 12) {
              if (!sleepByWeek[programWeek]) {
                sleepByWeek[programWeek] = { total: 0, count: 0 };
              }
              sleepByWeek[programWeek].total += entry.hours_slept;
              sleepByWeek[programWeek].count++;
            }
          });
        }

        // Generate sleep chart data - Week 1 (current/start) on left, Week 12 (future/end) on right
        const sleepChartDataNew = [];
        for (let week = 1; week <= 12; week++) {
          const weekData = sleepByWeek[week];
          sleepChartDataNew.push({
            week: week.toString(),
            value: weekData ? parseFloat((weekData.total / weekData.count).toFixed(1)) : null,
            goal: 8,
          });
        }

        // Generate volume chart data (total weight lifted per week)
        const volumeByWeek = {};
        if (workoutData && workoutData.length > 0) {
          workoutData.forEach(session => {
            if (!session?.started_at) return;
            const sessionDate = new Date(session.started_at);
            const weekNum = Math.ceil((now - sessionDate) / (7 * 24 * 60 * 60 * 1000));
            const displayWeek = Math.min(16, Math.max(1, 16 - weekNum + 1));

            // Sum volume from all sets in this session
            let sessionVolume = 0;
            if (session.workout_sets) {
              session.workout_sets.forEach(set => {
                if (!set.is_warmup && set.weight && set.reps) {
                  sessionVolume += set.weight * set.reps;
                }
              });
            }
            volumeByWeek[displayWeek] = (volumeByWeek[displayWeek] || 0) + sessionVolume;
          });
        }
        const volumeChartData = [];
        for (let week = 1; week <= 16; week++) {
          volumeChartData.push({
            week: week.toString(),
            value: volumeByWeek[week] ? Math.round(volumeByWeek[week]) : null,
            expected: null,
          });
        }

        // Generate lift PR charts (bench, squat, deadlift, ohp)
        const liftPRsByWeek = { bench: {}, squat: {}, deadlift: {}, ohp: {} };
        const liftPatterns = {
          bench: /bench press/i,
          squat: /squat/i,
          deadlift: /deadlift/i,
          ohp: /overhead press|ohp|shoulder press/i,
        };

        if (workoutData && workoutData.length > 0) {
          workoutData.forEach(session => {
            if (!session?.started_at || !session.workout_sets) return;
            const sessionDate = new Date(session.started_at);
            const weekNum = Math.ceil((now - sessionDate) / (7 * 24 * 60 * 60 * 1000));
            const displayWeek = Math.min(16, Math.max(1, 16 - weekNum + 1));

            session.workout_sets.forEach(set => {
              if (set.is_warmup || !set.weight || !set.reps) return;
              const e1rm = set.weight * (1 + set.reps / 30); // Epley formula

              Object.entries(liftPatterns).forEach(([lift, pattern]) => {
                if (pattern.test(set.exercise_name)) {
                  if (!liftPRsByWeek[lift][displayWeek] || e1rm > liftPRsByWeek[lift][displayWeek]) {
                    liftPRsByWeek[lift][displayWeek] = Math.round(e1rm);
                  }
                }
              });
            });
          });
        }

        const liftChartData = {};
        ['bench', 'squat', 'deadlift', 'ohp'].forEach(lift => {
          liftChartData[lift] = [];
          for (let week = 1; week <= 16; week++) {
            liftChartData[lift].push({
              week: week.toString(),
              value: liftPRsByWeek[lift][week] || null,
              expected: null,
            });
          }
        });

        // Load nutrition data for calories/protein charts
        let caloriesChartData = [];
        let proteinChartData = [];
        try {
          const endDate = new Date();
          const startDate = new Date();
          startDate.setDate(startDate.getDate() - 112); // 16 weeks

          const { data: nutritionData } = await nutritionService.getNutritionHistory(
            user.id,
            getLocalDateString(startDate),
            getLocalDateString(endDate)
          );

          if (nutritionData && nutritionData.length > 0) {
            const caloriesByWeek = {};
            const proteinByWeek = {};

            nutritionData.forEach(entry => {
              if (!entry?.log_date) return;
              const entryDate = new Date(entry.log_date);
              const weekNum = Math.ceil((now - entryDate) / (7 * 24 * 60 * 60 * 1000));
              const displayWeek = Math.min(16, Math.max(1, 16 - weekNum + 1));

              if (!caloriesByWeek[displayWeek]) {
                caloriesByWeek[displayWeek] = { total: 0, count: 0 };
                proteinByWeek[displayWeek] = { total: 0, count: 0 };
              }
              if (entry.total_calories) {
                caloriesByWeek[displayWeek].total += entry.total_calories;
                caloriesByWeek[displayWeek].count++;
              }
              if (entry.total_protein) {
                proteinByWeek[displayWeek].total += entry.total_protein;
                proteinByWeek[displayWeek].count++;
              }
            });

            for (let week = 1; week <= 16; week++) {
              const calData = caloriesByWeek[week];
              const proData = proteinByWeek[week];
              caloriesChartData.push({
                week: week.toString(),
                value: calData ? Math.round(calData.total / calData.count) : null,
                expected: 2500, // Default target
              });
              proteinChartData.push({
                week: week.toString(),
                value: proData ? Math.round(proData.total / proData.count) : null,
                expected: 150, // Default target
              });
            }
          }
        } catch (err) {
          console.warn('Error loading nutrition chart data:', err);
        }

        // Generate sleep chart for main chart selector (different format)
        const sleepMainChartData = [];
        for (let week = 1; week <= 16; week++) {
          // Map from 12-week sleep data to 16-week display
          const sleepWeek = Math.min(12, week);
          const weekData = sleepByWeek[sleepWeek];
          sleepMainChartData.push({
            week: week.toString(),
            value: weekData ? parseFloat((weekData.total / weekData.count).toFixed(1)) : null,
            expected: 8,
          });
        }

        if (isMounted) {
          // Update total workouts count from actual data
          const totalCompletedWorkouts = workoutData?.length || 0;
          setOverviewStats(prev => ({
            ...prev,
            totalWorkouts: totalCompletedWorkouts,
          }));

          setChartData(prev => ({
            ...prev,
            weight: weightChartData,
            workouts: workoutChartData,
            volume: volumeChartData,
            bench: liftChartData.bench,
            squat: liftChartData.squat,
            deadlift: liftChartData.deadlift,
            ohp: liftChartData.ohp,
            sleep: sleepMainChartData,
            calories: caloriesChartData.length > 0 ? caloriesChartData : [],
            protein: proteinChartData.length > 0 ? proteinChartData : [],
          }));
          setSleepChartData(sleepChartDataNew);
        }

      } catch (err) {
        console.warn('Error loading chart data:', err?.message || err);
      }
    };

    loadChartData();

    return () => { isMounted = false; };
  }, [user?.id, isAuthenticated, profile?.user_goals]);

  // Load weekly weight averages for dynamic goals
  useEffect(() => {
    let isMounted = true;

    const loadWeeklyWeightData = async () => {
      if (!user?.id || !isAuthenticated) return;

      try {
        const result = await profileService.getWeeklyWeightAverages(user.id, 8);
        if (isMounted && result?.data) {
          setWeeklyWeightData({
            actualWeeklyRate: result.data.actualWeeklyRate ?? 0,
            weeklyAverages: result.data.weeklyAverages ?? [],
            latestAverage: result.data.latestAverage ?? null,
          });
        }
      } catch (err) {
        // Fail silently - this feature is optional
        console.warn('Weekly weight data unavailable:', err?.message || err);
      }
    };

    loadWeeklyWeightData();

    return () => { isMounted = false; };
  }, [user?.id, isAuthenticated]);

  // Load sleep entry for selected date
  useEffect(() => {
    let isMounted = true;

    const loadSleepData = async () => {
      if (!user?.id || !isAuthenticated) return;

      try {
        // Get recent sleep entries to find defaults
        const { data: recentSleep } = await sleepService.getRecentSleep(user.id, 14);

        // Find the most recent entry with bed_time and wake_time
        const recentWithTimes = (recentSleep || []).find(entry => entry.bed_time && entry.wake_time);

        // Check if selected date's entry exists (already logged)
        const { data: sleepEntry } = await sleepService.getSleepLog(user.id, selectedSleepDate);

        if (isMounted) {
          if (sleepEntry) {
            // Load existing entry for selected date and show as confirmed
            setLastNightBedTime(sleepEntry.bed_time || '23:00');
            setLastNightWakeTime(sleepEntry.wake_time || '06:30');
            setLastNightConfirmed(true);
          } else {
            // No entry for this date - show edit form with defaults
            setLastNightConfirmed(false);
            if (recentWithTimes) {
              setLastNightBedTime(recentWithTimes.bed_time);
              setLastNightWakeTime(recentWithTimes.wake_time);
            } else {
              setLastNightBedTime('23:00');
              setLastNightWakeTime('06:30');
            }
          }

          // Update target sleep times defaults
          if (recentWithTimes) {
            setBedTime(recentWithTimes.bed_time);
            setWakeTime(recentWithTimes.wake_time);
          }
        }
      } catch (err) {
        console.warn('Error loading sleep data:', err?.message || err);
      }
    };

    loadSleepData();

    return () => { isMounted = false; };
  }, [user?.id, isAuthenticated, selectedSleepDate]);

  // Function to refresh sleep chart data (called after saving sleep)
  const refreshSleepChartData = async () => {
    if (!user?.id) return;

    try {
      const { data: sleepData } = await sleepService.getRecentSleep(user.id, 84);

      if (!sleepData) return;

      // Group sleep by week - Week 1 = start of program (current), Week 12 = end (future)
      const sleepByWeek = {};
      const now = new Date();

      sleepData.forEach(entry => {
        if (!entry?.log_date || entry?.hours_slept == null) return;
        const entryDate = new Date(entry.log_date);
        const daysDiff = Math.floor((now - entryDate) / (24 * 60 * 60 * 1000));
        const weeksAgo = Math.floor(daysDiff / 7); // 0 = current week
        const programWeek = 1 - weeksAgo; // Week 1 = current, data before program start is ignored

        if (programWeek >= 1 && programWeek <= 12) {
          if (!sleepByWeek[programWeek]) {
            sleepByWeek[programWeek] = { total: 0, count: 0 };
          }
          sleepByWeek[programWeek].total += entry.hours_slept;
          sleepByWeek[programWeek].count++;
        }
      });

      // Generate chart data - Week 1 (current/start) on left, Week 12 (future/end) on right
      const newSleepChartData = [];
      for (let week = 1; week <= 12; week++) {
        const weekData = sleepByWeek[week];
        newSleepChartData.push({
          week: week.toString(),
          value: weekData ? parseFloat((weekData.total / weekData.count).toFixed(1)) : null,
          goal: 8,
        });
      }

      setSleepChartData(newSleepChartData);
    } catch (err) {
      console.warn('Error refreshing sleep chart:', err);
    }
  };

  const [showActiveWorkout, setShowActiveWorkout] = useState(false);
  const [partialWorkoutProgress, setPartialWorkoutProgress] = useState(null); // Tracks incomplete workout for resume
  const [workoutTime, setWorkoutTime] = useState(60);
  const [showTimeEditor, setShowTimeEditor] = useState(false);
  const [expandedExerciseId, setExpandedExerciseId] = useState(null);
  const [exerciseListCollapsed, setExerciseListCollapsed] = useState(true); // Start collapsed by default
  const [customizedExercises, setCustomizedExercises] = useState(null); // null = use default, array = customized
  const [customExerciseCount, setCustomExerciseCount] = useState(null); // null = use default (workoutTime / 12), number = override
  const workoutTabScrollRef = useRef(null);
  const profileTabScrollRef = useRef(null);
  const friendsTabScrollRef = useRef(null);
  const workoutTabScrollPos = useRef(0);
  const profileTabScrollPos = useRef(0);
  const friendsTabScrollPos = useRef(0);
  const goalChangeInProgressRef = useRef(false); // Prevent profile sync from overwriting goal during change

  // Track scroll position on workouts tab
  const handleWorkoutTabScroll = (e) => {
    workoutTabScrollPos.current = e.target.scrollTop;
  };

  // Track scroll position on profile tab
  const handleProfileTabScroll = (e) => {
    profileTabScrollPos.current = e.target.scrollTop;
  };

  // Restore profile tab scroll position after re-renders
  useEffect(() => {
    if (activeTab === 'profile' && profileTabScrollRef.current && profileTabScrollPos.current > 0) {
      // Use requestAnimationFrame to ensure DOM has updated
      requestAnimationFrame(() => {
        if (profileTabScrollRef.current) {
          profileTabScrollRef.current.scrollTop = profileTabScrollPos.current;
        }
      });
    }
  });

  // Track scroll position on friends tab
  const handleFriendsTabScroll = (e) => {
    friendsTabScrollPos.current = e.target.scrollTop;
  };

  // Toggle expanded workout with scroll preservation (for friends tab)
  const setExpandedWorkoutIdWithScroll = (id) => {
    const scrollTop = friendsTabScrollRef.current?.scrollTop;
    setExpandedWorkoutId(id);
    requestAnimationFrame(() => {
      if (friendsTabScrollRef.current && scrollTop !== undefined) {
        friendsTabScrollRef.current.scrollTop = scrollTop;
      }
    });
  };

  // Toggle equipment in profile settings with scroll preservation
  const toggleProfileEquipmentWithScroll = (equipId) => {
    const scrollTop = profileTabScrollRef.current?.scrollTop;
    setUserData(p => {
      const current = p.equipment || [];
      if (current.includes(equipId)) {
        return { ...p, equipment: current.filter(e => e !== equipId) };
      } else {
        return { ...p, equipment: [...current, equipId] };
      }
    });
    requestAnimationFrame(() => {
      if (profileTabScrollRef.current && scrollTop !== undefined) {
        profileTabScrollRef.current.scrollTop = scrollTop;
      }
    });
  };

  // Toggle exercise list with scroll preservation
  const toggleExerciseListWithScroll = () => {
    const scrollTop = workoutTabScrollRef.current?.scrollTop;
    setExerciseListCollapsed(prev => !prev);
    requestAnimationFrame(() => {
      if (workoutTabScrollRef.current && scrollTop !== undefined) {
        workoutTabScrollRef.current.scrollTop = scrollTop;
      }
    });
  };

  // Show/hide exercise info with scroll preservation
  const showExerciseInfoWithScroll = (exerciseName) => {
    const scrollTop = workoutTabScrollRef.current?.scrollTop;
    setShowExerciseInfo(exerciseName);
    requestAnimationFrame(() => {
      if (workoutTabScrollRef.current && scrollTop !== undefined) {
        workoutTabScrollRef.current.scrollTop = scrollTop;
      }
    });
  };

  // Toggle warmup/cooldown with scroll preservation (for friends tab)
  const toggleWarmupCooldownWithScroll = (workoutId, type) => {
    const scrollTop = friendsTabScrollRef.current?.scrollTop;
    setWorkoutWarmupCooldown(prev => ({
      ...prev,
      [workoutId]: { ...prev[workoutId], [type]: !(prev[workoutId]?.[type] ?? true) }
    }));
    requestAnimationFrame(() => {
      if (friendsTabScrollRef.current && scrollTop !== undefined) {
        friendsTabScrollRef.current.scrollTop = scrollTop;
      }
    });
  };

  // Show/hide exercise info with friends tab scroll preservation
  const showExerciseInfoFriendsTab = (exerciseName) => {
    const scrollTop = friendsTabScrollRef.current?.scrollTop;
    setShowExerciseInfo(exerciseName);
    requestAnimationFrame(() => {
      if (friendsTabScrollRef.current && scrollTop !== undefined) {
        friendsTabScrollRef.current.scrollTop = scrollTop;
      }
    });
  };

  // Like/unlike activity with scroll preservation (Friends tab)
  const handleActivityLike = async (activityId, friendId, reactionType = 'like') => {
    const scrollTop = friendsTabScrollRef.current?.scrollTop;
    const isLiked = userLikes[activityId];

    if (isLiked && reactionType === userLikes[activityId]) {
      // Unlike if same reaction
      setUserLikes(prev => { const newLikes = { ...prev }; delete newLikes[activityId]; return newLikes; });
      setLikedPosts(prev => prev.filter(id => id !== activityId));
      await socialService.unlikeActivity(activityId, user?.id);
    } else {
      // Add new reaction or change existing
      setUserLikes(prev => ({ ...prev, [activityId]: reactionType }));
      if (!isLiked) setLikedPosts(prev => [...prev, activityId]);
      await socialService.likeActivity(activityId, user?.id, reactionType);
      if (friendId && friendId !== user?.id && !isLiked) {
        const userName = `${profile?.first_name || ''} ${profile?.last_name || ''}`.trim() || profile?.username || 'Someone';
        notificationService.notifyWorkoutLike(friendId, user?.id, userName, activityId);
      }
    }

    requestAnimationFrame(() => {
      if (friendsTabScrollRef.current && scrollTop !== undefined) {
        friendsTabScrollRef.current.scrollTop = scrollTop;
      }
    });
  };

  // State for reaction picker
  const [showReactionPicker, setShowReactionPicker] = useState(null); // activityId or null

  // Like/unlike activity with scroll preservation (Home tab)
  const handleHomeActivityLike = async (activityId, friendId, reactionType = 'like') => {
    const isLiked = userLikes[activityId];

    if (isLiked && reactionType === userLikes[activityId]) {
      // Unlike if same reaction
      setUserLikes(prev => { const newLikes = { ...prev }; delete newLikes[activityId]; return newLikes; });
      setLikedPosts(prev => prev.filter(id => id !== activityId));
      await socialService.unlikeActivity(activityId, user?.id);
    } else {
      // Add new reaction or change existing
      setUserLikes(prev => ({ ...prev, [activityId]: reactionType }));
      if (!isLiked) setLikedPosts(prev => [...prev, activityId]);
      await socialService.likeActivity(activityId, user?.id, reactionType);
      if (friendId && friendId !== user?.id && !isLiked) {
        const userName = `${profile?.first_name || ''} ${profile?.last_name || ''}`.trim() || profile?.username || 'Someone';
        notificationService.notifyWorkoutLike(friendId, user?.id, userName, activityId);
      }
    }
  };

  // Load head-to-head data when friend profile is opened
  const loadHeadToHead = async (friendId) => {
    if (!user?.id || !friendId) return;
    setHeadToHeadLoading(true);
    try {
      const result = await competitionService.getHeadToHead(user.id, friendId, headToHeadPeriod);
      if (result?.data) {
        setHeadToHeadData(result.data);
      }
    } catch (err) {
      console.warn('Error loading head-to-head:', err?.message);
    } finally {
      setHeadToHeadLoading(false);
    }
  };

  // Load PR leaderboard data
  const loadPRLeaderboard = async () => {
    if (!user?.id) return;
    setPrLeaderboardLoading(true);
    try {
      const result = await prLeaderboardService.getMyPRsWithRankings(user.id);
      if (result?.data) {
        // Also load demographic rankings for each PR
        const prsWithDemographics = await Promise.all(
          result.data.map(async (pr) => {
            const demographicRanking = await prLeaderboardService.getPRRankingByDemographic(
              user.id,
              pr.exercise_name,
              prLeaderboardFilter === 'global' ? 'age' : prLeaderboardFilter
            );
            return { ...pr, demographicRanking };
          })
        );
        setPrLeaderboardData(prsWithDemographics);
      }
    } catch (err) {
      console.warn('Error loading PR leaderboard:', err?.message);
    } finally {
      setPrLeaderboardLoading(false);
    }
  };

  // Load exercise leaderboard when exercise is selected
  const loadExerciseLeaderboard = async (exerciseName) => {
    if (!exerciseName) return;
    try {
      const result = await prLeaderboardService.getExerciseLeaderboard(exerciseName, 20);
      if (result?.data) {
        setExerciseLeaderboard(result.data);
      }
    } catch (err) {
      console.warn('Error loading exercise leaderboard:', err?.message);
    }
  };

  // Expand/collapse exercise with scroll preservation
  const toggleExpandedExercise = (exerciseId) => {
    const scrollTop = workoutTabScrollRef.current?.scrollTop;
    setExpandedExerciseId(prev => prev === exerciseId ? null : exerciseId);
    requestAnimationFrame(() => {
      if (workoutTabScrollRef.current && scrollTop !== undefined) {
        workoutTabScrollRef.current.scrollTop = scrollTop;
      }
    });
  };

  // Wrapper to preserve scroll when updating workout time/count
  const updateWorkoutTimeWithScroll = (time) => {
    const scrollTop = workoutTabScrollRef.current?.scrollTop;
    setWorkoutTime(time);
    setCustomExerciseCount(null);
    requestAnimationFrame(() => {
      if (workoutTabScrollRef.current && scrollTop !== undefined) {
        workoutTabScrollRef.current.scrollTop = scrollTop;
      }
    });
  };

  const updateExerciseCountWithScroll = (countOrUpdater) => {
    const scrollTop = workoutTabScrollRef.current?.scrollTop;
    setCustomExerciseCount(countOrUpdater);
    requestAnimationFrame(() => {
      if (workoutTabScrollRef.current && scrollTop !== undefined) {
        workoutTabScrollRef.current.scrollTop = scrollTop;
      }
    });
  };

  // Restore scroll position when switching back to workouts tab
  useEffect(() => {
    if (activeTab === 'workouts' && workoutTabScrollRef.current && workoutTabScrollPos.current > 0) {
      requestAnimationFrame(() => {
        if (workoutTabScrollRef.current) {
          workoutTabScrollRef.current.scrollTop = workoutTabScrollPos.current;
        }
      });
    }
  }, [activeTab]);

  const [showReschedule, setShowReschedule] = useState(false);
  const [showPausePlan, setShowPausePlan] = useState(false);
  const [rescheduleOption, setRescheduleOption] = useState(null);

  // Track if today's workout is completed
  const [todayWorkoutCompleted, setTodayWorkoutCompleted] = useState(false);

  // Warmup/cooldown settings for personal workout
  const [personalWarmup, setPersonalWarmup] = useState(true);
  const [personalCooldown, setPersonalCooldown] = useState(true);

  // Get today's workout from masterSchedule - will be set after masterSchedule is initialized
  const [todayWorkout, setTodayWorkout] = useState({
    type: 'Rest',
    name: 'Rest Day',
    exercises: 0,
    duration: 0,
    focus: ''
  });
  const [showStreakCalendar, setShowStreakCalendar] = useState(null);
  const [streakCalendarMonth, setStreakCalendarMonth] = useState(currentMonth);
  const [streakCalendarYear, setStreakCalendarYear] = useState(currentYear);
  const [selectedStreakDay, setSelectedStreakDay] = useState(null);
  const [draggedDay, setDraggedDay] = useState(null);
  const [dragOverDay, setDragOverDay] = useState(null);
  const [showScheduleSettings, setShowScheduleSettings] = useState(false);
  const [pauseDuration, setPauseDuration] = useState(null);
  const [pauseCalendarMonth, setPauseCalendarMonth] = useState(currentMonth);
  const [pauseCalendarYear, setPauseCalendarYear] = useState(currentYear);
  const [onboardingStep, setOnboardingStep] = useState(0);
  const [showGoalInfo, setShowGoalInfo] = useState(null);
  const [hoveredGoal, setHoveredGoal] = useState(null);
  const [waterIntake, setWaterIntake] = useState(0);
  const [caloriesIntake, setCaloriesIntake] = useState(0);
  const [proteinIntake, setProteinIntake] = useState(0);
  const [sleepHours, setSleepHours] = useState(7.5);
  const [sleepChartView, setSleepChartView] = useState('7days'); // '7days', 'weekly', 'monthly'
  const [bedTime, setBedTime] = useState('22:30');
  const [wakeTime, setWakeTime] = useState('06:30');
  const [lastNightBedTime, setLastNightBedTime] = useState('23:00');
  const [lastNightWakeTime, setLastNightWakeTime] = useState('06:30');
  const [lastNightConfirmed, setLastNightConfirmed] = useState(false);
  
  // Local editing refs for sleep (prevents scroll on each keystroke)
  const sleepEditRefs = {
    lastBedH: React.useRef(null),
    lastBedM: React.useRef(null),
    lastWakeH: React.useRef(null),
    lastWakeM: React.useRef(null),
    bedH: React.useRef(null),
    bedM: React.useRef(null),
    wakeH: React.useRef(null),
    wakeM: React.useRef(null),
  };
  
  // Pause/Reschedule status
  const [isPaused, setIsPaused] = useState(false);
  const [pauseReturnDate, setPauseReturnDate] = useState(null);
  const [isRescheduled, setIsRescheduled] = useState(false);
  const [originalWorkout, setOriginalWorkout] = useState(null);

  // Injury tracking
  const [injuries, setInjuries] = useState([]);
  const [showReportInjury, setShowReportInjury] = useState(false);
  const [showInjuryRecovery, setShowInjuryRecovery] = useState(null); // injury object or null
  const [selectedInjuryMuscle, setSelectedInjuryMuscle] = useState(null);
  const [injurySeverity, setInjurySeverity] = useState('mild');
  const [injuryNotes, setInjuryNotes] = useState('');

  // Supplements - start empty, load from database
  const [supplements, setSupplements] = useState([]);
  const [supplementsLoading, setSupplementsLoading] = useState(false);
  const [showAddSupplement, setShowAddSupplement] = useState(false);
  const [dismissedSuggestions, setDismissedSuggestions] = useState([]); // Track dismissed supplement suggestions
  const supplementNameRef = useRef(null);
  const supplementDosageRef = useRef(null);
  const supplementUnitRef = useRef(null);
  const SUPPLEMENT_UNITS = ['mg', 'g', 'mcg', 'IU', 'ml', 'capsule(s)', 'tablet(s)', 'scoop(s)', 'drop(s)'];

  // Extended Nutrition State - start at 0, load from database
  const [carbsIntake, setCarbsIntake] = useState(0);
  const [fatsIntake, setFatsIntake] = useState(0);
  const [showAddMealFull, setShowAddMealFull] = useState(false);
  const [nutritionTab, setNutritionTab] = useState('overview'); // overview, meals, supplements

  // Backdate feature - allows logging for previous days
  const [nutritionSelectedDate, setNutritionSelectedDate] = useState(TODAY_DATE_KEY);
  const [showDatePicker, setShowDatePicker] = useState(false);
  const [backdateNutrition, setBackdateNutrition] = useState(null); // { calories, protein, carbs, fats, water, meals }

  // Meal Log - start empty, load from database
  const [mealLog, setMealLog] = useState([]);
  
  // Nutrition Goals (calculated from user stats)
  const [nutritionGoals, setNutritionGoals] = useState({
    calories: 2200,
    protein: 150,
    carbs: 250,
    fats: 70,
    water: 2500,
    tdee: 2200,
    weeklyWeightChange: 0,
  });
  
  // Weekly Nutrition History (for charts) - loaded from database
  const [weeklyNutrition, setWeeklyNutrition] = useState([]);

  // Recent nutrition history for dynamic goal adjustment (last 7 days)
  const [recentNutritionHistory, setRecentNutritionHistory] = useState([]);

  // Missed day tracking - prompt user if yesterday had 0 or very low values
  const [showMissedDayPrompt, setShowMissedDayPrompt] = useState(false);
  const [missedDayData, setMissedDayData] = useState(null); // { date, calories, water }
  const [missedDayDismissed, setMissedDayDismissed] = useState(() => {
    try {
      const saved = localStorage.getItem('uprep_missed_day_dismissed');
      return saved ? JSON.parse(saved) : null;
    } catch { return null; }
  });

  // Monthly tracking data for calendar views (last 35 days)
  const [monthlyTracking, setMonthlyTracking] = useState({
    nutrition: {}, // { 'YYYY-MM-DD': { calories, protein, water, goalMet } }
    supplements: {}, // { 'YYYY-MM-DD': { taken, total, allTaken } }
    sleep: {}, // { 'YYYY-MM-DD': { hours, goalMet } }
  });

  // Supplement History - loaded from database
  const [supplementHistory, setSupplementHistory] = useState([]);
  
  // Following & Social - persist to localStorage
  const [socialEnabled, setSocialEnabled] = useState(() => {
    try {
      const saved = localStorage.getItem('uprep_social_enabled');
      return saved !== null ? JSON.parse(saved) : true;
    } catch { return true; }
  });
  const [friendsTab, setFriendsTab] = useState('feed'); // feed, following, discover, challenges
  const [showShareModal, setShowShareModal] = useState(false);
  const [showAddFriendModal, setShowAddFriendModal] = useState(false);
  const [friendSearchQuery, setFriendSearchQuery] = useState('');
  const [expandedActivity, setExpandedActivity] = useState(null);
  const [expandedActivitySets, setExpandedActivitySets] = useState({});
  const [expandedHomeActivity, setExpandedHomeActivity] = useState(null);
  const [dailyInsightsExpanded, setDailyInsightsExpanded] = useState(true);
  const friendSearchInputRef = useRef(null);
  const friendSearchTimeoutRef = useRef(null);
  const addFriendScrollRef = useRef(null);

  // Top followed time period filter
  const [topFollowedPeriod, setTopFollowedPeriod] = useState('all'); // all, 7, 14, 31

  // Following list - loaded from database (internally called friends for backwards compat)
  const [friends, setFriends] = useState([]);

  // Suggested users to follow - loaded from database
  const [suggestedFriends, setSuggestedFriends] = useState([]);

  // Top followed users - loaded from database
  const [topFollowedUsers, setTopFollowedUsers] = useState([]);
  const [topFollowedLoading, setTopFollowedLoading] = useState(false);

  // IDs of users the current user is following (for quick lookup)
  const [followingIds, setFollowingIds] = useState(new Set());

  // Count of users who follow the current user
  const [followersCount, setFollowersCount] = useState(0);
  const [followersList, setFollowersList] = useState([]);
  const [followersLoading, setFollowersLoading] = useState(false);
  const [followingList, setFollowingList] = useState([]);
  const [followingLoading, setFollowingLoading] = useState(false);

  // Notifications
  const [notifications, setNotifications] = useState([]);
  const [unreadCount, setUnreadCount] = useState(0);
  const [showNotifications, setShowNotifications] = useState(false);

  // Persist socialEnabled to localStorage
  useEffect(() => {
    try {
      localStorage.setItem('uprep_social_enabled', JSON.stringify(socialEnabled));
    } catch { /* ignore */ }
  }, [socialEnabled]);

  // Load followers/following list when tab is selected
  useEffect(() => {
    let isMounted = true;

    const loadFollowersList = async () => {
      if (!user?.id || !isAuthenticated || friendsTab !== 'followers') return;

      setFollowersLoading(true);
      try {
        const result = await socialService.getFollowersList(user.id);
        if (isMounted && result?.data) {
          setFollowersList(result.data);
        }
      } catch (err) {
        console.warn('Followers list not available:', err?.message);
      } finally {
        if (isMounted) setFollowersLoading(false);
      }
    };

    const loadFollowingList = async () => {
      if (!user?.id || !isAuthenticated || friendsTab !== 'following') return;

      setFollowingLoading(true);
      try {
        const result = await socialService.getFollowingList(user.id);
        if (isMounted && result?.data) {
          setFollowingList(result.data);
        }
      } catch (err) {
        console.warn('Following list not available:', err?.message);
      } finally {
        if (isMounted) setFollowingLoading(false);
      }
    };

    if (friendsTab === 'followers') {
      loadFollowersList();
    } else if (friendsTab === 'following') {
      loadFollowingList();
    }

    return () => { isMounted = false; };
  }, [user?.id, isAuthenticated, friendsTab]);

  // Load nutrition data for selected backdate (and water logs for any date)
  useEffect(() => {
    let isMounted = true;

    const loadNutritionData = async () => {
      if (!user?.id || !isAuthenticated) return;

      try {
        // Always load water logs for the selected date
        const targetDate = nutritionSelectedDate;
        const { data: waterLogsData } = await nutritionService.getWaterLogs(user.id, targetDate);
        if (isMounted) {
          setWaterLogs(waterLogsData || []);
        }

        // Load supplements for the selected date
        setSupplementsLoading(true);
        const { data: userSupplements } = await nutritionService.getSupplements(user.id);
        const { data: supplementLogs } = await nutritionService.getSupplementLogs(user.id, targetDate);
        const takenIds = new Set(supplementLogs?.map(log => log.supplement_id) || []);

        if (isMounted && userSupplements) {
          setSupplements(userSupplements.map(supp => ({
            id: supp.id,
            name: supp.name,
            dosage: supp.dosage,
            time: supp.scheduled_time,
            taken: takenIds.has(supp.id),
          })));
          setSupplementsLoading(false);
        }

        // If today is selected, clear backdate data (use main state)
        if (nutritionSelectedDate === TODAY_DATE_KEY) {
          setBackdateNutrition(null);
          return;
        }

        // Load daily totals for selected date
        const { data: dailyData } = await nutritionService.getDailyNutrition(user.id, nutritionSelectedDate);

        // Load meals for selected date
        const { data: meals } = await nutritionService.getMeals(user.id, nutritionSelectedDate);

        console.log('Backdating data loaded for', nutritionSelectedDate, ':', {
          dailyData,
          meals,
          calories: dailyData?.total_calories || 0,
          protein: dailyData?.total_protein || 0,
        });

        if (isMounted) {
          setBackdateNutrition({
            calories: dailyData?.total_calories || 0,
            protein: dailyData?.total_protein || 0,
            carbs: dailyData?.total_carbs || 0,
            fats: dailyData?.total_fats || 0,
            water: dailyData?.water_intake || 0,
            meals: meals?.map(meal => ({
              id: meal.id,
              name: meal.meal_name,
              time: meal.meal_time,
              calories: meal.calories,
              protein: meal.protein,
              carbs: meal.carbs,
              fats: meal.fats,
            })) || [],
          });
        }
      } catch (err) {
        console.warn('Error loading nutrition data:', err?.message || err);
        if (isMounted) {
          setSupplementsLoading(false);
        }
      }
    };

    loadNutritionData();

    return () => { isMounted = false; };
  }, [user?.id, isAuthenticated, nutritionSelectedDate, TODAY_DATE_KEY]);

  // Reset nutrition date to today when switching away from home tab
  useEffect(() => {
    if (activeTab !== 'home') {
      setNutritionSelectedDate(TODAY_DATE_KEY);
      setBackdateNutrition(null);
    }
  }, [activeTab, TODAY_DATE_KEY]);

  // Load top followed users when period changes
  useEffect(() => {
    let isMounted = true;

    const loadTopFollowed = async () => {
      if (!isAuthenticated) return;

      setTopFollowedLoading(true);
      try {
        const result = await socialService.getTopFollowed(topFollowedPeriod, 20);
        if (isMounted && result?.data && Array.isArray(result.data)) {
          setTopFollowedUsers(result.data);
        }
      } catch (err) {
        // Silently fail - database tables may not exist yet
        console.warn('Top followed not available:', err?.message);
      } finally {
        if (isMounted) setTopFollowedLoading(false);
      }
    };

    loadTopFollowed();

    return () => { isMounted = false; };
  }, [isAuthenticated, topFollowedPeriod]);

  // Workout rating system
  const [workoutStats, setWorkoutStats] = useState({}); // { workoutId: { completionCount, averageRating, ratingCount } }
  const [userRatings, setUserRatings] = useState({}); // { workoutId: rating }

  // Load workout stats and user ratings
  useEffect(() => {
    let isMounted = true;

    const loadWorkoutRatings = async () => {
      try {
        // Load all workout stats
        const statsResult = await workoutRatingService.getAllWorkoutStats();
        if (isMounted && statsResult?.data) {
          setWorkoutStats(statsResult.data);
        }
      } catch (err) {
        console.warn('Error loading workout stats:', err?.message);
      }

      try {
        // Load user's ratings if authenticated
        if (user?.id) {
          const ratingsResult = await workoutRatingService.getAllUserRatings(user.id);
          if (isMounted && ratingsResult?.data) {
            setUserRatings(ratingsResult.data);
          }
        }
      } catch (err) {
        console.warn('Error loading user ratings:', err?.message);
      }
    };

    loadWorkoutRatings();

    return () => { isMounted = false; };
  }, [user?.id]);

  // Activity feed - loaded from database
  const [activityFeed, setActivityFeed] = useState([]);
  const [activityFeedLoading, setActivityFeedLoading] = useState(false);
  
  // Challenges - loaded from database
  const [challenges, setChallenges] = useState([]);
  
  // Challenge creation state
  const [showCreateChallenge, setShowCreateChallenge] = useState(false);
  const [newChallenge, setNewChallenge] = useState({
    name: '',
    type: 'workouts',
    duration: 7, // days
    invitedFriends: []
  });

  // Community workouts state
  const [communityWorkouts, setCommunityWorkouts] = useState([]);
  const [communityWorkoutsLoading, setCommunityWorkoutsLoading] = useState(false);
  const [communitySort, setCommunitySort] = useState('popular'); // popular, rating, newest
  const [communityFilters, setCommunityFilters] = useState({
    duration: null, // 'short' (<30min), 'medium' (30-60), 'long' (>60)
    minRating: null, // 3, 4, 4.5
    focus: null, // 'push', 'pull', 'legs', etc.
    minCompletions: null, // 10, 50, 100
  });
  const [showCommunityFilters, setShowCommunityFilters] = useState(false);
  const [savedWorkoutIds, setSavedWorkoutIds] = useState(new Set());
  const [showRepertoire, setShowRepertoire] = useState(false); // show saved workouts modal
  const [showPublishModal, setShowPublishModal] = useState(false);
  const [workoutToPublish, setWorkoutToPublish] = useState(null);
  const [publishDescription, setPublishDescription] = useState('');
  const [myPublishedWorkouts, setMyPublishedWorkouts] = useState([]);
  const [selectedCommunityWorkout, setSelectedCommunityWorkout] = useState(null);
  const [expandedWorkoutId, setExpandedWorkoutId] = useState(null); // For inline expansion
  const [expandedTrendingWorkoutId, setExpandedTrendingWorkoutId] = useState(null); // For trending carousel expansion
  const [userWorkoutRatings, setUserWorkoutRatings] = useState({}); // user's ratings cache
  const [completedCommunityWorkoutIds, setCompletedCommunityWorkoutIds] = useState(new Set()); // workouts user has completed
  const [showCommentsFor, setShowCommentsFor] = useState(null); // workout ID to show comments
  const [workoutComments, setWorkoutComments] = useState([]);
  const [commentsLoading, setCommentsLoading] = useState(false);
  const [newComment, setNewComment] = useState('');
  const [savedWorkoutsDetails, setSavedWorkoutsDetails] = useState([]);
  const [renamingWorkout, setRenamingWorkout] = useState(null); // {id, name} of workout being renamed
  const [newWorkoutName, setNewWorkoutName] = useState('');
  const [workoutWarmupCooldown, setWorkoutWarmupCooldown] = useState({}); // {workoutId: {warmup: bool, cooldown: bool}}

  // Load community workouts
  useEffect(() => {
    let isMounted = true;

    const loadCommunityWorkouts = async () => {
      setCommunityWorkoutsLoading(true);
      try {
        const result = await publishedWorkoutService.getPublishedWorkouts({
          sortBy: communitySort,
          limit: 20
        });
        if (isMounted && result?.data && Array.isArray(result.data)) {
          setCommunityWorkouts(result.data);
        }

        // Load user ratings if logged in
        if (user?.id) {
          const ratingsResult = await publishedWorkoutService.getUserRatings(user.id);
          if (isMounted && ratingsResult?.data) {
            setUserWorkoutRatings(ratingsResult.data);
          }
        }
      } catch (err) {
        console.warn('Error loading community workouts:', err?.message);
      } finally {
        if (isMounted) setCommunityWorkoutsLoading(false);
      }
    };

    loadCommunityWorkouts();

    return () => { isMounted = false; };
  }, [communitySort, user?.id]);

  // Load saved workout IDs and my published workouts
  useEffect(() => {
    let isMounted = true;

    const loadSavedWorkouts = async () => {
      if (!user?.id) return;
      try {
        const result = await publishedWorkoutService.getSavedWorkouts(user.id);
        if (isMounted && result?.data && Array.isArray(result.data)) {
          setSavedWorkoutIds(new Set(result.data));
        }
      } catch (err) {
        console.warn('Error loading saved workouts:', err?.message);
      }

      try {
        const result = await publishedWorkoutService.getMyPublishedWorkouts(user.id);
        if (isMounted && result?.data && Array.isArray(result.data)) {
          setMyPublishedWorkouts(result.data);
        }
      } catch (err) {
        console.warn('Error loading my published workouts:', err?.message);
      }
    };

    loadSavedWorkouts();

    return () => { isMounted = false; };
  }, [user?.id]);

  // Handle publishing a workout
  const handlePublishWorkout = async (workoutData) => {
    if (!user?.id || !workoutData) return;

    try {
      const result = await publishedWorkoutService.publishWorkout(user.id, workoutData);
      if (result?.data) {
        setMyPublishedWorkouts(prev => [result.data, ...prev]);
        setCommunityWorkouts(prev => [{
          ...result.data,
          creator: {
            id: user.id,
            name: profile?.first_name ? `${profile.first_name} ${profile.last_name || ''}`.trim() : profile?.username || 'You',
            username: profile?.username || 'user',
            avatar: profile?.avatar_url || null,
          }
        }, ...prev]);
        setShowPublishModal(false);
        setWorkoutToPublish(null);
      }
    } catch (err) {
      console.warn('Error publishing workout:', err?.message);
    }
  };

  // Handle saving/unsaving a community workout
  const handleSaveWorkout = async (workoutId) => {
    if (!user?.id || !workoutId) return;

    const isSaved = savedWorkoutIds.has(workoutId);

    // Optimistic update
    setSavedWorkoutIds(prev => {
      const newSet = new Set(prev);
      if (isSaved) {
        newSet.delete(workoutId);
      } else {
        newSet.add(workoutId);
      }
      return newSet;
    });

    try {
      if (isSaved) {
        await publishedWorkoutService.unsaveWorkout(user.id, workoutId);
      } else {
        await publishedWorkoutService.saveWorkout(user.id, workoutId);
      }
    } catch (err) {
      console.warn('Error saving workout:', err?.message);
      // Revert on error
      setSavedWorkoutIds(prev => {
        const newSet = new Set(prev);
        if (isSaved) {
          newSet.add(workoutId);
        } else {
          newSet.delete(workoutId);
        }
        return newSet;
      });
    }
  };

  // Handle rating a workout
  const handleRateWorkout = async (workoutId, rating) => {
    if (!user?.id || !workoutId) return;

    const oldRating = userWorkoutRatings[workoutId];

    // Optimistic update
    setUserWorkoutRatings(prev => ({ ...prev, [workoutId]: rating }));

    try {
      await publishedWorkoutService.rateWorkout(user.id, workoutId, rating);
      // Refresh community workouts to get updated average
      const result = await publishedWorkoutService.getPublishedWorkouts({
        sortBy: communitySort,
        limit: 20
      });
      if (result?.data) {
        setCommunityWorkouts(result.data);
      }
    } catch (err) {
      console.warn('Error rating workout:', err?.message);
      // Revert on error
      setUserWorkoutRatings(prev => ({ ...prev, [workoutId]: oldRating }));
    }
  };

  // Load comments for a workout
  const loadComments = async (workoutId) => {
    setCommentsLoading(true);
    setShowCommentsFor(workoutId);
    try {
      const result = await publishedWorkoutService.getComments(workoutId);
      if (result?.data) {
        setWorkoutComments(result.data);
      }
    } catch (err) {
      console.warn('Error loading comments:', err?.message);
    } finally {
      setCommentsLoading(false);
    }
  };

  // Add a comment
  const handleAddComment = async () => {
    if (!user?.id || !showCommentsFor || !newComment.trim()) return;

    try {
      const result = await publishedWorkoutService.addComment(user.id, showCommentsFor, newComment.trim());
      if (result?.data) {
        // Refresh comments
        await loadComments(showCommentsFor);
        setNewComment('');
      }
    } catch (err) {
      console.warn('Error adding comment:', err?.message);
    }
  };

  // Load saved workouts (Rep-ertoire)
  const loadRepertoire = async () => {
    setShowRepertoire(true);
    try {
      const result = await publishedWorkoutService.getSavedWorkoutsWithDetails(user?.id);
      if (result?.data) {
        setSavedWorkoutsDetails(result.data);
      }
    } catch (err) {
      console.warn('Error loading Rep-ertoire:', err?.message);
    }
  };

  // Rename a published workout
  const handleRenameWorkout = async () => {
    if (!renamingWorkout?.id || !newWorkoutName.trim() || !user?.id) return;
    try {
      const { error } = await publishedWorkoutService.updateWorkout(user.id, renamingWorkout.id, {
        name: newWorkoutName.trim(),
      });
      if (!error) {
        // Update in my published workouts list
        setMyPublishedWorkouts(prev => prev.map(w =>
          w.id === renamingWorkout.id ? { ...w, name: newWorkoutName.trim() } : w
        ));
        // Update in community workouts list if present
        setCommunityWorkouts(prev => prev.map(w =>
          w.id === renamingWorkout.id ? { ...w, name: newWorkoutName.trim() } : w
        ));
        setRenamingWorkout(null);
        setNewWorkoutName('');
      }
    } catch (err) {
      console.warn('Error renaming workout:', err?.message);
    }
  };

  // Auto-adjust workout for user level
  const adjustWorkoutForUser = (workout) => {
    if (!workout?.exercises) return workout;

    const userExperience = userData.experience || 'beginner';
    const multipliers = {
      beginner: { sets: 0.75, weight: 0.6, reps: 1.2 },
      intermediate: { sets: 1, weight: 1, reps: 1 },
      advanced: { sets: 1.25, weight: 1.2, reps: 0.9 },
    };
    const mult = multipliers[userExperience] || multipliers.intermediate;

    return {
      ...workout,
      exercises: workout.exercises.map(ex => ({
        ...ex,
        sets: Math.max(2, Math.round((ex.sets || 3) * mult.sets)),
        targetReps: ex.targetReps ? Math.round(ex.targetReps * mult.reps) : ex.reps,
        suggestedWeight: ex.suggestedWeight ? Math.round(ex.suggestedWeight * mult.weight) : null,
        adjusted: true,
      })),
    };
  };

  // Calculate estimated workout duration
  const estimateWorkoutDuration = (exercises) => {
    if (!exercises || exercises.length === 0) return 45;
    const totalSets = exercises.reduce((sum, ex) => sum + (ex.sets || 3), 0);
    // Assume ~2 min per set including rest
    return Math.max(20, Math.min(120, totalSets * 2 + 5)); // 5 min warmup
  };

  // Profile editing state
  const [showEditProfile, setShowEditProfile] = useState(false);

  // Profile settings state
  const [settings, setSettings] = useState({
    units: 'metric', // 'metric' or 'imperial'
    notifications: {
      workoutReminders: true,
      progressUpdates: true,
      socialActivity: true,
      weeklyReport: true,
    },
    privacy: {
      profileVisible: true,
      showActivity: true,
      showProgress: false,
      publicPRs: true,
      publicWorkouts: true,
      allowTagsFrom: 'everyone', // 'everyone', 'followers', 'none'
    },
    tracking: {
      calories: true,
      macros: true,
      water: true,
      sleep: true,
      supplements: true,
    },
    social: {
      allowSubscribers: false, // false = friend requests only, true = anyone can subscribe
    },
    workout: {
      corePosition: 'last', // 'first' or 'last' - where to place core exercises
    },
  });
  const [showUnitsModal, setShowUnitsModal] = useState(false);
  const [showNotificationsModal, setShowNotificationsModal] = useState(false);
  const [showPrivacyModal, setShowPrivacyModal] = useState(false);
  const [showTrackingModal, setShowTrackingModal] = useState(false);
  const [showGoalEditor, setShowGoalEditor] = useState(false);
  const [goalChangeStep, setGoalChangeStep] = useState(1); // 1: select goal, 2: weight targets, 3: review
  const [pendingGoalData, setPendingGoalData] = useState(null); // temp data during goal change
  const [goalChangeSaving, setGoalChangeSaving] = useState(false); // loading state for Apply New Goal
  const [showAccountModal, setShowAccountModal] = useState(false);
  const [showLogoutConfirm, setShowLogoutConfirm] = useState(false);
  const [showExerciseInfo, setShowExerciseInfo] = useState(null); // exercise name to show info for
  const [showExperienceLevelModal, setShowExperienceLevelModal] = useState(false);
  const [showEquipmentModal, setShowEquipmentModal] = useState(false);

  // Achievements - will be calculated/loaded from database
  const [achievements] = useState([
    // Workout Milestones
    { id: 'first_workout', name: 'First Steps', desc: 'Complete your first workout', icon: 'target', unlocked: false },
    { id: 'ten_workouts', name: 'Getting Serious', desc: 'Complete 10 workouts', icon: 'dumbbell', unlocked: false },
    { id: 'fifty_workouts', name: 'Dedicated', desc: 'Complete 50 workouts', icon: 'award', unlocked: false },
    { id: 'hundred_workouts', name: 'Centurion', desc: 'Complete 100 workouts', icon: 'trophy', unlocked: false },
    // Streak Achievements
    { id: 'week_streak', name: 'Week Warrior', desc: '7-day workout streak', icon: 'flame', unlocked: false },
    { id: 'month_streak', name: 'Monthly Master', desc: '30-day workout streak', icon: 'zap', unlocked: false },
    { id: 'quarter_streak', name: 'Unstoppable', desc: '90-day workout streak', icon: 'star', unlocked: false },
    // Personal Records
    { id: 'first_pr', name: 'Personal Best', desc: 'Set your first PR', icon: 'trophy', unlocked: false },
    { id: 'five_prs', name: 'PR Collector', desc: 'Set 5 personal records', icon: 'award', unlocked: false },
    { id: 'twenty_prs', name: 'Record Breaker', desc: 'Set 20 personal records', icon: 'crown', unlocked: false },
    // Time-based
    { id: 'early_bird', name: 'Early Bird', desc: 'Workout before 7am', icon: 'activity', unlocked: false },
    { id: 'night_owl', name: 'Night Owl', desc: 'Workout after 9pm', icon: 'moon', unlocked: false },
    { id: 'weekend_warrior', name: 'Weekend Warrior', desc: 'Complete 10 weekend workouts', icon: 'calendar', unlocked: false },
    // Volume & Strength
    { id: 'volume_king', name: 'Volume King', desc: 'Lift 100,000kg total', icon: 'crown', unlocked: false },
    { id: 'iron_pumper', name: 'Iron Pumper', desc: 'Lift 500,000kg total', icon: 'dumbbell', unlocked: false },
    { id: 'bodyweight_bench', name: 'Bodyweight Bench', desc: 'Bench press your bodyweight', icon: 'dumbbell', unlocked: false },
    // Nutrition
    { id: 'consistency', name: 'Calorie Counter', desc: 'Hit calorie goal 7 days straight', icon: 'flame', unlocked: false },
    { id: 'protein_pro', name: 'Protein Pro', desc: 'Hit protein goal 14 days straight', icon: 'apple', unlocked: false },
    { id: 'hydrated', name: 'Hydration Hero', desc: 'Hit water goal 7 days straight', icon: 'droplets', unlocked: false },
    { id: 'meal_tracker', name: 'Meal Logger', desc: 'Log 100 meals', icon: 'utensils', unlocked: false },
    // Special
    { id: 'comeback_kid', name: 'Comeback Kid', desc: 'Return after 2+ weeks off', icon: 'refresh-cw', unlocked: false },
    { id: 'perfectionist', name: 'Perfectionist', desc: 'Complete a workout with all sets at target reps', icon: 'sparkles', unlocked: false },
    { id: 'social_butterfly', name: 'Social Butterfly', desc: 'Follow 5 users', icon: 'users', unlocked: false },
    { id: 'goal_crusher', name: 'Goal Crusher', desc: 'Reach your goal weight', icon: 'target', unlocked: false },
  ]);
  const [selectedAchievement, setSelectedAchievement] = useState(null);
  const [showAllAchievements, setShowAllAchievements] = useState(false);

  const [showFriendProfile, setShowFriendProfile] = useState(null);
  const [friendFollowStatus, setFriendFollowStatus] = useState({ isFollowing: false, followsYou: false });
  const [friendStats, setFriendStats] = useState({ workouts: 0, prs: 0, streak: 0 });
  const [showFriendStreakCalendar, setShowFriendStreakCalendar] = useState(null);
  const [friendStreakMonth, setFriendStreakMonth] = useState(currentMonth);
  const [friendStreakYear, setFriendStreakYear] = useState(currentYear);
  const [showFriendPRs, setShowFriendPRs] = useState(null);
  const [friendPRsData, setFriendPRsData] = useState([]);
  const [showFriendWorkouts, setShowFriendWorkouts] = useState(null);
  const [friendWorkoutsData, setFriendWorkoutsData] = useState([]);
  const [selectedFriendWorkout, setSelectedFriendWorkout] = useState(null);
  const [likedPosts, setLikedPosts] = useState([]); // Local fallback, synced from userLikes
  const [userLikes, setUserLikes] = useState({}); // { activityId: 'reactionType' } - synced from DB
  const [activityCommentCounts, setActivityCommentCounts] = useState({}); // { activityId: count }
  const [showCommentsModal, setShowCommentsModal] = useState(null); // activityId or null
  const [activityCommentsData, setActivityCommentsData] = useState([]); // Comments for current activity modal
  const [newActivityComment, setNewActivityComment] = useState('');
  const [activityCommentsLoading, setActivityCommentsLoading] = useState(false);

  // Head-to-head comparison state
  const [showHeadToHead, setShowHeadToHead] = useState(false);
  const [headToHeadData, setHeadToHeadData] = useState(null);
  const [headToHeadPeriod, setHeadToHeadPeriod] = useState('week');
  const [headToHeadLoading, setHeadToHeadLoading] = useState(false);

  // Weekly leaderboard state
  const [weeklyLeaderboard, setWeeklyLeaderboard] = useState([]);
  const [leaderboardType, setLeaderboardType] = useState('workouts');
  const [leaderboardLoading, setLeaderboardLoading] = useState(false);

  // Nudge state
  const [canNudge, setCanNudge] = useState(true);
  const [nudgeSending, setNudgeSending] = useState(false);
  const [nudgeSent, setNudgeSent] = useState(false);

  // Workout buddy state
  const [workoutBuddy, setWorkoutBuddy] = useState(null);
  const [buddyRequests, setBuddyRequests] = useState([]);
  const [buddyRequestSent, setBuddyRequestSent] = useState(false);

  // Shared goals state
  const [sharedGoals, setSharedGoals] = useState([]);

  // PR Leaderboard state
  const [showPRLeaderboard, setShowPRLeaderboard] = useState(false);
  const [prLeaderboardData, setPrLeaderboardData] = useState(null);
  const [prLeaderboardFilter, setPrLeaderboardFilter] = useState('global'); // 'global', 'age', 'weight'
  const [prLeaderboardLoading, setPrLeaderboardLoading] = useState(false);
  const [selectedPRExercise, setSelectedPRExercise] = useState(null);
  const [exerciseLeaderboard, setExerciseLeaderboard] = useState([]);

  const [userData, setUserData] = useState({
    firstName: '', lastName: '', email: '', goal: null, experience: null,
    daysPerWeek: 4, sessionDuration: 60, dob: '', weight: '',
    currentWeight: '', goalWeight: '', programWeeks: 16,
    restDays: [5, 6], // Saturday = 5, Sunday = 6 (Mon=0 based, default weekend rest)
    username: '',
    bio: '',
    gender: null, // 'male', 'female', or 'other'
    equipment: ['Barbell', 'Dumbbells', 'Cable', 'Machine', 'Bodyweight'] // Available equipment
  });

  // Overview stats - will be populated from database
  const [overviewStats, setOverviewStats] = useState({
    startingWeight: 0,
    currentWeight: 0,
    targetWeight: 0,
    weeklyTarget: 0, // kg per week (negative = loss, positive = gain)
    totalWorkouts: 0,
    programWeek: 1,
    programLength: 16,
    programStartDate: null, // Date when user started tracking
  });

  const [showWeighIn, setShowWeighIn] = useState(false);
  const [showWeightDetails, setShowWeightDetails] = useState(false);
  const [showWorkoutStats, setShowWorkoutStats] = useState(false);

  // Dynamic weight tracking based on weekly averages
  const [weeklyWeightData, setWeeklyWeightData] = useState({
    actualWeeklyRate: 0,      // Actual kg change per week based on averages
    weeklyAverages: [],       // Array of weekly average weights
    latestAverage: null,      // Most recent weekly average
  });

  // Friend search state
  const [searchResults, setSearchResults] = useState([]);
  const [searchLoading, setSearchLoading] = useState(false);
  const [hasSearched, setHasSearched] = useState(false);

  // Meal and water tracking modals
  const [showMealEntry, setShowMealEntry] = useState(false);
  const [showWaterEntry, setShowWaterEntry] = useState(false);
  const [showWeightLogModal, setShowWeightLogModal] = useState(false);
  const [weightLogValue, setWeightLogValue] = useState('');
  const [showMacroDetail, setShowMacroDetail] = useState(null); // 'protein', 'carbs', or 'fats'

  // Debug showMacroDetail changes
  useEffect(() => {
    console.log('showMacroDetail changed to:', showMacroDetail);
  }, [showMacroDetail]);

  // History modals for viewing/editing entries
  const [showMealHistory, setShowMealHistory] = useState(false);
  const [showWaterHistory, setShowWaterHistory] = useState(false);
  const [showSupplementHistory, setShowSupplementHistory] = useState(false);
  const [waterLogs, setWaterLogs] = useState([]); // Today's water logs

  const [selectedChart, setSelectedChart] = useState('weight');
  const [chartTimeFrame, setChartTimeFrame] = useState('all'); // '7d', '30d', '90d', 'all'
  const [chartData, setChartData] = useState({
    weight: [],
    workouts: [],
    bench: [],
    squat: [],
    deadlift: [],
    ohp: [],
    volume: [],
    sleep: [],
    calories: [],
    protein: [],
  });
  const chartLabels = {
    weight: 'kg',
    workouts: 'sessions',
    bench: 'kg',
    squat: 'kg',
    deadlift: 'kg',
    ohp: 'kg',
    volume: 'kg',
    sleep: 'hrs',
    calories: 'kcal',
    protein: 'g',
  };

  // Sleep chart data
  const [sleepChartData, setSleepChartData] = useState([]);

  const [streaks, setStreaks] = useState({
    weeklyWorkouts: { weeksCompleted: 0 },
    calories: { daysInRow: 0 },
    protein: { daysInRow: 0 },
    water: { daysInRow: 0 },
    sleep: { daysInRow: 0 },
    supplements: { daysInRow: 0 },
  });

  // Workout Tab State
  const [showWorkoutPreview, setShowWorkoutPreview] = useState(null); // workout template id
  const [showExerciseLibrary, setShowExerciseLibrary] = useState(false);
  const [showWorkoutHistory, setShowWorkoutHistory] = useState(false);
  const [showPersonalRecords, setShowPersonalRecords] = useState(false);
  const [showCustomWorkout, setShowCustomWorkout] = useState(false);
  const [showFullSchedule, setShowFullSchedule] = useState(false);
  const [fullScheduleMonth, setFullScheduleMonth] = useState(currentMonth);
  const [fullScheduleYear, setFullScheduleYear] = useState(currentYear);
  const [showWorkoutSummary, setShowWorkoutSummary] = useState(null);
  const [showExerciseDetail, setShowExerciseDetail] = useState(null);
  const [exerciseSearchQuery, setExerciseSearchQuery] = useState('');
  const [exerciseFilterGroup, setExerciseFilterGroup] = useState('All');
  
  // Current program state - auto-set based on user's goal
  const [currentProgram, setCurrentProgram] = useState(() => {
    // Use saved program if available, otherwise default based on goal
    const savedProgramId = userData.programId;
    const program = savedProgramId
      ? (AVAILABLE_PROGRAMS.find(p => p.id === savedProgramId) || getProgramForGoal(userData.goal))
      : getProgramForGoal(userData.goal);
    return {
      id: program.id,
      name: program.name,
      description: program.desc,
      daysPerWeek: program.days,
      currentWeek: 1,
      totalWeeks: program.weeks,
    };
  });

  // Track previous program to detect actual changes (not just initial load)
  const prevProgramIdRef = useRef(currentProgram.id);

  // Update program when userData.programId changes (e.g., loaded from profile)
  useEffect(() => {
    if (userData.programId) {
      const program = AVAILABLE_PROGRAMS.find(p => p.id === userData.programId);
      if (program && currentProgram.id !== program.id) {
        setCurrentProgram({
          id: program.id,
          name: program.name,
          description: program.desc,
          daysPerWeek: program.days,
          currentWeek: currentProgram.currentWeek || 1,
          totalWeeks: program.weeks,
        });
      }
    } else if (userData.goal) {
      // No saved program, use goal-based default
      const program = getProgramForGoal(userData.goal);
      if (currentProgram.id !== program.id) {
        setCurrentProgram(prev => ({
          ...prev,
          id: program.id,
          name: program.name,
          description: program.desc,
          daysPerWeek: program.days,
          totalWeeks: program.weeks,
        }));
      }
    }
  }, [userData.programId, userData.goal]);

  // Regenerate schedule when program changes (e.g., when userData.programId is loaded from database)
  useEffect(() => {
    const prevProgramId = prevProgramIdRef.current;
    const newProgramId = currentProgram.id;

    // Skip if program hasn't actually changed
    if (prevProgramId === newProgramId) return;

    // Update the ref
    prevProgramIdRef.current = newProgramId;

    // Find the program to get its workout cycle
    let program = AVAILABLE_PROGRAMS.find(p => p.id === newProgramId);
    if (!program) {
      const template = PROGRAM_TEMPLATES.find(t => t.id === newProgramId);
      if (template) {
        program = {
          id: template.id,
          schedule: template.cycle,
        };
      }
    }

    if (!program?.schedule) return;

    // Regenerate the schedule with the correct program rotation
    const userRestDays = userData.restDays || [5, 6];
    const workoutTypeRotation = program.schedule;

    setMasterSchedule(prev => {
      const newSchedule = {};
      let workoutIndex = 0;

      const now = new Date();
      const scheduleStart = new Date(now);
      scheduleStart.setDate(now.getDate() - 30);

      for (let i = 0; i < 395; i++) {
        const date = new Date(scheduleStart);
        date.setDate(scheduleStart.getDate() + i);
        const dateKey = getLocalDateString(date);
        const dayOfWeek = (date.getDay() + 6) % 7;

        // Preserve completed workouts
        const existingEntry = prev[dateKey];
        if (existingEntry?.completed) {
          newSchedule[dateKey] = existingEntry;
          continue;
        }

        if (userRestDays.includes(dayOfWeek)) {
          newSchedule[dateKey] = { workoutType: null, completed: false };
        } else {
          newSchedule[dateKey] = {
            workoutType: workoutTypeRotation[workoutIndex % workoutTypeRotation.length],
            completed: false
          };
          workoutIndex++;
        }
      }
      return newSchedule;
    });
  }, [currentProgram.id]);

  // Check follow status and load stats when viewing a friend's profile
  useEffect(() => {
    const friendId = showFriendProfile?.id;
    const currentUserId = user?.id;

    if (!friendId || !currentUserId || typeof friendId !== 'string' || typeof currentUserId !== 'string') {
      return;
    }

    // Reset stats and states when opening a new profile
    setFriendStats({ workouts: 0, prs: 0, streak: 0 });
    setCanNudge(true);
    setNudgeSent(false);
    setBuddyRequestSent(false);
    setHeadToHeadData(null);

    let cancelled = false;

    (async () => {
      try {
        const [followingRes, followsYouRes, workoutsRes, prsRes, canNudgeRes] = await Promise.all([
          socialService.isFollowing(currentUserId, friendId).catch(() => ({ isFollowing: false })),
          socialService.isFollowing(friendId, currentUserId).catch(() => ({ isFollowing: false })),
          workoutService.getWorkoutHistory(friendId, 1000, 0).catch(() => ({ data: [] })),
          workoutService.getPersonalRecords(friendId).catch(() => ({ data: [] })),
          accountabilityService.canNudgeToday(currentUserId, friendId).catch(() => ({ canNudge: true })),
        ]);

        if (!cancelled) {
          setFriendFollowStatus({
            isFollowing: Boolean(followingRes?.isFollowing),
            followsYou: Boolean(followsYouRes?.isFollowing),
          });
          setCanNudge(canNudgeRes?.canNudge !== false);

          // Calculate streak from workout history
          const workouts = workoutsRes?.data || [];
          let streak = 0;
          if (workouts.length > 0) {
            // Sort by date descending and count consecutive days
            const sortedDates = workouts
              .map(w => new Date(w.ended_at || w.started_at).toDateString())
              .filter((date, i, arr) => arr.indexOf(date) === i); // unique dates

            const today = new Date().toDateString();
            const yesterday = new Date(Date.now() - 86400000).toDateString();

            if (sortedDates[0] === today || sortedDates[0] === yesterday) {
              streak = 1;
              for (let i = 1; i < sortedDates.length; i++) {
                const curr = new Date(sortedDates[i - 1]);
                const prev = new Date(sortedDates[i]);
                const diffDays = Math.round((curr - prev) / 86400000);
                if (diffDays <= 1) {
                  streak++;
                } else {
                  break;
                }
              }
            }
          }

          setFriendStats({
            workouts: workouts.length,
            prs: prsRes?.data?.length || 0,
            streak: streak,
          });
        }
      } catch (e) {
        // Silently fail
      }
    })();

    return () => { cancelled = true; };
  }, [showFriendProfile?.id, user?.id]);

  // Load comments when activity comments modal opens
  useEffect(() => {
    let isMounted = true;

    const loadActivityComments = async () => {
      if (!showCommentsModal) return;

      setActivityCommentsLoading(true);
      try {
        const { data } = await socialService.getActivityComments(showCommentsModal);
        if (isMounted && data) {
          setActivityCommentsData(data);
        }
      } catch (err) {
        console.warn('Error loading activity comments:', err?.message);
      } finally {
        if (isMounted) {
          setActivityCommentsLoading(false);
        }
      }
    };

    loadActivityComments();

    return () => { isMounted = false; };
  }, [showCommentsModal]);

  // State for next program selection
  const [selectedBreakDuration, setSelectedBreakDuration] = useState('none');
  const [selectedNextProgram, setSelectedNextProgram] = useState(null);
  const [showNextProgramModal, setShowNextProgramModal] = useState(false);

  // State for program selector dropdown
  const [showProgramSelector, setShowProgramSelector] = useState(false);
  const [programSelectorStep, setProgramSelectorStep] = useState(0); // 0: select program, 1: select rest days, 2: preview
  const [selectedProgramForSetup, setSelectedProgramForSetup] = useState(null);
  const [selectedRestDays, setSelectedRestDays] = useState([0, 6]); // Default: Sunday (0) and Saturday (6)

  // Toggle program selector with scroll preservation
  const toggleProgramSelector = () => {
    const scrollRef = activeTab === 'profile' ? profileTabScrollRef : workoutTabScrollRef;
    const scrollPos = scrollRef.current?.scrollTop || 0;
    setShowProgramSelector(prev => !prev);
    requestAnimationFrame(() => {
      if (scrollRef.current) {
        scrollRef.current.scrollTop = scrollPos;
      }
    });
  };

  // Schedule state - dynamic schedule that can be edited
  const [scheduleWeekOffset, setScheduleWeekOffset] = useState(0);
  const [showScheduleEditor, setShowScheduleEditor] = useState(false);
  const [editingScheduleDay, setEditingScheduleDay] = useState(null);
  const [showWorkoutTimeEditor, setShowWorkoutTimeEditor] = useState(false);
  const scheduleScrollRef = useRef(null);

  // Get workout rotation based on days per week
  // Returns workout type identifiers for dynamic generation (not full templates)
  const getWorkoutTypeRotation = (daysPerWeek) => {
    switch(daysPerWeek) {
      case 3: // Full body 3x
        return ['full_body', 'full_body', 'full_body'];
      case 4: // Upper/Lower split
        return ['upper', 'lower', 'upper', 'lower'];
      case 5: // PPL + Upper/Lower
        return ['push', 'pull', 'legs_quad', 'upper', 'lower'];
      case 6: // PPL x2
      default:
        return ['push', 'pull', 'legs_quad', 'push', 'pull', 'legs_posterior'];
    }
  };

  // Track recently used exercises for variety
  const [recentlyUsedExercises, setRecentlyUsedExercises] = useState([]);

  // Get user's current goal
  const userGoal = userData.goal || 'build_muscle';

  // Master schedule - stores workout TYPE (not full workout) for dynamic generation
  const [masterSchedule, setMasterSchedule] = useState(() => {
    // Use user's rest days or default to Sat/Sun
    const userRestDays = userData.restDays || [5, 6]; // 0=Mon, 6=Sun
    const daysPerWeek = userData.daysPerWeek || (7 - userRestDays.length);
    const workoutTypeRotation = getWorkoutTypeRotation(daysPerWeek);

    const schedule = {};
    let workoutIndex = 0;

    // Generate schedule starting 30 days ago to 365 days in future
    const scheduleStart = new Date(today);
    scheduleStart.setDate(today.getDate() - 30);
    for (let i = 0; i < 395; i++) {
      const date = new Date(scheduleStart);
      date.setDate(scheduleStart.getDate() + i);
      const dateKey = getLocalDateString(date);
      // Convert to Monday=0 format: (getDay() + 6) % 7
      const dayOfWeek = (date.getDay() + 6) % 7;

      // Check if this day is a rest day
      if (userRestDays.includes(dayOfWeek)) {
        schedule[dateKey] = { workoutType: null, completed: false };
      } else {
        schedule[dateKey] = {
          workoutType: workoutTypeRotation[workoutIndex % workoutTypeRotation.length],
          completed: false // Will be loaded from database
        };
        workoutIndex++;
      }
    }
    return schedule;
  });

  // Function to change the workout program/split
  const changeProgram = (programId) => {
    // Check both AVAILABLE_PROGRAMS and PROGRAM_TEMPLATES
    let newProgram = AVAILABLE_PROGRAMS.find(p => p.id === programId);
    if (!newProgram) {
      // Fall back to PROGRAM_TEMPLATES
      const template = PROGRAM_TEMPLATES.find(t => t.id === programId);
      if (!template) return;
      // Convert template to program format
      newProgram = {
        id: template.id,
        name: template.name,
        desc: template.desc,
        days: userData.daysPerWeek || 4,
        weeks: 16,
        schedule: template.cycle,
      };
    }

    // Get the scroll ref and saved position
    const scrollRef = activeTab === 'profile' ? profileTabScrollRef : workoutTabScrollRef;
    const scrollPosRef = activeTab === 'profile' ? profileTabScrollPos : workoutTabScrollPos;
    const scrollPos = scrollPosRef.current;

    // Update current program
    setCurrentProgram({
      id: newProgram.id,
      name: newProgram.name,
      description: newProgram.desc,
      daysPerWeek: newProgram.days,
      currentWeek: 1, // Reset to week 1
      totalWeeks: newProgram.weeks,
    });

    // Save selection to userData so it persists
    setUserData(prev => ({ ...prev, programId: newProgram.id }));

    // Save to database if logged in
    if (updateGoals) {
      updateGoals({ program_id: newProgram.id });
    }

    // Regenerate the schedule with the new program
    const userRestDays = userData.restDays || [5, 6];
    const workoutTypeRotation = newProgram.schedule || getWorkoutTypeRotation(newProgram.days);

    const newSchedule = {};
    let workoutIndex = 0;

    // Generate schedule starting from today to 365 days in future
    const scheduleStart = new Date(today);
    scheduleStart.setDate(scheduleStart.getDate() - 30);

    for (let i = 0; i < 395; i++) {
      const date = new Date(scheduleStart);
      date.setDate(scheduleStart.getDate() + i);
      const dayOfWeek = (date.getDay() + 6) % 7; // Convert to Mon=0
      const dateKey = getLocalDateString(date);

      // Preserve completed workouts from the old schedule
      const existingEntry = masterSchedule[dateKey];
      if (existingEntry?.completed) {
        newSchedule[dateKey] = existingEntry;
        continue;
      }

      if (userRestDays.includes(dayOfWeek)) {
        newSchedule[dateKey] = { isRestDay: true, completed: false };
      } else {
        const workoutType = workoutTypeRotation[workoutIndex % workoutTypeRotation.length];
        newSchedule[dateKey] = {
          workoutType,
          completed: false,
          isRestDay: false,
        };
        workoutIndex++;
      }
    }

    setMasterSchedule(newSchedule);

    // Clear workout cache to regenerate workouts with new program
    workoutCacheRef.current = {};
    setCustomizedExercises(null);

    // Close the modal
    setShowProgramSelector(false);

    // Restore scroll position after React re-renders complete
    // Use multiple restoration attempts to handle async rendering
    const restoreScroll = () => {
      if (scrollRef.current) {
        scrollRef.current.scrollTop = scrollPos;
      }
    };

    // Immediate attempt
    requestAnimationFrame(restoreScroll);
    // After React batched updates
    setTimeout(restoreScroll, 0);
    // After any async effects
    setTimeout(restoreScroll, 50);
    setTimeout(restoreScroll, 100);
  };

  // Calculate program progress - total workouts completed vs total in program
  const programProgress = React.useMemo(() => {
    const totalWorkoutsInProgram = currentProgram.totalWeeks * currentProgram.daysPerWeek;

    // Count actual completed workouts from the schedule (not rest days)
    const totalCompletedWorkouts = Object.entries(masterSchedule).filter(([dateKey, entry]) => {
      return entry.completed && !entry.isRestDay;
    }).length;

    // Calculate current week based on completed workouts
    const currentWeek = Math.min(
      currentProgram.totalWeeks,
      Math.floor(totalCompletedWorkouts / currentProgram.daysPerWeek) + 1
    );

    const workoutsRemaining = Math.max(0, totalWorkoutsInProgram - totalCompletedWorkouts);
    const progressPercent = Math.min(100, (totalCompletedWorkouts / totalWorkoutsInProgram) * 100);
    const weeksRemaining = Math.max(0, currentProgram.totalWeeks - currentWeek);
    const isComplete = totalCompletedWorkouts >= totalWorkoutsInProgram;

    return {
      totalWorkouts: totalWorkoutsInProgram,
      completedWorkouts: totalCompletedWorkouts,
      workoutsRemaining,
      progressPercent,
      weeksRemaining,
      isComplete,
      currentWeek,
      totalWeeks: currentProgram.totalWeeks,
    };
  }, [currentProgram, masterSchedule]);

  // Calculate dynamic/adjusted nutrition goals based on recent deficits
  const adjustedNutritionGoals = React.useMemo(() => {
    const baseGoals = {
      calories: nutritionGoals.calories || 2200,
      protein: nutritionGoals.protein || 150,
      water: nutritionGoals.water || 2500,
      carbs: nutritionGoals.carbs || 250,
      fats: nutritionGoals.fats || 70,
    };

    // If no history, return base goals
    if (!recentNutritionHistory || recentNutritionHistory.length === 0) {
      return {
        ...baseGoals,
        adjustments: {
          calories: 0,
          protein: 0,
          water: 0,
        },
        isAdjusted: false,
      };
    }

    // Calculate average intake vs goals over the past days
    const daysTracked = recentNutritionHistory.length;
    const lookbackDays = Math.min(daysTracked, 3); // Use last 3 days for calculation
    const spreadDays = 3; // Spread deficit recovery over 3 days

    // Get the most recent days for calculation
    const recentDays = recentNutritionHistory.slice(-lookbackDays);

    // Thresholds for "unrealistically low" - likely forgot to log (skip these days)
    const MIN_REALISTIC_CALORIES = 500;
    const MIN_REALISTIC_WATER = 500;

    // Filter out "missed days" - days with unrealistically low values
    const validDays = recentDays.filter(day => {
      const dayCalories = day.total_calories || 0;
      const dayWater = day.water_intake || 0;
      // Skip days that appear to be missed (either metric unrealistically low)
      return dayCalories >= MIN_REALISTIC_CALORIES || dayWater >= MIN_REALISTIC_WATER;
    });

    // If all recent days were missed, don't adjust
    if (validDays.length === 0) {
      return {
        ...baseGoals,
        adjustments: {
          calories: 0,
          protein: 0,
          water: 0,
        },
        isAdjusted: false,
        hasMissedDays: true,
      };
    }

    // Calculate total deficits from valid days only
    let totalCalorieDeficit = 0;
    let totalProteinDeficit = 0;
    let totalWaterDeficit = 0;

    validDays.forEach(day => {
      const dayCalories = day.total_calories || 0;
      const dayProtein = day.total_protein || 0;
      const dayWater = day.water_intake || 0;

      // Only count deficits, not surpluses (we don't want to tell them to eat less)
      // For calories: if goal is surplus (bulking), deficit matters
      // For cutting: surplus matters less, deficit is ok
      const calorieDeficit = baseGoals.calories - dayCalories;
      const proteinDeficit = baseGoals.protein - dayProtein;
      const waterDeficit = baseGoals.water - dayWater;

      // Only accumulate if deficit exists (positive value)
      if (calorieDeficit > 0) totalCalorieDeficit += calorieDeficit;
      if (proteinDeficit > 0) totalProteinDeficit += proteinDeficit;
      if (waterDeficit > 0) totalWaterDeficit += waterDeficit;
    });

    // Calculate daily adjustment (spread over spreadDays)
    let calorieAdjustment = Math.round(totalCalorieDeficit / spreadDays);
    let proteinAdjustment = Math.round(totalProteinDeficit / spreadDays);
    let waterAdjustment = Math.round(totalWaterDeficit / spreadDays);

    // Cap adjustments at 25% of base goal (reasonable limits)
    const maxCalorieAdjust = Math.round(baseGoals.calories * 0.25);
    const maxProteinAdjust = Math.round(baseGoals.protein * 0.25);
    const maxWaterAdjust = Math.round(baseGoals.water * 0.25);

    calorieAdjustment = Math.min(calorieAdjustment, maxCalorieAdjust);
    proteinAdjustment = Math.min(proteinAdjustment, maxProteinAdjust);
    waterAdjustment = Math.min(waterAdjustment, maxWaterAdjust);

    // Minimum threshold - don't adjust for tiny deficits
    if (calorieAdjustment < 50) calorieAdjustment = 0;
    if (proteinAdjustment < 5) proteinAdjustment = 0;
    if (waterAdjustment < 100) waterAdjustment = 0;

    const isAdjusted = calorieAdjustment > 0 || proteinAdjustment > 0 || waterAdjustment > 0;

    // Absolute upper limits to keep targets reasonable
    const MAX_DAILY_CALORIES = 5000;
    const MAX_DAILY_PROTEIN = 350;
    const MAX_DAILY_WATER = 5000;

    return {
      calories: Math.min(baseGoals.calories + calorieAdjustment, MAX_DAILY_CALORIES),
      protein: Math.min(baseGoals.protein + proteinAdjustment, MAX_DAILY_PROTEIN),
      water: Math.min(baseGoals.water + waterAdjustment, MAX_DAILY_WATER),
      carbs: baseGoals.carbs,
      fats: baseGoals.fats,
      adjustments: {
        calories: calorieAdjustment,
        protein: proteinAdjustment,
        water: waterAdjustment,
      },
      isAdjusted,
      baseGoals,
    };
  }, [nutritionGoals, recentNutritionHistory]);

  // Handle follow/unfollow user
  const handleFollowUser = async (targetUserId) => {
    if (!user?.id || !targetUserId) return;

    const isCurrentlyFollowing = followingIds.has(targetUserId);

    // Optimistically update UI
    setFollowingIds(prev => {
      const newSet = new Set(prev);
      if (isCurrentlyFollowing) {
        newSet.delete(targetUserId);
      } else {
        newSet.add(targetUserId);
      }
      return newSet;
    });

    // Update follower count in topFollowedUsers optimistically
    setTopFollowedUsers(prev => (prev || []).map(u => {
      if (u?.id === targetUserId) {
        return {
          ...u,
          followers: isCurrentlyFollowing ? Math.max(0, (u.followers || 1) - 1) : (u.followers || 0) + 1
        };
      }
      return u;
    }));

    try {
      if (isCurrentlyFollowing) {
        await socialService.unfollowUser(user.id, targetUserId);
      } else {
        await socialService.followUser(user.id, targetUserId);
      }
    } catch (err) {
      console.warn('Error updating follow status:', err?.message);
      // Revert on error
      setFollowingIds(prev => {
        const newSet = new Set(prev);
        if (isCurrentlyFollowing) {
          newSet.add(targetUserId);
        } else {
          newSet.delete(targetUserId);
        }
        return newSet;
      });
      // Revert follower count
      setTopFollowedUsers(prev => (prev || []).map(u => {
        if (u?.id === targetUserId) {
          return {
            ...u,
            followers: isCurrentlyFollowing ? (u.followers || 0) + 1 : Math.max(0, (u.followers || 1) - 1)
          };
        }
        return u;
      }));
    }
  };

  // Get suggested next programs
  const suggestedNextPrograms = NEXT_PROGRAM_SUGGESTIONS[currentProgram.id] || NEXT_PROGRAM_SUGGESTIONS.upper_lower;

  // Ref-based cache for workouts (doesn't trigger re-renders)
  const workoutCacheRef = useRef({});

  // Clear workout cache when program changes (to regenerate with new workout types)
  useEffect(() => {
    workoutCacheRef.current = {};
  }, [currentProgram.id]);

  // Generate or retrieve cached workout for a date
  const getWorkoutForDate = (dateKey) => {
    const scheduleEntry = masterSchedule[dateKey];
    if (!scheduleEntry || !scheduleEntry.workoutType) return null;

    // Check ref cache first - but invalidate if it has 0 exercises
    const cached = workoutCacheRef.current[dateKey];
    if (cached && cached.exercises && cached.exercises.length > 0) {
      return cached;
    }

    // Generate new workout with user stats for weight calculation
    const workout = generateDynamicWorkout(scheduleEntry.workoutType, userGoal, recentlyUsedExercises, userData.experience, ALL_EXERCISES, userData);

    // Cache it in ref (doesn't trigger re-render)
    if (workout) {
      workoutCacheRef.current[dateKey] = workout;
    }

    return workout;
  };

  // Regenerate schedule when rest days or days per week changes
  const regenerateSchedule = (newRestDays, newDaysPerWeek) => {
    const workoutTypeRotation = getWorkoutTypeRotation(newDaysPerWeek);
    const newSchedule = {};
    let workoutIndex = 0;

    const scheduleStart = new Date(today);
    scheduleStart.setDate(today.getDate() - 30);

    for (let i = 0; i < 395; i++) {
      const date = new Date(scheduleStart);
      date.setDate(scheduleStart.getDate() + i);
      const dateKey = getLocalDateString(date);
      const dayOfWeek = (date.getDay() + 6) % 7; // Monday=0

      // Preserve completed workouts from old schedule
      const existingEntry = masterSchedule[dateKey];
      if (existingEntry?.completed) {
        newSchedule[dateKey] = existingEntry;
        if (existingEntry.workoutType) workoutIndex++; // Keep rotation in sync
        continue;
      }

      if (newRestDays.includes(dayOfWeek)) {
        newSchedule[dateKey] = { workoutType: null, completed: false };
      } else {
        newSchedule[dateKey] = {
          workoutType: workoutTypeRotation[workoutIndex % workoutTypeRotation.length],
          completed: false
        };
        workoutIndex++;
      }
    }

    setMasterSchedule(newSchedule);
    // Clear cache to regenerate workouts with new schedule
    workoutCacheRef.current = {};

    // Update userData
    setUserData(prev => ({
      ...prev,
      restDays: newRestDays,
      daysPerWeek: newDaysPerWeek,
    }));

    // Save to database
    if (updateGoals) {
      updateGoals({
        rest_days: newRestDays,
        days_per_week: newDaysPerWeek,
      });
    }
  };

  // Auto-regenerate schedule when rest days change (e.g., during onboarding)
  const prevRestDaysRef = useRef(userData.restDays);
  useEffect(() => {
    const prevRestDays = prevRestDaysRef.current;
    const currentRestDays = userData.restDays || [5, 6];
    const currentDaysPerWeek = 7 - currentRestDays.length;

    // Check if rest days actually changed (not just on mount)
    if (prevRestDays && JSON.stringify(prevRestDays) !== JSON.stringify(currentRestDays)) {
      regenerateSchedule(currentRestDays, currentDaysPerWeek);
    }
    prevRestDaysRef.current = currentRestDays;
  }, [userData.restDays]);

  // Sync todayWorkout with masterSchedule (on mount and when today's workout type changes)
  const todayWorkoutType = masterSchedule[TODAY_DATE_KEY]?.workoutType;
  useEffect(() => {
    const todayEntry = masterSchedule[TODAY_DATE_KEY];
    if (todayEntry) {
      setTodayWorkoutCompleted(todayEntry.completed);
      if (todayEntry.workoutType) {
        // Get the dynamically generated workout for today
        const generatedWorkout = getWorkoutForDate(TODAY_DATE_KEY);
        if (generatedWorkout) {
          setTodayWorkout({
            type: generatedWorkout.name.replace(' Day ', ' ').replace('Day ', ''),
            name: generatedWorkout.name,
            exercises: generatedWorkout.exercises?.length || 0,
            duration: 60,
            focus: generatedWorkout.focus || ''
          });
        }
      } else {
        setTodayWorkout({
          type: 'Rest',
          name: 'Rest Day',
          exercises: 0,
          duration: 0,
          focus: ''
        });
      }
    }
  }, [todayWorkoutType]);

  // Get today's dynamically generated workout (cached for consistency within the day)
  const todayWorkoutTemplate = getWorkoutForDate(TODAY_DATE_KEY);

  // Get the current exercises (either customized or from template)
  const getCurrentExercises = () => {
    let exercises = customizedExercises || todayWorkoutTemplate?.exercises || [];

    // Filter out exercises targeting injured muscles
    if (injuries.length > 0) {
      exercises = exercises.filter(ex => {
        // Check if this exercise targets any injured muscle
        for (const injury of injuries) {
          if (isMuscleInjured(ex.muscleGroup, injuries)) {
            return false;
          }
          // Also check secondary muscles if defined
          if (ex.secondaryMuscles) {
            for (const secondary of ex.secondaryMuscles) {
              if (isMuscleInjured(secondary, injuries)) {
                return false;
              }
            }
          }
        }
        return true;
      });
    }

    return exercises;
  };

  // Get recovery exercises to add based on current injuries
  const getInjuryRecoveryExercisesToAdd = () => {
    if (injuries.length === 0) return [];
    return getRecoveryExercisesForWorkout(injuries);
  };

  // Find alternative exercise from same muscle group
  const getAlternativeExercise = (currentExercise, excludeIds = []) => {
    const alternatives = ALL_EXERCISES.filter(ex =>
      ex.muscleGroup === currentExercise.muscleGroup &&
      ex.name !== currentExercise.name &&
      !excludeIds.includes(ex.id)
    );
    if (alternatives.length === 0) return null;
    const randomAlt = alternatives[Math.floor(Math.random() * alternatives.length)];
    return {
      ...currentExercise,
      id: randomAlt.id || randomAlt.name.toLowerCase().replace(/\s+/g, '_'),
      name: randomAlt.name,
      muscleGroup: randomAlt.muscleGroup,
    };
  };

  // Swap exercise with alternative
  const swapExercise = (exerciseIndex) => {
    const scrollTop = workoutTabScrollRef.current?.scrollTop;
    const exercises = getCurrentExercises();
    const currentExercise = exercises[exerciseIndex];
    const excludeIds = exercises.map(ex => ex.id);
    const alternative = getAlternativeExercise(currentExercise, excludeIds);

    if (alternative) {
      const newExercises = [...exercises];
      newExercises[exerciseIndex] = alternative;
      setCustomizedExercises(newExercises);
      setExpandedExerciseId(null);
      requestAnimationFrame(() => {
        if (workoutTabScrollRef.current && scrollTop !== undefined) {
          workoutTabScrollRef.current.scrollTop = scrollTop;
        }
      });
    }
  };

  // Remove exercise and redistribute sets
  const removeExercise = (exerciseIndex) => {
    const scrollTop = workoutTabScrollRef.current?.scrollTop;
    const exercises = getCurrentExercises();
    if (exercises.length <= 2) return; // Don't allow removing if only 2 exercises left

    const removedExercise = exercises[exerciseIndex];
    const removedSets = removedExercise.sets;
    const newExercises = exercises.filter((_, i) => i !== exerciseIndex);

    // Distribute removed sets among remaining exercises
    const setsToAdd = Math.ceil(removedSets / newExercises.length);
    const redistributedExercises = newExercises.map((ex, i) => ({
      ...ex,
      sets: ex.sets + (i < removedSets ? 1 : 0) // Add 1 set to first N exercises
    }));

    setCustomizedExercises(redistributedExercises);
    setExpandedExerciseId(null);
    requestAnimationFrame(() => {
      if (workoutTabScrollRef.current && scrollTop !== undefined) {
        workoutTabScrollRef.current.scrollTop = scrollTop;
      }
    });
  };

  // Move exercise up or down in the list (for Home Tab)
  // Takes the current displayed exercise list to work with
  const moveExerciseInHome = (exerciseId, direction, displayedExercises = null) => {
    // Use displayed exercises if provided, otherwise fall back to getCurrentExercises
    const exercises = displayedExercises || getCurrentExercises();
    // Find the current index of the exercise by ID
    const currentIndex = exercises.findIndex(ex => ex.id === exerciseId);
    if (currentIndex === -1) return;

    const newIndex = direction === 'up' ? currentIndex - 1 : currentIndex + 1;
    if (newIndex < 0 || newIndex >= exercises.length) return;

    // Save scroll position
    const scrollTop = workoutTabScrollRef.current?.scrollTop;

    const newExercises = [...exercises];
    // Swap the exercises
    const temp = newExercises[currentIndex];
    newExercises[currentIndex] = newExercises[newIndex];
    newExercises[newIndex] = temp;

    setCustomizedExercises(newExercises);

    // Restore scroll position
    requestAnimationFrame(() => {
      if (workoutTabScrollRef.current && scrollTop !== undefined) {
        workoutTabScrollRef.current.scrollTop = scrollTop;
      }
    });
  };

  // Reset customizations
  const resetCustomizations = () => {
    setCustomizedExercises(null);
    setExpandedExerciseId(null);
  };

  // Mark today's workout as complete
  const completeTodayWorkout = async () => {
    setTodayWorkoutCompleted(true);
    setMasterSchedule(prev => ({
      ...prev,
      [TODAY_DATE_KEY]: { ...prev[TODAY_DATE_KEY], completed: true }
    }));

    // Track community workout completion if applicable
    if (todayWorkout?.communityWorkoutId) {
      setCompletedCommunityWorkoutIds(prev => new Set([...prev, todayWorkout.communityWorkoutId]));
      // Increment completion count in database
      try {
        await publishedWorkoutService.incrementCompletion(todayWorkout.communityWorkoutId);
      } catch (err) {
        console.warn('Error incrementing community workout completion:', err?.message);
      }
    }

    // Increment completion count for this workout
    const workoutId = todayWorkoutTemplate?.id;
    if (workoutId) {
      // Optimistically update local stats
      setWorkoutStats(prev => ({
        ...prev,
        [workoutId]: {
          ...prev[workoutId],
          completionCount: (prev[workoutId]?.completionCount || 0) + 1,
        }
      }));
      // Update in database
      try {
        await workoutRatingService.incrementCompletion(workoutId);
      } catch (err) {
        console.warn('Error incrementing completion:', err?.message);
      }
    }
  };

  // Get week dates for display
  const getWeekDates = (weekOffset) => {
    const startOfWeek = new Date(today);
    startOfWeek.setDate(today.getDate() - today.getDay() + 1 + (weekOffset * 7)); // Monday

    const days = [];
    const dayNames = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];
    const todayStart = new Date(today.getFullYear(), today.getMonth(), today.getDate());

    for (let i = 0; i < 7; i++) {
      const date = new Date(startOfWeek);
      date.setDate(startOfWeek.getDate() + i);
      const dateKey = getLocalDateString(date);
      const scheduleEntry = masterSchedule[dateKey] || { workoutType: null, completed: false };
      const isPast = date < todayStart;
      // Generate workout if there's a workout type scheduled
      const workout = scheduleEntry.workoutType ? getWorkoutForDate(dateKey) : null;

      days.push({
        day: dayNames[i],
        date: date.getDate(),
        month: date.getMonth(),
        year: date.getFullYear(),
        dateKey,
        workout: workout,
        workoutType: scheduleEntry.workoutType,
        completed: scheduleEntry.completed,
        isToday: date.toDateString() === today.toDateString(),
        isPast
      });
    }
    return days;
  };

  const currentWeekDates = getWeekDates(scheduleWeekOffset);

  // Swap workout types between two days
  const swapWorkoutDays = (fromDateKey, toDateKey) => {
    setMasterSchedule(prev => {
      const newSchedule = { ...prev };
      const fromType = newSchedule[fromDateKey]?.workoutType;
      const toType = newSchedule[toDateKey]?.workoutType;

      newSchedule[fromDateKey] = { ...newSchedule[fromDateKey], workoutType: toType };
      newSchedule[toDateKey] = { ...newSchedule[toDateKey], workoutType: fromType };

      return newSchedule;
    });
    // Clear cache for swapped days to regenerate workouts
    delete workoutCacheRef.current[fromDateKey];
    delete workoutCacheRef.current[toDateKey];
  };

  // Change workout type for a specific day
  const setWorkoutForDay = (dateKey, workoutType) => {
    setMasterSchedule(prev => ({
      ...prev,
      [dateKey]: { ...prev[dateKey], workoutType }
    }));
    // Clear cache for this day to regenerate workout
    delete workoutCacheRef.current[dateKey];
  };
  
  // Get month name for week header
  const getWeekHeaderText = (weekOffset) => {
    const days = getWeekDates(weekOffset);
    const firstDay = days[0];
    const lastDay = days[6];
    const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
    
    if (weekOffset === 0) return 'This Week';
    if (weekOffset === 1) return 'Next Week';
    if (weekOffset === -1) return 'Last Week';
    
    if (firstDay.month === lastDay.month) {
      return `${monthNames[firstDay.month]} ${firstDay.date}-${lastDay.date}`;
    }
    return `${monthNames[firstDay.month]} ${firstDay.date} - ${monthNames[lastDay.month]} ${lastDay.date}`;
  };
  
  // Upcoming workouts (next 3)
  const upcomingWorkouts = (() => {
    const upcoming = [];
    for (let i = 1; i <= 14 && upcoming.length < 3; i++) {
      const date = new Date(today);
      date.setDate(today.getDate() + i);
      const dateKey = getLocalDateString(date);
      const entry = masterSchedule[dateKey];
      if (entry?.workoutType) {
        const dayNames = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];
        const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
        // Generate workout for display
        const workout = getWorkoutForDate(dateKey);
        if (workout) {
          upcoming.push({
            date: `${dayNames[(date.getDay() + 6) % 7]}, ${monthNames[date.getMonth()]} ${date.getDate()}`,
            dateKey,
            workout: workout
          });
        }
      }
    }
    return upcoming;
  })();
  
  // Completed workouts history - loaded from database
  const [workoutHistory, setWorkoutHistory] = useState([]);

  // Personal records - loaded from database
  const [personalRecords, setPersonalRecords] = useState([]);

  // Exercise history for progressive overload - last weight/reps per exercise
  const [exerciseHistory, setExerciseHistory] = useState({});

  // Load workout history, personal records, and exercise history from database
  useEffect(() => {
    let isMounted = true;

    const loadWorkoutData = async () => {
      if (!user?.id || !isAuthenticated) return;

      try {
        // Load workout history (all completed workouts across all programs)
        const { data: historyData, error: historyError } = await workoutService.getWorkoutHistory(user.id, 100);
        if (historyError) console.warn('Error loading workout history:', historyError?.message);

        if (isMounted && historyData) {
          setWorkoutHistory(historyData);
        }

        // Load personal records
        const { data: prData, error: prError } = await workoutService.getPersonalRecords(user.id);
        if (prError) console.warn('Error loading PRs:', prError?.message);

        if (isMounted && prData) {
          setPersonalRecords(prData);
        }

        // Load exercise history for progressive overload
        const { data: exerciseHistData, error: exerciseHistError } = await workoutService.getExerciseHistory(user.id);
        if (exerciseHistError) console.warn('Error loading exercise history:', exerciseHistError?.message);

        if (isMounted && exerciseHistData) {
          setExerciseHistory(exerciseHistData);
        }
      } catch (err) {
        console.warn('Error loading workout data:', err?.message || err);
      }
    };

    loadWorkoutData();

    return () => { isMounted = false; };
  }, [user?.id, isAuthenticated]);

  // Sync completed workouts from history into masterSchedule
  useEffect(() => {
    if (!workoutHistory || workoutHistory.length === 0) return;

    // Build a map of completed dates from workout history
    const completedDates = {};
    workoutHistory.forEach(session => {
      if (session.started_at) {
        const dateKey = session.started_at.split('T')[0];
        completedDates[dateKey] = {
          sessionId: session.id,
          workoutName: session.workout_name,
          duration: session.duration_minutes,
          volume: session.total_volume,
        };
      }
    });

    // Update masterSchedule with completed status
    setMasterSchedule(prev => {
      const updated = { ...prev };
      let hasChanges = false;

      Object.keys(completedDates).forEach(dateKey => {
        if (updated[dateKey] && !updated[dateKey].completed) {
          updated[dateKey] = {
            ...updated[dateKey],
            completed: true,
            sessionData: completedDates[dateKey],
          };
          hasChanges = true;
        }
      });

      return hasChanges ? updated : prev;
    });
  }, [workoutHistory]);

  // Helper to get last weight/reps used for an exercise from history
  const getLastPerformance = (exerciseName) => {
    if (!workoutHistory || workoutHistory.length === 0) return null;

    // Search through workout history for this exercise
    for (const session of workoutHistory) {
      if (session.workout_sets) {
        const exerciseSets = session.workout_sets
          .filter(set => set.exercise_name === exerciseName && !set.is_warmup)
          .sort((a, b) => b.set_number - a.set_number);

        if (exerciseSets.length > 0) {
          // Return the heaviest set from this session
          const bestSet = exerciseSets.reduce((best, current) =>
            (current.weight > best.weight) ? current : best
          , exerciseSets[0]);

          return {
            weight: bestSet.weight,
            reps: bestSet.reps,
            date: session.started_at,
          };
        }
      }
    }
    return null;
  };

  // Helper to get PR for an exercise
  const getExercisePR = (exerciseName) => {
    if (!personalRecords || personalRecords.length === 0) return null;

    const exercisePRs = personalRecords
      .filter(pr => pr.exercise_name === exerciseName)
      .sort((a, b) => b.e1rm - a.e1rm);

    return exercisePRs.length > 0 ? exercisePRs[0] : null;
  };

  // Function to refresh workout data (call after completing workout)
  const refreshWorkoutData = async () => {
    if (!user?.id) return;

    try {
      const { data: historyData } = await workoutService.getWorkoutHistory(user.id, 100);
      if (historyData) setWorkoutHistory(historyData);

      const { data: prData } = await workoutService.getPersonalRecords(user.id);
      if (prData) setPersonalRecords(prData);
    } catch (err) {
      console.warn('Error refreshing workout data:', err);
    }
  };

  // Welcome Screen
  const WelcomeScreen = () => (
    <div className="flex flex-col items-center justify-center h-full p-6 text-center">
      <div className="w-24 h-24 rounded-3xl flex items-center justify-center mb-6" style={{ backgroundColor: COLORS.surface }}>
        <Dumbbell size={48} color={COLORS.primary} />
      </div>
      <h1 className="text-4xl font-bold mb-2" style={{ color: COLORS.text }}>UpRep</h1>
      <p className="text-lg mb-2" style={{ color: COLORS.textSecondary }}>Your Personal Fitness Journey</p>
      <p className="text-sm mb-8" style={{ color: COLORS.textMuted }}>Track workouts, hit goals, transform your body</p>
      <button onClick={() => setCurrentScreen('register')}
        className="w-full py-4 rounded-xl font-semibold text-lg flex items-center justify-center gap-2 mb-3"
        style={{ backgroundColor: COLORS.primary, color: COLORS.text }}>
        Get Started <ChevronRight size={20} />
      </button>
      <button onClick={() => setCurrentScreen('login')}
        className="w-full py-4 rounded-xl font-semibold text-lg mb-6"
        style={{ backgroundColor: COLORS.surface, color: COLORS.text, border: `1px solid ${COLORS.surfaceLight}` }}>
        Log In
      </button>
    </div>
  );

  // Dashboard Screen
  const DashboardScreen = () => {
    const userName = userData.firstName || 'Matt';
    const hasProgress = userData.goal !== null;

    return (
      <div className="flex flex-col h-full">
        <div className="flex-1 overflow-auto p-6">
          <div className="flex items-center justify-center gap-2 mb-4">
            <div className="w-8 h-8 rounded-lg flex items-center justify-center" style={{ backgroundColor: COLORS.primary }}>
              <Dumbbell size={18} color={COLORS.text} />
            </div>
            <span className="text-xl font-bold" style={{ color: COLORS.text }}>UpRep</span>
          </div>
          <div className="text-center mb-6">
            <p className="text-lg mb-1" style={{ color: COLORS.textSecondary }}>Welcome back,</p>
            <h1 className="text-3xl font-bold" style={{ color: COLORS.text }}>{userName}!</h1>
          </div>

          {!hasProgress && (
            <>
              <div className="p-6 rounded-2xl mb-4" style={{ backgroundColor: COLORS.surface }}>
                <div className="text-center mb-4">
                  <div className="w-16 h-16 rounded-full mx-auto flex items-center justify-center" style={{ backgroundColor: COLORS.primary + '20' }}>
                    <Zap size={32} color={COLORS.primary} />
                  </div>
                </div>
                <h2 className="text-xl font-bold mb-2 text-center" style={{ color: COLORS.text }}>
                  Ready to Transform with UpRep?
                </h2>
                <p className="text-center mb-4" style={{ color: COLORS.textSecondary }}>
                  Your personalized fitness journey is just a few taps away
                </p>
              </div>
              <div className="space-y-3 mb-6">
                {[
                  { icon: Target, label: 'Personalized Plans', desc: 'Workouts tailored to your goals', color: COLORS.primary },
                  { icon: TrendingUp, label: 'Progress Tracking', desc: 'Watch your PRs climb', color: COLORS.accent },
                  { icon: Apple, label: 'Nutrition Tracking', desc: 'Hit your macros', color: COLORS.protein },
                  { icon: Flame, label: 'Stay Motivated', desc: 'Streaks & achievements', color: COLORS.warning },
                ].map((item, i) => (
                  <div key={i} className="p-4 rounded-xl flex items-center gap-4" style={{ backgroundColor: COLORS.surface }}>
                    <div className="w-12 h-12 rounded-full flex items-center justify-center" style={{ backgroundColor: item.color + '20' }}>
                      <item.icon size={24} color={item.color} />
                    </div>
                    <div>
                      <p className="font-semibold" style={{ color: COLORS.text }}>{item.label}</p>
                      <p className="text-sm" style={{ color: COLORS.textSecondary }}>{item.desc}</p>
                    </div>
                  </div>
                ))}
              </div>
            </>
          )}
        </div>
        {!hasProgress && (
          <div className="p-6 border-t" style={{ borderColor: COLORS.surfaceLight }}>
            <button onClick={() => setCurrentScreen('onboarding')}
              className="w-full py-4 rounded-xl font-semibold text-lg flex items-center justify-center gap-2"
              style={{ backgroundColor: COLORS.primary, color: COLORS.text }}>
              Start Your UpRep Journey <ChevronRight size={20} />
            </button>
          </div>
        )}
      </div>
    );
  };

  // Goal Info Modal
  const GoalInfoModal = ({ goal, onClose, onSelect }) => {
    const info = GOAL_INFO[goal];
    return (
      <div className="fixed inset-0 z-50 flex flex-col" style={{ backgroundColor: COLORS.background }}>
        <div className="p-4 border-b flex items-center gap-3" style={{ borderColor: COLORS.surfaceLight }}>
          <button onClick={onClose}><ChevronLeft size={24} color={COLORS.text} /></button>
          <h2 className="text-lg font-bold" style={{ color: COLORS.text }}>{info.title}</h2>
        </div>
        <div className="flex-1 overflow-auto p-4">
          <div className="text-center mb-6">
            <div className="w-20 h-20 rounded-full mx-auto flex items-center justify-center" style={{ backgroundColor: COLORS.primary + '20' }}>
              <IconMap name={info.icon} size={40} color={COLORS.primary} />
            </div>
            <p className="mt-4" style={{ color: COLORS.textSecondary }}>{info.overview}</p>
          </div>
          <div className="space-y-3">
            {info.requirements.map((req, i) => (
              <div key={i} className="p-4 rounded-xl" style={{ backgroundColor: COLORS.surface }}>
                <div className="flex items-start gap-3">
                  <div className="w-10 h-10 rounded-lg flex items-center justify-center flex-shrink-0" style={{ backgroundColor: COLORS.primary + '15' }}>
                    <IconMap name={req.icon} size={20} color={COLORS.primary} />
                  </div>
                  <div>
                    <p className="font-semibold" style={{ color: COLORS.text }}>{req.title}</p>
                    <p className="text-sm" style={{ color: COLORS.textSecondary }}>{req.desc}</p>
                  </div>
                </div>
              </div>
            ))}
          </div>
        </div>
        <div className="p-4 border-t" style={{ borderColor: COLORS.surfaceLight }}>
          <button onClick={() => onSelect(goal)} className="w-full py-4 rounded-xl font-semibold"
            style={{ backgroundColor: COLORS.primary, color: COLORS.text }}>
            Select This Goal
          </button>
        </div>
      </div>
    );
  };

  // Reschedule Modal
  const RescheduleModal = () => {
    // Base schedule for the next 14 days - using Push/Pull/Legs split
    const baseSchedule = [
      { day: 'Wed', date: 'Jan 8', type: 'Push A', isToday: true },
      { day: 'Thu', date: 'Jan 9', type: 'Pull A' },
      { day: 'Fri', date: 'Jan 10', type: 'Legs A' },
      { day: 'Sat', date: 'Jan 11', type: 'Rest' },
      { day: 'Sun', date: 'Jan 12', type: 'Rest' },
      { day: 'Mon', date: 'Jan 13', type: 'Push B' },
      { day: 'Tue', date: 'Jan 14', type: 'Pull B' },
      { day: 'Wed', date: 'Jan 15', type: 'Legs B' },
      { day: 'Thu', date: 'Jan 16', type: 'Rest' },
      { day: 'Fri', date: 'Jan 17', type: 'Upper A' },
      { day: 'Sat', date: 'Jan 18', type: 'Lower' },
      { day: 'Sun', date: 'Jan 19', type: 'Rest' },
      { day: 'Mon', date: 'Jan 20', type: 'Upper B' },
      { day: 'Tue', date: 'Jan 21', type: 'Arms' },
    ];
    
    // Workout type colors - consistent primary color for all workouts
    const getWorkoutColor = (type) => {
      if (type.includes('Rest')) return COLORS.textMuted;
      return COLORS.primary;
    };

    const dayNames = ['Wed', 'Thu', 'Fri', 'Sat', 'Sun', 'Mon', 'Tue'];
    const dates = ['Jan 8', 'Jan 9', 'Jan 10', 'Jan 11', 'Jan 12', 'Jan 13', 'Jan 14', 'Jan 15', 'Jan 16', 'Jan 17', 'Jan 18', 'Jan 19', 'Jan 20', 'Jan 21'];

    const getUpdatedSchedule = () => {
      if (!rescheduleOption) return baseSchedule;

      const workouts = baseSchedule.map(d => d.type);
      let newSchedule = [];

      if (rescheduleOption === 'shift1') {
        // Shift all workouts by 1 day, today becomes rest
        newSchedule = dates.map((date, i) => ({
          day: dayNames[i % 7],
          date,
          type: i === 0 ? 'Rest' : workouts[i - 1],
          isToday: i === 0,
          changed: i <= workouts.findIndex((w, idx) => idx > 0 && workouts[idx] !== workouts[idx-1]) + 1
        }));
        // Mark first few as changed
        for (let i = 0; i < 5; i++) newSchedule[i].changed = true;
      } else if (rescheduleOption === 'shift2') {
        // Shift all workouts by 2 days
        newSchedule = dates.map((date, i) => ({
          day: dayNames[i % 7],
          date,
          type: i < 2 ? 'Rest' : workouts[i - 2],
          isToday: i === 0,
          changed: i < 6
        }));
      } else if (rescheduleOption === 'shift3') {
        // Shift all workouts by 3 days
        newSchedule = dates.map((date, i) => ({
          day: dayNames[i % 7],
          date,
          type: i < 3 ? 'Rest' : workouts[i - 3],
          isToday: i === 0,
          changed: i < 7
        }));
      } else if (rescheduleOption === 'swap') {
        // Swap today with tomorrow
        newSchedule = dates.map((date, i) => ({
          day: dayNames[i % 7],
          date,
          type: i === 0 ? workouts[1] : i === 1 ? workouts[0] : workouts[i],
          isToday: i === 0,
          changed: i < 2
        }));
      } else if (rescheduleOption === 'compress') {
        // Move to tomorrow but remove the next rest day to keep schedule tight
        const workoutsOnly = workouts.filter(w => w !== 'Rest');
        let restCount = 0;
        let workoutIdx = 0;
        newSchedule = dates.map((date, i) => {
          let type;
          if (i === 0) {
            type = 'Rest'; // Today becomes rest
          } else {
            // Insert workouts, skipping one rest day
            const originalType = workouts[i];
            if (originalType === 'Rest' && restCount === 0 && i > 0 && i < 6) {
              // Skip first rest day after today to compress
              restCount++;
              type = workouts[i + 1] || 'Rest';
            } else {
              type = i === 0 ? 'Rest' : workouts[i - 1 + restCount];
            }
          }
          return {
            day: dayNames[i % 7],
            date,
            type: type || 'Rest',
            isToday: i === 0,
            changed: i < 5
          };
        });
        // Simplified compress: shift by 1 but show compressed schedule note
        newSchedule = dates.map((date, i) => ({
          day: dayNames[i % 7],
          date,
          type: i === 0 ? 'Rest' : i === 1 ? 'Push Day' : i === 2 ? 'Pull Day' : i === 3 ? 'Leg Day' : i === 4 ? 'Push Day' : i === 5 ? 'Rest' : workouts[i],
          isToday: i === 0,
          changed: i < 5
        }));
      } else if (rescheduleOption === 'skip') {
        // Skip today's workout entirely, continue with rest of schedule
        newSchedule = dates.map((date, i) => ({
          day: dayNames[i % 7],
          date,
          type: i === 0 ? 'Skipped' : workouts[i],
          isToday: i === 0,
          changed: i === 0,
          skipped: i === 0
        }));
      }

      return newSchedule.slice(0, 10);
    };

    const schedule = getUpdatedSchedule();

    const options = [
      { id: 'shift1', label: 'Move to Tomorrow', desc: 'Shift entire schedule by 1 day', icon: '' },
      { id: 'shift2', label: 'Move 2 Days', desc: 'Shift entire schedule by 2 days', icon: '' },
      { id: 'shift3', label: 'Move 3 Days', desc: 'Shift entire schedule by 3 days', icon: '' },
      { id: 'swap', label: 'Swap with Tomorrow', desc: 'Do Pull Day today, Push Day tomorrow', icon: '' },
      { id: 'compress', label: 'Move & Compress', desc: 'Shift by 1 day, remove a rest day', icon: '' },
      { id: 'skip', label: 'Skip This Workout', desc: 'Remove from schedule, continue as planned', icon: '' },
    ];

    return (
      <div className="fixed inset-0 z-50 flex flex-col" style={{ backgroundColor: COLORS.background }}>
        <div className="p-4 border-b flex items-center gap-3" style={{ borderColor: COLORS.surfaceLight }}>
          <button onClick={() => { setRescheduleOption(null); setShowReschedule(false); }}>
            <ChevronLeft size={24} color={COLORS.text} />
          </button>
          <h2 className="text-lg font-bold" style={{ color: COLORS.text }}>Reschedule Workout</h2>
        </div>
        <div className="flex-1 overflow-auto p-4">
          <div className="p-3 rounded-xl mb-4 flex items-center gap-3" style={{ backgroundColor: COLORS.primary + '20' }}>
            <Dumbbell size={20} color={COLORS.primary} />
            <div>
              <p className="font-semibold" style={{ color: COLORS.text }}>Today: Push Day</p>
              <p className="text-sm" style={{ color: COLORS.textSecondary }}>Bench Press, OHP, Incline Press + 2 more</p>
            </div>
          </div>

          <p className="mb-3 font-semibold" style={{ color: COLORS.text }}>How would you like to reschedule?</p>
          <div className="space-y-2 mb-6">
            {options.map(option => (
              <button key={option.id} onClick={() => setRescheduleOption(option.id)}
                className="w-full p-4 rounded-xl flex items-center gap-3 text-left"
                style={{ backgroundColor: rescheduleOption === option.id ? COLORS.primary + '20' : COLORS.surface,
                  border: `2px solid ${rescheduleOption === option.id ? COLORS.primary : COLORS.surfaceLight}` }}>
                <span className="text-2xl">{option.icon}</span>
                <div className="flex-1">
                  <p className="font-semibold" style={{ color: rescheduleOption === option.id ? COLORS.primary : COLORS.text }}>{option.label}</p>
                  <p className="text-xs" style={{ color: COLORS.textMuted }}>{option.desc}</p>
                </div>
                {rescheduleOption === option.id && <Check size={20} color={COLORS.primary} />}
              </button>
            ))}
          </div>

          {rescheduleOption && (
            <>
              <div className="flex items-center justify-between mb-3">
                <h3 className="font-semibold" style={{ color: COLORS.text }}>Updated Schedule</h3>
                <span className="text-xs px-2 py-1 rounded" style={{ backgroundColor: COLORS.accent + '20', color: COLORS.accent }}>
                  {schedule.filter(d => d.changed).length} days affected
                </span>
              </div>
              <div className="space-y-1">
                {schedule.map((day, i) => (
                  <div key={i} className="p-3 rounded-xl flex items-center justify-between"
                    style={{ 
                      backgroundColor: day.skipped ? COLORS.error + '15' : day.changed ? COLORS.accent + '15' : COLORS.surface,
                      border: day.isToday ? `2px solid ${COLORS.primary}` : '1px solid transparent'
                    }}>
                    <div className="flex items-center gap-3">
                      <div className="w-12">
                        <p className="font-bold text-sm" style={{ color: day.isToday ? COLORS.primary : COLORS.text }}>{day.day}</p>
                        <p className="text-xs" style={{ color: COLORS.textMuted }}>{day.date.split(' ')[1]}</p>
                      </div>
                      <div className="flex items-center gap-2">
                        {day.type === 'Push Day' && <div className="w-2 h-2 rounded-full" style={{ backgroundColor: COLORS.primary }} />}
                        {day.type === 'Pull Day' && <div className="w-2 h-2 rounded-full" style={{ backgroundColor: COLORS.accent }} />}
                        {day.type === 'Leg Day' && <div className="w-2 h-2 rounded-full" style={{ backgroundColor: COLORS.warning }} />}
                        {day.type === 'Rest' && <div className="w-2 h-2 rounded-full" style={{ backgroundColor: COLORS.textMuted }} />}
                        {day.type === 'Skipped' && <div className="w-2 h-2 rounded-full" style={{ backgroundColor: COLORS.error }} />}
                        <p style={{ color: day.skipped ? COLORS.error : day.type === 'Rest' ? COLORS.textMuted : COLORS.text }}>{day.type}</p>
                      </div>
                    </div>
                    <div className="flex items-center gap-2">
                      {day.changed && !day.skipped && !day.isToday && (
                        <span className="text-xs px-2 py-0.5 rounded" style={{ backgroundColor: COLORS.accent + '30', color: COLORS.accent }}>
                          shifted
                        </span>
                      )}
                      {day.isToday && (
                        <span className="text-xs px-2 py-0.5 rounded" style={{ backgroundColor: COLORS.primary, color: COLORS.text }}>
                          Today
                        </span>
                      )}
                    </div>
                  </div>
                ))}
              </div>
              
              {rescheduleOption === 'compress' && (
                <div className="mt-4 p-3 rounded-xl flex items-start gap-2" style={{ backgroundColor: COLORS.warning + '15' }}>
                  <AlertCircle size={16} color={COLORS.warning} className="mt-0.5" />
                  <p className="text-xs" style={{ color: COLORS.textSecondary }}>
                    <strong style={{ color: COLORS.warning }}>Compressed schedule:</strong> A rest day has been removed to keep your program on track. Make sure you're recovering well!
                  </p>
                </div>
              )}
            </>
          )}
        </div>
        <div className="p-4 border-t" style={{ borderColor: COLORS.surfaceLight }}>
          <button onClick={() => { 
            // Save original workout if not already saved
            if (!originalWorkout) {
              setOriginalWorkout({...todayWorkout});
            }
            if (rescheduleOption === 'skip') {
              setTodayWorkout({ type: 'Skipped', name: 'Workout Skipped', exercises: 0, duration: 0 });
            } else if (rescheduleOption === 'swap') {
              setTodayWorkout({ type: 'Pull Day', name: 'Pull Day A', exercises: 5, duration: 55 });
            } else {
              setTodayWorkout({ type: 'Rest', name: 'Rest Day', exercises: 0, duration: 0 });
            }
            setIsRescheduled(true);
            setRescheduleOption(null); 
            setShowReschedule(false); 
          }}
            disabled={!rescheduleOption} className="w-full py-4 rounded-xl font-semibold"
            style={{ backgroundColor: rescheduleOption === 'skip' ? COLORS.error : COLORS.primary, color: COLORS.text, opacity: rescheduleOption ? 1 : 0.5 }}>
            {rescheduleOption === 'skip' ? 'Skip Workout' : 'Confirm Reschedule'}
          </button>
        </div>
      </div>
    );
  };

  // Pause Plan Modal with Calendar
  const PausePlanModal = () => {
    const monthNames = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
    const dayNames = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];
    
    const getDaysInMonth = (month, year) => new Date(year, month + 1, 0).getDate();
    const getFirstDayOfMonth = (month, year) => {
      const day = new Date(year, month, 1).getDay();
      return (day + 6) % 7; // Convert Sunday=0 to Monday=0 based
    };
    
    const daysInMonth = getDaysInMonth(pauseCalendarMonth, pauseCalendarYear);
    const firstDay = getFirstDayOfMonth(pauseCalendarMonth, pauseCalendarYear);
    
    const isToday = (day) => {
      return day === today.getDate() && pauseCalendarMonth === today.getMonth() && pauseCalendarYear === today.getFullYear();
    };
    
    const isSelected = (day) => {
      if (!pauseDuration) return false;
      const selected = new Date(pauseDuration);
      return day === selected.getDate() && pauseCalendarMonth === selected.getMonth() && pauseCalendarYear === selected.getFullYear();
    };
    
    const isPast = (day) => {
      const date = new Date(pauseCalendarYear, pauseCalendarMonth, day);
      return date <= today;
    };
    
    const handleDateSelect = (day) => {
      if (isPast(day)) return;
      const selectedDate = new Date(pauseCalendarYear, pauseCalendarMonth, day);
      setPauseDuration(selectedDate.toISOString());
    };
    
    const formatSelectedDate = () => {
      if (!pauseDuration) return '';
      const date = new Date(pauseDuration);
      const days = Math.ceil((date - today) / (1000 * 60 * 60 * 24));
      return `${monthNames[date.getMonth()]} ${date.getDate()}, ${date.getFullYear()} (${days} days)`;
    };
    
    const changeMonth = (delta) => {
      let newMonth = pauseCalendarMonth + delta;
      let newYear = pauseCalendarYear;
      if (newMonth > 11) { newMonth = 0; newYear++; }
      if (newMonth < 0) { newMonth = 11; newYear--; }
      setPauseCalendarMonth(newMonth);
      setPauseCalendarYear(newYear);
    };
    
    const calendarDays = [];
    for (let i = 0; i < firstDay; i++) {
      calendarDays.push(null);
    }
    for (let i = 1; i <= daysInMonth; i++) {
      calendarDays.push(i);
    }

    return (
      <div className="fixed inset-0 z-50 flex flex-col" style={{ backgroundColor: COLORS.background }}>
        <div className="p-4 border-b flex items-center gap-3" style={{ borderColor: COLORS.surfaceLight }}>
          <button onClick={() => { setPauseDuration(null); setShowPausePlan(false); }}>
            <ChevronLeft size={24} color={COLORS.text} />
          </button>
          <h2 className="text-lg font-bold" style={{ color: COLORS.text }}>Take a Break</h2>
        </div>
        <div className="flex-1 overflow-auto p-4">
          {/* Supportive Message */}
          <div className="p-4 rounded-xl mb-4" style={{ backgroundColor: COLORS.surface }}>
            <div className="flex items-start gap-3">
              <span className="text-3xl"></span>
              <div>
                <h3 className="font-bold mb-1" style={{ color: COLORS.text }}>Rest is Part of Progress</h3>
                <p className="text-sm" style={{ color: COLORS.textSecondary }}>
                  Taking breaks is completely okay and often necessary! Whether it's a holiday, busy period, or you just need time off  your body and mind will thank you.
                </p>
              </div>
            </div>
          </div>

          <p className="font-semibold mb-3" style={{ color: COLORS.text }}>When will you be back?</p>
          
          {/* Calendar */}
          <div className="rounded-xl p-4 mb-4" style={{ backgroundColor: COLORS.surface }}>
            {/* Month Navigation */}
            <div className="flex items-center justify-between mb-4">
              <button onClick={() => changeMonth(-1)} className="p-2 rounded-lg" style={{ backgroundColor: COLORS.surfaceLight }}>
                <ChevronLeft size={20} color={COLORS.text} />
              </button>
              <h4 className="font-bold" style={{ color: COLORS.text }}>{monthNames[pauseCalendarMonth]} {pauseCalendarYear}</h4>
              <button onClick={() => changeMonth(1)} className="p-2 rounded-lg" style={{ backgroundColor: COLORS.surfaceLight }}>
                <ChevronRight size={20} color={COLORS.text} />
              </button>
            </div>
            
            {/* Day Headers */}
            <div className="grid grid-cols-7 gap-1 mb-2">
              {dayNames.map(day => (
                <div key={day} className="text-center text-xs font-semibold py-1" style={{ color: COLORS.textMuted }}>
                  {day}
                </div>
              ))}
            </div>
            
            {/* Calendar Grid */}
            <div className="grid grid-cols-7 gap-1">
              {calendarDays.map((day, i) => (
                <button
                  key={i}
                  onClick={() => day && handleDateSelect(day)}
                  disabled={!day || isPast(day)}
                  className="aspect-square rounded-lg flex items-center justify-center text-sm font-medium transition-all"
                  style={{ 
                    backgroundColor: isSelected(day) ? COLORS.success : isToday(day) ? COLORS.primary : 'transparent',
                    color: !day ? 'transparent' : isPast(day) ? COLORS.textMuted : isSelected(day) || isToday(day) ? COLORS.text : COLORS.text,
                    opacity: !day ? 0 : isPast(day) ? 0.4 : 1,
                    cursor: !day || isPast(day) ? 'default' : 'pointer'
                  }}
                >
                  {day || ''}
                </button>
              ))}
            </div>
            
            {/* Legend */}
            <div className="flex items-center justify-center gap-4 mt-4 pt-3 border-t" style={{ borderColor: COLORS.surfaceLight }}>
              <div className="flex items-center gap-2">
                <div className="w-3 h-3 rounded" style={{ backgroundColor: COLORS.primary }} />
                <span className="text-xs" style={{ color: COLORS.textMuted }}>Today</span>
              </div>
              <div className="flex items-center gap-2">
                <div className="w-3 h-3 rounded" style={{ backgroundColor: COLORS.success }} />
                <span className="text-xs" style={{ color: COLORS.textMuted }}>Return Date</span>
              </div>
            </div>
          </div>

          {/* Selected Date Display */}
          {pauseDuration && (
            <div className="p-4 rounded-xl mb-4" style={{ backgroundColor: COLORS.success + '15', border: `1px solid ${COLORS.success}40` }}>
              <div className="flex items-center gap-3">
                <Calendar size={20} color={COLORS.success} />
                <div>
                  <p className="text-sm" style={{ color: COLORS.textSecondary }}>Returning on</p>
                  <p className="font-bold" style={{ color: COLORS.success }}>{formatSelectedDate()}</p>
                </div>
              </div>
            </div>
          )}

          {/* What happens during break */}
          <div className="p-4 rounded-xl" style={{ backgroundColor: COLORS.surfaceLight }}>
            <p className="text-sm font-semibold mb-2" style={{ color: COLORS.text }}>What happens when you're back:</p>
            <div className="space-y-2">
              {[
                { icon: '', text: 'Your schedule will be automatically recalculated' },
                { icon: '', text: 'Weights and reps adjusted based on your break length' },
                { icon: '', text: 'Streaks preserved  we know life happens!' },
                { icon: '', text: 'Gradual ramp-up to get you back on track safely' },
              ].map((item, i) => (
                <div key={i} className="flex items-center gap-2">
                  <span>{item.icon}</span>
                  <p className="text-xs" style={{ color: COLORS.textSecondary }}>{item.text}</p>
                </div>
              ))}
            </div>
          </div>
        </div>
        <div className="p-4 border-t" style={{ borderColor: COLORS.surfaceLight }}>
          <button onClick={() => { 
            setIsPaused(true);
            setPauseReturnDate(pauseDuration);
            setPauseDuration(null); 
            setShowPausePlan(false); 
          }}
            disabled={!pauseDuration} className="w-full py-4 rounded-xl font-semibold"
            style={{ backgroundColor: COLORS.success, color: COLORS.background, opacity: pauseDuration ? 1 : 0.5 }}>
            {pauseDuration ? `Pause Until ${new Date(pauseDuration).getDate()} ${monthNames[new Date(pauseDuration).getMonth()]}` : 'Select a Return Date'}
          </button>
        </div>
      </div>
    );
  };

  // Report Injury Modal
  const ReportInjuryModal = () => {
    const muscleGroups = Object.keys(INJURY_RECOVERY_DATA);

    const handleReportInjury = async () => {
      if (!selectedInjuryMuscle) return;

      const timeline = calculateRecoveryTimeline(selectedInjuryMuscle, injurySeverity, new Date());

      const injuryData = {
        muscleGroup: selectedInjuryMuscle,
        severity: injurySeverity,
        notes: injuryNotes,
        reportedDate: getLocalDateString(),
        timeline: timeline,
      };

      // Save to database if user is authenticated
      if (user?.id) {
        try {
          const { data: savedInjury, error } = await injuryService.reportInjury(user.id, injuryData);
          if (error) {
            console.error('Error saving injury:', error?.message);
          } else if (savedInjury) {
            // Use the database ID
            const newInjury = {
              id: savedInjury.id,
              muscleGroup: savedInjury.muscle_group,
              severity: savedInjury.severity,
              notes: savedInjury.notes,
              reportedDate: savedInjury.reported_date,
              timeline: savedInjury.timeline,
            };
            setInjuries(prev => [...prev, newInjury]);
            setSelectedInjuryMuscle(null);
            setInjurySeverity('mild');
            setInjuryNotes('');
            setShowReportInjury(false);
            setShowInjuryRecovery(newInjury);
            return;
          }
        } catch (err) {
          console.error('Error saving injury:', err);
        }
      }

      // Fallback for non-authenticated users
      const newInjury = {
        id: Date.now(),
        ...injuryData,
      };

      setInjuries(prev => [...prev, newInjury]);
      setSelectedInjuryMuscle(null);
      setInjurySeverity('mild');
      setInjuryNotes('');
      setShowReportInjury(false);
      setShowInjuryRecovery(newInjury);
    };

    return (
      <div className="fixed inset-0 z-50 flex flex-col" style={{ backgroundColor: COLORS.background }}>
        <div className="p-4 border-b flex items-center gap-3" style={{ borderColor: COLORS.surfaceLight }}>
          <button onClick={() => { setSelectedInjuryMuscle(null); setInjurySeverity('mild'); setInjuryNotes(''); setShowReportInjury(false); }}>
            <ChevronLeft size={24} color={COLORS.text} />
          </button>
          <h2 className="text-lg font-bold" style={{ color: COLORS.text }}>Report Injury</h2>
        </div>
        <div className="flex-1 overflow-auto p-4">
          {/* Supportive Message */}
          <div className="p-4 rounded-xl mb-4" style={{ backgroundColor: COLORS.surface }}>
            <div className="flex items-start gap-3">
              <span className="text-3xl"></span>
              <div>
                <h3 className="font-bold mb-1" style={{ color: COLORS.text }}>We're Here to Help You Heal</h3>
                <p className="text-sm" style={{ color: COLORS.textSecondary }}>
                  Injuries happen to everyone. Let's work together to get you back to your best safely. We'll adjust your workouts and guide you through recovery.
                </p>
              </div>
            </div>
          </div>

          {/* Select Muscle Group */}
          <p className="font-semibold mb-3" style={{ color: COLORS.text }}>Which area is affected?</p>
          <div className="grid grid-cols-3 gap-2 mb-6">
            {muscleGroups.map(muscle => (
              <button
                key={muscle}
                onClick={() => setSelectedInjuryMuscle(muscle)}
                className="p-3 rounded-xl text-center text-sm font-medium transition-all"
                style={{
                  backgroundColor: selectedInjuryMuscle === muscle ? COLORS.primary : COLORS.surface,
                  color: selectedInjuryMuscle === muscle ? '#fff' : COLORS.text,
                  border: selectedInjuryMuscle === muscle ? `2px solid ${COLORS.primary}` : `2px solid ${COLORS.surfaceLight}`
                }}
              >
                {muscle}
              </button>
            ))}
          </div>

          {/* Severity Selection */}
          <p className="font-semibold mb-3" style={{ color: COLORS.text }}>How severe is it?</p>
          <div className="space-y-2 mb-6">
            {Object.entries(INJURY_SEVERITY).map(([key, val]) => (
              <button
                key={key}
                onClick={() => setInjurySeverity(key)}
                className="w-full p-4 rounded-xl flex items-center gap-4 transition-all"
                style={{
                  backgroundColor: injurySeverity === key ? val.color + '20' : COLORS.surface,
                  border: injurySeverity === key ? `2px solid ${val.color}` : `2px solid ${COLORS.surfaceLight}`
                }}
              >
                <div className="w-4 h-4 rounded-full" style={{ backgroundColor: val.color }} />
                <div className="text-left flex-1">
                  <p className="font-semibold" style={{ color: COLORS.text }}>{val.label}</p>
                  <p className="text-xs" style={{ color: COLORS.textSecondary }}>
                    {key === 'mild' && 'Minor discomfort, can do most activities'}
                    {key === 'moderate' && 'Noticeable pain, need to limit activities'}
                    {key === 'severe' && 'Significant pain, need medical attention'}
                  </p>
                </div>
                {injurySeverity === key && <Check size={20} color={val.color} />}
              </button>
            ))}
          </div>

          {/* Notes */}
          <p className="font-semibold mb-3" style={{ color: COLORS.text }}>Additional notes (optional)</p>
          <textarea
            value={injuryNotes}
            onChange={(e) => setInjuryNotes(e.target.value)}
            placeholder="Describe how it happened, symptoms, etc..."
            className="w-full p-4 rounded-xl mb-4"
            style={{ backgroundColor: COLORS.surface, color: COLORS.text, border: `1px solid ${COLORS.surfaceLight}`, minHeight: '100px' }}
          />

          {/* What to expect */}
          {selectedInjuryMuscle && (
            <div className="p-4 rounded-xl" style={{ backgroundColor: COLORS.surfaceLight }}>
              <p className="text-sm font-semibold mb-2" style={{ color: COLORS.text }}>What happens next:</p>
              <div className="space-y-2">
                {[
                  { icon: '', text: 'Workouts will avoid the injured area' },
                  { icon: '', text: 'Personalized recovery plan created' },
                  { icon: '', text: 'Rehab exercises added when appropriate' },
                  { icon: '', text: 'Gradual return to full training' },
                ].map((item, i) => (
                  <div key={i} className="flex items-center gap-2">
                    <span>{item.icon}</span>
                    <p className="text-xs" style={{ color: COLORS.textSecondary }}>{item.text}</p>
                  </div>
                ))}
              </div>
            </div>
          )}
        </div>
        <div className="p-4 border-t" style={{ borderColor: COLORS.surfaceLight }}>
          <button
            onClick={handleReportInjury}
            disabled={!selectedInjuryMuscle}
            className="w-full py-4 rounded-xl font-semibold"
            style={{ backgroundColor: COLORS.primary, color: '#fff', opacity: selectedInjuryMuscle ? 1 : 0.5 }}
          >
            {selectedInjuryMuscle ? `Start ${selectedInjuryMuscle} Recovery Plan` : 'Select Affected Area'}
          </button>
        </div>
      </div>
    );
  };

  // Injury Recovery Screen
  const InjuryRecoveryScreen = ({ injury }) => {
    if (!injury) return null;

    const currentPhase = getCurrentRecoveryPhase(injury);
    const phaseInfo = RECOVERY_PHASES[currentPhase];
    const timeline = injury.timeline;
    const coachingMessage = getCoachingMessage(currentPhase, injury.muscleGroup);

    const recoveryExercises = currentPhase === 'recovery' || currentPhase === 'strengthening'
      ? (currentPhase === 'recovery'
          ? RECOVERY_EXERCISES[injury.muscleGroup]
          : RESTRENGTHENING_EXERCISES[injury.muscleGroup]) || []
      : [];

    const daysUntilRecovery = Math.ceil((new Date(timeline.return.end) - new Date()) / (1000 * 60 * 60 * 24));
    const totalDays = Math.ceil((new Date(timeline.return.end) - new Date(injury.reportedDate)) / (1000 * 60 * 60 * 24));
    const progressPercent = Math.max(0, Math.min(100, ((totalDays - daysUntilRecovery) / totalDays) * 100));

    const formatDate = (dateStr) => {
      const date = new Date(dateStr);
      return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
    };

    const handleMarkHealed = async () => {
      // Update in database if user is authenticated
      if (user?.id && injury.id) {
        try {
          const { error } = await injuryService.markAsHealed(injury.id);
          if (error) {
            console.error('Error marking injury as healed:', error?.message);
          }
        } catch (err) {
          console.error('Error marking injury as healed:', err);
        }
      }

      setInjuries(prev => prev.filter(i => i.id !== injury.id));
      setShowInjuryRecovery(null);
    };

    return (
      <div className="fixed inset-0 z-50 flex flex-col" style={{ backgroundColor: COLORS.background }}>
        <div className="p-4 border-b flex items-center gap-3" style={{ borderColor: COLORS.surfaceLight }}>
          <button onClick={() => setShowInjuryRecovery(null)}>
            <ChevronLeft size={24} color={COLORS.text} />
          </button>
          <h2 className="text-lg font-bold" style={{ color: COLORS.text }}>{injury.muscleGroup} Recovery</h2>
        </div>
        <div className="flex-1 overflow-auto p-4">
          {/* Coaching Message */}
          <div className="p-4 rounded-xl mb-4" style={{ backgroundColor: COLORS.primary + '15', border: `1px solid ${COLORS.primary}30` }}>
            <div className="flex items-start gap-3">
              <span className="text-2xl">{phaseInfo.icon}</span>
              <div>
                <p className="font-bold mb-1" style={{ color: COLORS.primary }}>Coach's Note</p>
                <p className="text-sm" style={{ color: COLORS.text }}>{coachingMessage}</p>
              </div>
            </div>
          </div>

          {/* Progress Overview */}
          <div className="p-4 rounded-xl mb-4" style={{ backgroundColor: COLORS.surface }}>
            <div className="flex items-center justify-between mb-3">
              <h3 className="font-bold" style={{ color: COLORS.text }}>Recovery Progress</h3>
              <span className="text-sm font-semibold" style={{ color: COLORS.primary }}>{Math.round(progressPercent)}%</span>
            </div>
            <div className="w-full h-3 rounded-full mb-3" style={{ backgroundColor: COLORS.surfaceLight }}>
              <div
                className="h-full rounded-full transition-all"
                style={{ width: `${progressPercent}%`, backgroundColor: COLORS.primary }}
              />
            </div>
            <div className="flex justify-between text-xs" style={{ color: COLORS.textMuted }}>
              <span>Started {formatDate(injury.reportedDate)}</span>
              <span>Est. recovery: {formatDate(timeline.return.end)}</span>
            </div>
          </div>

          {/* Current Phase */}
          <div className="p-4 rounded-xl mb-4" style={{ backgroundColor: phaseInfo.color || COLORS.primary, color: '#fff' }}>
            <div className="flex items-center gap-3 mb-2">
              <span className="text-2xl">{phaseInfo.icon}</span>
              <div>
                <p className="text-xs opacity-80">Current Phase</p>
                <h3 className="font-bold text-lg">{phaseInfo.name}</h3>
              </div>
            </div>
            <p className="text-sm opacity-90">{phaseInfo.description}</p>
          </div>

          {/* Phase Timeline */}
          <div className="p-4 rounded-xl mb-4" style={{ backgroundColor: COLORS.surface }}>
            <h3 className="font-bold mb-4" style={{ color: COLORS.text }}>Your Recovery Timeline</h3>
            <div className="space-y-4">
              {['rest', 'recovery', 'strengthening', 'return'].map((phase, i) => {
                const isActive = phase === currentPhase;
                const isPast = ['rest', 'recovery', 'strengthening', 'return'].indexOf(currentPhase) > i;
                const phaseData = timeline[phase];
                const info = RECOVERY_PHASES[phase];

                return (
                  <div key={phase} className="flex gap-3">
                    <div className="flex flex-col items-center">
                      <div
                        className="w-8 h-8 rounded-full flex items-center justify-center"
                        style={{
                          backgroundColor: isPast ? COLORS.success : isActive ? COLORS.primary : COLORS.surfaceLight,
                          color: isPast || isActive ? '#fff' : COLORS.textMuted
                        }}
                      >
                        {isPast ? <Check size={16} /> : <span className="text-sm">{info.icon}</span>}
                      </div>
                      {i < 3 && (
                        <div
                          className="w-0.5 flex-1 mt-1"
                          style={{ backgroundColor: isPast ? COLORS.success : COLORS.surfaceLight }}
                        />
                      )}
                    </div>
                    <div className="flex-1 pb-4">
                      <div className="flex items-center gap-2">
                        <p className="font-semibold" style={{ color: isActive ? COLORS.primary : isPast ? COLORS.success : COLORS.text }}>
                          {info.name}
                        </p>
                        {isActive && (
                          <span className="text-xs px-2 py-0.5 rounded-full" style={{ backgroundColor: COLORS.primary + '20', color: COLORS.primary }}>
                            Now
                          </span>
                        )}
                      </div>
                      <p className="text-xs mt-1" style={{ color: COLORS.textMuted }}>
                        {formatDate(phaseData.start)} - {formatDate(phaseData.end)}
                      </p>
                      {isActive && info.tips && info.tips.length > 0 && (
                        <div className="mt-2 space-y-1">
                          {info.tips.slice(0, 2).map((tip, j) => (
                            <p key={j} className="text-xs" style={{ color: COLORS.textSecondary }}>
                               {tip}
                            </p>
                          ))}
                        </div>
                      )}
                    </div>
                  </div>
                );
              })}
            </div>
          </div>

          {/* Recovery Exercises */}
          {recoveryExercises.length > 0 && (
            <div className="p-4 rounded-xl mb-4" style={{ backgroundColor: COLORS.surface }}>
              <h3 className="font-bold mb-3" style={{ color: COLORS.text }}>
                {currentPhase === 'recovery' ? 'Rehab Exercises' : 'Strengthening Exercises'}
              </h3>
              <p className="text-sm mb-3" style={{ color: COLORS.textSecondary }}>
                {currentPhase === 'recovery'
                  ? 'Gentle exercises to promote healing and mobility'
                  : 'Progressive exercises to rebuild strength safely'}
              </p>
              <div className="space-y-2">
                {recoveryExercises.map((exercise, i) => (
                  <div key={i} className="p-3 rounded-lg flex items-center gap-3" style={{ backgroundColor: COLORS.surfaceLight }}>
                    <div className="w-8 h-8 rounded-full flex items-center justify-center" style={{ backgroundColor: COLORS.primary + '20' }}>
                      <span className="text-sm">{currentPhase === 'recovery' ? '' : ''}</span>
                    </div>
                    <div className="flex-1">
                      <p className="font-medium text-sm" style={{ color: COLORS.text }}>{exercise.name}</p>
                      <p className="text-xs" style={{ color: COLORS.textMuted }}>{exercise.sets} sets  {exercise.reps} reps</p>
                    </div>
                  </div>
                ))}
              </div>
            </div>
          )}

          {/* Tips for Current Phase */}
          <div className="p-4 rounded-xl mb-4" style={{ backgroundColor: COLORS.surfaceLight }}>
            <h3 className="font-semibold mb-3" style={{ color: COLORS.text }}>Tips for {phaseInfo.name}</h3>
            <div className="space-y-2">
              {(phaseInfo.tips || []).map((tip, i) => (
                <div key={i} className="flex items-start gap-2">
                  <Check size={14} color={COLORS.success} className="mt-0.5" />
                  <p className="text-sm" style={{ color: COLORS.textSecondary }}>{tip}</p>
                </div>
              ))}
            </div>
          </div>

          {/* Severity Info */}
          <div className="p-4 rounded-xl" style={{ backgroundColor: COLORS.surface }}>
            <div className="flex items-center gap-3 mb-2">
              <div className="w-3 h-3 rounded-full" style={{ backgroundColor: INJURY_SEVERITY[injury.severity].color }} />
              <p className="font-semibold" style={{ color: COLORS.text }}>{INJURY_SEVERITY[injury.severity].label} Injury</p>
            </div>
            {injury.notes && (
              <p className="text-sm" style={{ color: COLORS.textMuted }}>Notes: {injury.notes}</p>
            )}
          </div>
        </div>
        <div className="p-4 border-t space-y-2" style={{ borderColor: COLORS.surfaceLight }}>
          {currentPhase === 'return' && (
            <button
              onClick={handleMarkHealed}
              className="w-full py-4 rounded-xl font-semibold"
              style={{ backgroundColor: COLORS.success, color: '#fff' }}
            >
              Mark as Healed
            </button>
          )}
          <button
            onClick={() => setShowInjuryRecovery(null)}
            className="w-full py-3 rounded-xl font-semibold"
            style={{ backgroundColor: COLORS.surfaceLight, color: COLORS.text }}
          >
            Close
          </button>
        </div>
      </div>
    );
  };

  // Onboarding scroll ref for equipment selection
  const onboardingScrollRef = React.useRef(null);

  // Toggle equipment with scroll preservation
  const toggleEquipmentWithScroll = (equipId) => {
    const scrollTop = onboardingScrollRef.current?.scrollTop;
    setUserData(p => {
      const current = p.equipment || [];
      if (current.includes(equipId)) {
        return { ...p, equipment: current.filter(e => e !== equipId) };
      } else {
        return { ...p, equipment: [...current, equipId] };
      }
    });
    requestAnimationFrame(() => {
      if (onboardingScrollRef.current && scrollTop !== undefined) {
        onboardingScrollRef.current.scrollTop = scrollTop;
      }
    });
  };

  // Home Tab scroll ref
  const homeScrollRef = React.useRef(null);
  const homeScrollPos = React.useRef(0);
  const homeTabMounted = React.useRef(false);

  // Nutrition Tab scroll ref
  const nutritionTabScrollRef = React.useRef(0);

  // Restore home tab scroll position after re-renders (prevents jump to top on data load)
  React.useEffect(() => {
    if (activeTab === 'home' && homeScrollRef.current && homeTabMounted.current) {
      const savedPos = homeScrollPos.current;
      if (savedPos > 0) {
        requestAnimationFrame(() => {
          if (homeScrollRef.current) {
            homeScrollRef.current.scrollTop = savedPos;
          }
        });
      }
    }
    if (activeTab === 'home') {
      homeTabMounted.current = true;
    }
  });

  // Toggle trending workout with scroll preservation
  const toggleTrendingWorkoutWithScroll = (workoutId) => {
    const scrollTop = homeScrollRef.current?.scrollTop;
    setExpandedTrendingWorkoutId(prev => prev === workoutId ? null : workoutId);
    requestAnimationFrame(() => {
      if (homeScrollRef.current && scrollTop !== undefined) {
        homeScrollRef.current.scrollTop = scrollTop;
      }
    });
  };

  // Open comments with home tab scroll preservation
  const openCommentsWithScroll = async (workoutId) => {
    const scrollTop = homeScrollRef.current?.scrollTop;
    setShowCommentsFor(workoutId);
    await loadComments(workoutId);
    requestAnimationFrame(() => {
      if (homeScrollRef.current && scrollTop !== undefined) {
        homeScrollRef.current.scrollTop = scrollTop;
      }
    });
  };

  // Close comments with home tab scroll preservation
  const closeCommentsWithScroll = () => {
    const scrollTop = homeScrollRef.current?.scrollTop;
    setShowCommentsFor(null);
    setWorkoutComments([]);
    requestAnimationFrame(() => {
      if (homeScrollRef.current && scrollTop !== undefined) {
        homeScrollRef.current.scrollTop = scrollTop;
      }
    });
  };

  // Toggle warmup/cooldown with home tab scroll preservation
  const toggleWarmupCooldownHomeTab = (workoutId, type) => {
    const scrollTop = homeScrollRef.current?.scrollTop;
    setWorkoutWarmupCooldown(prev => ({
      ...prev,
      [workoutId]: { ...prev[workoutId], [type]: !(prev[workoutId]?.[type] ?? true) }
    }));
    requestAnimationFrame(() => {
      if (homeScrollRef.current && scrollTop !== undefined) {
        homeScrollRef.current.scrollTop = scrollTop;
      }
    });
  };

  // Home Tab - SLEEK REDESIGN

  // Main Screen with tabs
  const MainScreen = () => (
    <div className="flex flex-col h-full">
      <div className="flex-1 overflow-hidden">
        {activeTab === 'home' && (
          <HomeTab
            COLORS={COLORS}
            homeScrollRef={homeScrollRef}
            homeScrollPos={homeScrollPos}
            userData={userData}
            user={user}
            todayWorkout={todayWorkout}
            setTodayWorkout={setTodayWorkout}
            todayWorkoutCompleted={todayWorkoutCompleted}
            todayWorkoutTemplate={todayWorkoutTemplate}
            isPaused={isPaused}
            setIsPaused={setIsPaused}
            pauseReturnDate={pauseReturnDate}
            setPauseReturnDate={setPauseReturnDate}
            isRescheduled={isRescheduled}
            originalWorkout={originalWorkout}
            setIsRescheduled={setIsRescheduled}
            setOriginalWorkout={setOriginalWorkout}
            setShowPausePlan={setShowPausePlan}
            setShowReschedule={setShowReschedule}
            setShowWorkoutPreview={setShowWorkoutPreview}
            caloriesIntake={caloriesIntake}
            proteinIntake={proteinIntake}
            carbsIntake={carbsIntake}
            fatsIntake={fatsIntake}
            waterIntake={waterIntake}
            setWaterIntake={setWaterIntake}
            nutritionGoals={nutritionGoals}
            adjustedNutritionGoals={adjustedNutritionGoals}
            supplements={supplements}
            setSupplements={setSupplements}
            mealLog={mealLog}
            lastNightBedTime={lastNightBedTime}
            lastNightWakeTime={lastNightWakeTime}
            lastNightConfirmed={lastNightConfirmed}
            setLastNightConfirmed={setLastNightConfirmed}
            sleepHours={sleepHours}
            settings={settings}
            setSettings={setSettings}
            streaks={streaks}
            setShowWeighIn={setShowWeighIn}
            setShowWaterEntry={setShowWaterEntry}
            setShowAddMealFull={setShowAddMealFull}
            activityFeed={activityFeed}
            setActivityFeed={setActivityFeed}
            likedPosts={likedPosts}
            setLikedPosts={setLikedPosts}
            setActiveTab={setActiveTab}
            setFriendsTab={setFriendsTab}
            setNutritionTab={setNutritionTab}
            setShowWorkoutSummary={setShowWorkoutSummary}
            socialEnabled={socialEnabled}
            followersCount={followersCount}
            followingIds={followingIds}
            showNotifications={showNotifications}
            setShowNotifications={setShowNotifications}
            unreadCount={unreadCount}
            notifications={notifications}
            setNotifications={setNotifications}
            getWorkoutColor={getWorkoutColor}
            nutritionService={nutritionService}
            setWaterLogs={setWaterLogs}
            supabase={supabase}
            socialService={socialService}
            workoutStats={workoutStats}
            chartTimeFrame={chartTimeFrame}
            setChartTimeFrame={setChartTimeFrame}
            chartData={chartData}
            weeklyNutrition={weeklyNutrition}
            sleepChartData={sleepChartData}
            communityWorkouts={communityWorkouts}
            expandedTrendingWorkoutId={expandedTrendingWorkoutId}
            setExpandedTrendingWorkoutId={setExpandedTrendingWorkoutId}
            friends={friends}
            savedWorkoutIds={savedWorkoutIds}
            setSavedWorkoutIds={setSavedWorkoutIds}
            showMissedDayPrompt={showMissedDayPrompt}
            setShowMissedDayPrompt={setShowMissedDayPrompt}
            missedDayData={missedDayData}
            setMissedDayData={setMissedDayData}
            setMissedDayDismissed={setMissedDayDismissed}
            showActiveWorkout={showActiveWorkout}
            setShowActiveWorkout={setShowActiveWorkout}
            partialWorkoutProgress={partialWorkoutProgress}
            setPartialWorkoutProgress={setPartialWorkoutProgress}
            completeTodayWorkout={completeTodayWorkout}
            workoutTime={workoutTime}
            setWorkoutTime={setWorkoutTime}
            injuries={injuries}
            personalWarmup={personalWarmup}
            setPersonalWarmup={setPersonalWarmup}
            personalCooldown={personalCooldown}
            setPersonalCooldown={setPersonalCooldown}
            customExerciseCount={customExerciseCount}
            setCustomExerciseCount={setCustomExerciseCount}
            customizedExercises={customizedExercises}
            setCustomizedExercises={setCustomizedExercises}
            getCurrentExercises={getCurrentExercises}
            getInjuryRecoveryExercisesToAdd={getInjuryRecoveryExercisesToAdd}
            ALL_EXERCISES={ALL_EXERCISES}
            WORKOUT_TIMING={WORKOUT_TIMING}
          />
        )}
        {activeTab === 'workouts' && (
          <WorkoutTab
            COLORS={COLORS}
            workoutTabScrollRef={workoutTabScrollRef}
            handleWorkoutTabScroll={handleWorkoutTabScroll}
            scheduleWeekOffset={scheduleWeekOffset}
            setScheduleWeekOffset={setScheduleWeekOffset}
            getWeekHeaderText={getWeekHeaderText}
            setShowScheduleSettings={setShowScheduleSettings}
            draggedDay={draggedDay}
            setDraggedDay={setDraggedDay}
            dragOverDay={dragOverDay}
            setDragOverDay={setDragOverDay}
            currentWeekDates={currentWeekDates}
            overviewStats={overviewStats}
            setEditingScheduleDay={setEditingScheduleDay}
            swapWorkoutDays={swapWorkoutDays}
            getWorkoutColor={getWorkoutColor}
            isPaused={isPaused}
            pauseReturnDate={pauseReturnDate}
            setIsPaused={setIsPaused}
            setPauseReturnDate={setPauseReturnDate}
            todayWorkout={todayWorkout}
            setTodayWorkout={setTodayWorkout}
            todayWorkoutCompleted={todayWorkoutCompleted}
            todayWorkoutTemplate={todayWorkoutTemplate}
            isRescheduled={isRescheduled}
            originalWorkout={originalWorkout}
            setIsRescheduled={setIsRescheduled}
            setOriginalWorkout={setOriginalWorkout}
            workoutStats={workoutStats}
            setShowPausePlan={setShowPausePlan}
            setShowReschedule={setShowReschedule}
            setShowWorkoutPreview={setShowWorkoutPreview}
            showWorkoutTimeEditor={showWorkoutTimeEditor}
            setShowWorkoutTimeEditor={setShowWorkoutTimeEditor}
            workoutTime={workoutTime}
            customExerciseCount={customExerciseCount}
            setCustomExerciseCount={setCustomExerciseCount}
            updateWorkoutTimeWithScroll={updateWorkoutTimeWithScroll}
            getCurrentExercises={getCurrentExercises}
            settings={settings}
            personalWarmup={personalWarmup}
            personalCooldown={personalCooldown}
            setPersonalWarmup={setPersonalWarmup}
            setPersonalCooldown={setPersonalCooldown}
            customizedExercises={customizedExercises}
            optimizeExercisesForTimeAndCount={optimizeExercisesForTimeAndCount}
            getWorkoutTimeBreakdown={getWorkoutTimeBreakdown}
            updateExerciseCountWithScroll={updateExerciseCountWithScroll}
            exerciseListCollapsed={exerciseListCollapsed}
            toggleExerciseListWithScroll={toggleExerciseListWithScroll}
            resetCustomizations={resetCustomizations}
            expandedExerciseId={expandedExerciseId}
            toggleExpandedExercise={toggleExpandedExercise}
            moveExerciseInHome={moveExerciseInHome}
            showExerciseInfoWithScroll={showExerciseInfoWithScroll}
            userData={userData}
            swapExercise={swapExercise}
            removeExercise={removeExercise}
            partialWorkoutProgress={partialWorkoutProgress}
            setShowActiveWorkout={setShowActiveWorkout}
            upcomingWorkouts={upcomingWorkouts}
            setShowExerciseLibrary={setShowExerciseLibrary}
            setShowWorkoutHistory={setShowWorkoutHistory}
            setShowPersonalRecords={setShowPersonalRecords}
            setShowCustomWorkout={setShowCustomWorkout}
            workoutHistory={workoutHistory}
            setShowWorkoutSummary={setShowWorkoutSummary}
            personalRecords={personalRecords}
            setShowPRLeaderboard={setShowPRLeaderboard}
            loadPRLeaderboard={loadPRLeaderboard}
            setShowExerciseDetail={setShowExerciseDetail}
            currentProgram={currentProgram}
            programProgress={programProgress}
            setShowProgramSelector={setShowProgramSelector}
            suggestedNextPrograms={suggestedNextPrograms}
            selectedNextProgram={selectedNextProgram}
            setSelectedNextProgram={setSelectedNextProgram}
            selectedBreakDuration={selectedBreakDuration}
            setSelectedBreakDuration={setSelectedBreakDuration}
            BREAK_OPTIONS={BREAK_OPTIONS}
          />
        )}
        {activeTab === 'nutrition' && (
          <NutritionTab
            COLORS={COLORS}
            nutritionSelectedDate={nutritionSelectedDate}
            setNutritionSelectedDate={setNutritionSelectedDate}
            showDatePicker={showDatePicker}
            setShowDatePicker={setShowDatePicker}
            TODAY_DATE_KEY={TODAY_DATE_KEY}
            getLocalDateString={getLocalDateString}
            caloriesIntake={caloriesIntake}
            setCaloriesIntake={setCaloriesIntake}
            proteinIntake={proteinIntake}
            setProteinIntake={setProteinIntake}
            carbsIntake={carbsIntake}
            setCarbsIntake={setCarbsIntake}
            fatsIntake={fatsIntake}
            setFatsIntake={setFatsIntake}
            waterIntake={waterIntake}
            setWaterIntake={setWaterIntake}
            waterLogs={waterLogs}
            setWaterLogs={setWaterLogs}
            adjustedNutritionGoals={adjustedNutritionGoals}
            nutritionGoals={nutritionGoals}
            mealLog={mealLog}
            setMealLog={setMealLog}
            supplements={supplements}
            setSupplements={setSupplements}
            supplementsLoading={supplementsLoading}
            setSupplementsLoading={setSupplementsLoading}
            supplementHistory={supplementHistory}
            setSupplementHistory={setSupplementHistory}
            userData={userData}
            user={user}
            nutritionTab={nutritionTab}
            setNutritionTab={setNutritionTab}
            showMacroDetail={showMacroDetail}
            setShowMacroDetail={setShowMacroDetail}
            showAddSupplement={showAddSupplement}
            setShowAddSupplement={setShowAddSupplement}
            setShowAddMealFull={setShowAddMealFull}
            setShowWaterEntry={setShowWaterEntry}
            setShowWaterHistory={setShowWaterHistory}
            setShowMealHistory={setShowMealHistory}
            dismissedSuggestions={dismissedSuggestions}
            setDismissedSuggestions={setDismissedSuggestions}
            backdateNutrition={backdateNutrition}
            setBackdateNutrition={setBackdateNutrition}
            lastNightBedTime={lastNightBedTime}
            setLastNightBedTime={setLastNightBedTime}
            lastNightWakeTime={lastNightWakeTime}
            setLastNightWakeTime={setLastNightWakeTime}
            lastNightConfirmed={lastNightConfirmed}
            setLastNightConfirmed={setLastNightConfirmed}
            sleepHours={sleepHours}
            sleepChartView={sleepChartView}
            setSleepChartView={setSleepChartView}
            selectedSleepDate={selectedSleepDate}
            setSelectedSleepDate={setSelectedSleepDate}
            monthlyTracking={monthlyTracking}
            setMonthlyTracking={setMonthlyTracking}
            sleepEditRefs={sleepEditRefs}
            streaks={streaks}
            setStreaks={setStreaks}
            nutritionService={nutritionService}
            sleepService={sleepService}
            weeklyNutrition={weeklyNutrition}
            nutritionTabScrollRef={nutritionTabScrollRef}
          />
        )}
        {activeTab === 'friends' && (
          <FriendsTab
            COLORS={COLORS}
            friendsTabScrollRef={friendsTabScrollRef}
            socialEnabled={socialEnabled}
            setSocialEnabled={setSocialEnabled}
            friendsTab={friendsTab}
            setFriendsTab={setFriendsTab}
            todayWorkoutTemplate={todayWorkoutTemplate}
            setWorkoutToPublish={setWorkoutToPublish}
            setShowPublishModal={setShowPublishModal}
            communitySort={communitySort}
            setCommunitySort={setCommunitySort}
            showCommunityFilters={showCommunityFilters}
            setShowCommunityFilters={setShowCommunityFilters}
            communityFilters={communityFilters}
            setCommunityFilters={setCommunityFilters}
            myPublishedWorkouts={myPublishedWorkouts}
            expandedWorkoutId={expandedWorkoutId}
            setExpandedWorkoutIdWithScroll={setExpandedWorkoutIdWithScroll}
            workoutWarmupCooldown={workoutWarmupCooldown}
            toggleWarmupCooldownWithScroll={toggleWarmupCooldownWithScroll}
            renamingWorkout={renamingWorkout}
            setRenamingWorkout={setRenamingWorkout}
            newWorkoutName={newWorkoutName}
            setNewWorkoutName={setNewWorkoutName}
            handleRenameWorkout={handleRenameWorkout}
            loadComments={loadComments}
            setSelectedCommunityWorkout={setSelectedCommunityWorkout}
            savedWorkoutIds={savedWorkoutIds}
            setSavedWorkoutIds={setSavedWorkoutIds}
            loadRepertoire={loadRepertoire}
            getWorkoutStyle={getWorkoutStyle}
            estimateWorkoutDuration={estimateWorkoutDuration}
            getWorkoutTimeBreakdown={getWorkoutTimeBreakdown}
            WORKOUT_TIMING={WORKOUT_TIMING}
            showExerciseInfoFriendsTab={showExerciseInfoFriendsTab}
            formatActivityTime={formatActivityTime}
            IconMap={IconMap}
            StarRating={StarRating}
            communityWorkouts={communityWorkouts}
            communityWorkoutsLoading={communityWorkoutsLoading}
            userWorkoutRatings={userWorkoutRatings}
            handleRateWorkout={handleRateWorkout}
            handleSaveWorkout={handleSaveWorkout}
            user={user}
            adjustWorkoutForUser={adjustWorkoutForUser}
            publishedWorkoutService={publishedWorkoutService}
            userData={userData}
            overviewStats={overviewStats}
            personalRecords={personalRecords}
            streaks={streaks}
            setShowShareModal={setShowShareModal}
            weeklyLeaderboard={weeklyLeaderboard}
            setWeeklyLeaderboard={setWeeklyLeaderboard}
            leaderboardType={leaderboardType}
            setLeaderboardType={setLeaderboardType}
            leaderboardLoading={leaderboardLoading}
            setLeaderboardLoading={setLeaderboardLoading}
            competitionService={competitionService}
            activityFeed={activityFeed}
            activityFeedLoading={activityFeedLoading}
            userLikes={userLikes}
            handleActivityLike={handleActivityLike}
            expandedActivity={expandedActivity}
            setExpandedActivity={setExpandedActivity}
            expandedActivitySets={expandedActivitySets}
            setExpandedActivitySets={setExpandedActivitySets}
            setShowCommentsModal={setShowCommentsModal}
            activityCommentCounts={activityCommentCounts}
            followersList={followersList}
            followersLoading={followersLoading}
            setShowFriendProfile={setShowFriendProfile}
            setShowFriendStreakCalendar={setShowFriendStreakCalendar}
            setShowAddFriendModal={setShowAddFriendModal}
            friends={friends}
            followingList={followingList}
            followingLoading={followingLoading}
            suggestedFriends={suggestedFriends}
            topFollowedUsers={topFollowedUsers}
            topFollowedLoading={topFollowedLoading}
            topFollowedPeriod={topFollowedPeriod}
            setTopFollowedPeriod={setTopFollowedPeriod}
            followingIds={followingIds}
            handleFollowUser={handleFollowUser}
            challenges={challenges}
            setShowCreateChallenge={setShowCreateChallenge}
            profile={profile}
            workoutBuddy={workoutBuddy}
            setWorkoutBuddy={setWorkoutBuddy}
            buddyRequests={buddyRequests}
            setBuddyRequests={setBuddyRequests}
            accountabilityService={accountabilityService}
            supabase={supabase}
            setActiveTab={setActiveTab}
          />
        )}

        {/* ORIGINAL_FRIENDS_TAB_CONTENT_START - TO BE REMOVED */}
        {false && (
          <div>
            {/* Social Opt-Out Banner */}
            {!socialEnabled && (
              <div className="p-4 rounded-xl mb-4" style={{ backgroundColor: COLORS.surfaceLight }}>
                <div className="flex items-center justify-between">
                  <div>
                    <p className="font-semibold" style={{ color: COLORS.text }}>Social Features Disabled</p>
                    <p className="text-xs" style={{ color: COLORS.textMuted }}>Your activity is private</p>
                  </div>
                  <button
                    onClick={() => setSocialEnabled(true)}
                    className="px-3 py-2 rounded-xl text-sm font-semibold"
                    style={{ backgroundColor: COLORS.primary, color: COLORS.text }}
                  >
                    Enable
                  </button>
                </div>
              </div>
            )}

            {/* Tab Navigation */}
            <div className="flex gap-2 mb-4 overflow-x-auto">
              {[
                { id: 'feed', label: 'Activity' },
                { id: 'community_workouts', label: 'Workouts' },
                { id: 'followers', label: 'Followers' },
                { id: 'following', label: 'Following' },
                { id: 'discover', label: 'Discover' },
                { id: 'challenges', label: 'Challenges' },
              ].map(tab => (
                <button
                  key={tab.id}
                  onClick={() => setFriendsTab(tab.id)}
                  className="flex-1 py-2 px-1 rounded-xl text-xs font-semibold"
                  style={{
                    backgroundColor: friendsTab === tab.id ? COLORS.primary : COLORS.surface,
                    color: friendsTab === tab.id ? COLORS.text : COLORS.textMuted
                  }}
                >
                  {tab.label}
                </button>
              ))}
            </div>

            {/* COMMUNITY WORKOUTS TAB */}
            {friendsTab === 'community_workouts' && (
              <>
                {/* Publish Button */}
                <button
                  onClick={() => {
                    if (todayWorkoutTemplate) {
                      setWorkoutToPublish(todayWorkoutTemplate);
                      setShowPublishModal(true);
                    }
                  }}
                  className="w-full p-4 rounded-xl mb-4 flex items-center justify-center gap-2"
                  style={{ backgroundColor: COLORS.primary, color: COLORS.text }}
                >
                  <Share2 size={18} />
                  <span className="font-semibold">Share Your Workout</span>
                </button>

                {/* Sort Options */}
                <div className="flex gap-2 mb-3">
                  {[
                    { id: 'popular', label: 'Most Popular' },
                    { id: 'rating', label: 'Top Rated' },
                    { id: 'newest', label: 'Newest' },
                  ].map(sort => (
                    <button
                      key={sort.id}
                      onClick={() => setCommunitySort(sort.id)}
                      className="flex-1 py-2 rounded-lg text-xs font-semibold"
                      style={{
                        backgroundColor: communitySort === sort.id ? COLORS.primary : COLORS.surface,
                        color: communitySort === sort.id ? COLORS.text : COLORS.textMuted
                      }}
                    >
                      {sort.label}
                    </button>
                  ))}
                </div>

                {/* Filter Options */}
                <div className="mb-4">
                  <button
                    onClick={() => setShowCommunityFilters(!showCommunityFilters)}
                    className="flex items-center gap-2 px-3 py-2 rounded-lg text-xs font-semibold"
                    style={{ backgroundColor: COLORS.surface, color: COLORS.textMuted }}
                  >
                    <Filter size={14} />
                    Filters
                    {(communityFilters.duration || communityFilters.minRating || communityFilters.focus || communityFilters.minCompletions) && (
                      <span className="w-2 h-2 rounded-full" style={{ backgroundColor: COLORS.primary }} />
                    )}
                    <ChevronDown size={14} style={{ transform: showCommunityFilters ? 'rotate(180deg)' : 'rotate(0deg)', transition: 'transform 0.2s' }} />
                  </button>

                  {showCommunityFilters && (
                    <div className="mt-2 p-3 rounded-xl space-y-3" style={{ backgroundColor: COLORS.surface }}>
                      {/* Duration Filter */}
                      <div>
                        <p className="text-xs font-semibold mb-2" style={{ color: COLORS.textMuted }}>Duration</p>
                        <div className="flex gap-2 flex-wrap">
                          {[
                            { id: null, label: 'Any' },
                            { id: 'short', label: '<30min' },
                            { id: 'medium', label: '30-60min' },
                            { id: 'long', label: '>60min' },
                          ].map(d => (
                            <button
                              key={d.id || 'any'}
                              onClick={() => setCommunityFilters(prev => ({ ...prev, duration: d.id }))}
                              className="px-3 py-1.5 rounded-lg text-xs font-semibold"
                              style={{
                                backgroundColor: communityFilters.duration === d.id ? COLORS.primary : COLORS.surfaceLight,
                                color: communityFilters.duration === d.id ? COLORS.text : COLORS.textMuted
                              }}
                            >
                              {d.label}
                            </button>
                          ))}
                        </div>
                      </div>

                      {/* Min Rating Filter */}
                      <div>
                        <p className="text-xs font-semibold mb-2" style={{ color: COLORS.textMuted }}>Minimum Rating</p>
                        <div className="flex gap-2 flex-wrap">
                          {[
                            { id: null, label: 'Any' },
                            { id: 3, label: '3+ stars' },
                            { id: 4, label: '4+ stars' },
                            { id: 4.5, label: '4.5+ stars' },
                          ].map(r => (
                            <button
                              key={r.id || 'any'}
                              onClick={() => setCommunityFilters(prev => ({ ...prev, minRating: r.id }))}
                              className="px-3 py-1.5 rounded-lg text-xs font-semibold"
                              style={{
                                backgroundColor: communityFilters.minRating === r.id ? COLORS.primary : COLORS.surfaceLight,
                                color: communityFilters.minRating === r.id ? COLORS.text : COLORS.textMuted
                              }}
                            >
                              {r.label}
                            </button>
                          ))}
                        </div>
                      </div>

                      {/* Focus/Type Filter */}
                      <div>
                        <p className="text-xs font-semibold mb-2" style={{ color: COLORS.textMuted }}>Workout Type</p>
                        <div className="flex gap-2 flex-wrap">
                          {[
                            { id: null, label: 'Any' },
                            { id: 'push', label: 'Push' },
                            { id: 'pull', label: 'Pull' },
                            { id: 'legs', label: 'Legs' },
                            { id: 'upper', label: 'Upper' },
                            { id: 'full', label: 'Full Body' },
                            { id: 'core', label: 'Core' },
                          ].map(f => (
                            <button
                              key={f.id || 'any'}
                              onClick={() => setCommunityFilters(prev => ({ ...prev, focus: f.id }))}
                              className="px-3 py-1.5 rounded-lg text-xs font-semibold"
                              style={{
                                backgroundColor: communityFilters.focus === f.id ? COLORS.primary : COLORS.surfaceLight,
                                color: communityFilters.focus === f.id ? COLORS.text : COLORS.textMuted
                              }}
                            >
                              {f.label}
                            </button>
                          ))}
                        </div>
                      </div>

                      {/* Min Completions Filter */}
                      <div>
                        <p className="text-xs font-semibold mb-2" style={{ color: COLORS.textMuted }}>Completed By</p>
                        <div className="flex gap-2 flex-wrap">
                          {[
                            { id: null, label: 'Any' },
                            { id: 10, label: '10+ people' },
                            { id: 50, label: '50+ people' },
                            { id: 100, label: '100+ people' },
                          ].map(c => (
                            <button
                              key={c.id || 'any'}
                              onClick={() => setCommunityFilters(prev => ({ ...prev, minCompletions: c.id }))}
                              className="px-3 py-1.5 rounded-lg text-xs font-semibold"
                              style={{
                                backgroundColor: communityFilters.minCompletions === c.id ? COLORS.primary : COLORS.surfaceLight,
                                color: communityFilters.minCompletions === c.id ? COLORS.text : COLORS.textMuted
                              }}
                            >
                              {c.label}
                            </button>
                          ))}
                        </div>
                      </div>

                      {/* Clear Filters */}
                      {(communityFilters.duration || communityFilters.minRating || communityFilters.focus || communityFilters.minCompletions) && (
                        <button
                          onClick={() => setCommunityFilters({ duration: null, minRating: null, focus: null, minCompletions: null })}
                          className="text-xs font-semibold"
                          style={{ color: COLORS.error }}
                        >
                          Clear All Filters
                        </button>
                      )}
                    </div>
                  )}
                </div>

                {/* My Published Workouts */}
                {myPublishedWorkouts.length > 0 && (
                  <div className="mb-6">
                    <p className="text-xs font-semibold mb-3" style={{ color: COLORS.textMuted }}>YOUR SHARED WORKOUTS</p>
                    <div className="space-y-2">
                      {myPublishedWorkouts.map(workout => {
                        const style = getWorkoutStyle(workout.focus);
                        const isExpanded = expandedWorkoutId === workout.id;
                        const targetDuration = workout.target_duration || estimateWorkoutDuration(workout.exercises);
                        const uploadDate = workout.created_at ? new Date(workout.created_at) : null;
                        const uploadTimeAgo = uploadDate ? formatActivityTime(workout.created_at) : '';

                        return (
                          <div
                            key={workout.id}
                            className="rounded-xl overflow-hidden"
                            style={{ backgroundColor: COLORS.surface }}
                          >
                            {/* Card Header - Clickable to expand */}
                            <button
                              onClick={() => setExpandedWorkoutIdWithScroll(isExpanded ? null : workout.id)}
                              className="w-full p-3 text-left"
                            >
                              <div className="flex items-center gap-3">
                                <div
                                  className="w-10 h-10 rounded-lg flex items-center justify-center flex-shrink-0"
                                  style={{ backgroundColor: style.color + '20' }}
                                >
                                  <IconMap name={style.icon} size={18} color={style.color} />
                                </div>
                                <div className="flex-1 min-w-0">
                                  <div className="flex items-center gap-2">
                                    <p className="font-semibold text-sm truncate" style={{ color: COLORS.text }}>{workout.name}</p>
                                    <ChevronDown
                                      size={14}
                                      color={COLORS.textMuted}
                                      style={{ transform: isExpanded ? 'rotate(180deg)' : 'rotate(0deg)', transition: 'transform 0.2s' }}
                                    />
                                  </div>
                                  <div className="flex items-center flex-wrap gap-2 text-xs mt-1" style={{ color: COLORS.textMuted }}>
                                    <div className="flex items-center gap-1">
                                      <StarRating rating={workout.averageRating || 0} readonly size={10} />
                                      <span className="font-medium" style={{ color: COLORS.warning }}>{(workout.averageRating || 0).toFixed(1)}</span>
                                    </div>
                                    <span>({workout.ratingCount || 0})</span>
                                    <span className="flex items-center gap-1">
                                      <Users size={10} /> {workout.completionCount || 0}
                                    </span>
                                    {uploadTimeAgo && <span>{uploadTimeAgo}</span>}
                                  </div>
                                </div>
                                <button
                                  onClick={(e) => { e.stopPropagation(); loadComments(workout.id); }}
                                  className="p-2 rounded-lg flex items-center gap-1"
                                  style={{ backgroundColor: COLORS.surfaceLight }}
                                >
                                  <MessageCircle size={14} color={COLORS.textMuted} />
                                  <span className="text-xs" style={{ color: COLORS.textMuted }}>{workout.comment_count || 0}</span>
                                </button>
                              </div>
                            </button>

                            {/* Expanded Content */}
                            {isExpanded && (() => {
                              const timing = getWorkoutTimeBreakdown(workout.exercises || []);
                              const activeMins = Math.round(timing.workingTime / 60);
                              const restMins = Math.round(timing.restTime / 60);
                              const warmupMins = Math.round(WORKOUT_TIMING.WARMUP_TIME / 60);
                              const cooldownMins = Math.round(WORKOUT_TIMING.COOLDOWN_TIME / 60);
                              const warmupCooldownState = workoutWarmupCooldown[workout.id] || {};
                              const hasWarmup = warmupCooldownState.warmup ?? true;
                              const hasCooldown = warmupCooldownState.cooldown ?? true;
                              const workoutMins = activeMins + restMins + (hasWarmup ? warmupMins : 0) + (hasCooldown ? cooldownMins : 0);
                              return (
                              <div className="px-3 pb-3 border-t" style={{ borderColor: COLORS.surfaceLight }}>
                                {/* Time Breakdown */}
                                <div className="grid grid-cols-4 gap-2 py-3">
                                  <div className="text-center p-2 rounded-lg" style={{ backgroundColor: COLORS.success + '15' }}>
                                    <p className="font-bold text-sm" style={{ color: COLORS.success }}>{activeMins}min</p>
                                    <p className="text-xs" style={{ color: COLORS.textMuted }}>Active</p>
                                  </div>
                                  <div className="text-center p-2 rounded-lg" style={{ backgroundColor: COLORS.warning + '15' }}>
                                    <p className="font-bold text-sm" style={{ color: COLORS.warning }}>{restMins}min</p>
                                    <p className="text-xs" style={{ color: COLORS.textMuted }}>Rest</p>
                                  </div>
                                  <div className="text-center p-2 rounded-lg" style={{ backgroundColor: COLORS.primary + '15' }}>
                                    <p className="font-bold text-sm" style={{ color: COLORS.primary }}>{hasWarmup ? warmupMins : 0}+{hasCooldown ? cooldownMins : 0}min</p>
                                    <p className="text-xs" style={{ color: COLORS.textMuted }}>Warm/Cool</p>
                                  </div>
                                  <div className="text-center p-2 rounded-lg" style={{ backgroundColor: COLORS.surfaceLight }}>
                                    <p className="font-bold text-sm" style={{ color: COLORS.text }}>{workoutMins}min</p>
                                    <p className="text-xs" style={{ color: COLORS.textMuted }}>Total</p>
                                  </div>
                                </div>

                                {/* Warmup/Cooldown Toggles */}
                                <div className="flex items-center gap-3 py-2">
                                  <button
                                    onClick={() => toggleWarmupCooldownWithScroll(workout.id, 'warmup')}
                                    className="flex items-center gap-2 px-3 py-1.5 rounded-lg text-xs font-semibold"
                                    style={{
                                      backgroundColor: hasWarmup ? COLORS.primary + '20' : COLORS.surfaceLight,
                                      color: hasWarmup ? COLORS.primary : COLORS.textMuted
                                    }}
                                  >
                                    <Wind size={12} />
                                    Warmup {warmupMins}min
                                    {hasWarmup ? <Check size={12} /> : null}
                                  </button>
                                  <button
                                    onClick={() => toggleWarmupCooldownWithScroll(workout.id, 'cooldown')}
                                    className="flex items-center gap-2 px-3 py-1.5 rounded-lg text-xs font-semibold"
                                    style={{
                                      backgroundColor: hasCooldown ? COLORS.primary + '20' : COLORS.surfaceLight,
                                      color: hasCooldown ? COLORS.primary : COLORS.textMuted
                                    }}
                                  >
                                    <Sprout size={12} />
                                    Cooldown {cooldownMins}min
                                    {hasCooldown ? <Check size={12} /> : null}
                                  </button>
                                </div>

                                {/* Exercise count & avg completion */}
                                <div className="flex items-center gap-3 py-2 text-xs" style={{ color: COLORS.textMuted }}>
                                  <span>{workout.exercises?.length || 0} exercises</span>
                                  {workout.avg_actual_duration && (
                                    <span className="flex items-center gap-1">
                                      <Clock size={10} /> Avg completion: {workout.avg_actual_duration}min
                                    </span>
                                  )}
                                </div>

                                {/* Description */}
                                {workout.description && (
                                  <p className="text-sm py-2" style={{ color: COLORS.textSecondary }}>{workout.description}</p>
                                )}

                                {/* Exercises List with Warmup/Cooldown */}
                                <div className="py-2 space-y-2">
                                  {/* Warmup Item */}
                                  {hasWarmup && (
                                    <div className="p-2 rounded-lg flex items-center gap-2" style={{ backgroundColor: COLORS.primary + '15', border: `1px dashed ${COLORS.primary}40` }}>
                                      <div className="w-6 h-6 rounded-full flex items-center justify-center" style={{ backgroundColor: COLORS.primary + '30' }}>
                                        <Wind size={12} color={COLORS.primary} />
                                      </div>
                                      <div className="flex-1">
                                        <p className="font-semibold text-xs" style={{ color: COLORS.primary }}>Warmup</p>
                                        <p className="text-xs" style={{ color: COLORS.textMuted }}>Light cardio & dynamic stretches</p>
                                      </div>
                                      <p className="font-semibold text-xs" style={{ color: COLORS.primary }}>{warmupMins}min</p>
                                    </div>
                                  )}
                                  {(workout.exercises || []).map((exercise, i) => {
                                    const sets = exercise.sets || 3;
                                    const restTime = exercise.restTime || 90;
                                    return (
                                      <div
                                        key={exercise.id || i}
                                        className="p-2 rounded-lg flex items-center gap-2"
                                        style={{ backgroundColor: COLORS.surfaceLight }}
                                      >
                                        <div className="w-6 h-6 rounded-full flex items-center justify-center" style={{ backgroundColor: style.color + '20' }}>
                                          <span className="font-bold text-xs" style={{ color: style.color }}>{i + 1}</span>
                                        </div>
                                        <div className="flex-1 flex items-center gap-1">
                                          <p className="font-semibold text-xs" style={{ color: COLORS.text }}>{exercise.name}</p>
                                          <button
                                            onClick={(e) => { e.stopPropagation(); showExerciseInfoFriendsTab(exercise.name); }}
                                            className="p-0.5 rounded-full"
                                            style={{ backgroundColor: COLORS.primary + '20' }}
                                          >
                                            <Info size={10} color={COLORS.primary} />
                                          </button>
                                        </div>
                                        <div className="text-right">
                                          <p className="font-semibold text-xs" style={{ color: COLORS.text }}>
                                            {exercise.sets} x {exercise.targetReps || exercise.reps}
                                          </p>
                                          {sets > 1 && (
                                            <p className="text-xs" style={{ color: COLORS.warning }}>{restTime}s rest</p>
                                          )}
                                        </div>
                                      </div>
                                    );
                                  })}

                                  {/* Cooldown Item */}
                                  {hasCooldown && (
                                    <div className="p-2 rounded-lg flex items-center gap-2" style={{ backgroundColor: COLORS.primary + '15', border: `1px dashed ${COLORS.primary}40` }}>
                                      <div className="w-6 h-6 rounded-full flex items-center justify-center" style={{ backgroundColor: COLORS.primary + '30' }}>
                                        <Sprout size={12} color={COLORS.primary} />
                                      </div>
                                      <div className="flex-1">
                                        <p className="font-semibold text-xs" style={{ color: COLORS.primary }}>Cooldown</p>
                                        <p className="text-xs" style={{ color: COLORS.textMuted }}>Static stretches & recovery</p>
                                      </div>
                                      <p className="font-semibold text-xs" style={{ color: COLORS.primary }}>{cooldownMins}min</p>
                                    </div>
                                  )}
                                </div>

                                {/* Rename Section */}
                                {renamingWorkout?.id === workout.id ? (
                                  <div className="flex gap-2 py-2">
                                    <input
                                      type="text"
                                      value={newWorkoutName}
                                      onChange={(e) => setNewWorkoutName(e.target.value)}
                                      placeholder="New workout name"
                                      className="flex-1 px-3 py-2 rounded-lg text-sm outline-none"
                                      style={{ backgroundColor: COLORS.surfaceLight, color: COLORS.text, border: `1px solid ${COLORS.primary}` }}
                                      autoFocus
                                    />
                                    <button
                                      onClick={handleRenameWorkout}
                                      className="px-3 py-2 rounded-lg text-sm font-semibold"
                                      style={{ backgroundColor: COLORS.primary, color: COLORS.text }}
                                    >
                                      Save
                                    </button>
                                    <button
                                      onClick={() => { setRenamingWorkout(null); setNewWorkoutName(''); }}
                                      className="px-3 py-2 rounded-lg text-sm"
                                      style={{ backgroundColor: COLORS.surfaceLight, color: COLORS.textMuted }}
                                    >
                                      Cancel
                                    </button>
                                  </div>
                                ) : null}

                                {/* Action Buttons */}
                                <div className="flex gap-2 pt-2">
                                  <button
                                    onClick={() => { setRenamingWorkout({ id: workout.id, name: workout.name }); setNewWorkoutName(workout.name); }}
                                    className="py-2 px-3 rounded-lg font-semibold text-sm flex items-center justify-center gap-1"
                                    style={{ backgroundColor: COLORS.surfaceLight, color: COLORS.text }}
                                  >
                                    <Edit3 size={14} />
                                  </button>
                                  <button
                                    onClick={() => loadComments(workout.id)}
                                    className="flex-1 py-2 rounded-lg font-semibold text-sm flex items-center justify-center gap-1"
                                    style={{ backgroundColor: COLORS.surfaceLight, color: COLORS.text }}
                                  >
                                    <MessageCircle size={14} /> Comments
                                  </button>
                                  <button
                                    onClick={() => setSelectedCommunityWorkout(workout)}
                                    className="flex-1 py-2 rounded-lg font-semibold text-sm"
                                    style={{ backgroundColor: COLORS.primary + '20', color: COLORS.primary }}
                                  >
                                    Full Details
                                  </button>
                                </div>
                              </div>
                              );
                            })()}
                          </div>
                        );
                      })}
                    </div>
                  </div>
                )}

                {/* Rep-ertoire Button */}
                <button
                  onClick={loadRepertoire}
                  className="w-full p-3 rounded-xl mb-4 flex items-center justify-center gap-2"
                  style={{ backgroundColor: COLORS.surface, border: `1px solid ${COLORS.warning}40` }}
                >
                  <Book size={18} color={COLORS.warning} />
                  <span className="font-semibold" style={{ color: COLORS.warning }}>My Rep-ertoire</span>
                  {savedWorkoutIds.size > 0 && (
                    <span className="px-2 py-0.5 rounded-full text-xs font-bold" style={{ backgroundColor: COLORS.warning, color: COLORS.background }}>
                      {savedWorkoutIds.size}
                    </span>
                  )}
                </button>

                {/* Community Workouts List */}
                <p className="text-xs font-semibold mb-3" style={{ color: COLORS.textMuted }}>COMMUNITY WORKOUTS</p>

                {communityWorkoutsLoading ? (
                  <div className="flex items-center justify-center py-8">
                    <Loader2 size={24} className="animate-spin" color={COLORS.primary} />
                  </div>
                ) : communityWorkouts.length === 0 ? (
                  <div className="p-6 rounded-xl text-center" style={{ backgroundColor: COLORS.surface }}>
                    <Dumbbell size={40} color={COLORS.primary} className="mx-auto mb-3" style={{ opacity: 0.7 }} />
                    <p className="text-sm font-medium" style={{ color: COLORS.text }}>No workouts yet</p>
                    <p className="text-xs mt-1" style={{ color: COLORS.textMuted }}>Be the first to share a workout with the community!</p>
                  </div>
                ) : (() => {
                  // Apply filters to community workouts
                  const filteredWorkouts = communityWorkouts.filter(workout => {
                    const duration = workout.target_duration || estimateWorkoutDuration(workout.exercises);

                    // Duration filter
                    if (communityFilters.duration) {
                      if (communityFilters.duration === 'short' && duration >= 30) return false;
                      if (communityFilters.duration === 'medium' && (duration < 30 || duration > 60)) return false;
                      if (communityFilters.duration === 'long' && duration <= 60) return false;
                    }

                    // Rating filter
                    if (communityFilters.minRating && (workout.averageRating || 0) < communityFilters.minRating) {
                      return false;
                    }

                    // Focus/type filter
                    if (communityFilters.focus) {
                      const focusLower = (workout.focus || '').toLowerCase();
                      if (!focusLower.includes(communityFilters.focus)) return false;
                    }

                    // Completions filter
                    if (communityFilters.minCompletions && (workout.completionCount || 0) < communityFilters.minCompletions) {
                      return false;
                    }

                    return true;
                  });

                  if (filteredWorkouts.length === 0) {
                    return (
                      <div className="p-6 rounded-xl text-center" style={{ backgroundColor: COLORS.surface }}>
                        <Filter size={40} color={COLORS.primary} className="mx-auto mb-3" style={{ opacity: 0.7 }} />
                        <p className="text-sm font-medium" style={{ color: COLORS.text }}>No matching workouts</p>
                        <p className="text-xs mt-1" style={{ color: COLORS.textMuted }}>Try adjusting your filters</p>
                      </div>
                    );
                  }

                  return (
                  <div className="space-y-3">
                    {filteredWorkouts.map(workout => {
                      const style = getWorkoutStyle(workout.focus);
                      const isExpanded = expandedWorkoutId === workout.id;
                      const targetDuration = workout.target_duration || estimateWorkoutDuration(workout.exercises);
                      const uploadDate = workout.created_at ? new Date(workout.created_at) : null;
                      const uploadTimeAgo = uploadDate ? formatActivityTime(workout.created_at) : '';

                      return (
                        <div
                          key={workout.id}
                          className="rounded-xl overflow-hidden"
                          style={{ backgroundColor: COLORS.surface }}
                        >
                          {/* Card Header - Clickable to expand */}
                          <button
                            onClick={() => setExpandedWorkoutIdWithScroll(isExpanded ? null : workout.id)}
                            className="w-full p-4 text-left"
                          >
                            <div className="flex items-start gap-3">
                              {/* Workout Icon - Unique based on focus */}
                              <div
                                className="w-12 h-12 rounded-xl flex items-center justify-center flex-shrink-0"
                                style={{ backgroundColor: style.color + '20' }}
                              >
                                <IconMap name={style.icon} size={24} color={style.color} />
                              </div>

                              {/* Workout Info */}
                              <div className="flex-1 min-w-0">
                                <div className="flex items-center gap-2">
                                  <p className="font-bold truncate" style={{ color: COLORS.text }}>{workout.name}</p>
                                  <span className="text-xs px-2 py-0.5 rounded-full" style={{ backgroundColor: style.color + '20', color: style.color }}>
                                    {style.label}
                                  </span>
                                </div>

                                {/* Duration & Time */}
                                <div className="flex items-center gap-3 mt-1">
                                  <span className="text-xs flex items-center gap-1" style={{ color: COLORS.textMuted }}>
                                    <Clock size={10} /> {targetDuration}min target
                                    {workout.avg_actual_duration && (
                                      <span style={{ color: COLORS.textSecondary }}> / {workout.avg_actual_duration}min avg</span>
                                    )}
                                  </span>
                                </div>

                                {/* Stats Row */}
                                <div className="flex items-center flex-wrap gap-2 mt-2">
                                  <div className="flex items-center gap-1">
                                    <StarRating rating={workout.averageRating || 0} readonly size={12} />
                                    <span className="text-xs font-medium" style={{ color: COLORS.warning }}>
                                      {(workout.averageRating || 0).toFixed(1)}
                                    </span>
                                  </div>
                                  <span className="text-xs" style={{ color: COLORS.textMuted }}>
                                    ({workout.ratingCount || 0} {(workout.ratingCount || 0) === 1 ? 'review' : 'reviews'})
                                  </span>
                                  <span className="text-xs flex items-center gap-1" style={{ color: COLORS.textMuted }}>
                                    <Users size={10} /> {workout.completionCount || 0} done
                                  </span>
                                  <span className="text-xs" style={{ color: COLORS.textMuted }}>
                                    {workout.exercises?.length || 0} exercises
                                  </span>
                                </div>

                                {/* Creator & Upload Time */}
                                <div className="flex items-center justify-between mt-2">
                                  {workout.creator && (
                                    <div className="flex items-center gap-2">
                                      <div
                                        className="w-5 h-5 rounded-full flex items-center justify-center text-xs font-bold"
                                        style={{ backgroundColor: style.color + '30', color: style.color }}
                                      >
                                        {workout.creator.avatar || workout.creator.name?.[0]?.toUpperCase() || 'U'}
                                      </div>
                                      <span className="text-xs" style={{ color: COLORS.textMuted }}>
                                        {workout.creator.name} <span style={{ opacity: 0.7 }}>@{workout.creator.username}</span>
                                      </span>
                                    </div>
                                  )}
                                  {uploadTimeAgo && (
                                    <span className="text-xs" style={{ color: COLORS.textMuted }}>{uploadTimeAgo}</span>
                                  )}
                                </div>
                              </div>

                              {/* Actions */}
                              <div className="flex flex-col gap-2">
                                <button
                                  onClick={(e) => { e.stopPropagation(); handleSaveWorkout(workout.id); }}
                                  className="p-2 rounded-lg"
                                  style={{ backgroundColor: savedWorkoutIds.has(workout.id) ? COLORS.warning + '20' : COLORS.surfaceLight }}
                                  title={savedWorkoutIds.has(workout.id) ? 'Remove from Rep-ertoire' : 'Add to Rep-ertoire'}
                                >
                                  <Book
                                    size={16}
                                    color={savedWorkoutIds.has(workout.id) ? COLORS.warning : COLORS.textMuted}
                                    fill={savedWorkoutIds.has(workout.id) ? COLORS.warning : 'transparent'}
                                  />
                                </button>
                                <button
                                  onClick={(e) => { e.stopPropagation(); loadComments(workout.id); }}
                                  className="p-2 rounded-lg flex items-center justify-center"
                                  style={{ backgroundColor: COLORS.surfaceLight }}
                                >
                                  <MessageCircle size={16} color={COLORS.textMuted} />
                                </button>
                              </div>
                            </div>
                          </button>

                          {/* Expanded Content - Inline workout details */}
                          {isExpanded && (() => {
                            const timing = getWorkoutTimeBreakdown(workout.exercises || []);
                            const activeMins = Math.round(timing.workingTime / 60);
                            const restMins = Math.round(timing.restTime / 60);
                            const warmupMins = Math.round(WORKOUT_TIMING.WARMUP_TIME / 60);
                            const cooldownMins = Math.round(WORKOUT_TIMING.COOLDOWN_TIME / 60);
                            const warmupCooldownState = workoutWarmupCooldown[workout.id] || {};
                            const hasWarmup = warmupCooldownState.warmup ?? true;
                            const hasCooldown = warmupCooldownState.cooldown ?? true;
                            const workoutMins = activeMins + restMins + (hasWarmup ? warmupMins : 0) + (hasCooldown ? cooldownMins : 0);
                            return (
                            <div className="px-4 pb-4 border-t" style={{ borderColor: COLORS.surfaceLight }}>
                              {/* Time Breakdown */}
                              <div className="grid grid-cols-4 gap-2 py-3">
                                <div className="text-center p-2 rounded-lg" style={{ backgroundColor: COLORS.success + '15' }}>
                                  <p className="font-bold text-sm" style={{ color: COLORS.success }}>{activeMins}min</p>
                                  <p className="text-xs" style={{ color: COLORS.textMuted }}>Active</p>
                                </div>
                                <div className="text-center p-2 rounded-lg" style={{ backgroundColor: COLORS.warning + '15' }}>
                                  <p className="font-bold text-sm" style={{ color: COLORS.warning }}>{restMins}min</p>
                                  <p className="text-xs" style={{ color: COLORS.textMuted }}>Rest</p>
                                </div>
                                <div className="text-center p-2 rounded-lg" style={{ backgroundColor: COLORS.primary + '15' }}>
                                  <p className="font-bold text-sm" style={{ color: COLORS.primary }}>{hasWarmup ? warmupMins : 0}+{hasCooldown ? cooldownMins : 0}min</p>
                                  <p className="text-xs" style={{ color: COLORS.textMuted }}>Warm/Cool</p>
                                </div>
                                <div className="text-center p-2 rounded-lg" style={{ backgroundColor: COLORS.surfaceLight }}>
                                  <p className="font-bold text-sm" style={{ color: COLORS.text }}>{workoutMins}min</p>
                                  <p className="text-xs" style={{ color: COLORS.textMuted }}>Total</p>
                                </div>
                              </div>

                              {/* Warmup/Cooldown Toggles */}
                              <div className="flex items-center gap-3 py-2">
                                <button
                                  onClick={() => toggleWarmupCooldownWithScroll(workout.id, 'warmup')}
                                  className="flex items-center gap-2 px-3 py-1.5 rounded-lg text-xs font-semibold"
                                  style={{
                                    backgroundColor: hasWarmup ? COLORS.primary + '20' : COLORS.surfaceLight,
                                    color: hasWarmup ? COLORS.primary : COLORS.textMuted
                                  }}
                                >
                                  <Wind size={12} />
                                  Warmup {warmupMins}min
                                  {hasWarmup ? <Check size={12} /> : null}
                                </button>
                                <button
                                  onClick={() => toggleWarmupCooldownWithScroll(workout.id, 'cooldown')}
                                  className="flex items-center gap-2 px-3 py-1.5 rounded-lg text-xs font-semibold"
                                  style={{
                                    backgroundColor: hasCooldown ? COLORS.primary + '20' : COLORS.surfaceLight,
                                    color: hasCooldown ? COLORS.primary : COLORS.textMuted
                                  }}
                                >
                                  <Sprout size={12} />
                                  Cooldown {cooldownMins}min
                                  {hasCooldown ? <Check size={12} /> : null}
                                </button>
                              </div>

                              {/* Your Rating - Only show if user has completed or already rated */}
                              {(completedCommunityWorkoutIds.has(workout.id) || userWorkoutRatings[workout.id]) ? (
                                <div className="py-3 flex items-center justify-between border-b" style={{ borderColor: COLORS.surfaceLight }}>
                                  <span className="text-sm font-semibold" style={{ color: COLORS.text }}>Your Rating</span>
                                  <StarRating
                                    rating={userWorkoutRatings[workout.id] || 0}
                                    onRate={(rating) => handleRateWorkout(workout.id, rating)}
                                    size={20}
                                  />
                                </div>
                              ) : (
                                <div className="py-3 flex items-center justify-between border-b" style={{ borderColor: COLORS.surfaceLight }}>
                                  <span className="text-xs" style={{ color: COLORS.textMuted }}>Complete this workout to rate it</span>
                                </div>
                              )}

                              {/* Description */}
                              {workout.description && (
                                <p className="text-sm py-3" style={{ color: COLORS.textSecondary }}>{workout.description}</p>
                              )}

                              {/* Exercises List with Warmup/Cooldown */}
                              <div className="py-3 space-y-2">
                                {/* Warmup Item */}
                                {hasWarmup && (
                                  <div className="p-3 rounded-lg flex items-center gap-3" style={{ backgroundColor: COLORS.primary + '15', border: `1px dashed ${COLORS.primary}40` }}>
                                    <div className="w-8 h-8 rounded-full flex items-center justify-center" style={{ backgroundColor: COLORS.primary + '30' }}>
                                      <Wind size={14} color={COLORS.primary} />
                                    </div>
                                    <div className="flex-1">
                                      <p className="font-semibold text-sm" style={{ color: COLORS.primary }}>Warmup</p>
                                      <p className="text-xs" style={{ color: COLORS.textMuted }}>Light cardio & dynamic stretches</p>
                                    </div>
                                    <p className="font-semibold text-sm" style={{ color: COLORS.primary }}>{warmupMins}min</p>
                                  </div>
                                )}

                                {(workout.exercises || []).map((exercise, i) => {
                                  const sets = exercise.sets || 3;
                                  const restTime = exercise.restTime || 90;
                                  return (
                                    <div
                                      key={exercise.id || i}
                                      className="p-3 rounded-lg flex items-center gap-3"
                                      style={{ backgroundColor: COLORS.surfaceLight }}
                                    >
                                      <div className="w-8 h-8 rounded-full flex items-center justify-center" style={{ backgroundColor: style.color + '20' }}>
                                        <span className="font-bold text-sm" style={{ color: style.color }}>{i + 1}</span>
                                      </div>
                                      <div className="flex-1">
                                        <div className="flex items-center gap-1">
                                          <p className="font-semibold text-sm" style={{ color: COLORS.text }}>{exercise.name}</p>
                                          <button
                                            onClick={(e) => { e.stopPropagation(); showExerciseInfoFriendsTab(exercise.name); }}
                                            className="p-0.5 rounded-full"
                                            style={{ backgroundColor: COLORS.primary + '20' }}
                                          >
                                            <Info size={12} color={COLORS.primary} />
                                          </button>
                                        </div>
                                        <p className="text-xs" style={{ color: COLORS.textMuted }}>
                                          {exercise.muscleGroup}
                                        </p>
                                      </div>
                                      <div className="text-right">
                                        <p className="font-semibold text-sm" style={{ color: COLORS.text }}>
                                          {exercise.sets} x {exercise.targetReps || exercise.reps}
                                        </p>
                                        {sets > 1 && (
                                          <p className="text-xs" style={{ color: COLORS.warning }}>{restTime}s rest</p>
                                        )}
                                      </div>
                                    </div>
                                  );
                                })}

                                {/* Cooldown Item */}
                                {hasCooldown && (
                                  <div className="p-3 rounded-lg flex items-center gap-3" style={{ backgroundColor: COLORS.primary + '15', border: `1px dashed ${COLORS.primary}40` }}>
                                    <div className="w-8 h-8 rounded-full flex items-center justify-center" style={{ backgroundColor: COLORS.primary + '30' }}>
                                      <Sprout size={14} color={COLORS.primary} />
                                    </div>
                                    <div className="flex-1">
                                      <p className="font-semibold text-sm" style={{ color: COLORS.primary }}>Cooldown</p>
                                      <p className="text-xs" style={{ color: COLORS.textMuted }}>Static stretches & recovery</p>
                                    </div>
                                    <p className="font-semibold text-sm" style={{ color: COLORS.primary }}>{cooldownMins}min</p>
                                  </div>
                                )}
                              </div>

                              {/* Action Buttons */}
                              <div className="space-y-2 pt-2">
                                <button
                                  onClick={() => {
                                    const adjusted = adjustWorkoutForUser(workout);
                                    setTodayWorkout({
                                      type: adjusted.name,
                                      name: adjusted.name,
                                      focus: adjusted.focus,
                                      exercises: adjusted.exercises?.length || 0,
                                      duration: targetDuration,
                                      communityWorkoutId: workout.id,
                                    });
                                    setExpandedWorkoutId(null);
                                    setActiveTab('workouts');
                                  }}
                                  className="w-full py-3 rounded-xl font-semibold flex items-center justify-center gap-2"
                                  style={{ backgroundColor: COLORS.primary, color: COLORS.text }}
                                >
                                  <Play size={18} /> Start Workout (Auto-adjusted)
                                </button>
                                <button
                                  onClick={() => setSelectedCommunityWorkout(workout)}
                                  className="w-full py-2 rounded-xl font-semibold text-sm"
                                  style={{ backgroundColor: COLORS.surfaceLight, color: COLORS.textSecondary }}
                                >
                                  View Full Details
                                </button>
                              </div>
                            </div>
                            );
                          })()}
                        </div>
                      );
                    })}
                  </div>
                  );
                })()}
              </>
            )}

            {/* ACTIVITY FEED TAB */}
            {friendsTab === 'feed' && (
              <>
                {/* Your Stats Card */}
                <div className="p-4 rounded-xl mb-4" style={{ backgroundColor: COLORS.surface }}>
                  <div className="flex items-center justify-between mb-3">
                    <div className="flex items-center gap-3">
                      <div className="w-12 h-12 rounded-full flex items-center justify-center text-2xl" style={{ backgroundColor: COLORS.primary + '20' }}>
                        
                      </div>
                      <div>
                        <p className="font-bold" style={{ color: COLORS.text }}>@{userData.username || 'username'}</p>
                        <p className="text-xs" style={{ color: COLORS.textSecondary }}>{userData.firstName} {userData.lastName}</p>
                        <div className="flex items-center gap-1 mt-0.5">
                          <Flame size={12} color={COLORS.warning} />
                          <span className="text-xs font-semibold" style={{ color: COLORS.warning }}>{streaks.weeklyWorkouts.weeksCompleted} week streak</span>
                        </div>
                      </div>
                    </div>
                    <button 
                      onClick={() => setShowShareModal(true)}
                      className="px-3 py-2 rounded-xl text-sm font-semibold flex items-center gap-2"
                      style={{ backgroundColor: COLORS.primary }}
                    >
                      <Share2 size={14} color={COLORS.text} />
                      <span style={{ color: COLORS.text }}>Share</span>
                    </button>
                  </div>
                  {userData.bio && (
                    <p className="text-sm mb-3" style={{ color: COLORS.textSecondary }}>{userData.bio}</p>
                  )}
                  <div className="grid grid-cols-3 gap-3 text-center">
                    <div className="p-2 rounded-lg" style={{ backgroundColor: COLORS.surfaceLight }}>
                      <p className="font-bold" style={{ color: COLORS.text }}>{overviewStats.totalWorkouts}</p>
                      <p className="text-xs" style={{ color: COLORS.textMuted }}>workouts</p>
                    </div>
                    <div className="p-2 rounded-lg" style={{ backgroundColor: COLORS.surfaceLight }}>
                      <p className="font-bold" style={{ color: COLORS.text }}>{personalRecords.length}</p>
                      <p className="text-xs" style={{ color: COLORS.textMuted }}>PRs</p>
                    </div>
                    <div className="p-2 rounded-lg" style={{ backgroundColor: COLORS.surfaceLight }}>
                      <p className="font-bold" style={{ color: COLORS.text }}>{streaks.weeklyWorkouts.weeksCompleted}</p>
                      <p className="text-xs" style={{ color: COLORS.textMuted }}>week streak</p>
                    </div>
                  </div>
                </div>

                {/* Privacy Toggle */}
                <button
                  onClick={() => setSocialEnabled(!socialEnabled)}
                  className="w-full p-3 rounded-xl mb-4 flex items-center justify-between"
                  style={{ backgroundColor: COLORS.surface }}
                >
                  <div className="flex items-center gap-2">
                    <Eye size={16} color={COLORS.textMuted} />
                    <span className="text-sm" style={{ color: COLORS.textSecondary }}>Share my activity with followers</span>
                  </div>
                  <div
                    className="w-10 h-6 rounded-full p-0.5 transition-colors"
                    style={{ backgroundColor: socialEnabled ? COLORS.success : COLORS.surfaceLight }}
                  >
                    <div
                      className="w-5 h-5 rounded-full transition-transform"
                      style={{
                        backgroundColor: COLORS.text,
                        transform: socialEnabled ? 'translateX(16px)' : 'translateX(0)'
                      }}
                    />
                  </div>
                </button>

                {/* Weekly Leaderboard */}
                {weeklyLeaderboard.length > 0 && (
                  <div className="p-4 rounded-xl mb-4" style={{ backgroundColor: COLORS.surface }}>
                    <div className="flex items-center justify-between mb-3">
                      <div className="flex items-center gap-2">
                        <Crown size={18} color={COLORS.warning} />
                        <h3 className="font-bold text-sm" style={{ color: COLORS.text }}>This Week's Leaders</h3>
                      </div>
                      <div className="flex gap-1">
                        {[
                          { id: 'workouts', label: 'Workouts' },
                          { id: 'volume', label: 'Volume' },
                          { id: 'streak', label: 'Streak' },
                        ].map(type => (
                          <button
                            key={type.id}
                            onClick={async () => {
                              setLeaderboardType(type.id);
                              setLeaderboardLoading(true);
                              const result = await competitionService.getFriendsLeaderboard(user?.id, type.id, 10);
                              if (result?.data) setWeeklyLeaderboard(result.data);
                              setLeaderboardLoading(false);
                            }}
                            className="px-2 py-1 rounded text-xs"
                            style={{
                              backgroundColor: leaderboardType === type.id ? COLORS.primary : 'transparent',
                              color: leaderboardType === type.id ? COLORS.text : COLORS.textMuted
                            }}
                          >
                            {type.label}
                          </button>
                        ))}
                      </div>
                    </div>

                    {leaderboardLoading ? (
                      <div className="flex justify-center py-4">
                        <Loader2 size={24} color={COLORS.primary} className="animate-spin" />
                      </div>
                    ) : (
                      <div className="space-y-2">
                        {weeklyLeaderboard.slice(0, 5).map((entry, index) => {
                          const entryName = entry.profile
                            ? `${entry.profile.first_name || ''} ${entry.profile.last_name || ''}`.trim() || entry.profile.username || 'User'
                            : 'User';
                          const entryAvatar = entry.profile?.avatar_url || entry.profile?.first_name?.[0]?.toUpperCase() || 'U';

                          return (
                            <button
                              key={entry.userId}
                              onClick={() => {
                                if (!entry.isCurrentUser) {
                                  setShowFriendProfile({
                                    id: entry.userId,
                                    name: entryName,
                                    username: entry.profile?.username || 'user',
                                    avatar: entryAvatar,
                                  });
                                }
                              }}
                              className="w-full flex items-center gap-3 p-2 rounded-lg"
                              style={{ backgroundColor: entry.isCurrentUser ? COLORS.primary + '15' : COLORS.surfaceLight }}
                            >
                              {/* Rank */}
                              <div
                                className="w-7 h-7 rounded-full flex items-center justify-center text-xs font-bold"
                                style={{
                                  backgroundColor: entry.rank === 1 ? COLORS.warning + '30' : entry.rank === 2 ? '#C0C0C0' + '30' : entry.rank === 3 ? '#CD7F32' + '30' : COLORS.surfaceLight,
                                  color: entry.rank === 1 ? COLORS.warning : entry.rank === 2 ? '#C0C0C0' : entry.rank === 3 ? '#CD7F32' : COLORS.textMuted
                                }}
                              >
                                {entry.rank === 1 ? <Crown size={14} /> : entry.rank}
                              </div>

                              {/* Avatar */}
                              <div
                                className="w-8 h-8 rounded-full flex items-center justify-center text-sm font-bold"
                                style={{ backgroundColor: COLORS.primary + '30', color: COLORS.primary }}
                              >
                                {typeof entryAvatar === 'string' && entryAvatar.length === 1 ? entryAvatar : entryName[0]?.toUpperCase()}
                              </div>

                              {/* Name */}
                              <div className="flex-1 min-w-0 text-left">
                                <p className="text-sm font-medium truncate" style={{ color: COLORS.text }}>
                                  {entry.isCurrentUser ? 'You' : entryName}
                                </p>
                                {entry.isCurrentUser && (
                                  <p className="text-xs" style={{ color: COLORS.primary }}>Your position</p>
                                )}
                              </div>

                              {/* Score */}
                              <div className="text-right">
                                <p className="font-bold" style={{ color: COLORS.text }}>
                                  {leaderboardType === 'volume' ? `${(entry.score / 1000).toFixed(1)}k` : entry.score}
                                </p>
                                <p className="text-xs" style={{ color: COLORS.textMuted }}>
                                  {leaderboardType === 'volume' ? 'kg' : leaderboardType === 'streak' ? 'days' : 'sessions'}
                                </p>
                              </div>
                            </button>
                          );
                        })}
                      </div>
                    )}
                  </div>
                )}

                {/* Workout Buddy Card */}
                {workoutBuddy?.buddy && (
                  <div className="p-4 rounded-xl mb-4" style={{ backgroundColor: COLORS.surface }}>
                    <div className="flex items-center gap-2 mb-3">
                      <Users size={18} color={COLORS.success} />
                      <h3 className="font-bold text-sm" style={{ color: COLORS.text }}>Workout Buddy</h3>
                    </div>
                    <button
                      onClick={() => {
                        const buddy = workoutBuddy.buddy;
                        setShowFriendProfile({
                          id: buddy.id,
                          name: `${buddy.first_name || ''} ${buddy.last_name || ''}`.trim() || buddy.username || 'User',
                          username: buddy.username || 'user',
                          avatar: buddy.avatar_url || buddy.first_name?.[0]?.toUpperCase() || 'U',
                          bio: buddy.bio,
                        });
                      }}
                      className="w-full flex items-center gap-3 p-3 rounded-lg"
                      style={{ backgroundColor: COLORS.success + '15' }}
                    >
                      <div
                        className="w-12 h-12 rounded-full flex items-center justify-center text-lg font-bold"
                        style={{ backgroundColor: COLORS.success + '30', color: COLORS.success }}
                      >
                        {workoutBuddy.buddy.avatar_url || workoutBuddy.buddy.first_name?.[0]?.toUpperCase() || 'U'}
                      </div>
                      <div className="flex-1 text-left">
                        <p className="font-semibold" style={{ color: COLORS.text }}>
                          {`${workoutBuddy.buddy.first_name || ''} ${workoutBuddy.buddy.last_name || ''}`.trim() || workoutBuddy.buddy.username || 'Buddy'}
                        </p>
                        <p className="text-xs" style={{ color: COLORS.textMuted }}>
                          Buddies since {workoutBuddy.matched_at ? new Date(workoutBuddy.matched_at).toLocaleDateString() : 'recently'}
                        </p>
                      </div>
                      <ChevronRight size={20} color={COLORS.textMuted} />
                    </button>
                  </div>
                )}

                {/* Pending Buddy Requests */}
                {buddyRequests.length > 0 && (
                  <div className="p-4 rounded-xl mb-4" style={{ backgroundColor: COLORS.surface }}>
                    <div className="flex items-center gap-2 mb-3">
                      <UserPlus size={18} color={COLORS.primary} />
                      <h3 className="font-bold text-sm" style={{ color: COLORS.text }}>Buddy Requests</h3>
                      <span className="px-2 py-0.5 rounded-full text-xs font-bold" style={{ backgroundColor: COLORS.primary, color: COLORS.text }}>
                        {buddyRequests.length}
                      </span>
                    </div>
                    <div className="space-y-2">
                      {buddyRequests.map(request => {
                        const requester = request.user_a;
                        const requesterName = `${requester?.first_name || ''} ${requester?.last_name || ''}`.trim() || requester?.username || 'User';

                        return (
                          <div key={request.id} className="flex items-center gap-3 p-2 rounded-lg" style={{ backgroundColor: COLORS.surfaceLight }}>
                            <div
                              className="w-10 h-10 rounded-full flex items-center justify-center text-sm font-bold"
                              style={{ backgroundColor: COLORS.primary + '30', color: COLORS.primary }}
                            >
                              {requester?.avatar_url || requester?.first_name?.[0]?.toUpperCase() || 'U'}
                            </div>
                            <div className="flex-1 min-w-0">
                              <p className="text-sm font-medium" style={{ color: COLORS.text }}>{requesterName}</p>
                              <p className="text-xs" style={{ color: COLORS.textMuted }}>wants to be your workout buddy</p>
                            </div>
                            <div className="flex gap-2">
                              <button
                                onClick={async () => {
                                  await accountabilityService.acceptBuddy(request.id, user?.id);
                                  setBuddyRequests(prev => prev.filter(r => r.id !== request.id));
                                  // Reload buddy data
                                  const result = await accountabilityService.getBuddy(user?.id);
                                  if (result?.data) setWorkoutBuddy(result.data);
                                }}
                                className="px-3 py-1.5 rounded-lg text-xs font-semibold"
                                style={{ backgroundColor: COLORS.success, color: COLORS.text }}
                              >
                                Accept
                              </button>
                              <button
                                onClick={async () => {
                                  await accountabilityService.declineBuddy(request.id, user?.id);
                                  setBuddyRequests(prev => prev.filter(r => r.id !== request.id));
                                }}
                                className="px-3 py-1.5 rounded-lg text-xs font-semibold"
                                style={{ backgroundColor: COLORS.surfaceLight, color: COLORS.textMuted }}
                              >
                                Decline
                              </button>
                            </div>
                          </div>
                        );
                      })}
                    </div>
                  </div>
                )}

                {/* Activity Feed */}
                <p className="text-xs font-semibold mb-3" style={{ color: COLORS.textMuted }}>ACTIVITY FEED</p>

                {activityFeed.length === 0 ? (
                  <div className="p-6 rounded-xl text-center" style={{ backgroundColor: COLORS.surface }}>
                    <Users size={40} color={COLORS.primary} className="mx-auto mb-3" style={{ opacity: 0.7 }} />
                    <p className="text-sm font-medium" style={{ color: COLORS.text }}>No recent activity</p>
                    <p className="text-xs mt-1" style={{ color: COLORS.textMuted }}>Follow more people to see their workouts here!</p>
                    <button
                      onClick={() => setFriendsTab('discover')}
                      className="mt-3 px-4 py-2 rounded-lg text-sm font-semibold"
                      style={{ backgroundColor: COLORS.primary, color: COLORS.text }}
                    >
                      Discover People
                    </button>
                  </div>
                ) : (
                <div className="space-y-3">
                  {activityFeed.map(activity => {
                    // Use friend data from activity object
                    const friendData = activity.friend;
                    if (!friendData) return null;
                    const friend = {
                      id: friendData.id,
                      name: `${friendData.first_name || ''} ${friendData.last_name || ''}`.trim() || friendData.username || 'User',
                      username: friendData.username || 'user',
                      avatar: friendData.avatar_url || friendData.first_name?.[0]?.toUpperCase() || '?',
                      streak: 0, // Will be calculated when viewing profile
                    };
                    const isExpanded = expandedActivity === activity.id;

                    return (
                      <div
                        key={activity.id}
                        className="rounded-xl overflow-hidden"
                        style={{ backgroundColor: COLORS.surface }}
                      >
                        {/* Workout Activity Card */}
                        {activity.type === 'workout' && (
                          <div className="p-4">
                            <div className="flex items-start gap-3 mb-3">
                              <button
                                onClick={() => setShowFriendProfile(friend)}
                                className="w-10 h-10 rounded-full flex items-center justify-center text-xl flex-shrink-0"
                                style={{ backgroundColor: COLORS.surfaceLight }}
                              >
                                {typeof friend.avatar === 'string' && friend.avatar.length === 1 ? friend.avatar : '?'}
                              </button>
                              <div className="flex-1">
                                <div className="flex items-center gap-2">
                                  <button
                                    onClick={() => setShowFriendProfile(friend)}
                                    className="font-semibold"
                                    style={{ color: COLORS.text }}
                                  >
                                    {friend.name}
                                  </button>
                                  {friend.streak >= 7 && (
                                    <button
                                      onClick={(e) => { e.stopPropagation(); setShowFriendStreakCalendar(friend); }}
                                      className="text-xs px-2 py-0.5 rounded-full flex items-center gap-1"
                                      style={{ backgroundColor: COLORS.warning + '20' }}>
                                      <Flame size={10} color={COLORS.warning} />
                                      <span style={{ color: COLORS.warning }}>{friend.streak}</span>
                                    </button>
                                  )}
                                </div>
                                <p className="text-xs" style={{ color: COLORS.textMuted }}>@{friend.username}  {activity.time}</p>
                              </div>
                            </div>
                            
                            {/* Workout Summary - Clickable to expand */}
                            <button
                              onClick={async () => {
                                if (isExpanded) {
                                  setExpandedActivity(null);
                                  return;
                                }
                                setExpandedActivity(activity.id);
                                // Fetch workout sets if not already loaded
                                if (!expandedActivitySets[activity.id]) {
                                  try {
                                    const { data } = await supabase
                                      .from('workout_sets')
                                      .select('*')
                                      .eq('session_id', activity.id)
                                      .order('exercise_name', { ascending: true })
                                      .order('set_number', { ascending: true });
                                    setExpandedActivitySets(prev => ({ ...prev, [activity.id]: data || [] }));
                                  } catch (err) {
                                    console.warn('Error loading workout sets:', err);
                                  }
                                }
                              }}
                              className="w-full p-3 rounded-lg mb-3 text-left"
                              style={{ backgroundColor: COLORS.primary + '10', borderLeft: `3px solid ${COLORS.primary}` }}
                            >
                              <div className="flex items-center justify-between mb-2">
                                <div className="flex items-center gap-2">
                                  <Dumbbell size={16} color={COLORS.primary} />
                                  <span className="font-semibold" style={{ color: COLORS.text }}>{activity.workoutName}</span>
                                </div>
                                <div className="flex items-center gap-2">
                                  <span className="text-xs" style={{ color: COLORS.textMuted }}>{activity.duration} min</span>
                                  {isExpanded ? <ChevronUp size={16} color={COLORS.primary} /> : <ChevronDown size={16} color={COLORS.primary} />}
                                </div>
                              </div>

                              {/* Exercise Details when expanded */}
                              {isExpanded && (
                                <div className="space-y-2 mt-3 pt-3 border-t" style={{ borderColor: COLORS.primary + '30' }}>
                                  {expandedActivitySets[activity.id] ? (
                                    (() => {
                                      const sets = expandedActivitySets[activity.id];
                                      if (sets.length === 0) {
                                        return <p className="text-xs" style={{ color: COLORS.textMuted }}>No exercise details recorded</p>;
                                      }
                                      // Group sets by exercise name
                                      const groupedExercises = {};
                                      sets.forEach(set => {
                                        const name = set.exercise_name || 'Unknown';
                                        if (!groupedExercises[name]) {
                                          groupedExercises[name] = [];
                                        }
                                        groupedExercises[name].push(set);
                                      });
                                      return Object.entries(groupedExercises).map(([exerciseName, exerciseSets], i) => (
                                        <div key={i} className="text-sm">
                                          <p className="font-medium" style={{ color: COLORS.text }}>{exerciseName}</p>
                                          <div className="ml-3 space-y-0.5">
                                            {exerciseSets.map((set, j) => (
                                              <p key={j} className="text-xs" style={{ color: COLORS.textMuted }}>
                                                Set {set.set_number}: {set.weight}kg x {set.reps} reps
                                                {set.rpe && ` @ RPE ${set.rpe}`}
                                              </p>
                                            ))}
                                          </div>
                                        </div>
                                      ));
                                    })()
                                  ) : (
                                    <p className="text-xs" style={{ color: COLORS.textMuted }}>Loading...</p>
                                  )}
                                </div>
                              )}

                              {!isExpanded && (
                                <p className="text-xs" style={{ color: COLORS.primary }}>Tap to see exercises</p>
                              )}
                            </button>
                            
                            {/* Actions */}
                            <div className="flex items-center gap-4">
                              <button
                                onClick={() => handleActivityLike(activity.id, activity.friendId)}
                                className="flex items-center gap-1"
                              >
                                <Heart
                                  size={18}
                                  color={userLikes[activity.id] ? COLORS.error : COLORS.textMuted}
                                  fill={userLikes[activity.id] ? COLORS.error : 'none'}
                                />
                                <span className="text-sm" style={{ color: COLORS.textMuted }}>
                                  {activity.likes + (userLikes[activity.id] ? 1 : 0)}
                                </span>
                              </button>
                              <button
                                onClick={() => setShowCommentsModal(activity.id)}
                                className="flex items-center gap-1"
                              >
                                <MessageCircle size={18} color={COLORS.textMuted} />
                                <span className="text-sm" style={{ color: COLORS.textMuted }}>
                                  {activityCommentCounts[activity.id] > 0 ? activityCommentCounts[activity.id] : 'Comment'}
                                </span>
                              </button>
                            </div>
                          </div>
                        )}

                        {/* PR Activity Card */}
                        {activity.type === 'pr' && (
                          <div className="p-4">
                            <div className="flex items-start gap-3 mb-3">
                              <button 
                                onClick={() => setShowFriendProfile(friend)}
                                className="w-10 h-10 rounded-full flex items-center justify-center text-xl flex-shrink-0"
                                style={{ backgroundColor: COLORS.surfaceLight }}
                              >
                                {friend.avatar}
                              </button>
                              <div className="flex-1">
                                <div className="flex items-center gap-2">
                                  <button 
                                    onClick={() => setShowFriendProfile(friend)}
                                    className="font-semibold"
                                    style={{ color: COLORS.text }}
                                  >
                                    {friend.name}
                                  </button>
                                  <span className="text-xs px-2 py-0.5 rounded-full flex items-center gap-1" style={{ backgroundColor: COLORS.success + '20', color: COLORS.success }}>
                                    <Trophy size={12} /> NEW PR
                                  </span>
                                </div>
                                <p className="text-xs" style={{ color: COLORS.textMuted }}>{activity.time}</p>
                              </div>
                            </div>
                            
                            {/* PR Details */}
                            <button 
                              onClick={() => setExpandedActivity(isExpanded ? null : activity.id)}
                              className="w-full p-3 rounded-lg mb-3 text-left"
                              style={{ backgroundColor: COLORS.success + '10', borderLeft: `3px solid ${COLORS.success}` }}
                            >
                              <div className="flex items-center justify-between mb-1">
                                <span className="font-semibold" style={{ color: COLORS.text }}>{activity.exercise}</span>
                                <ChevronDown 
                                  size={16} 
                                  color={COLORS.textMuted} 
                                  style={{ transform: isExpanded ? 'rotate(180deg)' : 'none', transition: 'transform 0.2s' }}
                                />
                              </div>
                              <div className="flex items-center gap-2">
                                <span className="text-2xl font-bold" style={{ color: COLORS.success }}>{activity.newWeight}kg</span>
                                <span className="text-sm px-2 py-0.5 rounded" style={{ backgroundColor: COLORS.success + '20', color: COLORS.success }}>
                                  +{activity.newWeight - activity.previousWeight}kg
                                </span>
                              </div>
                              <p className="text-xs mt-1" style={{ color: COLORS.textMuted }}>
                                Tap to see progress journey 
                              </p>
                            </button>
                            
                            {/* PR Progress Graph */}
                            {isExpanded && activity.prHistory && (
                              <div className="p-3 rounded-lg mb-3" style={{ backgroundColor: COLORS.surfaceLight }}>
                                <p className="text-xs font-semibold mb-2" style={{ color: COLORS.textMuted }}>
                                  {friend.name.split(' ')[0]}'s {activity.exercise} Journey
                                </p>
                                <div style={{ height: 120 }}>
                                  <ResponsiveContainer width="100%" height="100%">
                                    <LineChart data={activity.prHistory}>
                                      <XAxis dataKey="date" tick={{ fill: COLORS.textMuted, fontSize: 10 }} axisLine={false} tickLine={false} />
                                      <YAxis tick={{ fill: COLORS.textMuted, fontSize: 10 }} axisLine={false} tickLine={false} width={30} domain={['dataMin - 10', 'dataMax + 10']} />
                                      <Tooltip 
                                        contentStyle={{ backgroundColor: COLORS.surface, border: 'none', borderRadius: 8 }}
                                        formatter={(value) => [`${value}kg`, 'Weight']}
                                      />
                                      <Line 
                                        type="monotone" 
                                        dataKey="weight" 
                                        stroke={COLORS.success} 
                                        strokeWidth={2} 
                                        dot={{ fill: COLORS.success, r: 4 }}
                                      />
                                    </LineChart>
                                  </ResponsiveContainer>
                                </div>
                                <p className="text-xs text-center mt-2" style={{ color: COLORS.success }}>
                                  +{activity.prHistory[activity.prHistory.length - 1].weight - activity.prHistory[0].weight}kg total progress
                                </p>
                              </div>
                            )}
                            
                            {/* Actions */}
                            <div className="flex items-center gap-4">
                              <button
                                onClick={() => handleActivityLike(activity.id, activity.friendId)}
                                className="flex items-center gap-1"
                              >
                                <Heart
                                  size={18}
                                  color={userLikes[activity.id] ? COLORS.error : COLORS.textMuted}
                                  fill={userLikes[activity.id] ? COLORS.error : 'none'}
                                />
                                <span className="text-sm" style={{ color: COLORS.textMuted }}>
                                  {activity.likes + (userLikes[activity.id] ? 1 : 0)}
                                </span>
                              </button>
                              <button
                                onClick={() => setShowCommentsModal(activity.id)}
                                className="flex items-center gap-1"
                              >
                                <MessageCircle size={18} color={COLORS.textMuted} />
                                <span className="text-sm" style={{ color: COLORS.textMuted }}>
                                  {activityCommentCounts[activity.id] > 0 ? activityCommentCounts[activity.id] : 'Congratulate'}
                                </span>
                              </button>
                            </div>
                          </div>
                        )}

                        {/* Milestone Activity Card */}
                        {activity.type === 'milestone' && (
                          <div className="p-4">
                            <div className="flex items-center gap-3">
                              <button 
                                onClick={() => setShowFriendProfile(friend)}
                                className="w-10 h-10 rounded-full flex items-center justify-center text-xl flex-shrink-0"
                                style={{ backgroundColor: COLORS.surfaceLight }}
                              >
                                {friend.avatar}
                              </button>
                              <div className="flex-1">
                                <div className="flex items-center gap-2 flex-wrap">
                                  <button 
                                    onClick={() => setShowFriendProfile(friend)}
                                    className="font-semibold"
                                    style={{ color: COLORS.text }}
                                  >
                                    {friend.name}
                                  </button>
                                  <span className="text-sm" style={{ color: COLORS.textSecondary }}>reached</span>
                                  <span className="text-sm font-bold px-2 py-0.5 rounded-full flex items-center gap-1" style={{ backgroundColor: COLORS.accent + '20', color: COLORS.accent }}>
                                    <Star size={12} /> {activity.milestone}
                                  </span>
                                </div>
                                <p className="text-xs" style={{ color: COLORS.textMuted }}>{activity.time}</p>
                              </div>
                              <button onClick={() => handleActivityLike(activity.id, activity.friendId)}>
                                <Heart
                                  size={18}
                                  color={userLikes[activity.id] ? COLORS.error : COLORS.textMuted}
                                  fill={userLikes[activity.id] ? COLORS.error : 'none'}
                                />
                              </button>
                            </div>
                          </div>
                        )}
                      </div>
                    );
                  })}
                </div>
                )}
              </>
            )}

            {/* FOLLOWERS LIST TAB */}
            {friendsTab === 'followers' && (
              <>
                <p className="text-xs font-semibold mb-3" style={{ color: COLORS.textMuted }}>
                  PEOPLE WHO FOLLOW YOU ({followersList.length})
                </p>

                {followersLoading ? (
                  <div className="p-6 rounded-xl text-center" style={{ backgroundColor: COLORS.surface }}>
                    <div className="animate-spin w-8 h-8 border-2 rounded-full mx-auto mb-2"
                         style={{ borderColor: COLORS.primary, borderTopColor: 'transparent' }} />
                    <p className="text-sm" style={{ color: COLORS.textMuted }}>Loading followers...</p>
                  </div>
                ) : followersList.length === 0 ? (
                  <div className="p-6 rounded-xl text-center" style={{ backgroundColor: COLORS.surface }}>
                    <Users size={40} color={COLORS.primary} className="mx-auto mb-3" style={{ opacity: 0.7 }} />
                    <p className="text-sm font-medium" style={{ color: COLORS.text }}>No followers yet</p>
                    <p className="text-xs mt-1" style={{ color: COLORS.textMuted }}>
                      Share your workouts and stay active to gain followers!
                    </p>
                  </div>
                ) : (
                  <div className="space-y-2">
                    {followersList.map(follower => (
                      <button
                        key={follower.id}
                        onClick={() => {
                          const friendData = {
                            id: follower.id,
                            name: follower.name,
                            username: follower.username,
                            avatar: follower.avatar || follower.name?.charAt(0) || '?',
                            workouts: follower.workouts,
                            followers: follower.followers,
                          };
                          setShowFriendProfile(friendData);
                        }}
                        className="w-full p-4 rounded-xl flex items-center justify-between"
                        style={{ backgroundColor: COLORS.surface }}
                      >
                        <div className="flex items-center gap-3">
                          <div
                            className="w-12 h-12 rounded-full flex items-center justify-center text-xl overflow-hidden"
                            style={{ backgroundColor: COLORS.surfaceLight }}
                          >
                            {follower.avatar ? (
                              typeof follower.avatar === 'string' && follower.avatar.startsWith('http') ? (
                                <img src={follower.avatar} alt="" className="w-full h-full object-cover" />
                              ) : (
                                follower.name?.charAt(0) || '?'
                              )
                            ) : (
                              follower.name?.charAt(0) || '?'
                            )}
                          </div>
                          <div className="text-left">
                            <p className="font-semibold" style={{ color: COLORS.text }}>{follower.name}</p>
                            <p className="text-xs" style={{ color: COLORS.textMuted }}>@{follower.username}</p>
                          </div>
                        </div>
                        <div className="text-right">
                          <div className="flex items-center gap-1 justify-end">
                            <Dumbbell size={12} color={COLORS.textMuted} />
                            <span className="text-xs" style={{ color: COLORS.textMuted }}>{follower.workouts} workouts</span>
                          </div>
                          <div className="flex items-center gap-1 justify-end mt-1">
                            <Users size={12} color={COLORS.textMuted} />
                            <span className="text-xs" style={{ color: COLORS.textMuted }}>{follower.followers} followers</span>
                          </div>
                        </div>
                      </button>
                    ))}
                  </div>
                )}
              </>
            )}

            {/* FOLLOWING LIST TAB */}
            {friendsTab === 'following' && (
              <>
                {/* Find Users Button */}
                <button
                  onClick={() => setShowAddFriendModal(true)}
                  className="w-full p-4 rounded-xl mb-4 flex items-center justify-center gap-2"
                  style={{ backgroundColor: COLORS.primary }}
                >
                  <Plus size={20} color={COLORS.text} />
                  <span className="font-semibold" style={{ color: COLORS.text }}>Find Users to Follow</span>
                </button>

                {/* Active Workouts */}
                {friends.filter(f => f.workoutStatus === 'working_out').length > 0 && (
                  <div className="mb-4">
                    <p className="text-xs font-semibold mb-2" style={{ color: COLORS.textMuted }}>WORKING OUT NOW</p>
                    <div className="flex gap-3 overflow-x-auto pb-2">
                      {friends.filter(f => f.workoutStatus === 'working_out').map(friend => (
                        <button
                          key={friend.id}
                          onClick={() => setShowFriendProfile(friend)}
                          className="flex flex-col items-center flex-shrink-0"
                        >
                          <div className="relative">
                            <div
                              className="w-14 h-14 rounded-full flex items-center justify-center text-2xl animate-pulse"
                              style={{ backgroundColor: COLORS.primary + '30', border: `2px solid ${COLORS.primary}` }}
                            >
                              {friend.avatar}
                            </div>
                            <div
                              className="absolute -bottom-1 left-1/2 -translate-x-1/2 px-2 py-0.5 rounded-full flex items-center gap-1"
                              style={{ backgroundColor: COLORS.primary }}
                            >
                              <Dumbbell size={10} color={COLORS.text} />
                              <span className="text-xs font-bold" style={{ color: COLORS.text }}>{friend.workoutDuration}m</span>
                            </div>
                          </div>
                          <p className="text-xs mt-2 max-w-[70px] truncate" style={{ color: COLORS.textSecondary }}>
                            {friend.name.split(' ')[0]}
                          </p>
                        </button>
                      ))}
                    </div>
                  </div>
                )}

                {/* Just Finished */}
                {friends.filter(f => f.workoutStatus === 'just_finished').length > 0 && (
                  <div className="mb-4">
                    <p className="text-xs font-semibold mb-2" style={{ color: COLORS.textMuted }}>JUST FINISHED</p>
                    <div className="flex gap-3 overflow-x-auto pb-2">
                      {friends.filter(f => f.workoutStatus === 'just_finished').map(friend => (
                        <button
                          key={friend.id}
                          onClick={() => setShowFriendProfile(friend)}
                          className="flex flex-col items-center flex-shrink-0"
                        >
                          <div className="relative">
                            <div
                              className="w-14 h-14 rounded-full flex items-center justify-center text-2xl"
                              style={{ backgroundColor: COLORS.success + '20', border: `2px solid ${COLORS.success}` }}
                            >
                              {friend.avatar}
                            </div>
                            <div
                              className="absolute -bottom-1 left-1/2 -translate-x-1/2 px-2 py-0.5 rounded-full flex items-center gap-1"
                              style={{ backgroundColor: COLORS.success }}
                            >
                              <Check size={10} color={COLORS.background} />
                              <span className="text-xs font-bold" style={{ color: COLORS.background }}>{friend.finishedMinutesAgo}m</span>
                            </div>
                          </div>
                          <p className="text-xs mt-2 max-w-[70px] truncate" style={{ color: COLORS.textSecondary }}>
                            {friend.name.split(' ')[0]}
                          </p>
                        </button>
                      ))}
                    </div>
                  </div>
                )}

                {/* Online Now (no workout activity) */}
                {friends.filter(f => f.isOnline && !f.workoutStatus).length > 0 && (
                  <div className="mb-4">
                    <p className="text-xs font-semibold mb-2" style={{ color: COLORS.textMuted }}>ONLINE NOW</p>
                    <div className="flex gap-3 overflow-x-auto pb-2">
                      {friends.filter(f => f.isOnline && !f.workoutStatus).map(friend => (
                        <button
                          key={friend.id}
                          onClick={() => setShowFriendProfile(friend)}
                          className="flex flex-col items-center flex-shrink-0"
                        >
                          <div className="relative">
                            <div
                              className="w-14 h-14 rounded-full flex items-center justify-center text-2xl"
                              style={{ backgroundColor: COLORS.surface }}
                            >
                              {friend.avatar}
                            </div>
                            <div
                              className="absolute bottom-0 right-0 w-4 h-4 rounded-full border-2"
                              style={{ backgroundColor: COLORS.success, borderColor: COLORS.background }}
                            />
                          </div>
                          <p className="text-xs mt-1 max-w-[60px] truncate" style={{ color: COLORS.textSecondary }}>
                            {friend.name.split(' ')[0]}
                          </p>
                        </button>
                      ))}
                    </div>
                  </div>
                )}

                {/* All Following */}
                <p className="text-xs font-semibold mb-3" style={{ color: COLORS.textMuted }}>FOLLOWING ({friends.length})</p>

                {friends.length === 0 ? (
                  <div className="p-6 rounded-xl text-center" style={{ backgroundColor: COLORS.surface }}>
                    <UserPlus size={40} color={COLORS.primary} className="mx-auto mb-3" style={{ opacity: 0.7 }} />
                    <p className="text-sm font-medium" style={{ color: COLORS.text }}>Not following anyone yet</p>
                    <p className="text-xs mt-1" style={{ color: COLORS.textMuted }}>Search for users or discover top athletes to follow!</p>
                    <button
                      onClick={() => setFriendsTab('discover')}
                      className="mt-3 px-4 py-2 rounded-lg text-sm font-semibold"
                      style={{ backgroundColor: COLORS.primary, color: COLORS.text }}
                    >
                      Discover People
                    </button>
                  </div>
                ) : (
                <div className="space-y-2">
                  {friends.map(friend => (
                    <button
                      key={friend.id}
                      onClick={() => setShowFriendProfile(friend)}
                      className="w-full p-4 rounded-xl flex items-center justify-between"
                      style={{ backgroundColor: COLORS.surface }}
                    >
                      <div className="flex items-center gap-3">
                        <div className="relative">
                          <div
                            className="w-12 h-12 rounded-full flex items-center justify-center text-xl"
                            style={{
                              backgroundColor: friend.workoutStatus === 'working_out' ? COLORS.primary + '30' :
                                              friend.workoutStatus === 'just_finished' ? COLORS.success + '20' :
                                              COLORS.surfaceLight,
                              border: friend.workoutStatus ? `2px solid ${friend.workoutStatus === 'working_out' ? COLORS.primary : COLORS.success}` : 'none'
                            }}
                          >
                            {typeof friend.avatar === 'string' && friend.avatar.length === 1 ? friend.avatar : '?'}
                          </div>
                          {friend.workoutStatus === 'working_out' ? (
                            <div
                              className="absolute -bottom-1 right-0 px-1.5 py-0.5 rounded-full flex items-center gap-0.5"
                              style={{ backgroundColor: COLORS.primary }}
                            >
                              <Dumbbell size={8} color={COLORS.text} />
                            </div>
                          ) : friend.workoutStatus === 'just_finished' ? (
                            <div
                              className="absolute -bottom-1 right-0 px-1.5 py-0.5 rounded-full flex items-center gap-0.5"
                              style={{ backgroundColor: COLORS.success }}
                            >
                              <Check size={8} color={COLORS.background} />
                            </div>
                          ) : friend.isOnline ? (
                            <div
                              className="absolute bottom-0 right-0 w-3 h-3 rounded-full border-2"
                              style={{ backgroundColor: COLORS.success, borderColor: COLORS.surface }}
                            />
                          ) : null}
                        </div>
                        <div className="text-left">
                          <p className="font-semibold" style={{ color: COLORS.text }}>{friend.name}</p>
                          <p className="text-xs" style={{ color: COLORS.textMuted }}>@{friend.username}</p>
                          <p className="text-xs mt-0.5" style={{ color: friend.workoutStatus === 'working_out' ? COLORS.primary : friend.workoutStatus === 'just_finished' ? COLORS.success : COLORS.textMuted }}>
                            {friend.workoutStatus === 'working_out' ? `Working out - ${friend.currentWorkout}` :
                             friend.workoutStatus === 'just_finished' ? `Finished ${friend.finishedMinutesAgo}m ago` :
                             friend.program}
                          </p>
                        </div>
                      </div>
                      <div className="text-right">
                        <button
                          onClick={(e) => { e.stopPropagation(); setShowFriendStreakCalendar(friend); }}
                          className="flex items-center gap-1 justify-end px-2 py-1 rounded-lg mb-1"
                          style={{ backgroundColor: COLORS.warning + '15' }}
                        >
                          <Flame size={14} color={COLORS.warning} />
                          <span className="font-bold" style={{ color: COLORS.warning }}>{friend.streak}</span>
                        </button>
                        <p className="text-xs" style={{ color: COLORS.textMuted }}>{friend.lastActive}</p>
                      </div>
                    </button>
                  ))}
                </div>
                )}
              </>
            )}

            {/* DISCOVER TAB - Top Followed Users */}
            {friendsTab === 'discover' && (
              <>
                {/* Time Period Filter */}
                <div className="mb-4">
                  <p className="text-xs font-semibold mb-2" style={{ color: COLORS.textMuted }}>TOP FOLLOWED</p>
                  <div className="flex gap-2">
                    {[
                      { id: 'all', label: 'All Time' },
                      { id: '7', label: '7 Days' },
                      { id: '14', label: '14 Days' },
                      { id: '31', label: '31 Days' },
                    ].map(period => (
                      <button
                        key={period.id}
                        onClick={() => setTopFollowedPeriod(period.id)}
                        className="flex-1 py-2 rounded-lg text-xs font-semibold"
                        style={{
                          backgroundColor: topFollowedPeriod === period.id ? COLORS.primary : COLORS.surface,
                          color: topFollowedPeriod === period.id ? COLORS.text : COLORS.textMuted
                        }}
                      >
                        {period.label}
                      </button>
                    ))}
                  </div>
                </div>

                {/* Top Followed Leaderboard */}
                {topFollowedLoading ? (
                  <div className="flex items-center justify-center py-8">
                    <Loader2 size={24} className="animate-spin" color={COLORS.primary} />
                  </div>
                ) : topFollowedUsers.length === 0 ? (
                  <div className="p-6 rounded-xl text-center" style={{ backgroundColor: COLORS.surface }}>
                    <Trophy size={40} color={COLORS.primary} className="mx-auto mb-3" style={{ opacity: 0.7 }} />
                    <p className="text-sm font-medium" style={{ color: COLORS.text }}>Leaderboard Coming Soon</p>
                    <p className="text-xs mt-1" style={{ color: COLORS.textMuted }}>Follow others and build your network - top creators will appear here!</p>
                  </div>
                ) : (
                <div className="space-y-3">
                  {[...(topFollowedUsers || [])]
                    .filter(u => u && u.id)
                    .sort((a, b) => {
                      if (topFollowedPeriod === 'all') {
                        return (b?.followers || 0) - (a?.followers || 0);
                      }
                      return (b?.followedRecently || 0) - (a?.followedRecently || 0);
                    })
                    .map((user, index) => (
                      <div
                        key={user.id}
                        className="p-4 rounded-xl flex items-center gap-3"
                        style={{ backgroundColor: COLORS.surface }}
                      >
                        {/* Rank */}
                        <div
                          className="w-8 h-8 rounded-full flex items-center justify-center text-sm font-bold flex-shrink-0"
                          style={{
                            backgroundColor: index === 0 ? '#FFD700' : index === 1 ? '#C0C0C0' : index === 2 ? '#CD7F32' : COLORS.surfaceLight,
                            color: index < 3 ? COLORS.background : COLORS.text
                          }}
                        >
                          {index + 1}
                        </div>

                        {/* Avatar */}
                        <div className="relative flex-shrink-0">
                          <div
                            className="w-12 h-12 rounded-full flex items-center justify-center text-lg font-bold"
                            style={{ backgroundColor: COLORS.primary + '30', color: COLORS.primary }}
                          >
                            {user.avatar || user.name?.[0]?.toUpperCase() || 'U'}
                          </div>
                          {user.verified && (
                            <div
                              className="absolute -bottom-1 -right-1 w-5 h-5 rounded-full flex items-center justify-center text-xs"
                              style={{ backgroundColor: COLORS.primary }}
                            >
                              
                            </div>
                          )}
                        </div>

                        {/* Info */}
                        <div className="flex-1 min-w-0">
                          <div className="flex items-center gap-2">
                            <p className="font-semibold truncate" style={{ color: COLORS.text }}>{user.name || 'User'}</p>
                          </div>
                          <p className="text-xs" style={{ color: COLORS.textMuted }}>@{user.username || 'user'}</p>
                          <div className="flex items-center gap-2 mt-1">
                            {user.program && <span className="text-xs" style={{ color: COLORS.textSecondary }}>{user.program}</span>}
                            {(user.streak || 0) > 0 && (
                              <span className="text-xs flex items-center gap-1" style={{ color: COLORS.warning }}>
                                <Flame size={10} /> {user.streak}
                              </span>
                            )}
                          </div>
                        </div>

                        {/* Followers Count & Follow Button */}
                        <div className="text-right flex-shrink-0">
                          <p className="text-lg font-bold" style={{ color: COLORS.text }}>
                            {topFollowedPeriod === 'all'
                              ? ((user.followers || 0) >= 1000 ? `${((user.followers || 0) / 1000).toFixed(1)}k` : (user.followers || 0))
                              : `+${user.followedRecently || 0}`
                            }
                          </p>
                          <p className="text-xs mb-2" style={{ color: COLORS.textMuted }}>
                            {topFollowedPeriod === 'all' ? 'followers' : 'new'}
                          </p>
                          <button
                            onClick={() => user?.id && handleFollowUser(user.id)}
                            className="px-3 py-1 rounded-lg text-xs font-semibold"
                            style={{
                              backgroundColor: followingIds?.has?.(user?.id) ? COLORS.surfaceLight : COLORS.primary + '20',
                              color: followingIds?.has?.(user?.id) ? COLORS.textMuted : COLORS.primary
                            }}
                          >
                            {followingIds?.has?.(user?.id) ? 'Following' : 'Follow'}
                          </button>
                        </div>
                      </div>
                    ))}
                </div>
                )}

                {/* Suggested For You Section */}
                {(suggestedFriends || []).length > 0 && (
                  <div className="mt-6">
                    <p className="text-xs font-semibold mb-3" style={{ color: COLORS.textMuted }}>SUGGESTED FOR YOU</p>
                    <div className="space-y-2">
                      {(suggestedFriends || []).slice(0, 4).filter(s => s && s.id).map(suggested => (
                        <div
                          key={suggested.id}
                          className="p-3 rounded-xl flex items-center gap-3"
                          style={{ backgroundColor: COLORS.surface }}
                        >
                          <div
                            className="w-10 h-10 rounded-full flex items-center justify-center text-lg font-bold"
                            style={{ backgroundColor: COLORS.primary + '30', color: COLORS.primary }}
                          >
                            {suggested.avatar || suggested.name?.[0]?.toUpperCase() || 'U'}
                          </div>
                          <div className="flex-1 min-w-0">
                            <p className="font-semibold text-sm truncate" style={{ color: COLORS.text }}>{suggested.name || 'User'}</p>
                            <p className="text-xs" style={{ color: COLORS.textMuted }}>{suggested.followers || 0} followers</p>
                          </div>
                          <button
                            onClick={() => suggested?.id && handleFollowUser(suggested.id)}
                            className="px-3 py-1.5 rounded-lg text-xs font-semibold"
                            style={{
                              backgroundColor: followingIds?.has?.(suggested?.id) ? COLORS.surfaceLight : COLORS.primary,
                              color: followingIds?.has?.(suggested?.id) ? COLORS.textMuted : COLORS.text
                            }}
                          >
                            {followingIds?.has?.(suggested?.id) ? 'Following' : 'Follow'}
                          </button>
                        </div>
                      ))}
                    </div>
                  </div>
                )}
              </>
            )}

            {/* CHALLENGES TAB */}
            {friendsTab === 'challenges' && (
              <>
                {/* Active Challenges */}
                <p className="text-xs font-semibold mb-3" style={{ color: COLORS.textMuted }}>YOUR CHALLENGES</p>
                <div className="space-y-4 mb-6">
                  {challenges.filter(c => c.joined).map(challenge => (
                    <div key={challenge.id} className="p-4 rounded-xl" style={{ backgroundColor: COLORS.surface }}>
                      <div className="flex items-center justify-between mb-3">
                        <div>
                          <div className="flex items-center gap-2">
                            <Trophy size={18} color={COLORS.warning} />
                            <h5 className="font-bold" style={{ color: COLORS.text }}>{challenge.name}</h5>
                          </div>
                          <p className="text-xs" style={{ color: COLORS.textMuted }}>{challenge.description}</p>
                        </div>
                        <div className="text-right">
                          <p className="text-xs" style={{ color: COLORS.textMuted }}>Ends</p>
                          <p className="text-sm font-semibold" style={{ color: COLORS.text }}>{challenge.endDate}</p>
                        </div>
                      </div>
                      
                      {/* Leaderboard */}
                      <div className="space-y-2">
                        {challenge.participants.slice(0, 4).map((participant, index) => (
                          <div 
                            key={participant.id}
                            className="flex items-center justify-between p-2 rounded-lg"
                            style={{ 
                              backgroundColor: participant.id === 'you' ? COLORS.primary + '20' : COLORS.surfaceLight 
                            }}
                          >
                            <div className="flex items-center gap-2">
                              <div 
                                className="w-6 h-6 rounded-full flex items-center justify-center text-xs font-bold"
                                style={{ 
                                  backgroundColor: index === 0 ? '#FFD700' : index === 1 ? '#C0C0C0' : index === 2 ? '#CD7F32' : COLORS.surface,
                                  color: index < 3 ? COLORS.background : COLORS.text
                                }}
                              >
                                {index + 1}
                              </div>
                              <span className="text-lg">{participant.avatar}</span>
                              <span 
                                className="text-sm font-medium"
                                style={{ color: participant.id === 'you' ? COLORS.primary : COLORS.text }}
                              >
                                {participant.name}
                              </span>
                            </div>
                            <span className="font-bold" style={{ color: COLORS.text }}>
                              {challenge.type === 'volume' ? `${(participant.score / 1000).toFixed(1)}k` : participant.score}
                              {challenge.type === 'workouts' && ' workouts'}
                              {challenge.type === 'streak' && ' days'}
                              {challenge.type === 'volume' && ' kg'}
                            </span>
                          </div>
                        ))}
                      </div>
                    </div>
                  ))}
                </div>

                {/* Available Challenges */}
                <p className="text-xs font-semibold mb-3" style={{ color: COLORS.textMuted }}>JOIN A CHALLENGE</p>
                <div className="space-y-3">
                  {challenges.filter(c => !c.joined).map(challenge => (
                    <div key={challenge.id} className="p-4 rounded-xl" style={{ backgroundColor: COLORS.surface }}>
                      <div className="flex items-center justify-between">
                        <div>
                          <div className="flex items-center gap-2">
                            <Trophy size={16} color={COLORS.textMuted} />
                            <h5 className="font-semibold" style={{ color: COLORS.text }}>{challenge.name}</h5>
                          </div>
                          <p className="text-xs" style={{ color: COLORS.textMuted }}>{challenge.description}</p>
                          <p className="text-xs mt-1" style={{ color: COLORS.textSecondary }}>
                            {challenge.participants.length} friends participating
                          </p>
                        </div>
                        <button 
                          className="px-4 py-2 rounded-xl text-sm font-semibold"
                          style={{ backgroundColor: COLORS.primary, color: COLORS.text }}
                        >
                          Join
                        </button>
                      </div>
                    </div>
                  ))}
                </div>

                {/* Create Challenge */}
                <button 
                  onClick={() => setShowCreateChallenge(true)}
                  className="w-full mt-4 p-4 rounded-xl flex items-center justify-center gap-2"
                  style={{ backgroundColor: COLORS.surfaceLight, border: `1px dashed ${COLORS.textMuted}` }}
                >
                  <Plus size={18} color={COLORS.textMuted} />
                  <span style={{ color: COLORS.textMuted }}>Create New Challenge</span>
                </button>
              </>
            )}
          </div>
        )}

        {/* Share Modal */}
        {showShareModal && (
          <div className="fixed inset-0 z-50 flex items-center justify-center p-4" style={{ backgroundColor: 'rgba(0,0,0,0.2)' }}>
            <div className="w-full max-w-sm rounded-2xl p-6" style={{ backgroundColor: COLORS.surface }}>
              <div className="flex items-center justify-between mb-4">
                <h3 className="text-xl font-bold" style={{ color: COLORS.text }}>Share Your Progress</h3>
                <button onClick={() => setShowShareModal(false)} className="p-2 rounded-full" style={{ backgroundColor: COLORS.surfaceLight }}>
                  <X size={20} color={COLORS.textMuted} />
                </button>
              </div>
              
              {/* Preview Card */}
              <div className="p-4 rounded-xl mb-4" style={{ backgroundColor: COLORS.background }}>
                <div className="flex items-center gap-3 mb-3">
                  <div className="w-12 h-12 rounded-full flex items-center justify-center text-2xl" style={{ backgroundColor: COLORS.primary + '20' }}>
                    
                  </div>
                  <div>
                    <p className="font-bold" style={{ color: COLORS.text }}>{userData.firstName ? `${userData.firstName}'s` : 'My'} Fitness Journey</p>
                    <p className="text-xs" style={{ color: COLORS.textMuted }}>
                      {streaks.weeklyWorkouts.weeksCompleted} week streak  {overviewStats.totalWorkouts} workouts
                    </p>
                  </div>
                </div>
                <div className="grid grid-cols-3 gap-2 text-center">
                  <div className="p-2 rounded-lg" style={{ backgroundColor: COLORS.surface }}>
                    <p className="font-bold flex items-center justify-center gap-1" style={{ color: COLORS.warning }}>
                      <Flame size={16} /> {streaks.weeklyWorkouts.weeksCompleted}
                    </p>
                    <p className="text-xs" style={{ color: COLORS.textMuted }}>week streak</p>
                  </div>
                  <div className="p-2 rounded-lg" style={{ backgroundColor: COLORS.surface }}>
                    <p className="font-bold" style={{ color: COLORS.primary }}>{overviewStats.totalWorkouts}</p>
                    <p className="text-xs" style={{ color: COLORS.textMuted }}>workouts</p>
                  </div>
                  <div className="p-2 rounded-lg" style={{ backgroundColor: COLORS.surface }}>
                    <p className="font-bold" style={{ color: COLORS.success }}>{personalRecords.length}</p>
                    <p className="text-xs" style={{ color: COLORS.textMuted }}>PRs</p>
                  </div>
                </div>
              </div>
              
              {/* Share Options */}
              <div className="space-y-2 mb-4">
                <button className="w-full p-3 rounded-xl flex items-center gap-3" style={{ backgroundColor: COLORS.surfaceLight }}>
                  <div className="w-10 h-10 rounded-full flex items-center justify-center" style={{ backgroundColor: '#25D366' }}>
                    <span className="text-lg"></span>
                  </div>
                  <span className="font-medium" style={{ color: COLORS.text }}>Share to Messages</span>
                </button>
                <button className="w-full p-3 rounded-xl flex items-center gap-3" style={{ backgroundColor: COLORS.surfaceLight }}>
                  <div className="w-10 h-10 rounded-full flex items-center justify-center" style={{ backgroundColor: '#1DA1F2' }}>
                    <span className="text-lg"></span>
                  </div>
                  <span className="font-medium" style={{ color: COLORS.text }}>Share to Twitter</span>
                </button>
                <button className="w-full p-3 rounded-xl flex items-center gap-3" style={{ backgroundColor: COLORS.surfaceLight }}>
                  <div className="w-10 h-10 rounded-full flex items-center justify-center" style={{ backgroundColor: '#E4405F' }}>
                    <span className="text-lg"></span>
                  </div>
                  <span className="font-medium" style={{ color: COLORS.text }}>Share to Instagram</span>
                </button>
                <button className="w-full p-3 rounded-xl flex items-center gap-3" style={{ backgroundColor: COLORS.surfaceLight }}>
                  <div className="w-10 h-10 rounded-full flex items-center justify-center" style={{ backgroundColor: COLORS.primary }}>
                    <Share2 size={18} color={COLORS.text} />
                  </div>
                  <span className="font-medium" style={{ color: COLORS.text }}>Copy Link</span>
                </button>
              </div>
              
              <button 
                onClick={() => setShowShareModal(false)}
                className="w-full py-3 rounded-xl font-semibold"
                style={{ backgroundColor: COLORS.surfaceLight, color: COLORS.textMuted }}
              >
                Cancel
              </button>
            </div>
          </div>
        )}

        {/* Create Challenge Modal */}
        {showCreateChallenge && (
          <div className="fixed inset-0 z-50 flex flex-col" style={{ backgroundColor: COLORS.background }}>
            <div className="p-4 border-b flex items-center gap-3" style={{ borderColor: COLORS.surfaceLight }}>
              <button onClick={() => { setShowCreateChallenge(false); setNewChallenge({ name: '', type: 'workouts', duration: 7, invitedFriends: [] }); }}>
                <X size={24} color={COLORS.text} />
              </button>
              <h3 className="text-lg font-bold" style={{ color: COLORS.text }}>Create Challenge</h3>
            </div>
            
            <div className="flex-1 overflow-auto p-4">
              {/* Challenge Name */}
              <div className="mb-6">
                <label className="text-sm mb-2 block font-semibold" style={{ color: COLORS.text }}>Challenge Name</label>
                <input
                  type="text"
                  value={newChallenge.name}
                  onChange={e => setNewChallenge(prev => ({...prev, name: e.target.value}))}
                  placeholder="e.g. January Grind, Push-up Masters"
                  className="w-full p-4 rounded-xl"
                  style={{ backgroundColor: COLORS.surface, color: COLORS.text, border: `2px solid ${COLORS.surfaceLight}` }}
                  maxLength={30}
                />
              </div>
              
              {/* Challenge Type */}
              <div className="mb-6">
                <label className="text-sm mb-2 block font-semibold" style={{ color: COLORS.text }}>Challenge Type</label>
                <div className="grid grid-cols-2 gap-2">
                  {[
                    { id: 'workouts', label: 'Most Workouts', icon: 'dumbbell', desc: 'Complete the most workouts' },
                    { id: 'streak', label: 'Longest Streak', icon: 'flame', desc: 'Maintain the longest streak' },
                    { id: 'volume', label: 'Total Volume', icon: 'dumbbell', desc: 'Lift the most total weight' },
                    { id: 'reps', label: 'Total Reps', icon: 'refresh-cw', desc: 'Complete the most reps' },
                    { id: 'calories', label: 'Calories Burned', icon: 'flame', desc: 'Burn the most calories' },
                    { id: 'custom', label: 'Custom Goal', icon: 'target', desc: 'Set your own metric' },
                  ].map(type => (
                    <button
                      key={type.id}
                      onClick={() => setNewChallenge(prev => ({...prev, type: type.id}))}
                      className="p-3 rounded-xl text-left"
                      style={{ 
                        backgroundColor: newChallenge.type === type.id ? COLORS.primary + '20' : COLORS.surface,
                        border: `2px solid ${newChallenge.type === type.id ? COLORS.primary : COLORS.surfaceLight}`
                      }}
                    >
                      <div className="flex items-center gap-2 mb-1">
                        <IconMap name={type.icon} size={18} color={newChallenge.type === type.id ? COLORS.primary : COLORS.textMuted} />
                        <span className="font-semibold text-sm" style={{ color: newChallenge.type === type.id ? COLORS.primary : COLORS.text }}>{type.label}</span>
                      </div>
                      <p className="text-xs" style={{ color: COLORS.textMuted }}>{type.desc}</p>
                    </button>
                  ))}
                </div>
              </div>
              
              {/* Duration */}
              <div className="mb-6">
                <label className="text-sm mb-2 block font-semibold" style={{ color: COLORS.text }}>Duration</label>
                <div className="flex gap-2">
                  {[
                    { days: 7, label: '1 Week' },
                    { days: 14, label: '2 Weeks' },
                    { days: 30, label: '1 Month' },
                    { days: 90, label: '3 Months' },
                  ].map(duration => (
                    <button
                      key={duration.days}
                      onClick={() => setNewChallenge(prev => ({...prev, duration: duration.days}))}
                      className="flex-1 p-3 rounded-xl text-center"
                      style={{ 
                        backgroundColor: newChallenge.duration === duration.days ? COLORS.primary + '20' : COLORS.surface,
                        border: `2px solid ${newChallenge.duration === duration.days ? COLORS.primary : COLORS.surfaceLight}`
                      }}
                    >
                      <span className="text-sm font-semibold" style={{ color: newChallenge.duration === duration.days ? COLORS.primary : COLORS.text }}>
                        {duration.label}
                      </span>
                    </button>
                  ))}
                </div>
              </div>
              
              {/* Invite Friends */}
              <div className="mb-6">
                <label className="text-sm mb-2 block font-semibold" style={{ color: COLORS.text }}>Invite Friends</label>
                {friends.length === 0 ? (
                  <div className="p-6 rounded-xl text-center" style={{ backgroundColor: COLORS.surface }}>
                    <Users size={32} color={COLORS.textMuted} className="mx-auto mb-3" style={{ opacity: 0.5 }} />
                    <p className="font-semibold mb-1" style={{ color: COLORS.text }}>No friends yet</p>
                    <p className="text-sm mb-4" style={{ color: COLORS.textMuted }}>
                      Follow some people to challenge them to competitions
                    </p>
                    <button
                      onClick={() => {
                        setShowCreateChallenge(false);
                        setNewChallenge({ name: '', type: 'workouts', duration: 7, invitedFriends: [] });
                        setFriendsTab('discover');
                      }}
                      className="px-4 py-2 rounded-xl font-semibold"
                      style={{ backgroundColor: COLORS.primary, color: COLORS.text }}
                    >
                      Find People to Follow
                    </button>
                  </div>
                ) : (
                  <>
                    <div className="space-y-2">
                      {friends.map(friend => (
                        <div
                          key={friend.id}
                          onClick={(e) => {
                            e.preventDefault();
                            e.stopPropagation();
                            setNewChallenge(prev => ({
                              ...prev,
                              invitedFriends: prev.invitedFriends.includes(friend.id)
                                ? prev.invitedFriends.filter(id => id !== friend.id)
                                : [...prev.invitedFriends, friend.id]
                            }));
                          }}
                          className="w-full p-3 rounded-xl flex items-center justify-between cursor-pointer"
                          style={{
                            backgroundColor: newChallenge.invitedFriends.includes(friend.id) ? COLORS.primary + '20' : COLORS.surface,
                            border: `2px solid ${newChallenge.invitedFriends.includes(friend.id) ? COLORS.primary : 'transparent'}`
                          }}
                        >
                          <div className="flex items-center gap-3">
                            <span className="text-2xl">{friend.avatar}</span>
                            <div className="text-left">
                              <p className="font-semibold" style={{ color: COLORS.text }}>{friend.name}</p>
                              <p className="text-xs" style={{ color: COLORS.textMuted }}>@{friend.username}</p>
                            </div>
                          </div>
                          <div
                            className="w-6 h-6 rounded-full flex items-center justify-center"
                            style={{
                              backgroundColor: newChallenge.invitedFriends.includes(friend.id) ? COLORS.primary : COLORS.surfaceLight
                            }}
                          >
                            {newChallenge.invitedFriends.includes(friend.id) && <Check size={14} color={COLORS.text} />}
                          </div>
                        </div>
                      ))}
                    </div>
                    {newChallenge.invitedFriends.length > 0 && (
                      <p className="text-xs mt-2" style={{ color: COLORS.primary }}>
                        {newChallenge.invitedFriends.length} friend{newChallenge.invitedFriends.length > 1 ? 's' : ''} selected
                      </p>
                    )}
                  </>
                )}
              </div>
              
              {/* Preview */}
              {newChallenge.name && (
                <div className="p-4 rounded-xl mb-4" style={{ backgroundColor: COLORS.surface }}>
                  <p className="text-xs mb-2" style={{ color: COLORS.textMuted }}>PREVIEW</p>
                  <div className="flex items-center gap-2 mb-2">
                    <Trophy size={18} color={COLORS.warning} />
                    <h5 className="font-bold" style={{ color: COLORS.text }}>{newChallenge.name}</h5>
                  </div>
                  <p className="text-sm" style={{ color: COLORS.textSecondary }}>
                    {newChallenge.type === 'workouts' && 'Complete the most workouts'}
                    {newChallenge.type === 'streak' && 'Maintain the longest streak'}
                    {newChallenge.type === 'volume' && 'Lift the most total weight'}
                    {newChallenge.type === 'reps' && 'Complete the most reps'}
                    {newChallenge.type === 'calories' && 'Burn the most calories'}
                    {newChallenge.type === 'custom' && 'Custom challenge goal'}
                  </p>
                  <p className="text-xs mt-1" style={{ color: COLORS.textMuted }}>
                    {newChallenge.duration} days  {newChallenge.invitedFriends.length + 1} participants
                  </p>
                </div>
              )}
            </div>
            
            <div className="p-4 border-t" style={{ borderColor: COLORS.surfaceLight }}>
              <button 
                onClick={() => {
                  if (newChallenge.name && newChallenge.invitedFriends.length > 0) {
                    const endDate = new Date();
                    endDate.setDate(endDate.getDate() + newChallenge.duration);
                    const newChallengeObj = {
                      id: Date.now(),
                      name: newChallenge.name,
                      description: newChallenge.type === 'workouts' ? 'Most workouts completed' :
                                   newChallenge.type === 'streak' ? 'Longest active streak' :
                                   newChallenge.type === 'volume' ? 'Most total weight lifted' :
                                   newChallenge.type === 'reps' ? 'Most total reps' :
                                   newChallenge.type === 'calories' ? 'Most calories burned' : 'Custom goal',
                      type: newChallenge.type,
                      endDate: endDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric' }),
                      participants: [
                        { id: 'you', name: 'You', avatar: null, score: 0 },
                        ...newChallenge.invitedFriends.map(friendId => {
                          const friend = friends.find(f => f.id === friendId);
                          return { id: friendId, name: friend.name, avatar: friend.avatar, score: 0 };
                        })
                      ],
                      yourRank: 1,
                      joined: true,
                      createdBy: 'You'
                    };
                    setChallenges(prev => [...prev, newChallengeObj]);
                    setNewChallenge({ name: '', type: 'workouts', duration: 7, invitedFriends: [] });
                    setShowCreateChallenge(false);
                  }
                }}
                disabled={!newChallenge.name || newChallenge.invitedFriends.length === 0}
                className="w-full py-4 rounded-xl font-semibold"
                style={{ 
                  backgroundColor: (newChallenge.name && newChallenge.invitedFriends.length > 0) ? COLORS.primary : COLORS.surfaceLight, 
                  color: (newChallenge.name && newChallenge.invitedFriends.length > 0) ? COLORS.text : COLORS.textMuted 
                }}
              >
                Create & Send Invites
              </button>
              {(!newChallenge.name || newChallenge.invitedFriends.length === 0) && (
                <p className="text-xs text-center mt-2" style={{ color: COLORS.textMuted }}>
                  {!newChallenge.name ? 'Add a challenge name' : 'Invite at least 1 friend'}
                </p>
              )}
            </div>
          </div>
        )}

        {/* Edit Profile Modal */}
        {showEditProfile && (
          <EditProfileModal
            userData={userData}
            setUserData={setUserData}
            COLORS={COLORS}
            onClose={() => setShowEditProfile(false)}
            user={user}
            updateProfile={updateProfile}
          />
        )}

        {/* Exercise Info Modal */}
        {showExerciseInfo && (
          <ExerciseInfoModal
            COLORS={COLORS}
            exerciseName={showExerciseInfo}
            onClose={() => showExerciseInfoWithScroll(null)}
          />
        )}

        {/* Units Modal */}
        {showUnitsModal && (
          <div className="fixed inset-0 z-50 flex items-center justify-center p-4" style={{ backgroundColor: 'rgba(0,0,0,0.2)' }}>
            <div className="w-full max-w-sm rounded-2xl" style={{ backgroundColor: COLORS.surface }}>
              <div className="p-4 border-b flex items-center gap-3" style={{ borderColor: COLORS.surfaceLight }}>
                <button onClick={() => setShowUnitsModal(false)}><X size={24} color={COLORS.text} /></button>
                <h3 className="text-lg font-bold" style={{ color: COLORS.text }}>Units</h3>
              </div>
              <div className="p-4">
                <p className="text-sm mb-4" style={{ color: COLORS.textMuted }}>Choose your preferred measurement units</p>
                <div className="space-y-2">
                  {[
                    { id: 'metric', label: 'Metric', desc: 'Kilograms, centimeters' },
                    { id: 'imperial', label: 'Imperial', desc: 'Pounds, inches' },
                  ].map(unit => (
                    <button
                      key={unit.id}
                      onClick={() => setSettings(prev => ({ ...prev, units: unit.id }))}
                      className="w-full p-4 rounded-xl flex items-center justify-between"
                      style={{
                        backgroundColor: settings.units === unit.id ? COLORS.primary + '20' : COLORS.surfaceLight,
                        border: `2px solid ${settings.units === unit.id ? COLORS.primary : 'transparent'}`
                      }}
                    >
                      <div className="text-left">
                        <p className="font-semibold" style={{ color: COLORS.text }}>{unit.label}</p>
                        <p className="text-xs" style={{ color: COLORS.textMuted }}>{unit.desc}</p>
                      </div>
                      {settings.units === unit.id && <Check size={20} color={COLORS.primary} />}
                    </button>
                  ))}
                </div>
              </div>
              <div className="p-4 border-t" style={{ borderColor: COLORS.surfaceLight }}>
                <button
                  onClick={() => setShowUnitsModal(false)}
                  className="w-full py-3 rounded-xl font-semibold"
                  style={{ backgroundColor: COLORS.primary, color: COLORS.text }}
                >
                  Done
                </button>
              </div>
            </div>
          </div>
        )}

        {/* Notifications Modal */}
        {showNotificationsModal && (
          <div className="fixed inset-0 z-50 flex flex-col" style={{ backgroundColor: COLORS.background }}>
            <div className="p-4 border-b flex items-center gap-3" style={{ borderColor: COLORS.surfaceLight }}>
              <button onClick={() => setShowNotificationsModal(false)}><X size={24} color={COLORS.text} /></button>
              <h3 className="text-lg font-bold" style={{ color: COLORS.text }}>Notifications</h3>
            </div>
            <div className="flex-1 overflow-auto p-4">
              <p className="text-sm mb-4" style={{ color: COLORS.textMuted }}>Choose which notifications you want to receive</p>
              <div className="space-y-3">
                {[
                  { id: 'workoutReminders', label: 'Workout Reminders', desc: 'Get reminded when it\'s time to train' },
                  { id: 'progressUpdates', label: 'Progress Updates', desc: 'Weekly summaries and milestone alerts' },
                  { id: 'socialActivity', label: 'Social Activity', desc: 'Friend requests, likes, and comments' },
                  { id: 'weeklyReport', label: 'Weekly Report', desc: 'Detailed weekly performance report' },
                ].map(notif => (
                  <div
                    key={notif.id}
                    className="p-4 rounded-xl flex items-center justify-between"
                    style={{ backgroundColor: COLORS.surface }}
                  >
                    <div>
                      <p className="font-semibold" style={{ color: COLORS.text }}>{notif.label}</p>
                      <p className="text-xs" style={{ color: COLORS.textMuted }}>{notif.desc}</p>
                    </div>
                    <button
                      onClick={() => setSettings(prev => ({
                        ...prev,
                        notifications: { ...prev.notifications, [notif.id]: !prev.notifications[notif.id] }
                      }))}
                      className="w-12 h-7 rounded-full p-0.5 transition-colors"
                      style={{ backgroundColor: settings.notifications[notif.id] ? COLORS.success : COLORS.surfaceLight }}
                    >
                      <div
                        className="w-6 h-6 rounded-full transition-transform"
                        style={{
                          backgroundColor: COLORS.text,
                          transform: settings.notifications[notif.id] ? 'translateX(20px)' : 'translateX(0)'
                        }}
                      />
                    </button>
                  </div>
                ))}
              </div>
            </div>
            <div className="p-4 border-t" style={{ borderColor: COLORS.surfaceLight }}>
              <button
                onClick={() => setShowNotificationsModal(false)}
                className="w-full py-3 rounded-xl font-semibold"
                style={{ backgroundColor: COLORS.primary, color: COLORS.text }}
              >
                Done
              </button>
            </div>
          </div>
        )}

        {/* Privacy Modal */}
        {showPrivacyModal && (
          <div className="fixed inset-0 z-50 flex flex-col" style={{ backgroundColor: COLORS.background }}>
            <div className="p-4 border-b flex items-center gap-3" style={{ borderColor: COLORS.surfaceLight }}>
              <button onClick={() => setShowPrivacyModal(false)}><X size={24} color={COLORS.text} /></button>
              <h3 className="text-lg font-bold" style={{ color: COLORS.text }}>Privacy & Social</h3>
            </div>
            <div className="flex-1 overflow-auto p-4">
              <p className="text-sm mb-4" style={{ color: COLORS.textMuted }}>Control who can see your profile and activity</p>
              <div className="space-y-3">
                {[
                  { id: 'profileVisible', label: 'Public Profile', desc: 'Allow others to find and view your profile' },
                  { id: 'showActivity', label: 'Show Activity', desc: 'Share your workouts in the activity feed' },
                  { id: 'showProgress', label: 'Show Progress', desc: 'Display weight and body stats to friends' },
                  { id: 'publicPRs', label: 'Share PRs', desc: 'Let friends view your personal records' },
                  { id: 'publicWorkouts', label: 'Share Workouts', desc: 'Let friends view your completed workouts' },
                ].map(privacy => (
                  <div
                    key={privacy.id}
                    className="p-4 rounded-xl flex items-center justify-between"
                    style={{ backgroundColor: COLORS.surface }}
                  >
                    <div>
                      <p className="font-semibold" style={{ color: COLORS.text }}>{privacy.label}</p>
                      <p className="text-xs" style={{ color: COLORS.textMuted }}>{privacy.desc}</p>
                    </div>
                    <button
                      onClick={async () => {
                        const newValue = !settings.privacy[privacy.id];
                        setSettings(prev => ({
                          ...prev,
                          privacy: { ...prev.privacy, [privacy.id]: newValue }
                        }));
                        // Save to database for PRs and workouts privacy
                        if (user?.id && (privacy.id === 'publicPRs' || privacy.id === 'publicWorkouts')) {
                          const dbKey = privacy.id === 'publicPRs' ? 'public_prs' : 'public_workouts';
                          await profileService.updateSettings(user.id, { [dbKey]: newValue });
                        }
                      }}
                      className="w-12 h-7 rounded-full p-0.5 transition-colors"
                      style={{ backgroundColor: settings.privacy[privacy.id] ? COLORS.success : COLORS.surfaceLight }}
                    >
                      <div
                        className="w-6 h-6 rounded-full transition-transform"
                        style={{
                          backgroundColor: COLORS.text,
                          transform: settings.privacy[privacy.id] ? 'translateX(20px)' : 'translateX(0)'
                        }}
                      />
                    </button>
                  </div>
                ))}
              </div>

              {/* Tagging Privacy Section */}
              <h4 className="font-semibold mt-6 mb-3" style={{ color: COLORS.text }}>Tagging & Mentions</h4>
              <div className="p-4 rounded-xl" style={{ backgroundColor: COLORS.surface }}>
                <div className="mb-3">
                  <p className="font-semibold mb-1" style={{ color: COLORS.text }}>Who can tag you in comments?</p>
                  <p className="text-xs" style={{ color: COLORS.textMuted }}>Control who can @mention you</p>
                </div>
                <div className="space-y-2">
                  {[
                    { id: 'everyone', label: 'Everyone', desc: 'Any user can tag you' },
                    { id: 'followers', label: 'People you follow', desc: 'Only users you follow can tag you' },
                    { id: 'none', label: 'No one', desc: 'Disable tagging completely' },
                  ].map(option => (
                    <button
                      key={option.id}
                      onClick={() => {
                        setSettings(prev => ({
                          ...prev,
                          privacy: { ...prev.privacy, allowTagsFrom: option.id }
                        }));
                      }}
                      className="w-full p-3 rounded-lg flex items-center gap-3 text-left"
                      style={{
                        backgroundColor: settings.privacy.allowTagsFrom === option.id ? COLORS.primary + '15' : COLORS.surfaceLight,
                        border: settings.privacy.allowTagsFrom === option.id ? `1px solid ${COLORS.primary}` : '1px solid transparent'
                      }}
                    >
                      <div
                        className="w-5 h-5 rounded-full flex items-center justify-center"
                        style={{
                          backgroundColor: settings.privacy.allowTagsFrom === option.id ? COLORS.primary : COLORS.surfaceLight,
                          border: settings.privacy.allowTagsFrom === option.id ? 'none' : `2px solid ${COLORS.textMuted}`
                        }}
                      >
                        {settings.privacy.allowTagsFrom === option.id && <Check size={12} color={COLORS.text} />}
                      </div>
                      <div className="flex-1">
                        <p className="font-semibold text-sm" style={{ color: COLORS.text }}>{option.label}</p>
                        <p className="text-xs" style={{ color: COLORS.textMuted }}>{option.desc}</p>
                      </div>
                    </button>
                  ))}
                </div>
              </div>

              {/* Followers / Subscribers Section */}
              <h4 className="font-semibold mt-6 mb-3" style={{ color: COLORS.text }}>Profile Visibility</h4>
              <div
                className="p-4 rounded-xl"
                style={{ backgroundColor: COLORS.surface }}
              >
                <div className="flex items-center justify-between">
                  <p className="font-semibold" style={{ color: COLORS.text }}>Public Profile</p>
                  <div className="flex items-center gap-2">
                    <span className="text-xs font-medium" style={{ color: settings.social.allowSubscribers ? COLORS.textMuted : COLORS.text }}>
                      Private
                    </span>
                    <button
                      onClick={async () => {
                        const newValue = !settings.social.allowSubscribers;
                        setSettings(prev => ({
                          ...prev,
                          social: { ...prev.social, allowSubscribers: newValue }
                        }));
                        // Save to database using AuthContext updateProfile (keeps profile in sync)
                        if (user?.id) {
                          try {
                            const { error } = await updateProfile({ allow_subscribers: newValue });
                            if (error) {
                              // Revert on error
                              console.warn('Settings update error:', error?.message);
                              setSettings(prev => ({
                                ...prev,
                                social: { ...prev.social, allowSubscribers: !newValue }
                              }));
                            }
                          } catch (err) {
                            console.warn('Settings update failed:', err?.message || err);
                            // Revert on error
                            setSettings(prev => ({
                              ...prev,
                              social: { ...prev.social, allowSubscribers: !newValue }
                            }));
                          }
                        }
                      }}
                      className="w-12 h-7 rounded-full p-0.5 transition-colors"
                      style={{ backgroundColor: settings.social.allowSubscribers ? COLORS.success : COLORS.surfaceLight }}
                    >
                      <div
                        className="w-6 h-6 rounded-full transition-transform"
                        style={{
                          backgroundColor: COLORS.text,
                          transform: settings.social.allowSubscribers ? 'translateX(20px)' : 'translateX(0)'
                        }}
                      />
                    </button>
                    <span className="text-xs font-medium" style={{ color: settings.social.allowSubscribers ? COLORS.text : COLORS.textMuted }}>
                      Public
                    </span>
                  </div>
                </div>

                {/* Clear explanation of current state */}
                <div className="mt-3 p-3 rounded-lg" style={{ backgroundColor: settings.social.allowSubscribers ? COLORS.success + '20' : COLORS.surfaceLight }}>
                  {settings.social.allowSubscribers ? (
                    <div>
                      <p className="text-sm font-semibold" style={{ color: COLORS.success }}>
                         PUBLIC - Anyone can see your progress
                      </p>
                      <p className="text-xs mt-1" style={{ color: COLORS.textMuted }}>
                        Anyone can subscribe to you without approval. They'll see your workouts and achievements.
                      </p>
                    </div>
                  ) : (
                    <div>
                      <p className="text-sm font-semibold" style={{ color: COLORS.text }}>
                         PRIVATE - Only friends can see your progress
                      </p>
                      <p className="text-xs mt-1" style={{ color: COLORS.textMuted }}>
                        People must send a friend request and be approved to see your activity.
                      </p>
                    </div>
                  )}
                </div>
              </div>

              <div className="mt-4 p-4 rounded-xl" style={{ backgroundColor: COLORS.primary + '10' }}>
                <p className="text-sm" style={{ color: COLORS.primary }}>
                  Your workout data is always private and encrypted. These settings only control what others can see.
                </p>
              </div>
            </div>
            <div className="p-4 border-t" style={{ borderColor: COLORS.surfaceLight }}>
              <button
                onClick={() => setShowPrivacyModal(false)}
                className="w-full py-3 rounded-xl font-semibold"
                style={{ backgroundColor: COLORS.primary, color: COLORS.text }}
              >
                Done
              </button>
            </div>
          </div>
        )}

        {/* Tracking Preferences Modal */}
        {showTrackingModal && (
          <div className="fixed inset-0 z-50 flex flex-col" style={{ backgroundColor: COLORS.background }}>
            <div className="p-4 border-b flex items-center gap-3" style={{ borderColor: COLORS.surfaceLight }}>
              <button onClick={() => setShowTrackingModal(false)}><X size={24} color={COLORS.text} /></button>
              <h3 className="text-lg font-bold" style={{ color: COLORS.text }}>Tracking Preferences</h3>
            </div>
            <div className="flex-1 overflow-auto p-4">
              <p className="text-sm mb-4" style={{ color: COLORS.textMuted }}>Choose what you want to track. Disabled items won't appear in your dashboard or count towards streaks.</p>
              <div className="space-y-3">
                {[
                  { id: 'calories', label: 'Calories', desc: 'Track daily calorie intake', icon: Flame, color: COLORS.warning },
                  { id: 'macros', label: 'Macros', desc: 'Track protein, carbs, and fats', icon: Apple, color: COLORS.protein },
                  { id: 'water', label: 'Water', desc: 'Track daily water intake', icon: Droplets, color: COLORS.water },
                  { id: 'sleep', label: 'Sleep', desc: 'Track sleep duration and quality', icon: Moon, color: COLORS.sleep },
                  { id: 'supplements', label: 'Supplements', desc: 'Track daily supplement intake', icon: Zap, color: COLORS.supplements },
                ].map(tracking => (
                  <div
                    key={tracking.id}
                    className="p-4 rounded-xl flex items-center justify-between"
                    style={{ backgroundColor: COLORS.surface }}
                  >
                    <div className="flex items-center gap-3">
                      <div className="w-10 h-10 rounded-lg flex items-center justify-center" style={{ backgroundColor: tracking.color + '20' }}>
                        <tracking.icon size={20} color={tracking.color} />
                      </div>
                      <div>
                        <p className="font-semibold" style={{ color: COLORS.text }}>{tracking.label}</p>
                        <p className="text-xs" style={{ color: COLORS.textMuted }}>{tracking.desc}</p>
                      </div>
                    </div>
                    <button
                      onClick={() => setSettings(prev => ({
                        ...prev,
                        tracking: { ...prev.tracking, [tracking.id]: !prev.tracking[tracking.id] }
                      }))}
                      className="w-12 h-7 rounded-full p-0.5 transition-colors"
                      style={{ backgroundColor: settings.tracking[tracking.id] ? COLORS.success : COLORS.surfaceLight }}
                    >
                      <div
                        className="w-6 h-6 rounded-full transition-transform"
                        style={{
                          backgroundColor: COLORS.text,
                          transform: settings.tracking[tracking.id] ? 'translateX(20px)' : 'translateX(0)'
                        }}
                      />
                    </button>
                  </div>
                ))}
              </div>
              <div className="mt-4 p-4 rounded-xl" style={{ backgroundColor: COLORS.warning + '10' }}>
                <p className="text-sm" style={{ color: COLORS.warning }}>
                  Workouts are always tracked. Disabling a category will hide it from your home screen and exclude it from streak calculations.
                </p>
              </div>
            </div>
            <div className="p-4 border-t" style={{ borderColor: COLORS.surfaceLight }}>
              <button
                onClick={() => setShowTrackingModal(false)}
                className="w-full py-3 rounded-xl font-semibold"
                style={{ backgroundColor: COLORS.primary, color: COLORS.text }}
              >
                Done
              </button>
            </div>
          </div>
        )}

        {/* Account Modal */}
        {showAccountModal && (
          <div className="fixed inset-0 z-50 flex flex-col" style={{ backgroundColor: COLORS.background }}>
            <div className="p-4 border-b flex items-center gap-3" style={{ borderColor: COLORS.surfaceLight }}>
              <button onClick={() => setShowAccountModal(false)}><X size={24} color={COLORS.text} /></button>
              <h3 className="text-lg font-bold" style={{ color: COLORS.text }}>Account</h3>
            </div>
            <div className="flex-1 overflow-auto p-4">
              <div className="space-y-3">
                <div className="p-4 rounded-xl" style={{ backgroundColor: COLORS.surface }}>
                  <p className="text-xs mb-1" style={{ color: COLORS.textMuted }}>Email</p>
                  <p className="font-semibold" style={{ color: COLORS.text }}>{userData.email || 'user@example.com'}</p>
                </div>
                <div className="p-4 rounded-xl" style={{ backgroundColor: COLORS.surface }}>
                  <p className="text-xs mb-1" style={{ color: COLORS.textMuted }}>Username</p>
                  <p className="font-semibold" style={{ color: COLORS.text }}>@{userData.username || 'username'}</p>
                </div>
                <button className="w-full p-4 rounded-xl flex items-center justify-between" style={{ backgroundColor: COLORS.surface }}>
                  <span style={{ color: COLORS.text }}>Change Password</span>
                  <ChevronRight size={18} color={COLORS.textMuted} />
                </button>
                <button className="w-full p-4 rounded-xl flex items-center justify-between" style={{ backgroundColor: COLORS.surface }}>
                  <span style={{ color: COLORS.text }}>Export My Data</span>
                  <ChevronRight size={18} color={COLORS.textMuted} />
                </button>
              </div>
              <div className="mt-6 pt-6 border-t" style={{ borderColor: COLORS.surfaceLight }}>
                <h4 className="font-semibold mb-3" style={{ color: COLORS.error }}>Danger Zone</h4>
                <button className="w-full p-4 rounded-xl mb-2" style={{ backgroundColor: COLORS.error + '15' }}>
                  <span style={{ color: COLORS.error }}>Deactivate Account</span>
                </button>
                <button className="w-full p-4 rounded-xl" style={{ backgroundColor: COLORS.error + '15' }}>
                  <span style={{ color: COLORS.error }}>Delete Account</span>
                </button>
              </div>
            </div>
            <div className="p-4 border-t" style={{ borderColor: COLORS.surfaceLight }}>
              <button
                onClick={() => setShowAccountModal(false)}
                className="w-full py-3 rounded-xl font-semibold"
                style={{ backgroundColor: COLORS.primary, color: COLORS.text }}
              >
                Done
              </button>
            </div>
          </div>
        )}

        {/* Goal Editor Modal - Multi-step */}
        {showGoalEditor && (() => {
          const goalData = pendingGoalData || {
            goal: userData.goal,
            currentWeight: userData.currentWeight || '',
            goalWeight: userData.goalWeight || '',
            programWeeks: userData.programWeeks || 16,
          };
          const selectedGoalInfo = GOAL_INFO[goalData.goal];
          const currentW = parseFloat(goalData.currentWeight) || 0;
          const goalW = parseFloat(goalData.goalWeight) || 0;
          const diff = goalW - currentW;
          const weeklyChange = currentW && goalW ? (diff / goalData.programWeeks) : 0;

          const getWeightWarning = () => {
            if (!currentW || !goalW) return null;
            const absWeekly = Math.abs(weeklyChange);
            const goalInfo = GOAL_INFO[goalData.goal];
            if (goalInfo?.weightDirection === 'lose' || goalData.goal === 'lose_fat') {
              if (diff > 0) return { type: 'error', msg: 'For fat loss, goal weight should be lower than current.' };
              if (absWeekly > 1) return { type: 'error', msg: `Losing ${absWeekly.toFixed(1)}kg/week is too aggressive.` };
            } else if (goalInfo?.weightDirection === 'gain' || goalData.goal === 'build_muscle' || goalData.goal === 'bulk') {
              if (diff < 0) return { type: 'error', msg: 'For muscle building, goal weight should be higher than current.' };
              if (absWeekly > 0.5) return { type: 'error', msg: `Gaining ${absWeekly.toFixed(1)}kg/week may lead to excess fat.` };
            }
            return null;
          };
          const warning = getWeightWarning();

          const applyGoalChange = async () => {
            setGoalChangeSaving(true);
            goalChangeInProgressRef.current = true; // Prevent profile sync from overwriting during save
            try {
              // Calculate new nutrition targets
              const nutritionTargets = generateNutritionTargets({
                weight: currentW,
                height: profile?.height || 175,
                age: profile?.age || 25,
                gender: profile?.gender || 'other',
                goal: goalData.goal,
                workoutsPerWeek: userData.daysPerWeek || 4,
                goalWeight: goalW,
              });

              // Update user data
              setUserData(prev => ({
                ...prev,
                goal: goalData.goal,
                currentWeight: goalData.currentWeight,
                goalWeight: goalData.goalWeight,
                programWeeks: goalData.programWeeks,
              }));

              // Update nutrition goals
              setNutritionGoals({
                calories: nutritionTargets.calories,
                protein: nutritionTargets.protein,
                carbs: nutritionTargets.carbs,
                fats: nutritionTargets.fat,
                water: nutritionTargets.water,
                tdee: nutritionTargets.tdee,
                weeklyWeightChange: nutritionTargets.weeklyWeightChange,
              });

              // Save to database if logged in
              if (user?.id) {
                try {
                  console.log('Saving goal change:', { goal: goalData.goal, current_weight: currentW, goal_weight: goalW, program_weeks: goalData.programWeeks });
                  const goalsResult = await updateGoals({
                    goal: goalData.goal,
                    current_weight: currentW,
                    goal_weight: goalW,
                    program_weeks: goalData.programWeeks,
                  });
                  if (goalsResult?.error) {
                    console.error('Failed to save goal:', goalsResult.error);
                    alert('Failed to save goal changes. Please try again.');
                    return;
                  }
                  await nutritionService.updateNutritionGoals(user.id, {
                    calories: nutritionTargets.calories,
                    protein: nutritionTargets.protein,
                    carbs: nutritionTargets.carbs,
                    fats: nutritionTargets.fat,
                    water: nutritionTargets.water,
                  });
                  // Log the new weight
                  await profileService.logWeight(user.id, currentW);
                } catch (err) {
                  console.error('Error saving goal change:', err);
                  alert('Failed to save goal changes. Please try again.');
                  return;
                }
              } else {
                console.warn('User not logged in, goal changes will not persist');
              }

              // Reset and close
              const scrollTop = profileTabScrollRef.current?.scrollTop;
              setPendingGoalData(null);
              setGoalChangeStep(1);
              setShowGoalEditor(false);
              requestAnimationFrame(() => {
                if (profileTabScrollRef.current && scrollTop !== undefined) {
                  profileTabScrollRef.current.scrollTop = scrollTop;
                }
              });
            } finally {
              setGoalChangeSaving(false);
              // Allow profile sync to resume after a short delay to ensure state is settled
              setTimeout(() => {
                goalChangeInProgressRef.current = false;
              }, 500);
            }
          };

          return (
            <div className="fixed inset-0 z-50 flex flex-col" style={{ backgroundColor: COLORS.background }}>
              <div className="p-4 border-b flex items-center gap-3" style={{ borderColor: COLORS.surfaceLight }}>
                <button onClick={() => {
                  if (goalChangeStep > 1) {
                    setGoalChangeStep(goalChangeStep - 1);
                  } else {
                    setPendingGoalData(null);
                    setGoalChangeStep(1);
                    setShowGoalEditor(false);
                  }
                }}>
                  {goalChangeStep > 1 ? <ChevronLeft size={24} color={COLORS.text} /> : <X size={24} color={COLORS.text} />}
                </button>
                <h3 className="text-lg font-bold" style={{ color: COLORS.text }}>
                  {goalChangeStep === 1 ? 'Change Goal' : goalChangeStep === 2 ? 'Set Weight Targets' : 'Review Changes'}
                </h3>
                <div className="flex-1" />
                <p className="text-xs" style={{ color: COLORS.textMuted }}>Step {goalChangeStep}/3</p>
              </div>
              <div className="flex-1 overflow-auto p-4">
                {/* Step 1: Select Goal */}
                {goalChangeStep === 1 && (
                  <>
                    <p className="text-sm mb-4" style={{ color: COLORS.textMuted }}>Select your new fitness goal</p>
                    <div className="space-y-3">
                      {Object.entries(GOAL_INFO).map(([id, goal]) => (
                        <button
                          key={id}
                          onClick={() => {
                            setPendingGoalData({ ...goalData, goal: id });
                            setGoalChangeStep(2);
                          }}
                          className="w-full p-4 rounded-xl flex items-center gap-4 text-left"
                          style={{
                            backgroundColor: goalData.goal === id ? COLORS.primary + '20' : COLORS.surface,
                            border: `2px solid ${goalData.goal === id ? COLORS.primary : COLORS.surfaceLight}`
                          }}
                        >
                          <div className="w-12 h-12 rounded-xl flex items-center justify-center" style={{ backgroundColor: goalData.goal === id ? COLORS.primary + '30' : COLORS.surfaceLight }}>
                            <IconMap name={goal.icon} size={28} color={goalData.goal === id ? COLORS.primary : COLORS.textMuted} />
                          </div>
                          <div className="flex-1">
                            <p className="font-semibold" style={{ color: goalData.goal === id ? COLORS.primary : COLORS.text }}>
                              {goal.title}
                            </p>
                            <p className="text-xs" style={{ color: COLORS.textMuted }}>{goal.overview}</p>
                          </div>
                          {goalData.goal === id && <Check size={20} color={COLORS.primary} />}
                        </button>
                      ))}
                    </div>
                  </>
                )}

                {/* Step 2: Weight Targets */}
                {goalChangeStep === 2 && (
                  <>
                    <div className="p-4 rounded-xl mb-4" style={{ backgroundColor: COLORS.primary + '15' }}>
                      <div className="flex items-center gap-3">
                        <div className="w-10 h-10 rounded-lg flex items-center justify-center" style={{ backgroundColor: COLORS.primary + '30' }}>
                          <IconMap name={selectedGoalInfo?.icon || 'target'} size={20} color={COLORS.primary} />
                        </div>
                        <div>
                          <p className="font-semibold" style={{ color: COLORS.primary }}>{selectedGoalInfo?.title}</p>
                          <p className="text-xs" style={{ color: COLORS.textMuted }}>{selectedGoalInfo?.overview}</p>
                        </div>
                      </div>
                    </div>

                    <p className="text-sm mb-4" style={{ color: COLORS.textMuted }}>
                      Set your weight targets to personalize your nutrition and training
                    </p>

                    <div className="space-y-4">
                      <div>
                        <label className="text-sm mb-2 block" style={{ color: COLORS.textMuted }}>Current Weight (kg)</label>
                        <input
                          type="text"
                          inputMode="decimal"
                          key="current-weight-input"
                          defaultValue={goalData.currentWeight || ''}
                          onBlur={e => {
                            const val = e.target.value.replace(/[^0-9.]/g, '');
                            setPendingGoalData(prev => ({ ...(prev || goalData), currentWeight: val }));
                          }}
                          onChange={e => {
                            // Update on change but don't trigger re-render
                            const val = e.target.value.replace(/[^0-9.]/g, '');
                            if (pendingGoalData) {
                              pendingGoalData.currentWeight = val;
                            }
                          }}
                          placeholder="e.g. 80"
                          className="w-full p-4 rounded-xl text-xl font-bold text-center"
                          style={{ backgroundColor: COLORS.surface, color: COLORS.text, border: `2px solid ${COLORS.surfaceLight}` }}
                        />
                      </div>

                      <div>
                        <label className="text-sm mb-2 block" style={{ color: COLORS.textMuted }}>Goal Weight (kg)</label>
                        <input
                          type="text"
                          inputMode="decimal"
                          key="goal-weight-input"
                          defaultValue={goalData.goalWeight || ''}
                          onBlur={e => {
                            const val = e.target.value.replace(/[^0-9.]/g, '');
                            setPendingGoalData(prev => ({ ...(prev || goalData), goalWeight: val }));
                          }}
                          onChange={e => {
                            // Update on change but don't trigger re-render
                            const val = e.target.value.replace(/[^0-9.]/g, '');
                            if (pendingGoalData) {
                              pendingGoalData.goalWeight = val;
                            }
                          }}
                          placeholder="e.g. 75"
                          className="w-full p-4 rounded-xl text-xl font-bold text-center"
                          style={{ backgroundColor: COLORS.surface, color: COLORS.text, border: `2px solid ${COLORS.surfaceLight}` }}
                        />
                      </div>

                      <div>
                        <label className="text-sm mb-2 block" style={{ color: COLORS.textMuted }}>Program Duration</label>
                        <div className="flex gap-2">
                          {[12, 16, 20, 24].map(w => (
                            <button
                              key={w}
                              onClick={() => setPendingGoalData(prev => ({ ...prev, programWeeks: w }))}
                              className="flex-1 py-3 rounded-xl text-sm font-semibold"
                              style={{
                                backgroundColor: goalData.programWeeks === w ? COLORS.primary : COLORS.surface,
                                color: goalData.programWeeks === w ? COLORS.text : COLORS.textMuted,
                                border: `2px solid ${goalData.programWeeks === w ? COLORS.primary : COLORS.surfaceLight}`
                              }}
                            >
                              {w} weeks
                            </button>
                          ))}
                        </div>
                      </div>

                      {warning && (
                        <div className="p-3 rounded-xl" style={{ backgroundColor: warning.type === 'error' ? COLORS.error + '20' : COLORS.warning + '20' }}>
                          <p className="text-sm" style={{ color: warning.type === 'error' ? COLORS.error : COLORS.warning }}>{warning.msg}</p>
                        </div>
                      )}

                      {currentW > 0 && goalW > 0 && !warning && (
                        <div className="p-3 rounded-xl" style={{ backgroundColor: COLORS.success + '20' }}>
                          <p className="text-sm" style={{ color: COLORS.success }}>
                            {weeklyChange > 0 ? '+' : ''}{weeklyChange.toFixed(2)}kg/week over {goalData.programWeeks} weeks
                          </p>
                        </div>
                      )}
                    </div>
                  </>
                )}

                {/* Step 3: Review */}
                {goalChangeStep === 3 && (() => {
                  const nutritionPreview = generateNutritionTargets({
                    weight: currentW,
                    height: profile?.height || 175,
                    age: profile?.age || 25,
                    gender: profile?.gender || 'other',
                    goal: goalData.goal,
                    workoutsPerWeek: userData.daysPerWeek || 4,
                    goalWeight: goalW,
                  });

                  return (
                    <>
                      <p className="text-sm mb-4" style={{ color: COLORS.textMuted }}>Review your new personalized plan</p>

                      <div className="space-y-4">
                        {/* Goal Summary */}
                        <div className="p-4 rounded-xl" style={{ backgroundColor: COLORS.surface }}>
                          <p className="text-xs font-semibold mb-2" style={{ color: COLORS.textMuted }}>NEW GOAL</p>
                          <div className="flex items-center gap-3">
                            <div className="w-10 h-10 rounded-lg flex items-center justify-center" style={{ backgroundColor: COLORS.primary + '30' }}>
                              <IconMap name={selectedGoalInfo?.icon || 'target'} size={20} color={COLORS.primary} />
                            </div>
                            <p className="font-semibold" style={{ color: COLORS.text }}>{selectedGoalInfo?.title}</p>
                          </div>
                        </div>

                        {/* Weight Plan */}
                        <div className="p-4 rounded-xl" style={{ backgroundColor: COLORS.surface }}>
                          <p className="text-xs font-semibold mb-3" style={{ color: COLORS.textMuted }}>WEIGHT PLAN</p>
                          <div className="flex items-center justify-between mb-2">
                            <span style={{ color: COLORS.textSecondary }}>Current</span>
                            <span className="font-bold" style={{ color: COLORS.text }}>{currentW}kg</span>
                          </div>
                          <div className="flex items-center justify-between mb-2">
                            <span style={{ color: COLORS.textSecondary }}>Target</span>
                            <span className="font-bold" style={{ color: COLORS.primary }}>{goalW}kg</span>
                          </div>
                          <div className="flex items-center justify-between">
                            <span style={{ color: COLORS.textSecondary }}>Timeline</span>
                            <span className="font-bold" style={{ color: COLORS.text }}>{goalData.programWeeks} weeks</span>
                          </div>
                        </div>

                        {/* Nutrition Targets */}
                        <div className="p-4 rounded-xl" style={{ backgroundColor: COLORS.surface }}>
                          <p className="text-xs font-semibold mb-3" style={{ color: COLORS.textMuted }}>DAILY NUTRITION TARGETS</p>
                          <div className="grid grid-cols-2 gap-3">
                            <div className="p-3 rounded-lg text-center" style={{ backgroundColor: COLORS.surfaceLight }}>
                              <p className="text-xl font-bold" style={{ color: COLORS.primary }}>{nutritionPreview.calories}</p>
                              <p className="text-xs" style={{ color: COLORS.textMuted }}>Calories</p>
                            </div>
                            <div className="p-3 rounded-lg text-center" style={{ backgroundColor: COLORS.surfaceLight }}>
                              <p className="text-xl font-bold" style={{ color: COLORS.protein }}>{nutritionPreview.protein}g</p>
                              <p className="text-xs" style={{ color: COLORS.textMuted }}>Protein</p>
                            </div>
                            <div className="p-3 rounded-lg text-center" style={{ backgroundColor: COLORS.surfaceLight }}>
                              <p className="text-xl font-bold" style={{ color: COLORS.warning }}>{nutritionPreview.carbs}g</p>
                              <p className="text-xs" style={{ color: COLORS.textMuted }}>Carbs</p>
                            </div>
                            <div className="p-3 rounded-lg text-center" style={{ backgroundColor: COLORS.surfaceLight }}>
                              <p className="text-xl font-bold" style={{ color: COLORS.sleep }}>{nutritionPreview.fat}g</p>
                              <p className="text-xs" style={{ color: COLORS.textMuted }}>Fats</p>
                            </div>
                          </div>
                          <div className="mt-3 p-3 rounded-lg text-center" style={{ backgroundColor: COLORS.surfaceLight }}>
                            <p className="text-xl font-bold" style={{ color: COLORS.accent }}>{(nutritionPreview.water / 1000).toFixed(1)}L</p>
                            <p className="text-xs" style={{ color: COLORS.textMuted }}>Daily Water</p>
                          </div>
                        </div>

                        {/* Expected Progress */}
                        <div className="p-4 rounded-xl" style={{ backgroundColor: COLORS.success + '15' }}>
                          <p className="text-sm font-semibold" style={{ color: COLORS.success }}>
                            Expected: {weeklyChange > 0 ? '+' : ''}{weeklyChange.toFixed(2)}kg/week
                          </p>
                          <p className="text-xs mt-1" style={{ color: COLORS.textMuted }}>
                            Based on {nutritionPreview.calories} daily calories vs {nutritionPreview.tdee} TDEE
                          </p>
                        </div>
                      </div>
                    </>
                  );
                })()}
              </div>

              {/* Bottom Actions */}
              <div className="p-4 border-t" style={{ borderColor: COLORS.surfaceLight }}>
                {goalChangeStep === 2 && (
                  <button
                    onClick={() => setGoalChangeStep(3)}
                    disabled={!currentW || !goalW || warning?.type === 'error'}
                    className="w-full py-4 rounded-xl font-semibold"
                    style={{
                      backgroundColor: (!currentW || !goalW || warning?.type === 'error') ? COLORS.surfaceLight : COLORS.primary,
                      color: (!currentW || !goalW || warning?.type === 'error') ? COLORS.textMuted : COLORS.text
                    }}
                  >
                    Review Changes
                  </button>
                )}
                {goalChangeStep === 3 && (
                  <button
                    onClick={applyGoalChange}
                    disabled={goalChangeSaving}
                    className="w-full py-4 rounded-xl font-semibold flex items-center justify-center gap-2"
                    style={{ backgroundColor: COLORS.success, color: '#fff', opacity: goalChangeSaving ? 0.7 : 1 }}
                  >
                    {goalChangeSaving ? (
                      <>
                        <div className="w-5 h-5 border-2 border-white border-t-transparent rounded-full animate-spin" />
                        Saving...
                      </>
                    ) : (
                      'Apply New Goal'
                    )}
                  </button>
                )}
              </div>
            </div>
          );
        })()}

        {/* Experience Level Modal */}
        {showExperienceLevelModal && (
          <div className="fixed inset-0 z-50 flex items-center justify-center p-4" style={{ backgroundColor: 'rgba(0,0,0,0.2)' }}>
            <div className="w-full max-w-sm rounded-2xl p-6" style={{ backgroundColor: COLORS.surface }}>
              <div className="flex items-center justify-between mb-4">
                <h3 className="text-lg font-bold" style={{ color: COLORS.text }}>Gym Experience Level</h3>
                <button onClick={() => setShowExperienceLevelModal(false)} className="p-1">
                  <X size={20} color={COLORS.textMuted} />
                </button>
              </div>
              <p className="text-sm mb-4" style={{ color: COLORS.textMuted }}>
                Your experience level affects workout complexity and exercise variations.
              </p>
              <div className="space-y-2">
                {Object.values(EXPERIENCE_LEVELS).map(level => (
                  <button
                    key={level.id}
                    type="button"
                    onClick={async () => {
                      const scrollTop = profileTabScrollRef.current?.scrollTop;
                      setUserData(prev => ({ ...prev, experience: level.id }));
                      setShowExperienceLevelModal(false);
                      requestAnimationFrame(() => {
                        if (profileTabScrollRef.current && scrollTop !== undefined) {
                          profileTabScrollRef.current.scrollTop = scrollTop;
                        }
                      });
                      if (user?.id) {
                        try {
                          await updateGoals({ experience: level.id });
                        } catch (err) {
                          console.warn('Error updating experience level:', err);
                        }
                      }
                    }}
                    className="w-full p-4 rounded-xl flex items-center gap-4 transition-all"
                    style={{
                      backgroundColor: userData.experience === level.id ? COLORS.primary + '20' : COLORS.surfaceLight,
                      border: `2px solid ${userData.experience === level.id ? COLORS.primary : 'transparent'}`
                    }}
                  >
                    <div className="w-10 h-10 rounded-lg flex items-center justify-center" style={{ backgroundColor: userData.experience === level.id ? COLORS.primary + '30' : COLORS.surface }}>
                      <IconMap name={level.icon} size={24} color={userData.experience === level.id ? COLORS.primary : COLORS.textMuted} />
                    </div>
                    <div className="flex-1 text-left">
                      <p className="font-semibold" style={{ color: userData.experience === level.id ? COLORS.primary : COLORS.text }}>
                        {level.label}
                      </p>
                      <p className="text-xs" style={{ color: COLORS.textMuted }}>{level.desc}</p>
                    </div>
                    {userData.experience === level.id && <Check size={20} color={COLORS.primary} />}
                  </button>
                ))}
              </div>
            </div>
          </div>
        )}

        {/* Equipment Modal */}
        {showEquipmentModal && (
          <div className="fixed inset-0 z-50 flex items-center justify-center p-4" style={{ backgroundColor: 'rgba(0,0,0,0.2)' }}>
            <div className="w-full max-w-md rounded-2xl p-6 max-h-[80vh] overflow-y-auto" style={{ backgroundColor: COLORS.surface }}>
              <div className="flex items-center justify-between mb-4">
                <h3 className="text-lg font-bold" style={{ color: COLORS.text }}>Gym Equipment</h3>
                <button onClick={() => setShowEquipmentModal(false)} className="p-1">
                  <X size={20} color={COLORS.textMuted} />
                </button>
              </div>
              <p className="text-sm mb-4" style={{ color: COLORS.textMuted }}>
                Select equipment you have access to. We'll customize your workouts accordingly.
              </p>
              <div className="space-y-2">
                {EQUIPMENT_OPTIONS.map(equip => {
                  const isSelected = userData.equipment?.includes(equip.id);
                  return (
                    <button
                      key={equip.id}
                      onClick={() => toggleProfileEquipmentWithScroll(equip.id)}
                      className="w-full p-4 rounded-xl flex items-center gap-4 transition-all"
                      style={{
                        backgroundColor: isSelected ? COLORS.primary + '20' : COLORS.surfaceLight,
                        border: `2px solid ${isSelected ? COLORS.primary : 'transparent'}`
                      }}
                    >
                      <div className="w-10 h-10 rounded-xl flex items-center justify-center" style={{ backgroundColor: isSelected ? COLORS.primary + '30' : COLORS.surface }}>
                        <IconMap name={equip.icon} size={20} color={isSelected ? COLORS.primary : COLORS.textMuted} />
                      </div>
                      <div className="flex-1 text-left">
                        <p className="font-semibold" style={{ color: isSelected ? COLORS.primary : COLORS.text }}>
                          {equip.name}
                        </p>
                        <p className="text-xs" style={{ color: COLORS.textMuted }}>{equip.desc}</p>
                      </div>
                      {isSelected && <Check size={20} color={COLORS.primary} />}
                    </button>
                  );
                })}
              </div>
              <button
                type="button"
                onClick={async () => {
                  const scrollTop = profileTabScrollRef.current?.scrollTop;
                  // Save equipment to database
                  if (user?.id && userData.equipment) {
                    try {
                      await updateGoals({ equipment: userData.equipment });
                    } catch (err) {
                      console.warn('Error saving equipment:', err);
                    }
                  }
                  setShowEquipmentModal(false);
                  requestAnimationFrame(() => {
                    if (profileTabScrollRef.current && scrollTop !== undefined) {
                      profileTabScrollRef.current.scrollTop = scrollTop;
                    }
                  });
                }}
                className="w-full mt-4 py-3 rounded-xl font-semibold"
                style={{ backgroundColor: COLORS.primary, color: COLORS.text }}
              >
                Done
              </button>
            </div>
          </div>
        )}

        {/* Program Selector Modal - Multi-Step */}
        {showProgramSelector && (
          <div className="fixed inset-0 z-50 flex items-center justify-center p-4" style={{ backgroundColor: 'rgba(0,0,0,0.2)' }}>
            <div className="w-full max-w-md rounded-2xl p-6 max-h-[85vh] overflow-y-auto" style={{ backgroundColor: COLORS.surface }}>
              {/* Header with step indicator */}
              <div className="flex items-center justify-between mb-2">
                <h3 className="text-lg font-bold" style={{ color: COLORS.text }}>
                  {programSelectorStep === 0 ? 'Choose Your Split' : programSelectorStep === 1 ? 'Select Rest Days' : 'Preview Schedule'}
                </h3>
                <button onClick={() => { setShowProgramSelector(false); setProgramSelectorStep(0); setSelectedProgramForSetup(null); }} className="p-1">
                  <X size={20} color={COLORS.textMuted} />
                </button>
              </div>

              {/* Step indicator */}
              <div className="flex gap-1 mb-4">
                {[0, 1, 2].map(step => (
                  <div key={step} className="flex-1 h-1 rounded-full" style={{ backgroundColor: step <= programSelectorStep ? COLORS.primary : COLORS.surfaceLight }} />
                ))}
              </div>

              {/* Step 0: Select Program */}
              {programSelectorStep === 0 && (
                <>
                  <p className="text-sm mb-4" style={{ color: COLORS.textMuted }}>
                    All programs will use your {userData.daysPerWeek || 4} training days. Choose a workout rotation.
                  </p>
                  <div className="space-y-2">
                    {PROGRAM_TEMPLATES.map(template => {
                      const isSelected = selectedProgramForSetup === template.id || (!selectedProgramForSetup && currentProgram.id === template.id);
                      return (
                        <button
                          key={template.id}
                          onClick={() => setSelectedProgramForSetup(template.id)}
                          className="w-full p-4 rounded-xl flex items-center gap-4 transition-all"
                          style={{
                            backgroundColor: isSelected ? COLORS.primary + '20' : COLORS.surfaceLight,
                            border: `2px solid ${isSelected ? COLORS.primary : 'transparent'}`
                          }}
                        >
                          <div className="w-10 h-10 rounded-xl flex items-center justify-center" style={{ backgroundColor: COLORS.primary + '30' }}>
                            <Dumbbell size={20} color={COLORS.primary} />
                          </div>
                          <div className="flex-1 text-left">
                            <p className="font-semibold" style={{ color: isSelected ? COLORS.primary : COLORS.text }}>
                              {template.name}
                            </p>
                            <p className="text-xs" style={{ color: COLORS.textSecondary }}>{template.desc}</p>
                            <p className="text-xs mt-1" style={{ color: COLORS.textMuted }}>
                              {template.cycle.length}-workout rotation
                            </p>
                          </div>
                          {isSelected && <Check size={20} color={COLORS.primary} />}
                        </button>
                      );
                    })}
                  </div>
                  <button
                    onClick={() => {
                      if (!selectedProgramForSetup) setSelectedProgramForSetup(currentProgram.id);
                      setProgramSelectorStep(1);
                    }}
                    className="w-full py-3 rounded-xl font-semibold mt-4"
                    style={{ backgroundColor: COLORS.primary, color: COLORS.text }}
                  >
                    Next: Select Rest Days
                  </button>
                </>
              )}

              {/* Step 1: Select Rest Days */}
              {programSelectorStep === 1 && (
                <>
                  <p className="text-sm mb-4" style={{ color: COLORS.textMuted }}>
                    Select your rest days. You'll train {userData.daysPerWeek || 4} days per week.
                  </p>
                  <div className="grid grid-cols-7 gap-2 mb-4">
                    {['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'].map((day, i) => {
                      const isRest = selectedRestDays.includes(i);
                      return (
                        <button
                          key={day}
                          onClick={() => {
                            setSelectedRestDays(prev => {
                              if (prev.includes(i)) {
                                return prev.filter(d => d !== i);
                              } else {
                                return [...prev, i];
                              }
                            });
                          }}
                          className="aspect-square rounded-lg flex flex-col items-center justify-center text-xs font-medium"
                          style={{
                            backgroundColor: isRest ? COLORS.surfaceLight : COLORS.primary + '20',
                            border: `2px solid ${isRest ? COLORS.textMuted : COLORS.primary}`,
                          }}
                        >
                          <span style={{ color: isRest ? COLORS.textMuted : COLORS.primary }}>{day}</span>
                          <span className="text-xs mt-0.5" style={{ color: isRest ? COLORS.textMuted : COLORS.primary }}>
                            {isRest ? 'Rest' : 'Train'}
                          </span>
                        </button>
                      );
                    })}
                  </div>
                  <div className="p-3 rounded-xl mb-4" style={{ backgroundColor: COLORS.surfaceLight }}>
                    <p className="text-xs" style={{ color: COLORS.textMuted }}>
                      Training days: {7 - selectedRestDays.length}  Rest days: {selectedRestDays.length}
                    </p>
                    {7 - selectedRestDays.length !== (userData.daysPerWeek || 4) && (
                      <p className="text-xs mt-1" style={{ color: COLORS.warning }}>
                        Note: This differs from your {userData.daysPerWeek || 4} days/week goal
                      </p>
                    )}
                  </div>
                  <div className="flex gap-3">
                    <button
                      onClick={() => setProgramSelectorStep(0)}
                      className="flex-1 py-3 rounded-xl font-semibold"
                      style={{ backgroundColor: COLORS.surfaceLight, color: COLORS.text }}
                    >
                      Back
                    </button>
                    <button
                      onClick={() => setProgramSelectorStep(2)}
                      className="flex-1 py-3 rounded-xl font-semibold"
                      style={{ backgroundColor: COLORS.primary, color: COLORS.text }}
                    >
                      Preview
                    </button>
                  </div>
                </>
              )}

              {/* Step 2: Preview 4-Week Schedule */}
              {programSelectorStep === 2 && (
                <>
                  <p className="text-sm mb-4" style={{ color: COLORS.textMuted }}>
                    Here's your 4-week training schedule preview:
                  </p>
                  {(() => {
                    const template = PROGRAM_TEMPLATES.find(t => t.id === selectedProgramForSetup) || PROGRAM_TEMPLATES[0];
                    const preview = generateProgramSchedule(template, 7 - selectedRestDays.length, selectedRestDays, 4);
                    const workoutColors = {
                      push: COLORS.primary,
                      pull: COLORS.accent,
                      legs_quad: COLORS.success,
                      legs_posterior: COLORS.success,
                      upper: COLORS.primary,
                      lower: COLORS.accent,
                      full_body: COLORS.primary,
                      chest: COLORS.primary,
                      back: COLORS.accent,
                      shoulders: COLORS.warning,
                      arms: COLORS.sleep,
                    };
                    const workoutLabels = {
                      push: 'Push',
                      pull: 'Pull',
                      legs_quad: 'Legs',
                      legs_posterior: 'Legs B',
                      upper: 'Upper',
                      lower: 'Lower',
                      full_body: 'Full',
                      chest: 'Chest',
                      back: 'Back',
                      shoulders: 'Shld',
                      arms: 'Arms',
                    };

                    return (
                      <div className="space-y-3 mb-4">
                        {preview.map((week, weekIdx) => (
                          <div key={weekIdx}>
                            <p className="text-xs font-semibold mb-1" style={{ color: COLORS.textMuted }}>Week {weekIdx + 1}</p>
                            <div className="grid grid-cols-7 gap-1">
                              {week.map((day, dayIdx) => (
                                <div
                                  key={dayIdx}
                                  className="aspect-square rounded-lg flex flex-col items-center justify-center"
                                  style={{
                                    backgroundColor: day.isRest ? COLORS.surfaceLight : (workoutColors[day.workout] || COLORS.primary) + '30',
                                  }}
                                >
                                  <span className="text-xs" style={{ color: COLORS.textMuted, fontSize: 8 }}>{day.day}</span>
                                  <span className="text-xs font-medium" style={{
                                    color: day.isRest ? COLORS.textMuted : (workoutColors[day.workout] || COLORS.primary),
                                    fontSize: 9
                                  }}>
                                    {day.isRest ? 'Off' : (workoutLabels[day.workout] || day.workout)}
                                  </span>
                                </div>
                              ))}
                            </div>
                          </div>
                        ))}
                      </div>
                    );
                  })()}
                  <div className="flex gap-3">
                    <button
                      onClick={() => setProgramSelectorStep(1)}
                      className="flex-1 py-3 rounded-xl font-semibold"
                      style={{ backgroundColor: COLORS.surfaceLight, color: COLORS.text }}
                    >
                      Back
                    </button>
                    <button
                      type="button"
                      onClick={() => {
                        const scrollTop = profileTabScrollRef.current?.scrollTop;
                        changeProgram(selectedProgramForSetup || currentProgram.id);
                        setShowProgramSelector(false);
                        setProgramSelectorStep(0);
                        setSelectedProgramForSetup(null);
                        requestAnimationFrame(() => {
                          if (profileTabScrollRef.current && scrollTop !== undefined) {
                            profileTabScrollRef.current.scrollTop = scrollTop;
                          }
                        });
                      }}
                      className="flex-1 py-3 rounded-xl font-semibold"
                      style={{ backgroundColor: COLORS.primary, color: COLORS.text }}
                    >
                      Start Program
                    </button>
                  </div>
                </>
              )}
            </div>
          </div>
        )}

        {/* Single Achievement Detail Modal */}
        {selectedAchievement && (
          <div className="fixed inset-0 z-50 flex items-center justify-center p-4" style={{ backgroundColor: 'rgba(0,0,0,0.2)' }} onClick={() => setSelectedAchievement(null)}>
            <div className="w-full max-w-sm rounded-2xl p-6" style={{ backgroundColor: COLORS.surface }} onClick={(e) => e.stopPropagation()}>
              <div className="text-center mb-4">
                <div
                  className="w-20 h-20 rounded-2xl mx-auto mb-3 flex items-center justify-center text-4xl"
                  style={{
                    backgroundColor: selectedAchievement.unlocked ? COLORS.primary + '20' : COLORS.surfaceLight,
                    opacity: selectedAchievement.unlocked ? 1 : 0.6
                  }}
                >
                  {selectedAchievement.icon}
                </div>
                <h3 className="text-xl font-bold" style={{ color: selectedAchievement.unlocked ? COLORS.text : COLORS.textMuted }}>
                  {selectedAchievement.name}
                </h3>
                <p className="text-sm mt-1" style={{ color: COLORS.textMuted }}>{selectedAchievement.desc}</p>
              </div>

              {selectedAchievement.unlocked ? (
                <div className="text-center mb-4">
                  <span className="inline-flex items-center gap-2 px-3 py-1 rounded-full text-sm" style={{ backgroundColor: COLORS.primary + '20', color: COLORS.primary }}>
                    <Check size={14} /> Unlocked
                  </span>
                </div>
              ) : (
                <div className="text-center mb-4">
                  <span className="inline-flex items-center gap-2 px-3 py-1 rounded-full text-sm" style={{ backgroundColor: COLORS.surfaceLight, color: COLORS.textMuted }}>
                     Locked
                  </span>
                </div>
              )}

              <button
                onClick={() => setSelectedAchievement(null)}
                className="w-full py-3 rounded-xl font-semibold"
                style={{ backgroundColor: COLORS.surfaceLight, color: COLORS.text }}
              >
                Close
              </button>
            </div>
          </div>
        )}

        {/* All Achievements Modal */}
        {showAllAchievements && (
          <div className="fixed inset-0 z-50 flex flex-col" style={{ backgroundColor: COLORS.background }}>
            <div className="p-4 border-b flex items-center gap-3" style={{ borderColor: COLORS.surfaceLight }}>
              <button onClick={() => setShowAllAchievements(false)}>
                <X size={24} color={COLORS.text} />
              </button>
              <div>
                <h3 className="text-lg font-bold" style={{ color: COLORS.text }}>All Achievements</h3>
                <p className="text-xs" style={{ color: COLORS.textMuted }}>
                  {achievements.filter(a => a.unlocked).length} of {achievements.length} unlocked
                </p>
              </div>
            </div>
            <div className="flex-1 overflow-auto p-4">
              <div className="grid grid-cols-2 gap-2">
                {achievements.map(achievement => (
                  <button
                    key={achievement.id}
                    onClick={() => { setShowAllAchievements(false); setSelectedAchievement(achievement); }}
                    className="p-4 rounded-xl flex items-center gap-3 text-left transition-transform active:scale-98"
                    style={{
                      backgroundColor: COLORS.surface,
                      opacity: achievement.unlocked ? 1 : 0.6,
                      border: achievement.unlocked ? `1px solid ${COLORS.primary}30` : 'none'
                    }}
                  >
                    <div className="w-10 h-10 rounded-lg flex items-center justify-center flex-shrink-0" style={{ backgroundColor: achievement.unlocked ? COLORS.primary + '20' : COLORS.surfaceLight }}>
                      <IconMap name={achievement.icon} size={20} color={achievement.unlocked ? COLORS.primary : COLORS.textMuted} />
                    </div>
                    <div className="flex-1 min-w-0">
                      <p className="text-sm font-medium truncate" style={{ color: achievement.unlocked ? COLORS.text : COLORS.textMuted }}>
                        {achievement.name}
                      </p>
                      <p className="text-xs truncate" style={{ color: COLORS.textMuted }}>
                        {achievement.desc}
                      </p>
                    </div>
                    {achievement.unlocked && <Check size={16} color={COLORS.primary} />}
                  </button>
                ))}
              </div>
            </div>
          </div>
        )}

        {/* Add Friend Modal */}
        {showAddFriendModal && (
          <div className="fixed inset-0 z-50 flex flex-col" style={{ backgroundColor: COLORS.background }}>
            <div className="p-4 border-b flex items-center gap-3" style={{ borderColor: COLORS.surfaceLight }}>
              <button onClick={() => { setShowAddFriendModal(false); setFriendSearchQuery(''); setSearchResults([]); setHasSearched(false); }}>
                <X size={24} color={COLORS.text} />
              </button>
              <h3 className="text-lg font-bold" style={{ color: COLORS.text }}>Find People</h3>
            </div>

            <div ref={addFriendScrollRef} className="flex-1 overflow-auto p-4">
              {/* Search */}
              <div className="relative mb-4">
                <Search size={18} color={COLORS.textMuted} className="absolute left-3 top-1/2 -translate-y-1/2" />
                <input
                  type="text"
                  placeholder="Search by username or name..."
                  autoComplete="off"
                  autoFocus
                  value={friendSearchQuery}
                  onChange={(e) => {
                    const query = e.target.value;
                    setFriendSearchQuery(query);

                    // Clear previous timeout
                    if (friendSearchTimeoutRef.current) {
                      clearTimeout(friendSearchTimeoutRef.current);
                    }

                    if (query.length < 2) {
                      // Only clear results if we had some before
                      if (searchResults.length > 0 || searchLoading || hasSearched) {
                        setSearchResults([]);
                        setSearchLoading(false);
                        setHasSearched(false);
                      }
                      return;
                    }

                    // Debounce the search - only set loading after a small delay
                    friendSearchTimeoutRef.current = setTimeout(async () => {
                      setSearchLoading(true);
                      try {
                        const { data } = await profileService.searchUsers(query, user?.id);
                        setSearchResults(data || []);
                        setHasSearched(true);
                      } catch (err) {
                        console.error('Search error:', err);
                        setSearchResults([]);
                        setHasSearched(true);
                      } finally {
                        setSearchLoading(false);
                      }
                    }, 400);
                  }}
                  className="w-full pl-10 pr-4 py-3 rounded-xl text-sm"
                  style={{ backgroundColor: COLORS.surface, color: COLORS.text, border: 'none' }}
                />
                {searchLoading && (
                  <Loader2 size={18} color={COLORS.textMuted} className="absolute right-3 top-1/2 -translate-y-1/2 animate-spin" />
                )}
              </div>

              {/* Search Results */}
              {(searchResults.length > 0 || searchLoading || hasSearched) && (
                <div className="mb-6">
                  <h4 className="font-semibold mb-3" style={{ color: COLORS.text }}>
                    {searchLoading ? 'Searching...' : searchResults.length > 0 ? `Found ${searchResults.length} users` : 'No users found'}
                  </h4>
                  {hasSearched && searchResults.length === 0 && !searchLoading && (
                    <div className="p-4 rounded-xl text-center" style={{ backgroundColor: COLORS.surface }}>
                      <p className="text-sm" style={{ color: COLORS.textMuted }}>
                        No users match your search. Try a different name or username.
                      </p>
                    </div>
                  )}
                  <div className="space-y-2">
                    {searchResults.map(person => (
                      <div
                        key={person.id}
                        className="p-4 rounded-xl"
                        style={{ backgroundColor: COLORS.surface }}
                      >
                        <div className="flex items-start justify-between">
                          <button
                            onClick={() => {
                              // Open profile modal with this user's data
                              const friendData = {
                                id: person.id,
                                name: `${person.first_name || ''} ${person.last_name || ''}`.trim() || person.username || 'User',
                                username: person.username || 'user',
                                avatar: person.avatar_url || (person.first_name ? person.first_name[0].toUpperCase() : '?'),
                                bio: person.bio,
                                followers: person.follower_count || 0,
                                workouts: person.published_workouts || 0,
                                lastActive: person.last_active || 'Unknown',
                              };
                              setShowFriendProfile(friendData);
                            }}
                            className="flex items-start gap-3 flex-1 text-left"
                          >
                            <div
                              className="w-12 h-12 rounded-full flex items-center justify-center text-xl flex-shrink-0"
                              style={{ backgroundColor: COLORS.surfaceLight }}
                            >
                              {person.avatar_url || (person.first_name ? person.first_name[0].toUpperCase() : '?')}
                            </div>
                            <div className="flex-1 min-w-0">
                              <div className="flex items-center gap-2">
                                <p className="font-semibold" style={{ color: COLORS.text }}>
                                  {person.first_name} {person.last_name}
                                </p>
                              </div>
                              <p className="text-xs" style={{ color: COLORS.textMuted }}>@{person.username || 'user'}</p>
                              {person.bio && (
                                <p className="text-xs mt-1 line-clamp-1" style={{ color: COLORS.textSecondary }}>
                                  {person.bio}
                                </p>
                              )}
                              <div className="flex items-center gap-3 mt-2">
                                <span className="text-xs" style={{ color: COLORS.textMuted }}>
                                  <span style={{ color: COLORS.text, fontWeight: 600 }}>{person.follower_count || 0}</span> followers
                                </span>
                                {person.published_workouts > 0 && (
                                  <span className="text-xs" style={{ color: COLORS.textMuted }}>
                                    <span style={{ color: COLORS.text, fontWeight: 600 }}>{person.published_workouts}</span> workouts
                                  </span>
                                )}
                              </div>
                            </div>
                          </button>
                          <button
                            onClick={async (e) => {
                              e.stopPropagation();
                              if (user?.id) {
                                const scrollTop = addFriendScrollRef.current?.scrollTop;
                                try {
                                  const isFollowing = followingIds?.has?.(person.id);
                                  if (isFollowing) {
                                    await profileService.unsubscribeFromUser(user.id, person.id);
                                    setFollowingIds(prev => {
                                      const next = new Set(prev);
                                      next.delete(person.id);
                                      return next;
                                    });
                                  } else {
                                    await profileService.subscribeToUser(user.id, person.id);
                                    setFollowingIds(prev => new Set([...prev, person.id]));
                                  }
                                } catch (err) {
                                  console.warn('Follow action failed:', err?.message || err);
                                }
                                requestAnimationFrame(() => {
                                  if (addFriendScrollRef.current && scrollTop !== undefined) {
                                    addFriendScrollRef.current.scrollTop = scrollTop;
                                  }
                                });
                              }
                            }}
                            className="px-4 py-2 rounded-xl text-sm font-semibold flex-shrink-0"
                            style={{
                              backgroundColor: followingIds?.has?.(person.id) ? COLORS.surfaceLight : COLORS.primary,
                              color: followingIds?.has?.(person.id) ? COLORS.textMuted : COLORS.text
                            }}
                          >
                            {followingIds?.has?.(person.id) ? 'Following' : 'Follow'}
                          </button>
                        </div>
                      </div>
                    ))}
                  </div>
                </div>
              )}

              {/* Only show these sections if not actively searching */}
              {!searchLoading && searchResults.length === 0 && (
                <>
                  {/* Invite Friends */}
                  <button
                    className="w-full p-4 rounded-xl mb-6 flex items-center gap-3"
                    style={{ backgroundColor: COLORS.primary }}
                  >
                    <div className="w-10 h-10 rounded-full flex items-center justify-center" style={{ backgroundColor: COLORS.text + '20' }}>
                      <Share2 size={20} color={COLORS.text} />
                    </div>
                    <div className="text-left">
                      <p className="font-semibold" style={{ color: COLORS.text }}>Invite Friends</p>
                      <p className="text-xs" style={{ color: COLORS.text + 'CC' }}>Share your invite link</p>
                    </div>
                  </button>

                  {/* Suggested Friends */}
                  {(suggestedFriends || []).length > 0 && (
                    <>
                      <h4 className="font-semibold mb-3" style={{ color: COLORS.text }}>Suggested for You</h4>
                      <div className="space-y-2 mb-6">
                        {(suggestedFriends || []).filter(f => f && f.id).map(friend => (
                          <div
                            key={friend.id}
                            className="p-4 rounded-xl flex items-center justify-between"
                            style={{ backgroundColor: COLORS.surface }}
                          >
                            <div className="flex items-center gap-3">
                              <div
                                className="w-12 h-12 rounded-full flex items-center justify-center text-xl font-bold"
                                style={{ backgroundColor: COLORS.primary + '30', color: COLORS.primary }}
                              >
                                {friend.avatar || friend.name?.[0]?.toUpperCase() || 'U'}
                              </div>
                              <div>
                                <p className="font-semibold" style={{ color: COLORS.text }}>{friend.name || 'User'}</p>
                                <p className="text-xs" style={{ color: COLORS.textMuted }}>{friend.followers || 0} followers</p>
                              </div>
                            </div>
                            <button
                              onClick={() => friend?.id && handleFollowUser(friend.id)}
                              className="px-4 py-2 rounded-xl text-sm font-semibold"
                              style={{
                                backgroundColor: followingIds?.has?.(friend?.id) ? COLORS.surfaceLight : COLORS.primary,
                                color: followingIds?.has?.(friend?.id) ? COLORS.textMuted : COLORS.text
                              }}
                            >
                              {followingIds?.has?.(friend?.id) ? 'Following' : 'Follow'}
                            </button>
                          </div>
                        ))}
                      </div>
                    </>
                  )}

                  {/* From Contacts */}
                  <h4 className="font-semibold mb-3" style={{ color: COLORS.text }}>Find from Contacts</h4>
                  <button
                    type="button"
                    onClick={(e) => {
                      e.preventDefault();
                      e.stopPropagation();
                      // Contact sync is not available in web version
                      alert('Contact sync is available in the mobile app');
                    }}
                    className="w-full p-4 rounded-xl flex items-center gap-3"
                    style={{ backgroundColor: COLORS.surface }}
                  >
                    <div className="w-10 h-10 rounded-full flex items-center justify-center" style={{ backgroundColor: COLORS.surfaceLight }}>
                      <Users size={20} color={COLORS.textMuted} />
                    </div>
                    <div className="text-left">
                      <p className="font-medium" style={{ color: COLORS.text }}>Sync Contacts</p>
                      <p className="text-xs" style={{ color: COLORS.textMuted }}>Find friends already on the app</p>
                    </div>
                  </button>
                </>
              )}
            </div>
          </div>
        )}

        {/* Friend Profile Modal */}
        {showFriendProfile && !showFriendStreakCalendar && (
          <div className="fixed inset-0 z-50 flex flex-col" style={{ backgroundColor: COLORS.background }}>
            <div className="p-4 border-b flex items-center gap-3" style={{ borderColor: COLORS.surfaceLight }}>
              <button onClick={() => setShowFriendProfile(null)}>
                <X size={24} color={COLORS.text} />
              </button>
              <h3 className="text-lg font-bold" style={{ color: COLORS.text }}>Profile</h3>
            </div>

            <div className="flex-1 overflow-auto p-4">
              {/* Profile Header */}
              <div className="text-center mb-6">
                <div
                  className="w-24 h-24 rounded-full mx-auto mb-3 flex items-center justify-center text-5xl"
                  style={{ backgroundColor: COLORS.surface }}
                >
                  {typeof showFriendProfile.avatar === 'string' && showFriendProfile.avatar.length === 1
                    ? showFriendProfile.avatar
                    : showFriendProfile.name?.[0]?.toUpperCase() || '?'}
                </div>
                <h4 className="text-xl font-bold" style={{ color: COLORS.text }}>{showFriendProfile.name || 'User'}</h4>
                <p className="text-sm" style={{ color: COLORS.textMuted }}>@{showFriendProfile.username || 'user'}</p>
                {showFriendProfile.bio && (
                  <p className="text-sm mt-2" style={{ color: COLORS.textSecondary }}>{showFriendProfile.bio}</p>
                )}
                <div className="flex items-center justify-center gap-2 mt-2 flex-wrap">
                  {showFriendProfile.isOnline ? (
                    <span className="text-xs px-2 py-1 rounded-full" style={{ backgroundColor: COLORS.success + '20', color: COLORS.success }}>
                      Online now
                    </span>
                  ) : showFriendProfile.lastActive ? (
                    <span className="text-xs" style={{ color: COLORS.textMuted }}>
                      Active {showFriendProfile.lastActive}
                    </span>
                  ) : null}
                  {friendFollowStatus.followsYou && (
                    <span className="text-xs px-2 py-1 rounded-full" style={{ backgroundColor: COLORS.success + '20', color: COLORS.success }}>
                      Follows you
                    </span>
                  )}
                </div>

                {/* Follow Button */}
                <button
                  onClick={async () => {
                    if (friendFollowStatus.isFollowing) {
                      await socialService.unfollowUser(user?.id, showFriendProfile.id);
                      setFriendFollowStatus(prev => ({ ...prev, isFollowing: false }));
                      setFriends(prev => prev.filter(f => f.id !== showFriendProfile.id));
                    } else {
                      await socialService.followUser(user?.id, showFriendProfile.id);
                      setFriendFollowStatus(prev => ({ ...prev, isFollowing: true }));
                    }
                  }}
                  className="mt-4 px-6 py-2 rounded-xl font-semibold text-sm"
                  style={{
                    backgroundColor: friendFollowStatus.isFollowing ? COLORS.surface : COLORS.primary,
                    color: friendFollowStatus.isFollowing ? COLORS.textMuted : COLORS.text,
                    border: friendFollowStatus.isFollowing ? `1px solid ${COLORS.surfaceLight}` : 'none'
                  }}
                >
                  {friendFollowStatus.isFollowing ? 'Following' : 'Follow'}
                </button>
              </div>

              {/* Stats - Clickable */}
              <div className="grid grid-cols-3 gap-3 mb-6">
                <button
                  onClick={async () => {
                    // Check privacy settings first
                    const { data: userSettings } = await profileService.getUserSettings(showFriendProfile.id);
                    if (userSettings?.public_workouts === false) {
                      setFriendWorkoutsData([]);
                      setShowFriendWorkouts({ ...showFriendProfile, privacyBlocked: true });
                      return;
                    }
                    // Load friend's workouts
                    const { data } = await workoutService.getCompletedSessions(showFriendProfile.id);
                    setFriendWorkoutsData(data || []);
                    setShowFriendWorkouts(showFriendProfile);
                  }}
                  className="p-4 rounded-xl text-center relative"
                  style={{ backgroundColor: COLORS.surface }}
                >
                  <Dumbbell size={20} color={COLORS.primary} className="mx-auto mb-1" />
                  <p className="text-xl font-bold" style={{ color: COLORS.text }}>{friendStats.workouts}</p>
                  <p className="text-xs" style={{ color: COLORS.textMuted }}>Workouts</p>
                  <ChevronRight size={14} color={COLORS.textMuted} className="absolute right-2 top-1/2 -translate-y-1/2" />
                </button>
                <button
                  onClick={async () => {
                    // Check privacy settings first
                    const { data: userSettings } = await profileService.getUserSettings(showFriendProfile.id);
                    if (userSettings?.public_prs === false) {
                      setFriendPRsData([]);
                      setShowFriendPRs({ ...showFriendProfile, privacyBlocked: true });
                      return;
                    }
                    // Load friend's PRs
                    const { data } = await workoutService.getPersonalRecords(showFriendProfile.id);
                    setFriendPRsData(data || []);
                    setShowFriendPRs(showFriendProfile);
                  }}
                  className="p-4 rounded-xl text-center relative"
                  style={{ backgroundColor: COLORS.surface }}
                >
                  <Trophy size={20} color={COLORS.warning} className="mx-auto mb-1" />
                  <p className="text-xl font-bold" style={{ color: COLORS.text }}>{friendStats.prs}</p>
                  <p className="text-xs" style={{ color: COLORS.textMuted }}>PRs</p>
                  <ChevronRight size={14} color={COLORS.textMuted} className="absolute right-2 top-1/2 -translate-y-1/2" />
                </button>
                <button
                  onClick={() => setShowFriendStreakCalendar({...showFriendProfile, streak: friendStats.streak})}
                  className="p-4 rounded-xl text-center relative"
                  style={{ backgroundColor: COLORS.surface }}
                >
                  <Flame size={20} color={COLORS.error} className="mx-auto mb-1" />
                  <p className="text-xl font-bold" style={{ color: COLORS.text }}>{friendStats.streak}</p>
                  <p className="text-xs" style={{ color: COLORS.textMuted }}>Workout Streak</p>
                  <ChevronRight size={14} color={COLORS.textMuted} className="absolute right-2 top-1/2 -translate-y-1/2" />
                </button>
              </div>

              {/* Current Goal */}
              <div className="p-4 rounded-xl mb-4" style={{ backgroundColor: COLORS.surface }}>
                <h5 className="font-semibold mb-2" style={{ color: COLORS.text }}>Current Goal</h5>
                <div className="flex items-center gap-3">
                  <div
                    className="w-10 h-10 rounded-full flex items-center justify-center"
                    style={{ backgroundColor: COLORS.primary + '20' }}
                  >
                    <Target size={20} color={COLORS.primary} />
                  </div>
                  <div>
                    <p className="font-medium" style={{ color: COLORS.text }}>
                      {showFriendProfile.goal === 'build_muscle' && 'Build Muscle'}
                      {showFriendProfile.goal === 'lose_fat' && 'Lose Fat'}
                      {showFriendProfile.goal === 'strength' && 'Get Stronger'}
                      {showFriendProfile.goal === 'fitness' && 'General Fitness'}
                      {!showFriendProfile.goal && 'General Fitness'}
                    </p>
                    <p className="text-xs" style={{ color: COLORS.textMuted }}>{showFriendProfile.weeklyWorkouts || 4}x per week</p>
                  </div>
                </div>
              </div>

              {/* Head-to-Head Comparison */}
              <div className="p-4 rounded-xl mb-4" style={{ backgroundColor: COLORS.surface }}>
                <div className="flex items-center justify-between mb-3">
                  <h5 className="font-semibold" style={{ color: COLORS.text }}>Head-to-Head</h5>
                  <div className="flex gap-1">
                    {['week', 'month', 'all'].map(period => (
                      <button
                        key={period}
                        onClick={async () => {
                          setHeadToHeadPeriod(period);
                          setHeadToHeadLoading(true);
                          const result = await competitionService.getHeadToHead(user?.id, showFriendProfile.id, period);
                          if (result?.data) setHeadToHeadData(result.data);
                          setHeadToHeadLoading(false);
                        }}
                        className="px-2 py-1 rounded text-xs"
                        style={{
                          backgroundColor: headToHeadPeriod === period ? COLORS.primary : COLORS.surfaceLight,
                          color: headToHeadPeriod === period ? COLORS.text : COLORS.textMuted
                        }}
                      >
                        {period === 'week' ? '7D' : period === 'month' ? '30D' : 'All'}
                      </button>
                    ))}
                  </div>
                </div>
                {headToHeadLoading ? (
                  <div className="flex justify-center py-4">
                    <Loader2 size={24} color={COLORS.primary} className="animate-spin" />
                  </div>
                ) : headToHeadData ? (
                  <div className="space-y-3">
                    {/* Workouts comparison */}
                    <div className="flex items-center justify-between">
                      <div className="flex-1 text-right pr-3">
                        <span className="text-lg font-bold" style={{ color: headToHeadData.user.workouts >= headToHeadData.friend.workouts ? COLORS.success : COLORS.text }}>
                          {headToHeadData.user.workouts}
                        </span>
                      </div>
                      <div className="w-20 text-center">
                        <Dumbbell size={16} color={COLORS.primary} className="mx-auto" />
                        <p className="text-xs" style={{ color: COLORS.textMuted }}>Workouts</p>
                      </div>
                      <div className="flex-1 pl-3">
                        <span className="text-lg font-bold" style={{ color: headToHeadData.friend.workouts > headToHeadData.user.workouts ? COLORS.success : COLORS.text }}>
                          {headToHeadData.friend.workouts}
                        </span>
                      </div>
                    </div>
                    {/* Volume comparison */}
                    <div className="flex items-center justify-between">
                      <div className="flex-1 text-right pr-3">
                        <span className="text-lg font-bold" style={{ color: headToHeadData.user.volume >= headToHeadData.friend.volume ? COLORS.success : COLORS.text }}>
                          {(headToHeadData.user.volume / 1000).toFixed(1)}k
                        </span>
                      </div>
                      <div className="w-20 text-center">
                        <BarChart3 size={16} color={COLORS.accent} className="mx-auto" />
                        <p className="text-xs" style={{ color: COLORS.textMuted }}>Volume (kg)</p>
                      </div>
                      <div className="flex-1 pl-3">
                        <span className="text-lg font-bold" style={{ color: headToHeadData.friend.volume > headToHeadData.user.volume ? COLORS.success : COLORS.text }}>
                          {(headToHeadData.friend.volume / 1000).toFixed(1)}k
                        </span>
                      </div>
                    </div>
                    {/* PRs comparison */}
                    <div className="flex items-center justify-between">
                      <div className="flex-1 text-right pr-3">
                        <span className="text-lg font-bold" style={{ color: headToHeadData.user.prs >= headToHeadData.friend.prs ? COLORS.success : COLORS.text }}>
                          {headToHeadData.user.prs}
                        </span>
                      </div>
                      <div className="w-20 text-center">
                        <Trophy size={16} color={COLORS.warning} className="mx-auto" />
                        <p className="text-xs" style={{ color: COLORS.textMuted }}>PRs</p>
                      </div>
                      <div className="flex-1 pl-3">
                        <span className="text-lg font-bold" style={{ color: headToHeadData.friend.prs > headToHeadData.user.prs ? COLORS.success : COLORS.text }}>
                          {headToHeadData.friend.prs}
                        </span>
                      </div>
                    </div>
                    {/* Streak comparison */}
                    <div className="flex items-center justify-between">
                      <div className="flex-1 text-right pr-3">
                        <span className="text-lg font-bold" style={{ color: headToHeadData.user.streak >= headToHeadData.friend.streak ? COLORS.success : COLORS.text }}>
                          {headToHeadData.user.streak}
                        </span>
                      </div>
                      <div className="w-20 text-center">
                        <Flame size={16} color={COLORS.error} className="mx-auto" />
                        <p className="text-xs" style={{ color: COLORS.textMuted }}>Streak</p>
                      </div>
                      <div className="flex-1 pl-3">
                        <span className="text-lg font-bold" style={{ color: headToHeadData.friend.streak > headToHeadData.user.streak ? COLORS.success : COLORS.text }}>
                          {headToHeadData.friend.streak}
                        </span>
                      </div>
                    </div>
                    {/* Labels */}
                    <div className="flex items-center justify-between pt-2 border-t" style={{ borderColor: COLORS.surfaceLight }}>
                      <span className="text-xs font-medium" style={{ color: COLORS.primary }}>You</span>
                      <span className="text-xs font-medium" style={{ color: COLORS.primary }}>{showFriendProfile.name?.split(' ')[0] || 'Friend'}</span>
                    </div>
                  </div>
                ) : (
                  <button
                    onClick={async () => {
                      setHeadToHeadLoading(true);
                      const result = await competitionService.getHeadToHead(user?.id, showFriendProfile.id, headToHeadPeriod);
                      if (result?.data) setHeadToHeadData(result.data);
                      setHeadToHeadLoading(false);
                    }}
                    className="w-full py-3 rounded-lg text-sm font-medium"
                    style={{ backgroundColor: COLORS.primary + '20', color: COLORS.primary }}
                  >
                    Compare Stats
                  </button>
                )}
              </div>

              {/* Action Buttons (Nudge & Workout Buddy) */}
              <div className="flex gap-3 mb-4">
                {/* Nudge Button */}
                <button
                  onClick={async () => {
                    if (nudgeSent || nudgeSending) return;
                    setNudgeSending(true);
                    const result = await accountabilityService.sendNudge(user?.id, showFriendProfile.id);
                    setNudgeSending(false);
                    if (result.error?.message?.includes('Already nudged') || result.alreadyNudged) {
                      setCanNudge(false);
                    } else if (!result.error) {
                      setNudgeSent(true);
                      setTimeout(() => setNudgeSent(false), 3000);
                    }
                  }}
                  disabled={!canNudge || nudgeSending || nudgeSent}
                  className="flex-1 flex items-center justify-center gap-2 py-3 rounded-xl font-medium text-sm"
                  style={{
                    backgroundColor: nudgeSent ? COLORS.success + '20' : (!canNudge ? COLORS.surfaceLight : COLORS.warning + '20'),
                    color: nudgeSent ? COLORS.success : (!canNudge ? COLORS.textMuted : COLORS.warning)
                  }}
                >
                  {nudgeSending ? (
                    <Loader2 size={18} className="animate-spin" />
                  ) : nudgeSent ? (
                    <>
                      <Check size={18} />
                      <span>Nudged!</span>
                    </>
                  ) : (
                    <>
                      <Bell size={18} />
                      <span>{canNudge ? 'Nudge' : 'Nudged Today'}</span>
                    </>
                  )}
                </button>

                {/* Workout Buddy Button */}
                <button
                  onClick={async () => {
                    if (buddyRequestSent) return;
                    const result = await accountabilityService.requestBuddy(user?.id, showFriendProfile.id);
                    if (!result.error || result.alreadyExists) {
                      setBuddyRequestSent(true);
                    }
                  }}
                  disabled={buddyRequestSent || (workoutBuddy?.buddy?.id === showFriendProfile.id)}
                  className="flex-1 flex items-center justify-center gap-2 py-3 rounded-xl font-medium text-sm"
                  style={{
                    backgroundColor: buddyRequestSent || (workoutBuddy?.buddy?.id === showFriendProfile.id) ? COLORS.success + '20' : COLORS.primary + '20',
                    color: buddyRequestSent || (workoutBuddy?.buddy?.id === showFriendProfile.id) ? COLORS.success : COLORS.primary
                  }}
                >
                  <Users size={18} />
                  <span>
                    {workoutBuddy?.buddy?.id === showFriendProfile.id ? 'Workout Buddy' : buddyRequestSent ? 'Request Sent' : 'Be Buddies'}
                  </span>
                </button>
              </div>

              {/* Recent Activity */}
              <div className="p-4 rounded-xl" style={{ backgroundColor: COLORS.surface }}>
                <h5 className="font-semibold mb-3" style={{ color: COLORS.text }}>Recent Activity</h5>
                <div className="space-y-2">
                  {activityFeed.filter(a => a.friendId === showFriendProfile.id).slice(0, 3).map(activity => (
                    <div key={activity.id} className="flex items-center gap-3 p-2 rounded-lg" style={{ backgroundColor: COLORS.surfaceLight }}>
                      <div className="w-8 h-8 rounded-lg flex items-center justify-center" style={{ backgroundColor: COLORS.primary + '20' }}>
                        {activity.type === 'workout' && <Dumbbell size={16} color={COLORS.primary} />}
                        {activity.type === 'pr' && <Trophy size={16} color={COLORS.warning} />}
                        {activity.type === 'milestone' && <Star size={16} color={COLORS.accent} />}
                      </div>
                      <div className="flex-1">
                        <p className="text-sm" style={{ color: COLORS.text }}>
                          {activity.type === 'workout' && `Completed ${activity.workoutName}`}
                          {activity.type === 'pr' && `New ${activity.exercise} PR: ${activity.newWeight}kg`}
                          {activity.type === 'milestone' && `Reached ${activity.milestone}`}
                        </p>
                        <p className="text-xs" style={{ color: COLORS.textMuted }}>{activity.time}</p>
                      </div>
                    </div>
                  ))}
                </div>
              </div>
            </div>
          </div>
        )}

        {/* Friend Streak Calendar Modal */}
        {showFriendStreakCalendar && (() => {
          const friend = showFriendStreakCalendar;
          const monthNames = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
          const dayNames = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];
          const getDaysInMonth = (month, year) => new Date(year, month + 1, 0).getDate();
          const getFirstDayOfMonth = (month, year) => {
            const day = new Date(year, month, 1).getDay();
            return (day + 6) % 7; // Convert to Monday=0 based
          };
          const daysInMonth = getDaysInMonth(friendStreakMonth, friendStreakYear);
          const firstDay = getFirstDayOfMonth(friendStreakMonth, friendStreakYear);
          
          // Generate friend's workout data based on their streak
          const generateFriendWorkoutData = () => {
            const data = {};
            const streakDays = friend?.streak || friend?.stats?.streak || 0;
            const todayDate = today.getDate();
            const isCurrentMonth = friendStreakMonth === today.getMonth() && friendStreakYear === today.getFullYear();
            const maxDay = isCurrentMonth ? todayDate : daysInMonth;

            // Work backwards from today/end of month to create workout history
            for (let i = 1; i <= maxDay; i++) {
              // Calculate days from end (for streak calculation)
              const daysFromEnd = maxDay - i;
              if (daysFromEnd < streakDays) {
                // Within their streak - they worked out
                data[i] = {
                  workedOut: true,
                  workout: ['Push Day', 'Pull Day', 'Leg Day', 'Upper Body', 'Lower Body', 'Full Body'][i % 6],
                  duration: 45 + (i % 30)
                };
              } else {
                // Before their streak started - simulate random pattern
                const rand = ((i * 7) % 10) / 10; // Deterministic "random" based on day
                data[i] = {
                  workedOut: rand > 0.4,
                  workout: rand > 0.4 ? ['Push Day', 'Pull Day', 'Leg Day'][i % 3] : null,
                  duration: rand > 0.4 ? 45 + (i % 30) : 0
                };
              }
            }
            return data;
          };

          const workoutData = generateFriendWorkoutData();

          // Calculate weekly workouts from the data
          const weeklyWorkouts = Math.round((Object.values(workoutData).filter(d => d?.workedOut).length / Math.max(1, Object.keys(workoutData).length)) * 7);
          
          const calendarDays = [];
          for (let i = 0; i < firstDay; i++) calendarDays.push(null);
          for (let i = 1; i <= daysInMonth; i++) calendarDays.push(i);
          
          const isToday = (day) => day === today.getDate() && friendStreakMonth === today.getMonth() && friendStreakYear === today.getFullYear();
          const isFuture = (day) => new Date(friendStreakYear, friendStreakMonth, day) > today;
          
          const changeMonth = (delta) => {
            let newMonth = friendStreakMonth + delta;
            let newYear = friendStreakYear;
            if (newMonth > 11) { newMonth = 0; newYear++; }
            if (newMonth < 0) { newMonth = 11; newYear--; }
            setFriendStreakMonth(newMonth);
            setFriendStreakYear(newYear);
          };
          
          const workoutDays = Object.values(workoutData).filter(d => d.workedOut).length;
          const restDays = Object.values(workoutData).filter(d => !d.workedOut).length;
          const avgDuration = Math.round(Object.values(workoutData).filter(d => d.workedOut).reduce((acc, d) => acc + d.duration, 0) / workoutDays) || 0;
          
          return (
            <div className="fixed inset-0 z-50 flex flex-col" style={{ backgroundColor: COLORS.background }}>
              <div className="p-4 border-b flex items-center gap-3" style={{ borderColor: COLORS.surfaceLight }}>
                <button onClick={() => { setShowFriendStreakCalendar(null); setFriendStreakMonth(currentMonth); setFriendStreakYear(currentYear); }}>
                  <ChevronLeft size={24} color={COLORS.text} />
                </button>
                <div
                  className="w-10 h-10 rounded-full flex items-center justify-center text-xl"
                  style={{ backgroundColor: COLORS.surfaceLight }}
                >
                  {typeof friend.avatar === 'string' && friend.avatar.length === 1 ? friend.avatar : friend.name?.[0]?.toUpperCase() || '?'}
                </div>
                <div>
                  <h2 className="font-bold" style={{ color: COLORS.text }}>{(friend.name || 'User').split(' ')[0]}'s Streak</h2>
                  <p className="text-xs" style={{ color: COLORS.textMuted }}>{friend.program || friend.bio || 'Fitness enthusiast'}</p>
                </div>
              </div>
              
              <div className="flex-1 overflow-auto p-4">
                {/* Streak Banner */}
                <div className="p-4 rounded-xl mb-4 text-center" style={{ backgroundColor: COLORS.warning + '20' }}>
                  <div className="flex items-center justify-center gap-2 mb-1">
                    <Flame size={28} color={COLORS.warning} />
                    <p className="text-4xl font-bold" style={{ color: COLORS.warning }}>{friend.streak || friend.stats?.streak || 0}</p>
                  </div>
                  <p style={{ color: COLORS.textSecondary }}>day workout streak</p>
                  {(friend.streak || friend.stats?.streak || 0) >= 30 && (
                    <div className="mt-2 inline-flex items-center gap-1 px-3 py-1 rounded-full" style={{ backgroundColor: COLORS.warning + '30' }}>
                      <Trophy size={14} color={COLORS.warning} />
                      <span className="text-xs font-semibold" style={{ color: COLORS.warning }}>On fire!</span>
                    </div>
                  )}
                </div>
                
                {/* Calendar */}
                <div className="rounded-xl p-4 mb-4" style={{ backgroundColor: COLORS.surface }}>
                  <div className="flex items-center justify-between mb-4">
                    <button onClick={() => changeMonth(-1)} className="p-2 rounded-lg" style={{ backgroundColor: COLORS.surfaceLight }}>
                      <ChevronLeft size={20} color={COLORS.text} />
                    </button>
                    <h4 className="font-bold" style={{ color: COLORS.text }}>{monthNames[friendStreakMonth]} {friendStreakYear}</h4>
                    <button onClick={() => changeMonth(1)} className="p-2 rounded-lg" style={{ backgroundColor: COLORS.surfaceLight }}>
                      <ChevronRight size={20} color={COLORS.text} />
                    </button>
                  </div>
                  
                  <div className="grid grid-cols-7 gap-1 mb-2">
                    {dayNames.map(day => (
                      <div key={day} className="text-center text-xs font-semibold py-1" style={{ color: COLORS.textMuted }}>{day}</div>
                    ))}
                  </div>
                  
                  <div className="grid grid-cols-7 gap-1">
                    {calendarDays.map((day, i) => {
                      const dayData = workoutData[day];
                      const future = day && isFuture(day);
                      const todayDate = isToday(day);
                      
                      return (
                        <div 
                          key={i}
                          className="rounded-lg flex flex-col items-center justify-center p-2 relative"
                          style={{ 
                            backgroundColor: !day ? 'transparent' : future ? 'transparent' : dayData?.workedOut ? COLORS.success + '30' : COLORS.surfaceLight,
                            border: todayDate ? `2px solid ${COLORS.warning}` : '2px solid transparent',
                            opacity: !day ? 0 : future ? 0.4 : 1,
                            minHeight: '50px'
                          }}
                        >
                          <span className="text-xs font-medium" style={{ color: COLORS.text }}>{day || ''}</span>
                          {day && !future && dayData && (
                            <div className="mt-1">
                              {dayData.workedOut ? (
                                <Dumbbell size={12} color={COLORS.success} />
                              ) : (
                                <span className="text-xs" style={{ color: COLORS.textMuted }}>Rest</span>
                              )}
                            </div>
                          )}
                        </div>
                      );
                    })}
                  </div>
                  
                  <div className="flex items-center justify-center gap-4 mt-4 pt-3 border-t" style={{ borderColor: COLORS.surfaceLight }}>
                    <div className="flex items-center gap-2">
                      <div className="w-4 h-4 rounded flex items-center justify-center" style={{ backgroundColor: COLORS.success + '30' }}>
                        <Dumbbell size={10} color={COLORS.success} />
                      </div>
                      <span className="text-xs" style={{ color: COLORS.textMuted }}>Workout</span>
                    </div>
                    <div className="flex items-center gap-2">
                      <div className="w-4 h-4 rounded" style={{ backgroundColor: COLORS.surfaceLight }} />
                      <span className="text-xs" style={{ color: COLORS.textMuted }}>Rest Day</span>
                    </div>
                  </div>
                </div>
                
                {/* Stats Summary */}
                <h5 className="font-semibold mb-3" style={{ color: COLORS.text }}>This Month</h5>
                <div className="grid grid-cols-3 gap-3 mb-4">
                  <div className="p-4 rounded-xl text-center" style={{ backgroundColor: COLORS.success + '15' }}>
                    <p className="text-2xl font-bold" style={{ color: COLORS.success }}>{workoutDays}</p>
                    <p className="text-xs" style={{ color: COLORS.textSecondary }}>Workouts</p>
                  </div>
                  <div className="p-4 rounded-xl text-center" style={{ backgroundColor: COLORS.surfaceLight }}>
                    <p className="text-2xl font-bold" style={{ color: COLORS.text }}>{restDays}</p>
                    <p className="text-xs" style={{ color: COLORS.textSecondary }}>Rest Days</p>
                  </div>
                  <div className="p-4 rounded-xl text-center" style={{ backgroundColor: COLORS.primary + '15' }}>
                    <p className="text-2xl font-bold" style={{ color: COLORS.primary }}>{avgDuration}m</p>
                    <p className="text-xs" style={{ color: COLORS.textSecondary }}>Avg Duration</p>
                  </div>
                </div>
                
                {/* Weekly Breakdown */}
                <div className="p-4 rounded-xl" style={{ backgroundColor: COLORS.surface }}>
                  <h5 className="font-semibold mb-3" style={{ color: COLORS.text }}>Weekly Average</h5>
                  <div className="flex items-center gap-3">
                    <div 
                      className="w-12 h-12 rounded-full flex items-center justify-center"
                      style={{ backgroundColor: COLORS.primary + '20' }}
                    >
                      <span className="text-lg font-bold" style={{ color: COLORS.primary }}>{weeklyWorkouts}</span>
                    </div>
                    <div>
                      <p className="font-medium" style={{ color: COLORS.text }}>workouts per week</p>
                      <p className="text-xs" style={{ color: COLORS.textMuted }}>
                        {weeklyWorkouts >= 5 ? 'Very consistent!' : weeklyWorkouts >= 3 ? 'Solid routine!' : 'Building the habit'}
                      </p>
                    </div>
                  </div>
                </div>
              </div>
              
              <div className="p-4 border-t" style={{ borderColor: COLORS.surfaceLight }}>
                <button 
                  onClick={() => { setShowFriendStreakCalendar(null); setFriendStreakMonth(currentMonth); setFriendStreakYear(currentYear); }}
                  className="w-full py-4 rounded-xl font-semibold"
                  style={{ backgroundColor: COLORS.warning, color: COLORS.background }}
                >
                  Close
                </button>
              </div>
            </div>
          );
        })()}

        {/* Friend PRs Modal */}
        {showFriendPRs && (
          <div className="fixed inset-0 z-50 flex flex-col" style={{ backgroundColor: COLORS.background }}>
            <div className="p-4 border-b flex items-center gap-3" style={{ borderColor: COLORS.surfaceLight }}>
              <button onClick={() => setShowFriendPRs(null)}>
                <ChevronLeft size={24} color={COLORS.text} />
              </button>
              <div
                className="w-10 h-10 rounded-full flex items-center justify-center text-xl"
                style={{ backgroundColor: COLORS.surfaceLight }}
              >
                {typeof showFriendPRs.avatar === 'string' && showFriendPRs.avatar.length === 1 ? showFriendPRs.avatar : showFriendPRs.name?.[0]?.toUpperCase() || '?'}
              </div>
              <div>
                <h2 className="font-bold" style={{ color: COLORS.text }}>{(showFriendPRs.name || 'User').split(' ')[0]}'s PRs</h2>
                <p className="text-xs" style={{ color: COLORS.textMuted }}>{friendPRsData.length} personal records</p>
              </div>
            </div>

            <div className="flex-1 overflow-auto p-4">
              {showFriendPRs.privacyBlocked ? (
                <div className="text-center py-12">
                  <div className="w-16 h-16 rounded-full mx-auto mb-4 flex items-center justify-center" style={{ backgroundColor: COLORS.surfaceLight }}>
                    <Lock size={32} color={COLORS.textMuted} />
                  </div>
                  <h3 className="font-bold mb-2" style={{ color: COLORS.text }}>PRs are Private</h3>
                  <p className="text-sm" style={{ color: COLORS.textMuted }}>
                    {showFriendPRs.name?.split(' ')[0] || 'This user'} has chosen to keep their personal records private
                  </p>
                </div>
              ) : friendPRsData.length === 0 ? (
                <div className="text-center py-12">
                  <div className="w-16 h-16 rounded-full mx-auto mb-4 flex items-center justify-center" style={{ backgroundColor: COLORS.surfaceLight }}>
                    <Trophy size={32} color={COLORS.textMuted} />
                  </div>
                  <h3 className="font-bold mb-2" style={{ color: COLORS.text }}>No PRs Yet</h3>
                  <p className="text-sm" style={{ color: COLORS.textMuted }}>
                    {showFriendPRs.name?.split(' ')[0] || 'This user'} hasn't set any personal records yet
                  </p>
                </div>
              ) : (
                <div className="space-y-3">
                  {/* Group PRs by exercise */}
                  {Object.entries(
                    friendPRsData.reduce((acc, pr) => {
                      const key = pr.exercise_name || pr.exercise || 'Unknown';
                      if (!acc[key]) acc[key] = [];
                      acc[key].push(pr);
                      return acc;
                    }, {})
                  ).sort(([a], [b]) => a.localeCompare(b)).map(([exercise, prs]) => (
                    <div key={exercise} className="p-4 rounded-xl" style={{ backgroundColor: COLORS.surface }}>
                      <div className="flex items-center gap-3 mb-3">
                        <div className="w-10 h-10 rounded-full flex items-center justify-center" style={{ backgroundColor: COLORS.warning + '20' }}>
                          <Trophy size={18} color={COLORS.warning} />
                        </div>
                        <div>
                          <p className="font-semibold" style={{ color: COLORS.text }}>{exercise}</p>
                          <p className="text-xs" style={{ color: COLORS.textMuted }}>{prs.length} record{prs.length > 1 ? 's' : ''}</p>
                        </div>
                      </div>
                      <div className="space-y-2">
                        {prs.slice(0, 3).map((pr, idx) => (
                          <div key={idx} className="flex items-center justify-between p-2 rounded-lg" style={{ backgroundColor: COLORS.surfaceLight }}>
                            <div>
                              <p className="font-semibold" style={{ color: COLORS.text }}>{pr.weight}kg x {pr.reps}</p>
                              <p className="text-xs" style={{ color: COLORS.textMuted }}>
                                {pr.achieved_at ? new Date(pr.achieved_at).toLocaleDateString() : 'Recently'}
                              </p>
                            </div>
                            {pr.e1rm && (
                              <div className="text-right">
                                <p className="text-sm font-semibold" style={{ color: COLORS.primary }}>{Math.round(pr.e1rm)}kg</p>
                                <p className="text-xs" style={{ color: COLORS.textMuted }}>Est. 1RM</p>
                              </div>
                            )}
                          </div>
                        ))}
                      </div>
                    </div>
                  ))}
                </div>
              )}
            </div>

            <div className="p-4 border-t" style={{ borderColor: COLORS.surfaceLight }}>
              <button
                onClick={() => setShowFriendPRs(null)}
                className="w-full py-4 rounded-xl font-semibold"
                style={{ backgroundColor: COLORS.warning, color: COLORS.background }}
              >
                Close
              </button>
            </div>
          </div>
        )}

        {/* Meal Entry Modal - at root level to persist across tab changes */}
        {showMealEntry && (
          <MealEntryModal
            COLORS={COLORS}
            userId={user?.id}
            onClose={() => setShowMealEntry(false)}
            onSave={async (mealData) => {
              const mealTime = mealData.time || new Date().toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', hour12: false });
              const mealName = mealData.name || 'Quick entry';

              // Save to Supabase if logged in
              if (user?.id) {
                const { data } = await nutritionService.logMeal(user.id, {
                  name: mealName,
                  time: mealTime,
                  calories: mealData.calories || 0,
                  protein: mealData.protein || 0,
                  carbs: mealData.carbs || 0,
                  fats: mealData.fats || 0,
                });
                const savedMeal = data ? {
                  id: data.id,
                  name: data.meal_name,
                  time: data.meal_time,
                  calories: data.calories,
                  protein: data.protein,
                  carbs: data.carbs,
                  fats: data.fats,
                } : {
                  id: Date.now(),
                  name: mealName,
                  time: mealTime,
                  calories: mealData.calories || 0,
                  protein: mealData.protein || 0,
                  carbs: mealData.carbs || 0,
                  fats: mealData.fats || 0,
                };
                setMealLog(prev => [...prev, savedMeal]);
              } else {
                // Not logged in - still add to local mealLog
                setMealLog(prev => [...prev, {
                  id: Date.now(),
                  name: mealName,
                  time: mealTime,
                  calories: mealData.calories || 0,
                  protein: mealData.protein || 0,
                  carbs: mealData.carbs || 0,
                  fats: mealData.fats || 0,
                }]);
              }
              setCaloriesIntake(prev => prev + (mealData.calories || 0));
              setProteinIntake(prev => prev + (mealData.protein || 0));
              setCarbsIntake(prev => prev + (mealData.carbs || 0));
              setShowMealEntry(false);
            }}
          />
        )}

        {/* Water Entry Modal - at root level to persist across tab changes */}
        {showWaterEntry && (
          <WaterEntryModal
            COLORS={COLORS}
            onClose={() => setShowWaterEntry(false)}
            onSave={async (amount) => {
              // Optimistic update
              setWaterIntake(prev => Math.min(prev + amount, 10000));
              setShowWaterEntry(false);

              if (user?.id) {
                try {
                  const { data, error } = await nutritionService.logWater(user.id, amount);
                  if (error || !data) {
                    // Rollback on failure
                    setWaterIntake(prev => Math.max(prev - amount, 0));
                    console.error('Failed to save water:', error?.message);
                    return;
                  }
                  setWaterLogs(prev => [...prev, data]);
                } catch (err) {
                  // Rollback on network error
                  setWaterIntake(prev => Math.max(prev - amount, 0));
                  console.error('Failed to save water:', err);
                }
              }
            }}
          />
        )}

        {/* Activity Comments Modal */}
        {showCommentsModal && (
          <div className="fixed inset-0 z-50 flex flex-col" style={{ backgroundColor: COLORS.background }}>
            <div className="p-4 border-b flex items-center gap-3" style={{ borderColor: COLORS.surfaceLight }}>
              <button onClick={() => { setShowCommentsModal(null); setActivityCommentsData([]); setNewActivityComment(''); }}>
                <X size={24} color={COLORS.text} />
              </button>
              <h3 className="text-lg font-bold" style={{ color: COLORS.text }}>Comments</h3>
            </div>

            <div className="flex-1 overflow-auto p-4">
              {activityCommentsLoading ? (
                <div className="flex items-center justify-center py-12">
                  <Loader2 size={32} color={COLORS.primary} className="animate-spin" />
                </div>
              ) : activityCommentsData.length === 0 ? (
                <div className="text-center py-12">
                  <MessageCircle size={48} color={COLORS.textMuted} className="mx-auto mb-3" style={{ opacity: 0.5 }} />
                  <p className="text-sm" style={{ color: COLORS.textMuted }}>No comments yet</p>
                  <p className="text-xs" style={{ color: COLORS.textMuted }}>Be the first to leave a comment!</p>
                </div>
              ) : (
                <div className="space-y-4">
                  {activityCommentsData.map((comment) => {
                    const commentUser = comment.user;
                    const commentName = commentUser
                      ? `${commentUser.first_name || ''} ${commentUser.last_name || ''}`.trim() || commentUser.username || 'User'
                      : 'User';
                    const commentAvatar = commentUser?.avatar_url || commentUser?.first_name?.[0]?.toUpperCase() || 'U';
                    const isOwnComment = comment.user_id === user?.id;

                    return (
                      <div key={comment.id} className="flex gap-3">
                        <div
                          className="w-10 h-10 rounded-full flex-shrink-0 flex items-center justify-center text-sm font-bold"
                          style={{ backgroundColor: COLORS.primary + '30', color: COLORS.primary }}
                        >
                          {typeof commentAvatar === 'string' && commentAvatar.length === 1 ? commentAvatar : commentName[0]?.toUpperCase()}
                        </div>
                        <div className="flex-1 min-w-0">
                          <div className="flex items-center gap-2">
                            <span className="font-semibold text-sm" style={{ color: COLORS.text }}>{commentName}</span>
                            <span className="text-xs" style={{ color: COLORS.textMuted }}>
                              {formatActivityTime(comment.created_at)}
                            </span>
                          </div>
                          <p className="text-sm mt-1" style={{ color: COLORS.textSecondary }}>{comment.content}</p>
                          {isOwnComment && (
                            <button
                              onClick={async () => {
                                if (confirm('Delete this comment?')) {
                                  await socialService.deleteComment(comment.id, user?.id);
                                  setActivityCommentsData(prev => prev.filter(c => c.id !== comment.id));
                                  setActivityCommentCounts(prev => ({
                                    ...prev,
                                    [showCommentsModal]: Math.max(0, (prev[showCommentsModal] || 1) - 1)
                                  }));
                                }
                              }}
                              className="text-xs mt-1"
                              style={{ color: COLORS.error }}
                            >
                              Delete
                            </button>
                          )}
                        </div>
                      </div>
                    );
                  })}
                </div>
              )}
            </div>

            {/* Comment Input */}
            <div className="p-4 border-t" style={{ borderColor: COLORS.surfaceLight, backgroundColor: COLORS.surface }}>
              <div className="flex gap-3">
                <div
                  className="w-10 h-10 rounded-full flex-shrink-0 flex items-center justify-center text-sm font-bold"
                  style={{ backgroundColor: COLORS.primary + '30', color: COLORS.primary }}
                >
                  {profile?.first_name?.[0]?.toUpperCase() || 'U'}
                </div>
                <div className="flex-1 flex gap-2">
                  <input
                    type="text"
                    value={newActivityComment}
                    onChange={(e) => setNewActivityComment(e.target.value)}
                    placeholder="Write a comment..."
                    className="flex-1 px-4 py-2 rounded-xl text-sm"
                    style={{ backgroundColor: COLORS.surfaceLight, color: COLORS.text, border: 'none', outline: 'none' }}
                    onKeyDown={async (e) => {
                      if (e.key === 'Enter' && !e.shiftKey && newActivityComment.trim()) {
                        e.preventDefault();
                        const content = newActivityComment.trim();
                        setNewActivityComment('');
                        const { data } = await socialService.addComment(showCommentsModal, user?.id, content);
                        if (data) {
                          setActivityCommentsData(prev => [...prev, data]);
                          setActivityCommentCounts(prev => ({
                            ...prev,
                            [showCommentsModal]: (prev[showCommentsModal] || 0) + 1
                          }));
                          // Notify the activity owner
                          const activity = activityFeed.find(a => a.id === showCommentsModal);
                          if (activity?.friendId && activity.friendId !== user?.id) {
                            const userName = `${profile?.first_name || ''} ${profile?.last_name || ''}`.trim() || profile?.username || 'Someone';
                            notificationService.notifyComment(activity.friendId, user?.id, userName, showCommentsModal);
                          }
                        }
                      }
                    }}
                  />
                  <button
                    onClick={async () => {
                      if (!newActivityComment.trim()) return;
                      const content = newActivityComment.trim();
                      setNewActivityComment('');
                      const { data } = await socialService.addComment(showCommentsModal, user?.id, content);
                      if (data) {
                        setActivityCommentsData(prev => [...prev, data]);
                        setActivityCommentCounts(prev => ({
                          ...prev,
                          [showCommentsModal]: (prev[showCommentsModal] || 0) + 1
                        }));
                        // Notify the activity owner
                        const activity = activityFeed.find(a => a.id === showCommentsModal);
                        if (activity?.friendId && activity.friendId !== user?.id) {
                          const userName = `${profile?.first_name || ''} ${profile?.last_name || ''}`.trim() || profile?.username || 'Someone';
                          notificationService.notifyComment(activity.friendId, user?.id, userName, showCommentsModal);
                        }
                      }
                    }}
                    disabled={!newActivityComment.trim()}
                    className="px-4 py-2 rounded-xl font-semibold text-sm"
                    style={{
                      backgroundColor: newActivityComment.trim() ? COLORS.primary : COLORS.surfaceLight,
                      color: newActivityComment.trim() ? COLORS.text : COLORS.textMuted
                    }}
                  >
                    Post
                  </button>
                </div>
              </div>
            </div>
          </div>
        )}

        {/* Friend Workouts Modal */}
        {showFriendWorkouts && !selectedFriendWorkout && (
          <div className="fixed inset-0 z-50 flex flex-col" style={{ backgroundColor: COLORS.background }}>
            <div className="p-4 border-b flex items-center gap-3" style={{ borderColor: COLORS.surfaceLight }}>
              <button onClick={() => setShowFriendWorkouts(null)}>
                <ChevronLeft size={24} color={COLORS.text} />
              </button>
              <div
                className="w-10 h-10 rounded-full flex items-center justify-center text-xl"
                style={{ backgroundColor: COLORS.surfaceLight }}
              >
                {typeof showFriendWorkouts.avatar === 'string' && showFriendWorkouts.avatar.length === 1 ? showFriendWorkouts.avatar : showFriendWorkouts.name?.[0]?.toUpperCase() || '?'}
              </div>
              <div>
                <h2 className="font-bold" style={{ color: COLORS.text }}>{(showFriendWorkouts.name || 'User').split(' ')[0]}'s Workouts</h2>
                <p className="text-xs" style={{ color: COLORS.textMuted }}>{friendWorkoutsData.length} completed workouts</p>
              </div>
            </div>

            <div className="flex-1 overflow-auto p-4">
              {showFriendWorkouts.privacyBlocked ? (
                <div className="text-center py-12">
                  <div className="w-16 h-16 rounded-full mx-auto mb-4 flex items-center justify-center" style={{ backgroundColor: COLORS.surfaceLight }}>
                    <Lock size={32} color={COLORS.textMuted} />
                  </div>
                  <h3 className="font-bold mb-2" style={{ color: COLORS.text }}>Workouts are Private</h3>
                  <p className="text-sm" style={{ color: COLORS.textMuted }}>
                    {showFriendWorkouts.name?.split(' ')[0] || 'This user'} has chosen to keep their workouts private
                  </p>
                </div>
              ) : friendWorkoutsData.length === 0 ? (
                <div className="text-center py-12">
                  <div className="w-16 h-16 rounded-full mx-auto mb-4 flex items-center justify-center" style={{ backgroundColor: COLORS.surfaceLight }}>
                    <Dumbbell size={32} color={COLORS.textMuted} />
                  </div>
                  <h3 className="font-bold mb-2" style={{ color: COLORS.text }}>No Workouts Yet</h3>
                  <p className="text-sm" style={{ color: COLORS.textMuted }}>
                    {showFriendWorkouts.name?.split(' ')[0] || 'This user'} hasn't completed any workouts yet
                  </p>
                </div>
              ) : (
                <div className="space-y-3">
                  {friendWorkoutsData.map((workout, idx) => {
                    const exerciseCount = workout.exercises?.length || 0;
                    const totalVolume = (workout.exercises || []).reduce((sum, ex) => {
                      return sum + (ex.sets || []).reduce((setSum, set) => {
                        return setSum + ((set.weight || 0) * (set.reps || 0));
                      }, 0);
                    }, 0);

                    return (
                      <button
                        key={workout.id || idx}
                        onClick={() => setSelectedFriendWorkout(workout)}
                        className="w-full p-4 rounded-xl text-left"
                        style={{ backgroundColor: COLORS.surface }}
                      >
                        <div className="flex items-center justify-between">
                          <div className="flex items-center gap-3">
                            <div className="w-12 h-12 rounded-xl flex items-center justify-center" style={{ backgroundColor: COLORS.primary + '20' }}>
                              <Dumbbell size={24} color={COLORS.primary} />
                            </div>
                            <div>
                              <p className="font-semibold" style={{ color: COLORS.text }}>{workout.template_name || workout.name || 'Workout'}</p>
                              <p className="text-xs" style={{ color: COLORS.textMuted }}>
                                {workout.completed_at ? new Date(workout.completed_at).toLocaleDateString() : 'Recently'}
                                {workout.focus && ` - ${workout.focus}`}
                              </p>
                            </div>
                          </div>
                          <ChevronRight size={20} color={COLORS.textMuted} />
                        </div>
                        <div className="flex gap-4 mt-3 pt-3 border-t" style={{ borderColor: COLORS.surfaceLight }}>
                          <div>
                            <p className="text-sm font-semibold" style={{ color: COLORS.text }}>{exerciseCount}</p>
                            <p className="text-xs" style={{ color: COLORS.textMuted }}>exercises</p>
                          </div>
                          <div>
                            <p className="text-sm font-semibold" style={{ color: COLORS.text }}>{workout.duration_minutes || 45}min</p>
                            <p className="text-xs" style={{ color: COLORS.textMuted }}>duration</p>
                          </div>
                          {totalVolume > 0 && (
                            <div>
                              <p className="text-sm font-semibold" style={{ color: COLORS.text }}>{(totalVolume / 1000).toFixed(1)}k</p>
                              <p className="text-xs" style={{ color: COLORS.textMuted }}>volume (kg)</p>
                            </div>
                          )}
                        </div>
                      </button>
                    );
                  })}
                </div>
              )}
            </div>

            <div className="p-4 border-t" style={{ borderColor: COLORS.surfaceLight }}>
              <button
                onClick={() => setShowFriendWorkouts(null)}
                className="w-full py-4 rounded-xl font-semibold"
                style={{ backgroundColor: COLORS.primary, color: COLORS.text }}
              >
                Close
              </button>
            </div>
          </div>
        )}

        {/* Selected Friend Workout Detail */}
        {selectedFriendWorkout && (
          <div className="fixed inset-0 z-50 flex flex-col" style={{ backgroundColor: COLORS.background }}>
            <div className="p-4 border-b flex items-center gap-3" style={{ borderColor: COLORS.surfaceLight }}>
              <button onClick={() => setSelectedFriendWorkout(null)}>
                <ChevronLeft size={24} color={COLORS.text} />
              </button>
              <div>
                <h2 className="font-bold" style={{ color: COLORS.text }}>{selectedFriendWorkout.template_name || selectedFriendWorkout.name || 'Workout'}</h2>
                <p className="text-xs" style={{ color: COLORS.textMuted }}>
                  {selectedFriendWorkout.completed_at ? new Date(selectedFriendWorkout.completed_at).toLocaleDateString() : 'Recently'}
                  {selectedFriendWorkout.focus && ` - ${selectedFriendWorkout.focus}`}
                </p>
              </div>
            </div>

            <div className="flex-1 overflow-auto p-4">
              {/* Workout Summary */}
              <div className="grid grid-cols-3 gap-3 mb-6">
                <div className="p-4 rounded-xl text-center" style={{ backgroundColor: COLORS.surface }}>
                  <p className="text-xl font-bold" style={{ color: COLORS.text }}>{(selectedFriendWorkout.exercises || []).length}</p>
                  <p className="text-xs" style={{ color: COLORS.textMuted }}>Exercises</p>
                </div>
                <div className="p-4 rounded-xl text-center" style={{ backgroundColor: COLORS.surface }}>
                  <p className="text-xl font-bold" style={{ color: COLORS.text }}>{selectedFriendWorkout.duration_minutes || 45}</p>
                  <p className="text-xs" style={{ color: COLORS.textMuted }}>Minutes</p>
                </div>
                <div className="p-4 rounded-xl text-center" style={{ backgroundColor: COLORS.surface }}>
                  <p className="text-xl font-bold" style={{ color: COLORS.text }}>
                    {((selectedFriendWorkout.exercises || []).reduce((sum, ex) => {
                      return sum + (ex.sets || []).reduce((setSum, set) => {
                        return setSum + ((set.weight || 0) * (set.reps || 0));
                      }, 0);
                    }, 0) / 1000).toFixed(1)}k
                  </p>
                  <p className="text-xs" style={{ color: COLORS.textMuted }}>Volume (kg)</p>
                </div>
              </div>

              {/* Exercises List */}
              <h3 className="font-semibold mb-3" style={{ color: COLORS.text }}>Exercises</h3>
              <div className="space-y-3">
                {(selectedFriendWorkout.exercises || []).map((exercise, idx) => {
                  const sets = exercise.sets || [];
                  const completedSets = sets.filter(s => s.completed);

                  return (
                    <div key={idx} className="p-4 rounded-xl" style={{ backgroundColor: COLORS.surface }}>
                      <div className="flex items-center gap-3 mb-3">
                        <div className="w-10 h-10 rounded-xl flex items-center justify-center" style={{ backgroundColor: COLORS.primary + '20' }}>
                          <Dumbbell size={18} color={COLORS.primary} />
                        </div>
                        <div className="flex-1">
                          <p className="font-semibold" style={{ color: COLORS.text }}>{exercise.name || exercise.exercise_name || 'Exercise'}</p>
                          <p className="text-xs" style={{ color: COLORS.textMuted }}>{exercise.muscle_group || exercise.muscleGroup || ''}</p>
                        </div>
                      </div>

                      {/* Sets Table */}
                      <div className="rounded-lg overflow-hidden" style={{ backgroundColor: COLORS.surfaceLight }}>
                        <div className="grid grid-cols-4 gap-2 p-2 border-b" style={{ borderColor: COLORS.surface }}>
                          <p className="text-xs font-semibold" style={{ color: COLORS.textMuted }}>Set</p>
                          <p className="text-xs font-semibold" style={{ color: COLORS.textMuted }}>Weight</p>
                          <p className="text-xs font-semibold" style={{ color: COLORS.textMuted }}>Reps</p>
                          <p className="text-xs font-semibold text-right" style={{ color: COLORS.textMuted }}>Status</p>
                        </div>
                        {sets.length > 0 ? sets.map((set, setIdx) => (
                          <div key={setIdx} className="grid grid-cols-4 gap-2 p-2">
                            <p className="text-sm" style={{ color: COLORS.text }}>{setIdx + 1}</p>
                            <p className="text-sm" style={{ color: COLORS.text }}>{set.weight || '-'}kg</p>
                            <p className="text-sm" style={{ color: COLORS.text }}>{set.reps || '-'}</p>
                            <div className="text-right">
                              {set.completed ? (
                                <Check size={16} color={COLORS.success} />
                              ) : (
                                <span className="text-xs" style={{ color: COLORS.textMuted }}>-</span>
                              )}
                            </div>
                          </div>
                        )) : (
                          <div className="p-3 text-center">
                            <p className="text-xs" style={{ color: COLORS.textMuted }}>
                              {exercise.sets_count || 3} sets x {exercise.reps || exercise.target_reps || '8-12'} reps
                            </p>
                          </div>
                        )}
                      </div>
                    </div>
                  );
                })}
              </div>
            </div>

            <div className="p-4 border-t" style={{ borderColor: COLORS.surfaceLight }}>
              <button
                onClick={() => setSelectedFriendWorkout(null)}
                className="w-full py-4 rounded-xl font-semibold"
                style={{ backgroundColor: COLORS.primary, color: COLORS.text }}
              >
                Back to Workouts
              </button>
            </div>
          </div>
        )}

        {activeTab === 'progress' && (
          <ProgressTab
            COLORS={COLORS}
            userData={userData}
            currentProgram={currentProgram}
            programProgress={programProgress}
            masterSchedule={masterSchedule}
            adjustedNutritionGoals={adjustedNutritionGoals}
            nutritionGoals={nutritionGoals}
            todayWorkoutCompleted={todayWorkoutCompleted}
            WORKOUT_TEMPLATES={WORKOUT_TEMPLATES}
            caloriesIntake={caloriesIntake}
            proteinIntake={proteinIntake}
            waterIntake={waterIntake}
            lastNightBedTime={lastNightBedTime}
            lastNightWakeTime={lastNightWakeTime}
            streaks={streaks}
            dailyInsightsExpanded={dailyInsightsExpanded}
            setDailyInsightsExpanded={setDailyInsightsExpanded}
            chartData={chartData}
            setShowWeighIn={setShowWeighIn}
            getLocalDateString={getLocalDateString}
          />
        )}
        {activeTab === 'profile' && (
          <div ref={profileTabScrollRef} onScroll={handleProfileTabScroll} className="h-full overflow-auto pb-20">
            {/* Profile Header */}
            <div className="pb-6 text-center" style={{ backgroundColor: COLORS.surface }}>
              {/* Cover Photo */}
              <div
                className="h-32 w-full"
                style={{
                  backgroundColor: userData.coverPhotoUrl ? 'transparent' : COLORS.surfaceLight,
                  backgroundImage: userData.coverPhotoUrl ? `url(${userData.coverPhotoUrl})` : 'none',
                  backgroundSize: 'cover',
                  backgroundPosition: 'center'
                }}
              />
              {/* Profile Picture */}
              <div className="-mt-12 mb-4">
                <div
                  className="w-24 h-24 rounded-full mx-auto border-4 flex items-center justify-center"
                  style={{
                    backgroundColor: userData.avatarUrl ? 'transparent' : COLORS.primary + '20',
                    backgroundImage: userData.avatarUrl ? `url(${userData.avatarUrl})` : 'none',
                    backgroundSize: 'cover',
                    backgroundPosition: 'center',
                    borderColor: COLORS.surface
                  }}
                >
                  {!userData.avatarUrl && <User size={48} color={COLORS.primary} />}
                </div>
              </div>
              <h2 className="text-xl font-bold" style={{ color: COLORS.text }}>
                @{userData.username || 'username'}
              </h2>
              <p className="text-sm mb-2" style={{ color: COLORS.textSecondary }}>
                {userData.firstName || 'First'} {userData.lastName || 'Last'}
              </p>
              {userData.bio && (
                <p className="text-sm mb-3 px-4" style={{ color: COLORS.textMuted }}>{userData.bio}</p>
              )}
              {/* Followers/Following Count */}
              <div className="flex items-center justify-center gap-6 mb-4">
                <div className="text-center">
                  <p className="text-lg font-bold" style={{ color: COLORS.text }}>{followersCount}</p>
                  <p className="text-xs" style={{ color: COLORS.textMuted }}>followers</p>
                </div>
                <div className="w-px h-8" style={{ backgroundColor: COLORS.surfaceLight }} />
                <div className="text-center">
                  <p className="text-lg font-bold" style={{ color: COLORS.text }}>{followingIds.size}</p>
                  <p className="text-xs" style={{ color: COLORS.textMuted }}>following</p>
                </div>
              </div>
              <button
                onClick={() => setShowEditProfile(true)}
                className="px-4 py-2 rounded-xl text-sm font-semibold flex items-center gap-2 mx-auto"
                style={{ backgroundColor: COLORS.surfaceLight, color: COLORS.text }}
              >
                <Edit3 size={14} />
                Edit Profile
              </button>
            </div>

            {/* Quick Stats */}
            <div className="p-4">
              <p className="text-xs font-semibold mb-3" style={{ color: COLORS.textMuted }}>STATS</p>
              <div className="grid grid-cols-4 gap-2 mb-6">
                <div className="p-3 rounded-xl text-center" style={{ backgroundColor: COLORS.surface }}>
                  <p className="text-xl font-bold" style={{ color: COLORS.primary }}>{overviewStats.totalWorkouts}</p>
                  <p className="text-xs" style={{ color: COLORS.textMuted }}>workouts</p>
                </div>
                <div className="p-3 rounded-xl text-center" style={{ backgroundColor: COLORS.surface }}>
                  <p className="text-xl font-bold" style={{ color: COLORS.warning }}>{streaks.weeklyWorkouts.weeksCompleted}</p>
                  <p className="text-xs" style={{ color: COLORS.textMuted }}>week streak</p>
                </div>
                <div className="p-3 rounded-xl text-center" style={{ backgroundColor: COLORS.surface }}>
                  <p className="text-xl font-bold" style={{ color: COLORS.success }}>{personalRecords.length}</p>
                  <p className="text-xs" style={{ color: COLORS.textMuted }}>PRs</p>
                </div>
                <div className="p-3 rounded-xl text-center" style={{ backgroundColor: COLORS.surface }}>
                  <p className="text-xl font-bold" style={{ color: COLORS.accent }}>{achievements.filter(a => a.unlocked).length}</p>
                  <p className="text-xs" style={{ color: COLORS.textMuted }}>badges</p>
                </div>
              </div>

              {/* Current Goal */}
              <div className="mb-4">
                <div className="flex items-center justify-between mb-3">
                  <p className="text-xs font-semibold" style={{ color: COLORS.textMuted }}>CURRENT GOAL</p>
                  <button
                    onClick={() => setShowGoalEditor(true)}
                    className="text-xs px-2 py-1 rounded"
                    style={{ backgroundColor: COLORS.surfaceLight, color: COLORS.textMuted }}
                  >
                    Change
                  </button>
                </div>
                {userData.goal && GOAL_INFO[userData.goal] ? (
                  <div className="p-4 rounded-xl" style={{ backgroundColor: COLORS.surface }}>
                    <div className="flex items-center gap-3 mb-3">
                      <div className="w-12 h-12 rounded-xl flex items-center justify-center" style={{ backgroundColor: COLORS.primary + '20' }}>
                        {userData.goal === 'bulk' && <Dumbbell size={24} color={COLORS.primary} />}
                        {userData.goal === 'build_muscle' && <Target size={24} color={COLORS.primary} />}
                        {userData.goal === 'strength' && <Dumbbell size={24} color={COLORS.primary} />}
                        {userData.goal === 'recomp' && <RefreshCw size={24} color={COLORS.primary} />}
                        {userData.goal === 'fitness' && <Heart size={24} color={COLORS.primary} />}
                        {userData.goal === 'athletic' && <Zap size={24} color={COLORS.primary} />}
                        {userData.goal === 'lean' && <TrendingDown size={24} color={COLORS.primary} />}
                        {userData.goal === 'lose_fat' && <Flame size={24} color={COLORS.primary} />}
                      </div>
                      <div>
                        <p className="font-semibold" style={{ color: COLORS.text }}>{GOAL_INFO[userData.goal].title}</p>
                        <p className="text-xs" style={{ color: COLORS.textMuted }}>
                          {EXPERIENCE_LEVELS[userData.experience]?.label || 'Unknown'}
                        </p>
                      </div>
                    </div>
                    <div className="mb-2">
                      <div className="flex justify-between text-xs mb-1">
                        <span style={{ color: COLORS.textMuted }}>Progress to goal</span>
                        <span style={{ color: COLORS.primary }}>
                          {(() => {
                            const start = parseFloat(userData.currentWeight) || overviewStats.startingWeight;
                            const goal = parseFloat(userData.goalWeight) || overviewStats.targetWeight;
                            const current = overviewStats.currentWeight;
                            const totalChange = Math.abs(goal - start);
                            const currentChange = Math.abs(current - start);
                            return totalChange > 0 ? Math.min(100, Math.round((currentChange / totalChange) * 100)) : 0;
                          })()}%
                        </span>
                      </div>
                      <div className="h-2 rounded-full overflow-hidden" style={{ backgroundColor: COLORS.surfaceLight }}>
                        <div
                          className="h-full rounded-full"
                          style={{
                            backgroundColor: COLORS.primary,
                            width: `${(() => {
                              const start = parseFloat(userData.currentWeight) || overviewStats.startingWeight;
                              const goal = parseFloat(userData.goalWeight) || overviewStats.targetWeight;
                              const current = overviewStats.currentWeight;
                              const totalChange = Math.abs(goal - start);
                              const currentChange = Math.abs(current - start);
                              return totalChange > 0 ? Math.min(100, Math.round((currentChange / totalChange) * 100)) : 0;
                            })()}%`
                          }}
                        />
                      </div>
                    </div>
                    <div className="flex justify-between text-sm">
                      <span style={{ color: COLORS.textMuted }}>Start: {overviewStats.startingWeight}kg</span>
                      <span style={{ color: COLORS.text }}>Now: {overviewStats.currentWeight}kg</span>
                      <span style={{ color: COLORS.success }}>Goal: {overviewStats.targetWeight}kg</span>
                    </div>
                  </div>
                ) : (
                  <button
                    onClick={() => setShowGoalEditor(true)}
                    className="w-full p-4 rounded-xl text-center"
                    style={{ backgroundColor: COLORS.surface, border: `2px dashed ${COLORS.surfaceLight}` }}
                  >
                    <Target size={24} color={COLORS.textMuted} className="mx-auto mb-2" />
                    <p style={{ color: COLORS.textMuted }}>Set your fitness goal</p>
                  </button>
                )}
              </div>

              {/* Experience Level */}
              <p className="text-xs font-semibold mb-3" style={{ color: COLORS.textMuted }}>EXPERIENCE LEVEL</p>
              <button
                onClick={() => setShowExperienceLevelModal(true)}
                className="w-full p-4 rounded-xl mb-4 text-left"
                style={{ backgroundColor: COLORS.surface }}
              >
                <div className="flex items-center justify-between">
                  <div className="flex items-center gap-3">
                    <div className="w-10 h-10 rounded-xl flex items-center justify-center" style={{ backgroundColor: COLORS.accent + '20' }}>
                      {userData.experience === 'beginner' && <Sprout size={20} color={COLORS.accent} />}
                      {userData.experience === 'novice' && <TrendingUp size={20} color={COLORS.accent} />}
                      {userData.experience === 'experienced' && <Dumbbell size={20} color={COLORS.accent} />}
                      {userData.experience === 'expert' && <Crown size={20} color={COLORS.accent} />}
                      {!userData.experience && <Dumbbell size={20} color={COLORS.accent} />}
                    </div>
                    <div>
                      <p className="font-semibold" style={{ color: COLORS.text }}>
                        {EXPERIENCE_LEVELS[userData.experience]?.label || 'Not Set'}
                      </p>
                      <p className="text-xs" style={{ color: COLORS.textMuted }}>
                        {EXPERIENCE_LEVELS[userData.experience]?.desc || 'Set your experience level'}
                      </p>
                    </div>
                  </div>
                  <ChevronRight size={20} color={COLORS.textMuted} />
                </div>
              </button>

              {/* Equipment */}
              <p className="text-xs font-semibold mb-3" style={{ color: COLORS.textMuted }}>GYM EQUIPMENT</p>
              <button
                onClick={() => setShowEquipmentModal(true)}
                className="w-full p-4 rounded-xl mb-4 text-left"
                style={{ backgroundColor: COLORS.surface }}
              >
                <div className="flex items-center justify-between">
                  <div className="flex items-center gap-3">
                    <div className="w-10 h-10 rounded-xl flex items-center justify-center" style={{ backgroundColor: COLORS.warning + '20' }}>
                      <Dumbbell size={20} color={COLORS.warning} />
                    </div>
                    <div>
                      <p className="font-semibold" style={{ color: COLORS.text }}>
                        {userData.equipment?.length || 0} items selected
                      </p>
                      <p className="text-xs" style={{ color: COLORS.textMuted }}>
                        {userData.equipment?.slice(0, 3).join(', ')}{userData.equipment?.length > 3 ? '...' : ''}
                      </p>
                    </div>
                  </div>
                  <ChevronRight size={20} color={COLORS.textMuted} />
                </div>
              </button>

              {/* Sleep Goal */}
              <p className="text-xs font-semibold mb-3" style={{ color: COLORS.textMuted }}>SLEEP GOAL</p>
              <div className="p-4 rounded-xl mb-4" style={{ backgroundColor: COLORS.surface }}>
                <div className="flex items-center justify-between">
                  <div className="flex items-center gap-3">
                    <div className="w-10 h-10 rounded-xl flex items-center justify-center" style={{ backgroundColor: COLORS.sleep + '20' }}>
                      <Moon size={20} color={COLORS.sleep} />
                    </div>
                    <div>
                      <p className="font-semibold" style={{ color: COLORS.text }}>
                        {sleepHours} hours per night
                      </p>
                      <p className="text-xs" style={{ color: COLORS.textMuted }}>
                        Target sleep duration
                      </p>
                    </div>
                  </div>
                  <div className="flex items-center gap-2">
                    <button
                      onClick={async () => {
                        const newHours = Math.max(5, sleepHours - 0.5);
                        setSleepHours(newHours);
                        if (user?.id) {
                          await sleepService.updateSleepGoals(user.id, { target_hours: newHours });
                        }
                      }}
                      className="w-8 h-8 rounded-full flex items-center justify-center"
                      style={{ backgroundColor: COLORS.surfaceLight }}
                    >
                      <Minus size={16} color={COLORS.textMuted} />
                    </button>
                    <span className="w-10 text-center font-bold" style={{ color: COLORS.sleep }}>{sleepHours}</span>
                    <button
                      onClick={async () => {
                        const newHours = Math.min(10, sleepHours + 0.5);
                        setSleepHours(newHours);
                        if (user?.id) {
                          await sleepService.updateSleepGoals(user.id, { target_hours: newHours });
                        }
                      }}
                      className="w-8 h-8 rounded-full flex items-center justify-center"
                      style={{ backgroundColor: COLORS.surfaceLight }}
                    >
                      <Plus size={16} color={COLORS.textMuted} />
                    </button>
                  </div>
                </div>
              </div>

              {/* Current Program - opens modal */}
              <p className="text-xs font-semibold mb-3" style={{ color: COLORS.textMuted }}>TRAINING SPLIT</p>
              <div className="p-4 rounded-xl mb-4" style={{ backgroundColor: COLORS.surface }}>
                <button
                  type="button"
                  onClick={() => setShowProgramSelector(true)}
                  className="w-full p-3 rounded-xl flex items-center justify-between mb-3"
                  style={{ backgroundColor: COLORS.surfaceLight, border: `1px solid ${COLORS.primary}40` }}
                >
                  <div className="flex items-center gap-3">
                    <div className="w-10 h-10 rounded-xl flex items-center justify-center" style={{ backgroundColor: COLORS.primary + '20' }}>
                      <Dumbbell size={20} color={COLORS.primary} />
                    </div>
                    <div className="text-left">
                      <p className="font-semibold" style={{ color: COLORS.text }}>{currentProgram.name}</p>
                      <p className="text-xs" style={{ color: COLORS.textMuted }}>{currentProgram.daysPerWeek} days/week  {currentProgram.totalWeeks} weeks</p>
                    </div>
                  </div>
                  <ChevronRight size={20} color={COLORS.primary} />
                </button>
                <div className="flex justify-between text-xs mb-1">
                  <span style={{ color: COLORS.textMuted }}>Week {programProgress.currentWeek} of {programProgress.totalWeeks}</span>
                  <span style={{ color: COLORS.primary }}>{Math.round((programProgress.currentWeek / programProgress.totalWeeks) * 100)}%</span>
                </div>
                <div className="h-2 rounded-full overflow-hidden mb-3" style={{ backgroundColor: COLORS.surfaceLight }}>
                  <div
                    className="h-full rounded-full"
                    style={{ backgroundColor: COLORS.primary, width: `${(programProgress.currentWeek / programProgress.totalWeeks) * 100}%` }}
                  />
                </div>
                <button
                  onClick={() => {
                    if (window.confirm('Reset program to Day 1? This will restart your workout rotation from the beginning.')) {
                      // Reset all completed workouts in masterSchedule
                      setMasterSchedule(prev => {
                        const newSchedule = {};
                        Object.entries(prev).forEach(([dateKey, entry]) => {
                          newSchedule[dateKey] = { ...entry, completed: false };
                        });
                        return newSchedule;
                      });
                      // Reset today's workout completed state
                      setTodayWorkoutCompleted(false);
                    }
                  }}
                  className="w-full py-2 rounded-lg text-sm font-medium"
                  style={{ backgroundColor: COLORS.surfaceLight, color: COLORS.textMuted }}
                >
                  Reset to Day 1
                </button>
              </div>

              {/* Achievements */}
              <div className="mb-4">
                <div className="flex items-center justify-between mb-3">
                  <p className="text-xs font-semibold" style={{ color: COLORS.textMuted }}>ACHIEVEMENTS</p>
                  <span className="text-xs" style={{ color: COLORS.textMuted }}>
                    {achievements.filter(a => a.unlocked).length}/{achievements.length} unlocked
                  </span>
                </div>
                <div className="grid grid-cols-4 gap-2 mb-2">
                  {achievements.slice(0, 8).map((achievement) => (
                    <button
                      key={achievement.id}
                      onClick={() => setSelectedAchievement(achievement)}
                      className="p-3 rounded-xl text-center transition-transform active:scale-95"
                      style={{
                        backgroundColor: COLORS.surface,
                        opacity: achievement.unlocked ? 1 : 0.5
                      }}
                    >
                      <div className="w-8 h-8 rounded-lg mx-auto flex items-center justify-center" style={{ backgroundColor: achievement.unlocked ? COLORS.primary + '20' : COLORS.surfaceLight }}>
                        <IconMap name={achievement.icon} size={16} color={achievement.unlocked ? COLORS.primary : COLORS.textMuted} />
                      </div>
                      <p className="text-xs mt-1 truncate" style={{ color: achievement.unlocked ? COLORS.text : COLORS.textMuted }}>
                        {achievement.name}
                      </p>
                    </button>
                  ))}
                </div>
                {achievements.length > 8 && (
                  <button
                    onClick={() => setShowAllAchievements(true)}
                    className="w-full py-2 rounded-xl text-sm"
                    style={{ backgroundColor: COLORS.surface, color: COLORS.primary }}
                  >
                    View All {achievements.length} Achievements
                  </button>
                )}
              </div>

              {/* Settings */}
              <div className="mb-4">
                <p className="text-xs font-semibold mb-3" style={{ color: COLORS.textMuted }}>SETTINGS</p>
                <div className="rounded-xl overflow-hidden" style={{ backgroundColor: COLORS.surface }}>
                  <button
                    onClick={() => setShowUnitsModal(true)}
                    className="w-full p-4 flex items-center justify-between border-b"
                    style={{ borderColor: COLORS.surfaceLight }}
                  >
                    <div className="flex items-center gap-3">
                      <div className="w-8 h-8 rounded-lg flex items-center justify-center" style={{ backgroundColor: COLORS.accent + '20' }}>
                        <ArrowLeftRight size={16} color={COLORS.accent} />
                      </div>
                      <span style={{ color: COLORS.text }}>Units</span>
                    </div>
                    <div className="flex items-center gap-2">
                      <span className="text-sm" style={{ color: COLORS.textMuted }}>
                        {settings.units === 'metric' ? 'Metric (kg)' : 'Imperial (lbs)'}
                      </span>
                      <ChevronRight size={18} color={COLORS.textMuted} />
                    </div>
                  </button>

                  <button
                    onClick={() => setShowNotificationsModal(true)}
                    className="w-full p-4 flex items-center justify-between border-b"
                    style={{ borderColor: COLORS.surfaceLight }}
                  >
                    <div className="flex items-center gap-3">
                      <div className="w-8 h-8 rounded-lg flex items-center justify-center" style={{ backgroundColor: COLORS.warning + '20' }}>
                        <Zap size={16} color={COLORS.warning} />
                      </div>
                      <span style={{ color: COLORS.text }}>Notifications</span>
                    </div>
                    <ChevronRight size={18} color={COLORS.textMuted} />
                  </button>

                  <button
                    onClick={() => setShowPrivacyModal(true)}
                    className="w-full p-4 flex items-center justify-between border-b"
                    style={{ borderColor: COLORS.surfaceLight }}
                  >
                    <div className="flex items-center gap-3">
                      <div className="w-8 h-8 rounded-lg flex items-center justify-center" style={{ backgroundColor: COLORS.primary + '20' }}>
                        <Eye size={16} color={COLORS.primary} />
                      </div>
                      <span style={{ color: COLORS.text }}>Privacy</span>
                    </div>
                    <ChevronRight size={18} color={COLORS.textMuted} />
                  </button>

                  <button
                    onClick={() => setShowTrackingModal(true)}
                    className="w-full p-4 flex items-center justify-between border-b"
                    style={{ borderColor: COLORS.surfaceLight }}
                  >
                    <div className="flex items-center gap-3">
                      <div className="w-8 h-8 rounded-lg flex items-center justify-center" style={{ backgroundColor: COLORS.success + '20' }}>
                        <BarChart3 size={16} color={COLORS.success} />
                      </div>
                      <span style={{ color: COLORS.text }}>Tracking Preferences</span>
                    </div>
                    <ChevronRight size={18} color={COLORS.textMuted} />
                  </button>

                  {/* Core Exercise Position Setting */}
                  <div className="w-full p-4 flex items-center justify-between border-b" style={{ borderColor: COLORS.surfaceLight }}>
                    <div className="flex items-center gap-3">
                      <div className="w-8 h-8 rounded-lg flex items-center justify-center" style={{ backgroundColor: COLORS.warning + '20' }}>
                        <Dumbbell size={16} color={COLORS.warning} />
                      </div>
                      <div>
                        <span style={{ color: COLORS.text }}>Core Exercises</span>
                        <p className="text-xs" style={{ color: COLORS.textMuted }}>Position in workout</p>
                      </div>
                    </div>
                    <div className="flex items-center gap-1 p-1 rounded-lg" style={{ backgroundColor: COLORS.surfaceLight }}>
                      <button
                        onClick={() => {
                          const scrollTop = profileTabScrollRef.current?.scrollTop;
                          setSettings(prev => ({ ...prev, workout: { ...prev.workout, corePosition: 'first' } }));
                          setCustomizedExercises(null); // Reset to apply new core position
                          requestAnimationFrame(() => {
                            if (profileTabScrollRef.current && scrollTop !== undefined) {
                              profileTabScrollRef.current.scrollTop = scrollTop;
                            }
                          });
                        }}
                        className="px-3 py-1.5 rounded-md text-xs font-semibold"
                        style={{
                          backgroundColor: settings.workout.corePosition === 'first' ? COLORS.primary : 'transparent',
                          color: settings.workout.corePosition === 'first' ? COLORS.text : COLORS.textMuted
                        }}
                      >
                        First
                      </button>
                      <button
                        onClick={() => {
                          const scrollTop = profileTabScrollRef.current?.scrollTop;
                          setSettings(prev => ({ ...prev, workout: { ...prev.workout, corePosition: 'last' } }));
                          setCustomizedExercises(null); // Reset to apply new core position
                          requestAnimationFrame(() => {
                            if (profileTabScrollRef.current && scrollTop !== undefined) {
                              profileTabScrollRef.current.scrollTop = scrollTop;
                            }
                          });
                        }}
                        className="px-3 py-1.5 rounded-md text-xs font-semibold"
                        style={{
                          backgroundColor: settings.workout.corePosition === 'last' ? COLORS.primary : 'transparent',
                          color: settings.workout.corePosition === 'last' ? COLORS.text : COLORS.textMuted
                        }}
                      >
                        Last
                      </button>
                    </div>
                  </div>

                  <button
                    onClick={() => setShowAccountModal(true)}
                    className="w-full p-4 flex items-center justify-between"
                  >
                    <div className="flex items-center gap-3">
                      <div className="w-8 h-8 rounded-lg flex items-center justify-center" style={{ backgroundColor: COLORS.surfaceLight }}>
                        <User size={16} color={COLORS.textSecondary} />
                      </div>
                      <span style={{ color: COLORS.text }}>Account</span>
                    </div>
                    <ChevronRight size={18} color={COLORS.textMuted} />
                  </button>
                </div>
              </div>

              {/* Support */}
              <div className="mb-4">
                <h3 className="font-semibold mb-3" style={{ color: COLORS.text }}>Support</h3>
                <div className="rounded-xl overflow-hidden" style={{ backgroundColor: COLORS.surface }}>
                  <button className="w-full p-4 flex items-center justify-between border-b" style={{ borderColor: COLORS.surfaceLight }}>
                    <div className="flex items-center gap-3">
                      <div className="w-8 h-8 rounded-lg flex items-center justify-center" style={{ backgroundColor: COLORS.surfaceLight }}>
                        <Book size={16} color={COLORS.textSecondary} />
                      </div>
                      <span style={{ color: COLORS.text }}>Help Center</span>
                    </div>
                    <ChevronRight size={18} color={COLORS.textMuted} />
                  </button>
                  <button className="w-full p-4 flex items-center justify-between border-b" style={{ borderColor: COLORS.surfaceLight }}>
                    <div className="flex items-center gap-3">
                      <div className="w-8 h-8 rounded-lg flex items-center justify-center" style={{ backgroundColor: COLORS.surfaceLight }}>
                        <MessageCircle size={16} color={COLORS.textSecondary} />
                      </div>
                      <span style={{ color: COLORS.text }}>Send Feedback</span>
                    </div>
                    <ChevronRight size={18} color={COLORS.textMuted} />
                  </button>
                  <button className="w-full p-4 flex items-center justify-between">
                    <div className="flex items-center gap-3">
                      <div className="w-8 h-8 rounded-lg flex items-center justify-center" style={{ backgroundColor: COLORS.surfaceLight }}>
                        <Info size={16} color={COLORS.textSecondary} />
                      </div>
                      <span style={{ color: COLORS.text }}>About UpRep</span>
                    </div>
                    <span className="text-sm" style={{ color: COLORS.textMuted }}>v5.0.0</span>
                  </button>
                </div>
              </div>

              {/* Rate Us */}
              <div className="mb-4">
                <h3 className="font-semibold mb-3" style={{ color: COLORS.text }}>Enjoying UpRep?</h3>
                <div className="p-4 rounded-xl" style={{ backgroundColor: COLORS.primary + '10', border: `1px solid ${COLORS.primary}30` }}>
                  <div className="flex items-center gap-4">
                    <div className="w-12 h-12 rounded-xl flex items-center justify-center" style={{ backgroundColor: COLORS.warning + '20' }}>
                      <Star size={24} color={COLORS.warning} />
                    </div>
                    <div className="flex-1">
                      <p className="font-semibold mb-1" style={{ color: COLORS.text }}>Rate us on the App Store</p>
                      <p className="text-xs mb-3" style={{ color: COLORS.textMuted }}>
                        Your feedback helps us improve and reach more fitness enthusiasts!
                      </p>
                      <div className="flex gap-2">
                        <button
                          onClick={() => window.open('https://apps.apple.com', '_blank')}
                          className="flex-1 py-2 px-3 rounded-lg text-sm font-medium flex items-center justify-center gap-2"
                          style={{ backgroundColor: COLORS.surface, color: COLORS.text }}
                        >
                          <span></span> App Store
                        </button>
                        <button
                          onClick={() => window.open('https://play.google.com', '_blank')}
                          className="flex-1 py-2 px-3 rounded-lg text-sm font-medium flex items-center justify-center gap-2"
                          style={{ backgroundColor: COLORS.surface, color: COLORS.text }}
                        >
                          <span></span> Google Play
                        </button>
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              {/* Logout */}
              <button
                onClick={() => setShowLogoutConfirm(true)}
                className="w-full p-4 rounded-xl mb-6"
                style={{ backgroundColor: COLORS.error + '15' }}
              >
                <span className="font-semibold" style={{ color: COLORS.error }}>Log Out</span>
              </button>

              {/* Member since */}
              <p className="text-center text-xs mb-4" style={{ color: COLORS.textMuted }}>
                Member since December 2025
              </p>
            </div>
          </div>
        )}
      </div>

      {/* Logout Confirm Modal */}
      {showLogoutConfirm && (
        <div className="fixed inset-0 z-50 flex items-center justify-center p-4" style={{ backgroundColor: 'rgba(0,0,0,0.2)' }}>
          <div className="w-full max-w-sm rounded-2xl p-6" style={{ backgroundColor: COLORS.surface }}>
            <h3 className="text-xl font-bold mb-2 text-center" style={{ color: COLORS.text }}>Log Out?</h3>
            <p className="text-sm text-center mb-6" style={{ color: COLORS.textMuted }}>
              Are you sure you want to log out? Your data will be saved.
            </p>
            <div className="flex gap-3">
              <button
                onClick={() => setShowLogoutConfirm(false)}
                className="flex-1 py-3 rounded-xl font-semibold"
                style={{ backgroundColor: COLORS.surfaceLight, color: COLORS.text }}
              >
                Cancel
              </button>
              <button
                onClick={async () => {
                  setShowLogoutConfirm(false);
                  await signOut();
                  setCurrentScreen('welcome');
                  setActiveTab('home');
                }}
                className="flex-1 py-3 rounded-xl font-semibold"
                style={{ backgroundColor: COLORS.error, color: COLORS.text }}
              >
                Log Out
              </button>
            </div>
          </div>
        </div>
      )}

      {/* WORKOUT TAB MODALS */}
      
      {/* Workout Preview Modal */}
      {showWorkoutPreview && (() => {
        // Support both workout object directly or legacy ID lookup
        const workout = typeof showWorkoutPreview === 'object'
          ? showWorkoutPreview
          : Object.values(WORKOUT_TEMPLATES).find(w => w.id === showWorkoutPreview);
        if (!workout) return null;
        return (
          <div className="fixed inset-0 z-50 flex flex-col" style={{ backgroundColor: COLORS.background }}>
            <div className="p-4 border-b flex items-center gap-3" style={{ borderColor: COLORS.surfaceLight }}>
              <button onClick={() => setShowWorkoutPreview(null)}><X size={24} color={COLORS.text} /></button>
              <h2 className="text-lg font-bold" style={{ color: COLORS.text }}>{workout.name}</h2>
            </div>
            <div className="flex-1 overflow-auto p-4">
              <div className="p-4 rounded-xl mb-4" style={{ backgroundColor: getWorkoutColor(workout.name, COLORS) + '15', border: `1px solid ${getWorkoutColor(workout.name, COLORS)}40` }}>
                <div className="flex items-center gap-2 mb-2">
                  <Target size={18} color={getWorkoutColor(workout.name, COLORS)} />
                  <span className="font-semibold" style={{ color: getWorkoutColor(workout.name, COLORS) }}>{workout.focus}</span>
                </div>
                <p className="text-sm mb-3" style={{ color: COLORS.textSecondary }}>{workout.description}</p>
                <div className="flex flex-wrap gap-2">
                  {workout.goals.map((goal, i) => (
                    <span key={i} className="text-xs px-2 py-1 rounded-full" style={{ backgroundColor: COLORS.surface, color: COLORS.text }}>
                       {goal}
                    </span>
                  ))}
                </div>

                {/* Rating & Stats Display */}
                <div className="flex items-center gap-4 mt-4 pt-3" style={{ borderTop: `1px solid ${COLORS.surfaceLight}` }}>
                  <div className="flex items-center gap-1">
                    <Award size={16} color={COLORS.warning} />
                    <span className="font-semibold" style={{ color: COLORS.text }}>
                      {(workoutStats[workout.id]?.averageRating || 0).toFixed(1)}
                    </span>
                    <span className="text-xs" style={{ color: COLORS.textMuted }}>
                      ({workoutStats[workout.id]?.ratingCount || 0} ratings)
                    </span>
                  </div>
                  <div className="flex items-center gap-1">
                    <Users size={16} color={COLORS.primary} />
                    <span className="text-sm" style={{ color: COLORS.textSecondary }}>
                      {workoutStats[workout.id]?.completionCount || 0} completed
                    </span>
                  </div>
                </div>
              </div>

              {/* Exercises Section */}
              <h3 className="font-semibold mb-3" style={{ color: COLORS.text }}>Exercises ({workout.exercises.length})</h3>
              <div className="space-y-3 mb-4">
                {workout.exercises.map((exercise, i) => {
                  const isSuperset = exercise.supersetId;
                  const isFirstInSuperset = isSuperset && exercise.supersetOrder === 1;
                  const isSecondInSuperset = isSuperset && exercise.supersetOrder === 2;

                  return (
                    <div key={exercise.id}>
                      {/* Superset header - show before first exercise in superset */}
                      {isFirstInSuperset && (
                        <div className="flex items-center gap-2 mb-2 px-2">
                          <Zap size={14} color={COLORS.warning} />
                          <span className="text-xs font-semibold" style={{ color: COLORS.warning }}>SUPERSET</span>
                          <span className="text-xs" style={{ color: COLORS.textMuted }}> No rest between these exercises</span>
                        </div>
                      )}
                      <div
                        className="p-4 rounded-xl"
                        style={{
                          backgroundColor: exercise.isCardio ? COLORS.primary + '10' : COLORS.surface,
                          ...(isSuperset && {
                            borderLeft: `3px solid ${COLORS.warning}`,
                            marginLeft: isFirstInSuperset ? 0 : 0,
                            borderRadius: isFirstInSuperset ? '12px 12px 0 0' : isSecondInSuperset ? '0 0 12px 12px' : '12px',
                            marginTop: isSecondInSuperset ? '-1px' : 0
                          })
                        }}
                      >
                        <div className="flex items-center gap-3">
                          <div className="w-8 h-8 rounded-full flex items-center justify-center" style={{ backgroundColor: exercise.isCardio ? COLORS.primary + '20' : getWorkoutColor(workout.name, COLORS) + '20' }}>
                            <span className="font-bold text-sm" style={{ color: exercise.isCardio ? COLORS.primary : getWorkoutColor(workout.name, COLORS) }}>{i + 1}</span>
                          </div>
                          <div className="flex-1">
                            <p className="font-semibold" style={{ color: COLORS.text }}>{exercise.name}</p>
                            <p className="text-xs" style={{ color: COLORS.textMuted }}>
                              {exercise.isCardio ? exercise.description : exercise.muscleGroup}
                              {isSuperset && <span style={{ color: COLORS.warning }}>  Paired with {exercise.supersetWith}</span>}
                            </p>
                          </div>
                          <div className="text-right">
                            {exercise.isCardio ? (
                              <>
                                <p className="font-semibold" style={{ color: COLORS.primary }}>{exercise.duration} min</p>
                                <p className="text-xs" style={{ color: COLORS.textMuted }}>~{exercise.caloriesBurned} cal</p>
                              </>
                            ) : (
                              <>
                                <p className="font-semibold" style={{ color: COLORS.text }}>{exercise.sets}  {exercise.targetReps}</p>
                                <p className="text-xs" style={{ color: COLORS.textMuted }}>{exercise.suggestedWeight > 0 ? `${exercise.suggestedWeight}kg` : 'Bodyweight'}</p>
                              </>
                            )}
                          </div>
                        </div>
                      </div>
                    </div>
                  );
                })}
              </div>

              {/* Cool-down Section */}
              <div className="mb-4">
                <h3 className="font-semibold mb-3 flex items-center gap-2" style={{ color: COLORS.text }}>
                  <span className="w-6 h-6 rounded-full flex items-center justify-center text-xs" style={{ backgroundColor: COLORS.info + '20', color: COLORS.info }}>C</span>
                  Cool-down (2 min)
                </h3>
                <div className="p-4 rounded-xl" style={{ backgroundColor: COLORS.info + '10', border: `1px solid ${COLORS.info}30` }}>
                  <div className="space-y-2">
                    <div className="flex items-center gap-2">
                      <div className="w-2 h-2 rounded-full" style={{ backgroundColor: COLORS.info }} />
                      <p className="text-sm" style={{ color: COLORS.text }}>Light walking or slow movements</p>
                    </div>
                    <div className="flex items-center gap-2">
                      <div className="w-2 h-2 rounded-full" style={{ backgroundColor: COLORS.info }} />
                      <p className="text-sm" style={{ color: COLORS.text }}>Static stretches for worked muscles</p>
                    </div>
                    <div className="flex items-center gap-2">
                      <div className="w-2 h-2 rounded-full" style={{ backgroundColor: COLORS.info }} />
                      <p className="text-sm" style={{ color: COLORS.text }}>Deep breathing to lower heart rate</p>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            <div className="p-4 border-t" style={{ borderColor: COLORS.surfaceLight }}>
              {/* Rate This Workout */}
              <div className="mb-4">
                <p className="text-sm font-semibold mb-2" style={{ color: COLORS.text }}>Rate this workout</p>
                <div className="flex items-center gap-1">
                  {[1, 2, 3, 4, 5].map(star => (
                    <button
                      key={star}
                      onClick={() => handleRateWorkout(workout.id, star)}
                      className="p-1 transition-transform hover:scale-110"
                    >
                      <Award
                        size={28}
                        color={star <= (userRatings[workout.id] || 0) ? COLORS.warning : COLORS.surfaceLight}
                        fill={star <= (userRatings[workout.id] || 0) ? COLORS.warning : 'transparent'}
                      />
                    </button>
                  ))}
                  {userRatings[workout.id] && (
                    <span className="ml-2 text-sm" style={{ color: COLORS.textMuted }}>
                      Your rating: {userRatings[workout.id]}/5
                    </span>
                  )}
                </div>
              </div>
              <button
                onClick={() => { setShowWorkoutPreview(null); setShowActiveWorkout(true); }}
                className="w-full py-4 rounded-xl font-semibold flex items-center justify-center gap-2"
                style={{ backgroundColor: getWorkoutColor(workout.name, COLORS), color: COLORS.text }}
              >
                Start This Workout <Play size={20} />
              </button>
            </div>
          </div>
        );
      })()}

      {/* Exercise Library Modal */}
      {showExerciseLibrary && (
        <div className="fixed inset-0 z-50 flex flex-col" style={{ backgroundColor: COLORS.background }}>
          <div className="p-4 border-b" style={{ borderColor: COLORS.surfaceLight }}>
            <div className="flex items-center gap-3 mb-3">
              <button onClick={() => setShowExerciseLibrary(false)}><X size={24} color={COLORS.text} /></button>
              <h2 className="text-lg font-bold" style={{ color: COLORS.text }}>Exercise Library</h2>
            </div>
            <div className="relative mb-3">
              <Search size={18} color={COLORS.textMuted} className="absolute left-3 top-1/2 -translate-y-1/2" />
              <input
                type="text"
                value={exerciseSearchQuery}
                onChange={e => setExerciseSearchQuery(e.target.value)}
                placeholder="Search exercises..."
                className="w-full pl-10 pr-4 py-3 rounded-xl"
                style={{ backgroundColor: COLORS.surface, color: COLORS.text, border: 'none' }}
              />
            </div>
            <div className="flex gap-2 overflow-x-auto pb-2">
              {['All', 'Chest', 'Back', 'Shoulders', 'Biceps', 'Triceps', 'Quads', 'Hamstrings', 'Glutes', 'Core'].map(group => (
                <button
                  key={group}
                  onClick={() => setExerciseFilterGroup(group)}
                  className="px-3 py-1 rounded-full text-xs font-semibold flex-shrink-0"
                  style={{ 
                    backgroundColor: exerciseFilterGroup === group ? COLORS.primary : COLORS.surface,
                    color: exerciseFilterGroup === group ? COLORS.text : COLORS.textMuted
                  }}
                >
                  {group}
                </button>
              ))}
            </div>
          </div>
          <div className="flex-1 overflow-auto p-4">
            <div className="space-y-2">
              {ALL_EXERCISES
                .filter(ex => {
                  const matchesSearch = ex.name.toLowerCase().includes(exerciseSearchQuery.toLowerCase());
                  const matchesGroup = exerciseFilterGroup === 'All' || ex.muscleGroup.includes(exerciseFilterGroup);
                  return matchesSearch && matchesGroup;
                })
                .map((exercise, i) => (
                  <button 
                    key={i}
                    onClick={() => { setShowExerciseDetail(exercise.name); setShowExerciseLibrary(false); }}
                    className="w-full p-3 rounded-xl flex items-center justify-between"
                    style={{ backgroundColor: COLORS.surface }}
                  >
                    <div className="text-left">
                      <p className="font-semibold" style={{ color: COLORS.text }}>{exercise.name}</p>
                      <p className="text-xs" style={{ color: COLORS.textMuted }}>{exercise.muscleGroup}  {exercise.equipment}</p>
                    </div>
                    <span className="text-xs px-2 py-1 rounded" style={{ backgroundColor: COLORS.surfaceLight, color: COLORS.textSecondary }}>
                      {exercise.type}
                    </span>
                  </button>
                ))
              }
            </div>
          </div>
        </div>
      )}

      {/* Workout History Modal */}
      {showWorkoutHistory && (
        <div className="fixed inset-0 z-50 flex flex-col" style={{ backgroundColor: COLORS.background }}>
          <div className="p-4 border-b flex items-center gap-3" style={{ borderColor: COLORS.surfaceLight }}>
            <button onClick={() => setShowWorkoutHistory(false)}><X size={24} color={COLORS.text} /></button>
            <h2 className="text-lg font-bold" style={{ color: COLORS.text }}>Workout History</h2>
          </div>
          <div className="flex-1 overflow-auto p-4">
            {workoutHistory.length === 0 ? (
              <div className="flex flex-col items-center justify-center h-full text-center px-6">
                <div className="w-16 h-16 rounded-full flex items-center justify-center mb-4" style={{ backgroundColor: COLORS.surfaceLight }}>
                  <Dumbbell size={32} color={COLORS.textMuted} />
                </div>
                <h3 className="text-lg font-semibold mb-2" style={{ color: COLORS.text }}>No Workouts Yet</h3>
                <p className="text-sm mb-4" style={{ color: COLORS.textMuted }}>
                  Complete your first workout to start tracking your progress. Your workout history will appear here.
                </p>
                <button
                  onClick={() => { setShowWorkoutHistory(false); setActiveTab('workouts'); }}
                  className="px-6 py-3 rounded-xl font-semibold"
                  style={{ backgroundColor: COLORS.primary, color: COLORS.text }}
                >
                  Start a Workout
                </button>
              </div>
            ) : (
              <div className="space-y-3">
                {workoutHistory.map((item) => (
                  <button
                    key={item.id}
                    onClick={() => { setShowWorkoutSummary(item); setShowWorkoutHistory(false); }}
                    className="w-full p-4 rounded-xl"
                    style={{ backgroundColor: COLORS.surface }}
                  >
                    <div className="flex items-center justify-between mb-2">
                      <div className="flex items-center gap-3">
                        <div className="w-10 h-10 rounded-full flex items-center justify-center" style={{ backgroundColor: getWorkoutColor(item.workout.name, COLORS) + '20' }}>
                          <Dumbbell size={18} color={getWorkoutColor(item.workout.name, COLORS)} />
                        </div>
                        <div className="text-left">
                          <p className="font-semibold" style={{ color: COLORS.text }}>{item.workout.name}</p>
                          <p className="text-xs" style={{ color: COLORS.textMuted }}>{item.date}</p>
                        </div>
                      </div>
                      <Check size={18} color={COLORS.success} />
                    </div>
                    <div className="flex justify-between text-sm pt-2 border-t" style={{ borderColor: COLORS.surfaceLight }}>
                      <span style={{ color: COLORS.textSecondary }}>{item.duration} min</span>
                      <span style={{ color: COLORS.textSecondary }}>{item.exercises} exercises</span>
                      <span style={{ color: COLORS.text, fontWeight: 600 }}>{(item.totalVolume / 1000).toFixed(1)}k kg</span>
                    </div>
                  </button>
                ))}
              </div>
            )}
          </div>
        </div>
      )}

      {/* Personal Records Modal */}
      {showPersonalRecords && (
        <div className="fixed inset-0 z-50 flex flex-col" style={{ backgroundColor: COLORS.background }}>
          <div className="p-4 border-b flex items-center gap-3" style={{ borderColor: COLORS.surfaceLight }}>
            <button onClick={() => setShowPersonalRecords(false)}><X size={24} color={COLORS.text} /></button>
            <h2 className="text-lg font-bold" style={{ color: COLORS.text }}>Personal Records</h2>
          </div>
          <div className="flex-1 overflow-auto p-4">
            {personalRecords.length === 0 ? (
              <div className="flex flex-col items-center justify-center h-full text-center px-6">
                <div className="w-16 h-16 rounded-full flex items-center justify-center mb-4" style={{ backgroundColor: COLORS.warning + '20' }}>
                  <Trophy size={32} color={COLORS.warning} />
                </div>
                <h3 className="text-lg font-semibold mb-2" style={{ color: COLORS.text }}>No PRs Yet</h3>
                <p className="text-sm mb-4" style={{ color: COLORS.textMuted }}>
                  Complete workouts and lift heavier to set your first personal records. Every new best becomes a PR!
                </p>
                <button
                  onClick={() => { setShowPersonalRecords(false); setActiveTab('workouts'); }}
                  className="px-6 py-3 rounded-xl font-semibold"
                  style={{ backgroundColor: COLORS.primary, color: COLORS.text }}
                >
                  Start Training
                </button>
              </div>
            ) : (
              <div className="space-y-3">
                {personalRecords.map((pr, i) => (
                  <button
                    key={i}
                    onClick={() => { setShowExerciseDetail(pr.exercise); setShowPersonalRecords(false); }}
                    className="w-full p-4 rounded-xl"
                    style={{ backgroundColor: COLORS.surface }}
                  >
                    <div className="flex items-center justify-between">
                      <div className="flex items-center gap-3">
                        <div className="w-10 h-10 rounded-full flex items-center justify-center" style={{ backgroundColor: COLORS.warning + '20' }}>
                          <Trophy size={18} color={COLORS.warning} />
                        </div>
                        <div className="text-left">
                          <p className="font-semibold" style={{ color: COLORS.text }}>{pr.exercise}</p>
                          <p className="text-xs" style={{ color: COLORS.textMuted }}>{pr.date}</p>
                        </div>
                      </div>
                      <div className="text-right">
                        <p className="text-xl font-bold" style={{ color: COLORS.text }}>{pr.weight}kg</p>
                        <p className="text-xs" style={{ color: COLORS.textMuted }}>x {pr.reps} reps</p>
                      </div>
                    </div>
                    {pr.e1rm > 0 && (
                      <div className="mt-2 pt-2 border-t flex justify-between" style={{ borderColor: COLORS.surfaceLight }}>
                        <span className="text-xs" style={{ color: COLORS.textMuted }}>Estimated 1RM</span>
                        <span className="text-sm font-semibold" style={{ color: COLORS.primary }}>{pr.e1rm}kg</span>
                      </div>
                    )}
                  </button>
                ))}
              </div>
            )}
          </div>
        </div>
      )}

      {/* PR Leaderboard Screen */}
      {showPRLeaderboard && (
        <div className="fixed inset-0 z-50 flex flex-col" style={{ backgroundColor: COLORS.background }}>
          <div className="p-4 border-b flex items-center gap-3" style={{ borderColor: COLORS.surfaceLight }}>
            <button onClick={() => { setShowPRLeaderboard(false); setSelectedPRExercise(null); }}>
              <X size={24} color={COLORS.text} />
            </button>
            <h2 className="text-lg font-bold" style={{ color: COLORS.text }}>
              {selectedPRExercise ? selectedPRExercise : 'My PRs & Rankings'}
            </h2>
            {selectedPRExercise && (
              <button
                onClick={() => { setSelectedPRExercise(null); setExerciseLeaderboard([]); }}
                className="ml-auto text-sm"
                style={{ color: COLORS.primary }}
              >
                Back to PRs
              </button>
            )}
          </div>

          {/* Filter Tabs */}
          {!selectedPRExercise && (
            <div className="p-4 pb-0">
              <div className="flex gap-2 p-1 rounded-xl" style={{ backgroundColor: COLORS.surface }}>
                {[
                  { id: 'global', label: 'Global' },
                  { id: 'age', label: 'My Age Group' },
                  { id: 'weight', label: 'My Weight Class' },
                ].map(filter => (
                  <button
                    key={filter.id}
                    onClick={async () => {
                      setPrLeaderboardFilter(filter.id);
                      // Reload with new filter
                      if (user?.id) {
                        setPrLeaderboardLoading(true);
                        const result = await prLeaderboardService.getMyPRsWithRankings(user.id);
                        if (result?.data) {
                          const prsWithDemographics = await Promise.all(
                            result.data.map(async (pr) => {
                              const demographicRanking = await prLeaderboardService.getPRRankingByDemographic(
                                user.id, pr.exercise_name, filter.id === 'global' ? 'age' : filter.id
                              );
                              return { ...pr, demographicRanking };
                            })
                          );
                          setPrLeaderboardData(prsWithDemographics);
                        }
                        setPrLeaderboardLoading(false);
                      }
                    }}
                    className="flex-1 py-2 px-3 rounded-lg text-sm font-medium transition-colors"
                    style={{
                      backgroundColor: prLeaderboardFilter === filter.id ? COLORS.primary : 'transparent',
                      color: prLeaderboardFilter === filter.id ? COLORS.text : COLORS.textMuted
                    }}
                  >
                    {filter.label}
                  </button>
                ))}
              </div>
            </div>
          )}

          <div className="flex-1 overflow-auto p-4">
            {prLeaderboardLoading ? (
              <div className="flex items-center justify-center py-12">
                <Loader2 size={32} color={COLORS.primary} className="animate-spin" />
              </div>
            ) : selectedPRExercise ? (
              /* Exercise Leaderboard View */
              <div>
                <div className="text-center mb-4">
                  <Trophy size={32} color={COLORS.warning} className="mx-auto mb-2" />
                  <h3 className="font-bold text-lg" style={{ color: COLORS.text }}>Top Lifters</h3>
                  <p className="text-sm" style={{ color: COLORS.textMuted }}>{selectedPRExercise}</p>
                </div>
                {exerciseLeaderboard.length === 0 ? (
                  <div className="text-center py-8">
                    <p style={{ color: COLORS.textMuted }}>No data available</p>
                  </div>
                ) : (
                  <div className="space-y-2">
                    {exerciseLeaderboard.map((entry, index) => {
                      const isCurrentUser = entry.userId === user?.id;
                      return (
                        <div
                          key={entry.userId}
                          className="p-3 rounded-xl flex items-center gap-3"
                          style={{
                            backgroundColor: isCurrentUser ? COLORS.primary + '20' : COLORS.surface,
                            border: isCurrentUser ? `2px solid ${COLORS.primary}` : 'none'
                          }}
                        >
                          <div
                            className="w-8 h-8 rounded-full flex items-center justify-center font-bold text-sm"
                            style={{
                              backgroundColor: index < 3 ? [COLORS.warning, '#C0C0C0', '#CD7F32'][index] + '30' : COLORS.surfaceLight,
                              color: index < 3 ? [COLORS.warning, '#888', '#CD7F32'][index] : COLORS.textMuted
                            }}
                          >
                            {index < 3 ? ['', '', ''][index] : entry.rank}
                          </div>
                          <div className="flex-1 min-w-0">
                            <p className="font-semibold truncate" style={{ color: COLORS.text }}>
                              {entry.profile?.first_name || entry.profile?.username || 'User'}
                              {isCurrentUser && <span style={{ color: COLORS.primary }}> (You)</span>}
                            </p>
                            <p className="text-xs" style={{ color: COLORS.textMuted }}>
                              @{entry.profile?.username || 'user'}
                            </p>
                          </div>
                          <div className="text-right">
                            <p className="font-bold text-lg" style={{ color: COLORS.text }}>{entry.e1rm?.toFixed(0) || entry.weight}kg</p>
                            <p className="text-xs" style={{ color: COLORS.textMuted }}>e1RM</p>
                          </div>
                        </div>
                      );
                    })}
                  </div>
                )}
              </div>
            ) : !prLeaderboardData || prLeaderboardData.length === 0 ? (
              /* Empty State */
              <div className="flex flex-col items-center justify-center h-full text-center px-6">
                <div className="w-16 h-16 rounded-full flex items-center justify-center mb-4" style={{ backgroundColor: COLORS.warning + '20' }}>
                  <Trophy size={32} color={COLORS.warning} />
                </div>
                <h3 className="text-lg font-semibold mb-2" style={{ color: COLORS.text }}>No PRs Yet</h3>
                <p className="text-sm mb-4" style={{ color: COLORS.textMuted }}>
                  Complete workouts and lift heavier to set personal records and see how you rank!
                </p>
                <button
                  onClick={() => { setShowPRLeaderboard(false); setActiveTab('workouts'); }}
                  className="px-6 py-3 rounded-xl font-semibold"
                  style={{ backgroundColor: COLORS.primary, color: COLORS.text }}
                >
                  Start Training
                </button>
              </div>
            ) : (
              /* PR List with Rankings */
              <div className="space-y-3">
                {prLeaderboardData.map((pr, index) => {
                  const ranking = prLeaderboardFilter === 'global'
                    ? { rank: pr.globalRank, total: pr.totalUsers, percentile: pr.percentile }
                    : pr.demographicRanking || { rank: 0, total: 0, percentile: 0 };

                  return (
                    <button
                      key={pr.id || index}
                      onClick={async () => {
                        setSelectedPRExercise(pr.exercise_name);
                        const result = await prLeaderboardService.getExerciseLeaderboard(pr.exercise_name, 20);
                        if (result?.data) setExerciseLeaderboard(result.data);
                      }}
                      className="w-full p-4 rounded-xl text-left"
                      style={{ backgroundColor: COLORS.surface }}
                    >
                      <div className="flex items-center gap-3 mb-3">
                        <div className="w-10 h-10 rounded-full flex items-center justify-center" style={{ backgroundColor: COLORS.warning + '20' }}>
                          <Trophy size={18} color={COLORS.warning} />
                        </div>
                        <div className="flex-1 min-w-0">
                          <p className="font-semibold truncate" style={{ color: COLORS.text }}>{pr.exercise_name}</p>
                          <p className="text-xs" style={{ color: COLORS.textMuted }}>
                            {pr.weight}kg  {pr.reps} reps
                          </p>
                        </div>
                        <div className="text-right">
                          <p className="text-xl font-bold" style={{ color: COLORS.primary }}>{pr.e1rm?.toFixed(0) || ''}kg</p>
                          <p className="text-xs" style={{ color: COLORS.textMuted }}>e1RM</p>
                        </div>
                      </div>

                      {/* Ranking Info */}
                      <div className="flex items-center justify-between pt-3 border-t" style={{ borderColor: COLORS.surfaceLight }}>
                        <div className="flex items-center gap-2">
                          <Crown size={14} color={ranking.percentile >= 90 ? COLORS.warning : COLORS.textMuted} />
                          <span className="text-sm font-semibold" style={{ color: COLORS.text }}>
                            #{ranking.rank || ''}
                          </span>
                          <span className="text-xs" style={{ color: COLORS.textMuted }}>
                            of {ranking.total || 0} {prLeaderboardFilter === 'global' ? 'users' : prLeaderboardFilter === 'age' ? 'in age group' : 'in weight class'}
                          </span>
                        </div>
                        <div className="flex items-center gap-2">
                          {ranking.percentile >= 90 && (
                            <span className="text-xs px-2 py-0.5 rounded-full font-semibold" style={{ backgroundColor: COLORS.warning + '20', color: COLORS.warning }}>
                              Top {100 - ranking.percentile}%
                            </span>
                          )}
                          {ranking.percentile >= 50 && ranking.percentile < 90 && (
                            <span className="text-xs px-2 py-0.5 rounded-full" style={{ backgroundColor: COLORS.success + '20', color: COLORS.success }}>
                              Top {100 - ranking.percentile}%
                            </span>
                          )}
                          {ranking.percentile > 0 && ranking.percentile < 50 && (
                            <span className="text-xs" style={{ color: COLORS.textMuted }}>
                              Top {100 - ranking.percentile}%
                            </span>
                          )}
                          <ChevronRight size={16} color={COLORS.textMuted} />
                        </div>
                      </div>

                      {/* Percentile Bar */}
                      <div className="mt-2 h-1.5 rounded-full overflow-hidden" style={{ backgroundColor: COLORS.surfaceLight }}>
                        <div
                          className="h-full rounded-full transition-all"
                          style={{
                            width: `${ranking.percentile || 0}%`,
                            backgroundColor: ranking.percentile >= 90 ? COLORS.warning : ranking.percentile >= 50 ? COLORS.success : COLORS.primary
                          }}
                        />
                      </div>
                    </button>
                  );
                })}
              </div>
            )}
          </div>
        </div>
      )}

      {/* Custom Workout Modal */}
      {showCustomWorkout && (
        <div className="fixed inset-0 z-50 flex flex-col" style={{ backgroundColor: COLORS.background }}>
          <div className="p-4 border-b flex items-center gap-3" style={{ borderColor: COLORS.surfaceLight }}>
            <button onClick={() => setShowCustomWorkout(false)}><X size={24} color={COLORS.text} /></button>
            <h2 className="text-lg font-bold" style={{ color: COLORS.text }}>Custom Workout</h2>
          </div>
          <div className="flex-1 overflow-auto p-4">
            <div className="text-center py-12">
              <Edit3 size={48} color={COLORS.primary} className="mx-auto mb-4" />
              <h3 className="text-xl font-bold mb-2" style={{ color: COLORS.text }}>Build Your Own</h3>
              <p className="text-sm mb-6" style={{ color: COLORS.textSecondary }}>
                Create a custom workout from scratch or modify an existing template.
              </p>
              <div className="space-y-3">
                <button 
                  onClick={() => { setShowExerciseLibrary(true); setShowCustomWorkout(false); }}
                  className="w-full p-4 rounded-xl flex items-center gap-3"
                  style={{ backgroundColor: COLORS.surface }}
                >
                  <Plus size={20} color={COLORS.primary} />
                  <span style={{ color: COLORS.text }}>Start from scratch</span>
                </button>
                <button 
                  className="w-full p-4 rounded-xl flex items-center gap-3"
                  style={{ backgroundColor: COLORS.surface }}
                >
                  <Book size={20} color={COLORS.accent} />
                  <span style={{ color: COLORS.text }}>Copy from template</span>
                </button>
              </div>
            </div>
          </div>
        </div>
      )}

      {/* Full Schedule Modal */}
      {showFullSchedule && (() => {
        const monthNames = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
        
        const getDaysInMonth = (month, year) => new Date(year, month + 1, 0).getDate();
        const getFirstDayOfMonth = (month, year) => {
          const day = new Date(year, month, 1).getDay();
          return (day + 6) % 7; // Convert to Monday=0 based
        };
        
        const daysInMonth = getDaysInMonth(fullScheduleMonth, fullScheduleYear);
        const firstDay = getFirstDayOfMonth(fullScheduleMonth, fullScheduleYear);
        
        return (
          <div className="fixed inset-0 z-50 flex flex-col" style={{ backgroundColor: COLORS.background }}>
            <div className="p-4 border-b flex items-center gap-3" style={{ borderColor: COLORS.surfaceLight }}>
              <button onClick={() => setShowFullSchedule(false)}><X size={24} color={COLORS.text} /></button>
              <h2 className="text-lg font-bold" style={{ color: COLORS.text }}>Full Schedule</h2>
            </div>
            <div className="flex-1 overflow-auto p-4">
              {/* Month Navigation */}
              <div className="flex items-center justify-between mb-4">
                <button 
                  onClick={() => {
                    if (fullScheduleMonth === 0) { setFullScheduleMonth(11); setFullScheduleYear(fullScheduleYear - 1); }
                    else setFullScheduleMonth(fullScheduleMonth - 1);
                  }}
                  className="p-2 rounded-lg" style={{ backgroundColor: COLORS.surface }}
                >
                  <ChevronLeft size={18} color={COLORS.text} />
                </button>
                <h3 className="font-bold" style={{ color: COLORS.text }}>{monthNames[fullScheduleMonth]} {fullScheduleYear}</h3>
                <button 
                  onClick={() => {
                    if (fullScheduleMonth === 11) { setFullScheduleMonth(0); setFullScheduleYear(fullScheduleYear + 1); }
                    else setFullScheduleMonth(fullScheduleMonth + 1);
                  }}
                  className="p-2 rounded-lg" style={{ backgroundColor: COLORS.surface }}
                >
                  <ChevronRight size={18} color={COLORS.text} />
                </button>
              </div>
              
              <div className="grid grid-cols-7 gap-1 mb-2">
                {['M', 'T', 'W', 'T', 'F', 'S', 'S'].map((d, i) => (
                  <div key={i} className="text-center text-xs py-2" style={{ color: COLORS.textMuted }}>{d}</div>
                ))}
              </div>
              <div className="grid grid-cols-7 gap-1">
                {/* Empty cells for days before month starts */}
                {[...Array(firstDay)].map((_, i) => (
                  <div key={`empty-${i}`} className="aspect-square" />
                ))}
                {/* Days of month */}
                {[...Array(daysInMonth)].map((_, i) => {
                  const day = i + 1;
                  const date = new Date(fullScheduleYear, fullScheduleMonth, day);
                  const dateKey = getLocalDateString(date);
                  const entry = masterSchedule[dateKey];
                  const isToday = fullScheduleYear === currentYear && fullScheduleMonth === currentMonth && day === today.getDate();
                  const isPast = date < today;

                  // Check if this date is before user's program start date
                  const isBeforeProgram = overviewStats.programStartDate && dateKey < overviewStats.programStartDate;

                  // Get short name from workout type
                  const getShortNameFromType = (type) => {
                    if (!type) return null;
                    const typeMap = {
                      push: 'Push', pull: 'Pull', legs_quad: 'Legs', legs_posterior: 'Legs',
                      upper: 'Upper', lower: 'Lower', full_body: 'Full', arms: 'Arms'
                    };
                    return typeMap[type] || type.charAt(0).toUpperCase() + type.slice(1);
                  };

                  const shortName = isBeforeProgram ? null : getShortNameFromType(entry?.workoutType);
                  const isMissed = isPast && entry?.workoutType && !entry?.completed && !isBeforeProgram;
                  // Get full workout for editing modal
                  const workout = entry?.workoutType ? getWorkoutForDate(dateKey) : null;

                  return (
                    <button
                      key={day}
                      onClick={() => {
                        if (!isBeforeProgram && !isPast) {
                          setEditingScheduleDay({
                            day: ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'][(date.getDay() + 6) % 7],
                            date: day,
                            month: fullScheduleMonth,
                            year: fullScheduleYear,
                            dateKey,
                            workout: workout,
                            workoutType: entry?.workoutType || null,
                            completed: entry?.completed || false,
                            isToday,
                            isPast
                          });
                        }
                      }}
                      disabled={isBeforeProgram || isPast}
                      className="aspect-square rounded-lg flex flex-col items-center justify-center p-1"
                      style={{
                        backgroundColor: isToday ? COLORS.primary + '30' : isBeforeProgram ? COLORS.surfaceLight : COLORS.surface,
                        border: isToday ? `2px solid ${COLORS.primary}` : 'none',
                        // Past rest days are considered completed, so full opacity
                        opacity: isBeforeProgram || isMissed ? 0.5 : 1
                      }}
                    >
                      <span className="text-xs" style={{ color: isToday ? COLORS.primary : isBeforeProgram ? COLORS.textMuted : COLORS.text }}>{day}</span>
                      {isBeforeProgram ? (
                        <span className="text-xs mt-0.5" style={{ color: COLORS.textMuted, fontSize: '7px' }}>-</span>
                      ) : isMissed ? (
                        <span className="text-xs mt-0.5" style={{ color: COLORS.textMuted, fontSize: '7px' }}>Missed</span>
                      ) : shortName ? (
                        <span
                          className="text-xs font-semibold mt-0.5 truncate w-full text-center"
                          style={{ color: getWorkoutColor(shortName, COLORS), fontSize: '8px' }}
                        >
                          {shortName}
                        </span>
                      ) : (
                        <span className="text-xs mt-0.5" style={{ color: COLORS.textMuted, fontSize: '8px' }}>Rest</span>
                      )}
                      {isPast && !isBeforeProgram && (entry?.completed || !entry?.workoutType) && (
                        <Check size={8} color={COLORS.success} />
                      )}
                    </button>
                  );
                })}
              </div>
              
              <p className="text-xs text-center mt-4" style={{ color: COLORS.textMuted }}>
                Tap any day to edit workout
              </p>
            </div>
          </div>
        );
      })()}

      {/* Schedule Day Editor Modal */}
      {editingScheduleDay && (() => {
        const editDate = new Date(editingScheduleDay.year, editingScheduleDay.month, editingScheduleDay.date);
        const todayStart = new Date(today);
        todayStart.setHours(0, 0, 0, 0);
        editDate.setHours(0, 0, 0, 0);
        const isPastDate = editDate < todayStart;

        return (
        <div className="fixed inset-0 z-50 flex flex-col" style={{ backgroundColor: COLORS.background }}>
          <div className="p-4 border-b flex items-center gap-3" style={{ borderColor: COLORS.surfaceLight }}>
            <button onClick={() => setEditingScheduleDay(null)}><X size={24} color={COLORS.text} /></button>
            <h2 className="text-lg font-bold" style={{ color: COLORS.text }}>
              {editingScheduleDay.day}, {['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'][editingScheduleDay.month]} {editingScheduleDay.date}
            </h2>
            {isPastDate && (
              <span className="text-xs px-2 py-1 rounded-full ml-auto" style={{ backgroundColor: COLORS.surfaceLight, color: COLORS.textMuted }}>
                Past
              </span>
            )}
          </div>
          <div className="flex-1 overflow-auto p-4">
            {/* Current Workout */}
            <div className="mb-6">
              <p className="text-xs font-semibold mb-2" style={{ color: COLORS.textMuted }}>{isPastDate ? 'WORKOUT' : 'CURRENT WORKOUT'}</p>
              <div className="p-4 rounded-xl" style={{ backgroundColor: COLORS.surface }}>
                {editingScheduleDay.workout ? (
                  <>
                    <div className="flex items-center gap-3 mb-4">
                      <div
                        className="w-12 h-12 rounded-xl flex items-center justify-center"
                        style={{ backgroundColor: getWorkoutColor(editingScheduleDay.workout.name, COLORS) + '20' }}
                      >
                        <Dumbbell size={24} color={getWorkoutColor(editingScheduleDay.workout.name, COLORS)} />
                      </div>
                      <div className="flex-1">
                        <p className="font-semibold" style={{ color: COLORS.text }}>{editingScheduleDay.workout.name}</p>
                        <p className="text-xs" style={{ color: COLORS.textMuted }}>{editingScheduleDay.workout.focus}  {editingScheduleDay.workout.exercises?.length || 0} exercises</p>
                      </div>
                    </div>
                    {/* Exercise List */}
                    {editingScheduleDay.workout.exercises && editingScheduleDay.workout.exercises.length > 0 && (
                      <div className="space-y-2 pt-3 border-t" style={{ borderColor: COLORS.surfaceLight }}>
                        {editingScheduleDay.workout.exercises.slice(0, 6).map((exercise, idx) => (
                          <div key={exercise.id || idx} className="flex items-center justify-between">
                            <div className="flex items-center gap-2">
                              <span className="w-5 h-5 rounded-full flex items-center justify-center text-xs" style={{ backgroundColor: getWorkoutColor(editingScheduleDay.workout.name, COLORS) + '20', color: getWorkoutColor(editingScheduleDay.workout.name, COLORS) }}>{idx + 1}</span>
                              <div>
                                <p className="text-sm" style={{ color: COLORS.text }}>{exercise.name}</p>
                                <p className="text-xs" style={{ color: COLORS.textMuted }}>{exercise.muscleGroup}</p>
                              </div>
                            </div>
                            <span className="text-xs" style={{ color: COLORS.textMuted }}>{exercise.sets}{exercise.targetReps}</span>
                          </div>
                        ))}
                        {editingScheduleDay.workout.exercises.length > 6 && (
                          <p className="text-xs text-center pt-2" style={{ color: COLORS.textMuted }}>
                            +{editingScheduleDay.workout.exercises.length - 6} more exercises
                          </p>
                        )}
                      </div>
                    )}
                  </>
                ) : (
                  <div className="flex items-center gap-3">
                    <div className="w-12 h-12 rounded-xl flex items-center justify-center" style={{ backgroundColor: COLORS.surfaceLight }}>
                      <Moon size={24} color={COLORS.textMuted} />
                    </div>
                    <div>
                      <p className="font-semibold" style={{ color: COLORS.text }}>Rest Day</p>
                      <p className="text-xs" style={{ color: COLORS.textMuted }}>Recovery and restoration</p>
                    </div>
                  </div>
                )}
              </div>
            </div>

            {/* Quick Actions - only for future/today with workout */}
            {!isPastDate && editingScheduleDay.workout && (
              <div className="mb-6">
                <p className="text-xs font-semibold mb-2" style={{ color: COLORS.textMuted }}>QUICK ACTIONS</p>
                <div className="grid grid-cols-2 gap-2">
                  <button
                    onClick={() => {
                      setShowWorkoutPreview(editingScheduleDay.workout);
                      setEditingScheduleDay(null);
                    }}
                    className="p-3 rounded-xl flex items-center gap-2"
                    style={{ backgroundColor: COLORS.surface }}
                  >
                    <Eye size={16} color={COLORS.primary} />
                    <span className="text-sm" style={{ color: COLORS.text }}>Preview</span>
                  </button>
                  <button
                    onClick={() => {
                      setWorkoutForDay(editingScheduleDay.dateKey, null);
                      setEditingScheduleDay({ ...editingScheduleDay, workout: null, workoutType: null });
                    }}
                    className="p-3 rounded-xl flex items-center gap-2"
                    style={{ backgroundColor: COLORS.surface }}
                  >
                    <X size={16} color={COLORS.error} />
                    <span className="text-sm" style={{ color: COLORS.text }}>Skip Day</span>
                  </button>
                </div>
              </div>
            )}

            {/* Change Workout - only for future/today */}
            {!isPastDate && (
              <div className="mb-6">
                <p className="text-xs font-semibold mb-2" style={{ color: COLORS.textMuted }}>CHANGE TO</p>
                <div className="space-y-2">
                  <button
                    onClick={() => {
                      setWorkoutForDay(editingScheduleDay.dateKey, null);
                      setEditingScheduleDay({ ...editingScheduleDay, workout: null, workoutType: null });
                    }}
                    className="w-full p-3 rounded-xl flex items-center gap-3"
                    style={{
                      backgroundColor: !editingScheduleDay.workoutType ? COLORS.primary + '20' : COLORS.surface,
                      border: !editingScheduleDay.workoutType ? `2px solid ${COLORS.primary}` : '2px solid transparent'
                    }}
                  >
                    <Moon size={18} color={COLORS.textMuted} />
                    <span style={{ color: COLORS.text }}>Rest Day</span>
                  </button>
                  {Object.entries(WORKOUT_STRUCTURES).map(([typeId, structure]) => (
                    <button
                      key={typeId}
                      onClick={() => {
                        setWorkoutForDay(editingScheduleDay.dateKey, typeId);
                        const newWorkout = generateDynamicWorkout(typeId, userGoal, recentlyUsedExercises, userData.experience, ALL_EXERCISES, userData);
                        setEditingScheduleDay({ ...editingScheduleDay, workout: newWorkout, workoutType: typeId });
                      }}
                      className="w-full p-3 rounded-xl flex items-center gap-3"
                      style={{
                        backgroundColor: editingScheduleDay.workoutType === typeId ? COLORS.primary + '20' : COLORS.surface,
                        border: editingScheduleDay.workoutType === typeId ? `2px solid ${COLORS.primary}` : '2px solid transparent'
                      }}
                    >
                      <div
                        className="w-8 h-8 rounded-lg flex items-center justify-center"
                        style={{ backgroundColor: getWorkoutColor(structure.name, COLORS) + '20' }}
                      >
                        <Dumbbell size={14} color={getWorkoutColor(structure.name, COLORS)} />
                      </div>
                      <div className="flex-1 text-left">
                        <p className="font-semibold text-sm" style={{ color: COLORS.text }}>{structure.name}</p>
                        <p className="text-xs" style={{ color: COLORS.textMuted }}>{structure.focus}</p>
                      </div>
                      {editingScheduleDay.workoutType === typeId && (
                        <Check size={18} color={COLORS.primary} />
                      )}
                    </button>
                  ))}
                </div>
              </div>
            )}

            {/* Swap with Another Day - only for future/today */}
            {!isPastDate && (
              <div className="mb-6">
                <div className="flex items-center gap-2 mb-2">
                  <ArrowLeftRight size={14} color={COLORS.textMuted} />
                  <p className="text-xs font-semibold" style={{ color: COLORS.textMuted }}>SWAP WITH NEARBY DAY</p>
                </div>
                <div className="flex gap-2 overflow-x-auto pb-2">
                  {[-3, -2, -1, 1, 2, 3].map(offset => {
                    const date = new Date(editingScheduleDay.year, editingScheduleDay.month, editingScheduleDay.date + offset);
                    const dateKey = getLocalDateString(date);
                    const entry = masterSchedule[dateKey];
                    const dayNames = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];

                    return (
                      <button
                        key={offset}
                        onClick={() => {
                          swapWorkoutDays(editingScheduleDay.dateKey, dateKey);
                          setEditingScheduleDay(null);
                        }}
                        className="flex-shrink-0 p-3 rounded-xl text-center"
                        style={{ backgroundColor: COLORS.surface, minWidth: '80px' }}
                      >
                        <p className="text-xs" style={{ color: COLORS.textMuted }}>{dayNames[(date.getDay() + 6) % 7]}</p>
                        <p className="font-bold" style={{ color: COLORS.text }}>{date.getDate()}</p>
                        {entry?.workoutType ? (
                          <p className="text-xs mt-1" style={{ color: getWorkoutColor(WORKOUT_STRUCTURES[entry.workoutType]?.name || 'Workout', COLORS) }}>
                            {WORKOUT_STRUCTURES[entry.workoutType]?.name?.split(' ')[0] || entry.workoutType}
                          </p>
                        ) : (
                          <p className="text-xs mt-1" style={{ color: COLORS.textMuted }}>Rest</p>
                        )}
                      </button>
                    );
                  })}
                </div>
              </div>
            )}

            {/* Past Day Options */}
            {isPastDate && (
              <div className="mb-6">
                <p className="text-xs font-semibold mb-2" style={{ color: COLORS.textMuted }}>LOG THIS DAY</p>

                {/* Completion Status Toggle */}
                <div className="p-4 rounded-xl mb-3" style={{ backgroundColor: COLORS.surface }}>
                  <div className="flex items-center justify-between">
                    <div className="flex items-center gap-3">
                      {editingScheduleDay.completed ? (
                        <div className="w-10 h-10 rounded-full flex items-center justify-center" style={{ backgroundColor: COLORS.success + '20' }}>
                          <Check size={20} color={COLORS.success} />
                        </div>
                      ) : (
                        <div className="w-10 h-10 rounded-full flex items-center justify-center" style={{ backgroundColor: COLORS.surfaceLight }}>
                          <X size={20} color={COLORS.textMuted} />
                        </div>
                      )}
                      <div>
                        <p className="font-semibold" style={{ color: COLORS.text }}>
                          {editingScheduleDay.completed ? 'Completed' : 'Not Completed'}
                        </p>
                        <p className="text-xs" style={{ color: COLORS.textMuted }}>
                          {editingScheduleDay.completed ? 'Great work!' : 'Mark as complete if you did this workout'}
                        </p>
                      </div>
                    </div>
                    <button
                      onClick={() => {
                        const newCompleted = !editingScheduleDay.completed;
                        setMasterSchedule(prev => ({
                          ...prev,
                          [editingScheduleDay.dateKey]: {
                            ...prev[editingScheduleDay.dateKey],
                            completed: newCompleted
                          }
                        }));
                        setEditingScheduleDay({ ...editingScheduleDay, completed: newCompleted });
                      }}
                      className="px-4 py-2 rounded-lg font-semibold text-sm"
                      style={{
                        backgroundColor: editingScheduleDay.completed ? COLORS.error + '20' : COLORS.success + '20',
                        color: editingScheduleDay.completed ? COLORS.error : COLORS.success
                      }}
                    >
                      {editingScheduleDay.completed ? 'Undo' : 'Mark Done'}
                    </button>
                  </div>
                </div>

                {/* Change Workout for Past Day */}
                <p className="text-xs font-semibold mb-2 mt-4" style={{ color: COLORS.textMuted }}>CHANGE WORKOUT</p>
                <div className="space-y-2">
                  <button
                    onClick={() => {
                      setWorkoutForDay(editingScheduleDay.dateKey, null);
                      setEditingScheduleDay({ ...editingScheduleDay, workout: null, workoutType: null });
                    }}
                    className="w-full p-3 rounded-xl flex items-center gap-3"
                    style={{
                      backgroundColor: !editingScheduleDay.workoutType ? COLORS.primary + '20' : COLORS.surface,
                      border: !editingScheduleDay.workoutType ? `2px solid ${COLORS.primary}` : '2px solid transparent'
                    }}
                  >
                    <Moon size={18} color={COLORS.textMuted} />
                    <span style={{ color: COLORS.text }}>Rest Day</span>
                  </button>
                  {Object.entries(WORKOUT_STRUCTURES).map(([typeId, structure]) => (
                    <button
                      key={typeId}
                      onClick={() => {
                        setWorkoutForDay(editingScheduleDay.dateKey, typeId);
                        const newWorkout = generateDynamicWorkout(typeId, userGoal, recentlyUsedExercises, userData.experience, ALL_EXERCISES, userData);
                        setEditingScheduleDay({ ...editingScheduleDay, workout: newWorkout, workoutType: typeId });
                      }}
                      className="w-full p-3 rounded-xl flex items-center gap-3"
                      style={{
                        backgroundColor: editingScheduleDay.workoutType === typeId ? COLORS.primary + '20' : COLORS.surface,
                        border: editingScheduleDay.workoutType === typeId ? `2px solid ${COLORS.primary}` : '2px solid transparent'
                      }}
                    >
                      <div
                        className="w-8 h-8 rounded-lg flex items-center justify-center"
                        style={{ backgroundColor: getWorkoutColor(structure.name, COLORS) + '20' }}
                      >
                        <Dumbbell size={14} color={getWorkoutColor(structure.name, COLORS)} />
                      </div>
                      <div className="flex-1 text-left">
                        <p className="font-semibold text-sm" style={{ color: COLORS.text }}>{structure.name}</p>
                        <p className="text-xs" style={{ color: COLORS.textMuted }}>{structure.focus}</p>
                      </div>
                      {editingScheduleDay.workoutType === typeId && (
                        <Check size={18} color={COLORS.primary} />
                      )}
                    </button>
                  ))}
                </div>
              </div>
            )}
          </div>
          <div className="p-4 border-t" style={{ borderColor: COLORS.surfaceLight }}>
            <button
              onClick={() => setEditingScheduleDay(null)}
              className="w-full py-4 rounded-xl font-semibold"
              style={{ backgroundColor: COLORS.primary, color: COLORS.text }}
            >
              Done
            </button>
          </div>
        </div>
        );
      })()}

      {/* Workout Summary Modal */}
      {showWorkoutSummary && (
        <div className="fixed inset-0 z-50 flex flex-col" style={{ backgroundColor: COLORS.background }}>
          <div className="p-4 border-b flex items-center gap-3" style={{ borderColor: COLORS.surfaceLight }}>
            <button onClick={() => setShowWorkoutSummary(null)}><X size={24} color={COLORS.text} /></button>
            <h2 className="text-lg font-bold" style={{ color: COLORS.text }}>Workout Summary</h2>
          </div>
          <div className="flex-1 overflow-auto p-4">
            <div className="text-center mb-6">
              <div className="w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-3" style={{ backgroundColor: COLORS.success + '20' }}>
                <Check size={32} color={COLORS.success} />
              </div>
              <h3 className="text-xl font-bold" style={{ color: COLORS.text }}>{showWorkoutSummary.workout.name}</h3>
              <p className="text-sm" style={{ color: COLORS.textMuted }}>{showWorkoutSummary.date}</p>
            </div>

            <div className="grid grid-cols-3 gap-3 mb-6">
              <div className="p-3 rounded-xl text-center" style={{ backgroundColor: COLORS.surface }}>
                <p className="text-2xl font-bold" style={{ color: COLORS.primary }}>{showWorkoutSummary.duration}</p>
                <p className="text-xs" style={{ color: COLORS.textMuted }}>minutes</p>
              </div>
              <div className="p-3 rounded-xl text-center" style={{ backgroundColor: COLORS.surface }}>
                <p className="text-2xl font-bold" style={{ color: COLORS.accent }}>{showWorkoutSummary.exercises}</p>
                <p className="text-xs" style={{ color: COLORS.textMuted }}>exercises</p>
              </div>
              <div className="p-3 rounded-xl text-center" style={{ backgroundColor: COLORS.surface }}>
                <p className="text-2xl font-bold" style={{ color: COLORS.warning }}>{(showWorkoutSummary.totalVolume / 1000).toFixed(1)}k</p>
                <p className="text-xs" style={{ color: COLORS.textMuted }}>kg volume</p>
              </div>
            </div>

            <h4 className="font-semibold mb-3" style={{ color: COLORS.text }}>Exercises Completed</h4>
            <div className="space-y-2">
              {showWorkoutSummary.workout.exercises.map((ex, i) => (
                <div key={i} className="p-3 rounded-xl flex items-center justify-between" style={{ backgroundColor: COLORS.surface }}>
                  <div className="flex items-center gap-3">
                    <div className="w-8 h-8 rounded-full flex items-center justify-center" style={{ backgroundColor: COLORS.success + '20' }}>
                      <Check size={14} color={COLORS.success} />
                    </div>
                    <div>
                      <p className="font-semibold text-sm" style={{ color: COLORS.text }}>{ex.name}</p>
                      <p className="text-xs" style={{ color: COLORS.textMuted }}>{ex.muscleGroup}</p>
                    </div>
                  </div>
                  <div className="text-right">
                    <p className="text-sm font-semibold" style={{ color: COLORS.text }}>{ex.sets}  {ex.targetReps}</p>
                    <p className="text-xs" style={{ color: COLORS.textMuted }}>{ex.suggestedWeight}kg</p>
                  </div>
                </div>
              ))}
            </div>

            {/* Publish to Community Option */}
            <div className="mt-6 p-4 rounded-xl" style={{ backgroundColor: COLORS.primary + '10', border: `1px solid ${COLORS.primary}30` }}>
              <div className="flex items-center gap-3 mb-3">
                <Upload size={20} color={COLORS.primary} />
                <div className="flex-1">
                  <p className="font-semibold" style={{ color: COLORS.text }}>Share this workout</p>
                  <p className="text-xs" style={{ color: COLORS.textMuted }}>Let others try your routine</p>
                </div>
              </div>
              <button
                onClick={() => {
                  // Set up publish modal with this workout's data
                  setWorkoutToPublish({
                    name: showWorkoutSummary.workout.name,
                    focus: showWorkoutSummary.workout.focus || 'general',
                    exercises: showWorkoutSummary.workout.exercises,
                  });
                  setPublishDescription('');
                  setShowPublishModal(true);
                  setShowWorkoutSummary(null);
                }}
                className="w-full py-3 rounded-xl font-semibold flex items-center justify-center gap-2"
                style={{ backgroundColor: COLORS.primary, color: COLORS.text }}
              >
                <Upload size={16} /> Publish to Community
              </button>
            </div>
          </div>
        </div>
      )}

      {/* Exercise Detail Modal */}
      {showExerciseDetail && (() => {
        const exerciseInfo = ALL_EXERCISES.find(e => e.name === showExerciseDetail);
        const pr = personalRecords.find(p => p.exercise === showExerciseDetail);
        return (
          <div className="fixed inset-0 z-50 flex flex-col" style={{ backgroundColor: COLORS.background }}>
            <div className="p-4 border-b flex items-center gap-3" style={{ borderColor: COLORS.surfaceLight }}>
              <button onClick={() => setShowExerciseDetail(null)}><X size={24} color={COLORS.text} /></button>
              <h2 className="text-lg font-bold" style={{ color: COLORS.text }}>{showExerciseDetail}</h2>
            </div>
            <div className="flex-1 overflow-auto p-4">
              {exerciseInfo && (
                <div className="p-4 rounded-xl mb-4" style={{ backgroundColor: COLORS.surface }}>
                  <div className="flex justify-between items-center mb-2">
                    <span className="text-sm" style={{ color: COLORS.textMuted }}>Muscle Group</span>
                    <span className="font-semibold" style={{ color: COLORS.text }}>{exerciseInfo.muscleGroup}</span>
                  </div>
                  <div className="flex justify-between items-center mb-2">
                    <span className="text-sm" style={{ color: COLORS.textMuted }}>Equipment</span>
                    <span className="font-semibold" style={{ color: COLORS.text }}>{exerciseInfo.equipment}</span>
                  </div>
                  <div className="flex justify-between items-center">
                    <span className="text-sm" style={{ color: COLORS.textMuted }}>Type</span>
                    <span className="font-semibold capitalize" style={{ color: COLORS.text }}>{exerciseInfo.type}</span>
                  </div>
                </div>
              )}

              {pr && (
                <div className="p-4 rounded-xl mb-4" style={{ backgroundColor: COLORS.warning + '15', border: `1px solid ${COLORS.warning}40` }}>
                  <div className="flex items-center gap-2 mb-2">
                    <Trophy size={18} color={COLORS.warning} />
                    <span className="font-semibold" style={{ color: COLORS.warning }}>Personal Record</span>
                  </div>
                  <div className="flex justify-between items-center">
                    <div>
                      <p className="text-2xl font-bold" style={{ color: COLORS.text }}>{pr.weight}kg  {pr.reps}</p>
                      <p className="text-xs" style={{ color: COLORS.textMuted }}>{pr.date}</p>
                    </div>
                    {pr.e1rm > 0 && (
                      <div className="text-right">
                        <p className="text-lg font-bold" style={{ color: COLORS.primary }}>{pr.e1rm}kg</p>
                        <p className="text-xs" style={{ color: COLORS.textMuted }}>Est. 1RM</p>
                      </div>
                    )}
                  </div>
                </div>
              )}

              <h4 className="font-semibold mb-3" style={{ color: COLORS.text }}>Progress Chart</h4>
              <div className="p-4 rounded-xl" style={{ backgroundColor: COLORS.surface }}>
                <div className="h-32 flex flex-col items-center justify-center">
                  <TrendingUp size={32} color={COLORS.textMuted} style={{ opacity: 0.5 }} />
                  <p className="text-sm mt-2" style={{ color: COLORS.textMuted }}>No progress data yet</p>
                  <p className="text-xs" style={{ color: COLORS.textMuted }}>Complete workouts to track your progress</p>
                </div>
              </div>

              <h4 className="font-semibold mt-4 mb-3" style={{ color: COLORS.text }}>Recent Sessions</h4>
              <div className="p-4 rounded-xl" style={{ backgroundColor: COLORS.surface }}>
                <div className="flex flex-col items-center justify-center py-4">
                  <Dumbbell size={32} color={COLORS.textMuted} style={{ opacity: 0.5 }} />
                  <p className="text-sm mt-2" style={{ color: COLORS.textMuted }}>No sessions recorded</p>
                  <p className="text-xs text-center" style={{ color: COLORS.textMuted }}>Your workout history for this exercise will appear here</p>
                </div>
              </div>

              <h4 className="font-semibold mt-4 mb-3" style={{ color: COLORS.text }}>Tips</h4>
              <div className="p-4 rounded-xl" style={{ backgroundColor: COLORS.primary + '10', border: `1px solid ${COLORS.primary}20` }}>
                <div className="space-y-2">
                  <div className="flex items-start gap-2">
                    <div className="w-1.5 h-1.5 rounded-full mt-1.5" style={{ backgroundColor: COLORS.primary }} />
                    <p className="text-sm" style={{ color: COLORS.text }}>Start with a weight you can control for all reps</p>
                  </div>
                  <div className="flex items-start gap-2">
                    <div className="w-1.5 h-1.5 rounded-full mt-1.5" style={{ backgroundColor: COLORS.primary }} />
                    <p className="text-sm" style={{ color: COLORS.text }}>Focus on form before increasing weight</p>
                  </div>
                  <div className="flex items-start gap-2">
                    <div className="w-1.5 h-1.5 rounded-full mt-1.5" style={{ backgroundColor: COLORS.primary }} />
                    <p className="text-sm" style={{ color: COLORS.text }}>Log your sets to track progressive overload</p>
                  </div>
                </div>
              </div>
            </div>
          </div>
        );
      })()}

      {/* Active Workout Screen - rendered at MainScreen level for access from all tabs */}
      {showActiveWorkout && (() => {
        // Check if resuming a partial workout
        if (partialWorkoutProgress) {
          return (
            <ActiveWorkoutScreen
              onClose={() => setShowActiveWorkout(false)}
              onComplete={() => { setPartialWorkoutProgress(null); completeTodayWorkout(); }}
              onSaveProgress={setPartialWorkoutProgress}
              COLORS={COLORS}
              availableTime={workoutTime}
              userGoal={userData.goal || 'build_muscle'}
              userExperience={userData.experience || 'beginner'}
              userId={user?.id}
              workoutName={partialWorkoutProgress.workoutName || todayWorkout?.name || 'Workout'}
              workoutTemplate={{ exercises: partialWorkoutProgress.exercises }}
              injuries={injuries}
              includeWarmup={personalWarmup}
              includeCooldown={personalCooldown}
              savedProgress={partialWorkoutProgress}
            />
          );
        }

        // Get exercises exactly as shown in the workout card
        const filteredExercises = getCurrentExercises();
        const recoveryExercises = getInjuryRecoveryExercisesToAdd();
        const baseExercises = [...filteredExercises, ...recoveryExercises];
        const fullPool = todayWorkoutTemplate?.exercises || baseExercises;

        // Apply same time/count optimization as displayed
        const defaultExerciseCount = Math.max(2, Math.floor(workoutTime / 12));
        const exerciseCount = customExerciseCount || defaultExerciseCount;
        const workoutTypeForCoverage = todayWorkoutTemplate?.workoutType || todayWorkout?.type || null;
        const optimizedExercises = optimizeExercisesForTimeAndCount(baseExercises, fullPool, workoutTime, exerciseCount, workoutTypeForCoverage, settings.workout.corePosition, personalWarmup, personalCooldown, !!customizedExercises);

        const template = { ...todayWorkoutTemplate, exercises: optimizedExercises };
        return (
          <ActiveWorkoutScreen
            onClose={() => setShowActiveWorkout(false)}
            onComplete={() => { setPartialWorkoutProgress(null); completeTodayWorkout(); }}
            onSaveProgress={setPartialWorkoutProgress}
            COLORS={COLORS}
            availableTime={workoutTime}
            userGoal={userData.goal || 'build_muscle'}
            userExperience={userData.experience || 'beginner'}
            userId={user?.id}
            workoutName={todayWorkout?.name || 'Workout'}
            workoutTemplate={template}
            injuries={injuries}
            includeWarmup={personalWarmup}
            includeCooldown={personalCooldown}
          />
        );
      })()}

      {/* Reschedule Modal - rendered at MainScreen level for access from all tabs */}
      {showReschedule && <RescheduleModal />}
      
      {/* Pause Plan Modal - rendered at MainScreen level for access from all tabs */}
      {showPausePlan && <PausePlanModal />}

      {/* Report Injury Modal */}
      {showReportInjury && <ReportInjuryModal />}

      {/* Injury Recovery Screen */}
      {showInjuryRecovery && <InjuryRecoveryScreen injury={showInjuryRecovery} />}

      {/* Full Meal Entry Modal */}
      {showAddMealFull && (
        <FullMealEntryModal
          COLORS={COLORS}
          foods={allFoods}
          frequentMeals={frequentMealsForModal}
          onClose={() => setShowAddMealFull(false)}
          onSave={async (meal) => {
            const targetDate = nutritionSelectedDate !== TODAY_DATE_KEY ? nutritionSelectedDate : null;
            if (targetDate) {
              // Backdate meal entry
              if (user?.id) {
                const { data } = await nutritionService.logMeal(user.id, {
                  date: targetDate,
                  name: meal.name,
                  time: meal.time,
                  calories: meal.calories,
                  protein: meal.protein,
                  carbs: meal.carbs,
                  fats: meal.fats,
                });
                const savedMeal = data ? {
                  id: data.id,
                  name: data.meal_name,
                  time: data.meal_time,
                  calories: data.calories,
                  protein: data.protein,
                  carbs: data.carbs,
                  fats: data.fats,
                } : meal;
                setBackdateNutrition(prev => prev ? {
                  ...prev,
                  calories: (prev.calories || 0) + meal.calories,
                  protein: (prev.protein || 0) + meal.protein,
                  carbs: (prev.carbs || 0) + meal.carbs,
                  fats: (prev.fats || 0) + meal.fats,
                  meals: [...(prev.meals || []), savedMeal],
                } : {
                  calories: meal.calories,
                  protein: meal.protein,
                  carbs: meal.carbs,
                  fats: meal.fats,
                  water: 0,
                  meals: [savedMeal],
                });
              }
            } else {
              // Today's meal - optimistic update
              const tempId = `temp-${Date.now()}`;
              const tempMeal = { ...meal, id: tempId };
              setMealLog(prev => [...prev, tempMeal]);
              setCaloriesIntake(prev => prev + meal.calories);
              setProteinIntake(prev => prev + meal.protein);
              setCarbsIntake(prev => prev + meal.carbs);
              setFatsIntake(prev => prev + meal.fats);

              // Save to database in background and update with real ID
              if (user?.id) {
                nutritionService.logMeal(user.id, {
                  name: meal.name,
                  time: meal.time,
                  calories: meal.calories,
                  protein: meal.protein,
                  carbs: meal.carbs,
                  fats: meal.fats,
                }).then(({ data, error }) => {
                  if (error || !data) {
                    // Rollback optimistic update on failure
                    setMealLog(prev => prev.filter(m => m.id !== tempId));
                    setCaloriesIntake(prev => prev - meal.calories);
                    setProteinIntake(prev => prev - meal.protein);
                    setCarbsIntake(prev => prev - meal.carbs);
                    setFatsIntake(prev => prev - meal.fats);
                    console.error('Failed to save meal:', error?.message);
                    return;
                  }
                  setMealLog(prev => prev.map(m => m.id === tempId ? {
                    id: data.id,
                    name: data.meal_name,
                    time: data.meal_time,
                    calories: data.calories,
                    protein: data.protein,
                    carbs: data.carbs,
                    fats: data.fats,
                  } : m));
                }).catch(err => {
                  // Rollback on network/unexpected error
                  setMealLog(prev => prev.filter(m => m.id !== tempId));
                  setCaloriesIntake(prev => prev - meal.calories);
                  setProteinIntake(prev => prev - meal.protein);
                  setCarbsIntake(prev => prev - meal.carbs);
                  setFatsIntake(prev => prev - meal.fats);
                  console.error('Failed to save meal:', err);
                });
              }
            }
            setShowAddMealFull(false);
          }}
        />
      )}

      {/* Meal History Modal */}
      {showMealHistory && (
        <div className="fixed inset-0 z-50 flex items-end justify-center" style={{ backgroundColor: 'rgba(0,0,0,0.2)' }}>
          <div className="w-full max-w-md rounded-t-3xl p-6 max-h-[85vh] overflow-y-auto" style={{ backgroundColor: COLORS.surface }}>
            <div className="flex items-center justify-between mb-4">
              <h3 className="text-lg font-bold" style={{ color: COLORS.text }}>
                {nutritionSelectedDate === TODAY_DATE_KEY ? "Today's Meals" : `Meals - ${new Date(nutritionSelectedDate).toLocaleDateString('en-US', { month: 'short', day: 'numeric' })}`}
              </h3>
              <button onClick={() => setShowMealHistory(false)} className="p-2 rounded-full" style={{ backgroundColor: COLORS.surfaceLight }}>
                <X size={20} color={COLORS.textMuted} />
              </button>
            </div>

            {/* Meal List */}
            <div className="space-y-3 mb-4">
              {(nutritionSelectedDate === TODAY_DATE_KEY ? mealLog : (backdateNutrition?.meals || [])).length > 0 ? (
                (nutritionSelectedDate === TODAY_DATE_KEY ? mealLog : (backdateNutrition?.meals || [])).map((meal, idx) => (
                  <div key={meal.id || idx} className="p-4 rounded-xl" style={{ backgroundColor: COLORS.surfaceLight }}>
                    <div className="flex justify-between items-start">
                      <div className="flex-1">
                        <p className="font-semibold" style={{ color: COLORS.text }}>{meal.name}</p>
                        <p className="text-xs" style={{ color: COLORS.textMuted }}>
                          {(() => {
                            if (!meal.time) return '';
                            const [hours, minutes] = meal.time.split(':');
                            const h = parseInt(hours, 10);
                            const ampm = h >= 12 ? 'pm' : 'am';
                            const h12 = h % 12 || 12;
                            return `${h12}:${minutes} ${ampm}`;
                          })()}
                        </p>
                        <div className="flex gap-3 mt-2">
                          <span className="text-xs" style={{ color: COLORS.accent }}>{meal.calories} cal</span>
                          <span className="text-xs" style={{ color: COLORS.primary }}>{meal.protein}g P</span>
                          <span className="text-xs" style={{ color: COLORS.warning }}>{meal.carbs}g C</span>
                        </div>
                      </div>
                      <button
                        onClick={async () => {
                          if (!user?.id || !meal.id) return;
                          const targetDate = nutritionSelectedDate !== TODAY_DATE_KEY ? nutritionSelectedDate : TODAY_DATE_KEY;
                          await nutritionService.deleteMeal(meal.id, user.id, targetDate);

                          if (nutritionSelectedDate === TODAY_DATE_KEY) {
                            setMealLog(prev => prev.filter(m => m.id !== meal.id));
                            setCaloriesIntake(prev => prev - meal.calories);
                            setProteinIntake(prev => prev - meal.protein);
                            setCarbsIntake(prev => prev - meal.carbs);
                            setFatsIntake(prev => prev - meal.fats);
                          } else {
                            setBackdateNutrition(prev => prev ? {
                              ...prev,
                              calories: (prev.calories || 0) - meal.calories,
                              protein: (prev.protein || 0) - meal.protein,
                              carbs: (prev.carbs || 0) - meal.carbs,
                              fats: (prev.fats || 0) - meal.fats,
                              meals: (prev.meals || []).filter(m => m.id !== meal.id),
                            } : null);
                          }
                        }}
                        className="p-2 rounded-lg"
                        style={{ backgroundColor: COLORS.error + '20' }}
                      >
                        <Trash2 size={16} color={COLORS.error} />
                      </button>
                    </div>
                  </div>
                ))
              ) : (
                <div className="text-center py-8">
                  <Utensils size={32} color={COLORS.textMuted} className="mx-auto mb-2" />
                  <p className="text-sm" style={{ color: COLORS.textMuted }}>No meals logged yet</p>
                </div>
              )}
            </div>

            {/* Add Meal Button */}
            <button
              onClick={() => {
                setShowMealHistory(false);
                setShowAddMealFull(true);
              }}
              className="w-full py-3 rounded-xl font-semibold flex items-center justify-center gap-2"
              style={{ backgroundColor: COLORS.accent, color: COLORS.text }}
            >
              <Plus size={18} />
              Add Meal
            </button>
          </div>
        </div>
      )}

      {/* Water History Modal */}
      {showWaterHistory && (
        <div className="fixed inset-0 z-50 flex items-end justify-center" style={{ backgroundColor: 'rgba(0,0,0,0.2)' }}>
          <div className="w-full max-w-md rounded-t-3xl p-6 max-h-[85vh] overflow-y-auto" style={{ backgroundColor: COLORS.surface }}>
            <div className="flex items-center justify-between mb-4">
              <h3 className="text-lg font-bold" style={{ color: COLORS.text }}>
                {nutritionSelectedDate === TODAY_DATE_KEY ? "Today's Water" : `Water - ${new Date(nutritionSelectedDate).toLocaleDateString('en-US', { month: 'short', day: 'numeric' })}`}
              </h3>
              <button onClick={() => setShowWaterHistory(false)} className="p-2 rounded-full" style={{ backgroundColor: COLORS.surfaceLight }}>
                <X size={20} color={COLORS.textMuted} />
              </button>
            </div>

            {/* Total Summary */}
            <div className="p-4 rounded-xl mb-4" style={{ backgroundColor: COLORS.water + '15' }}>
              <div className="flex items-center justify-between">
                <div className="flex items-center gap-3">
                  <Droplets size={24} color={COLORS.water} />
                  <div>
                    <p className="text-sm" style={{ color: COLORS.textMuted }}>Total</p>
                    <p className="text-xl font-bold" style={{ color: COLORS.water }}>
                      {((nutritionSelectedDate === TODAY_DATE_KEY ? waterIntake : (backdateNutrition?.water || 0)) / 1000).toFixed(1)}L
                    </p>
                  </div>
                </div>
                <div className="text-right">
                  <p className="text-sm" style={{ color: COLORS.textMuted }}>Goal</p>
                  <p className="text-lg font-semibold" style={{ color: COLORS.text }}>{(adjustedNutritionGoals.water / 1000).toFixed(1)}L</p>
                </div>
              </div>
            </div>

            {/* Water Entries List */}
            <p className="text-xs font-semibold mb-2" style={{ color: COLORS.textMuted }}>ENTRIES</p>
            <div className="space-y-2 mb-4">
              {waterLogs.length > 0 ? (
                waterLogs.map((log, idx) => (
                  <div key={log.id || idx} className="p-3 rounded-xl flex items-center justify-between" style={{ backgroundColor: COLORS.surfaceLight }}>
                    <div className="flex items-center gap-3">
                      <div className="w-8 h-8 rounded-full flex items-center justify-center" style={{ backgroundColor: COLORS.water + '20' }}>
                        <Droplets size={14} color={COLORS.water} />
                      </div>
                      <div>
                        <p className="font-semibold" style={{ color: COLORS.text }}>{log.amount_ml}ml</p>
                        <p className="text-xs" style={{ color: COLORS.textMuted }}>
                          {new Date(log.logged_at || log.created_at).toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' })}
                        </p>
                      </div>
                    </div>
                    <button
                      onClick={async (e) => {
                        e.preventDefault();
                        e.stopPropagation();
                        if (!user?.id || !log.id) return;

                        // Delete water log from database
                        const { error } = await supabase
                          .from('water_logs')
                          .delete()
                          .eq('id', log.id);

                        if (!error) {
                          // Update local state
                          setWaterLogs(prev => prev.filter(l => l.id !== log.id));

                          // Update today's intake or backdate nutrition
                          if (nutritionSelectedDate === TODAY_DATE_KEY) {
                            setWaterIntake(prev => Math.max(0, prev - log.amount_ml));
                          } else {
                            setBackdateNutrition(prev => prev ? {
                              ...prev,
                              water: Math.max(0, (prev.water || 0) - log.amount_ml),
                            } : null);
                          }
                        } else {
                          console.error('Error deleting water log:', error);
                          alert('Failed to delete water entry');
                        }
                      }}
                      className="p-2 rounded-lg"
                      style={{ backgroundColor: COLORS.error + '20' }}
                    >
                      <Trash2 size={14} color={COLORS.error} />
                    </button>
                  </div>
                ))
              ) : (
                <div className="text-center py-6">
                  <Droplets size={32} color={COLORS.textMuted} className="mx-auto mb-2" />
                  <p className="text-sm" style={{ color: COLORS.textMuted }}>No water logged yet</p>
                </div>
              )}
            </div>

            {/* Quick Add Buttons */}
            <p className="text-xs font-semibold mb-2" style={{ color: COLORS.textMuted }}>QUICK ADD</p>
            <div className="grid grid-cols-4 gap-2">
              {[
                { label: '1 Cup', amount: 250 },
                { label: '500ml', amount: 500 },
                { label: '1L', amount: 1000 },
              ].map(opt => (
                <button
                  key={opt.amount}
                  onClick={async () => {
                    const targetDate = nutritionSelectedDate !== TODAY_DATE_KEY ? nutritionSelectedDate : null;
                    if (targetDate) {
                      if (user?.id) {
                        const { data } = await nutritionService.logWater(user.id, opt.amount, targetDate);
                        if (data) {
                          setWaterLogs(prev => [...prev, data]);
                          setBackdateNutrition(prev => prev ? {
                            ...prev,
                            water: (prev.water || 0) + opt.amount,
                          } : { water: opt.amount, calories: 0, protein: 0, carbs: 0, fats: 0, meals: [] });
                        }
                      }
                    } else {
                      if (user?.id) {
                        const { data } = await nutritionService.logWater(user.id, opt.amount);
                        if (data) {
                          setWaterLogs(prev => [...prev, data]);
                          setWaterIntake(prev => Math.min(prev + opt.amount, 10000));
                        }
                      }
                    }
                  }}
                  className="py-2 rounded-lg text-center"
                  style={{ backgroundColor: COLORS.water + '15', border: `1px solid ${COLORS.water}30` }}
                >
                  <p className="text-sm font-bold" style={{ color: COLORS.water }}>{opt.label}</p>
                </button>
              ))}
              <button
                onClick={() => {
                  setShowWaterHistory(false);
                  setShowWaterEntry(true);
                }}
                className="py-2 rounded-lg"
                style={{ backgroundColor: COLORS.surfaceLight }}
              >
                <p className="text-sm font-semibold" style={{ color: COLORS.textMuted }}>+</p>
              </button>
            </div>
          </div>
        </div>
      )}

      {/* Supplement History Modal */}
      {showSupplementHistory && (
        <div className="fixed inset-0 z-50 flex items-end justify-center" style={{ backgroundColor: 'rgba(0,0,0,0.2)' }}>
          <div className="w-full max-w-md rounded-t-3xl p-6 max-h-[85vh] overflow-y-auto" style={{ backgroundColor: COLORS.surface }}>
            <div className="flex items-center justify-between mb-4">
              <h3 className="text-lg font-bold" style={{ color: COLORS.text }}>
                Today's Supplements
              </h3>
              <button onClick={() => setShowSupplementHistory(false)} className="p-2 rounded-full" style={{ backgroundColor: COLORS.surfaceLight }}>
                <X size={20} color={COLORS.textMuted} />
              </button>
            </div>

            {/* Supplement List */}
            <div className="space-y-3 mb-4">
              {supplements.length > 0 ? (
                supplements.map(supp => (
                  <div
                    key={supp.id}
                    className="p-4 rounded-xl flex items-center justify-between"
                    style={{ backgroundColor: supp.taken ? COLORS.supplements + '15' : COLORS.surfaceLight }}
                  >
                    <div
                      className="flex items-center gap-3 flex-1 cursor-pointer"
                      onClick={async () => {
                        if (supplementsLoading) return;
                        const newTakenState = !supp.taken;

                        // Update UI immediately
                        setSupplements(prev => prev.map(s => s.id === supp.id ? {...s, taken: newTakenState} : s));

                        // Save to database
                        if (user?.id) {
                          if (newTakenState) {
                            await nutritionService.logSupplement(user.id, supp.id, TODAY_DATE_KEY);
                          } else {
                            await nutritionService.deleteSupplement(user.id, supp.id, TODAY_DATE_KEY);
                          }
                        }
                      }}
                    >
                      <div
                        className="w-10 h-10 rounded-full flex items-center justify-center"
                        style={{ backgroundColor: supp.taken ? COLORS.supplements : COLORS.surface }}
                      >
                        {supp.taken ? (
                          <Check size={20} color={COLORS.text} />
                        ) : (
                          <Zap size={20} color={COLORS.supplements} />
                        )}
                      </div>
                      <div className="flex-1">
                        <p className="font-semibold" style={{ color: COLORS.text }}>{supp.name}</p>
                        <p className="text-xs" style={{ color: COLORS.textMuted }}>{supp.dosage}  {supp.time}</p>
                      </div>
                    </div>
                  </div>
                ))
              ) : (
                <div className="text-center py-8">
                  <Zap size={32} color={COLORS.textMuted} className="mx-auto mb-2" />
                  <p className="text-sm" style={{ color: COLORS.textMuted }}>No supplements added yet</p>
                </div>
              )}
            </div>

            {/* Add Supplement Button */}
            <button
              onClick={() => {
                setShowSupplementHistory(false);
                setActiveTab('nutrition');
                setNutritionTab('supplements');
              }}
              className="w-full py-3 rounded-xl font-semibold flex items-center justify-center gap-2"
              style={{ backgroundColor: COLORS.supplements, color: COLORS.text }}
            >
              <Plus size={18} />
              Manage Supplements
            </button>
          </div>
        </div>
      )}

      {/* Schedule Settings Modal */}
      {showScheduleSettings && (
        <div className="fixed inset-0 z-50 flex flex-col" style={{ backgroundColor: COLORS.background }}>
          {/* Header */}
          <div className="p-4 border-b flex items-center gap-3" style={{ borderColor: COLORS.surfaceLight }}>
            <button
              onClick={() => setShowScheduleSettings(false)}
              className="p-2 rounded-lg"
              style={{ backgroundColor: COLORS.surface }}
            >
              <ChevronLeft size={24} color={COLORS.text} />
            </button>
            <h2 className="text-xl font-bold" style={{ color: COLORS.text }}>Schedule Settings</h2>
          </div>

          {/* Content */}
          <div className="flex-1 overflow-auto p-4 space-y-6">
            {/* Rest Days - Free Toggle */}
            <div>
              <h4 className="font-semibold mb-2" style={{ color: COLORS.text }}>Select Your Rest Days</h4>
              <p className="text-sm mb-3" style={{ color: COLORS.textMuted }}>
                Tap days to toggle between training and rest
              </p>
              <div className="flex gap-1">
                {['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'].map((day, i) => {
                  const isRestDay = (userData.restDays || [5, 6]).includes(i);
                  return (
                    <button
                      key={day}
                      onClick={() => {
                        setUserData(prev => {
                          const currentRestDays = prev.restDays || [5, 6];
                          const newRestDays = isRestDay
                            ? currentRestDays.filter(d => d !== i)
                            : [...currentRestDays, i].sort((a, b) => a - b);
                          const newDaysPerWeek = 7 - newRestDays.length;
                          return { ...prev, restDays: newRestDays, daysPerWeek: newDaysPerWeek };
                        });
                      }}
                      className="flex-1 py-3 rounded-xl text-sm font-medium flex flex-col items-center gap-1"
                      style={{
                        backgroundColor: isRestDay ? COLORS.surfaceLight : COLORS.primary,
                        color: isRestDay ? COLORS.textMuted : '#fff'
                      }}
                    >
                      <span>{day}</span>
                      <span style={{ fontSize: 10 }}>{isRestDay ? 'Rest' : 'Train'}</span>
                    </button>
                  );
                })}
              </div>

              {/* Training Days Summary */}
              {(() => {
                const trainingDays = 7 - (userData.restDays || [5, 6]).length;
                const isTooFew = trainingDays < 3;
                const isTooMany = trainingDays > 6;
                const isOptimal = trainingDays >= 3 && trainingDays <= 6;

                return (
                  <div className="mt-4">
                    <div className="flex justify-between items-center mb-2">
                      <span className="text-sm" style={{ color: COLORS.textMuted }}>Training days per week:</span>
                      <span className="font-bold text-lg" style={{ color: isOptimal ? COLORS.primary : COLORS.warning }}>
                        {trainingDays}
                      </span>
                    </div>

                    {/* Warning Messages */}
                    {isTooFew && (
                      <div className="p-3 rounded-lg flex items-start gap-2" style={{ backgroundColor: COLORS.warning + '20' }}>
                        <AlertCircle size={18} color={COLORS.warning} className="flex-shrink-0 mt-0.5" />
                        <div>
                          <p className="text-sm font-semibold" style={{ color: COLORS.warning }}>Too few training days</p>
                          <p className="text-xs" style={{ color: COLORS.textMuted }}>
                            We recommend at least 3 training days per week for optimal progress.
                          </p>
                        </div>
                      </div>
                    )}
                    {isTooMany && (
                      <div className="p-3 rounded-lg flex items-start gap-2" style={{ backgroundColor: COLORS.warning + '20' }}>
                        <AlertCircle size={18} color={COLORS.warning} className="flex-shrink-0 mt-0.5" />
                        <div>
                          <p className="text-sm font-semibold" style={{ color: COLORS.warning }}>No rest days selected</p>
                          <p className="text-xs" style={{ color: COLORS.textMuted }}>
                            Rest is essential for recovery. We recommend at least 1 rest day per week.
                          </p>
                        </div>
                      </div>
                    )}
                    {isOptimal && (
                      <p className="text-sm" style={{ color: COLORS.textMuted }}>
                        {trainingDays === 3 && 'Full body workouts, great for beginners'}
                        {trainingDays === 4 && 'Upper/Lower split, balanced approach'}
                        {trainingDays === 5 && 'Push/Pull/Legs + extras, intermediate level'}
                        {trainingDays === 6 && 'Push/Pull/Legs x2, advanced training'}
                      </p>
                    )}
                  </div>
                );
              })()}
            </div>

            {/* Weekly Preview */}
            <div>
              <h4 className="font-semibold mb-3" style={{ color: COLORS.text }}>Weekly Preview</h4>
              <div className="rounded-xl p-4 space-y-2" style={{ backgroundColor: COLORS.surface }}>
                {(() => {
                  const restDays = userData.restDays || [5, 6];
                  const trainingDays = 7 - restDays.length;
                  const previewRotation = getWorkoutRotation(trainingDays);
                  const days = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'];
                  let workoutIndex = 0;

                  return days.map((day, i) => {
                    const isRest = restDays.includes(i);
                    const workout = isRest ? null : previewRotation[workoutIndex % previewRotation.length];
                    if (!isRest) workoutIndex++;

                    return (
                      <div key={day} className="flex justify-between items-center py-2">
                        <span style={{ color: COLORS.text }}>{day}</span>
                        <span
                          className="text-sm px-3 py-1 rounded-full"
                          style={{
                            backgroundColor: isRest ? COLORS.surfaceLight : COLORS.primary + '20',
                            color: isRest ? COLORS.textMuted : COLORS.primary
                          }}
                        >
                          {isRest ? 'Rest' : workout?.name || 'Workout'}
                        </span>
                      </div>
                    );
                  });
                })()}
              </div>
            </div>
          </div>

          {/* Apply Button */}
          <div className="p-4" style={{ backgroundColor: COLORS.surface }}>
            <button
              onClick={() => {
                const restDays = userData.restDays || [5, 6];
                const trainingDays = 7 - restDays.length;
                regenerateSchedule(restDays, trainingDays);
                setShowScheduleSettings(false);
              }}
              className="w-full py-4 rounded-xl font-semibold"
              style={{ backgroundColor: COLORS.primary, color: '#fff' }}
            >
              Apply & Regenerate Schedule
            </button>
          </div>
        </div>
      )}

      {/* Publish Workout Modal */}
      {showPublishModal && workoutToPublish && (
        <div className="fixed inset-0 z-50 flex items-center justify-center p-4" style={{ backgroundColor: 'rgba(0,0,0,0.2)' }}>
          <div className="w-full max-w-md rounded-2xl p-6 max-h-[90vh] overflow-auto" style={{ backgroundColor: COLORS.surface }}>
            <div className="flex items-center justify-between mb-4">
              <h3 className="text-lg font-bold" style={{ color: COLORS.text }}>Share Workout</h3>
              <button onClick={() => { setShowPublishModal(false); setWorkoutToPublish(null); setPublishDescription(''); }} className="p-1">
                <X size={20} color={COLORS.textMuted} />
              </button>
            </div>

            <div className="p-4 rounded-xl mb-4" style={{ backgroundColor: COLORS.surfaceLight }}>
              <p className="font-semibold" style={{ color: COLORS.text }}>{workoutToPublish.name}</p>
              <p className="text-sm" style={{ color: COLORS.textMuted }}>{workoutToPublish.focus}</p>
              <p className="text-xs mt-2" style={{ color: COLORS.textSecondary }}>
                {workoutToPublish.exercises?.length || 0} exercises
              </p>
            </div>

            {/* Description/Review Field */}
            <div className="mb-4">
              <label className="text-sm font-medium mb-2 block" style={{ color: COLORS.text }}>
                Add a description or review
              </label>
              <textarea
                value={publishDescription}
                onChange={(e) => setPublishDescription(e.target.value)}
                placeholder="Share your thoughts about this workout... What makes it great? Who is it best for? Any tips for getting the most out of it?"
                rows={4}
                className="w-full p-3 rounded-xl text-sm resize-none"
                style={{
                  backgroundColor: COLORS.surfaceLight,
                  color: COLORS.text,
                  border: `1px solid ${COLORS.surfaceLight}`,
                }}
              />
              <p className="text-xs mt-1" style={{ color: COLORS.textMuted }}>
                {publishDescription.length}/500 characters
              </p>
            </div>

            <p className="text-sm mb-4" style={{ color: COLORS.textMuted }}>
              Share this workout with the community. Others will be able to view, rate, and use this workout in their training.
            </p>

            <div className="flex gap-3">
              <button
                onClick={() => { setShowPublishModal(false); setWorkoutToPublish(null); setPublishDescription(''); }}
                className="flex-1 py-3 rounded-xl font-semibold"
                style={{ backgroundColor: COLORS.surfaceLight, color: COLORS.text }}
              >
                Cancel
              </button>
              <button
                onClick={() => {
                  handlePublishWorkout({ ...workoutToPublish, description: publishDescription });
                  setPublishDescription('');
                }}
                className="flex-1 py-3 rounded-xl font-semibold flex items-center justify-center gap-2"
                style={{ backgroundColor: COLORS.primary, color: COLORS.text }}
              >
                <Share2 size={16} /> Publish
              </button>
            </div>
          </div>
        </div>
      )}

      {/* Community Workout Preview Modal */}
      {selectedCommunityWorkout && (
        <div className="fixed inset-0 z-50 flex flex-col" style={{ backgroundColor: COLORS.background }}>
          <div className="p-4 border-b flex items-center gap-3" style={{ borderColor: COLORS.surfaceLight }}>
            <button onClick={() => setSelectedCommunityWorkout(null)}><X size={24} color={COLORS.text} /></button>
            <h2 className="text-lg font-bold" style={{ color: COLORS.text }}>{selectedCommunityWorkout.name}</h2>
          </div>
          <div className="flex-1 overflow-auto p-4">
            {/* Workout Info */}
            <div className="p-4 rounded-xl mb-4" style={{ backgroundColor: COLORS.primary + '15', border: `1px solid ${COLORS.primary}40` }}>
              <div className="flex items-center gap-2 mb-2">
                <Target size={18} color={COLORS.primary} />
                <span className="font-semibold" style={{ color: COLORS.primary }}>{selectedCommunityWorkout.focus}</span>
              </div>
              <p className="text-sm mb-3" style={{ color: COLORS.textSecondary }}>{selectedCommunityWorkout.description}</p>

              {/* Goals */}
              {selectedCommunityWorkout.goals?.length > 0 && (
                <div className="flex flex-wrap gap-2 mb-3">
                  {selectedCommunityWorkout.goals.map((goal, i) => (
                    <span key={i} className="text-xs px-2 py-1 rounded-full" style={{ backgroundColor: COLORS.surface, color: COLORS.text }}>
                      {goal}
                    </span>
                  ))}
                </div>
              )}

              {/* Stats & Creator */}
              <div className="flex items-center gap-4 pt-3" style={{ borderTop: `1px solid ${COLORS.surfaceLight}` }}>
                <div className="flex items-center gap-1">
                  <Award size={16} color={COLORS.warning} />
                  <span className="font-semibold" style={{ color: COLORS.text }}>
                    {(selectedCommunityWorkout.averageRating || 0).toFixed(1)}
                  </span>
                  <span className="text-xs" style={{ color: COLORS.textMuted }}>
                    ({selectedCommunityWorkout.ratingCount || 0})
                  </span>
                </div>
                <div className="flex items-center gap-1">
                  <Users size={16} color={COLORS.primary} />
                  <span className="text-sm" style={{ color: COLORS.textSecondary }}>
                    {selectedCommunityWorkout.completionCount || 0} completed
                  </span>
                </div>
              </div>

              {/* Creator Info */}
              {selectedCommunityWorkout.creator && (
                <div className="flex items-center gap-2 mt-3 pt-3" style={{ borderTop: `1px solid ${COLORS.surfaceLight}` }}>
                  <div
                    className="w-8 h-8 rounded-full flex items-center justify-center text-sm font-bold"
                    style={{ backgroundColor: COLORS.primary + '30', color: COLORS.primary }}
                  >
                    {selectedCommunityWorkout.creator.avatar || selectedCommunityWorkout.creator.name?.[0]?.toUpperCase() || 'U'}
                  </div>
                  <div>
                    <p className="text-sm font-semibold" style={{ color: COLORS.text }}>{selectedCommunityWorkout.creator.name}</p>
                    <p className="text-xs" style={{ color: COLORS.textMuted }}>@{selectedCommunityWorkout.creator.username}</p>
                  </div>
                </div>
              )}
            </div>

            {/* Exercises */}
            <h3 className="font-semibold mb-3" style={{ color: COLORS.text }}>
              Exercises ({selectedCommunityWorkout.exercises?.length || 0})
            </h3>
            <div className="space-y-3 mb-4">
              {(selectedCommunityWorkout.exercises || []).map((exercise, i) => (
                <div
                  key={exercise.id || i}
                  className="p-4 rounded-xl"
                  style={{ backgroundColor: COLORS.surface }}
                >
                  <div className="flex items-center gap-3">
                    <div className="w-8 h-8 rounded-full flex items-center justify-center" style={{ backgroundColor: COLORS.primary + '20' }}>
                      <span className="font-bold text-sm" style={{ color: COLORS.primary }}>{i + 1}</span>
                    </div>
                    <div className="flex-1">
                      <p className="font-semibold" style={{ color: COLORS.text }}>{exercise.name}</p>
                      <p className="text-xs" style={{ color: COLORS.textMuted }}>{exercise.muscleGroup}</p>
                    </div>
                    <div className="text-right">
                      <p className="font-semibold" style={{ color: COLORS.text }}>{exercise.sets}  {exercise.targetReps}</p>
                      <p className="text-xs" style={{ color: COLORS.textMuted }}>
                        {exercise.suggestedWeight > 0 ? `${exercise.suggestedWeight}kg` : 'Bodyweight'}
                      </p>
                    </div>
                  </div>
                </div>
              ))}
            </div>
          </div>

          {/* Actions Footer */}
          <div className="p-4 border-t space-y-3" style={{ borderColor: COLORS.surfaceLight }}>
            {/* Rating Section - Only show if completed or already rated */}
            {(completedCommunityWorkoutIds.has(selectedCommunityWorkout.id) || userWorkoutRatings[selectedCommunityWorkout.id]) ? (
              <div className="flex items-center justify-between py-2">
                <span className="text-sm font-semibold" style={{ color: COLORS.text }}>Rate this workout</span>
                <StarRating
                  rating={userWorkoutRatings[selectedCommunityWorkout.id] || 0}
                  onRate={(rating) => handleRateWorkout(selectedCommunityWorkout.id, rating)}
                  size={24}
                />
              </div>
            ) : (
              <div className="py-2">
                <span className="text-xs" style={{ color: COLORS.textMuted }}>Complete this workout to rate it</span>
              </div>
            )}

            <div className="flex gap-2">
              <button
                onClick={() => handleSaveWorkout(selectedCommunityWorkout.id)}
                className="flex-1 py-3 rounded-xl font-semibold flex items-center justify-center gap-2"
                style={{
                  backgroundColor: savedWorkoutIds.has(selectedCommunityWorkout.id) ? COLORS.warning + '20' : COLORS.surfaceLight,
                  color: savedWorkoutIds.has(selectedCommunityWorkout.id) ? COLORS.warning : COLORS.text
                }}
              >
                <Book
                  size={18}
                  fill={savedWorkoutIds.has(selectedCommunityWorkout.id) ? COLORS.warning : 'transparent'}
                />
                {savedWorkoutIds.has(selectedCommunityWorkout.id) ? 'Saved' : 'Rep-ertoire'}
              </button>
              <button
                onClick={() => { loadComments(selectedCommunityWorkout.id); }}
                className="flex-1 py-3 rounded-xl font-semibold flex items-center justify-center gap-2"
                style={{ backgroundColor: COLORS.surfaceLight, color: COLORS.text }}
              >
                <MessageCircle size={18} />
                Comments
              </button>
            </div>

            <button
              onClick={() => {
                const adjusted = adjustWorkoutForUser(selectedCommunityWorkout);
                setTodayWorkout({
                  type: adjusted.name,
                  name: adjusted.name,
                  focus: adjusted.focus,
                  exercises: adjusted.exercises?.length || 0,
                  duration: selectedCommunityWorkout.target_duration || estimateWorkoutDuration(selectedCommunityWorkout.exercises),
                  communityWorkoutId: selectedCommunityWorkout.id,
                });
                setSelectedCommunityWorkout(null);
                setActiveTab('workouts');
              }}
              className="w-full py-4 rounded-xl font-semibold flex items-center justify-center gap-2"
              style={{ backgroundColor: COLORS.primary, color: COLORS.text }}
            >
              <Play size={18} /> Start Workout (Auto-adjusted for you)
            </button>
          </div>
        </div>
      )}

      {/* Comments Modal */}
      {showCommentsFor && (
        <div className="fixed inset-0 z-50 flex flex-col" style={{ backgroundColor: COLORS.background }}>
          <div className="p-4 border-b flex items-center gap-3" style={{ borderColor: COLORS.surfaceLight }}>
            <button onClick={closeCommentsWithScroll}>
              <X size={24} color={COLORS.text} />
            </button>
            <h2 className="text-lg font-bold" style={{ color: COLORS.text }}>Comments</h2>
          </div>

          <div className="flex-1 overflow-auto p-4">
            {commentsLoading ? (
              <div className="flex items-center justify-center py-8">
                <Loader2 size={24} className="animate-spin" color={COLORS.primary} />
              </div>
            ) : workoutComments.length === 0 ? (
              <div className="text-center py-8">
                <MessageCircle size={40} color={COLORS.textMuted} className="mx-auto mb-3" style={{ opacity: 0.5 }} />
                <p className="font-semibold" style={{ color: COLORS.text }}>No comments yet</p>
                <p className="text-sm" style={{ color: COLORS.textMuted }}>Be the first to leave a comment!</p>
              </div>
            ) : (
              <div className="space-y-4">
                {workoutComments.map(comment => (
                  <div key={comment.id} className="p-4 rounded-xl" style={{ backgroundColor: COLORS.surface }}>
                    <div className="flex items-center gap-3 mb-2">
                      <div
                        className="w-8 h-8 rounded-full flex items-center justify-center text-sm font-bold"
                        style={{ backgroundColor: COLORS.primary + '30', color: COLORS.primary }}
                      >
                        {comment.user?.avatar || comment.user?.username?.[0]?.toUpperCase() || 'U'}
                      </div>
                      <div>
                        <p className="font-semibold text-sm" style={{ color: COLORS.text }}>{comment.user?.name || 'User'}</p>
                        <p className="text-xs" style={{ color: COLORS.textMuted }}>
                          {comment.created_at ? formatActivityTime(comment.created_at) : ''}
                        </p>
                      </div>
                    </div>
                    <p className="text-sm" style={{ color: COLORS.textSecondary }}>
                      {renderCommentWithMentions(comment.content, COLORS, (username) => {
                        // Could navigate to user profile here
                        console.log('Clicked mention:', username);
                      })}
                    </p>
                  </div>
                ))}
              </div>
            )}
          </div>

          {/* Add Comment */}
          <div className="p-4 border-t" style={{ borderColor: COLORS.surfaceLight }}>
            <div className="flex gap-2">
              <input
                type="text"
                value={newComment}
                onChange={(e) => setNewComment(e.target.value)}
                placeholder="Add a comment..."
                className="flex-1 p-3 rounded-xl"
                style={{ backgroundColor: COLORS.surface, color: COLORS.text, border: 'none', outline: 'none' }}
              />
              <button
                onClick={handleAddComment}
                disabled={!newComment.trim()}
                className="px-4 rounded-xl font-semibold"
                style={{
                  backgroundColor: newComment.trim() ? COLORS.primary : COLORS.surfaceLight,
                  color: newComment.trim() ? COLORS.text : COLORS.textMuted
                }}
              >
                Post
              </button>
            </div>
          </div>
        </div>
      )}

      {/* Rep-ertoire Modal (Saved Workouts) */}
      {showRepertoire && (
        <div className="fixed inset-0 z-50 flex flex-col" style={{ backgroundColor: COLORS.background }}>
          <div className="p-4 border-b flex items-center gap-3" style={{ borderColor: COLORS.surfaceLight }}>
            <button onClick={() => setShowRepertoire(false)}>
              <X size={24} color={COLORS.text} />
            </button>
            <Book size={24} color={COLORS.warning} />
            <h2 className="text-lg font-bold" style={{ color: COLORS.text }}>My Rep-ertoire</h2>
          </div>

          <div className="flex-1 overflow-auto p-4">
            {savedWorkoutsDetails.length === 0 ? (
              <div className="text-center py-12">
                <Book size={48} color={COLORS.textMuted} className="mx-auto mb-3" style={{ opacity: 0.5 }} />
                <p className="font-bold mb-2" style={{ color: COLORS.text }}>No saved workouts yet</p>
                <p className="text-sm" style={{ color: COLORS.textMuted }}>
                  Save workouts from the community to build your Rep-ertoire!
                </p>
              </div>
            ) : (
              <div className="space-y-3">
                {savedWorkoutsDetails.map(workout => {
                  const style = getWorkoutStyle(workout.focus);
                  const targetDuration = workout.target_duration || estimateWorkoutDuration(workout.exercises);
                  return (
                    <div
                      key={workout.id}
                      className="p-4 rounded-xl"
                      style={{ backgroundColor: COLORS.surface }}
                    >
                      <button
                        onClick={() => { setShowRepertoire(false); setSelectedCommunityWorkout(workout); }}
                        className="w-full text-left"
                      >
                        <div className="flex items-center gap-3">
                          <div
                            className="w-12 h-12 rounded-xl flex items-center justify-center"
                            style={{ backgroundColor: style.color + '20' }}
                          >
                            <IconMap name={style.icon} size={24} color={style.color} />
                          </div>
                          <div className="flex-1 min-w-0">
                            <p className="font-bold truncate" style={{ color: COLORS.text }}>{workout.name}</p>
                            <div className="flex items-center gap-2 mt-1">
                              <StarRating rating={workout.averageRating || 0} readonly size={12} />
                              <span className="text-xs" style={{ color: COLORS.textMuted }}>
                                ({(workout.averageRating || 0).toFixed(1)}) {workout.ratingCount || 0} {(workout.ratingCount || 0) === 1 ? 'review' : 'reviews'}
                              </span>
                              <span className="text-xs" style={{ color: COLORS.textMuted }}>
                                {workout.exercises?.length || 0} exercises
                              </span>
                            </div>
                            {workout.creator && (
                              <p className="text-xs mt-1" style={{ color: COLORS.textMuted }}>
                                by @{workout.creator.username}
                              </p>
                            )}
                          </div>
                          <ChevronRight size={20} color={COLORS.textMuted} />
                        </div>
                      </button>

                      {/* Action Buttons */}
                      <div className="flex gap-2 mt-3 pt-3 border-t" style={{ borderColor: COLORS.surfaceLight }}>
                        <button
                          onClick={() => {
                            const adjusted = adjustWorkoutForUser(workout);
                            setTodayWorkout({
                              type: adjusted.name,
                              name: adjusted.name,
                              focus: adjusted.focus,
                              exercises: adjusted.exercises?.length || 0,
                              duration: targetDuration,
                              communityWorkoutId: workout.id,
                            });
                            setShowRepertoire(false);
                            setActiveTab('workouts');
                          }}
                          className="flex-1 py-2 rounded-lg flex items-center justify-center gap-1 text-xs font-semibold"
                          style={{ backgroundColor: COLORS.primary, color: COLORS.text }}
                        >
                          <Play size={14} /> Start Now
                        </button>
                        <button
                          onClick={() => {
                            // Add to schedule for today
                            setMasterSchedule(prev => ({
                              ...prev,
                              [TODAY_DATE_KEY]: {
                                ...prev[TODAY_DATE_KEY],
                                workout: workout.name,
                                type: workout.focus || 'general',
                                communityWorkoutId: workout.id,
                              }
                            }));
                            setShowRepertoire(false);
                          }}
                          className="flex-1 py-2 rounded-lg flex items-center justify-center gap-1 text-xs font-semibold"
                          style={{ backgroundColor: COLORS.surfaceLight, color: COLORS.text }}
                        >
                          <Calendar size={14} /> Add to Today
                        </button>
                        <button
                          onClick={(e) => { e.stopPropagation(); handleSaveWorkout(workout.id); }}
                          className="px-3 py-2 rounded-lg"
                          style={{ backgroundColor: COLORS.warning + '20' }}
                        >
                          <Trash2 size={14} color={COLORS.error} />
                        </button>
                      </div>
                    </div>
                  );
                })}
              </div>
            )}
          </div>
        </div>
      )}

      {/* Weigh-In Modal */}
      {showWeighIn && (
        <WeighInModal
          COLORS={COLORS}
          onClose={() => setShowWeighIn(false)}
          initialWeight={userData.currentWeight || 80}
          currentWeight={userData.currentWeight || 80}
          userGoal={userData.goal || 'build_muscle'}
          onSave={async (data) => {
            if (user?.id) {
              await profileService.logWeight(user.id, data.weight, data.date, data.bodyFat, data.muscleMass);
              setUserData(prev => ({ ...prev, currentWeight: data.weight }));
            }
            setShowWeighIn(false);
          }}
        />
      )}

      <div className="flex justify-around py-2 border-t" style={{ backgroundColor: COLORS.surface, borderColor: COLORS.surfaceLight }}>
        {[
          { id: 'home', icon: Home, label: 'Home' },
          { id: 'workouts', icon: Dumbbell, label: 'Workouts' },
          { id: 'friends', icon: Users, label: 'Community' },
          { id: 'nutrition', icon: Heart, label: 'Health' },
          { id: 'progress', icon: BarChart3, label: 'Progress' },
          { id: 'profile', icon: User, label: 'Profile' },
        ].map(tab => (
          <button key={tab.id} onClick={() => setActiveTab(tab.id)} className="flex flex-col items-center gap-0.5">
            <tab.icon size={18} color={activeTab === tab.id ? COLORS.primary : COLORS.textMuted} />
            <span style={{ fontSize: 9, color: activeTab === tab.id ? COLORS.primary : COLORS.textMuted }}>{tab.label}</span>
          </button>
        ))}
      </div>
    </div>
  );

  // Show loading screen while checking auth
  if (authLoading) {
    return (
      <div className="w-full h-screen flex flex-col items-center justify-center" style={{ backgroundColor: COLORS.background }}>
        <Loader2 size={48} color={COLORS.primary} className="animate-spin mb-4" />
        <p style={{ color: COLORS.textSecondary }}>Loading...</p>
      </div>
    );
  }

  // Show loading while data is being fetched from database
  if (isAuthenticated && dataLoading) {
    return (
      <div className="w-full h-screen flex flex-col items-center justify-center" style={{ backgroundColor: COLORS.background }}>
        <Loader2 size={48} color={COLORS.primary} className="animate-spin mb-4" />
        <p style={{ color: COLORS.textSecondary }}>Loading UpRep...</p>
      </div>
    );
  }

  return (
    <div className="w-full h-screen flex flex-col" style={{ backgroundColor: COLORS.background }}>
      <div className="flex-1 overflow-hidden relative">
        {currentScreen === 'welcome' && <WelcomeScreen />}
        {currentScreen === 'login' && <LoginScreen onBack={() => setCurrentScreen('welcome')} onLogin={() => setCurrentScreen('main')} COLORS={COLORS} />}
        {currentScreen === 'register' && <RegisterScreen onBack={() => setCurrentScreen('welcome')}
          onRegister={(data) => { setUserData(p => ({...p, ...data})); setCurrentScreen('onboarding'); }} COLORS={COLORS} />}
        {currentScreen === 'dashboard' && <DashboardScreen />}
        {currentScreen === 'onboarding' && <OnboardingScreen
          userData={userData}
          setUserData={setUserData}
          onboardingStep={onboardingStep}
          setOnboardingStep={setOnboardingStep}
          hoveredGoal={hoveredGoal}
          setHoveredGoal={setHoveredGoal}
          sleepHours={sleepHours}
          setSleepHours={setSleepHours}
          setCurrentScreen={setCurrentScreen}
          user={user}
          updateProfile={updateProfile}
          updateGoals={updateGoals}
          setNutritionGoals={setNutritionGoals}
          setOverviewStats={setOverviewStats}
          onboardingScrollRef={onboardingScrollRef}
          toggleEquipmentWithScroll={toggleEquipmentWithScroll}
          getLocalDateString={getLocalDateString}
          generateNutritionTargets={generateNutritionTargets}
        />}
        {currentScreen === 'main' && <MainScreen />}
      </div>
    </div>
  );
}
